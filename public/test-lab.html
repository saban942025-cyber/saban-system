<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>××¢×‘×“×ª ×”× ×™×¡×•×™×™× ×©×œ SabanOS - ×’×¨×¡×ª ×××¡×˜×¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-10 font-sans">

    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800">ğŸ§  SabanOS Logic Lab</h1>
        <p class="text-gray-500">×‘×“×™×§×ª ×—×•×§×™ ×‘×¨×–×œ + ×’×™×©×ª ×××¡×˜×¨</p>
        <div id="master-badge" class="hidden mt-2 inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold border border-yellow-300">
            <i class="fas fa-crown"></i> ××—×•×‘×¨ ×›×××¡×˜×¨ (Rami)
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">
        
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">ğŸ“¦ ××•×¦×¨×™× ×œ×‘×“×™×§×”</h2>
            <p class="text-xs text-gray-400 mb-4">×œ×—×¥ ×œ×”×•×¡×¤×” ×œ×¢×’×œ×”:</p>
            <div id="product-list" class="space-y-3">
                </div>

            <div class="mt-8 pt-4 border-t border-gray-100">
                <h3 class="text-sm font-bold text-gray-600 mb-2">×›×œ×™ ×× ×”×œ:</h3>
                <button onclick="loginAsMaster()" class="w-full bg-gray-800 text-white py-2 rounded text-sm hover:bg-gray-700 transition">
                    <i class="fas fa-user-shield"></i> ×›× ×¡ ×›×××¡×˜×¨ (×¢×§×•×£ ×—×¡×™××•×ª)
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-blue-100 relative">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">ğŸ›’ ×”×¢×’×œ×” ×•× ×™×ª×•×— ×”××•×—</h2>
            
            <div id="cart-display" class="min-h-[150px] bg-gray-50 p-4 rounded mb-4 text-sm text-gray-600 space-y-2">
                ×”×¢×’×œ×” ×¨×™×§×”...
            </div>
            
            <div class="flex justify-between items-center border-t pt-2 font-bold text-gray-800">
                <span>×¡×”"×› ×œ×ª×©×œ×•×:</span>
                <span id="total-price">0.00 â‚ª</span>
            </div>

            <div id="brain-output" class="hidden mt-4 bg-red-50 border-r-4 border-red-500 p-4 rounded animate-pulse">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                    </div>
                    <div class="mr-3">
                        <h3 class="text-sm font-bold text-red-800" id="alert-title">×”×ª×¨××ª ××¢×¨×›×ª</h3>
                        <div class="mt-1 text-sm text-red-700" id="alert-msg"></div>
                        
                        <div class="mt-4 flex gap-3">
                            <button id="fix-btn" class="hidden text-xs bg-red-100 text-red-800 px-3 py-1 rounded border border-red-200 hover:bg-red-200">
                                ×ª×§×Ÿ ××•×˜×•××˜×™×ª
                            </button>
                            <button id="override-btn" class="hidden text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded hover:bg-gray-300">
                                <i class="fas fa-key"></i> ××™×©×•×¨ ×××¡×˜×¨ (×¢×§×•×£)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. ×”× ×ª×•× ×™× (×”×§×˜×œ×•×’) ---
        const products = [
            { 
                id: "114260", 
                name: "×œ×•×— ×’×‘×¡ ×›×—×•×œ (×›×‘×“)", 
                price: 168.48, 
                logistics: { weight: 28, requires_crane: true } 
            },
            { 
                id: "18161", 
                name: "âš ï¸ ×”×•×‘×œ×” ×œ× ××–×•×¨×™×ª (×”××œ×›×•×“×ª)", 
                price: 0, // ×”××—×™×¨ ×”×•× 0 ×‘×›×•×•× ×” ×›×“×™ ×œ×‘×“×•×§ ××ª ×”××¢×¨×›×ª
                logistics: { is_service: true, is_trap: true } 
            },
            { 
                id: "service_crane", 
                name: "ğŸ—ï¸ ×©×™×¨×•×ª ×× ×•×£", 
                price: 300, 
                logistics: { is_service: true } 
            },
            { 
                id: "manual_delivery", 
                name: "ğŸšš ×—×™×•×‘ ×”×•×‘×œ×” ×™×“× ×™", 
                price: 250, 
                logistics: { is_service: true, type: "delivery_charge" } 
            }
        ];

        // --- 2. × ×™×”×•×œ ××¦×‘ (State) ---
        let cart = [];
        let isMaster = false;

        // --- 3. ×”××•×— (SabanLogic) ---
        const SabanLogic = {
            analyzeCart: (cartItems) => {
                let analysis = {
                    missingServices: [],
                    isValid: true,
                    totalPrice: 0,
                    blockReason: null
                };

                let hasRemoteDeliveryItem = false;
                let deliveryCharge = 0;
                let hasHeavyItems = false;
                let hasCraneService = false;

                cartItems.forEach(item => {
                    analysis.totalPrice += (item.price * item.qty);

                    // ×–×™×”×•×™ ×”××œ×›×•×“×ª (18161)
                    if (item.id === "18161") hasRemoteDeliveryItem = true;
                    
                    // ×—×™×©×•×‘ ×›×¡×£ ×¢×œ ×”×•×‘×œ×”
                    if (item.id === "manual_delivery") deliveryCharge += (item.price * item.qty);

                    // ×–×™×”×•×™ ×›×‘×“×™×
                    if (item.logistics && item.logistics.requires_crane) hasHeavyItems = true;
                    if (item.id === "service_crane") hasCraneService = true;
                });

                // --- ×—×•×§×™ ×”×‘×¨×–×œ ---

                // ×—×•×§ 1: ×”×•×‘×œ×” ×‘××¤×¡ ×©×§×œ
                if (hasRemoteDeliveryItem && deliveryCharge === 0) {
                    analysis.isValid = false;
                    analysis.blockReason = "GHOST_DELIVERY";
                    analysis.missingServices.push({
                        msg: "ğŸš¨ ×¢×¦×•×¨! ×”×•×¡×¤×ª '×”×•×‘×œ×” ×œ× ××–×•×¨×™×ª' (18161) ×‘××—×™×¨ 0, ××š ×œ× ×—×™×™×‘×ª ×”×•×‘×œ×” ×‘×›×¡×£. ×–×• ×‘×“×™×•×§ ×”×˜×¢×•×ª ×©×’×•×¨××ª ×œ×”×¤×¡×“!",
                        fixId: "manual_delivery"
                    });
                }

                // ×—×•×§ 2: ×¤×¨×™×˜ ×›×‘×“ ×œ×œ× ×× ×•×£
                else if (hasHeavyItems && !hasCraneService) {
                    analysis.isValid = false;
                    analysis.blockReason = "CRANE_MISSING";
                    analysis.missingServices.push({
                        msg: "âš ï¸ ×©×™× ×œ×‘: ×™×© ×¤×¨×™×˜×™× ×›×‘×“×™× ×œ×œ× ×—×™×•×‘ ×× ×•×£.",
                        fixId: "service_crane"
                    });
                }

                return analysis;
            }
        };

        // --- 4. ×××©×§ ××©×ª××© (UI) ---
        
        function renderProducts() {
            const listEl = document.getElementById('product-list');
            listEl.innerHTML = products.map(p => `
                <div onclick="addToCart('${p.id}')" 
                     class="flex justify-between items-center p-3 bg-gray-50 hover:bg-blue-50 cursor-pointer rounded border transition active:scale-95 select-none">
                    <div class="flex items-center gap-2">
                        <span class="${p.id === '18161' ? 'text-red-600 font-bold' : ''}">${p.name}</span>
                    </div>
                    <span class="font-bold text-gray-700">${p.price} â‚ª</span>
                </div>
            `).join('');
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const existingItem = cart.find(i => i.id === productId);
            
            if (existingItem) {
                existingItem.qty++;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            updateSystem();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateSystem();
        }

        function updateSystem() {
            // 1. ×¨×™× ×“×•×¨ ×¢×’×œ×”
            const cartEl = document.getElementById('cart-display');
            const totalEl = document.getElementById('total-price');
            
            if (cart.length === 0) {
                cartEl.innerHTML = '<div class="text-center py-4 text-gray-400">×”×¢×’×œ×” ×¨×™×§×”...</div>';
                totalEl.innerText = "0.00 â‚ª";
                document.getElementById('brain-output').classList.add('hidden');
                return;
            }

            cartEl.innerHTML = cart.map((item, index) => `
                <div class="flex justify-between items-center bg-white p-2 rounded shadow-sm border border-gray-100">
                    <div class="flex items-center gap-2">
                        <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-600 px-1"><i class="fas fa-times"></i></button>
                        <span>${item.name}</span> <span class="text-xs bg-gray-200 px-1 rounded">x${item.qty}</span>
                    </div>
                    <span>${(item.price * item.qty).toFixed(2)}</span>
                </div>
            `).join('');

            // 2. ×”×¨×¦×ª ×”××•×—
            const analysis = SabanLogic.analyzeCart(cart);
            totalEl.innerText = analysis.totalPrice.toFixed(2) + " â‚ª";
            
            // 3. ×˜×™×¤×•×œ ×‘×”×ª×¨××•×ª
            const alertBox = document.getElementById('brain-output');
            const fixBtn = document.getElementById('fix-btn');
            const overrideBtn = document.getElementById('override-btn');

            if (!analysis.isValid) {
                alertBox.classList.remove('hidden');
                document.getElementById('alert-msg').innerText = analysis.missingServices[0].msg;
                
                // ×›×¤×ª×•×¨ ×ª×™×§×•×Ÿ
                fixBtn.classList.remove('hidden');
                fixBtn.onclick = () => addToCart(analysis.missingServices[0].fixId);

                // ×›×¤×ª×•×¨ ×××¡×˜×¨
                if (isMaster) {
                    overrideBtn.classList.remove('hidden');
                    overrideBtn.onclick = () => {
                        alert("âœ… ××•×©×¨ ×¢×œ ×™×“×™ ×××¡×˜×¨ ×¨×××™. ×”×”×–×× ×” ×©×•×—×¨×¨×”.");
                        alertBox.classList.add('hidden');
                    };
                } else {
                    overrideBtn.classList.add('hidden');
                }
            } else {
                alertBox.classList.add('hidden');
            }
        }

        // ×¤×•× ×§×¦×™×™×ª ×”×ª×—×‘×¨×•×ª ×××¡×˜×¨
        window.loginAsMaster = function() {
            isMaster = true;
            document.getElementById('master-badge').classList.remove('hidden');
            updateSystem(); // ×¨×¢× ×•×Ÿ ×›×“×™ ×œ×¨××•×ª ××ª ×›×¤×ª×•×¨×™ ×”×××¡×˜×¨
            alert("ğŸ‘‘ ×‘×¨×•×š ×”×‘× ×¨×××™! ×§×™×‘×œ×ª ×”×¨×©××•×ª ×××¡×˜×¨.");
        }

        // ×”×ª×—×œ×”
        renderProducts();

    </script>
</body>
</html>