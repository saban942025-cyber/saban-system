<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Saban Command</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=Saban&background=0f172a&color=fff&size=192">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- Mobile Native Feel --- */
        body { 
            background: #f1f5f9; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px; /* ××§×•× ×œ×˜××‘×™× ×œ××˜×” */
            padding-top: env(safe-area-inset-top);
            overscroll-behavior-y: none; /* ×× ×™×¢×ª ×’×œ×™×œ×ª ×§×¤×™×¥ */
        }

        /* Sticky Header */
        .header {
            background: #0f172a; color: white;
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- Views & Animations --- */
        .view-container {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            padding: 16px;
        }
        .view-container.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards --- */
        .mobile-card {
            background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;
            position: relative; overflow: hidden; active:scale-95; transition: 0.1s;
        }
        
        /* Transfer Snake Mini (Mobile Version) */
        .snake-track { height: 6px; background: #e2e8f0; border-radius: 3px; margin: 15px 0; position: relative; overflow: hidden; }
        .snake-head {
            position: absolute; top: 0; bottom: 0; width: 40%;
            background: linear-gradient(90deg, transparent, #22c55e, transparent);
            animation: snakeMobile 2s infinite linear;
        }
        @keyframes snakeMobile { 0% {left: -40%} 100% {left: 100%} }

        /* --- Bottom Navigation (Tabs) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; height: 80px;
            display: flex; justify-content: space-around; align-items: flex-start;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.03);
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: #94a3b8; font-size: 10px; font-weight: 600; 
            width: 60px; cursor: pointer; transition: 0.2s;
        }
        .nav-btn i { font-size: 22px; margin-bottom: 2px; transition: 0.2s; }
        
        .nav-btn.active { color: #0f172a; }
        .nav-btn.active i { transform: translateY(-3px); color: #2563eb; }

        /* --- Floating Action Button (FAB) --- */
        .fab-container {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
        }
        .fab {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, #2563eb, #1e40af);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 24px;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4);
            border: 4px solid white;
        }
        .fab:active { transform: scale(0.9); }

    </style>
</head>
<body>

    <div class="header">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold border-2 border-white">×¨</div>
            <div>
                <h1 class="font-bold text-lg leading-none">×¨×××™ ×¡×‘×Ÿ</h1>
                <span class="text-[10px] text-green-400 font-bold tracking-wider">â— ×× ×”×œ ××—×•×‘×¨</span>
            </div>
        </div>
        <button onclick="window.location.reload()" class="w-8 h-8 flex items-center justify-center bg-slate-700 rounded-full">
            <i class="fas fa-sync-alt text-xs text-gray-300"></i>
        </button>
    </div>

    <div id="tab-orders" class="view-container active">
        <h2 class="text-xs font-bold text-gray-500 uppercase mb-3">×”×–×× ×•×ª ×¤×ª×•×—×•×ª</h2>
        <div id="orders-list">
            <div class="text-center mt-10 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        </div>
    </div>

    <div id="tab-transfers" class="view-container">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xs font-bold text-gray-500 uppercase">×”×¢×‘×¨×•×ª ××œ××™ (×¢×œ×™)</h2>
            <span class="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-1 rounded-full font-bold">×¤×¢×™×œ</span>
        </div>
        <div id="transfers-list">
            </div>
    </div>

    <div id="tab-team" class="view-container">
        <h2 class="text-xs font-bold text-gray-500 uppercase mb-3">×¡×˜×˜×•×¡ ×›×•×—×•×ª</h2>
        <div id="team-list" class="grid grid-cols-2 gap-3">
            </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" onclick="switchTab('orders', this)">
            <i class="fas fa-clipboard-list"></i>
            <span>×”×–×× ×•×ª</span>
        </div>
        
        <div class="nav-btn" onclick="switchTab('transfers', this)">
            <i class="fas fa-dolly"></i>
            <span>×”×¢×‘×¨×•×ª</span>
        </div>

        <div class="relative w-12" onclick="openCreateMenu()">
            <div class="fab-container">
                <div class="fab"><i class="fas fa-plus"></i></div>
            </div>
        </div>

        <div class="nav-btn" onclick="switchTab('team', this)">
            <i class="fas fa-users"></i>
            <span>×¦×•×•×ª</span>
        </div>

        <div class="nav-btn" onclick="window.open('index.html', '_blank')">
            <i class="fas fa-desktop"></i>
            <span>×—×"×œ</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // --- Tab Switching Logic ---
        window.switchTab = (tabName, btn) => {
            // ×”×—×œ×¤×ª ×ª×¦×•×’×”
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™×
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            // ×’×œ×™×œ×” ×œ××¢×œ×”
            window.scrollTo(0,0);
        };

        // --- 1. Quick Create Menu (×”×›×¤×ª×•×¨ ×”×’×“×•×œ) ---
        window.openCreateMenu = async () => {
            const { value: action } = await Swal.fire({
                title: '××” ×ª×¨×¦×” ×œ×¤×ª×•×—?',
                showCancelButton: true,
                cancelButtonText: '×‘×™×˜×•×œ',
                confirmButtonText: '×œ× ×¨×œ×•×•× ×˜×™', // × ×¡×ª×™×¨ ××•×ª×•
                showConfirmButton: false,
                html: `
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <button onclick="Swal.clickConfirm(); createTransfer()" class="bg-yellow-100 p-4 rounded-xl border border-yellow-300 flex flex-col items-center gap-2 active:scale-95 transition">
                            <i class="fas fa-dolly text-2xl text-yellow-600"></i>
                            <span class="text-sm font-bold text-yellow-800">×”×¢×‘×¨×” ×—×“×©×”</span>
                        </button>
                        <button onclick="Swal.clickConfirm(); createQuickOrder()" class="bg-blue-100 p-4 rounded-xl border border-blue-300 flex flex-col items-center gap-2 active:scale-95 transition">
                            <i class="fas fa-box-open text-2xl text-blue-600"></i>
                            <span class="text-sm font-bold text-blue-800">×”×–×× ×” ××”×™×¨×”</span>
                        </button>
                    </div>
                `
            });
        };

        // --- 2. Create Transfer (×¨×××™ ×¤×•×ª×— ××”× ×™×™×“) ---
        window.createTransfer = async () => {
            const { value: form } = await Swal.fire({
                title: 'ğŸš› ×”×¢×‘×¨×” ×‘×™×Ÿ ×¡× ×™×¤×™×',
                html: `
                    <select id="swal-from" class="swal2-select w-full mb-3 text-sm">
                        <option value="×”×—×¨×©">×™×¦×™××”: ×”×—×¨×© 10</option>
                        <option value="×”×ª×œ××™×“">×™×¦×™××”: ×”×ª×œ××™×“ 6</option>
                    </select>
                    <select id="swal-to" class="swal2-select w-full mb-3 text-sm">
                        <option value="×”×ª×œ××™×“">×™×¢×“: ×”×ª×œ××™×“ 6</option>
                        <option value="×”×—×¨×©">×™×¢×“: ×”×—×¨×© 10</option>
                        <option value="×œ×§×•×—">×™×¢×“: ××ª×¨ ×œ×§×•×—</option>
                    </select>
                    <textarea id="swal-items" class="swal2-textarea w-full text-sm" placeholder="××” ×œ×”×¢×‘×™×¨? (×œ××©×œ: 2 ××©×˜×—×™ ×‘×œ×•×§)"></textarea>
                `,
                confirmButtonText: 'ğŸš€ ×©×œ×— ×œ×¢×œ×™',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        from: document.getElementById('swal-from').value,
                        to: document.getElementById('swal-to').value,
                        items: document.getElementById('swal-items').value
                    }
                }
            });

            if (form) {
                await addDoc(collection(db, "transfers"), {
                    fromBranch: form.from,
                    toBranch: form.to,
                    items: form.items,
                    status: 'new', // ×–×” ×™×’×¨×•× ×œ××¢×¨×›×ª ×œ×—×›×•×ª ×œ××¡××š ××§×•××§×¡
                    driverId: 'ali_01',
                    createdAt: serverTimestamp(),
                    createdBy: 'Rami Mobile'
                });
                
                Swal.fire({
                    icon: 'success', 
                    title: '× ×©×œ×— ×œ×¢×œ×™!', 
                    text: '×”××©×™××” × ×¤×ª×—×” ×•×××ª×™× ×” ×œ××¡××š',
                    timer: 2000, showConfirmButton: false
                });
            }
        };

        // --- Data Listeners ---
        
        // Orders
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => {
            const list = document.getElementById('orders-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                if(o.status === 'done') return;
                list.innerHTML += `
                <div class="mobile-card">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-800">${o.clientName}</h3>
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded">#${o.orderNum}</span>
                    </div>
                    <p class="text-sm text-gray-500 line-clamp-2">${o.itemsText}</p>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded">${o.status}</span>
                        <button class="text-gray-400"><i class="fas fa-chevron-left"></i></button>
                    </div>
                </div>`;
            });
        });

        // Transfers (×¢× ×”× ×—×©)
        onSnapshot(query(collection(db, "transfers"), orderBy("createdAt", "desc")), (snap) => {
            const list = document.getElementById('transfers-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                const isActive = t.status === 'processing';
                const color = isActive ? 'border-green-500' : 'border-yellow-500';
                
                list.innerHTML += `
                <div class="mobile-card border-r-4 ${color}">
                    <div class="flex justify-between text-xs text-gray-400 mb-2">
                        <span><i class="fas fa-warehouse"></i> ${t.fromBranch}</span>
                        <i class="fas fa-arrow-left"></i>
                        <span><i class="fas fa-building"></i> ${t.toBranch}</span>
                    </div>
                    <div class="font-bold text-sm text-gray-800 mb-2">${t.items}</div>
                    
                    ${isActive ? `<div class="snake-track"><div class="snake-head"></div></div>` : ''}
                    
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex items-center gap-2">
                            <img src="https://ui-avatars.com/api/?name=Ali&background=eab308" class="w-5 h-5 rounded-full">
                            <span class="text-xs font-bold text-gray-600">×¢×œ×™</span>
                        </div>
                        <span class="text-[10px] font-mono bg-gray-100 px-2 rounded text-gray-500">${t.status}</span>
                    </div>
                </div>`;
            });
        });

        // Team (×¡×™××•×œ×¦×™×”)
        const team = [
            {name: '×¢×œ×™', role: '× ×”×’', status: 'busy', loc: '×”×¨×¦×œ×™×”'},
            {name: '×—×›××ª', role: '×× ×•×£', status: 'online', loc: '×”×•×“ ×”×©×¨×•×Ÿ'},
            {name: '×ª××™×¨', role: '××—×¡× ××™', status: 'online', loc: '×”×ª×œ××™×“'},
        ];
        const teamList = document.getElementById('team-list');
        team.forEach(u => {
            const dot = u.status === 'online' ? 'bg-green-500' : 'bg-red-500';
            teamList.innerHTML += `
            <div class="bg-white p-3 rounded-xl border border-gray-200 flex items-center gap-3">
                <div class="relative">
                    <img src="https://ui-avatars.com/api/?name=${u.name}&background=random" class="w-10 h-10 rounded-full">
                    <div class="absolute bottom-0 right-0 w-3 h-3 ${dot} border-2 border-white rounded-full"></div>
                </div>
                <div>
                    <div class="font-bold text-sm">${u.name}</div>
                    <div class="text-[10px] text-gray-500">${u.role} â€¢ ${u.loc}</div>
                </div>
            </div>`;
        });
    </script>
</body>
</html>
