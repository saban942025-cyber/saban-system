<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Drive | 专 住</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #f8fafc; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        .app-header { background: #1e293b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 10; }
        .refresh-btn { width: 32px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .refresh-btn:hover { background: rgba(255,255,255,0.2); transform: rotate(180deg); }

        /* Grid Area */
        .main-area { flex: 1; overflow-y: auto; padding: 20px; }
        .docs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }

        /* Document Card */
        .doc-card { 
            background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s; position: relative;
            display: flex; flex-direction: column; height: 260px;
        }
        .doc-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: #94a3b8; }

        /* Card Header (Preview) */
        .card-preview { 
            height: 120px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; 
            font-size: 48px; color: #cbd5e1; position: relative; cursor: pointer;
        }
        .card-preview img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Badges */
        .source-badge { position: absolute; top: 8px; right: 8px; font-size: 10px; font-weight: bold; padding: 4px 8px; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 5; }
        .badge-manual { background: #dbeafe; color: #1e40af; } /* 注 转 */
        .badge-comax { background: #ffedd5; color: #9a3412; } /* 注  */

        /* Card Content */
        .card-body { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .file-name { font-weight: 700; font-size: 13px; color: #334155; line-height: 1.3; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .meta-row { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #64748b; margin-top: 4px; }
        
        /* Actions Footer */
        .card-actions { border-top: 1px solid #f1f5f9; padding: 10px; display: flex; gap: 8px; background: #fff; }
        .action-btn { flex: 1; font-size: 11px; font-weight: bold; padding: 6px; border-radius: 6px; border: 1px solid #e2e8f0; background: #f8fafc; color: #475569; display: flex; align-items: center; justify-content: center; gap: 4px; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { background: #e2e8f0; }
        .btn-tag { background: #f0fdf4; color: #15803d; border-color: #bbf7d0; }
        .btn-tag:hover { background: #dcfce7; }

        /* Floating Button */
        .fab { position: fixed; bottom: 30px; left: 30px; width: 56px; height: 56px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4); cursor: pointer; transition: 0.2s; z-index: 50; }
        .fab:hover { transform: scale(1.1) rotate(90deg); background: #1d4ed8; }

        .loader { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 14px; flex-direction: column; gap: 10px; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg">
                <i class="fas fa-cloud text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Saban Drive</h1>
                <div class="text-[10px] opacity-70">专 住 专</div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span id="counter" class="text-xs bg-slate-700 px-2 py-1 rounded-md">0 拽爪</span>
            <div class="refresh-btn" onclick="loadFiles()"><i class="fas fa-sync-alt text-xs"></i></div>
        </div>
    </div>

    <div class="main-area">
        <div id="grid" class="docs-grid"></div>
        <div id="loader" class="loader mt-20">
            <i class="fas fa-circle-notch fa-spin text-3xl text-blue-500"></i>
            <span>注 住 注...</span>
        </div>
    </div>

    <div class="fab" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-plus"></i>
    </div>
    <input type="file" id="fileInput" hidden onchange="handleUpload(this)">

    <script>
        // >>> 砖  转 -Web App URL 砖 拽 (Google Apps Script) <<<
        const API_URL = "https://script.google.com/macros/s/AKfycbwIwoPwUA7uKnylbBBLoq06os16t1OV5jxWuohGCXhuWt99JjMfdEp1wWV-rSCeSmaD/exec"; 

        // 专砖转 爪转 转 专 (住驻)
        const STAFF = [
            { name: "专 (\")", phone: "972505227724" },
            { name: " (住专)", phone: "972507855865" },
            { name: "爪拽 (专砖)", phone: "972504482285" },
            { name: "专 (转驻注)", phone: "972508860896" },
            { name: " ()", phone: "" } // 驻转 专转 砖 拽砖专
        ];

        async function loadFiles() {
            const grid = document.getElementById('grid');
            const loader = document.getElementById('loader');
            
            grid.innerHTML = '';
            loader.style.display = 'flex';

            try {
                const res = await fetch(API_URL);
                const files = await res.json();
                
                document.getElementById('counter').innerText = `${files.length} 拽爪`;
                loader.style.display = 'none';

                if (files.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center text-gray-400 mt-10"> 住 爪</div>`;
                    return;
                }

                files.forEach(f => {
                    renderCard(f, grid);
                });

            } catch (err) {
                console.error(err);
                loader.innerHTML = '<span class="text-red-500">砖 注转 转</span>';
            }
        }

        function renderCard(file, container) {
            //  住 拽抓
            const isImg = file.type.includes('image');
            const isPdf = file.type.includes('pdf');
            const icon = isImg ? 'fa-file-image' : (isPdf ? 'fa-file-pdf text-red-500' : 'fa-file text-gray-400');
            
            //  拽专 (驻 砖 拽抓  住 砖专转)
            //  砖住拽专驻 专 source: 'comax'  'manual'
            const isComax = file.source === 'comax';
            const badgeHtml = isComax 
                ? `<span class="source-badge badge-comax"><i class="fas fa-envelope"></i> 拽拽住</span>`
                : `<span class="source-badge badge-manual"><i class="fas fa-user"></i> 专</span>`;

            // 驻专 转专 砖注
            const dateObj = new Date(file.date);
            const dateStr = dateObj.toLocaleDateString('he-IL');
            const timeStr = dateObj.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });

            const previewContent = isImg 
                ? `<img src="${file.url}" loading="lazy">` 
                : `<i class="fas ${icon}"></i>`;

            const card = document.createElement('div');
            card.className = 'doc-card';
            card.innerHTML = `
                ${badgeHtml}
                <div class="card-preview" onclick="window.open('${file.url}', '_blank')">
                    ${previewContent}
                </div>
                <div class="card-body">
                    <div>
                        <div class="file-name" title="${file.name}">${file.name}</div>
                        <div class="meta-row">
                            <i class="far fa-clock"></i>
                            <span>${dateStr} | ${timeStr}</span>
                        </div>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="action-btn" onclick="copyLink('${file.url}')">
                        <i class="fas fa-link"></i> 注转拽
                    </button>
                    <button class="action-btn btn-tag" onclick="tagStaff('${file.name}', '${file.url}')">
                        <i class="fab fa-whatsapp"></i> 转
                    </button>
                </div>
            `;
            container.appendChild(card);
        }

        // --- 注转 拽抓 ---
        async function handleUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // 专 -Base64
            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                
                // 转爪转 注
                Swal.fire({
                    title: '注 拽抓...',
                    text: ' 转',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            fileName: file.name,
                            mimeType: file.type,
                            fileBase64: base64
                        })
                    });
                    const result = await res.json();

                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '拽抓 注!',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        loadFiles(); // 专注
                    } else {
                        throw new Error(result.error);
                    }
                } catch (e) {
                    Swal.fire('砖', '注 砖', 'error');
                }
            };
        }

        // --- 转 砖转祝 ---
        window.tagStaff = (fileName, url) => {
            // 爪专转 专砖转 驻转专 住-专
            const buttonsHtml = STAFF.map(s => 
                `<button onclick="sendToStaff('${s.phone}', '${fileName}', '${url}')" 
                  class="w-full bg-gray-50 border border-gray-200 p-3 rounded-lg mb-2 flex justify-between items-center hover:bg-green-50 hover:border-green-200 transition">
                    <span class="font-bold text-gray-700">${s.name}</span>
                    <i class="fab fa-whatsapp text-green-500 text-xl"></i>
                 </button>`
            ).join('');

            Swal.fire({
                title: '转 砖 爪转',
                html: `<div class="mt-4">${buttonsHtml}</div>`,
                showConfirmButton: false,
                showCloseButton: true
            });
        };

        window.sendToStaff = (phone, name, url) => {
            const text = `*砖转祝 拽抓 注专转 住* \n砖: ${name}\n拽: ${url}`;
            const waLink = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
            window.open(waLink, '_blank');
            Swal.close();
        };

        window.copyLink = (url) => {
            navigator.clipboard.writeText(url);
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 2000
            });
            Toast.fire({ icon: 'success', title: '拽 注转拽!' });
        };

        // 注 专砖转
        loadFiles();
    </script>
</body>
</html>
