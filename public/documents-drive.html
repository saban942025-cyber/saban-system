<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Drive | 住专</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #f1f5f9; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        .app-header { background: #1e293b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 20; }
        
        /* Main Grid */
        .main-area { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 80px; }
        .docs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }

        /* Card Design */
        .doc-card { 
            background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; flex-direction: column;
            transition: transform 0.2s; position: relative;
        }
        .doc-card:active { transform: scale(0.98); }

        /* Preview Section */
        .card-preview { 
            height: 100px; background: #f8fafc; display: flex; align-items: center; justify-content: center; 
            font-size: 40px; color: #cbd5e1; cursor: pointer; position: relative;
        }
        .card-preview img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Badges */
        .badge { position: absolute; top: 6px; right: 6px; font-size: 9px; font-weight: bold; padding: 3px 6px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 5; }
        .bg-manual { background: #dbeafe; color: #1e40af; } 
        .bg-comax { background: #ffedd5; color: #9a3412; }

        /* Content */
        .card-body { padding: 10px; flex: 1; display: flex; flex-direction: column; }
        .file-name { font-weight: 700; font-size: 12px; color: #334155; line-height: 1.3; margin-bottom: 4px; height: 32px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .file-date { font-size: 10px; color: #94a3b8; display: flex; items-center; gap: 4px; }

        /* Buttons Row (New!) */
        .card-actions { 
            padding: 8px; border-top: 1px solid #f1f5f9; background: #fff;
            display: flex; gap: 8px; 
        }
        .btn-action {
            flex: 1; height: 36px; border-radius: 8px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer; border: none; transition: 0.2s;
        }
        
        /* WhatsApp Button */
        .btn-wa { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .btn-wa:hover { background: #bbf7d0; }

        /* App Tag Button */
        .btn-tag { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .btn-tag:hover { background: #dbeafe; }

        /* FAB */
        .fab { position: fixed; bottom: 24px; left: 24px; width: 56px; height: 56px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4); cursor: pointer; z-index: 50; }
        
        /* Loader */
        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #64748b; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg">
                <i class="fas fa-folder-open text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Saban Drive</h1>
                <div class="text-[10px] opacity-80" id="status-text">注...</div>
            </div>
        </div>
        <button onclick="loadFiles()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition">
            <i class="fas fa-sync-alt text-xs"></i>
        </button>
    </div>

    <div class="main-area">
        <div id="grid" class="docs-grid"></div>
        <div id="loader" class="loader-container">
            <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i>
            <span class="text-xs">住专 住...</span>
        </div>
    </div>

    <div class="fab" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-plus"></i>
    </div>
    <input type="file" id="fileInput" hidden onchange="handleUpload(this)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Config (转   砖专 驻拽爪转)
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // >>> 转转 砖 砖住驻拽转 <<<
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIwoPwUA7uKnylbBBLoq06os16t1OV5jxWuohGCXhuWt99JjMfdEp1wWV-rSCeSmaD/exec";

        // 专砖转 注 转
        const STAFF = [
            { id: "harel", name: "专 (\")", phone: "972505227724" },
            { id: "yoav", name: " (住专)", phone: "972507855865" },
            { id: "itzik", name: "爪拽 (专砖)", phone: "972504482285" },
            { id: "oren", name: "专 (爪专)", phone: "972509001392" },
            { id: "ali", name: "注 (祝)", phone: "972500000606" }
        ];

        window.loadFiles = async () => {
            const grid = document.getElementById('grid');
            const loader = document.getElementById('loader');
            
            grid.innerHTML = '';
            loader.style.display = 'flex';

            try {
                const res = await fetch(SCRIPT_URL);
                const files = await res.json();
                
                document.getElementById('status-text').innerText = `${files.length} 住 专`;
                loader.style.display = 'none';

                if (files.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center text-gray-400 mt-10">转拽 专拽</div>`;
                    return;
                }

                files.forEach(f => renderCard(f, grid));

            } catch (err) {
                console.error(err);
                document.getElementById('status-text').innerText = '砖 住专';
                loader.innerHTML = '<span class="text-red-500 text-xs">转拽 专 砖专转</span>';
            }
        };

        function renderCard(file, container) {
            const isImg = file.type.includes('image');
            const isPdf = file.type.includes('pdf');
            const icon = isImg ? 'fa-image text-blue-400' : (isPdf ? 'fa-file-pdf text-red-500' : 'fa-file text-gray-400');
            const sourceBadge = file.source === 'comax' 
                ? `<span class="badge bg-comax">Comax</span>` 
                : `<span class="badge bg-manual"></span>`;

            const dateStr = new Date(file.date).toLocaleDateString('he-IL');
            const preview = isImg ? `<img src="${file.url}" loading="lazy">` : `<i class="fas ${icon}"></i>`;

            const card = document.createElement('div');
            card.className = 'doc-card';
            card.innerHTML = `
                ${sourceBadge}
                <div class="card-preview" onclick="window.open('${file.url}', '_blank')">
                    ${preview}
                </div>
                <div class="card-body">
                    <div class="file-name" title="${file.name}">${file.name}</div>
                    <div class="file-date"><i class="far fa-clock"></i> ${dateStr}</div>
                </div>
                <div class="card-actions">
                    <button class="btn-action btn-wa" onclick="shareToWhatsapp('${file.name}', '${file.url}')">
                        <i class="fab fa-whatsapp text-lg"></i>
                    </button>
                    <button class="btn-action btn-tag" onclick="tagInApp('${file.name}', '${file.url}')">
                        <i class="fas fa-bell text-lg"></i> 转
                    </button>
                </div>
            `;
            container.appendChild(card);
        }

        // --- 驻注转 驻转专 ---

        // 1. 砖转祝 爪祝 (爪)
        window.shareToWhatsapp = (name, url) => {
            const text = `, 拽 住 注专转 住:\n*${name}*\n${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };

        // 2. 转 驻拽爪 (驻 - 转 驻专住)
        window.tagInApp = (fileName, fileUrl) => {
            const options = {};
            STAFF.forEach(s => options[s.id] = s.name);

            Swal.fire({
                title: '转 驻拽爪',
                text: '专  拽驻抓 转专:',
                input: 'select',
                inputOptions: options,
                inputPlaceholder: '专 砖 爪转...',
                showCancelButton: true,
                confirmButtonText: '砖 转专 ',
                confirmButtonColor: '#2563eb'
            }).then(async (result) => {
                if (result.value) {
                    const staffId = result.value;
                    const staffName = STAFF.find(s => s.id === staffId).name;
                    
                    // 转 拽拽爪转 转专转 -Firestore
                    try {
                        await addDoc(collection(db, "notifications"), {
                            targetUser: staffId, // : 'yoav'
                            type: 'document',
                            title: '住 砖 转 注专',
                            body: fileName,
                            link: fileUrl,
                            read: false,
                            createdAt: serverTimestamp()
                        });
                        Swal.fire('砖!', `转专 砖 驻拽爪 砖 ${staffName}`, 'success');
                    } catch (e) {
                        console.error(e);
                        Swal.fire('砖', ' 转  砖 转专', 'error');
                    }
                }
            });
        };

        // --- 注 专 ---
        window.handleUpload = (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                
                Swal.fire({ title: '注...', didOpen: () => Swal.showLoading() });

                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ fileName: file.name, mimeType: file.type, fileBase64: base64 })
                    });
                    const result = await res.json();
                    
                    if(result.success) {
                        Swal.fire('爪', '拽抓 专', 'success');
                        window.loadFiles();
                    } else { throw new Error(result.error); }
                } catch (e) {
                    Swal.fire('砖', '拽 专 专', 'error');
                }
            };
        };

        // 转
        window.loadFiles();
    </script>
</body>
</html>
