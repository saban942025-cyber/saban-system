<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Brain Trainer </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #7c3aed; --glass: rgba(255, 255, 255, 0.95); }
        body { background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); font-family: system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; color: #1e293b; overflow: hidden; }

        /* Container */
        .workspace { max-width: 1200px; margin: 0 auto; width: 100%; height: 100%; display: grid; grid-template-rows: auto 1fr; gap: 20px; padding: 20px; }

        /* Cards */
        .card { background: var(--glass); border: 1px solid white; border-radius: 20px; box-shadow: 0 10px 30px rgba(124, 58, 237, 0.05); overflow: hidden; display: flex; flex-direction: column; }
        
        /* Inputs */
        .input-box { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; outline: none; transition: 0.2s; background: white; font-size: 15px; }
        .input-box:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
        
        /* Table */
        .knowledge-table { width: 100%; border-collapse: collapse; }
        .knowledge-table th { text-align: right; padding: 15px; background: #f8fafc; color: #64748b; font-size: 12px; font-weight: 800; uppercase; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
        .knowledge-table td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: top; }
        .knowledge-table tr:hover { background: #f1f5f9; }
        
        /* Buttons */
        .btn-ai { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; padding: 10px 20px; border-radius: 12px; font-weight: bold; transition: 0.2s; display: flex; items-center; gap: 8px; cursor: pointer; }
        .btn-ai:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(109, 40, 217, 0.3); }
        .btn-save { background: #10b981; color: white; }
        .btn-del { color: #ef4444; background: #fef2f2; padding: 6px; border-radius: 8px; }
        .btn-del:hover { background: #fee2e2; }

        /* Scroll */
        .custom-scroll { overflow-y: auto; scrollbar-width: thin; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <header class="bg-white/80 backdrop-blur px-6 py-3 border-b flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-600 rounded-xl flex items-center justify-center text-white text-xl shadow-lg"></div>
            <div>
                <h1 class="font-bold text-lg leading-none text-slate-800">Brain Trainer</h1>
                <span class="text-xs text-purple-600 font-bold">  (Flash 1.5)</span>
            </div>
        </div>
        <div class="text-xs text-gray-500 font-mono">v4.0 Fixed</div>
    </header>

    <div class="workspace">
        
        <div class="card p-6 grid grid-cols-1 md:grid-cols-2 gap-6 relative">
            
            <div class="space-y-4 border-l pl-6 md:border-l-0 md:pl-0 md:border-r md:pr-6">
                <div class="flex justify-between items-center">
                    <label class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-question-circle text-purple-500"></i> 砖 </label>
                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">砖 1</span>
                </div>
                <textarea id="askInput" class="input-box h-32 resize-none" placeholder="砖:  转专 拽 拽专拽 注 住 专拽?"></textarea>
                <button onclick="askGemini()" id="btnAsk" class="btn-ai w-full justify-center">
                    <i class="fas fa-sparkles"></i> 砖 转  (Gemini)
                </button>
            </div>

            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <label class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-comment-dots text-green-500"></i> 转砖 砖转砖专</label>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">砖 2</span>
                </div>
                <textarea id="answerOutput" class="input-box h-32 resize-none bg-slate-50" placeholder="转砖 转驻注 ... 转 注专 转 驻 砖专."></textarea>
                <button onclick="saveToBrain()" class="btn-ai btn-save w-full justify-center opacity-50 cursor-not-allowed" id="btnSave" disabled>
                    <i class="fas fa-save"></i> 砖专 专 
                </button>
            </div>
        </div>

        <div class="card flex-1">
            <div class="p-4 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                <div class="flex items-center gap-2">
                    <i class="fas fa-database text-blue-500"></i>
                    <h2 class="font-bold text-slate-700">专 注 (砖转 转砖转)</h2>
                </div>
                <div class="relative w-64">
                    <input id="searchTable" class="input-box py-2 text-xs" placeholder="驻砖 专..." oninput="filterTable()">
                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                </div>
            </div>
            
            <div class="custom-scroll flex-1 bg-white">
                <table class="knowledge-table">
                    <thead>
                        <tr>
                            <th width="30%">砖 / 砖</th>
                            <th>转砖 砖专</th>
                            <th width="10%">驻注转</th>
                        </tr>
                    </thead>
                    <tbody id="qaTableBody">
                        <tr><td colspan="3" class="text-center py-10 text-gray-400">注 注...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // API Key
        const GEMINI_KEY = "AIzaSyD9plWwyTESFm24c_OTunf4mFAsAmfrgj0";
        
        // Hardcoded Model Name (Safe & Fast)
        const MODEL_NAME = "gemini-1.5-flash";

        // State
        let knowledgeData = [];

        // --- Logic: Ask Gemini ---
        window.askGemini = async () => {
            const question = document.getElementById('askInput').value;
            if(!question) return alert(" 转 砖");

            const btn = document.getElementById('btnAsk');
            const out = document.getElementById('answerOutput');
            const saveBtn = document.getElementById('btnSave');

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 住 转砖...';
            out.value = "";
            saveBtn.disabled = true; saveBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                // 砖砖 砖专 -1.5 Flash
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_KEY}`;
                
                const prompt = `
                转 注抓   砖 "住 专 ".
                砖 转: "${question}"
                
                转 转砖:
                1. 注 注专转 拽爪注转 拽转.
                2. 转 拽爪专 注 (注 3 砖驻).
                3.  爪专, 爪 爪专 专.
                `;

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if(!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error?.message || res.status);
                }

                const data = await res.json();
                
                if(data.candidates && data.candidates[0].content) {
                    const answer = data.candidates[0].content.parts[0].text;
                    out.value = answer;
                    saveBtn.disabled = false; saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    out.value = " 转拽 转砖 专专.";
                }

            } catch(e) {
                console.error(e);
                out.value = "砖: " + e.message;
            }
            
            btn.innerHTML = '<i class="fas fa-sparkles"></i> 砖 转  (Gemini)';
        };

        // --- Logic: Save to Brain ---
        window.saveToBrain = async () => {
            const question = document.getElementById('askInput').value;
            const answer = document.getElementById('answerOutput').value;

            if(!question || !answer) return;

            try {
                await addDoc(collection(db, "qa_knowledge"), {
                    question: question,
                    answer: answer,
                    createdAt: new Date(),
                    tags: question.split(' ').filter(w => w.length > 3)
                });
                
                alert("砖专 爪! ");
                document.getElementById('askInput').value = '';
                document.getElementById('answerOutput').value = '';
                document.getElementById('btnSave').disabled = true;
                document.getElementById('btnSave').classList.add('opacity-50');
                
                loadKnowledge();

            } catch(e) { alert("砖 砖专"); console.error(e); }
        };

        // --- Logic: Load & Table ---
        async function loadKnowledge() {
            const list = document.getElementById('qaTableBody');
            try {
                const q = query(collection(db, "qa_knowledge"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                knowledgeData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderTable(knowledgeData);
            } catch(e) { console.error(e); list.innerHTML = '<tr><td colspan="3" class="text-center text-red-500">砖 注转 转</td></tr>'; }
        }

        window.renderTable = (data) => {
            const list = document.getElementById('qaTableBody');
            if(data.length === 0) { list.innerHTML = '<tr><td colspan="3" class="text-center py-10 text-gray-400"> 专拽. 转转  转!</td></tr>'; return; }

            list.innerHTML = data.map(item => `
                <tr class="group">
                    <td>
                        <div class="font-bold text-slate-700">${item.question}</div>
                        <div class="text-[10px] text-gray-400 mt-1">${new Date(item.createdAt.seconds*1000).toLocaleDateString()}</div>
                    </td>
                    <td class="text-slate-600 leading-relaxed">${item.answer}</td>
                    <td class="text-center">
                        <button onclick="deleteItem('${item.id}')" class="btn-del"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        window.filterTable = () => {
            const term = document.getElementById('searchTable').value.toLowerCase();
            const filtered = knowledgeData.filter(i => i.question.toLowerCase().includes(term) || i.answer.toLowerCase().includes(term));
            renderTable(filtered);
        };

        window.deleteItem = async (id) => {
            if(!confirm("拽?")) return;
            await deleteDoc(doc(db, "qa_knowledge", id));
            loadKnowledge();
        };

        // Init
        loadKnowledge();
        window.deleteItem = window.deleteItem; // Expose

    </script>
</body>
</html>
