<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban App Platinum ğŸ’ | AI Scanner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- CORE --- */
        body { background: #f0f2f5; font-family: 'Heebo', sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; -webkit-tap-highlight-color: transparent; }

        /* --- X-RAY SCANNER ANIMATION --- */
        .scanner-container {
            position: relative; overflow: hidden; border-radius: 20px;
            background: #0f172a; color: #0ea5e9; padding: 20px; margin-bottom: 20px;
            min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px -10px rgba(14, 165, 233, 0.4); border: 1px solid #1e293b;
        }
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: #0ea5e9; box-shadow: 0 0 20px #0ea5e9;
            animation: scanMove 2s linear infinite; z-index: 10; display: none;
        }
        .scan-grid {
            position: absolute; inset: 0; background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.3; z-index: 1;
        }
        .scan-textarea {
            width: 100%; height: 100%; background: transparent; border: none; outline: none;
            color: #e2e8f0; font-family: monospace; font-size: 14px; resize: none; z-index: 5; text-align: center;
        }
        .scanner-container.active .scan-line { display: block; }
        .scanner-container.active { border-color: #0ea5e9; }

        @keyframes scanMove { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        /* --- PARSED ITEM CARDS --- */
        .parsed-card {
            background: white; border-radius: 16px; padding: 12px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -2px rgba(0,0,0,0.05); transition: 0.2s;
            animation: slideUp 0.3s ease-out; position: relative; overflow: hidden;
        }
        .parsed-card:active { transform: scale(0.98); background: #f8fafc; }
        
        .card-type-product { border-right: 4px solid #10b981; }
        .card-type-address { border-right: 4px solid #3b82f6; background: #eff6ff; }
        .card-type-contact { border-right: 4px solid #8b5cf6; background: #f5f3ff; }

        /* --- MINI MAP --- */
        .mini-map-card {
            background: white; border-radius: 16px; overflow: hidden; margin: 10px 0;
            border: 1px solid #e2e8f0; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .map-visual {
            height: 100px; background: #e0e7ff url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); 
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .map-pin { font-size: 30px; color: #ef4444; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); animation: bounce 1s infinite; }

        /* --- UI UTILS --- */
        .glass-header { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .tab-bar { background: white; border-top: 1px solid #e5e5ea; height: 70px; display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { color: #94a3b8; font-size: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .tab-item.active { color: #007aff; }
        
        .view { display: none; padding: 16px; padding-bottom: 90px; height: 100%; overflow-y: auto; }
        .view.active { display: block; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: flex-end; }
        .modal-sheet { background: white; width: 100%; height: 80vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; animation: slideUpBig 0.3s; }
        @keyframes slideUpBig { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="glass-header">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-slate-900 rounded-xl flex items-center justify-center text-white font-black text-sm shadow-md">S</div>
            <div>
                <div class="font-black text-slate-800 leading-none text-base">Saban App</div>
                <div class="text-[10px] text-slate-500 font-bold">PLATINUM AI ğŸ’</div>
            </div>
        </div>
        <div class="relative cursor-pointer" onclick="switchTab('cart')">
            <div class="w-9 h-9 bg-white rounded-full flex items-center justify-center shadow-sm border border-gray-100"><i class="fas fa-shopping-bag text-slate-700"></i></div>
            <div id="cartBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center shadow-sm border border-white">0</div>
        </div>
    </header>

    <div class="flex-1 relative overflow-hidden">
        
        <div id="view-smart" class="view active">
            
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6 text-center">
                <h2 class="text-xl font-black text-slate-800 mb-1">×©×•×œ×—×Ÿ ×¢×‘×•×“×” ×—×›×</h2>
                <p class="text-xs text-slate-500">×”×“×‘×§ ×¨×©×™××”, ×›×ª×•×‘×ª ×•××™×© ×§×©×¨ - ×× ×™ ××¡×“×¨ ×”×›×œ.</p>
            </div>

            <div id="scannerBox" class="scanner-container">
                <div class="scan-grid"></div>
                <div class="scan-line"></div>
                <textarea id="smartInput" class="scan-textarea" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”×”×•×“×¢×” ××”×•×•×¦××¤...&#10;×œ×“×•×’××”:&#10;×ª×©×œ×— ×œ×¨×—×•×‘ ×•×™×¦××Ÿ 44 ×¨×¢× × ×”&#10;10 ×©×§ ××œ×˜ ×•×“×‘×§ ×§×¨××™×§×”"></textarea>
            </div>

            <button onclick="window.startAIScan()" id="btnScan" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-transform text-lg">
                <i class="fas fa-microchip"></i> ×¡×¨×•×§ ×•×¤×¢× ×— (AI)
            </button>

            <div id="scanResults" class="mt-6 hidden pb-20">
                <div class="flex justify-between items-center mb-3 px-1">
                    <span class="text-xs font-bold text-slate-400 uppercase">×ª×•×¦××•×ª ×”×¤×¢× ×•×—</span>
                    <button onclick="window.clearScan()" class="text-xs text-red-500 font-bold">× ×§×” ×”×›×œ</button>
                </div>
                
                <div id="parsedList" class="space-y-2"></div>
                <div id="geoBox"></div>

                <button onclick="window.finalizeOrder()" class="w-full mt-6 bg-green-600 text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition">
                    <span>××©×¨ ×•×”×¤×§ ×”×–×× ×”</span> <i class="fas fa-file-invoice"></i>
                </button>
            </div>
        </div>

        <div id="view-catalog" class="view">
            <div class="sticky top-0 z-10 bg-[#f0f2f5] pb-2">
                <input id="searchMain" class="w-full bg-white h-12 rounded-2xl pl-4 pr-4 font-bold shadow-sm outline-none border border-transparent focus:border-blue-500" placeholder="ğŸ” ×—×¤×© ××•×¦×¨..." oninput="window.filterCatalog()">
            </div>
            <div id="catalogGrid" class="grid grid-cols-2 gap-3 mt-2"></div>
        </div>

        <div id="view-cart" class="view">
            <h2 class="text-2xl font-black mb-4">×”×¢×’×œ×” ×©×œ×™</h2>
            <div id="cartItems" class="space-y-3">
                <div class="text-center text-gray-400 mt-10">×”×¢×’×œ×” ×¨×™×§×”</div>
            </div>
        </div>

    </div>

    <div id="swapModal" class="modal-overlay" onclick="window.closeSwap(event)">
        <div class="modal-sheet p-5" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-slate-800">×”×—×œ×¤×ª ××•×¦×¨</h3>
                <button onclick="window.closeSwap()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500"><i class="fas fa-times"></i></button>
            </div>
            <input id="swapSearch" class="w-full bg-slate-50 border border-slate-200 h-12 rounded-xl px-4 font-bold mb-4 outline-none focus:border-blue-500" placeholder="×”×§×œ×“ ×©× ××•×¦×¨..." oninput="window.searchSwap()">
            <div id="swapResults" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="window.switchTab('smart')" id="tab-smart"><i class="fas fa-magic text-xl mb-1"></i> ×¡×•×¨×§</div>
        <div class="tab-item" onclick="window.switchTab('catalog')" id="tab-catalog"><i class="fas fa-th-large text-xl mb-1"></i> ×§×˜×œ×•×’</div>
        <div class="tab-item" onclick="window.switchTab('cart')" id="tab-cart"><i class="fas fa-shopping-bag text-xl mb-1"></i> ×¢×’×œ×”</div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const GEMINI_KEY = "AIzaSyAdfGVrmr90Mp9ZhNMItD81iaE8OipKwz0";
        
        let db;
        let catalog = [];
        let parsedData = [];
        let addressInfo = null;
        let contactInfo = null;
        let activeSwapIndex = -1;
        let cart = [];

        // INIT
        (async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const snap = await getDocs(collection(db, "products"));
                catalog = snap.docs.map(d => ({id: d.id, ...d.data()}));
            } catch(e) { 
                console.log("Offline mode"); 
                catalog = [{id:'1', core:{name:'××œ×˜ ×©×—×•×¨', price:25}}, {id:'2', core:{name:'×“×‘×§ ×§×¨××™×§×” 114', price:45}}];
            }
            window.renderCatalog(catalog);
        })();

        // --- GLOBAL FUNCTIONS ---
        window.switchTab = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
        };

        window.renderCatalog = (items) => {
            document.getElementById('catalogGrid').innerHTML = items.map(p => `
                <div class="bg-white rounded-xl p-3 shadow-sm text-center">
                    <img src="${p.rich?.image || 'https://via.placeholder.com/80'}" class="mx-auto h-20 object-contain mb-2">
                    <div class="font-bold text-xs text-slate-800 h-8 line-clamp-2">${p.core.name}</div>
                    <div class="text-blue-600 font-bold text-sm">â‚ª${p.core.price}</div>
                </div>`).join('');
        };

        window.filterCatalog = () => {
            const q = document.getElementById('searchMain').value.toLowerCase();
            window.renderCatalog(catalog.filter(p => p.core.name.toLowerCase().includes(q)));
        };

        window.startAIScan = async () => {
            const text = document.getElementById('smartInput').value;
            if(!text) return alert("×× × ×”×“×‘×§ ×˜×§×¡×˜");

            const box = document.getElementById('scannerBox');
            box.classList.add('active');
            document.getElementById('btnScan').innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ××¤×¢× ×—...';
            
            // Logic
            parsedData = []; addressInfo = null; contactInfo = null;
            const lines = text.split('\n');
            let potentialAddress = "";

            for(let line of lines) {
                const clean = line.trim();
                if(clean.length < 2) continue;
                
                // Contact
                const phoneMatch = clean.match(/(?:05|0\d)-?\d{7,8}/);
                if(phoneMatch) {
                    const phone = phoneMatch[0];
                    const name = clean.replace(phone, '').replace(/[-:]/g,'').trim() || "×œ×§×•×—";
                    contactInfo = { name, phone };
                    continue;
                }
                
                // Address
                if(/×¨×—×•×‘|×¢×™×¨|×œ×›×‘×•×“|×”×’×¢×”/.test(clean) && !/\d{3,}/.test(clean)) {
                    potentialAddress = clean;
                    continue;
                }

                // Product
                const qtyMatch = clean.match(/^(\d+)/) || clean.match(/(\d+)$/);
                let qty = qtyMatch ? parseInt(qtyMatch[0]) : 1;
                let textOnly = clean.replace(/\d+/g, '').replace(/×©×§×™×|×™×—/g, '').trim();
                let match = catalog.find(p => p.core.name.includes(textOnly));
                
                parsedData.push({
                    type: 'product',
                    name: match ? match.core.name : textOnly,
                    qty: qty,
                    price: match?.core?.price || 0,
                    img: match?.rich?.image
                });
            }

            // AI Geo
            if(potentialAddress) {
                addressInfo = { text: potentialAddress };
                const coords = await getCoordinatesByAI(potentialAddress);
                if(coords) { addressInfo.lat = coords.lat; addressInfo.lng = coords.lng; }
            }

            box.classList.remove('active');
            document.getElementById('btnScan').innerHTML = '<i class="fas fa-magic"></i> ×¡×¨×•×§ ×©×•×‘';
            document.getElementById('scanResults').classList.remove('hidden');
            renderParsedResults();
        };

        function renderParsedResults() {
            const list = document.getElementById('parsedList');
            list.innerHTML = '';

            if(contactInfo) {
                list.innerHTML += `<div class="parsed-card card-type-contact"><div class="flex-1 font-bold text-slate-800">${contactInfo.name} <span class="text-xs font-normal">${contactInfo.phone}</span></div></div>`;
            }

            parsedData.forEach((item, i) => {
                list.innerHTML += `
                <div class="parsed-card card-type-product">
                    <img src="${item.img || 'https://via.placeholder.com/50'}" class="w-12 h-12 rounded bg-slate-100 object-cover border">
                    <div class="flex-1" onclick="window.openSwap(${i})">
                        <div class="font-bold text-sm text-slate-800">${item.name}</div>
                        <div class="text-xs text-blue-500 font-bold">×œ×—×¥ ×œ×”×—×œ×¤×”</div>
                    </div>
                    <input type="number" class="w-12 text-center bg-slate-50 border rounded p-1 font-bold outline-none" value="${item.qty}" onchange="parsedData[${i}].qty=this.value">
                    <i class="fas fa-times text-slate-300 px-2" onclick="window.removeItem(${i})"></i>
                </div>`;
            });

            const geoBox = document.getElementById('geoBox');
            if(addressInfo && addressInfo.lat) {
                geoBox.innerHTML = `
                <div class="mini-map-card">
                    <div class="map-visual"><div class="map-pin"><i class="fas fa-map-marker-alt"></i></div></div>
                    <div class="p-3 flex justify-between items-center">
                        <div class="font-bold text-slate-800">${addressInfo.text}</div>
                        <a href="https://waze.com/ul?ll=${addressInfo.lat},${addressInfo.lng}&navigate=yes" target="_blank" class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg"><i class="fab fa-waze text-xl"></i></a>
                    </div>
                </div>`;
            } else { geoBox.innerHTML = ''; }
        }

        // --- INVOICE GENERATOR (FIX GIBBERISH) ---
        window.finalizeOrder = async () => {
            if(parsedData.length === 0) return alert("××™×Ÿ ×¤×¨×™×˜×™×");

            // 1. ×©××™×¨×” ×œ-DB
            try {
                if(db) {
                    await addDoc(collection(db, "orders"), {
                        clientName: contactInfo?.name || "××¤×œ×™×§×¦×™×”",
                        phone: contactInfo?.phone || "",
                        address: addressInfo?.text || "",
                        items: parsedData,
                        status: "new",
                        createdAt: serverTimestamp(),
                        source: "app_scanner"
                    });
                }
            } catch(e) { console.error("Save error", e); }

            // 2. ×™×¦×™×¨×ª ×—×©×‘×•× ×™×ª HTML ×œ×”×“×¤×¡×” (×¤×•×ª×¨ ××ª ×‘×¢×™×™×ª ×”×’'×™×‘×¨×™×© ×‘-PDF)
            const invoiceHTML = `
            <html dir="rtl">
            <head><title>×”×–×× ×” ×—×“×©×”</title><style>body{font-family:sans-serif;padding:20px;text-align:center;}table{width:100%;border-collapse:collapse;margin-top:20px;}th,td{border:1px solid #ddd;padding:8px;}th{background:#f0f0f0;}</style></head>
            <body>
                <h1>×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ ×‘×¢"×</h1>
                <h3>×”×–×× ×ª ×¢×‘×•×“×” / ×”×¦×¢×ª ××—×™×¨</h3>
                <div style="text-align:right;margin:20px 0;background:#f9f9f9;padding:10px;">
                    <strong>×œ×§×•×—:</strong> ${contactInfo?.name || '-'}<br>
                    <strong>×˜×œ×¤×•×Ÿ:</strong> ${contactInfo?.phone || '-'}<br>
                    <strong>×›×ª×•×‘×ª:</strong> ${addressInfo?.text || '-'}
                </div>
                <table>
                    <thead><tr><th>#</th><th>××•×¦×¨</th><th>×›××•×ª</th></tr></thead>
                    <tbody>
                        ${parsedData.map((it,i)=>`<tr><td>${i+1}</td><td>${it.name}</td><td>${it.qty}</td></tr>`).join('')}
                    </tbody>
                </table>
                <br><br>
                <button onclick="window.print()" style="padding:10px 20px;background:blue;color:white;border:none;cursor:pointer;font-size:16px;">×”×“×¤×¡ / ×©××•×¨ ×›-PDF</button>
            </body>
            </html>`;

            const win = window.open("", "_blank");
            win.document.write(invoiceHTML);
            win.document.close();
            
            // × ×™×§×•×™
            window.clearScan();
        };

        // --- UTILS ---
        window.clearScan = () => { parsedData=[]; contactInfo=null; addressInfo=null; renderParsedResults(); };
        window.removeItem = (i) => { parsedData.splice(i, 1); renderParsedResults(); };
        
        async function getCoordinatesByAI(addr) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Return JSON only: { "lat": number, "lng": number } for address: "${addr}, Israel"` }] }] }) 
                });
                const d = await res.json();
                return JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
            } catch(e) { return null; }
        }

        // Swap Utils
        window.openSwap = (i) => { activeSwapIndex = i; document.getElementById('swapModal').style.display='flex'; };
        window.closeSwap = () => document.getElementById('swapModal').style.display='none';
        window.searchSwap = () => {
            const q = document.getElementById('swapSearch').value;
            const res = document.getElementById('swapResults');
            res.innerHTML = catalog.filter(p=>p.core.name.includes(q)).map(p=>`<div class="p-3 border-b" onclick="window.performSwap('${p.id}')">${p.core.name}</div>`).join('');
        };
        window.performSwap = (id) => {
            const p = catalog.find(x=>x.id===id);
            parsedData[activeSwapIndex].name = p.core.name;
            parsedData[activeSwapIndex].price = p.core.price;
            parsedData[activeSwapIndex].img = p.rich?.image;
            renderParsedResults(); window.closeSwap();
        };

    </script>
</body>
</html>
