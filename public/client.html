<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SabanOS App v35.0</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        body { background-color: #e5e7eb; font-family: -apple-system, system-ui, sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .app-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; padding-bottom: 75px; }
        
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Chat */
        .chat-content { flex: 1; overflow-y: auto; background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 12px; font-size: 15px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }
        .msg-in { align-self: flex-start; background: #fff; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        
        /* Attachment Menu (The "Paperclip") */
        .attach-menu { position: absolute; bottom: 80px; left: 10px; right: 10px; background: white; border-radius: 16px; padding: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50; }
        .attach-menu.open { transform: translateY(0); }
        .attach-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .attach-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; }
        .attach-item:active .attach-icon { transform: scale(0.9); }

        /* File Preview in Chat */
        .file-card { background: #f0f2f5; border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px; margin-top: 5px; border: 1px solid #ddd; }
        .file-icon { font-size: 24px; color: #ef4444; } /* PDF Color */

        /* Nav */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; border-top: 1px solid #e5e5eb; display: grid; grid-template-columns: 1fr 1fr 1fr; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; }
        .nav-item.active { color: #008069; }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="bg-[#008069] text-white p-4 h-16 flex items-center justify-between shadow-md z-20">
            <div class="flex items-center gap-3">
                <img id="userAvatar" src="" class="w-9 h-9 rounded-full border border-white/50">
                <div><h1 class="font-bold text-lg leading-tight">×—.×¡×‘×Ÿ</h1><span class="text-xs opacity-90" id="userName">××•×¨×—</span></div>
            </div>
        </header>

        <div id="screen-chat" class="screen active">
            <div class="chat-content" id="chatBox"></div>
            
            <div id="attachMenu" class="attach-menu">
                <div class="attach-item" onclick="sendLocation()">
                    <div class="attach-icon bg-orange-500"><i class="fas fa-map-marker-alt"></i></div>
                    <span class="text-xs font-bold text-gray-600">××™×§×•×</span>
                </div>
                <div class="attach-item" onclick="document.getElementById('fileInput').click()">
                    <div class="attach-icon bg-purple-500"><i class="fas fa-file-upload"></i></div>
                    <span class="text-xs font-bold text-gray-600">××¡××š</span>
                </div>
                <div class="attach-item" onclick="switchScreen('shop'); toggleAttach()">
                    <div class="attach-icon bg-blue-500"><i class="fas fa-store"></i></div>
                    <span class="text-xs font-bold text-gray-600">×§×˜×œ×•×’</span>
                </div>
                <div id="managerTools" class="contents hidden">
                    <div class="attach-item" onclick="sendBotCommand('transfer_flow')">
                        <div class="attach-icon bg-teal-600"><i class="fas fa-exchange-alt"></i></div>
                        <span class="text-xs font-bold text-gray-600">×”×¢×‘×¨×”</span>
                    </div>
                    <div class="attach-item" onclick="sendBotCommand('driver_flow')">
                        <div class="attach-icon bg-slate-700"><i class="fas fa-truck-loading"></i></div>
                        <span class="text-xs font-bold text-gray-600">× ×”×’</span>
                    </div>
                </div>
            </div>
            <input type="file" id="fileInput" class="hidden" onchange="uploadFile(this)">

            <div class="p-2 bg-white border-t flex items-center gap-2">
                <button onclick="toggleAttach()" class="w-10 h-10 rounded-full text-gray-500 text-xl hover:bg-gray-100 transition"><i class="fas fa-paperclip"></i></button>
                <input id="chatInput" class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 text-sm outline-none" placeholder="×”×•×“×¢×”..." onkeydown="if(event.key === 'Enter') sendChat()">
                <button onclick="sendChat()" class="w-10 h-10 rounded-full bg-[#008069] text-white shadow-sm flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="screen-shop" class="screen bg-gray-50"><div class="p-10 text-center text-gray-400">×—× ×•×ª</div></div>
        <div id="screen-cart" class="screen bg-white"><div class="p-10 text-center text-gray-400">×¢×’×œ×”</div></div>
    </div>

    <nav class="nav-bar">
        <div onclick="switchScreen('shop')" class="nav-item nav-shop"><i class="fas fa-store text-xl mb-1"></i><span class="text-[10px]">×—× ×•×ª</span></div>
        <div onclick="switchScreen('cart')" class="nav-item nav-cart"><div class="relative"><i class="fas fa-shopping-bag text-xl mb-1"></i></div><span class="text-[10px]">×¢×’×œ×”</span></div>
        <div onclick="switchScreen('chat')" class="nav-item nav-chat active"><i class="fas fa-comments text-xl mb-1"></i><span class="text-[10px]">×¦'××˜</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanChatbot } from './js/chatbot-engine.js';
        
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = { id:'guest', name:'××•×¨×—', role:'client' };
        let bot = null;

        // --- INIT ---
        window.onload = async () => {
            const uid = new URLSearchParams(window.location.search).get('uid') || localStorage.getItem('saban_uid');
            if (uid) {
                try {
                    const snap = await getDoc(doc(db, "users", uid));
                    if(snap.exists()) currentUser = { id:uid, ...snap.data() };
                    
                    document.getElementById('userName').innerText = currentUser.name;
                    document.getElementById('userAvatar').src = currentUser.avatar || `https://ui-avatars.com/api/?name=${currentUser.name}`;
                    
                    // ×‘×“×™×§×ª ×× ×”×œ
                    if(['manager','branch_manager','admin'].includes(currentUser.role)) {
                        document.getElementById('managerTools').classList.remove('hidden');
                    }

                    // ××ª×—×•×œ ×‘×•×˜
                    bot = new SabanChatbot(db, currentUser);
                    subscribeToChat(uid);

                } catch(e) { console.error(e); }
            }
        };

        // --- ATTACHMENTS LOGIC ---
        window.toggleAttach = () => document.getElementById('attachMenu').classList.toggle('open');

        window.sendLocation = () => {
            if(!navigator.geolocation) return alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘××™×§×•×");
            toggleAttach();
            // ×©×œ×™×—×ª ×”×•×“×¢×ª ××¢×¨×›×ª
            addDoc(collection(db, `chat_sessions/${currentUser.id}/messages`), { 
                text: "ğŸ“ ××—×©×‘ ××™×§×•×...", role: 'user', createdAt: serverTimestamp() 
            });
            
            navigator.geolocation.getCurrentPosition(pos => {
                const link = `${pos.coords.latitude},${pos.coords.longitude}`;
                // ×©×œ×™×—×” ×œ×‘×•×˜ ×•×œ×¦'××˜
                handleBotInteraction(`LOCATION:${link}`);
            }, () => alert("×©×’×™××” ×‘×§×‘×œ×ª ××™×§×•×"));
        };

        window.uploadFile = (input) => {
            const file = input.files[0];
            if(!file) return;
            toggleAttach();
            
            // ×”×“××™×™×ª ×”×¢×œ××” (×‘×¤×¨×•×“×§×©×Ÿ: ×©×œ×™×—×” ×œ-Storage)
            const fakeUrl = URL.createObjectURL(file);
            
            const html = `
                <div class="file-card">
                    <div class="file-icon"><i class="fas fa-file-alt"></i></div>
                    <div>
                        <div class="font-bold text-sm">${file.name}</div>
                        <div class="text-[10px] text-gray-500">${(file.size/1024).toFixed(1)}KB â€¢ ×”×•×¢×œ×” ×¢×›×©×™×•</div>
                    </div>
                </div>`;
            
            addDoc(collection(db, `chat_sessions/${currentUser.id}/messages`), { 
                text: html, role: 'user', createdAt: serverTimestamp() 
            });
            
            // ×¢×“×›×•×Ÿ ×”×‘×•×˜
            handleBotInteraction(`FILE:|${file.name}`);
        };

        window.sendBotCommand = (cmd) => {
            toggleAttach();
            handleBotInteraction(cmd);
        };

        // --- CHAT ENGINE ---
        function subscribeToChat(uid) {
            onSnapshot(query(collection(db, `chat_sessions/${uid}/messages`), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('chatBox');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const cls = m.role==='user'?'msg-out':'msg-in';
                    return `<div class="msg ${cls}">${m.text}</div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendChat = async () => {
            const txt = document.getElementById('chatInput').value; if(!txt) return;
            document.getElementById('chatInput').value='';
            
            await addDoc(collection(db, `chat_sessions/${currentUser.id}/messages`), { text: txt, role: 'user', createdAt: serverTimestamp() });
            
            handleBotInteraction(txt);
        };

        async function handleBotInteraction(txt) {
            if(!bot) return;
            // ×©×œ×™×—×” ×œ××•×—
            const response = await bot.ask(txt);
            
            if(response && response.text) {
                setTimeout(async () => {
                    await addDoc(collection(db, `chat_sessions/${currentUser.id}/messages`), { 
                        text: response.text, role: 'staff', sender: 'SabanBot', createdAt: serverTimestamp() 
                    });
                    
                    // ×× ×™×© ×›×¤×ª×•×¨×™×
                    if(response.buttons) {
                         const btnsHtml = response.buttons.map(b => `<button onclick="sendBotCommand('${b.payload}')" class="block w-full bg-white border border-green-200 text-green-700 text-sm font-bold py-2 rounded mt-1">${b.label}</button>`).join('');
                         await addDoc(collection(db, `chat_sessions/${currentUser.id}/messages`), { 
                            text: btnsHtml, role: 'staff', sender: 'System', createdAt: serverTimestamp() 
                        });
                    }

                }, 800); // ×”×©×”×™×™×” ×˜×‘×¢×™×ª
            }
        }

        // Utils
        window.switchScreen = (n) => { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(`screen-${n}`).classList.add('active'); };
        window.handleLogout = () => { localStorage.clear(); location.href="index.html"; };

    </script>
</body>
</html>
