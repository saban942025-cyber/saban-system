<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban App ğŸ’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* iOS Look & Feel */
        body { background: #f2f2f7; font-family: -apple-system, BlinkMacSystemFont, sans-serif; -webkit-tap-highlight-color: transparent; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Glass Header */
        .glass-header {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50;
        }

        /* Product Card */
        .product-card {
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s; display: flex; flex-direction: column;
        }
        .product-card:active { transform: scale(0.98); }
        .stock-badge {
            position: absolute; top: 8px; right: 8px; font-size: 10px; font-weight: bold;
            padding: 4px 8px; border-radius: 12px; z-index: 10;
        }
        .stock-ok { background: #dcfce7; color: #15803d; } /* ×™×¨×•×§ */
        .stock-low { background: #fee2e2; color: #991b1b; } /* ××“×•× */

        /* Chat Bubbles */
        .chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .bubble { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; line-height: 1.5; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .bubble-bot { background: white; color: #1e293b; border-top-right-radius: 4px; border: 1px solid #e2e8f0; }
        .bubble-user { background: #2563eb; color: white; border-top-left-radius: 4px; align-self: flex-end; }
        .bubble-sys { text-align: center; font-size: 11px; color: #94a3b8; margin: 5px 0; }

        /* Checkout Form */
        .form-input {
            width: 100%; padding: 12px; border-radius: 12px; background: #f1f5f9;
            border: 1px solid transparent; outline: none; font-size: 15px; margin-bottom: 10px;
            transition: 0.2s;
        }
        .form-input:focus { background: white; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        /* Navigation Bar */
        .nav-bar {
            background: white; border-top: 1px solid #e5e5ea; padding-bottom: env(safe-area-inset-bottom);
            display: flex; justify-content: space-around; height: 65px; align-items: center;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; font-size: 10px; font-weight: 500; cursor: pointer; width: 100%; }
        .nav-item.active { color: #2563eb; }
        .nav-icon { font-size: 20px; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    </style>
</head>
<body>

    <header class="glass-header px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-sm shadow-lg">S</div>
            <div>
                <div class="font-bold text-slate-800 leading-none">Saban</div>
                <div class="text-[10px] text-slate-500">×”×‘×™×ª ×œ×§×‘×œ×Ÿ</div>
            </div>
        </div>
        <div class="relative" onclick="switchTab('cart')">
            <i class="fas fa-shopping-cart text-slate-600 text-xl"></i>
            <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
        </div>
    </header>

    <main id="view-catalog" class="flex-1 overflow-y-auto p-4 custom-scroll">
        <div class="relative mb-6">
            <input type="text" id="catalogSearch" placeholder="××” ××—×¤×©×™× ×”×™×•×? (×œ××©×œ: ×¡×™×§×”, ×’×‘×¡...)" class="w-full bg-white p-3 pr-10 rounded-xl shadow-sm border border-slate-100 outline-none" oninput="renderCatalog(this.value)">
            <i class="fas fa-search absolute left-3 top-3.5 text-slate-400"></i>
        </div>

        <div id="catalogGrid" class="grid grid-cols-2 gap-3 pb-20">
            <div class="col-span-2 text-center py-10 text-slate-400">
                <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i>
                <p>×˜×•×¢×Ÿ ××ª ×”××“×¤×™×...</p>
            </div>
        </div>
    </main>

    <main id="view-chat" class="flex-1 flex flex-col hidden bg-slate-50">
        <div id="chatBox" class="chat-container">
            <div class="bubble bubble-bot">
                ×”×™×™ ×©×—×¨! ğŸ‘‹<br>×× ×™ ×›××Ÿ ×œ×›×œ ×©××œ×”.<br>
                ××ª×” ×™×›×•×œ ×œ×©××•×œ ××•×ª×™ ×¢×œ <b>×—×™×©×•×‘ ×›××•×™×•×ª</b> (×œ××©×œ: ×›××” ×“×‘×§ ×¦×¨×™×š ×œ-20 ×"×¨), ××• ×œ×”×ª×™×™×¢×¥ ×¢×œ ××•×¦×¨×™×.
            </div>
        </div>
        
        <div class="p-3 bg-white border-t flex gap-2">
            <input type="text" id="chatInput" placeholder="×©××œ ××•×ª×™ ××©×”×•..." class="flex-1 bg-slate-100 rounded-xl px-4 outline-none border border-transparent focus:border-blue-500 transition">
            <button onclick="sendChat()" class="w-10 h-10 bg-blue-600 text-white rounded-xl shadow-lg flex items-center justify-center hover:scale-105 transition">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </main>

    <main id="view-cart" class="flex-1 overflow-y-auto p-4 hidden">
        <h2 class="text-xl font-bold text-slate-800 mb-4">×¡×™×›×•× ×”×–×× ×”</h2>
        
        <div id="cartItemsList" class="space-y-3 mb-6">
            <div class="text-center text-sm text-slate-400 py-6">×”×¢×’×œ×” ×¨×™×§×”</div>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-20">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700">×¤×¨×˜×™× ×œ××©×œ×•×—</h3>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="sameAsUser" onchange="autoFillUser()" class="w-4 h-4">
                    <label for="sameAsUser" class="text-xs font-bold text-slate-500">×× ×™ ×”××–××™×Ÿ</label>
                </div>
            </div>

            <input id="ordProject" class="form-input" placeholder="×©× ×”×¤×¨×•×™×§×˜ (×—×•×‘×”)">
            <input id="ordAddress" class="form-input" placeholder="×›×ª×•×‘×ª / ×¢×™×¨">
            <input id="ordContact" class="form-input" placeholder="×©× ××™×© ×§×©×¨ ×‘×©×˜×—">
            <input id="ordPhone" type="tel" class="form-input" placeholder="× ×™×™×“ ××™×© ×§×©×¨">

            <button onclick="getLocation()" id="btnLocation" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl mb-4 flex items-center justify-center gap-2 border border-slate-200">
                <i class="fas fa-location-arrow text-blue-500"></i> ×¦×¨×£ ××™×§×•× × ×•×›×—×™ (Waze)
            </button>
            <input type="hidden" id="wazeLink">

            <button onclick="submitOrder()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-xl flex items-center justify-center gap-3 text-lg">
                <span>×©×œ×— ×”×–×× ×”</span>
                <i class="fas fa-check"></i>
            </button>
        </div>
    </main>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('catalog')" id="nav-catalog">
            <i class="nav-icon fas fa-th-large"></i>
            <span>×§×˜×œ×•×’</span>
        </div>
        <div class="nav-item" onclick="switchTab('chat')" id="nav-chat">
            <i class="nav-icon fas fa-robot"></i>
            <span>×™×•×¢×¥ ×—×›×</span>
        </div>
        <div class="nav-item" onclick="switchTab('cart')" id="nav-cart">
            <i class="nav-icon fas fa-clipboard-list"></i>
            <span>×”×–×× ×”</span>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        // ×™×™×‘×•× ×”×× ×•×¢ ×”×—×›× ×©×‘× ×™× ×•
        import { SabanChatbot } from './js/chatbot-engine.js';

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Simulated User (Shahar Shaul)
        const currentUser = { name: "×©×—×¨ ×©××•×œ", phone: "050-0000000", id: "user_123" };
        
        // Init Bot
        const bot = new SabanChatbot(db, currentUser);

        // State
        let allProducts = [];
        let cart = [];

        // --- Catalog Logic ---
        window.loadCatalog = async () => {
            try {
                const snap = await getDocs(collection(db, "products"));
                allProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderCatalog();
            } catch(e) { console.error(e); }
        };

        window.renderCatalog = (filter = "") => {
            const grid = document.getElementById('catalogGrid');
            const term = filter.toLowerCase();
            const filtered = allProducts.filter(p => p.core.name.toLowerCase().includes(term));

            if(filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-2 text-center py-10 text-slate-400">×œ× × ××¦××• ××•×¦×¨×™×</div>';
                return;
            }

            grid.innerHTML = filtered.map(p => {
                const stockStatus = p.core.warehouse === 'both' ? '×‘××œ××™ (×ª×œ××™×“+×—×¨×©)' : (p.core.warehouse === 'harash' ? '×‘××œ××™ (×—×¨×©)' : '×‘××œ××™ (×ª×œ××™×“)');
                const stockClass = 'stock-ok'; // ×›×¨×’×¢ ×›×•×œ× ×™×¨×•×§×™× ×œ×¦×•×¨×š ×”×“×’××”
                
                return `
                <div class="product-card relative group">
                    <div class="stock-badge ${stockClass}">${stockStatus}</div>
                    
                    <div class="h-32 p-4 flex items-center justify-center bg-white border-b border-slate-50">
                        <img src="${p.rich?.image || 'https://via.placeholder.com/150'}" class="h-full object-contain">
                    </div>
                    
                    <div class="p-3">
                        <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">${p.core.brand || '×›×œ×œ×™'}</div>
                        <div class="font-bold text-slate-800 text-sm leading-tight line-clamp-2 h-10 mb-1">${p.core.name}</div>
                        <div class="flex justify-between items-center mt-2">
                            <div class="font-bold text-blue-600">â‚ª${p.core.price}</div>
                            
                            <div class="flex gap-2">
                                <button onclick="consultProduct('${p.core.name}')" class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100">
                                    <i class="fas fa-comment-dots text-xs"></i>
                                </button>
                                <button onclick="addToCart('${p.id}')" class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center shadow-lg hover:bg-slate-700">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        };

        // --- Chat Logic ---
        window.sendChat = async (overrideMsg = null) => {
            const input = document.getElementById('chatInput');
            const msg = overrideMsg || input.value;
            if(!msg) return;

            // UI User
            addBubble(msg, 'user');
            input.value = '';

            // UI Bot Thinking
            const loadId = addBubble('<i class="fas fa-circle-notch fa-spin"></i> ×‘×•×“×§...', 'bot');

            try {
                // Call Gemini Engine
                const res = await bot.ask(msg);
                
                // Replace loading with answer
                document.getElementById(loadId).innerHTML = res.text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                
                // Sound Effect
                // new Audio('pop.mp3').play().catch(()=>{}); 
                
            } catch(e) {
                document.getElementById(loadId).innerText = "×ª×§×œ×” ×‘×—×™×‘×•×¨. × ×¡×” ×©×•×‘.";
            }
        };

        window.consultProduct = (prodName) => {
            switchTab('chat');
            const msg = `×× ×™ ××ª×¢× ×™×™×Ÿ ×‘××•×¦×¨ "${prodName}". ×¡×¤×¨ ×œ×™ ×¢×œ×™×• ×•×”×× ×”×•× ××ª××™× ×œ×™?`;
            sendChat(msg);
        };

        function addBubble(text, type) {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `bubble bubble-${type}`;
            div.innerHTML = text;
            div.id = 'msg-' + Date.now();
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div.id;
        }

        // --- Cart & Order Logic ---
        window.addToCart = (id) => {
            const prod = allProducts.find(p => p.id === id);
            if(prod) {
                cart.push(prod);
                updateCartUI();
                
                // Animation Feedback
                const badge = document.getElementById('cartCount');
                badge.classList.add('animate-ping');
                setTimeout(() => badge.classList.remove('animate-ping'), 500);
            }
        };

        function updateCartUI() {
            const list = document.getElementById('cartItemsList');
            const badge = document.getElementById('cartCount');
            
            badge.innerText = cart.length;
            badge.classList.remove('hidden');

            if(cart.length === 0) {
                list.innerHTML = '<div class="text-center text-sm text-slate-400 py-6">×”×¢×’×œ×” ×¨×™×§×”</div>';
                return;
            }

            list.innerHTML = cart.map((item, idx) => `
                <div class="flex items-center gap-3 bg-white p-3 rounded-xl border border-slate-100">
                    <img src="${item.rich?.image}" class="w-10 h-10 rounded object-cover bg-slate-50">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-xs truncate">${item.core.name}</div>
                        <div class="text-blue-600 font-bold text-xs">â‚ª${item.core.price}</div>
                    </div>
                    <button onclick="removeFromCart(${idx})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        window.removeFromCart = (idx) => {
            cart.splice(idx, 1);
            updateCartUI();
        };

        window.autoFillUser = () => {
            const checked = document.getElementById('sameAsUser').checked;
            if(checked) {
                document.getElementById('ordContact').value = currentUser.name;
                document.getElementById('ordPhone').value = currentUser.phone;
            } else {
                document.getElementById('ordContact').value = '';
                document.getElementById('ordPhone').value = '';
            }
        };

        window.getLocation = () => {
            const btn = document.getElementById('btnLocation');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×××ª×¨...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        const wazeUrl = `https://waze.com/ul?ll=${latitude},${longitude}&navigate=yes`;
                        document.getElementById('wazeLink').value = wazeUrl;
                        btn.className = "w-full bg-green-50 text-green-600 border border-green-200 font-bold py-3 rounded-xl mb-4 flex items-center justify-center gap-2";
                        btn.innerHTML = '<i class="fas fa-check"></i> ××™×§×•× ×¦×•×¨×£ ×‘×”×¦×œ×—×”';
                    }, 
                    (err) => {
                        alert("×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ ××™×§×•×. ×•×•×“× ×©×”-GPS ×“×œ×•×§.");
                        btn.innerHTML = '<i class="fas fa-location-arrow text-blue-500"></i> × ×¡×” ×©×•×‘';
                    }
                );
            } else {
                alert("×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘××™×§×•×");
            }
        };

        window.submitOrder = async () => {
            if(cart.length === 0) return alert("×”×¢×’×œ×” ×¨×™×§×”!");
            
            const order = {
                project: document.getElementById('ordProject').value,
                address: document.getElementById('ordAddress').value,
                contactName: document.getElementById('ordContact').value,
                contactPhone: document.getElementById('ordPhone').value,
                wazeLink: document.getElementById('wazeLink').value,
                items: cart.map(i => ({id: i.id, name: i.core.name, price: i.core.price})),
                user: currentUser,
                status: 'new',
                createdAt: new Date()
            };

            if(!order.project || !order.contactName) return alert("× × ×œ××œ× ×©× ×¤×¨×•×™×§×˜ ×•××™×© ×§×©×¨");

            try {
                await addDoc(collection(db, "orders"), order);
                
                // Show Success
                alert("×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”! ğŸš€\n××•×¨×Ÿ ×‘×—×\"×œ ×›×‘×¨ ×¨×•××” ××ª ×–×”.");
                cart = [];
                updateCartUI();
                switchTab('catalog');
            } catch(e) {
                console.error(e);
                alert("×©×’×™××” ×‘×©×œ×™×—×”.");
            }
        };

        // --- Tabs System ---
        window.switchTab = (tabId) => {
            ['catalog', 'chat', 'cart'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('active');
            });
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.add('active');
        };

        // Init
        loadCatalog();
        
        // Expose functions globally
        window.removeFromCart = window.removeFromCart;

    </script>
</body>
</html>
