<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SabanOS | Client App v48.0</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, system-ui, sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .app-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; padding-bottom: 80px; }
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ×›×¤×ª×•×¨×™ ×©×¢×¨ (×¢×™×¦×•×‘ ×—×“×© ×•××¨×©×™×) --- */
        .gate-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .gate-btn { 
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 24px; 
            box-shadow: 5px 5px 15px #d1d9e6, -5px -5px 15px #ffffff;
            padding: 20px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; 
            height: 160px; /* ×’×“×•×œ ×•××¨×©×™× */
            border: 1px solid #fff;
            transition: transform 0.1s;
        }
        .gate-btn:active { transform: scale(0.98); box-shadow: inset 5px 5px 10px #d1d9e6, inset -5px -5px 10px #ffffff; }
        .gate-emoji { font-size: 48px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .gate-title { font-weight: 800; font-size: 17px; color: #1e293b; text-align: center; line-height: 1.2; }
        .gate-desc { font-size: 11px; color: #64748b; text-align: center; font-weight: 500; }

        /* ×›×¨×˜×™×¡×™ ×× ×©×™ ×¦×•×•×ª */
        .staff-card { display: flex; align-items: center; background: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #f0f0f0; }
        .staff-card:active { background: #f9fafb; }
        .staff-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-left: 15px; border: 2px solid #e2e8f0; }

        /* Chat */
        .chat-content { flex: 1; overflow-y: auto; background-color: #efeae2; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 85%; padding: 14px; border-radius: 16px; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: fit-content; }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }

        /* Modals & Nav */
        .modal-full { position: fixed; inset: 0; background: white; z-index: 100; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .modal-full.open { transform: translateY(0); }
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; border-top: 1px solid #e5e5eb; display: grid; grid-template-columns: 1fr 1fr 1fr; z-index: 50; padding-bottom: 15px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #9ca3af; font-size: 11px; font-weight: 600; }
        .nav-item.active { color: #008069; } .nav-item i { font-size: 26px; margin-bottom: 4px; }
        
        /* Products */
        .product-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e5e7eb; position: relative; }
        .product-img { width: 100%; height: 140px; object-fit: contain; padding: 10px; background: #fff; }
        .scale-btn { position: absolute; top: 10px; right: 10px; background: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #64748b; border: 1px solid #e2e8f0; }
        .scale-btn.active { background: #3b82f6; color: white; border-color: #2563eb; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="app-container">
        <header class="bg-[#008069] text-white p-5 h-20 flex items-center justify-between shadow-lg z-20 shrink-0 rounded-b-3xl">
            <div class="flex items-center gap-4" onclick="showMyProfile()">
                <img id="userAvatar" src="https://via.placeholder.com/50" class="w-12 h-12 rounded-full border-2 border-white/50 bg-white/10 object-cover shadow-md">
                <div>
                    <h1 class="font-black text-xl leading-tight">×©×œ×•×, <span id="userName">××•×¨×—</span></h1>
                    <span class="text-xs opacity-90">×¤×•×¨×˜×œ ×œ×§×•×—×•×ª ×¡×‘×Ÿ VIP</span>
                </div>
            </div>
        </header>

        <div id="screen-home" class="screen active overflow-y-auto">
            <div class="gate-grid">
                <div onclick="switchScreen('shop')" class="gate-btn">
                    <span class="gate-emoji">ğŸ§±</span>
                    <span class="gate-title">×—× ×•×ª ×•×”×–×× ×•×ª</span>
                    <span class="gate-desc">×§×˜×œ×•×’ ×—×•××¨×™× ×•××œ××™</span>
                </div>
                
                <div onclick="startContainerFlow()" class="gate-btn">
                    <span class="gate-emoji">ğŸšš</span>
                    <span class="gate-title">×”×–××Ÿ ××›×•×œ×”</span>
                    <span class="gate-desc">8 ×§×•×‘ / ×¤×™× ×•×™ ×¤×¡×•×œ×ª</span>
                </div>

                <div onclick="openHistoryModal()" class="gate-btn">
                    <span class="gate-emoji">ğŸ“œ</span>
                    <span class="gate-title">×”×–×× ×•×ª ×©×œ×™</span>
                    <span class="gate-desc">×¡×˜×˜×•×¡, ××¨×›×™×•×Ÿ ×•×—×©×‘×•× ×™×•×ª</span>
                </div>

                <div onclick="document.getElementById('contactModal').classList.add('open')" class="gate-btn">
                    <span class="gate-emoji">ğŸ‘·</span>
                    <span class="gate-title">×× ×©×™ ×¦×•×•×ª</span>
                    <span class="gate-desc">×¤× ×™×” ×™×©×™×¨×” ×œ×× ×”×œ×™×</span>
                </div>
            </div>

            <div class="px-5 pb-5">
                <div onclick="switchScreen('chat'); sendChat('×× ×™ ×¦×¨×™×š ×œ×”×ª×™×™×¢×¥...')" class="bg-indigo-600 rounded-2xl p-5 text-white shadow-xl flex items-center justify-between cursor-pointer active:scale-95 transition">
                    <div>
                        <div class="font-bold text-lg mb-1">ğŸ’¬ ×¦'××˜-×¡×‘×Ÿ</div>
                        <div class="text-indigo-200 text-sm">×”×¢×•×–×¨ ×”××™×©×™ ×©×œ×š ×œ×›×œ ×©××œ×”</div>
                    </div>
                    <div class="text-4xl">ğŸ¤–</div>
                </div>
            </div>
        </div>

        <div id="screen-shop" class="screen">
            <div class="p-4 flex-1 overflow-y-auto pb-24">
                <div class="relative mb-6">
                    <input type="text" id="searchInput" oninput="filterProducts()" placeholder="×—×™×¤×•×© ××•×¦×¨..." class="w-full p-4 pl-10 bg-white rounded-xl text-sm outline-none shadow-sm border border-gray-200 focus:border-green-500">
                    <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                </div>
                <div id="productsGrid" class="grid grid-cols-2 gap-4 pb-4"></div>
            </div>
        </div>

        <div id="screen-cart" class="screen bg-white">
            <header class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-20 shadow-sm"><h2 class="font-bold text-xl text-gray-800">ğŸ›’ ×”×¢×’×œ×” ×©×œ×™</h2><button onclick="clearCart()" class="text-red-500 text-xs font-bold">× ×§×”</button></header>
            <div id="cartItemsList" class="p-4 space-y-3 flex-1 overflow-y-auto"></div>
            <div class="p-4 border-t shadow-lg">
                <button onclick="submitOrder()" class="w-full bg-[#008069] text-white py-4 rounded-xl font-bold shadow-md active:scale-95 transition text-lg">×©×œ×— ×”×–×× ×” ×œ×—×"×œ ğŸš€</button>
            </div>
        </div>

        <div id="screen-chat" class="screen">
            <div class="chat-content" id="chatBox"></div>
            <div class="p-3 bg-white border-t flex items-center gap-2">
                <button onclick="openPasteOrder()" class="text-blue-600 bg-blue-50 p-3 rounded-full"><i class="fas fa-paste"></i></button>
                <input id="chatInput" class="flex-1 bg-gray-100 rounded-full px-5 py-3 text-sm outline-none" placeholder="×”×§×œ×“..." onkeydown="if(event.key === 'Enter') sendChat()">
                <button onclick="sendChat()" class="bg-[#008069] text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition"><i class="fas fa-paper-plane text-lg"></i></button>
            </div>
        </div>
    </div>

    <div id="contactModal" class="modal-full">
        <div class="h-16 flex items-center justify-between px-6 border-b bg-white shadow-sm">
            <button onclick="document.getElementById('contactModal').classList.remove('open')" class="w-10 h-10 bg-gray-100 rounded-full"><i class="fas fa-arrow-down"></i></button>
            <span class="font-bold text-lg">×× ×©×™ ×§×©×¨</span>
            <div class="w-10"></div>
        </div>
        <div class="p-5 bg-gray-50 flex-1 overflow-y-auto">
            <p class="text-gray-500 text-sm mb-4 text-center">×‘×—×¨ ××™×© ×§×©×¨ ×œ×¤×ª×™×—×ª ×¤× ×™×™×” ×™×©×™×¨×”:</p>
            
            <div onclick="contactStaff('×¨××™', '×× ×”×œ ×ª×¤×¢×•×œ')" class="staff-card">
                <img src="https://ui-avatars.com/api/?name=Rami&background=008069&color=fff" class="staff-img">
                <div class="flex-1 mr-4">
                    <div class="font-bold text-lg text-gray-800">×¨××™ ××¡××¨×•×”</div>
                    <div class="text-sm text-gray-500">×× ×”×œ ×ª×¤×¢×•×œ ×¨××©×™</div>
                </div>
                <i class="fas fa-comment text-green-600 text-xl"></i>
            </div>

            <div onclick="contactStaff('×”×¨××œ', '×”× ×”×œ×ª ×—×©×‘×•× ×•×ª')" class="staff-card">
                <img src="https://ui-avatars.com/api/?name=Harel&background=6366f1&color=fff" class="staff-img">
                <div class="flex-1 mr-4">
                    <div class="font-bold text-lg text-gray-800">×”×¨××œ</div>
                    <div class="text-sm text-gray-500">×× ×›"×œ / ×›×¡×¤×™×</div>
                </div>
                <i class="fas fa-comment text-indigo-600 text-xl"></i>
            </div>

            <div onclick="contactStaff('××•×¨×Ÿ', '××—×¡× ××™')" class="staff-card">
                <img src="https://ui-avatars.com/api/?name=Oren&background=f59e0b&color=fff" class="staff-img">
                <div class="flex-1 mr-4">
                    <div class="font-bold text-lg text-gray-800">××•×¨×Ÿ</div>
                    <div class="text-sm text-gray-500">×× ×”×œ ××—×¡×Ÿ</div>
                </div>
                <i class="fas fa-comment text-orange-600 text-xl"></i>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal-full">
        <div class="h-14 flex items-center justify-between px-4 border-b bg-white shadow-sm sticky top-0 z-30">
            <button onclick="closeProductModal()" class="w-9 h-9 bg-gray-100 rounded-full text-gray-600"><i class="fas fa-arrow-right"></i></button>
            <span class="font-bold text-sm">×¤×¨×˜×™ ××•×¦×¨</span><div class="w-9"></div>
        </div>
        <div class="flex-1 flex flex-col overflow-hidden bg-white">
            <img id="modalImg" src="" class="h-48 object-contain my-6">
            <div class="px-6 text-center">
                <h1 class="text-2xl font-black text-gray-800" id="modalName"></h1>
                <div class="text-4xl font-bold text-[#008069] mt-2">â‚ª<span id="modalPrice"></span></div>
            </div>
            
            <div class="flex border-b border-gray-100 mt-6 bg-gray-50">
                <div class="flex-1 text-center p-3 font-bold text-gray-600 border-b-2 border-green-600">××¤×¨×˜ ×˜×›× ×™</div>
            </div>

            <div class="p-6 overflow-y-auto">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-2xl text-center border border-blue-100">
                        <div class="text-xs font-bold text-blue-600 uppercase mb-1">××©×§×œ</div>
                        <div class="text-2xl font-black text-blue-900" id="modalWeight">-</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-2xl text-center border border-orange-100">
                        <div class="text-xs font-bold text-orange-600 uppercase mb-1">×× ×•×£</div>
                        <div class="text-2xl font-black text-orange-900" id="modalCrane">-</div>
                    </div>
                </div>
                
                <p id="content-desc" class="text-gray-600 leading-relaxed text-sm"></p>
                
                <div class="mt-4 bg-gray-100 rounded-xl p-4 flex items-center justify-center gap-2 text-gray-500 text-sm">
                    <i class="fab fa-youtube text-red-600 text-xl"></i> ×¡×¨×˜×•×Ÿ ×”×“×¨×›×” ×–××™×Ÿ
                </div>
            </div>
        </div>
        <div class="p-4 bg-white border-t flex gap-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
            <button onclick="consultBot()" class="bg-indigo-50 text-indigo-600 px-5 rounded-2xl font-bold flex flex-col items-center justify-center text-xs w-24">
                <i class="fas fa-robot text-2xl mb-1"></i> ×”×ª×™×™×¢×¥
            </button>
            <button onclick="addToCartFromModal()" class="flex-1 bg-[#008069] text-white py-3 rounded-2xl font-bold text-xl shadow-lg active:scale-95 transition">×”×•×¡×£ ×œ×¢×’×œ×”</button>
        </div>
    </div>

    <div id="historyModal" class="modal-full"><div class="h-14 flex items-center justify-between px-4 border-b bg-white"><button onclick="document.getElementById('historyModal').classList.remove('open')" class="w-9 h-9 bg-gray-100 rounded-full"><i class="fas fa-times"></i></button><span class="font-bold">×”×–×× ×•×ª ×©×œ×™</span><div class="w-9"></div></div><div class="p-4 bg-gray-50 flex-1 overflow-y-auto" id="historyContent"></div></div>
    <div id="pasteModal" class="modal-full"><div class="h-14 flex items-center justify-between px-4 border-b bg-white"><button onclick="document.getElementById('pasteModal').classList.remove('open')" class="w-9 h-9 bg-gray-100 rounded-full"><i class="fas fa-times"></i></button><span class="font-bold">×”×–×× ×” ××”×™×¨×”</span><div class="w-9"></div></div><div class="p-5 flex-1 flex flex-col"><textarea id="pasteInput" class="flex-1 w-full border p-4 rounded-xl text-lg bg-gray-50 outline-none resize-none focus:bg-white focus:border-green-500 shadow-inner" placeholder="×”×“×‘×§ ×›××Ÿ ×¨×©×™××” ××•×•××˜×¡××¤..."></textarea><button onclick="submitPasteOrder()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold mt-4 shadow-lg text-lg">×©×œ×— ×”×–×× ×” ğŸš€</button></div></div>

    <nav class="nav-bar">
        <div onclick="switchScreen('home')" class="nav-item nav-home active"><i class="fas fa-home"></i><span>×¨××©×™</span></div>
        <div onclick="switchScreen('shop')" class="nav-item nav-shop"><i class="fas fa-store"></i><span>×—× ×•×ª</span></div>
        <div onclick="switchScreen('cart')" class="nav-item nav-cart"><i class="fas fa-shopping-bag"></i><span>×¢×’×œ×”</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, getDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanSounds } from './js/sounds.js';
        import { SabanChatbot } from './js/chatbot-engine.js';

        // Init
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        let app, db; try{app=initializeApp(firebaseConfig);db=getFirestore(app);}catch(e){}

        let currentUser={id:'guest',name:'××•×¨×—'}, cart=[], allProducts=[], bot;
        window.audioUnlocked = false;

        // --- Container Flow Logic (The Script) ---
        window.startContainerFlow = async () => {
            switchScreen('chat');
            sendChat('×× ×™ ×¦×¨×™×š ×œ×”×–××™×Ÿ ××›×•×œ×” ğŸšš');
            
            // ×“×™× ××™×§×” ××œ××”
            setTimeout(() => {
                addBotMsg('×‘×›×™×£! ×œ××™×–×• ×¢×™×¨ ×”××›×•×œ×” ××™×•×¢×“×ª?');
                // ×›××Ÿ ×”×œ×§×•×— ×™×¢× ×”, ××‘×œ ×œ×¦×•×¨×š ×”×¤×©×˜×•×ª × ×¦×™×’ ×œ×• ×›×¤×ª×•×¨×™×
                // (×‘×’×¨×¡×” ××œ××” ×”×‘×•×˜ ×™×—×›×” ×œ×ª×©×•×‘×”)
            }, 1000);
        };

        // --- Contact Staff Logic ---
        window.contactStaff = (name, role) => {
            document.getElementById('contactModal').classList.remove('open');
            switchScreen('chat');
            sendChat(`ğŸ‘‹ ×”×™×™, ×× ×™ ××‘×§×© ×©${name} (${role}) ×™×—×–×•×¨ ××œ×™×™ ×‘×”×§×“×.`);
        };

        // --- Core Functions ---
        window.unlockAudio = () => { if(!window.audioUnlocked && SabanSounds) { SabanSounds.playMessage(); window.audioUnlocked = true; } };
        window.switchScreen = (n) => { 
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
            document.getElementById(`screen-${n}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            if(document.querySelector(`.nav-${n}`)) document.querySelector(`.nav-${n}`).classList.add('active');
        };

        // Product Modal Logic
        window.openProduct = (pStr) => { 
            const p=JSON.parse(decodeURIComponent(pStr)); 
            document.getElementById('modalName').innerText=p.core?.name; 
            document.getElementById('modalPrice').innerText=p.core?.price; 
            document.getElementById('modalImg').src=p.rich?.image; 
            document.getElementById('content-desc').innerText=p.rich?.description || "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ"; 
            document.getElementById('modalWeight').innerText=(p.logistics?.weight||'-')+' ×§"×’'; 
            document.getElementById('modalCrane').innerText=p.logistics?.requires_crane?'×›×Ÿ':'×œ×'; 
            document.getElementById('productModal').classList.add('open'); 
        };
        window.closeProductModal = () => document.getElementById('productModal').classList.remove('open');
        window.addToCartFromModal = () => { window.quickAdd(document.getElementById('modalName').innerText); window.closeProductModal(); };
        window.consultBot = () => { window.closeProductModal(); window.switchScreen('chat'); window.sendChat(`××ª×™×™×¢×¥ ×œ×’×‘×™ ${document.getElementById('modalName').innerText}`); };

        // Cart & Chat
        window.quickAdd = (name) => { cart.push({name}); updateCart(); };
        window.updateCart = () => { document.getElementById('cartItemsList').innerHTML=cart.map(i=>`<div class="p-3 border rounded bg-white">${i.name}</div>`).join(''); };
        window.clearCart = () => { cart=[]; updateCart(); };
        window.submitOrder = () => { if(cart.length){ window.sendChat('×”×–×× ×” ×—×“×©×” × ×©×œ×—×” ×œ×—×"×œ ğŸš€'); cart=[]; updateCart(); window.switchScreen('chat'); }};

        window.sendChat = async (msg) => {
            const txt = msg || document.getElementById('chatInput').value; if(!txt) return;
            document.getElementById('chatInput').value = '';
            if(db) await addDoc(collection(db, `chat_sessions/${currentUser.id}/messages`), { text: txt, role: 'user', createdAt: serverTimestamp() });
            
            // Bot Response (Simulated Delay)
            if(bot) {
                const res = await bot.ask(txt);
                if(res?.text) setTimeout(()=> addBotMsg(res.text), 1000);
            }
        };

        const addBotMsg = async (text) => {
            if(db) await addDoc(collection(db, `chat_sessions/${currentUser.id}/messages`), { text: text, role: 'staff', sender: 'SabanBot', createdAt: serverTimestamp() });
            SabanSounds.playMessage();
        };

        window.openPasteOrder = () => document.getElementById('pasteModal').classList.add('open');
        window.submitPasteOrder = () => { const t=document.getElementById('pasteInput').value; if(t){ window.sendChat(`ğŸ“ ×¨×©×™××”:\n${t}`); document.getElementById('pasteModal').classList.remove('open'); window.switchScreen('chat'); }};
        
        window.openHistoryModal = async () => {
            document.getElementById('historyModal').classList.add('open');
            const c = document.getElementById('historyContent');
            if(!db) { c.innerHTML="××•×¤×œ×™×™×Ÿ"; return; }
            const q = query(collection(db, "active_orders"), where("clientUid", "==", currentUser.id));
            const snap = await getDocs(q);
            c.innerHTML = snap.docs.map(d => `<div class="bg-white p-4 mb-3 rounded-xl border-l-4 border-green-500 font-bold shadow-sm flex justify-between"><span>×”×–×× ×” #${d.id}</span><span class="text-green-600">${d.data().status}</span></div>`).join('') || '<div class="text-center text-gray-400 mt-10">××™×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</div>';
        };

        // Init
        window.onload = async () => {
            if(db) {
                getDocs(collection(db,"products")).then(s => {
                    document.getElementById('productsGrid').innerHTML = s.docs.map(d=>{
                        const p = d.data(); const pStr=encodeURIComponent(JSON.stringify(p));
                        return `<div class="product-card" onclick="openProduct('${pStr}')"><img src="${p.rich?.image}" class="product-img"><div class="p-3 border-t"><div class="font-bold text-xs h-8 overflow-hidden">${p.core.name}</div><div class="flex justify-between mt-1"><span class="text-green-600 font-bold">â‚ª${p.core.price}</span></div></div></div>`;
                    }).join('');
                });
                
                const uid = new URLSearchParams(window.location.search).get('uid') || localStorage.getItem('impersonateId');
                if(uid) {
                    getDoc(doc(db,"users",uid)).then(s=>{ 
                        if(s.exists()) currentUser={id:uid,...s.data()};
                        document.getElementById('userName').innerText=currentUser.name;
                        document.getElementById('userAvatar').src=currentUser.avatar;
                        bot = new SabanChatbot(db, currentUser);
                        onSnapshot(query(collection(db, `chat_sessions/${uid}/messages`), orderBy("createdAt", "asc")), snap => {
                            document.getElementById('chatBox').innerHTML = snap.docs.map(d => `<div class="msg ${d.data().role==='user'?'msg-out':'msg-in'}">${d.data().text}</div>`).join('');
                            document.getElementById('chatBox').scrollTop = 9999;
                        });
                    });
                }
            }
        };
    </script>
</body>
</html>
