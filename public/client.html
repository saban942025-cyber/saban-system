<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SabanOS | Client App v18.0</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Screens */
        .screen { display: none; height: 100%; flex-direction: column; overflow: hidden; }
        .screen.active { display: flex; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Navigation */
        .nav-bar { background: white; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: 20px; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9ca3af; font-size: 10px; cursor: pointer; width: 33%; }
        .nav-item.active { color: #008069; font-weight: bold; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        .badge { position: absolute; top: -5px; right: 25%; background: #ef4444; color: white; font-size: 10px; padding: 1px 5px; border-radius: 10px; }

        /* Cart Items */
        .cart-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .qty-btn { width: 24px; height: 24px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }

        /* Confirmation Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 60; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 16px; padding: 20px; max-height: 80vh; overflow-y: auto; position: relative; }
        
        .bot-analysis { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 13px; color: #166534; }
        .bot-warning { background: #fef2f2; border: 1px solid #fecaca; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 13px; color: #991b1b; display: flex; gap: 8px; align-items: start; }
    </style>
</head>
<body>

    <header class="bg-[#008069] text-white p-3 shadow-md sticky top-0 z-10 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img id="userAvatar" src="" class="w-9 h-9 rounded-full border border-white/30">
            <div>
                <h1 class="font-bold text-lg leading-tight">×—.×¡×‘×Ÿ</h1>
                <span class="text-[10px] opacity-90 block">××—×•×‘×¨: <span id="userName" class="font-bold">...</span></span>
            </div>
        </div>
        <button onclick="handleLogout()" class="text-white/80 hover:text-white px-2"><i class="fas fa-sign-out-alt"></i></button>
    </header>

    <div id="screen-shop" class="screen active">
        <div class="p-3 bg-white shadow-sm z-10">
            <input type="text" id="searchInput" oninput="filterProducts()" placeholder="×—×¤×© ××•×¦×¨ (××œ×˜, ×‘×œ×•×§...)" class="w-full p-2 bg-gray-100 rounded-lg text-sm outline-none border border-transparent focus:border-green-500 transition">
        </div>
        <main class="flex-1 p-3 overflow-y-auto bg-gray-50 pb-24">
            <div id="productsGrid" class="grid grid-cols-2 gap-3"></div>
        </main>
    </div>

    <div id="screen-cart" class="screen">
        <main class="flex-1 p-3 overflow-y-auto bg-gray-50 pb-24">
            <h2 class="font-bold text-lg mb-3 text-gray-700">ğŸ›’ ×”×¢×’×œ×” ×©×œ×š</h2>
            <div id="cartItemsList" class="mb-6">
                </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <h3 class="font-bold text-sm text-gray-800 mb-3 border-b pb-2">×¤×¨×˜×™ ×¤×¨×•×™×§×˜ ×•××™×© ×§×©×¨</h3>
                
                <div id="lastContactBox" class="hidden mb-3 bg-blue-50 p-2 rounded text-xs text-blue-700 flex justify-between items-center cursor-pointer border border-blue-100" onclick="fillLastContact()">
                    <span><i class="fas fa-history"></i> ×”×©×ª××© ×‘×¤×¨×˜×™× ××—×¨×•× ×™× (×™×•×¡×™)</span>
                    <i class="fas fa-chevron-left"></i>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500">×©× ×”×¤×¨×•×™×§×˜ / ××ª×¨</label>
                        <input type="text" id="projName" placeholder="×œ××©×œ: ×•×™×œ×” ××©×¤×—×ª ×›×”×Ÿ" class="w-full border p-2 rounded text-sm focus:border-green-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">×›×ª×•×‘×ª ×œ××©×œ×•×—</label>
                        <input type="text" id="projAddr" placeholder="×¨×—×•×‘ ×•×¢×™×¨" class="w-full border p-2 rounded text-sm focus:border-green-500 outline-none">
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="text-xs text-gray-500">×©× ××™×© ×§×©×¨</label>
                            <input type="text" id="contactName" placeholder="××§×‘×œ ×”×¡×—×•×¨×”" class="w-full border p-2 rounded text-sm focus:border-green-500 outline-none">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs text-gray-500">×˜×œ×¤×•×Ÿ</label>
                            <input type="tel" id="contactPhone" placeholder="050..." class="w-full border p-2 rounded text-sm focus:border-green-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">×”×¢×¨×•×ª ×œ× ×”×’ / ×©×™×˜×ª ×¤×¨×™×§×”</label>
                        <select id="deliveryType" class="w-full border p-2 rounded text-sm bg-white focus:border-green-500 outline-none">
                            <option value="manual">×¤×¨×™×§×” ×¨×’×™×œ×” (×œ×™×“ ×”××©××™×ª)</option>
                            <option value="crane">×× ×•×£ (×§×•××”/×’×’)</option>
                            <option value="pickup">××™×¡×•×£ ×¢×¦××™</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button onclick="analyzeAndReview()" class="w-full bg-[#008069] text-white py-3 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2">
                    <i class="fas fa-robot"></i> × ×ª×— ×”×–×× ×” ×•×©×œ×— ×œ××™×©×•×¨
                </button>
            </div>
        </main>
    </div>

    <div id="reviewModal" class="modal-overlay hidden">
        <div class="modal-box">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto text-xl mb-2"><i class="fas fa-clipboard-check"></i></div>
                <h3 class="font-bold text-lg">×©×™×§×•×£ ×”×–×× ×” - ××™×©×•×¨ ×¡×•×¤×™</h3>
                <p class="text-xs text-gray-500">SabanAI × ×™×ª×— ××ª ×”×”×–×× ×” ×©×œ×š</p>
            </div>

            <div class="bg-gray-50 p-3 rounded-lg text-sm mb-4 border border-gray-200">
                <div class="flex justify-between border-b pb-2 mb-2">
                    <span class="font-bold">×¤×¨×•×™×§×˜:</span>
                    <span id="reviewProject">---</span>
                </div>
                <div class="flex justify-between border-b pb-2 mb-2">
                    <span class="font-bold">××™×© ×§×©×¨:</span>
                    <span id="reviewContact">---</span>
                </div>
                <div class="max-h-32 overflow-y-auto mb-2">
                    <ul id="reviewItems" class="list-disc pr-4 text-xs text-gray-600 space-y-1"></ul>
                </div>
                <div class="flex justify-between font-bold text-lg pt-2 border-t border-gray-300">
                    <span>×¡×”"×› ×œ×ª×©×œ×•×:</span>
                    <span id="reviewTotal" class="text-green-700">0.00 â‚ª</span>
                </div>
            </div>

            <div id="botFeedbackArea"></div>

            <div class="flex gap-2 mt-6">
                <button onclick="document.getElementById('reviewModal').classList.add('hidden')" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold text-sm">×¢×¨×•×š ×©×•×‘</button>
                <button onclick="confirmOrder()" class="flex-1 bg-[#008069] text-white py-2 rounded-lg font-bold text-sm shadow">×××©×¨ ×•×©×•×œ×— âœ…</button>
            </div>
        </div>
    </div>

    <nav class="nav-bar fixed bottom-0 w-full">
        <div onclick="switchScreen('shop')" class="nav-item active" id="nav-shop">
            <i class="fas fa-store nav-icon"></i><span>×—× ×•×ª</span>
        </div>
        <div onclick="switchScreen('cart')" class="nav-item relative" id="nav-cart">
            <i class="fas fa-shopping-cart nav-icon"></i><span>×¢×’×œ×”</span>
            <span id="cartBadge" class="badge hidden">0</span>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- STATE ---
        let cart = []; // Array of objects: { id, name, price, qty, logicData }
        let allProducts = [];
        let currentUser = { id: 'guest', name: '××•×¨×—' };

        // --- INIT ---
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const uid = params.get('uid') || localStorage.getItem('impersonateId');
            
            if (uid) {
                currentUser.id = uid;
                currentUser.name = uid.replace('_', ' ');
                document.getElementById('userName').innerText = currentUser.name;
                document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${currentUser.name}&background=ffffff&color=008069&bold=true`;
            }

            loadProducts();
            checkLastContact();
        };

        // --- PRODUCTS & CART ---
        async function loadProducts() {
            try {
                const snap = await getDocs(collection(db, "products"));
                allProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderProducts(allProducts);
            } catch(e) { console.error(e); }
        }

        function renderProducts(list) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = list.map(p => {
                const name = p.core?.name || p.title;
                const price = p.core?.price || p.price;
                const img = p.rich?.image || p.image || "https://via.placeholder.com/100?text=No+Img";
                
                // ×œ×•×’×™×§×” ×œ×‘×•×˜ (×”×× ×›×‘×“? ×”×× ×¦×¨×™×š ×× ×•×£?)
                const logistics = JSON.stringify(p.logistics || {});

                return `
                <div class="bg-white p-3 rounded-xl shadow-sm flex flex-col items-center justify-between h-48" onclick='addToCart("${p.id}", "${name}", ${price}, ${logistics})'>
                    <img src="${img}" class="w-20 h-20 object-contain mb-2 mix-blend-multiply">
                    <div class="text-center w-full">
                        <h3 class="font-bold text-xs text-gray-800 line-clamp-2 h-8 leading-tight">${name}</h3>
                        <div class="text-[#008069] font-bold text-sm mt-1">â‚ª${price}</div>
                    </div>
                    <button class="w-full bg-gray-100 hover:bg-green-50 text-green-700 text-xs py-1.5 rounded-lg font-bold mt-2 transition">+ ×”×•×¡×£</button>
                </div>`;
            }).join('');
        }

        window.addToCart = (id, name, price, logistics) => {
            const existing = cart.find(i => i.id === id);
            if (existing) existing.qty++;
            else cart.push({ id, name, price, qty: 1, logistics });
            
            updateCartBadge();
            renderCartItems();
            // Subtle feedback
            if(navigator.vibrate) navigator.vibrate(20);
        };

        function updateCartBadge() {
            const b = document.getElementById('cartBadge');
            const total = cart.reduce((acc, i) => acc + i.qty, 0);
            b.innerText = total;
            b.classList.toggle('hidden', total === 0);
        }

        // --- CART MANAGEMENT ---
        function renderCartItems() {
            const container = document.getElementById('cartItemsList');
            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">×”×¢×’×œ×” ×¨×™×§×”</div>';
                return;
            }
            container.innerHTML = cart.map((item, i) => `
                <div class="cart-item">
                    <div>
                        <div class="font-bold text-sm text-gray-800">${item.name}</div>
                        <div class="text-xs text-gray-500">â‚ª${item.price} ×œ×™×—'</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="qty-btn" onclick="updateQty(${i}, -1)">-</div>
                        <span class="font-bold text-sm w-4 text-center">${item.qty}</span>
                        <div class="qty-btn" onclick="updateQty(${i}, 1)">+</div>
                    </div>
                </div>
            `).join('');
        }

        window.updateQty = (index, delta) => {
            cart[index].qty += delta;
            if (cart[index].qty <= 0) cart.splice(index, 1);
            renderCartItems();
            updateCartBadge();
        };

        // --- CONTACT MEMORY ---
        function checkLastContact() {
            const last = JSON.parse(localStorage.getItem('last_contact'));
            if (last) {
                const box = document.getElementById('lastContactBox');
                box.querySelector('span').innerHTML = `<i class="fas fa-history"></i> ×”×©×ª××© ×‘××—×¨×•×Ÿ: <b>${last.name}</b> (${last.proj})`;
                box.classList.remove('hidden');
            }
        }

        window.fillLastContact = () => {
            const last = JSON.parse(localStorage.getItem('last_contact'));
            if (last) {
                document.getElementById('projName').value = last.proj;
                document.getElementById('projAddr').value = last.addr;
                document.getElementById('contactName').value = last.name;
                document.getElementById('contactPhone').value = last.phone;
                document.getElementById('lastContactBox').classList.add('hidden');
            }
        };

        // --- BOT ANALYST (SabanLogic) ---
        window.analyzeAndReview = () => {
            if (cart.length === 0) return alert("×”×¢×’×œ×” ×¨×™×§×”");
            
            // 1. Gather Data
            const proj = document.getElementById('projName').value || "×œ× ×¦×•×™×Ÿ";
            const contact = document.getElementById('contactName').value || currentUser.name;
            const deliveryType = document.getElementById('deliveryType').value;
            const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);

            // 2. Run Logic (The Brain)
            const feedbackArea = document.getElementById('botFeedbackArea');
            feedbackArea.innerHTML = '';
            
            let heavyItems = false;
            cart.forEach(i => { if (i.logistics?.weight > 20 || i.logistics?.requires_crane) heavyItems = true; });

            // LOGIC RULES
            if (heavyItems && deliveryType === 'manual') {
                feedbackArea.innerHTML += `
                <div class="bot-warning">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                    <div>
                        <b>×©×™× ×œ×‘:</b> ×™×© ×¤×¨×™×˜×™× ×›×‘×“×™× ×‘×”×–×× ×” (×›××• ××œ×˜/×‘×œ×•×§×™×) ××‘×œ ×‘×—×¨×ª <b>"×¤×¨×™×§×” ×™×“× ×™×ª"</b>.<br>
                        ×”×× ××ª×” ×‘×˜×•×— ×©×™×© ××™ ×©×™×¤×¨×•×§? × ×”×’ ×œ× ×¤×•×¨×§ ×™×“× ×™×ª.
                        <br><button onclick="changeDeliveryToCrane()" class="text-blue-600 underline text-xs mt-1">×”×—×œ×£ ×œ×× ×•×£</button>
                    </div>
                </div>`;
            } else {
                feedbackArea.innerHTML += `
                <div class="bot-analysis">
                    <i class="fas fa-check-circle"></i> ×”×”×–×× ×” × ×‘×“×§×” ×•× ×¨××™×ª ×ª×§×™× ×” ×œ×•×’×™×¡×˜×™×ª.
                </div>`;
            }

            // 3. Populate Review
            document.getElementById('reviewProject').innerText = proj;
            document.getElementById('reviewContact').innerText = contact;
            document.getElementById('reviewTotal').innerText = `â‚ª${total.toFixed(2)}`;
            document.getElementById('reviewItems').innerHTML = cart.map(i => `<li>${i.name} (x${i.qty})</li>`).join('');

            document.getElementById('reviewModal').classList.remove('hidden');
        };

        window.changeDeliveryToCrane = () => {
            document.getElementById('deliveryType').value = 'crane';
            document.getElementById('botFeedbackArea').innerHTML = `<div class="bot-analysis"><i class="fas fa-check"></i> ×¢×•×“×›×Ÿ ×œ×× ×•×£. ×ª×§×™×Ÿ.</div>`;
        };

        // --- SUBMIT ---
        window.confirmOrder = async () => {
            // Save contact for next time
            const contactData = {
                proj: document.getElementById('projName').value,
                addr: document.getElementById('projAddr').value,
                name: document.getElementById('contactName').value,
                phone: document.getElementById('contactPhone').value
            };
            localStorage.setItem('last_contact', JSON.stringify(contactData));

            // Send to Firestore
            const orderData = {
                clientId: currentUser.id,
                clientName: currentUser.name,
                project: contactData.proj,
                address: contactData.addr,
                contactPerson: contactData.name,
                contactPhone: contactData.phone,
                deliveryType: document.getElementById('deliveryType').value,
                items: cart,
                totalPrice: cart.reduce((acc, i) => acc + (i.price * i.qty), 0),
                status: "new",
                createdAt: serverTimestamp()
            };

            await addDoc(collection(db, "orders"), orderData);
            
            // Notify & Reset
            alert("×”×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”! ğŸš€\n×§×‘×œ×” ×ª×©×œ×— ×œ×•×•×¦××£.");
            cart = [];
            updateCartBadge();
            renderCartItems();
            document.getElementById('reviewModal').classList.add('hidden');
            switchScreen('shop');
        };

        // --- NAVIGATION ---
        window.switchScreen = (name) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${name}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-${name}`).classList.add('active');
        };

        window.filterProducts = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(p => (p.core?.name || p.title || "").toLowerCase().includes(term));
            renderProducts(filtered);
        };

        window.handleLogout = () => {
            localStorage.removeItem('impersonateId');
            signOut(auth).then(() => window.location.href="index.html");
        };
    </script>
</body>
</html>
