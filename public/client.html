<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SabanOS | Client App v25.1</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        /* (××•×ª×• CSS ×›××• ×§×•×“×) */
        body { background-color: #e5e7eb; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .app-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding-bottom: 75px; }
        .screen { display: none; flex-direction: column; height: 100%; overflow: hidden; }
        .screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chat-content { flex: 1; overflow-y: auto; background-color: #efeae2; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 12px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: #fff; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: rgba(255,255,255,0.98); border-top: 1px solid #e5e5eb; display: grid; grid-template-columns: 1fr 1fr 1fr; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; }
        .nav-item.active { color: #008069; }
        .product-card { background: white; border-radius: 16px; padding: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="bg-[#008069] text-white p-4 flex justify-between items-center h-16 shadow-md z-20">
            <h1 class="font-bold text-lg">×—.×¡×‘×Ÿ | <span id="userName">××•×¨×—</span></h1>
        </header>

        <div id="screen-shop" class="screen active bg-gray-50">
            <div class="p-4 overflow-y-auto">
                <button onclick="startContainerFlow()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white p-4 rounded-xl shadow-lg mb-4 flex items-center justify-between">
                    <span class="font-bold text-lg"><i class="fas fa-trash-alt"></i> ×”×–×× ×ª ××›×•×œ×”</span>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="productsGrid" class="grid grid-cols-2 gap-3"></div>
            </div>
        </div>

        <div id="screen-cart" class="screen bg-white">
            <div class="p-4 border-b flex justify-between items-center"><h2 class="font-bold text-xl">ğŸ›’ ×¢×’×œ×”</h2><button onclick="clearCart()" class="text-red-500 text-sm">× ×§×”</button></div>
            <div id="cartItemsList" class="p-4 flex-1 overflow-y-auto space-y-3"></div>
            <div class="p-4 border-t"><button onclick="analyzeAndMoveToChat()" class="w-full bg-[#008069] text-white py-3 rounded-xl font-bold">××©×¨ ×•×©×œ×— ×œ×¡×™×“×•×¨</button></div>
        </div>

        <div id="screen-chat" class="screen">
            <div class="chat-content" id="chatBox"></div>
            <div class="bg-white p-3 border-t flex gap-2">
                <input id="chatInput" class="flex-1 bg-gray-100 rounded-full px-4 py-2" placeholder="×”×•×“×¢×”...">
                <button onclick="sendChat()" class="bg-[#008069] text-white w-10 h-10 rounded-full"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <div onclick="switchScreen('shop')" class="nav-item active" id="nav-shop"><i class="fas fa-store"></i><span>×—× ×•×ª</span></div>
        <div onclick="switchScreen('cart')" class="nav-item" id="nav-cart"><i class="fas fa-shopping-bag"></i><span id="cartBadge">0</span></div>
        <div onclick="switchScreen('chat')" class="nav-item" id="nav-chat"><i class="fas fa-comments"></i><span>×¦'××˜</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanLogic } from './js/saban-brain.js';
        import { SabanPush } from './js/notifications.js'; // ×™×™×‘×•× ×”××¢×¨×›×ª ×”×—×“×©×”

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = { id: 'guest', name: '××•×¨×—' };
        let cart = [];
        let allProducts = [];

        window.onload = () => {
            const uid = new URLSearchParams(window.location.search).get('uid');
            if (uid) { 
                currentUser.id = uid; 
                currentUser.name = uid.replace('_',' '); 
                document.getElementById('userName').innerText = currentUser.name; 
                
                // ğŸ”” ×”×¤×¢×œ×ª ×”×¨×©××” ×œ×”×ª×¨××•×ª ×œ×œ×§×•×—
                SabanPush.init('client', currentUser.id);
                
                subscribeToChat(uid); 
            }
            loadProducts();
        };

        // ... (×©××¨ ×”×§×•×“ ×©×œ ×”×—× ×•×ª ×œ×œ× ×©×™× ×•×™, ×”×©××¨×ª×™ ××•×ª×• ×§×¦×¨ ×›×“×™ ×œ× ×œ×”×¢××™×¡) ...
        async function loadProducts() { const snap = await getDocs(collection(db, "products")); allProducts = snap.docs.map(d => ({id: d.id, ...d.data()})); renderProducts(allProducts); }
        function renderProducts(list) { document.getElementById('productsGrid').innerHTML = list.map(p => { const pStr = encodeURIComponent(JSON.stringify(p)); return `<div class="bg-white p-3 rounded-xl shadow-sm border" onclick="addToCart('${pStr}')"><div class="font-bold text-sm h-10 overflow-hidden">${p.core?.name || p.title}</div><div class="text-green-600 font-bold text-xs mt-1">â‚ª${p.core?.price || p.price}</div><button class="w-full bg-gray-100 text-xs py-1 rounded mt-2">×”×•×¡×£ +</button></div>`; }).join(''); }
        window.addToCart = (pStr) => { const p = JSON.parse(decodeURIComponent(pStr)); const exist = cart.find(i => i.id === p.id); if (exist) exist.qty++; else cart.push({ id: p.id, name: p.core?.name || p.title, price: p.core?.price || p.price, qty: 1, logistics: p.logistics || {} }); updateCartUI(); };
        function updateCartUI() { document.getElementById('cartBadge').innerText = cart.reduce((a,c)=>a+c.qty,0); document.getElementById('cartItemsList').innerHTML = cart.map(i => `<div class="flex justify-between border-b pb-2"><span>${i.name} (x${i.qty})</span><span>â‚ª${i.price*i.qty}</span></div>`).join(''); }
        window.clearCart = () => { cart = []; updateCartUI(); };
        window.analyzeAndMoveToChat = async () => { if (cart.length === 0) return alert("×¢×’×œ×” ×¨×™×§×”"); const analysis = SabanLogic.analyzeCart(cart); if (!analysis.isValid) return alert(analysis.missingServices[0].msg); const txt = `<b>×”×–×× ×” ×—×“×©×”:</b><br>${cart.map(i=>`â–«ï¸ ${i.name} x${i.qty}`).join('<br>')}<br>×¡×”"×›: â‚ª${analysis.totalPrice}`; switchScreen('chat'); await addDoc(collection(db, `chat_sessions/${currentUser.id}/messages`), { text: txt, role: 'user', createdAt: serverTimestamp() }); await setDoc(doc(db, "chat_sessions", currentUser.id), { userName: currentUser.name, lastMessage: "×”×–×× ×” ×—×“×©×”", lastActivity: serverTimestamp(), isBotActive: true }, { merge: true }); cart = []; updateCartUI(); };
        function subscribeToChat(uid) { onSnapshot(query(collection(db, `chat_sessions/${uid}/messages`), orderBy("createdAt", "asc")), (snap) => { const box = document.getElementById('chatBox'); box.innerHTML = snap.docs.map(d => { const m = d.data(); return `<div class="msg ${m.role==='user'?'msg-out':'msg-in'}">${m.text}</div>`; }).join(''); box.scrollTop = box.scrollHeight; }); }
        window.sendChat = async () => { const txt = document.getElementById('chatInput').value; if(!txt) return; document.getElementById('chatInput').value = ''; await addDoc(collection(db, `chat_sessions/${currentUser.id}/messages`), { text: txt, role: 'user', createdAt: serverTimestamp() }); };
        window.switchScreen = (n) => { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(`screen-${n}`).classList.add('active'); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`nav-${n}`).classList.add('active'); }
        window.startContainerFlow = () => { switchScreen('chat'); document.getElementById('chatInput').value='××›×•×œ×”'; sendChat(); };
    </script>
</body>
</html>
