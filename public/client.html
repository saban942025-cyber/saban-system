<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban App Platinum ğŸ’</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- CORE STYLES --- */
        body { 
            background: #f0f2f5; 
            font-family: 'Heebo', sans-serif; 
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }

        /* --- X-RAY SCANNER ANIMATION --- */
        .scanner-container {
            position: relative; overflow: hidden; border-radius: 20px;
            background: #1e293b; color: #0ea5e9; padding: 20px; margin-bottom: 20px;
            min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px -10px rgba(14, 165, 233, 0.3);
        }
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: #0ea5e9; box-shadow: 0 0 15px #0ea5e9;
            animation: scanMove 2s linear infinite; z-index: 10;
            display: none;
        }
        .scan-text { font-family: monospace; opacity: 0.7; z-index: 5; text-align: center; white-space: pre-wrap; width: 100%; }
        .scan-active .scan-line { display: block; }
        .scan-active .scan-text { color: #86efac; text-shadow: 0 0 5px #22c55e; }

        @keyframes scanMove { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        /* --- PARSED ITEM CARD --- */
        .parsed-item {
            background: white; border-radius: 16px; padding: 12px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -2px rgba(0,0,0,0.05);
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .item-img { width: 48px; height: 48px; border-radius: 10px; background: #f1f5f9; object-fit: cover; }
        .item-qty-box {
            background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px;
            width: 50px; text-align: center; padding: 5px; font-weight: bold;
        }
        .edit-btn { color: #3b82f6; font-size: 12px; font-weight: bold; cursor: pointer; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- PRODUCT SEARCH MODAL --- */
        .search-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100;
            display: none; flex-direction: column; justify-content: flex-end;
        }
        .search-sheet {
            background: white; border-radius: 24px 24px 0 0; height: 80vh;
            display: flex; flex-direction: column; padding: 20px;
            animation: slideUp 0.3s ease-out;
        }
        .search-result-row {
            display: flex; align-items: center; gap: 10px; padding: 12px;
            border-bottom: 1px solid #f1f5f9; cursor: pointer;
        }
        .search-result-row:active { background: #eff6ff; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- UI COMPONENTS --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05); padding: 12px 16px; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
        }
        .tab-bar {
            background: white; border-top: 1px solid #e5e5ea; height: 70px;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom); z-index: 50;
        }
        .tab-item { color: #94a3b8; font-size: 10px; display: flex; flex-direction: column; align-items: center; }
        .tab-item.active { color: #007aff; }
        .view-container { flex: 1; position: relative; overflow: hidden; }
        .view { position: absolute; inset: 0; overflow-y: auto; display: none; padding: 16px; padding-bottom: 80px; }
        .view.active { display: block; }
        .catalog-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .catalog-card { background: white; border-radius: 16px; padding: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <header class="glass-header">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-slate-900 rounded-xl flex items-center justify-center text-white font-black text-sm shadow-md">S</div>
            <div>
                <div class="font-black text-slate-800 leading-none text-base">Saban App</div>
                <div class="text-[10px] text-slate-500 font-bold">X-RAY EDITION â˜¢ï¸</div>
            </div>
        </div>
        <div class="relative cursor-pointer" onclick="switchTab('cart')">
            <div class="w-9 h-9 bg-white rounded-full flex items-center justify-center shadow-sm border border-gray-100">
                <i class="fas fa-shopping-bag text-slate-700"></i>
            </div>
            <div id="cartBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center shadow-sm border border-white">0</div>
        </div>
    </header>

    <div class="view-container">
        
        <div id="view-catalog" class="view active">
            <div class="sticky top-0 z-30 bg-[#f0f2f5] pb-4 pt-1">
                <input id="searchMain" class="w-full bg-white h-12 rounded-2xl pl-10 pr-4 font-bold shadow-sm outline-none" placeholder="ğŸ” ×—×¤×© ××•×¦×¨..." oninput="filterCatalog()">
            </div>
            <div id="catalogGrid" class="catalog-grid"></div>
        </div>

        <div id="view-smart" class="view">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-black text-slate-800">×”×“×‘×§×” ×—×›××”</h2>
                <p class="text-sm text-slate-500">×”×“×‘×§ ×¨×©×™××” ×•×”××¢×¨×›×ª ×ª×”×¤×•×š ××•×ª×” ×œ×”×–×× ×”</p>
            </div>

            <div id="scannerBox" class="scanner-container">
                <div class="scan-line"></div>
                <div id="scanContent" class="scan-text text-sm">×”×“×‘×§ ×›××Ÿ ×˜×§×¡×˜...</div>
                <textarea id="smartInput" class="absolute inset-0 opacity-0 cursor-text" oninput="updateScanText()"></textarea>
            </div>

            <button onclick="startXRayScan()" id="btnScan" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-transform text-lg">
                <i class="fas fa-magic"></i> ×¡×¨×•×§ ×•×¤×¢× ×—
            </button>

            <div id="scanResults" class="mt-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700">×ª×•×¦××•×ª ×¡×¨×™×§×”</h3>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">×–×•×”×• <span id="scanCount">0</span> ×¤×¨×™×˜×™×</span>
                </div>
                <div id="parsedList"></div>
                <button onclick="finalizeOrder()" class="w-full mt-4 bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg">
                    <i class="fas fa-check"></i> ××©×¨ ×•×”×¤×§ ×”×–×× ×” (PDF)
                </button>
            </div>
        </div>

        <div id="view-cart" class="view">
            <h2 class="text-2xl font-black mb-4">×¡×™×›×•× ×”×–×× ×”</h2>
            <div id="cartItems" class="space-y-3"></div>
            <button onclick="sendToOffice()" class="w-full mt-6 bg-slate-900 text-white font-bold py-4 rounded-xl shadow-xl">
                ×©×œ×— ×œ×—×"×œ ğŸš€
            </button>
        </div>

    </div>

    <div id="swapModal" class="search-modal" onclick="closeSwap(event)">
        <div class="search-sheet" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">×”×—×œ×¤×ª ××•×¦×¨</h3>
                <button onclick="document.getElementById('swapModal').style.display='none'" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <input id="swapSearch" class="w-full bg-slate-100 p-3 rounded-xl mb-4 font-bold outline-none border border-transparent focus:border-blue-500 transition" placeholder="×”×§×œ×“ ×©× ××•×¦×¨ ×œ×”×—×œ×¤×”..." oninput="searchSwap()">
            <div id="swapResults" class="flex-1 overflow-y-auto custom-scroll"></div>
        </div>
    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('catalog')" id="tab-catalog"><i class="fas fa-th-large text-xl mb-1"></i> ×§×˜×œ×•×’</div>
        <div class="tab-item" onclick="switchTab('smart')" id="tab-smart"><i class="fas fa-magic text-xl mb-1"></i> ×¡×•×¨×§</div>
        <div class="tab-item" onclick="switchTab('cart')" id="tab-cart"><i class="fas fa-shopping-bag text-xl mb-1"></i> ×¢×’×œ×”</div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // STATE
        let catalog = [];
        let parsedItems = []; // ×”×¤×¨×™×˜×™× ×©×¤×•×¢× ×—×•
        let activeEditIndex = -1;
        let cart = [];

        // --- INIT ---
        (async () => {
            try {
                const snap = await getDocs(collection(db, "products"));
                catalog = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCatalog(catalog);
            } catch(e) { console.warn("Offline Catalog"); }
        })();

        // --- CATALOG LOGIC ---
        function renderCatalog(items) {
            const grid = document.getElementById('catalogGrid');
            grid.innerHTML = items.map(p => `
                <div class="catalog-card" onclick="addToCart('${p.id}')">
                    <img src="${p.rich?.image || 'https://via.placeholder.com/100'}" class="mx-auto h-24 object-contain mb-2">
                    <div class="font-bold text-sm text-slate-800 line-clamp-2 h-10">${p.core.name}</div>
                    <div class="text-blue-600 font-bold mt-1">â‚ª${p.core.price}</div>
                </div>
            `).join('');
        }

        window.filterCatalog = () => {
            const q = document.getElementById('searchMain').value.toLowerCase();
            renderCatalog(catalog.filter(p => p.core.name.toLowerCase().includes(q)));
        };

        // --- X-RAY SCANNER LOGIC ---
        window.updateScanText = () => {
            const txt = document.getElementById('smartInput').value;
            document.getElementById('scanContent').innerText = txt || "×”×“×‘×§ ×›××Ÿ ×˜×§×¡×˜...";
        };

        window.startXRayScan = async () => {
            const text = document.getElementById('smartInput').value;
            if(!text) return alert("×× × ×”×“×‘×§ ×˜×§×¡×˜");

            // 1. ××¤×§×˜ ×•×™×–×•××œ×™
            const box = document.getElementById('scannerBox');
            box.classList.add('scan-active');
            document.getElementById('btnScan').innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××¤×¢× ×—...';
            
            // 2. ×”×©×”×™×™×” ×“×¨××˜×™×ª
            await new Promise(r => setTimeout(r, 1500));

            // 3. ×œ×•×’×™×§×” ×©×œ ×¤×¢× ×•×— (Regex)
            parsedItems = [];
            const lines = text.split('\n');
            
            lines.forEach(line => {
                const clean = line.trim();
                if(clean.length < 2) return;
                
                // ×—×™×œ×•×¥ ×›××•×ª
                const qtyMatch = clean.match(/^(\d+)/) || clean.match(/(\d+)$/);
                let qty = qtyMatch ? parseInt(qtyMatch[0]) : 1;
                
                // × ×™×§×•×™ ×©×
                let name = clean.replace(/\d+/g, '').replace(/×©×§×™×|×™×—|×—×‘×™×œ×”/g, '').trim();
                
                // ×–×™×”×•×™ ××•×¦×¨ ×‘×§×˜×œ×•×’
                let match = catalog.find(p => p.core.name.includes(name));
                
                parsedItems.push({
                    tempId: Date.now() + Math.random(),
                    name: match ? match.core.name : name,
                    image: match?.rich?.image || 'https://via.placeholder.com/50?text=?',
                    qty: qty,
                    price: match?.core?.price || 0,
                    catalogId: match?.id || null
                });
            });

            // 4. ×¡×™×•×
            box.classList.remove('scan-active');
            document.getElementById('btnScan').innerHTML = '<i class="fas fa-magic"></i> ×¡×¨×•×§ ×©×•×‘';
            document.getElementById('scanResults').classList.remove('hidden');
            renderParsedList();
        };

        function renderParsedList() {
            const list = document.getElementById('parsedList');
            document.getElementById('scanCount').innerText = parsedItems.length;
            
            list.innerHTML = parsedItems.map((item, i) => `
                <div class="parsed-item">
                    <img src="${item.image}" class="item-img">
                    <div class="flex-1">
                        <div class="font-bold text-sm text-slate-800" onclick="openSwap(${i})">${item.name}</div>
                        <div class="edit-btn" onclick="openSwap(${i})">×”×—×œ×£ ××•×¦×¨ <i class="fas fa-exchange-alt"></i></div>
                    </div>
                    <input type="number" class="item-qty-box outline-none" value="${item.qty}" onchange="updateParsedQty(${i}, this.value)">
                    <i class="fas fa-times text-gray-300 px-2" onclick="removeParsed(${i})"></i>
                </div>
            `).join('');
        }

        window.updateParsedQty = (i, val) => parsedItems[i].qty = parseInt(val);
        window.removeParsed = (i) => { parsedItems.splice(i, 1); renderParsedList(); };

        // --- LIVE SWAP (×¢×¨×™×›×” ×—×›××”) ---
        window.openSwap = (index) => {
            activeEditIndex = index;
            document.getElementById('swapModal').style.display = 'flex';
            document.getElementById('swapSearch').value = '';
            document.getElementById('swapSearch').focus();
            searchSwap(); // Show all initially
        };

        window.searchSwap = () => {
            const q = document.getElementById('swapSearch').value.toLowerCase();
            const res = document.getElementById('swapResults');
            
            const matches = catalog.filter(p => p.core.name.toLowerCase().includes(q)).slice(0, 20);
            
            res.innerHTML = matches.map(p => `
                <div class="search-result-row" onclick="performSwap('${p.id}')">
                    <img src="${p.rich?.image}" class="w-10 h-10 rounded bg-slate-50 object-cover">
                    <div class="flex-1 font-bold text-sm">${p.core.name}</div>
                    <div class="text-green-600 font-bold text-xs">â‚ª${p.core.price}</div>
                </div>
            `).join('');
        };

        window.performSwap = (catId) => {
            const product = catalog.find(p => p.id === catId);
            if(product && activeEditIndex > -1) {
                parsedItems[activeEditIndex].name = product.core.name;
                parsedItems[activeEditIndex].image = product.rich?.image;
                parsedItems[activeEditIndex].price = product.core.price;
                parsedItems[activeEditIndex].catalogId = product.id;
                renderParsedList();
                document.getElementById('swapModal').style.display = 'none';
            }
        };

        window.closeSwap = (e) => {
            if(e.target.id === 'swapModal') document.getElementById('swapModal').style.display = 'none';
        };

        // --- ORDER FINALIZATION ---
        window.finalizeOrder = () => {
            // ×”×¢×‘×¨×ª ×”×¤×¨×™×˜×™× ×œ×¢×’×œ×”
            parsedItems.forEach(i => cart.push(i));
            updateCartUI();
            switchTab('cart');
            document.getElementById('scanResults').classList.add('hidden'); // Clear scan
            parsedItems = [];
        };

        function updateCartUI() {
            const el = document.getElementById('cartItems');
            document.getElementById('cartBadge').innerText = cart.length;
            document.getElementById('cartBadge').classList.toggle('hidden', cart.length === 0);
            
            if(cart.length === 0) el.innerHTML = '<div class="text-center text-gray-400 mt-10">×”×¢×’×œ×” ×¨×™×§×”</div>';
            else el.innerHTML = cart.map(i => `
                <div class="bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm">
                    <span class="font-bold text-sm">${i.name}</span>
                    <span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold">x${i.qty}</span>
                </div>
            `).join('');
        }

        window.sendToOffice = async () => {
            if(cart.length === 0) return alert("××™×Ÿ ×¤×¨×™×˜×™×");
            
            try {
                // 1. ×™×¦×™×¨×ª PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // ×”×•×¡×¤×ª ×’×•×¤×Ÿ ×¢×‘×¨×™×ª (×“×¨×•×© Base64 ××œ×, ×›××Ÿ × ×©×ª××© ×‘×× ×’×œ×™×ª ×œ×“××•)
                doc.setFontSize(22);
                doc.text("Saban Order #" + Math.floor(Math.random()*1000), 20, 20);
                
                let y = 40;
                cart.forEach((item, i) => {
                    doc.setFontSize(14);
                    doc.text(`${i+1}. ${item.name} - Qty: ${item.qty}`, 20, y);
                    y += 10;
                });
                
                doc.save("Saban_Order.pdf"); // ×”×•×¨×“×” ×œ×œ×§×•×—

                // 2. ×©×œ×™×—×” ×œ-Firebase (×—×"×œ)
                await addDoc(collection(db, "orders"), {
                    clientName: "×œ×§×•×— ××¤×œ×™×§×¦×™×”",
                    items: cart,
                    status: "new",
                    createdAt: serverTimestamp(),
                    source: "app_scanner"
                });

                alert("×”×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×œ×—×\"×œ! ğŸš€");
                cart = []; updateCartUI(); switchTab('catalog');

            } catch(e) { console.error(e); alert("×©×’×™××” ×‘×©×œ×™×—×”"); }
        };

        window.switchTab = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
        };

        window.addToCart = (id) => {
            const p = catalog.find(x => x.id === id);
            cart.push({ name: p.core.name, qty: 1, price: p.core.price });
            updateCartUI();
        };

    </script>
</body>
</html>
