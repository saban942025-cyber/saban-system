<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban App Platinum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background: #f0f2f5; font-family: -apple-system, system-ui, sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .view { display: none; height: 100%; overflow-y: auto; padding-bottom: 80px; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        
        /* Catalog Card */
        .prod-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; position: relative; }
        .badge-wh { position: absolute; top: 8px; right: 8px; font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 12px; background: rgba(255,255,255,0.9); border: 1px solid #ddd; }
        
        /* Floating Compare */
        .compare-float { position: fixed; bottom: 80px; left: 20px; right: 20px; background: #1e293b; color: white; padding: 15px; border-radius: 16px; display: none; align-items: center; justify-content: space-between; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 50; animation: slideUp 0.3s; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); } to { transform: translateY(0); } }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 85%; max-width: 400px; border-radius: 20px; padding: 20px; position: relative; }
    </style>
</head>
<body>

    <div class="bg-white/95 backdrop-blur border-b p-3 flex justify-between items-center sticky top-0 z-40">
        <div class="font-black text-slate-800 text-lg">Saban</div>
        <div class="flex gap-3">
            <button onclick="switchTab('cart')" class="relative">
                <i class="fas fa-shopping-bag text-xl"></i>
                <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-hidden relative">
        <div id="view-catalog" class="view active p-4">
            <div class="relative mb-4">
                <input id="search" class="w-full bg-white h-12 rounded-xl px-4 border shadow-sm outline-none" placeholder="חפש מוצר..." oninput="render()">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
            </div>
            <div id="grid" class="grid grid-cols-2 gap-3"></div>
        </div>

        <div id="view-chat" class="view bg-[#efeae2]">
            <div id="chatBox" class="p-4 space-y-3"></div>
            <div class="fixed bottom-[70px] left-0 right-0 p-3 bg-[#f0f2f5] flex gap-2 border-t">
                <input id="chatIn" class="flex-1 rounded-full px-4 border-none outline-none h-10" placeholder="שאל אותי...">
                <button onclick="send()" class="w-10 h-10 bg-[#008069] text-white rounded-full"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="view-cart" class="view p-4">
            <h2 class="text-2xl font-bold mb-4">העגלה שלי</h2>
            <div id="cartList" class="space-y-2"></div>
            <button onclick="submitOrder()" class="w-full bg-black text-white py-4 rounded-xl font-bold mt-6 shadow-xl">שלח הזמנה</button>
        </div>
    </div>

    <div id="compareBar" class="compare-float">
        <div class="text-sm">
            <span class="font-bold text-yellow-400" id="cmpCount">0</span> מוצרים להשוואה
        </div>
        <button onclick="runCompare()" class="bg-blue-600 px-4 py-2 rounded-lg font-bold text-xs flex items-center gap-2">
            <i class="fas fa-robot"></i> שאל את הבוט
        </button>
    </div>

    <div id="detailsModal" class="modal-overlay">
        <div class="modal-box">
            <button onclick="closeModal()" class="absolute top-3 left-3 text-gray-400"><i class="fas fa-times"></i></button>
            <div id="modalContent"></div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t h-[65px] flex justify-around items-center z-50 pb-2">
        <button onclick="switchTab('catalog')" class="flex flex-col items-center text-blue-600"><i class="fas fa-th-large text-xl"></i><span class="text-[10px]">קטלוג</span></button>
        <button onclick="switchTab('chat')" class="flex flex-col items-center text-gray-400"><i class="fas fa-comments text-xl"></i><span class="text-[10px]">ייעוץ</span></button>
        <button onclick="switchTab('cart')" class="flex flex-col items-center text-gray-400"><i class="fas fa-clipboard-list text-xl"></i><span class="text-[10px]">הזמנה</span></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanChatbot } from './js/chatbot-engine.js'; // וודא שהקובץ קיים

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let products = [];
        let compareList = [];
        let cart = [];
        const bot = new SabanChatbot(db, {name: "לקוח"});

        // Init
        async function init() {
            const snap = await getDocs(collection(db, "products"));
            products = snap.docs.map(d => ({id: d.id, ...d.data()}));
            render();
        }

        window.render = () => {
            const term = document.getElementById('search').value.toLowerCase();
            const grid = document.getElementById('grid');
            grid.innerHTML = products.filter(p => p.core.name.toLowerCase().includes(term)).map(p => `
                <div class="prod-card">
                    <div class="badge-wh text-gray-500">${p.core.warehouse === 'both' ? 'תלמיד+חרש' : (p.core.warehouse==='harash'?'חרש':'תלמיד')}</div>
                    <img src="${p.rich?.image}" class="h-32 object-contain p-2" onclick="showDetails('${p.id}')">
                    <div class="p-3">
                        <div class="font-bold text-sm h-10 line-clamp-2">${p.core.name}</div>
                        <div class="flex justify-between items-center mt-2">
                            <div class="font-bold text-blue-600">₪${p.core.price}</div>
                            <div class="flex gap-2">
                                <button onclick="toggleCompare('${p.id}')" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center border ${compareList.includes(p.id)?'border-blue-500 text-blue-500':''}"><i class="fas fa-balance-scale"></i></button>
                                <button onclick="addToCart('${p.id}')" class="w-8 h-8 rounded-full bg-black text-white flex items-center justify-center"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        // Rich Details Logic
        window.showDetails = (id) => {
            const p = products.find(x => x.id === id);
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="text-center mb-4">
                    <img src="${p.rich?.image}" class="h-32 mx-auto object-contain">
                    <h2 class="text-lg font-bold mt-2">${p.core.name}</h2>
                    <div class="text-blue-600 font-bold">₪${p.core.price}</div>
                </div>
                <div class="space-y-2 bg-gray-50 p-3 rounded-lg text-sm mb-4">
                    <div class="flex justify-between"><span>זמן ייבוש:</span> <b>${p.rich?.specs?.drying_time || 'לא צוין'}</b></div>
                    <div class="flex justify-between"><span>כיסוי:</span> <b>${p.rich?.specs?.coverage || 'לא צוין'}</b></div>
                    <div class="flex justify-between"><span>מחסן:</span> <b>${p.core.warehouse}</b></div>
                </div>
                <button onclick="askBotSpecific('${p.core.name}')" class="w-full bg-blue-100 text-blue-700 font-bold py-3 rounded-xl flex items-center justify-center gap-2">
                    <img src="https://i.postimg.cc/W3nYsP7X/h-sbn.png" class="w-5 h-5 rounded-full">
                    שאל את צ'אט-סבן על המוצר
                </button>
            `;
            modal.style.display = 'flex';
        };
        
        window.closeModal = () => document.getElementById('detailsModal').style.display = 'none';

        // Compare Logic
        window.toggleCompare = (id) => {
            if(compareList.includes(id)) compareList = compareList.filter(x => x !== id);
            else {
                if(compareList.length >= 2) compareList.shift(); // Max 2 items
                compareList.push(id);
            }
            
            const bar = document.getElementById('compareBar');
            if(compareList.length > 0) {
                bar.style.display = 'flex';
                document.getElementById('cmpCount').innerText = compareList.length;
            } else {
                bar.style.display = 'none';
            }
            render(); // Refresh icons
        };

        window.runCompare = () => {
            const p1 = products.find(x => x.id === compareList[0]);
            const p2 = products.find(x => x.id === compareList[1]);
            
            // הודעה מרחפת
            switchTab('chat');
            
            let prompt = "";
            if(p2) {
                prompt = `היי, אני מתלבט בין ${p1.core.name} לבין ${p2.core.name}. מה ההבדלים ומה עדיף?`;
            } else {
                prompt = `היי, ספר לי האם כדאי לקנות את ${p1.core.name}?`;
            }
            
            setTimeout(() => send(prompt), 500);
            compareList = [];
            document.getElementById('compareBar').style.display = 'none';
            render();
        };

        window.askBotSpecific = (name) => {
            closeModal();
            switchTab('chat');
            setTimeout(() => send(`היי, אני מתעניין ב-${name}. האם זה מתאים לי?`), 500);
        };

        // Chat & Cart (Standard)
        window.switchTab = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
        };

        window.send = async (txt) => {
            const inp = document.getElementById('chatIn');
            const val = txt || inp.value;
            if(!val) return;
            inp.value = '';
            
            const box = document.getElementById('chatBox');
            box.innerHTML += `<div class="bg-blue-600 text-white p-2 rounded-lg self-end w-fit mb-2 ml-auto">${val}</div>`;
            
            const res = await bot.ask(val);
            box.innerHTML += `<div class="bg-white p-2 rounded-lg self-start w-fit mb-2 border flex gap-2">
                <img src="https://i.postimg.cc/W3nYsP7X/h-sbn.png" class="w-6 h-6 rounded-full">
                <div>${res.text}</div>
            </div>`;
        };
        
        // Cart Logic... (addToCart, submitOrder - Same as before)
        window.addToCart = (id) => {
            const p = products.find(x => x.id === id);
            cart.push(p);
            // Simple toast
            alert("נוסף לעגלה: " + p.core.name);
        };

        init();
    </script>
</body>
</html>
