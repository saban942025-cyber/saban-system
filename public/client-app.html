<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban App Platinum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background: #f0f2f5; font-family: 'Heebo', sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .view { display: none; height: 100%; overflow-y: auto; padding-bottom: 80px; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        
        /* Catalog */
        .prod-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; position: relative; transition: transform 0.1s; }
        .prod-card:active { transform: scale(0.98); }
        .badge-sale { position: absolute; top: 0; left: 0; background: #ef4444; color: white; font-size: 10px; font-weight: bold; padding: 2px 8px; border-bottom-right-radius: 8px; }
        
        /* Floating Compare */
        .compare-bar { position: fixed; bottom: 80px; left: 20px; right: 20px; background: #1e293b; color: white; padding: 15px; border-radius: 16px; display: none; align-items: center; justify-content: space-between; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 50; animation: slideUp 0.3s; }
        
        /* Promo Popup */
        .promo-popup { position: fixed; top: 20px; left: 20px; right: 20px; background: white; border-radius: 16px; padding: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 100; animation: slideDown 0.5s; display: none; border-right: 5px solid #ef4444; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(-100px); } to { transform: translateY(0); } }

        /* Modal Details */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; position: relative; animation: slideUp 0.3s; }
    </style>
</head>
<body>

    <div id="promoBanner" class="promo-popup">
        <div class="flex items-center gap-3">
            <div class="bg-red-100 p-2 rounded-full text-red-600"><i class="fas fa-gift"></i></div>
            <div>
                <div class="font-bold text-sm text-gray-800">××‘×¦×¢ ×—×!</div>
                <div class="text-xs text-gray-500" id="promoText"></div>
            </div>
            <button onclick="this.parentElement.parentElement.style.display='none'" class="mr-auto text-gray-400"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div class="bg-white/95 backdrop-blur border-b p-3 flex justify-between items-center sticky top-0 z-40 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center text-white font-black text-sm">S</div>
            <div class="font-bold text-slate-800">Saban</div>
        </div>
        <button onclick="switchTab('cart')" class="relative">
            <i class="fas fa-shopping-bag text-xl text-slate-700"></i>
            <span id="cartCount" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center font-bold">0</span>
        </button>
    </div>

    <div class="flex-1 overflow-hidden relative bg-[#f0f2f5]">
        
        <div id="view-catalog" class="view active p-3">
            <div class="sticky top-0 z-30 pb-3 pt-1 bg-[#f0f2f5]">
                <div class="relative shadow-sm">
                    <input id="search" class="w-full bg-white h-12 rounded-xl px-4 pl-10 border-none outline-none font-bold text-gray-700" placeholder="ğŸ” ×—×¤×© ××•×¦×¨ (××• ×–××Ÿ ×™×™×‘×•×©...)" oninput="render()">
                </div>
            </div>

            <div id="saleSection" class="hidden mb-4">
                <h3 class="font-bold text-red-600 text-sm mb-2 px-1 flex items-center gap-1"><i class="fas fa-fire"></i> ×—× ×‘××œ××™</h3>
                <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar" id="saleRow"></div>
            </div>

            <div id="grid" class="grid grid-cols-2 gap-3 pb-20"></div>
        </div>

        <div id="view-smart" class="view p-5 bg-white">
            <div class="text-center mb-6 mt-4">
                <div class="w-14 h-14 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl text-purple-600 shadow-sm">âœ¨</div>
                <h2 class="text-xl font-black text-slate-800">×¤×¢× ×•×— ×—×›×</h2>
                <p class="text-xs text-slate-500 mt-1">×”×“×‘×§ ×¨×©×™××” ××”×•×•×¦××¤, ×× ×—× ×• × ×¡×“×¨ ××•×ª×”</p>
            </div>
            <textarea id="smartInput" class="w-full h-40 rounded-xl p-4 border bg-gray-50 focus:bg-white focus:ring-2 ring-purple-500 outline-none resize-none shadow-inner text-sm" placeholder="×œ×“×•×’××”: 10 ××œ×˜, 5 ×“×‘×§ ×¡×™×§×” ×•×’× 3 ×‘×œ×•×ª ×¡×•××¡×•×..."></textarea>
            <button onclick="runSmartParser()" class="w-full mt-4 bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition">
                <i class="fas fa-magic text-yellow-400"></i> <span>×¤×¢× ×— ×•×”×•×¡×£ ×œ×¢×’×œ×”</span>
            </button>
        </div>

        <div id="view-chat" class="view bg-[#efeae2]">
            <div id="chatBox" class="p-4 space-y-3 pb-20">
                <div class="bg-white p-3 rounded-lg rounded-tr-none shadow-sm max-w-[85%] text-sm">
                    ×”×™×™ ×©×—×¨! ğŸ‘‹<br>×× ×™ ×›××Ÿ ×œ×™×™×¢×•×¥ ××§×¦×•×¢×™, ×”×©×•×•××ª ××•×¦×¨×™× ×•×‘×“×™×§×ª ××œ××™.
                </div>
            </div>
            <div class="fixed bottom-[70px] left-0 right-0 p-2 bg-[#f0f2f5] flex gap-2 border-t">
                <input id="chatIn" class="flex-1 rounded-full px-4 border-none outline-none h-10 shadow-sm" placeholder="×©××œ ××•×ª×™..." onkeydown="if(event.key==='Enter') send()">
                <button onclick="send()" class="w-10 h-10 bg-[#008069] text-white rounded-full flex items-center justify-center shadow"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="view-cart" class="view p-4">
            <h2 class="text-2xl font-black mb-4">×”×¢×’×œ×”</h2>
            <div id="cartList" class="space-y-3 mb-20"></div>
            <div class="fixed bottom-[80px] left-4 right-4">
                <button onclick="submitOrder()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-xl flex justify-center items-center gap-2">
                    <span>×©×œ×— ×”×–×× ×” ×œ×•×•×¦××¤</span> <i class="fab fa-whatsapp"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="compareBar" class="compare-bar">
        <div class="text-sm"><span class="font-bold text-yellow-400" id="cmpCount">0</span> ×œ×”×©×•×•××”</div>
        <button onclick="runCompare()" class="bg-blue-600 px-3 py-1.5 rounded-lg font-bold text-xs flex items-center gap-2"><i class="fas fa-robot"></i> ×©××œ ××ª ×”×‘×•×˜</button>
    </div>

    <div id="detailsModal" class="modal-overlay">
        <div class="modal-box">
            <button onclick="document.getElementById('detailsModal').style.display='none'" class="absolute top-3 left-3 text-gray-400"><i class="fas fa-times"></i></button>
            <div id="modalContent"></div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t h-[65px] flex justify-around items-center z-50 pb-2 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('catalog')" class="flex flex-col items-center text-blue-600 nav-btn" id="nav-catalog"><i class="fas fa-th-large text-xl"></i><span class="text-[10px] font-bold">×§×˜×œ×•×’</span></button>
        <button onclick="switchTab('smart')" class="flex flex-col items-center text-gray-400 nav-btn" id="nav-smart"><i class="fas fa-magic text-xl"></i><span class="text-[10px] font-bold">×—×›×</span></button>
        <button onclick="switchTab('chat')" class="flex flex-col items-center text-gray-400 nav-btn" id="nav-chat"><i class="fas fa-comments text-xl"></i><span class="text-[10px] font-bold">×™×™×¢×•×¥</span></button>
        <button onclick="switchTab('cart')" class="flex flex-col items-center text-gray-400 nav-btn" id="nav-cart"><i class="fas fa-clipboard-list text-xl"></i><span class="text-[10px] font-bold">×”×–×× ×”</span></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanChatbot } from './js/chatbot-engine.js';

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let products = [];
        let compareList = [];
        let cart = [];
        const bot = new SabanChatbot(db, {name: "×œ×§×•×—"});

        // --- Init ---
        async function init() {
            try {
                const snap = await getDocs(collection(db, "products"));
                products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
                
                // Promo Logic (Simulated)
                setTimeout(() => {
                    const promoText = "××‘×¦×¢ ×¡×•×£ ×©× ×”! ×§× ×” 10 ×©×§×™× ×§×‘×œ 1 ××ª× ×”"; 
                    if(promoText) {
                        document.getElementById('promoText').innerText = promoText;
                        document.getElementById('promoBanner').style.display = 'flex';
                    }
                }, 2000);

            } catch(e) { console.error(e); }
        }

        // --- Render Catalog ---
        window.render = () => {
            const term = document.getElementById('search').value.toLowerCase();
            
            // Filter
            const filtered = products.filter(p => {
                const searchStr = `${p.core.name} ${p.rich?.specs?.drying_time||''} ${p.core.brand||''}`.toLowerCase();
                return searchStr.includes(term);
            });

            // Top Sales
            const sales = filtered.filter(p => p.core.isSale).slice(0, 3);
            const saleSec = document.getElementById('saleSection');
            const saleRow = document.getElementById('saleRow');
            
            if(sales.length > 0 && !term) {
                saleSec.classList.remove('hidden');
                saleRow.innerHTML = sales.map(p => `
                    <div class="min-w-[120px] bg-white rounded-xl p-2 shadow border border-red-100 flex flex-col items-center relative" onclick="showDetails('${p.id}')">
                        <div class="absolute top-0 right-0 bg-red-600 text-white text-[9px] px-2 rounded-bl-lg font-bold">SALE</div>
                        <img src="${p.rich?.image}" class="h-16 object-contain mb-2">
                        <div class="text-xs font-bold text-center leading-tight h-8 overflow-hidden">${p.core.name}</div>
                        <div class="text-red-600 font-bold text-xs mt-1">â‚ª${p.core.price}</div>
                    </div>
                `).join('');
            } else {
                saleSec.classList.add('hidden');
            }

            // Grid
            document.getElementById('grid').innerHTML = filtered.map(p => `
                <div class="prod-card">
                    <img src="${p.rich?.image}" class="h-32 object-contain p-4" onclick="showDetails('${p.id}')">
                    <div class="p-3 bg-white flex flex-col flex-1">
                        <div class="text-[10px] text-gray-400 font-bold uppercase">${p.core.brand || '×›×œ×œ×™'}</div>
                        <div class="font-bold text-sm h-9 line-clamp-2 leading-tight">${p.core.name}</div>
                        <div class="mt-auto pt-2 flex justify-between items-center">
                            <div class="font-black text-slate-800">â‚ª${p.core.price}</div>
                            <div class="flex gap-1">
                                <button onclick="toggleCompare('${p.id}')" class="w-7 h-7 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center border ${compareList.includes(p.id)?'border-blue-500 text-blue-500':''}"><i class="fas fa-balance-scale text-xs"></i></button>
                                <button onclick="addToCart('${p.id}')" class="w-7 h-7 rounded-lg bg-slate-900 text-white flex items-center justify-center shadow"><i class="fas fa-plus text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        // --- Details Modal ---
        window.showDetails = (id) => {
            const p = products.find(x => x.id === id);
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('modalContent');
            
            const specs = p.rich?.specs || {};
            const videoBtn = p.rich?.video_url ? `<button onclick="window.open('${p.rich.video_url}')" class="w-full mt-2 border border-red-500 text-red-500 py-2 rounded-xl font-bold flex items-center justify-center gap-2"><i class="fab fa-youtube"></i> ×¡×¨×˜×•×Ÿ ××•×¦×¨</button>` : '';

            content.innerHTML = `
                <div class="text-center">
                    <img src="${p.rich?.image}" class="h-40 mx-auto object-contain mb-2">
                    <h2 class="text-lg font-bold text-slate-800 leading-tight">${p.core.name}</h2>
                    <div class="text-xl font-black text-slate-900 mt-1">â‚ª${p.core.price}</div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mt-4 text-xs">
                    <div class="bg-gray-50 p-2 rounded border text-center">
                        <div class="text-gray-400">×™×™×‘×•×©</div>
                        <div class="font-bold">${specs.drying_time || '-'}</div>
                    </div>
                    <div class="bg-gray-50 p-2 rounded border text-center">
                        <div class="text-gray-400">×›×™×¡×•×™</div>
                        <div class="font-bold">${specs.coverage || '-'}</div>
                    </div>
                    <div class="bg-gray-50 p-2 rounded border text-center">
                        <div class="text-gray-400">××—×¡×Ÿ</div>
                        <div class="font-bold">${p.core.warehouse}</div>
                    </div>
                    <div class="bg-gray-50 p-2 rounded border text-center">
                        <div class="text-gray-400">××©×§×œ</div>
                        <div class="font-bold">${specs.weight || '-'}</div>
                    </div>
                </div>

                ${videoBtn}

                <div class="flex gap-2 mt-4">
                    <button onclick="askBot('${p.core.name}')" class="flex-1 bg-blue-50 text-blue-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                        <i class="fas fa-comment-dots"></i> ×”×ª×™×™×¢×¥
                    </button>
                    <button onclick="addToCart('${p.id}'); closeModal()" class="flex-1 bg-black text-white py-3 rounded-xl font-bold shadow-lg">
                        ×”×•×¡×£ ×œ×¢×’×œ×”
                    </button>
                </div>
            `;
            modal.style.display = 'flex';
        };

        window.closeModal = () => document.getElementById('detailsModal').style.display = 'none';

        // --- Comparison ---
        window.toggleCompare = (id) => {
            if(compareList.includes(id)) compareList = compareList.filter(x => x !== id);
            else {
                if(compareList.length >= 2) compareList.shift();
                compareList.push(id);
            }
            const bar = document.getElementById('compareBar');
            bar.style.display = compareList.length > 0 ? 'flex' : 'none';
            document.getElementById('cmpCount').innerText = compareList.length;
            render();
        };

        window.runCompare = () => {
            const names = compareList.map(id => products.find(x => x.id === id).core.name).join(" ××•×œ ");
            switchTab('chat');
            setTimeout(() => send(`×”×™×™, ××” ×”×”×‘×“×œ ×‘×™×Ÿ ${names} ×•××” ×¢×“×™×£?`), 500);
            compareList = [];
            document.getElementById('compareBar').style.display = 'none';
            render();
        };

        window.askBot = (name) => {
            closeModal();
            switchTab('chat');
            setTimeout(() => send(`×”×™×™, ×¡×¤×¨ ×œ×™ ×¢×œ ${name}, ×”×× ×–×” ××ª××™× ×œ×™?`), 500);
        };

        // --- Smart Parser ---
        window.runSmartParser = async () => {
            const text = document.getElementById('smartInput').value;
            if(!text) return;
            
            const btn = document.querySelector('#view-smart button');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××¢×‘×“...';
            
            // Local parsing simulation for speed
            const lines = text.split('\n');
            let added = 0;
            lines.forEach(l => {
                const clean = l.replace(/[0-9]/g, '').trim();
                if(clean.length < 2) return;
                const match = products.find(p => p.core.name.includes(clean));
                if(match) {
                    cart.push(match);
                    added++;
                } else {
                    // Add external item
                    cart.push({id: 'ext'+Math.random(), core: {name: l, price: 0}, rich: {image: null}});
                    added++;
                }
            });

            updateCart();
            switchTab('cart');
            alert(`× ×•×¡×¤×• ${added} ×¤×¨×™×˜×™× ×œ×¢×’×œ×”!`);
            document.getElementById('smartInput').value = '';
            btn.innerHTML = '<i class="fas fa-magic text-yellow-400"></i> <span>×¤×¢× ×— ×•×”×•×¡×£ ×œ×¢×’×œ×”</span>';
        };

        // --- Cart & Chat ---
        window.addToCart = (id) => {
            const p = products.find(x => x.id === id);
            cart.push(p);
            updateCart();
            
            const badge = document.getElementById('cartBadge');
            badge.classList.remove('hidden');
            badge.innerText = cart.length;
            badge.classList.add('animate-ping');
            setTimeout(() => badge.classList.remove('animate-ping'), 500);
        };

        function updateCart() {
            const list = document.getElementById('cartList');
            if(!cart.length) list.innerHTML = '<div class="text-center text-gray-400 mt-10">×”×¢×’×œ×” ×¨×™×§×”</div>';
            else {
                list.innerHTML = cart.map((p, i) => `
                    <div class="flex items-center gap-3 bg-white p-3 rounded-xl border shadow-sm">
                        <img src="${p.rich?.image}" class="w-12 h-12 object-contain bg-gray-50 rounded">
                        <div class="flex-1">
                            <div class="font-bold text-sm line-clamp-1">${p.core.name}</div>
                            <div class="text-xs text-blue-600 font-bold">â‚ª${p.core.price}</div>
                        </div>
                        <button onclick="cart.splice(${i},1); updateCart()" class="text-red-400 px-2"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            }
            document.getElementById('cartBadge').innerText = cart.length;
        }

        window.send = async (txt) => {
            const inp = document.getElementById('chatIn');
            const val = txt || inp.value;
            if(!val) return;
            inp.value = '';
            
            const box = document.getElementById('chatBox');
            box.innerHTML += `<div class="bg-blue-600 text-white p-2.5 rounded-2xl rounded-br-none self-end w-fit mb-2 text-sm shadow">${val}</div>`;
            
            const res = await bot.ask(val);
            box.innerHTML += `<div class="bg-white p-3 rounded-2xl rounded-bl-none self-start w-fit mb-2 border text-sm shadow-sm flex gap-2">
                <img src="https://i.postimg.cc/W3nYsP7X/h-sbn.png" class="w-6 h-6 rounded-full">
                <div>${res.text}</div>
            </div>`;
            box.scrollTop = box.scrollHeight;
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+tab).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-blue-600'));
            document.getElementById('nav-'+tab).classList.add('text-blue-600');
        };

        init();
    </script>
</body>
</html>
