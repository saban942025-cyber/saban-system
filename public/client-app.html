<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban App Platinum ğŸ’</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- ×”×’×“×¨×•×ª ×‘×¡×™×¡ ×•×¢×™×¦×•×‘ ×œ××™×™×¤×•×Ÿ --- */
        body { 
            background: #f0f2f5; 
            font-family: 'Heebo', sans-serif; 
            height: 100dvh; /* ×’×•×‘×” ×“×™× ××™ ×œ××•×‘×™×™×œ */
            display: flex; flex-direction: column; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Header ×–×›×•×›×™×ª --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            padding: 12px 16px; z-index: 50; flex-shrink: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        }

        /* --- ××¢×‘×¨ ×‘×™×Ÿ ××¡×›×™× --- */
        .view-container { flex: 1; position: relative; overflow: hidden; }
        .view { 
            position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden;
            background: #f0f2f5; display: none; opacity: 0; transition: opacity 0.2s ease-in-out;
            padding-bottom: 80px; /* ××§×•× ×œ×˜××‘×™× ×œ××˜×” */
        }
        .view.active { display: block; opacity: 1; }

        /* --- ×›×¨×˜×™×¡ ××•×¦×¨ ×‘×§×˜×œ×•×’ --- */
        .catalog-card {
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.04);
            transition: transform 0.2s; display: flex; flex-direction: column;
        }
        .catalog-card:active { transform: scale(0.97); }
        .stock-tag {
            position: absolute; top: 8px; right: 8px; font-size: 10px; font-weight: 800;
            padding: 4px 10px; border-radius: 20px; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- ×¢×™×¦×•×‘ ×¦'××˜ (WhatsApp Style) --- */
        #view-chat {
            background-color: #efeae2;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
            display: none; flex-direction: column;
        }
        #view-chat.active { display: flex; }
        
        .chat-scroll-area { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; gap: 8px; 
        }

        .msg-row { display: flex; gap: 8px; align-items: flex-end; animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .msg-row.user { flex-direction: row-reverse; }
        
        .avatar { 
            width: 32px; height: 32px; border-radius: 50%; background: white; 
            border: 1px solid rgba(0,0,0,0.1); object-fit: cover; flex-shrink: 0;
        }

        .bubble {
            max-width: 85%; padding: 10px 14px; border-radius: 18px; position: relative;
            font-size: 15px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .bubble.bot { background: white; color: #111; border-bottom-right-radius: 4px; }
        .bubble.user { background: #d9fdd3; color: #111; border-bottom-left-radius: 4px; }

        .chat-timestamp {
            font-size: 10px; color: #9ca3af; text-align: left; margin-top: 4px;
            display: flex; align-items: center; justify-content: flex-end; gap: 4px;
        }

        /* --- ×›×¨×˜×™×¡ ××•×¦×¨ ×‘×ª×•×š ×”×¦'××˜ (Embedded) --- */
        .chat-product-card {
            background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px;
            margin-top: 8px; padding: 8px; display: flex; gap: 10px; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .chat-product-card:active { background: #f3f4f6; }
        .cpc-img { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: white; }
        .cpc-content { flex: 1; min-w: 0; }
        .cpc-title { font-size: 13px; font-weight: bold; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cpc-price { font-size: 12px; color: #2563eb; font-weight: 800; }
        .cpc-add-btn {
            background: #25d366; color: white; font-size: 10px; font-weight: bold;
            padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 5px rgba(37, 211, 102, 0.2);
        }

        /* --- ×¡×¨×’×œ ×›×œ×™× ×ª×—×ª×•×Ÿ (Tab Bar) --- */
        .tab-bar {
            background: white; border-top: 1px solid #e5e5ea; height: 70px;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom); z-index: 50;
        }
        .tab-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #94a3b8; font-size: 10px; font-weight: 500; width: 100%; height: 100%;
        }
        .tab-item.active { color: #007aff; }
        .tab-icon { font-size: 22px; margin-bottom: 4px; transition: transform 0.2s; }
        .tab-item:active .tab-icon { transform: scale(0.9); }

        /* --- ×× ×™××¦×™×•×ª --- */
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
        .animate-ping-custom { animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; }
    </style>
</head>
<body>

    <audio id="soundPop" src="https://cdn.freesound.org/previews/553/553331_11760467-lq.mp3"></audio>

    <header class="glass-header flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-slate-900 rounded-xl flex items-center justify-center text-white font-black text-sm shadow-md">S</div>
            <div>
                <div class="font-black text-slate-800 leading-none text-base">Saban</div>
                <div class="text-[10px] text-slate-500 font-bold tracking-wide">PREMIUM APP</div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="relative cursor-pointer" onclick="switchTab('cart')">
                <div class="w-9 h-9 bg-white rounded-full flex items-center justify-center shadow-sm border border-gray-100">
                    <i class="fas fa-shopping-bag text-slate-700"></i>
                </div>
                <div id="cartBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center shadow-sm border border-white">0</div>
            </div>
            <img src="https://ui-avatars.com/api/?name=Shahar+Shaul&background=007aff&color=fff" class="w-9 h-9 rounded-full border-2 border-white shadow-sm">
        </div>
    </header>

    <div class="view-container">

        <div id="view-catalog" class="view active p-4">
            <div class="sticky top-0 z-30 bg-[#f0f2f5] pb-2 pt-1">
                <div class="relative shadow-sm">
                    <input id="searchCatalog" class="w-full bg-white h-12 rounded-2xl pl-12 pr-4 outline-none font-bold text-slate-700 placeholder-slate-400 border border-transparent focus:border-blue-500 transition-all" placeholder="ğŸ” ×—×¤×© ××•×¦×¨ (××œ×˜, ×“×‘×§, ×’×‘×¡...)" oninput="renderCatalog()">
                    <div class="absolute left-4 top-3.5 text-slate-400"><i class="fas fa-search"></i></div>
                </div>
            </div>

            <div id="catalogGrid" class="grid grid-cols-2 gap-3 mt-2">
                <div class="col-span-2 text-center py-20 text-slate-400 flex flex-col items-center">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i>
                    <span>×˜×•×¢×Ÿ ××ª ×”××“×¤×™×...</span>
                </div>
            </div>
        </div>

        <div id="view-smart" class="view p-5">
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-tr from-purple-500 to-indigo-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg text-white text-2xl">
                    <i class="fas fa-magic"></i>
                </div>
                <h2 class="text-xl font-black text-slate-800 mb-2">×”×“×‘×§×” ×—×›××”</h2>
                <p class="text-sm text-slate-500 leading-relaxed">
                    ×§×™×‘×œ×ª ×¨×©×™××” ××‘×•×œ×’× ×ª ×‘×•×•×¦××¤?<br>
                    ×ª×“×‘×™×§ ××•×ª×” ×›××Ÿ, ×•×’'××™× ×™ ×™×¡×“×¨ ×œ×š ××ª ×”×¢×’×œ×” ×‘×©× ×™×•×ª.
                </p>
            </div>
            
            <textarea id="smartInput" class="w-full h-40 rounded-2xl p-4 border border-slate-200 bg-white focus:ring-2 ring-purple-500 outline-none resize-none shadow-inner text-base" placeholder="×“×•×’××”: ×ª×‘×™× 10 ×©×§ ××œ×˜, 5 ×“×‘×§ ×§×¨××™×§×” ×•××™×–×” 20 ×‘×œ×•×§×™×..."></textarea>
            
            <button onclick="processSmartOrder()" id="btnSmart" class="w-full mt-4 bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-transform">
                <span>×¤×¢× ×— ×¨×©×™××”</span>
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>

        <div id="view-chat" class="view">
            <div id="chatBox" class="chat-scroll-area">
                <div class="msg-row">
                    <img src="https://i.postimg.cc/W3nYsP7X/h-sbn.png" class="avatar">
                    <div class="bubble bot">
                        ××”×œ×Ÿ ×©×—×¨! ğŸ‘‹<br>
                        ×× ×™ ×”××•××—×” ×”×“×™×’×™×˜×œ×™ ×©×œ ×¡×‘×Ÿ.<br>
                        ×× ×™ ×›××Ÿ ×›×“×™ ×œ×¢×–×•×¨ ×œ×š ×‘×—×™×©×•×‘ ×›××•×™×•×ª, ×‘×“×™×§×ª ××œ××™ ×•××™×“×¢ ×˜×›× ×™.
                        <div class="chat-timestamp">×¢×›×©×™×•</div>
                    </div>
                </div>
            </div>

            <div class="bg-[#f0f2f5] p-2 flex items-center gap-2 border-t border-slate-200">
                <input id="chatIn" class="flex-1 h-10 bg-white rounded-full px-5 border-none outline-none shadow-sm text-sm" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()" class="w-10 h-10 bg-[#005c4b] text-white rounded-full flex items-center justify-center shadow-md active:scale-90 transition-transform">
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>

        <div id="view-cart" class="view p-4">
            <h2 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2">
                ×”×¢×’×œ×” ×©×œ×™ <span class="text-sm font-normal text-slate-500 bg-slate-100 px-2 py-1 rounded-lg" id="cartTotalItems">0 ×¤×¨×™×˜×™×</span>
            </h2>

            <div id="cartList" class="space-y-3 mb-8">
                <div class="text-center py-20 text-slate-400">×”×¢×’×œ×” ×¨×™×§×” ×›×¨×’×¢ ğŸ›’</div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 pb-8">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-truck text-blue-500"></i> ×¤×¨×˜×™ ××©×œ×•×—</h3>
                
                <div class="space-y-3">
                    <input id="ordProject" class="w-full bg-slate-50 h-12 px-4 rounded-xl border border-transparent focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="×©× ×”×¤×¨×•×™×§×˜ *">
                    <input id="ordContact" class="w-full bg-slate-50 h-12 px-4 rounded-xl border border-transparent focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="×©× ××™×© ×§×©×¨">
                    <input id="ordPhone" class="w-full bg-slate-50 h-12 px-4 rounded-xl border border-transparent focus:bg-white focus:border-blue-500 outline-none transition-colors" placeholder="×˜×œ×¤×•×Ÿ">
                </div>
                
                <button onclick="getWaze()" id="btnWaze" class="w-full mt-4 bg-blue-50 text-blue-600 font-bold py-3 rounded-xl flex items-center justify-center gap-2 border border-blue-100">
                    <i class="fab fa-waze text-xl"></i> ×¦×¨×£ ××™×§×•× (Waze)
                </button>
                <input type="hidden" id="wazeLink">

                <button onclick="submitOrder()" class="w-full mt-6 bg-slate-900 text-white font-bold py-4 rounded-xl shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-transform">
                    <span>×©×œ×— ×œ×¡×™×“×•×¨ ×¢×‘×•×“×”</span>
                    <i class="fas fa-check"></i>
                </button>
            </div>
        </div>

    </div>

    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('catalog')" id="tab-catalog">
            <i class="fas fa-th-large tab-icon"></i> <span>×§×˜×œ×•×’</span>
        </div>
        <div class="tab-item" onclick="switchTab('smart')" id="tab-smart">
            <i class="fas fa-magic tab-icon text-purple-500"></i> <span>×—×›×</span>
        </div>
        <div class="tab-item" onclick="switchTab('chat')" id="tab-chat">
            <i class="fas fa-comments tab-icon"></i> <span>×¦'××˜</span>
        </div>
        <div class="tab-item" onclick="switchTab('cart')" id="tab-cart">
            <i class="fas fa-clipboard-list tab-icon"></i> <span>×”×–×× ×”</span>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanChatbot } from './js/chatbot-engine.js';

        // --- CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const GEMINI_KEY = "AIzaSyD9plWwyTESFm24c_OTunf4mFAsAmfrgj0";

        // User Context
        const user = { name: "×©×—×¨ ×©××•×œ", phone: "050-0000000" };
        const botEngine = new SabanChatbot(db, user);

        // App State
        let allProducts = [];
        let cart = [];

        // --- SOUNDS ---
        const playSound = () => {
            const audio = document.getElementById('soundPop');
            if(audio) { audio.currentTime = 0; audio.play().catch(e => {}); }
        };

        // --- 1. CATALOG ---
        async function loadCatalogData() {
            try {
                const snap = await getDocs(collection(db, "products"));
                allProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderCatalog();
            } catch(e) { console.error(e); }
        }

        window.renderCatalog = () => {
            const term = document.getElementById('searchCatalog').value.toLowerCase();
            const filtered = allProducts.filter(p => p.core.name.toLowerCase().includes(term));
            const grid = document.getElementById('catalogGrid');

            if(filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-2 text-center py-20 text-slate-400">×œ× × ××¦××• ××•×¦×¨×™× ğŸ§</div>';
                return;
            }

            grid.innerHTML = filtered.map(p => `
                <div class="catalog-card relative">
                    <div class="stock-tag bg-green-100 text-green-700">×‘××œ××™</div>
                    <div class="h-36 p-4 flex items-center justify-center bg-white">
                        <img src="${p.rich?.image || 'https://via.placeholder.com/150'}" class="h-full object-contain">
                    </div>
                    <div class="p-3 bg-white flex flex-col flex-1">
                        <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">${p.core.brand || '×›×œ×œ×™'}</div>
                        <div class="font-bold text-sm leading-tight mb-2 line-clamp-2">${p.core.name}</div>
                        <div class="mt-auto flex justify-between items-center pt-2 border-t border-gray-50">
                            <div class="text-blue-600 font-black">â‚ª${p.core.price}</div>
                            <div class="flex gap-2">
                                <button onclick="consult('${p.core.name}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition"><i class="fas fa-comment-dots"></i></button>
                                <button onclick="addToCart('${p.id}')" class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center shadow-lg active:scale-90 transition"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        // --- 2. CHAT & AI ---
        window.sendChat = async (textOverride) => {
            const inp = document.getElementById('chatIn');
            const txt = textOverride || inp.value;
            if(!txt) return;

            addBubble(txt, 'user');
            inp.value = '';

            // Loading state
            const loadId = addBubble('<i class="fas fa-circle-notch fa-spin"></i> ×—×•×©×‘...', 'bot');

            // AI Call
            const res = await botEngine.ask(txt);
            document.getElementById(loadId).remove();
            
            // Response + Sound + Product Injection
            addBubble(res.text, 'bot', true);
            playSound();
        };

        function addBubble(text, type, scanProducts = false) {
            const box = document.getElementById('chatBox');
            const row = document.createElement('div');
            row.className = `msg-row ${type}`;
            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

            // ×–×™×”×•×™ ××•×¦×¨×™× ×‘×ª×•×š ×”×˜×§×¡×˜
            let productCards = '';
            if(scanProducts && allProducts.length > 0) {
                const detected = allProducts.filter(p => text.includes(p.core.name));
                const unique = [...new Set(detected)];
                unique.forEach(p => {
                    productCards += `
                    <div class="chat-product-card" onclick="addToCart('${p.id}')">
                        <img src="${p.rich?.image}" class="cpc-img">
                        <div class="cpc-content">
                            <div class="cpc-title">${p.core.name}</div>
                            <div class="cpc-price">â‚ª${p.core.price}</div>
                        </div>
                        <div class="cpc-add-btn">×”×•×¡×£ +</div>
                    </div>`;
                });
            }

            const avatarSrc = type==='user' ? "https://ui-avatars.com/api/?name=Shahar+Shaul&background=007aff&color=fff" : "https://i.postimg.cc/W3nYsP7X/h-sbn.png";

            row.innerHTML = `
                <img src="${avatarSrc}" class="avatar">
                <div class="bubble ${type}">
                    ${text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}
                    ${productCards}
                    <div class="chat-timestamp">${time} ${type==='user'?'<i class="fas fa-check-double text-blue-500"></i>':''}</div>
                </div>
            `;
            
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
            return row.id;
        }

        window.consult = (prodName) => {
            switchTab('chat');
            setTimeout(() => sendChat(`×”×™×™, ×× ×™ ××ª×¢× ×™×™×Ÿ ×‘-${prodName}, ×”×× ×™×© ×‘××œ××™?`), 300);
        };

        // --- 3. SMART PASTE ---
        window.processSmartOrder = async () => {
            const txt = document.getElementById('smartInput').value;
            if(!txt) return alert("×× × ×”×–×Ÿ ×¨×©×™××”");
            
            const btn = document.getElementById('btnSmart');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××¤×¢× ×—...';
            btn.disabled = true;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
            const prompt = `Extract construction products and quantity from: "${txt}". Return ONLY JSON array: [{"name":"X","qty":1}]. No markdown.`;

            try {
                const r = await fetch(url, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const d = await r.json();
                let json = d.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                const items = JSON.parse(json);

                items.forEach(i => {
                    cart.push({
                        id: 'smart_'+Math.random(),
                        core: { name: i.name + ` (×›××•×ª: ${i.qty})`, price: 0 },
                        rich: { image: 'https://cdn-icons-png.flaticon.com/512/1040/1040241.png' }
                    });
                });
                updateCart();
                switchTab('cart');
                playSound();
                alert(`âœ… × ×•×¡×¤×• ${items.length} ×¤×¨×™×˜×™×!`);
                document.getElementById('smartInput').value = '';

            } catch(e) { 
                console.error(e);
                alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×‘×™×Ÿ ××ª ×”×¨×©×™××”."); 
            }
            btn.innerHTML = oldHtml; btn.disabled = false;
        };

        // --- 4. CART & SYSTEM ---
        window.addToCart = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(p) {
                cart.push(p);
                updateCart();
                playSound();
                
                // ×× ×™××¦×™×” ×§×˜× ×” ×œ×˜××‘
                const badge = document.getElementById('cartBadge');
                badge.classList.remove('hidden');
                badge.classList.add('animate-ping-custom');
                setTimeout(() => badge.classList.remove('animate-ping-custom'), 500);
            }
        };

        function updateCart() {
            const list = document.getElementById('cartList');
            const badge = document.getElementById('cartBadge');
            const total = document.getElementById('cartTotalItems');
            
            badge.innerText = cart.length;
            badge.classList.toggle('hidden', cart.length === 0);
            total.innerText = `${cart.length} ×¤×¨×™×˜×™×`;

            if(cart.length === 0) { list.innerHTML = '<div class="text-center py-10 text-slate-400">×”×¢×’×œ×” ×¨×™×§×”</div>'; return; }

            list.innerHTML = cart.map((item, i) => `
                <div class="flex items-center gap-3 bg-white p-3 rounded-2xl border border-slate-50 shadow-sm animate-[slideUp_0.2s]">
                    <img src="${item.rich?.image}" class="w-12 h-12 rounded-xl object-cover bg-gray-50">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-xs text-slate-800 truncate">${item.core.name}</div>
                        <div class="text-blue-600 font-bold text-xs mt-1">â‚ª${item.core.price}</div>
                    </div>
                    <button onclick="remCart(${i})" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition"><i class="fas fa-trash-alt text-xs"></i></button>
                </div>
            `).join('');
        }
        window.remCart = (i) => { cart.splice(i, 1); updateCart(); };

        window.getWaze = () => {
            const b = document.getElementById('btnWaze');
            b.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×××ª×¨...';
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById('wazeLink').value = `https://waze.com/ul?ll=${pos.coords.latitude},${pos.coords.longitude}&navigate=yes`;
                    b.className = "w-full mt-4 bg-green-50 text-green-600 font-bold py-3 rounded-xl flex items-center justify-center gap-2 border border-green-200";
                    b.innerHTML = '<i class="fas fa-check"></i> ××™×§×•× × ×§×œ×˜ ×‘×”×¦×œ×—×”';
                }, () => { alert("×™×© ×œ××©×¨ ××™×§×•×"); b.innerText = "× ×¡×” ×©×•×‘"; });
            }
        };

        window.submitOrder = async () => {
            if(cart.length === 0) return alert("×”×¢×’×œ×” ×¨×™×§×”!");
            const order = {
                project: document.getElementById('ordProject').value,
                contact: document.getElementById('ordContact').value,
                phone: document.getElementById('ordPhone').value,
                waze: document.getElementById('wazeLink').value,
                items: cart.map(i => ({name: i.core.name, price: i.core.price})),
                user: user,
                createdAt: new Date(),
                status: 'new'
            };
            if(!order.project) return alert("×—×¡×¨ ×©× ×¤×¨×•×™×§×˜");

            try {
                await addDoc(collection(db, "orders"), order);
                alert("×”×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”! ğŸšš");
                cart = []; updateCart(); switchTab('catalog');
            } catch(e) { alert("×©×’×™××” ×‘×©×œ×™×—×”"); }
        };

        window.switchTab = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
        };

        // Init
        loadCatalogData();
        window.remCart = window.remCart; // Expose to global scope

    </script>
</body>
</html>
