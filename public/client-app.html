<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Client Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin: 0; font-family: sans-serif; background: #f8fafc; color: #1e293b; height: 100vh; display: flex; flex-direction: column; }
        .app-header { background: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .order-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; border-right: 4px solid #cbd5e1; }
        .order-card.new { border-right-color: #3b82f6; }
        .order-card.done { border-right-color: #22c55e; }
        
        /* Modal Styles */
        #orderModal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: none; align-items: end; }
        #orderModal.open { display: flex; }
        .modal-content { background: white; width: 100%; border-radius: 20px 20px 0 0; height: 85vh; display: flex; flex-direction: column; padding: 20px; animation: slideUp 0.3s; }
        @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)} }
    </style>
</head>
<body>

    <header class="app-header">
        <div>
            <h1 class="text-xl font-black text-slate-800">×”×”×–×× ×•×ª ×©×œ×™ ğŸ“¦</h1>
            <p id="userName" class="text-xs text-gray-500">×˜×•×¢×Ÿ...</p>
        </div>
        <img id="userAvatar" class="w-10 h-10 rounded-full border border-gray-200">
    </header>

    <main class="flex-1 overflow-y-auto p-4 pb-24" id="orders-container">
        </main>

    <div class="fixed bottom-6 left-6 z-40">
        <button onclick="openOrderModal()" class="bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-2xl">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <div id="orderModal">
        <div class="modal-content shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">×”×–×× ×” ×—×“×©×” ğŸ“</h2>
                <button onclick="closeOrderModal()" class="text-gray-400 text-2xl"><i class="fas fa-times"></i></button>
            </div>

            <div class="relative mb-4">
                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                <input type="text" id="productSearch" placeholder="×—×¤×© ××•×¦×¨ (×œ××©×œ: ××œ×˜, ×‘×œ×•×§...)" 
                       class="w-full bg-gray-100 p-3 pr-10 rounded-xl outline-none focus:ring-2 focus:ring-blue-500"
                       oninput="filterProducts(this.value)">
            </div>

            <div id="catalogList" class="flex-1 overflow-y-auto mb-4 space-y-2 pr-1">
                </div>

            <div class="border-t pt-4">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-bold">×¤×¨×™×˜×™× ×‘×¢×’×œ×”:</span>
                    <span id="cartCount" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-bold">0</span>
                </div>
                <div id="cartPreview" class="text-xs text-gray-500 mb-4 h-10 overflow-hidden truncate">...</div>
                
                <button onclick="submitOrder()" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg flex justify-center items-center gap-2">
                    <span>ğŸš€ ×©×’×¨ ×”×–×× ×” ×œ×—×"×œ</span>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ×”×’×“×¨×•×ª Firebase
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let currentUser = null;
        let cart = []; // ×”×¢×’×œ×”
        
        // "×’×™×œ×™×•×Ÿ" ××•×¦×¨×™× ××“×•××” (×‘××¦×™××•×ª ×™×‘×•× ×-Comax ××• DB)
        const productsCatalog = [
            { id: 1, name: "××œ×˜ ×œ×‘×Ÿ (×©×§ 25 ×§×’)", icon: "ğŸ§±" },
            { id: 2, name: "××œ×˜ ××¤×•×¨ (×©×§ 50 ×§×’)", icon: "ğŸ—ï¸" },
            { id: 3, name: "×‘×œ×•×§ 10 (××©×˜×—)", icon: "â¬œ" },
            { id: 4, name: "×‘×œ×•×§ 20 (××©×˜×—)", icon: "â¬›" },
            { id: 5, name: "×—×•×œ ×™× (×‘×œ×”)", icon: "ğŸ–ï¸" },
            { id: 6, name: "×˜×™×˜ ××•×›×Ÿ", icon: "ğŸ§ª" },
            { id: 7, name: "×“×‘×§ ×§×¨××™×§×” 114", icon: "ğŸ§´" },
            { id: 8, name: "×¨×•×‘×” ××§×¨×™×œ×™×ª", icon: "ğŸ¨" }
        ];

        window.onload = () => {
            // ×–×™×”×•×™ ××©×ª××© ××”×œ×™× ×§ ××• ××”×–×™×›×¨×•×Ÿ
            const urlParams = new URLSearchParams(window.location.search);
            const uid = urlParams.get('uid');
            
            if (uid) {
                // ×× × ×›× ×¡ ×‘×œ×™× ×§ ×™×©×™×¨ - ×”×•× ××•×¨× ×™×œ
                currentUser = { 
                    uid: uid, 
                    name: uid === '601921' ? '××•×¨× ×™×œ-××©×¨ ×œ×•×™' : '×œ×§×•×— ' + uid,
                    avatar: `https://ui-avatars.com/api/?name=${uid}`
                };
                localStorage.setItem('saban_client', JSON.stringify(currentUser));
            } else {
                currentUser = JSON.parse(localStorage.getItem('saban_client')) || { uid: 'guest', name: '××•×¨×—', avatar: '' };
            }

            document.getElementById('userName').innerText = currentUser.name;
            document.getElementById('userAvatar').src = currentUser.avatar;
            
            loadOrders();
            renderCatalog(productsCatalog); // ×”×¦×’×ª ×›×œ ×”××•×¦×¨×™× ×‘×”×ª×—×œ×”
        };

        // ×˜×¢×™× ×ª ×”×–×× ×•×ª ×‘×–××Ÿ ×××ª
        function loadOrders() {
            const q = query(collection(db, "orders"), 
                            where("clientId", "==", currentUser.uid), // ×¨×§ ×”×–×× ×•×ª ×©×œ ×”×œ×§×•×— ×”×–×”!
                            orderBy("createdAt", "desc"));
            
            const container = document.getElementById('orders-container');
            
            onSnapshot(q, (snap) => {
                container.innerHTML = "";
                if(snap.empty) {
                    container.innerHTML = `<div class="text-center text-gray-400 mt-10">××™×Ÿ ×”×–×× ×•×ª ×¢×“×™×™×Ÿ</div>`;
                    return;
                }
                snap.forEach(d => {
                    const o = d.data();
                    const statusClass = o.status === 'done' ? 'done' : 'new';
                    const itemsText = o.items ? o.items.map(i => `${i.qty}x ${i.name}`).join(', ') : '×¤×¨×™×˜×™× ×›×œ×œ×™×™×';
                    
                    container.innerHTML += `
                    <div class="order-card ${statusClass}">
                        <div class="flex justify-between font-bold">
                            <span>×”×–×× ×” #${o.orderNum || '...'}</span>
                            <span class="text-xs ${o.status==='done'?'text-green-600':'text-blue-600'}">${o.status==='done'?'×¡×•×¤×§':'×‘×˜×™×¤×•×œ'}</span>
                        </div>
                        <div class="text-sm text-gray-600 mt-2 truncate">${itemsText}</div>
                        <div class="text-[10px] text-gray-400 mt-2">${new Date(o.createdAt?.seconds*1000).toLocaleString()}</div>
                    </div>`;
                });
            });
        }

        // --- ×œ×•×’×™×§×ª ×˜×•×¤×¡ ×”×–×× ×” ---

        window.openOrderModal = () => {
            cart = [];
            updateCartUI();
            document.getElementById('orderModal').classList.add('open');
            document.getElementById('productSearch').focus();
        };

        window.closeOrderModal = () => {
            document.getElementById('orderModal').classList.remove('open');
        };

        window.filterProducts = (val) => {
            const filtered = productsCatalog.filter(p => p.name.includes(val));
            renderCatalog(filtered);
        };

        function renderCatalog(list) {
            const el = document.getElementById('catalogList');
            el.innerHTML = "";
            list.forEach(p => {
                el.innerHTML += `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100" onclick="addToCart('${p.name}')">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${p.icon}</span>
                        <span class="font-bold text-sm text-gray-700">${p.name}</span>
                    </div>
                    <button class="w-8 h-8 bg-white border border-gray-200 rounded-full text-blue-600 hover:bg-blue-50">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>`;
            });
        }

        window.addToCart = (name) => {
            // ×”×•×¡×¤×” ×œ×¢×’×œ×” (×¤×©×•×˜×”)
            const existing = cart.find(i => i.name === name);
            if(existing) existing.qty++;
            else cart.push({name: name, qty: 1});
            
            // ×× ×™××¦×™×” ×§×˜× ×”
            updateCartUI();
        };

        function updateCartUI() {
            const count = cart.reduce((acc, item) => acc + item.qty, 0);
            document.getElementById('cartCount').innerText = count;
            
            if(cart.length === 0) {
                document.getElementById('cartPreview').innerText = "×”×¢×’×œ×” ×¨×™×§×”...";
            } else {
                document.getElementById('cartPreview').innerText = cart.map(i => `${i.qty} ×™×—' ${i.name}`).join(', ');
            }
        }

        window.submitOrder = async () => {
            if(cart.length === 0) return alert("×”×¢×’×œ×” ×¨×™×§×”! ×‘×—×¨ ××•×¦×¨×™×.");
            
            const btn = document.querySelector('button[onclick="submitOrder()"]');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ×©×•×œ×—...`;
            
            try {
                await addDoc(collection(db, "orders"), {
                    clientName: currentUser.name,
                    clientId: currentUser.uid,
                    status: 'new',
                    orderNum: "APP-" + Math.floor(Math.random() * 10000),
                    items: cart, // ×©×•×œ×— ××ª ×›×œ ×”×¢×’×œ×”
                    createdAt: serverTimestamp()
                });
                
                closeOrderModal();
                btn.innerHTML = `<span>ğŸš€ ×©×’×¨ ×”×–×× ×” ×œ×—×"×œ</span>`;
                // ××™×Ÿ ×¦×•×¨×š ×œ×¨×¢× ×Ÿ - ×”-Snapshot ×™×¢×“×›×Ÿ ××ª ×”××¡×š ×œ×‘×“
                
            } catch(e) {
                alert("×©×’×™××” ×‘×©×œ×™×—×”");
                console.error(e);
            }
        };
    </script>
</body>
</html>
