// בתוך public/staff.html
import { increment, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"; // להוסיף לייבוא למעלה

window.finishPick = async (orderId) => {
    if(!confirm("סיימת ללקט? המלאי יעודכן והנהג יקבל הודעה.")) return;
    
    try {
        // 1. קבלת פרטי ההזמנה
        const orderRef = doc(db, "orders", orderId);
        const orderSnap = await getDoc(orderRef);
        const orderData = orderSnap.data();

        // 2. עדכון מלאי (לולאה על כל הפריטים)
        const updates = orderData.items.map(item => {
            if (!item.id) return null; // הגנה
            const productRef = doc(db, "products", item.id);
            return updateDoc(productRef, {
                "core.stock": increment(-item.qty)
            });
        });

        await Promise.all(updates); // מחכה שכולם יתעדכנו

        // 3. קידום סטטוס לנהג
        await updateDoc(orderRef, { status: "shipping" });
        
        alert("✅ המלאי עודכן והמשימה עברה לנהג!");
        
    } catch (e) {
        console.error(e);
        alert("שגיאה בעדכון מלאי: " + e.message);
    }
};
