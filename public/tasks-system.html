<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban TaskForce | 砖转 爪注转</title>
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNhYmFuIFRhc2tzIiwKICAic2hvcnRfbmFtZSI6ICJTvGJhbiIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGUxNzJhIiwKICAidGhlbWVfY29sb3IiOiAiIzBiMTEyMCIKfQ==">
    <meta name="theme-color" content="#0f172a">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(function(OneSignal) {
        OneSignal.init({
          appId: "YOUR-ONESIGNAL-APP-ID-HERE", //  砖 驻 转 驻转 砖
        });
      });
    </script>

    <style>
        body { background: #0f172a; color: white; font-family: 'Heebo', sans-serif; overflow-x: hidden; }
        
        /* Stories Bar */
        .stories-container {
            display: flex; gap: 15px; padding: 15px; overflow-x: auto;
            background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid #334155;
        }
        .story-ring {
            width: 65px; height: 65px; border-radius: 50%; padding: 3px;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            position: relative; cursor: pointer; transition: transform 0.2s;
        }
        .story-ring.urgent { background: linear-gradient(45deg, #ef4444, #b91c1c); animation: pulse-red 1.5s infinite; }
        .story-ring:active { transform: scale(0.9); }
        .story-img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid #0f172a; object-fit: cover; }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Hamal Grid */
        .hamal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
        .task-card { background: #1e293b; border-radius: 16px; padding: 20px; border: 1px solid #334155; position: relative; }
        .task-card.overdue { border-color: #ef4444; background: #280a0a; }

        /* The "Lock" Modal (专 注) */
        .lock-screen {
            position: fixed; inset: 0; background: rgba(185, 28, 28, 0.95); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            backdrop-filter: blur(10px); animation: fadeIn 0.3s;
        }
        .lock-icon { font-size: 80px; color: white; margin-bottom: 20px; animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } }

        /* Utils */
        .glass-input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; padding: 10px; width: 100%; outline: none; }
        .glass-input:focus { border-color: #3b82f6; background: rgba(255,255,255,0.15); }
    </style>
</head>
<body>

    <div id="userView" class="hidden">
        <div class="stories-container" id="storiesBar">
            <div class="text-sm text-gray-400 self-center"> 砖转 驻转转 </div>
        </div>
        
        <div class="p-6 text-center">
            <h2 class="text-3xl font-black mb-2">砖, <span id="userNameDisplay">...</span></h2>
            <p class="text-slate-400">抓 注 注 注 爪驻 砖转 驻转转</p>
        </div>
    </div>

    <div id="adminView" class="hidden">
        <div class="bg-slate-800 p-4 flex justify-between items-center shadow-lg border-b border-slate-700">
            <h1 class="text-xl font-black flex items-center gap-2"><i class="fas fa-radar text-red-500"></i> " 砖转</h1>
            <button onclick="openCreateModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-bold text-sm shadow flex items-center gap-2">
                <i class="fas fa-plus"></i> 砖 砖
            </button>
        </div>
        
        <div class="p-4 flex gap-4 overflow-x-auto">
            <div class="bg-slate-800 px-4 py-2 rounded-lg text-sm font-bold border border-slate-700">住": <span id="statTotal">0</span></div>
            <div class="bg-red-900/30 text-red-400 px-4 py-2 rounded-lg text-sm font-bold border border-red-900/50">专: <span id="statLate">0</span></div>
            <div class="bg-yellow-900/30 text-yellow-400 px-4 py-2 rounded-lg text-sm font-bold border border-yellow-900/50">拽砖转 专: <span id="statExt">0</span></div>
        </div>

        <div id="tasksGrid" class="hamal-grid"></div>
    </div>

    <div id="createModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
        <div class="bg-slate-900 p-8 rounded-2xl w-full max-w-md border border-slate-700 shadow-2xl">
            <h2 class="text-2xl font-black mb-6">砖专 砖 </h2>
            <form onsubmit="event.preventDefault(); submitTask();" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400">转专转 砖</label>
                    <input id="taskTitle" class="glass-input font-bold" placeholder="砖: 住驻专转  " required>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400">拽爪 :</label>
                    <select id="taskAssignee" class="glass-input bg-slate-800">
                        <option value="all">  (注 转)</option>
                        </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400">- (砖注 转专)</label>
                    <input id="taskDeadline" type="datetime-local" class="glass-input" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400">驻转</label>
                    <div class="flex gap-4 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="prio" value="normal" checked class="accent-blue-500"> 专</label>
                        <label class="flex items-center gap-2 cursor-pointer text-red-400 font-bold"><input type="radio" name="prio" value="urgent" class="accent-red-500"> 祝 砖 </label>
                    </div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="document.getElementById('createModal').style.display='none'" class="flex-1 py-3 rounded-xl font-bold bg-slate-800 text-slate-400"></button>
                    <button type="submit" class="flex-1 py-3 rounded-xl font-bold bg-blue-600 hover:bg-blue-700 text-white shadow-lg">砖专 砖 转专</button>
                </div>
            </form>
        </div>
    </div>

    <div id="taskViewer" class="fixed inset-0 bg-slate-900 z-40 hidden flex-col">
        <button id="closeTaskBtn" onclick="closeTaskViewer()" class="absolute top-4 left-4 text-slate-400 text-2xl"><i class="fas fa-times"></i></button>
        
        <div class="p-8 mt-10 text-center">
            <div id="viewPrioBadge" class="inline-block bg-blue-600 text-xs font-bold px-3 py-1 rounded-full mb-4">砖 专</div>
            <h1 id="viewTitle" class="text-3xl font-black mb-4 leading-tight">...</h1>
            <div class="text-6xl font-black font-mono my-8" id="countdown">00:00:00</div>
            <p class="text-slate-400 text-sm mb-8"> 砖转专 爪注 砖</p>
            
            <button onclick="markDone()" class="w-full py-4 bg-green-600 hover:bg-green-500 rounded-2xl font-black text-xl shadow-lg shadow-green-900/50 transition transform active:scale-95">
                <i class="fas fa-check"></i> 住转 转 砖
            </button>
        </div>

        <div id="lockScreen" class="lock-screen">
            <i class="fas fa-lock lock-icon"></i>
            <h2 class="text-4xl font-black mb-2">注专转 注!</h2>
            <p class="text-xl mb-8 opacity-90">专转  砖. 注  住.</p>
            
            <div class="w-full max-w-sm px-6">
                <label class="text-left block text-sm font-bold mb-2">  住转 ?</label>
                <textarea id="extensionReason" class="glass-input h-24 mb-4" placeholder=" 驻专 住 转转..."></textarea>
                <button onclick="requestTime()" class="w-full py-3 bg-white text-red-900 font-black rounded-xl hover:bg-gray-100">
                    拽砖 专转  砖专专 注
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, where, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let activeTask = null;
        let timerInterval = null;

        // --- INIT ---
        window.onload = async () => {
            const stored = localStorage.getItem('saban_user');
            if(!stored) return window.location.href = 'index.html';
            currentUser = JSON.parse(stored);

            document.getElementById('userNameDisplay').innerText = currentUser.name;

            if (currentUser.role === 'admin' || currentUser.role === 'ops') {
                document.getElementById('adminView').classList.remove('hidden');
                initAdmin();
            } else {
                document.getElementById('userView').classList.remove('hidden');
                initUser();
            }
        };

        // --- ADMIN LOGIC ---
        async function initAdmin() {
            // 注转 砖转砖 住拽
            const usersSnap = await getDocs(collection(db, "users"));
            const select = document.getElementById('taskAssignee');
            usersSnap.forEach(d => {
                const u = d.data();
                if(u.role !== 'admin') {
                    select.innerHTML += `<option value="${d.id}">${u.name} (${u.role})</option>`;
                }
            });

            //  砖转
            const q = query(collection(db, "tasks"), orderBy("deadline", "asc"));
            onSnapshot(q, (snap) => {
                const grid = document.getElementById('tasksGrid');
                grid.innerHTML = '';
                
                let total = 0, late = 0, ext = 0;

                snap.forEach(d => {
                    const t = d.data();
                    if(t.status === 'done') return; //  爪 专转 " 专砖   注住
                    
                    total++;
                    const isLate = new Date() > new Date(t.deadline.seconds * 1000);
                    if(isLate) late++;
                    if(t.status === 'extension_requested') ext++;

                    const timeLeft = getTimeLeft(t.deadline.seconds * 1000);
                    
                    grid.innerHTML += `
                    <div class="task-card ${isLate ? 'overdue' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg">${t.title}</h3>
                            ${t.priority === 'urgent' ? '<span class="text-red-500 font-bold animate-pulse"> 祝</span>' : ''}
                        </div>
                        <div class="text-sm text-slate-400 mb-4">
                            <div><i class="fas fa-user"></i> 拽爪 : ${t.assigneeName}</div>
                            <div><i class="fas fa-clock"></i> -: ${new Date(t.deadline.seconds*1000).toLocaleString()}</div>
                        </div>
                        
                        ${isLate ? `<div class="bg-red-900/50 text-red-200 p-2 rounded text-center font-bold mb-2">锔 专: ${timeLeft}</div>` : ''}
                        
                        ${t.status === 'extension_requested' ? `
                            <div class="bg-yellow-900/50 p-2 rounded mb-2 border border-yellow-600">
                                <div class="text-yellow-400 font-bold text-xs">拽砖转 专:</div>
                                <div class="text-xs italic">"${t.extensionReason}"</div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="approveExt('${d.id}')" class="bg-green-600 text-white px-2 py-1 rounded text-xs flex-1">砖专</button>
                                    <button onclick="denyExt('${d.id}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs flex-1"></button>
                                </div>
                            </div>
                        ` : ''}

                        <button onclick="deleteTask('${d.id}')" class="text-slate-500 text-xs hover:text-red-500 mt-2">拽 砖</button>
                    </div>`;
                });

                document.getElementById('statTotal').innerText = total;
                document.getElementById('statLate').innerText = late;
                document.getElementById('statExt').innerText = ext;
            });
        }

        window.openCreateModal = () => document.getElementById('createModal').style.display = 'flex';
        
        window.submitTask = async () => {
            const title = document.getElementById('taskTitle').value;
            const assigneeId = document.getElementById('taskAssignee').value;
            const assigneeName = document.getElementById('taskAssignee').options[document.getElementById('taskAssignee').selectedIndex].text;
            const deadlineVal = document.getElementById('taskDeadline').value;
            const prio = document.querySelector('input[name="prio"]:checked').value;

            if(!deadlineVal) return alert(" 专 转专 砖注");

            await addDoc(collection(db, "tasks"), {
                title,
                assigneeId, // 'all' or specific UID
                assigneeName,
                priority: prio,
                deadline: new Date(deadlineVal), // Firestore will convert
                status: 'open', // open, done, extension_requested
                createdBy: currentUser.name,
                createdAt: serverTimestamp()
            });

            // OneSignal Trigger (Simulation Code)
            if(window.OneSignal) {
                //   拽 转 砖转 注 -AssigneeId
                console.log("Sending Push Notification to " + assigneeName);
            }

            document.getElementById('createModal').style.display = 'none';
            document.getElementById('taskTitle').value = '';
        };

        window.approveExt = async (id) => {
            // 住驻转 砖注 -
            const snap = await getDoc(doc(db, "tasks", id)); // 爪专  getDoc  住专
            // 爪专  驻砖 注 住住
            await updateDoc(doc(db, "tasks", id), { status: 'open', extensionReason: null });
            alert("拽砖 砖专 (砖 注  转 专住 )");
        };
        
        window.deleteTask = async(id) => { if(confirm("拽?")) await deleteDoc(doc(db, "tasks", id)); }; // 爪专 deleteDoc

        // --- USER LOGIC ---
        function initUser() {
            //  砖转 砖  
            const q = query(collection(db, "tasks"), where("status", "!=", "done"));
            
            onSnapshot(q, (snap) => {
                const container = document.getElementById('storiesBar');
                container.innerHTML = '';
                let hasTask = false;

                snap.forEach(d => {
                    const t = d.data();
                    // 驻专 爪 拽 ( 'OR' -firebase )
                    if(t.assigneeId === currentUser.uid || t.assigneeId === 'all') {
                        hasTask = true;
                        const isUrgent = t.priority === 'urgent';
                        
                        container.innerHTML += `
                        <div class="flex flex-col items-center gap-1" onclick="openTaskView('${d.id}')">
                            <div class="story-ring ${isUrgent ? 'urgent' : ''}">
                                <img src="https://ui-avatars.com/api/?name=${t.createdBy}&background=random" class="story-img">
                            </div>
                            <span class="text-xs font-bold truncate w-16 text-center">${t.title}</span>
                        </div>`;

                        // Store data for view
                        t.id = d.id;
                        activeTask = t; // 砖专 转 专 (驻专拽砖  注专)
                    }
                });

                if(!hasTask) container.innerHTML = '<div class="text-sm text-gray-400 self-center"> 砖转 </div>';
            });
        }

        window.openTaskView = (id) => {
            // 爪转 砖祝 转 砖 住驻爪驻转 注专
            if(!activeTask || activeTask.id !== id) return; // 驻砖转 

            const v = document.getElementById('taskViewer');
            v.classList.remove('hidden');
            v.classList.add('flex');
            
            document.getElementById('viewTitle').innerText = activeTask.title;
            const badge = document.getElementById('viewPrioBadge');
            if(activeTask.priority === 'urgent') {
                badge.className = "inline-block bg-red-600 text-xs font-bold px-3 py-1 rounded-full mb-4 animate-pulse";
                badge.innerText = " 砖 驻";
            } else {
                badge.className = "inline-block bg-blue-600 text-xs font-bold px-3 py-1 rounded-full mb-4";
                badge.innerText = "砖 专";
            }

            startTimer(activeTask.deadline.seconds * 1000);
        };

        window.closeTaskViewer = () => {
            document.getElementById('taskViewer').classList.add('hidden');
            document.getElementById('taskViewer').classList.remove('flex');
            clearInterval(timerInterval);
        };

        function startTimer(deadlineMs) {
            clearInterval(timerInterval);
            
            const update = () => {
                const now = new Date().getTime();
                const dist = deadlineMs - now;

                if (dist < 0) {
                    // TIME IS UP!
                    clearInterval(timerInterval);
                    document.getElementById('countdown').innerText = "00:00:00";
                    document.getElementById('countdown').classList.add('text-red-500');
                    lockScreen();
                    return;
                }

                const h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((dist % (1000 * 60)) / 1000);

                document.getElementById('countdown').innerText = 
                    `${h < 10 ? '0'+h : h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            };

            update();
            timerInterval = setInterval(update, 1000);
        }

        function lockScreen() {
            document.getElementById('lockScreen').style.display = 'flex';
            document.getElementById('closeTaskBtn').style.display = 'none'; //  转 住专
        }

        window.requestTime = async () => {
            const reason = document.getElementById('extensionReason').value;
            if(!reason || reason.length < 5) return alert(" 驻专 住 转 ( 5 转)");

            await updateDoc(doc(db, "tasks", activeTask.id), {
                status: 'extension_requested',
                extensionReason: reason
            });

            alert("拽砖 砖 . 转 砖专.");
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('closeTaskBtn').style.display = 'block';
            closeTaskViewer();
        };

        window.markDone = async () => {
            if(!confirm("住转 转 砖 转?")) return;
            await updateDoc(doc(db, "tasks", activeTask.id), { status: 'done' });
            closeTaskViewer();
        };

        // Helper
        function getTimeLeft(ms) {
            const diff = ms - new Date().getTime();
            if(diff < 0) return "注专 ";
            const h = Math.floor(diff / 3600000);
            return h + " 砖注转";
        }

    </script>
</body>
</html>
