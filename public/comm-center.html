<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Chat | 专 转拽砖专转</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background: #e5e7eb; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 300px; background: white; border-left: 1px solid #d1d5db; display: flex; flex-direction: column; z-index: 20; }
        .sidebar-header { padding: 15px; background: #f3f4f6; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .search-box { padding: 10px; border-bottom: 1px solid #f3f4f6; }
        .chat-list { flex: 1; overflow-y: auto; }
        
        .chat-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f9fafb; }
        .chat-item:hover { background: #f9fafb; }
        .chat-item.active { background: #eff6ff; border-right: 4px solid #3b82f6; }
        
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid #e5e7eb; }
        .avatar-group { background: #e0f2fe; color: #0369a1; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        
        .unread-badge { background: #2563eb; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; margin-right: auto; }

        /* Main Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #efeae2; position: relative; }
        .chat-header { background: #f0f2f5; padding: 10px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #d1d5db; height: 60px; }
        
        .messages-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.95; }
        
        .message { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #dcf8c6; border-top-left-radius: 0; }
        
        .msg-time { font-size: 10px; color: #9ca3af; text-align: left; margin-top: 4px; }
        .msg-sender { font-size: 10px; font-weight: bold; color: #e11d48; margin-bottom: 2px; }

        /* Input Area */
        .input-area { background: #f0f2f5; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .msg-input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; font-size: 14px; }
        .btn-send { background: #2563eb; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-send:hover { transform: scale(1.1); }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; transition: 0.3s; transform: translateX(0); }
            .sidebar.hidden-mobile { transform: translateX(100%); }
            .chat-area { width: 100%; }
            .back-btn { display: block; margin-left: 10px; cursor: pointer; }
        }
        @media (min-width: 769px) {
            .back-btn { display: none; }
        }

        /* Section Dividers */
        .list-section { font-size: 11px; font-weight: bold; color: #6b7280; padding: 10px 15px 5px; background: #f9fafb; text-transform: uppercase; letter-spacing: 0.5px; }
    </style>
</head>
<body>

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="font-bold text-gray-700 flex items-center gap-2"><i class="fab fa-whatsapp text-green-500 text-xl"></i> Saban Chat</div>
            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs"></div>
        </div>
        <div class="search-box">
            <input type="text" id="search-contact" placeholder="驻砖 砖 拽砖专..." class="w-full bg-gray-100 px-3 py-2 rounded-lg text-sm outline-none">
        </div>
        <div class="chat-list" id="contacts-list">
            </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <i class="fas fa-arrow-right back-btn text-gray-600" onclick="toggleSidebar()"></i>
            <img id="header-img" src="" class="avatar hidden">
            <div>
                <div id="header-name" class="font-bold text-gray-800">专 砖 拽砖专</div>
                <div id="header-status" class="text-xs text-gray-500"></div>
            </div>
        </div>

        <div id="messages" class="messages-box">
            <div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-50">
                <i class="fas fa-comments text-6xl mb-4"></i>
                <div>专 砖  转</div>
            </div>
        </div>

        <div class="input-area">
            <button class="text-gray-500 hover:text-gray-700 p-2"><i class="fas fa-paperclip"></i></button>
            <input type="text" id="msg-input" class="msg-input" placeholder="拽 注..." onkeypress="handleKey(event)">
            <div class="btn-send" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // STATE
        let currentChatId = null;
        let currentUser = 'dispatcher'; // 住爪 - 专注  住专
        let contacts = [];

        // 1.  砖转砖 + 住驻转 专 住转
        const qUsers = query(collection(db, "users"), orderBy("name"));
        
        onSnapshot(qUsers, (snap) => {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            contacts = [];

            // --- 拽爪转 拽注转 ---
            renderContactItem(list, { id: 'general', name: ' 注专抓 ', type: 'group', avatar: null, role: 'system' }, true);
            
            // 转专转 
            list.innerHTML += `<div class="list-section"> 住专爪</div>`;
            
            // --- 住驻 驻 砖 专 ( 注  -DB) ---
            const veredExists = snap.docs.find(d => d.data().name.includes('专'));
            if (!veredExists) {
                 renderContactItem(list, { 
                     id: 'vered_manual', 
                     name: '专 住', 
                     role: 'manager', 
                     avatar: 'https://ui-avatars.com/api/?name=Vered&background=be123c&color=fff',
                     phone: '0506662300'
                 });
            }

            // --- 注转 砖转砖 -DB ---
            let driversList = [];
            let managersList = [];

            snap.forEach(d => {
                const u = { id: d.id, ...d.data() };
                if (u.type === 'driver') driversList.push(u);
                else if (u.type === 'manager' || u.role?.includes('')) managersList.push(u);
            });

            // 专专 
            managersList.forEach(u => renderContactItem(list, u));

            // 转专转 
            list.innerHTML += `<div class="list-section"> 砖 砖</div>`;
            driversList.forEach(u => renderContactItem(list, u));
        });

        function renderContactItem(container, u, isGroup = false) {
            const avatarSrc = u.avatar || `https://ui-avatars.com/api/?name=${u.name}&background=random`;
            const icon = isGroup ? '<i class="fas fa-bullhorn"></i>' : `<img src="${avatarSrc}" class="avatar">`;
            const cssClass = isGroup ? 'avatar-group rounded-lg w-[45px] h-[45px]' : '';
            
            //  专 爪注转 砖
            const isVered = u.name.includes('专');
            const nameColor = isVered ? 'text-rose-700 font-bold' : 'text-gray-800 font-bold';
            const badge = isVered ? '<i class="fas fa-crown text-xs text-yellow-500 ml-1"></i>' : '';

            const html = `
            <div class="chat-item" onclick="openChat('${u.id}', '${u.name}', '${avatarSrc}', '${u.type}')">
                <div class="${isGroup ? cssClass : ''}">${icon}</div>
                <div class="flex-1">
                    <div class="${nameColor} text-sm flex items-center justify-between">
                        <span>${u.name} ${badge}</span>
                        <span class="text-[10px] text-gray-400">12:30</span>
                    </div>
                    <div class="text-xs text-gray-500 truncate w-40">${u.role || ' 砖'}</div>
                </div>
            </div>`;
            
            container.innerHTML += html;
        }

        // 2. 驻转转 爪'
        window.openChat = (id, name, avatar, type) => {
            currentChatId = id;
            
            // UI Update
            document.getElementById('header-name').innerText = name;
            document.getElementById('header-status').innerText = type === 'group' ? '注专抓 注转 ' : '专';
            const img = document.getElementById('header-img');
            img.src = avatar;
            img.classList.remove('hidden');
            
            // Mobile toggle
            if(window.innerWidth < 768) toggleSidebar();

            // Load Messages
            const qMsg = query(collection(db, `chats/${id}/messages`), orderBy("createdAt", "asc"));
            onSnapshot(qMsg, (snap) => {
                const box = document.getElementById('messages');
                box.innerHTML = '';
                
                if (snap.empty) {
                     box.innerHTML = `<div class="text-center mt-10 text-gray-500 text-sm bg-white/80 p-2 rounded w-fit mx-auto">转转 砖 注 ${name}</div>`;
                }

                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.senderId === 'dispatcher'; // 
                    const time = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...';
                    
                    box.innerHTML += `
                    <div class="message ${isMe ? 'msg-out' : 'msg-in'}">
                        ${!isMe ? `<div class="msg-sender">${m.senderName}</div>` : ''}
                        <div>${m.text}</div>
                        <div class="msg-time">${time} <i class="fas fa-check-double text-blue-500 ml-1"></i></div>
                    </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        // 3. 砖转 注
        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !currentChatId) return;

            input.value = '';
            
            // 砖专 -Firestore
            await addDoc(collection(db, `chats/${currentChatId}/messages`), {
                text: text,
                senderId: 'dispatcher',
                senderName: ' (住专)', //  - 爪专 拽转 
                createdAt: serverTimestamp(),
                read: false
            });
            
            // 爪 砖
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3'); 
            audio.volume = 0.2;
            audio.play().catch(()=>{});
        };

        window.handleKey = (e) => { if (e.key === 'Enter') sendMessage(); };
        
        // Mobile Sidebar Toggle
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('hidden-mobile');
        };

        // 住驻  驻注转 砖 专 注专转    砖 (Self-Healing)
        async function ensureVeredInDB() {
            // 拽  拽
            //  驻砖专 专抓 拽 砖拽 砖拽转 住驻
            //  专 驻  转爪 (render)
        }
    </script>
</body>
</html>
