<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "07b81f2e-e812-424f-beca-36584b12ccf2",
        });
      });
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #efeae2; height: 100vh; display: flex; flex-direction: column; font-family: sans-serif; }
        
        .chat-sidebar { width: 100%; background: white; height: 100%; display: flex; flex-direction: column; }
        .chat-row { padding: 12px 16px; border-bottom: 1px solid #f0f2f5; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .chat-row:hover { background: #f5f6f6; }
        .avatar { width: 45px; height: 45px; rounded-full; background: #ddd; object-fit: cover; }
        
        .conversation { flex: 1; display: none; flex-direction: column; background: #efeae2; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.95; }
        .conversation.active { display: flex; position: absolute; inset: 0; z-index: 20; }
        
        .chat-header { height: 60px; background: #f0f2f5; display: flex; align-items: center; padding: 0 16px; gap: 10px; border-bottom: 1px solid #d1d7db; }
        .msg-area { flex: 1; padding: 20px; overflow-y: auto; }
        .input-area { min-height: 60px; background: #f0f2f5; display: flex; align-items: center; padding: 5px 10px; gap: 10px; }
        .input-box { flex: 1; padding: 10px; border-radius: 8px; border: none; outline: none; }
    </style>
</head>
<body>

    <div class="chat-sidebar" id="chat-list-view">
        <div class="p-3 bg-gray-50 border-b">
            <input type="text" placeholder="חיפוש..." class="w-full bg-white border rounded-lg px-3 py-2 text-sm">
        </div>
        <div id="contacts-list">
            <div class="p-4 text-center text-gray-400">טוען...</div>
        </div>
    </div>

    <div class="conversation" id="conversation-view">
        <div class="chat-header">
            <button onclick="closeChat()"><i class="fas fa-arrow-right text-gray-600"></i></button>
            <img id="chat-avatar" class="avatar">
            <div class="font-bold text-gray-800" id="chat-name">שם</div>
        </div>
        <div class="msg-area" id="msg-area"></div>
        <div class="input-area">
            <input type="text" class="input-box" placeholder="הקלד הודעה...">
            <button class="text-green-600 text-xl"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        onSnapshot(query(collection(db, "users"), orderBy("name")), (snap) => {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            snap.forEach(d => {
                const u = d.data();
                if(u.type === 'client') return;
                list.innerHTML += `
                <div class="chat-row" onclick="openChat('${u.name}', '${u.avatar}')">
                    <img src="${u.avatar || `https://ui-avatars.com/api/?name=${u.name}`}" class="avatar">
                    <div>
                        <div class="font-bold text-sm text-gray-800">${u.name}</div>
                        <div class="text-xs text-gray-500">${u.role || 'זמין'}</div>
                    </div>
                </div>`;
            });
        });

        window.openChat = (name, avatar) => {
            document.getElementById('conversation-view').classList.add('active');
            document.getElementById('chat-name').innerText = name;
            document.getElementById('chat-avatar').src = avatar || `https://ui-avatars.com/api/?name=${name}`;
        };
        window.closeChat = () => document.getElementById('conversation-view').classList.remove('active');
    </script>
</body>
</html>
