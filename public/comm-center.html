<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Comm Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background: #d1d7db; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 30%; min-width: 300px; background: white; border-left: 1px solid #e9edef; display: flex; flex-direction: column; }
        .main-chat { flex: 1; background: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); display: flex; flex-direction: column; position: relative; }

        /* Sidebar Header */
        .side-header { height: 60px; background: #f0f2f5; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-right: 1px solid #d1d7db; }
        
        /* Search */
        .search-container { padding: 10px; border-bottom: 1px solid #f0f2f5; background: white; }
        .search-box { background: #f0f2f5; border-radius: 8px; padding: 8px; display: flex; align-items: center; font-size: 14px; }
        
        /* List */
        .chat-list { overflow-y: auto; flex: 1; }
        .chat-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f5f6f6; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }
        
        .avatar { width: 45px; height: 45px; rounded: 50%; object-fit: cover; margin-left: 12px; }
        .info { flex: 1; }
        .name { font-weight: bold; font-size: 15px; color: #111b21; }
        .last-msg { font-size: 13px; color: #667781; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        /* Main Chat Header */
        .chat-header { height: 60px; background: #f0f2f5; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #d1d7db; }
        .header-info { display: flex; align-items: center; cursor: pointer; }
        
        /* THE GRAY BUTTON (Task Dispatch) */
        .btn-dispatch { background: #54656f; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-dispatch:hover { background: #3b4a54; transform: translateY(-1px); }

        /* Messages */
        .messages-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 60%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-meta { font-size: 10px; color: #999; text-align: left; margin-top: 4px; display: flex; justify-content: flex-end; gap: 3px; }

        /* Input */
        .input-area { height: 62px; background: #f0f2f5; padding: 10px 16px; display: flex; align-items: center; gap: 10px; }
        .type-box { flex: 1; background: white; padding: 12px; border-radius: 8px; border: none; outline: none; font-size: 15px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="side-header">
            <img src="https://media-mrs2-2.cdn.whatsapp.net/v/t61.24694-24/490584763_1521666505466352_3860845398977059833_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3QEGGv9ElRRb2Qx1Adjclex0ahijeyYdc8W8wmVuCZ6L2A&oe=695B04A6&_nc_sid=5e03e0&_nc_cat=104" class="w-10 h-10 rounded-full border">
            <div class="flex gap-4 text-gray-500">
                <i class="fas fa-circle-notch"></i>
                <i class="fas fa-comment-alt"></i>
                <i class="fas fa-ellipsis-v"></i>
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search text-gray-500 ml-3"></i>
                <input type="text" placeholder="驻砖  转转 爪' 砖" class="bg-transparent outline-none w-full">
            </div>
        </div>

        <div id="contacts-list" class="chat-list">
            </div>
    </div>

    <div class="main-chat">
        
        <div class="chat-header">
            <div class="header-info">
                <img id="active-avatar" src="https://ui-avatars.com/api/?background=ddd&color=fff" class="avatar">
                <div class="mr-3">
                    <div id="active-name" class="font-bold text-gray-800">专 爪'</div>
                    <div id="active-status" class="text-xs text-gray-500">...</div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button id="btn-dispatch" onclick="openDispatchModal()" class="btn-dispatch hidden">
                    <i class="fas fa-tasks"></i>
                    <span>砖专 砖</span>
                </button>
                
                <i class="fas fa-search text-gray-500 cursor-pointer"></i>
                <i class="fas fa-ellipsis-v text-gray-500 cursor-pointer"></i>
            </div>
        </div>

        <div id="messages-area" class="messages-area">
            <div class="text-center text-sm text-gray-500 bg-[#e0f2fe] p-2 rounded w-fit mx-auto mt-10 shadow-sm">
                <i class="fas fa-lock text-xs"></i> 注转  爪驻转 拽爪 拽爪
            </div>
        </div>

        <div class="input-area">
            <i class="far fa-smile text-2xl text-gray-500 cursor-pointer"></i>
            <i class="fas fa-paperclip text-xl text-gray-500 cursor-pointer"></i>
            <input type="text" id="msg-input" class="type-box" placeholder="拽 注..." onkeydown="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="text-[#00a884] text-2xl"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // 1. 砖 拽砖专 (转拽 住专)
        const CHATS = [
            { id: 'orders_main', name: '转 拽转', type: 'group', avatar: 'https://ui-avatars.com/api/?name=Orders&background=00a884&color=fff' },
            { id: 'management', name: '注转 ', type: 'group', avatar: 'https://ui-avatars.com/api/?name=Saban&background=1e293b&color=fff' },
            
            // >>>  注 -ID 拽 <<<
            { id: 'chat_0500000607', name: '转 ()', phone: '0500000607', type: 'driver', avatar: 'https://cdn-icons-png.flaticon.com/512/1995/1995470.png' },
            { id: 'chat_0500000606', name: '注 (祝)', phone: '0500000606', type: 'driver', avatar: 'https://cdn-icons-png.flaticon.com/512/741/741407.png' }
        ];

        let activeChat = null;

        // 2. Render List
        function renderList() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            
            CHATS.forEach(c => {
                list.innerHTML += `
                <div class="chat-item" onclick="loadChat('${c.id}')">
                    <img src="${c.avatar}" class="avatar">
                    <div class="info mr-3">
                        <div class="flex justify-between">
                            <span class="name">${c.name}</span>
                            <span class="text-xs text-gray-400">10:45</span>
                        </div>
                        <div class="last-msg">抓 住 爪'...</div>
                    </div>
                </div>`;
            });
        }
        renderList();

        // 3. Load Chat Logic
        window.loadChat = (chatId) => {
            const chat = CHATS.find(c => c.id === chatId);
            activeChat = chat;

            // UI Update
            document.getElementById('active-name').innerText = chat.name;
            document.getElementById('active-avatar').src = chat.avatar;
            document.getElementById('active-status').innerText = chat.type === 'driver' ? '专 (Driver App)' : '拽爪 驻注';
            
            // Show/Hide "Dispatch Task" Button
            const btn = document.getElementById('btn-dispatch');
            if (chat.type === 'driver') {
                btn.classList.remove('hidden');
                btn.classList.add('flex');
            } else {
                btn.classList.add('hidden');
                btn.classList.remove('flex');
            }

            // Load Messages
            // 注专: 住专转 转 orderBy 转  注 拽专住转   拽住,  转爪注 拽
            const q = query(collection(db, `chats/${chatId}/messages`));
            
            onSnapshot(q, (snap) => {
                const area = document.getElementById('messages-area');
                area.innerHTML = ''; 
                
                //  
                const msgs = snap.docs.map(d => d.data()).sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                msgs.forEach(m => {
                    const isMe = m.sender === '专 (Admin)'; 
                    
                    area.innerHTML += `
                    <div class="msg ${isMe ? 'msg-out' : 'msg-in'}">
                        ${!isMe && chat.type === 'group' ? `<div class="text-xs font-bold text-orange-600 mb-1">${m.sender}</div>` : ''}
                        <div>${m.text}</div>
                        <div class="msg-meta">
                            <span>${m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'}</span>
                            ${isMe ? '<i class="fas fa-check-double text-blue-500"></i>' : ''}
                        </div>
                    </div>`;
                });
                area.scrollTop = area.scrollHeight;
            });
        };

        // 4. Send Message
        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !activeChat) return;
            
            input.value = '';
            await addDoc(collection(db, `chats/${activeChat.id}/messages`), {
                text: text,
                sender: '专 (Admin)',
                timestamp: serverTimestamp()
            });
        };

        // 5. THE DISPATCH MODAL
        window.openDispatchModal = () => {
            if(!activeChat || activeChat.type !== 'driver') return;

            Swal.fire({
                title: `砖 ${activeChat.name}`,
                html: `
                    <div class="text-right space-y-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500">住 砖</label>
                            <select id="task-cat" class="swal2-input w-full mx-0 text-sm">
                                <option value="client">  拽 ()</option>
                                <option value="transfer"> 注专  住驻 (转)</option>
                                <option value="supplier"> 住祝 住驻拽 (住)</option>
                                <option value="urgent"> 砖 驻 ()</option>
                            </select>
                        </div>
                        <textarea id="task-desc" class="swal2-textarea w-full mx-0" placeholder=" 砖? (: 住祝 砖专)"></textarea>
                        <input id="task-addr" class="swal2-input w-full mx-0" placeholder="转转 -Waze">
                    </div>
                `,
                confirmButtonText: '砖专  ',
                confirmButtonColor: '#54656f',
                showCancelButton: true,
                preConfirm: () => {
                    return {
                        type: document.getElementById('task-cat').value,
                        desc: document.getElementById('task-desc').value,
                        addr: document.getElementById('task-addr').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    if(!data.desc) return;

                    // 1. Create Order (For Driver App)
                    // 砖砖 砖 拽 ( "()")
                    const driverNameClean = activeChat.name.split(' ')[0]; // "转"

                    await addDoc(collection(db, "orders"), {
                        driverId: driverNameClean, 
                        clientName: "砖  (爪')",
                        text: data.desc,
                        address: data.addr,
                        taskType: data.type,
                        status: 'assigned',
                        lastUpdate: serverTimestamp(),
                        createdAt: serverTimestamp()
                    });

                    // 2. Send Chat Notification
                    await addDoc(collection(db, `chats/${activeChat.id}/messages`), {
                        text: ` *砖 砖:* ${data.desc}`,
                        sender: '注专转',
                        timestamp: serverTimestamp()
                    });

                    Swal.fire({
                        title: '砖专!',
                        text: '砖 驻注 爪   拽 爪驻爪祝',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        };

        // Expose functions
        window.loadChat = loadChat;
        window.sendMessage = sendMessage;
        window.openDispatchModal = openDispatchModal;

    </script>
</body>
</html>
