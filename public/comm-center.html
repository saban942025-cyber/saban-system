<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Comm Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 350px; background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .main-chat { flex: 1; background: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); display: flex; flex-direction: column; position: relative; }

        /* Sidebar Items */
        .search-box { padding: 10px; background: #f0f2f5; border-bottom: 1px solid #e2e8f0; }
        .chat-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f5f6f6; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }
        
        .avatar { width: 45px; height: 45px; rounded: 50%; object-fit: cover; margin-left: 12px; }
        .group-avatar { background: #e2e8f0; color: #64748b; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* Message Area */
        .chat-header { height: 60px; background: #f0f2f5; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e2e8f0; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        .msg { max-width: 60%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-meta { font-size: 10px; color: #999; text-align: left; margin-top: 4px; display: flex; justify-content: space-between; align-items: center; }
        .sender-name { font-size: 11px; font-weight: bold; color: #d97706; margin-bottom: 2px; }

        /* Team Panel (Right Side in LTR / Left in RTL) */
        .team-panel { width: 0; transition: 0.3s; background: white; border-right: 1px solid #e2e8f0; overflow: hidden; display: flex; flex-direction: column; }
        .team-panel.open { width: 280px; }
        
        .member-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f8fafc; }
        .role-tag { font-size: 10px; padding: 2px 6px; background: #e0f2fe; color: #0284c7; border-radius: 4px; margin-right: auto; }
        
        /* Input Area */
        .input-area { background: #f0f2f5; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .type-box { flex: 1; background: white; padding: 10px; border-radius: 8px; border: none; outline: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="h-[60px] bg-[#f0f2f5] p-3 flex justify-between items-center border-b">
            <div class="flex items-center gap-2">
                <img src="https://media-mrs2-2.cdn.whatsapp.net/v/t61.24694-24/490584763_1521666505466352_3860845398977059833_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3QEGGv9ElRRb2Qx1Adjclex0ahijeyYdc8W8wmVuCZ6L2A&oe=695B04A6&_nc_sid=5e03e0&_nc_cat=104" class="w-8 h-8 rounded-full">
                <span class="font-bold text-gray-700">×¨×××™ (Admin)</span>
            </div>
            <div class="flex gap-2 text-gray-500">
                <button onclick="createNewGroup()" title="×§×‘×•×¦×” ×—×“×©×”"><i class="fas fa-users"></i></button>
                <button onclick="generateClientLink()" title="×—×™×‘×•×¨ ×œ×§×•×— ×œ××¤×œ×™×§×¦×™×”" class="text-green-600"><i class="fas fa-link"></i></button>
            </div>
        </div>
        
        <div class="search-box">
            <input type="text" placeholder="×—×™×¤×•×© ××• ×”×ª×—×œ×ª ×¦'××˜ ×—×“×©" class="w-full bg-white px-4 py-1.5 rounded-lg text-sm border-none outline-none">
        </div>

        <div id="chat-list" class="flex-1 overflow-y-auto">
            </div>
    </div>

    <div class="main-chat">
        <div class="chat-header">
            <div class="flex items-center gap-3 cursor-pointer" onclick="toggleTeamPanel()">
                <div id="active-avatar" class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center"><i class="fas fa-users text-white"></i></div>
                <div>
                    <div id="active-title" class="font-bold text-gray-800">×‘×—×¨ ×¦'××˜</div>
                    <div id="active-desc" class="text-xs text-gray-500">×œ×—×¥ ×œ×¤×¨×˜×™ ×”×§×‘×•×¦×”</div>
                </div>
            </div>
            <div class="flex gap-4 text-gray-500">
                <i class="fas fa-search cursor-pointer"></i>
                <i class="fas fa-paperclip cursor-pointer"></i>
                <i class="fas fa-ellipsis-v cursor-pointer"></i>
            </div>
        </div>

        <div id="messages-area" class="messages"></div>

        <div class="input-area">
            <i class="far fa-smile text-2xl text-gray-500 cursor-pointer"></i>
            <input type="text" id="msg-input" class="type-box" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="text-[#00a884] text-xl"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="team-panel" class="team-panel">
        <div class="h-[60px] bg-white border-b flex items-center px-4 font-bold text-gray-700 justify-between">
            <span>×—×‘×¨×™ ×”×§×‘×•×¦×”</span>
            <button onclick="toggleTeamPanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 bg-gray-50 border-b">
            <button onclick="addMemberToGroup()" class="w-full bg-white border border-dashed border-green-500 text-green-600 py-2 rounded font-bold text-xs hover:bg-green-50">
                <i class="fas fa-user-plus"></i> ×”×•×¡×£ ××™×© ×¦×•×•×ª
            </button>
        </div>
        <div id="group-members" class="flex-1 overflow-y-auto">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Config (Must be set up in your actual project)
        const app = initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" });
        const db = getFirestore(app);

        // --- 1. DATA SEEDING (××”×§×•×‘×¥ CSV ×©×œ×š) ---
        const CORE_TEAM = [
            { name: "×”×¨××œ ××™×“×œ×¡×•×Ÿ", role: "CEO", phone: "972505227724", avatar: "ğŸ‘¨â€ğŸ’¼" },
            { name: "×¨×××™ ××¡××¨×•×”", role: "Admin", phone: "972508860896", avatar: "ğŸ‘¨â€ğŸ’»" },
            { name: "×™×•××‘", role: "Admin", phone: "972507855865", avatar: "ğŸ› ï¸" },
            { name: "× ×ª× ××œ", role: "×¨×›×©", phone: "972548132442", avatar: "ğŸ›’" },
            { name: "×•×¨×“", role: "Back Office", phone: "972506662300", avatar: "ğŸ‘©â€ğŸ’¼" },
            { name: "××™×¦×™×§ ×–×”×‘×™", role: "×× ×”×œ ×¡× ×™×£", phone: "972504482285", avatar: "ğŸ¬" },
            { name: "××•×¨×Ÿ", role: "×× ×”×œ ×—×¦×¨", phone: "972509001392", avatar: "ğŸšœ" }
        ];

        // Groups Structure
        const GROUPS = [
            { id: "orders_main", name: "×”×–×× ×•×ª ×œ×§×•×—×•×ª ×‘×œ×‘×“", icon: "ğŸ—ï¸", members: CORE_TEAM }, // ×›×•×œ×
            { id: "dispatch", name: "×¡×™×“×•×¨ ×¢×‘×•×“×” ×•× ×”×’×™×", icon: "ğŸš›", members: CORE_TEAM.filter(m => ["Admin","CEO","×× ×”×œ ×—×¦×¨"].includes(m.role)) },
            { id: "announcements", name: "×”×•×“×¢×•×ª ×•× ×”×œ×™× (×”×¨××œ)", icon: "ğŸ“¢", members: CORE_TEAM }
        ];

        let activeGroupId = null;

        // --- 2. INITIALIZATION ---
        function renderGroups() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            
            GROUPS.forEach(g => {
                const activeClass = g.id === activeGroupId ? 'active' : '';
                list.innerHTML += `
                <div class="chat-item ${activeClass}" onclick="loadGroup('${g.id}')">
                    <div class="avatar group-avatar rounded-full">${g.icon}</div>
                    <div class="flex-1 mr-3">
                        <div class="flex justify-between">
                            <span class="font-bold text-gray-800 text-sm">${g.name}</span>
                            <span class="text-[10px] text-gray-400">09:41</span>
                        </div>
                        <div class="text-xs text-gray-500 truncate">×œ×—×¥ ×œ×›× ×™×¡×”...</div>
                    </div>
                </div>`;
            });
        }

        // --- 3. LOGIC ---
        window.loadGroup = (gid) => {
            activeGroupId = gid;
            const group = GROUPS.find(g => g.id === gid);
            
            // Update UI
            renderGroups(); // Refresh active state
            document.getElementById('active-title').innerText = group.name;
            document.getElementById('active-desc').innerText = group.members.map(m => m.name.split(' ')[0]).join(', ') + '...';
            document.getElementById('active-avatar').innerHTML = group.icon;
            
            // Load Members to Panel
            const memList = document.getElementById('group-members');
            memList.innerHTML = '';
            group.members.forEach(m => {
                memList.innerHTML += `
                <div class="member-item">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs">${m.avatar}</div>
                    <div class="mr-3 flex-1">
                        <div class="text-sm font-bold text-gray-700">${m.name}</div>
                        <div class="text-[10px] text-gray-400">${m.phone}</div>
                    </div>
                    <span class="role-tag">${m.role}</span>
                </div>`;
            });

            // Load Chat (Mock for now, would be Firebase snapshot)
            document.getElementById('messages-area').innerHTML = `
                <div class="text-center text-xs text-gray-400 my-4 bg-[#e0f2fe] p-1 rounded inline-block mx-auto shadow-sm">
                    ğŸ”’ ×”×”×•×“×¢×•×ª ×‘×§×‘×•×¦×” ×–×• ×××•×‘×˜×—×•×ª ×•××•×¦×¤× ×•×ª (Saban System)
                </div>
                ${gid === 'orders_main' ? generateMockOrders() : ''}
            `;
        };

        function generateMockOrders() {
            // ××“××” ××ª ×”×”×™×¡×˜×•×¨×™×” ××”-CSV
            return `
            <div class="msg msg-in">
                <div class="sender-name">× ×ª× ××œ ×—. ×¡×‘×Ÿ</div>
                <div>×”×–×× ×” ×œ×’'××™×œ ×”×¨×¦×œ×™×”, 100 ××˜×¨ ××–×•× ×™×ª. ×œ×™×•× ×©×œ×™×©×™.</div>
                <div class="msg-meta"><span>13:21</span></div>
            </div>
            <div class="msg msg-out">
                <div>×§×™×‘×œ×ª×™, ×‘×˜×™×¤×•×œ</div>
                <div class="msg-meta"><span>13:22</span><i class="fas fa-check-double text-blue-500"></i></div>
            </div>
            <div class="msg msg-in">
                <div class="sender-name">×”×–×× ×•×ª ×—. ×¡×‘×Ÿ (×‘×•×˜)</div>
                <div class="bg-white p-2 rounded border-l-4 border-green-500 bg-green-50">
                    <b>ğŸ“¦ ×”×–×× ×” ×—×“×©×” × ×§×œ×˜×”</b><br>
                    ×œ×§×•×—: ×˜×œ ××¨×‘×™×‘<br>
                    ×¤×¨×™×˜: ×‘××œ×•×ª ×—×•×œ<br>
                    <button class="mt-2 text-xs bg-green-600 text-white px-2 py-1 rounded">×¤×ª×— ×”×–×× ×”</button>
                </div>
                <div class="msg-meta"><span>14:00</span></div>
            </div>
            `;
        }

        window.sendMessage = () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;
            
            const area = document.getElementById('messages-area');
            area.innerHTML += `
            <div class="msg msg-out">
                <div>${text}</div>
                <div class="msg-meta"><span>×¢×›×©×™×•</span><i class="fas fa-clock text-gray-400"></i></div>
            </div>`;
            input.value = '';
            area.scrollTop = area.scrollHeight;
        };

        // --- 4. THE MAGIC LINK GENERATOR ---
        window.generateClientLink = () => {
            Swal.fire({
                title: 'ğŸ”— ×™×¦×™×¨×ª ×œ×™× ×§ ×œ×œ×§×•×—',
                html: `
                    <input id="clientName" class="swal2-input" placeholder="×©× ×”×œ×§×•×—">
                    <input id="clientPhone" class="swal2-input" placeholder="×˜×œ×¤×•×Ÿ">
                `,
                confirmButtonText: '×¦×•×¨ ×•×”×¢×ª×§ ×œ×™× ×§',
                preConfirm: () => {
                    const name = document.getElementById('clientName').value;
                    const phone = document.getElementById('clientPhone').value;
                    if (!name) Swal.showValidationMessage('×—×•×‘×” ×œ×”×–×™×Ÿ ×©×');
                    return { name, phone };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // ×”×œ×™× ×§ ×œ××¤×œ×™×§×¦×™×™×ª ×”×œ×§×•×— ×©×™×¦×¨× ×•
                    const link = `https://saban-system.onrender.com/client-smart.html?name=${encodeURIComponent(result.value.name)}&uid=${result.value.phone}`;
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(link);
                    
                    Swal.fire({
                        icon: 'success',
                        title: '×”×œ×™× ×§ ×”×•×¢×ª×§!',
                        text: '×©×œ×— ××•×ª×• ×¢×›×©×™×• ×œ×œ×§×•×— ×‘×•×•×¦××£',
                        footer: `<a href="https://wa.me/${result.value.phone}?text=${encodeURIComponent('×”×™×™ ' + result.value.name + ', ×”× ×” ×”×œ×™× ×§ ×œ××¢×¨×›×ª ×”×”×–×× ×•×ª ×”×—×“×©×” ×©×œ× ×•:\n' + link)}" target="_blank" style="color:green;font-weight:bold;">×œ×—×¥ ×›××Ÿ ×œ×©×œ×™×—×” ×‘×•×•×¦××£ ğŸ“²</a>`
                    });
                }
            });
        };

        window.toggleTeamPanel = () => {
            document.getElementById('team-panel').classList.toggle('open');
        };

        window.createNewGroup = () => {
            Swal.fire('×‘×§×¨×•×‘', '×¤×™×¦\'×¨ ×™×¦×™×¨×ª ×§×‘×•×¦×•×ª ×“×™× ×××™×•×ª ×‘×¤×™×ª×•×—', 'info');
        };

        // Init
        renderGroups();
        
        // Expose to window
        window.sendMessage = sendMessage;
        window.loadGroup = loadGroup;
        window.toggleTeamPanel = toggleTeamPanel;
        window.generateClientLink = generateClientLink;
        window.createNewGroup = createNewGroup;

    </script>
</body>
</html>
