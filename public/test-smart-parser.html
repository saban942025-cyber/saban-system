<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban AI Parser Lab ğŸ§ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap');
        body { font-family: 'Heebo', sans-serif; background: #1e1e24; color: white; height: 100vh; overflow: hidden; }

        /* ××–×•×¨ ×”×¢×‘×•×“×” */
        .workspace { display: flex; height: 100%; }
        .input-zone { width: 35%; padding: 20px; border-left: 1px solid #333; background: #25252b; z-index: 10; display: flex; flex-direction: column; }
        .visual-zone { flex: 1; padding: 40px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }

        /* ×¤×— ×”×–×‘×œ ×”××¨×—×£ */
        .trash-can-zone {
            position: absolute; bottom: 30px; left: 30px;
            width: 80px; height: 80px; border-radius: 50%;
            background: #2a2a2a; border: 2px dashed #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: #666; transition: 0.3s;
        }
        .trash-can-zone.active { transform: scale(1.2); border-color: red; color: red; background: #300000; }

        /* ×©×•×¨×•×ª ×”×¤×¢× ×•×— */
        .parsed-line {
            width: 100%; max-width: 600px;
            background: #2a2a30; border-radius: 12px;
            padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 15px;
            opacity: 0; transform: translateY(20px);
            border: 1px solid transparent;
            transition: 0.3s; position: relative; overflow: hidden;
        }
        /* ×× ×™××¦×™×™×ª ×›× ×™×¡×” */
        .slide-in { animation: slideIn 0.5s forwards; }
        @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }

        /* ×¡×˜×˜×•×¡×™× */
        .status-dot { width: 12px; height: 12px; rounded-full; flex-shrink: 0; }
        .match-green { background: #10b981; box-shadow: 0 0 10px #10b981; } /* ×‘×•×œ */
        .match-yellow { background: #f59e0b; box-shadow: 0 0 10px #f59e0b; } /* ×‘×¢×¨×š */
        .match-red { background: #ef4444; box-shadow: 0 0 10px #ef4444; animation: pulseRed 2s infinite; } /* ×œ× ×–×•×”×” */

        @keyframes pulseRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* ×× ×™××¦×™×™×ª ×–×¨×™×§×ª ×–×‘×œ (× ×™×™×¨ ×¢×£) */
        .flying-paper {
            position: absolute; width: 20px; height: 20px; background: white;
            border-radius: 4px; pointer-events: none; z-index: 100;
        }

        /* ×”××•×¦×¨ ×©× ××¦× */
        .product-preview {
            display: flex; gap: 10px; align-items: center; font-size: 14px;
        }
        .prod-img { width: 40px; height: 40px; border-radius: 6px; background: white; object-fit: cover; }

        /* ×›×¤×ª×•×¨ ×”×§×¡× */
        .magic-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            padding: 15px; border-radius: 15px; font-weight: bold; font-size: 18px;
            margin-top: 20px; cursor: pointer; transition: 0.2s; text-align: center;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        .magic-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div class="workspace">
        <div class="input-zone">
            <h2 class="text-xl font-black mb-4 flex items-center gap-2"><i class="fas fa-paste text-yellow-400"></i> ×”×“×‘×§×” ×—×›××”</h2>
            <p class="text-xs text-gray-400 mb-4">×”×“×‘×§ ×›××Ÿ ××ª ×”×¨×©×™××” ×”××‘×•×œ×’× ×ª ××”×•×•×¦××¤...</p>
            
            <textarea id="rawInput" class="w-full h-64 bg-[#1a1a1e] border border-[#333] rounded-xl p-4 text-white text-right outline-none focus:border-purple-500 resize-none" 
            placeholder="×“×•×’××”: ×™× ××‘×• ×©×—×¨ ×ª×‘×™× 10 ×©×§ ××œ×˜ ×“×—×•×£×£×£ ×•×’× ×“×‘×§ ×§×¨××™×§×” ×©×œ ×¡×™×§×”"></textarea>
            
            <div onclick="startTheShow()" class="magic-btn">
                <i class="fas fa-magic"></i> ×”×ª×—×œ ××ª ×”×§×¡×
            </div>

            <div id="logs" class="mt-6 text-xs text-gray-500 font-mono space-y-1 h-40 overflow-y-auto"></div>
        </div>

        <div class="visual-zone" id="stage">
            <div class="text-gray-500 font-bold text-2xl mb-10 opacity-30">×”××•×— ×©×œ ×¡×‘×Ÿ ××¢×‘×“ × ×ª×•× ×™×...</div>
            <div id="resultsArea" class="w-full flex flex-col items-center"></div>

            <div class="trash-can-zone" id="trashCan">
                <i class="fas fa-trash-alt"></i>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Setup
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const GEMINI_KEY = "AIzaSyD9plWwyTESFm24c_OTunf4mFAsAmfrgj0";

        // State
        let catalog = [];
        const logs = document.getElementById('logs');

        // 1. ×˜×¢×™× ×ª ×§×˜×œ×•×’ (×”××•×— ×”××§×•××™)
        async function loadCatalog() {
            log("×˜×•×¢×Ÿ ×§×˜×œ×•×’ ××•×¦×¨×™×...");
            try {
                const snap = await getDocs(collection(db, "products"));
                catalog = snap.docs.map(d => d.data());
                log(`âœ… ×§×˜×œ×•×’ × ×˜×¢×Ÿ: ${catalog.length} ××•×¦×¨×™× ×–××™× ×™×.`);
            } catch(e) { log("âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×§×˜×œ×•×’"); console.error(e); }
        }

        // 2. ×”×¤×•× ×§×¦×™×” ×”×¨××©×™×ª (×”×‘×××™)
        window.startTheShow = async () => {
            const rawText = document.getElementById('rawInput').value;
            if(!rawText) return alert("××™×Ÿ ×˜×§×¡×˜!");

            document.getElementById('resultsArea').innerHTML = ''; // × ×™×§×•×™ ×‘××”
            log("ğŸš€ ××ª×—×™×œ ×¤×¢× ×•×—...");

            // ×©×œ×‘ ×': ×’'××™× ×™ ×× ×§×” ××ª ×”×–×‘×œ ×•××—×œ×¥ ×¤×¨×™×˜×™×
            const cleanItems = await cleanTextWithAI(rawText);
            
            // ×©×œ×‘ ×‘': ×”×¦×’×” ×•×™×–×•××œ×™×ª ×©×•×¨×” ××—×¨ ×©×•×¨×”
            for (let i = 0; i < cleanItems.length; i++) {
                await processLineVisual(cleanItems[i], i);
            }

            log("ğŸ ×¡×™×™×× ×•. ×”×”×–×× ×” ××•×›× ×”.");
        };

        // 3. ×’'××™× ×™ (×”×× ×§×”)
        async function cleanTextWithAI(text) {
            log("ğŸ¤– ×’'××™× ×™ ×× ×ª×— ×˜×§×¡×˜...");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
            const prompt = `
            Analyze this construction order text (Hebrew/Arabic slang). 
            Input: "${text}"
            
            Tasks:
            1. Identify waste words (greetings, urgency, unrelated) -> Throw them away.
            2. Extract products.
            3. Return JSON array: [{"originalText": "the text segment", "cleanName": "product name", "qty": number, "isWaste": boolean}]
            `;

            try {
                const res = await fetch(url, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await res.json();
                let json = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(json);
            } catch(e) {
                log("âŒ ×©×’×™××” ×‘-AI");
                return [];
            }
        }

        // 4. ×”×× ×•×¢ ×”×•×•×™×–×•××œ×™ (×”×× ×™××˜×•×¨)
        async function processLineVisual(item, index) {
            return new Promise(resolve => {
                setTimeout(async () => {
                    
                    // ×× ×–×” ×–×‘×œ - ×–×¨×•×§ ×œ×¤×—
                    if(item.isWaste) {
                        throwTrash(item.originalText);
                        resolve();
                        return;
                    }

                    // ×× ×–×” ××•×¦×¨ - ×—×¤×© ×‘×§×˜×œ×•×’ ×•×”×¦×’
                    const match = findInCatalog(item.cleanName);
                    createProductRow(item, match);
                    resolve();

                }, index * 800); // ×“×™×œ×™×™ ×‘×™×Ÿ ×©×•×¨×•×ª (×”×§×œ×“×”)
            });
        }

        // 5. ×—×™×¤×•×© ×‘×§×˜×œ×•×’ (Fuzzy Match ×¤×©×•×˜)
        function findInCatalog(name) {
            // ×—×™×¤×•×© ×˜×™×¤×©: ×”×× ×”×©× × ××¦× ×‘×ª×•×š ×©× ×”××•×¦×¨
            const found = catalog.find(p => p.core.name.includes(name) || (p.core.brand && p.core.brand.includes(name)));
            return found;
        }

        // 6. ×™×¦×™×¨×ª ×©×•×¨×” ×•×™×–×•××œ×™×ª
        function createProductRow(item, match) {
            const stage = document.getElementById('resultsArea');
            const el = document.createElement('div');
            el.className = 'parsed-line slide-in';
            
            let statusClass = 'match-red';
            let content = '';

            if (match) {
                // ×–×™×”×•×™ ××•×©×œ× (××• ×§×¨×•×‘)
                statusClass = 'match-green';
                content = `
                    <div class="status-dot ${statusClass}"></div>
                    <img src="${match.rich?.image || 'https://via.placeholder.com/40'}" class="prod-img">
                    <div class="flex-1">
                        <div class="font-bold text-white text-sm">${match.core.name}</div>
                        <div class="text-xs text-gray-400">×–×•×”×”: ${item.cleanName} | ×›××•×ª: ${item.qty}</div>
                    </div>
                    <div class="text-green-400 font-bold text-xs"><i class="fas fa-check"></i> × × ×¢×œ</div>
                `;
            } else {
                // ×œ× ×–×•×”×”
                statusClass = 'match-red';
                content = `
                    <div class="status-dot ${statusClass}"></div>
                    <div class="w-10 h-10 bg-red-900 rounded-lg flex items-center justify-center text-red-500"><i class="fas fa-question"></i></div>
                    <div class="flex-1">
                        <div class="font-bold text-white text-sm">×œ× ×–×•×”×”: "${item.cleanName}"</div>
                        <div class="text-xs text-red-400 cursor-pointer hover:underline">×œ×—×¥ ×›××Ÿ ×œ×—×™×¤×•×© ×‘×§×˜×œ×•×’</div>
                    </div>
                `;
            }

            el.innerHTML = content;
            stage.appendChild(el);
            
            // ×¡××•× ×“ ×”×§×œ×“×” ×¢×“×™×Ÿ (××•×¤×¦×™×•× ×œ×™)
            // playTypeSound();
        }

        // 7. ×× ×™××¦×™×™×ª ×–×¨×™×§×ª ×–×‘×œ
        function throwTrash(text) {
            log(`ğŸ—‘ï¸ ×–×•×¨×§ ×œ×¤×—: "${text}"`);
            const trash = document.getElementById('trashCan');
            trash.classList.add('active');
            
            // ×™×¦×™×¨×ª ××œ×× ×˜ × ×™×™×¨ ××¢×•×¤×£ (×”×“××™×”)
            // ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×× ×™××¦×™×™×ª CSS ××•×¨×›×‘×ª ×©×œ ××¢×•×£
            
            setTimeout(() => trash.classList.remove('active'), 500);
        }

        // ×œ×•×’×™× ×œ××¡×š
        function log(msg) {
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        // ××ª×—×•×œ
        loadCatalog();

    </script>
</body>
</html>
