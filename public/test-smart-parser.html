<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Hyper-Parser ğŸš€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Heebo', sans-serif; background: #0f172a; color: white; height: 100vh; overflow: hidden; }

        /* --- ××–×•×¨×™ ×¢×‘×•×“×” --- */
        .workspace { display: flex; height: 100%; }
        
        .input-panel { 
            width: 30%; padding: 25px; background: #1e293b; 
            border-left: 1px solid #334155; display: flex; flex-direction: column; z-index: 20;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
        }
        
        .stage-panel { 
            flex: 1; padding: 40px; position: relative; overflow-y: auto; 
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- ×¨×›×™×‘×™× ×•×™×–×•××œ×™×™× --- */
        .parsed-card {
            width: 100%; max-width: 700px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; padding: 15px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 15px;
            opacity: 0; transform: translateY(30px);
            transition: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .parsed-card.show { opacity: 1; transform: translateY(0); }

        /* ×¡×•×’×™ ×›×¨×˜×™×¡×™× */
        .card-product { border-right: 4px solid #10b981; }
        .card-external { border-right: 4px solid #f59e0b; }
        .card-address { border-right: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }

        /* ×ª××•× ×•×ª ×•××™×§×•× ×™× */
        .item-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #333; border: 1px solid #555; }
        .icon-box { width: 50px; height: 50px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* ×¤×— ×–×‘×œ */
        .trash-zone {
            position: fixed; bottom: 40px; left: 40px;
            width: 70px; height: 70px; border-radius: 50%;
            border: 2px dashed #64748b; color: #64748b;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s; z-index: 50;
        }
        .trash-zone.active { transform: scale(1.2) rotate(-15deg); border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .flying-trash { position: fixed; pointer-events: none; z-index: 100; transition: all 0.6s ease-in; color: #94a3b8; font-size: 14px; white-space: nowrap; }

        /* ×›×¤×ª×•×¨ ×”×¤×¢×œ×” */
        .run-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 16px; border-radius: 14px; font-weight: 900; letter-spacing: 1px;
            text-align: center; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            margin-top: 20px;
        }
        .run-btn:active { transform: scale(0.98); }

        /* ×©×“×” ×˜×§×¡×˜ */
        textarea { 
            background: #0f172a; border: 1px solid #334155; color: #cbd5e1;
            font-family: monospace; line-height: 1.6;
        }
        textarea:focus { border-color: #8b5cf6; outline: none; }
    </style>
</head>
<body>

    <div class="workspace">
        <div class="input-panel">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg text-xl">ğŸ§ </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Saban Parser</h1>
                    <div class="text-xs text-purple-400 font-bold">×× ×•×¢ ×¤×¢× ×•×— ×”×™×‘×¨×™×“×™ v2.0</div>
                </div>
            </div>

            <label class="text-xs text-slate-400 mb-2 font-bold">×”×“×‘×§ ×”×–×× ×” (×˜×§×¡×˜ ×—×•×¤×©×™):</label>
            <textarea id="rawInput" class="w-full h-64 rounded-xl p-4 resize-none" placeholder="×“×•×’××”:
×‘×•×§×¨ ×˜×•×‘
×ª×©×œ×— ×œ×¨×—×•×‘ ×”××œ×•× ×™× 15 ×‘×”×¨×¦×œ×™×”
10 ×©×§ ××œ×˜
3 ×‘×œ×” ×¡×•××¡×•×
×•×“×‘×§ ×§×¨××™×§×” ×©×œ ×¡×™×§×” ×“×—×•×£"></textarea>

            <div onclick="processOrder()" class="run-btn">
                <i class="fas fa-bolt"></i> ×¤×¢× ×— ×”×–×× ×”
            </div>

            <div id="logs" class="mt-auto h-32 overflow-y-auto text-[10px] font-mono text-slate-500 border-t border-slate-700 pt-2 space-y-1"></div>
        </div>

        <div class="stage-panel" id="stage">
            <div id="emptyState" class="text-center opacity-30 mt-20">
                <i class="fas fa-layer-group text-6xl mb-4"></i>
                <h2 class="text-2xl font-bold">×××ª×™×Ÿ ×œ× ×ª×•× ×™×...</h2>
            </div>
            
            <div id="resultsArea" class="w-full flex flex-col items-center pb-20"></div>

            <div class="trash-zone" id="trashCan">
                <i class="fas fa-trash"></i>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Catalog Cache
        let localCatalog = [];
        const logs = document.getElementById('logs');

        // 1. ×˜×¢×™× ×ª ×§×˜×œ×•×’ (Engine A)
        async function loadCatalog() {
            log("ğŸ“š ×˜×•×¢×Ÿ ×§×˜×œ×•×’ ××§×•××™...");
            try {
                const snap = await getDocs(collection(db, "products"));
                localCatalog = snap.docs.map(d => d.data());
                log(`âœ… ×§×˜×œ×•×’ × ×˜×¢×Ÿ: ${localCatalog.length} ×¤×¨×™×˜×™×.`);
            } catch(e) { 
                log("âš ï¸ ×¢×•×‘×“ ×¢×œ ×§×˜×œ×•×’ ×’×™×‘×•×™ (Offline Mode).");
                localCatalog = [
                    {core: {name: "××œ×˜ ×©×—×•×¨", price: 25}, rich: {image: "https://via.placeholder.com/50/gray"}},
                    {core: {name: "×“×‘×§ ×§×¨××™×§×” ×¡×™×§×” 255", price: 45}, rich: {image: "https://via.placeholder.com/50/blue"}},
                    {core: {name: "×¨×•×‘×” ×˜××‘×•×¨", price: 30}, rich: {image: "https://via.placeholder.com/50/red"}}
                ];
            }
        }

        // 2. ×”×¤×•× ×§×¦×™×” ×”×¨××©×™×ª (The Router)
        window.processOrder = async () => {
            const text = document.getElementById('rawInput').value;
            if(!text) return alert("××™×Ÿ ×˜×§×¡×˜");

            document.getElementById('resultsArea').innerHTML = '';
            document.getElementById('emptyState').style.display = 'none';
            log("ğŸš€ ××ª×—×™×œ × ×™×ª×•×— ×”×™×‘×¨×™×“×™...");

            const lines = text.split('\n');
            
            // ××¢×‘×¨ ×¢×œ ×›×œ ×©×•×¨×” ×‘× ×¤×¨×“ (Load Balancing)
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if(line.length < 2) continue;
                
                await analyzeLine(line, i);
            }
            log("âœ… ×¤×¢× ×•×— ×”×¡×ª×™×™×.");
        };

        // 3. ×× ×•×¢ ×”× ×™×ª×•×— (The Brain)
        async function analyzeLine(line, index) {
            return new Promise(resolve => {
                setTimeout(() => {
                    
                    // ×‘×“×™×§×” 1: ×”×× ×–×” ×–×‘×œ? (××™×œ×™× ×©×—×•×¨×•×ª)
                    if(isGarbage(line)) {
                        throwTrash(line);
                        resolve(); return;
                    }

                    // ×‘×“×™×§×” 2: ×”×× ×–×• ×›×ª×•×‘×ª? (Waze Engine)
                    if(isAddress(line)) {
                        renderAddressCard(line);
                        resolve(); return;
                    }

                    // ×‘×“×™×§×” 3: ×”×× ×–×” ××•×¦×¨ ××§×•××™? (Local Engine)
                    const localProduct = findLocalProduct(line);
                    if(localProduct) {
                        const qty = extractQty(line);
                        renderProductCard(localProduct, qty, line, 'local');
                        resolve(); return;
                    }

                    // ×‘×“×™×§×” 4: ××•×¦×¨ ×—×™×¦×•× ×™ / ×œ× ××–×•×”×” (External Engine)
                    // ×›××Ÿ ×”×™×™× ×• ×©×•×œ×—×™× ×œ×’'××™× ×™, ×›×¨×’×¢ × ×¡××œ×¥ ×–×™×”×•×™ "×‘×œ×”"
                    if(line.includes("×‘×œ×”") || line.includes("×¡×•××¡×•×") || line.includes("×—×•×œ")) {
                        const qty = extractQty(line);
                        renderExternalProduct(line, qty);
                    } else {
                        // ×× ×‘×××ª ×œ× ×–×•×”×” ×›×œ×•× -> ××¦×‘ ×¢×¨×™×›×”
                        renderUnknown(line);
                    }

                    resolve();

                }, index * 600); // ×“×™×œ×™×™ ×œ××¤×§×˜
            });
        }

        // --- Logic Functions ---

        function isGarbage(text) {
            const t = text.toLowerCase();
            return t.includes("×‘×•×§×¨") || t.includes("×ª×•×“×”") || t.includes("×“×—×•×£") || t.includes("×™×") || t.includes("××—×™");
        }

        function isAddress(text) {
            const t = text.toLowerCase();
            return t.includes("×¨×—×•×‘") || t.includes("×¢×™×¨") || t.includes("×œ×™×“") || t.includes("×œ×›×‘×•×“") || t.includes("×”×¨×¦×œ×™×”") || t.includes("×ª×œ ××‘×™×‘");
        }

        function findLocalProduct(text) {
            return localCatalog.find(p => text.includes(p.core.name) || (p.core.brand && text.includes(p.core.brand)));
        }

        function extractQty(text) {
            const match = text.match(/\d+/);
            return match ? parseInt(match[0]) : 1;
        }

        // --- Render Functions (The Show) ---

        function renderProductCard(product, qty, originalText, type) {
            const div = document.createElement('div');
            div.className = 'parsed-card card-product';
            div.innerHTML = `
                <img src="${product.rich?.image}" class="item-img">
                <div class="flex-1">
                    <div class="font-bold text-lg">${product.core.name}</div>
                    <div class="text-xs text-slate-400">×–×•×”×” ××ª×•×š: "${originalText}"</div>
                </div>
                <div class="text-center px-4 border-r border-slate-700">
                    <div class="text-[10px] text-slate-500">×›××•×ª</div>
                    <div class="text-xl font-bold text-green-400">${qty}</div>
                </div>
                <div class="text-green-500 text-xl"><i class="fas fa-check-circle"></i></div>
            `;
            appendToStage(div);
        }

        function renderAddressCard(text) {
            // ×¡×™××•×œ×¦×™×™×ª ×—×™×©×•×‘ ××¨×—×§
            const distance = Math.floor(Math.random() * 30) + 10; 
            const div = document.createElement('div');
            div.className = 'parsed-card card-address';
            div.innerHTML = `
                <div class="icon-box bg-blue-900/30 text-blue-400"><i class="fas fa-map-marker-alt"></i></div>
                <div class="flex-1">
                    <div class="font-bold text-lg text-blue-100">×™×¢×“: ${text}</div>
                    <a href="https://waze.com/ul?q=${encodeURIComponent(text)}" target="_blank" class="text-xs text-blue-400 hover:underline">
                        <i class="fab fa-waze"></i> ×œ×—×¥ ×œ× ×™×•×•×˜
                    </a>
                </div>
                <div class="text-right">
                    <div class="text-xl font-bold text-blue-300">ğŸšš ${distance} ×§"×</div>
                    <div class="text-[10px] text-slate-400">××”××—×¡×Ÿ ×‘×˜×™×™×‘×”</div>
                </div>
            `;
            appendToStage(div);
        }

        function renderExternalProduct(text, qty) {
            const div = document.createElement('div');
            div.className = 'parsed-card card-external';
            div.innerHTML = `
                <div class="icon-box bg-yellow-900/30 text-yellow-500"><i class="fas fa-globe"></i></div>
                <div class="flex-1">
                    <div class="font-bold text-lg text-yellow-100">${text}</div>
                    <div class="text-xs text-yellow-500/70">××•×¦×¨ ×¨×›×© ×—×™×¦×•× ×™ (Google Search)</div>
                </div>
                <div class="text-center px-4 border-r border-slate-700">
                    <div class="text-[10px] text-slate-500">×›××•×ª</div>
                    <div class="text-xl font-bold text-yellow-400">${qty}</div>
                </div>
            `;
            appendToStage(div);
        }

        function renderUnknown(text) {
            const div = document.createElement('div');
            div.className = 'parsed-card border-red-500/30';
            div.innerHTML = `
                <div class="icon-box bg-red-900/20 text-red-500"><i class="fas fa-question"></i></div>
                <div class="flex-1">
                    <div class="font-bold text-lg text-red-200">${text}</div>
                    <div class="text-xs text-red-400">×œ× ×–×•×”×” ×‘×•×•×“××•×ª - ×“×¨×•×© ××™×©×•×¨ ×™×“× ×™</div>
                </div>
                <button class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-xs font-bold">×¢×¨×•×š</button>
            `;
            appendToStage(div);
        }

        function appendToStage(el) {
            const stage = document.getElementById('resultsArea');
            stage.appendChild(el);
            // Trigger Animation
            requestAnimationFrame(() => el.classList.add('show'));
            // Play sound (optional)
        }

        function throwTrash(text) {
            const trash = document.getElementById('trashCan');
            const fly = document.createElement('div');
            fly.className = 'flying-trash';
            fly.innerText = text;
            fly.style.left = '30%';
            fly.style.top = '20%';
            document.body.appendChild(fly);

            const rect = trash.getBoundingClientRect();

            setTimeout(() => {
                fly.style.left = (rect.left + 35) + 'px';
                fly.style.top = (rect.top + 35) + 'px';
                fly.style.transform = 'scale(0.1) rotate(90deg)';
                fly.style.opacity = 0;
                trash.classList.add('active');
            }, 50);

            setTimeout(() => {
                fly.remove();
                trash.classList.remove('active');
            }, 600);
            
            log(`ğŸ—‘ï¸ × ×•×§×”: ${text}`);
        }

        function log(msg) {
            const d = document.createElement('div');
            d.innerHTML = `> ${msg}`;
            logs.appendChild(d);
            logs.scrollTop = logs.scrollHeight;
        }

        // Init
        loadCatalog();

    </script>
</body>
</html>
