<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול משתמשים | Saban Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-slate-100 font-sans p-6">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-black text-slate-800 mb-6 flex items-center gap-3">
            <i class="fas fa-users-cog text-blue-600"></i> ניהול משתמשים וגישות
        </h1>

        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="font-bold text-lg mb-4">הוסף משתמש חדש</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input id="uName" type="text" placeholder="שם מלא" class="border p-3 rounded-xl bg-slate-50 outline-none focus:border-blue-500">
                <input id="uPhone" type="tel" placeholder="מספר טלפון (מזהה)" class="border p-3 rounded-xl bg-slate-50 outline-none focus:border-blue-500 text-left" dir="ltr">
                <select id="uRole" class="border p-3 rounded-xl bg-slate-50 outline-none">
                    <option value="client">לקוח</option>
                    <option value="staff">איש צוות</option>
                    <option value="admin">מנהל על</option>
                </select>
                <input id="uImg" type="text" placeholder="לינק לתמונה (אופציונלי)" class="border p-3 rounded-xl bg-slate-50 outline-none text-left" dir="ltr">
            </div>
            <button onclick="addUser()" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 shadow-lg transition">
                <i class="fas fa-plus"></i> צור משתמש במערכת
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <table class="w-full text-sm text-right">
                <thead class="bg-slate-50 text-slate-500 font-bold uppercase">
                    <tr>
                        <th class="p-4">משתמש</th>
                        <th class="p-4">טלפון (כניסה)</th>
                        <th class="p-4">תפקיד</th>
                        <th class="p-4">פעולות</th>
                    </tr>
                </thead>
                <tbody id="usersList" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, setDoc, doc, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // הוספת משתמש
        window.addUser = async () => {
            const name = document.getElementById('uName').value;
            const phone = document.getElementById('uPhone').value;
            const role = document.getElementById('uRole').value;
            const img = document.getElementById('uImg').value || `https://ui-avatars.com/api/?name=${name}&background=random`;

            if(!name || !phone) return Swal.fire('שגיאה', 'חובה למלא שם וטלפון', 'error');

            try {
                // המזהה הוא הטלפון - כדי למנוע כפילויות
                await setDoc(doc(db, "users", phone), {
                    name, phone, role, avatar: img, createdAt: serverTimestamp()
                });
                Swal.fire('בוצע!', 'המשתמש נוצר בהצלחה', 'success');
                document.getElementById('uName').value = '';
                document.getElementById('uPhone').value = '';
            } catch(e) {
                console.error(e);
                Swal.fire('שגיאה', 'לא ניתן לשמור נתונים', 'error');
            }
        };

        // מחיקה
        window.delUser = async (phone) => {
            if(confirm('למחוק את המשתמש?')) await deleteDoc(doc(db, "users", phone));
        };

        // טעינה בזמן אמת
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('usersList');
            list.innerHTML = '';
            snap.forEach(d => {
                const u = d.data();
                const badgeColor = u.role === 'client' ? 'bg-green-100 text-green-700' : 'bg-purple-100 text-purple-700';
                list.innerHTML += `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4 flex items-center gap-3">
                        <img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover">
                        <span class="font-bold text-slate-700">${u.name}</span>
                    </td>
                    <td class="p-4 font-mono text-slate-500">${u.phone}</td>
                    <td class="p-4"><span class="px-3 py-1 rounded-full text-xs font-bold ${badgeColor}">${u.role === 'client' ? 'לקוח' : 'צוות'}</span></td>
                    <td class="p-4">
                        <button onclick="delUser('${u.phone}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        });
    </script>
</body>
</html>
