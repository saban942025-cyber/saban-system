<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SabanOS Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background: #000; }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* Splash Screen */
        #splash { position: fixed; inset: 0; background: #0f172a; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .logo-bounce { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body>

    <div id="splash">
        <div class="w-24 h-24 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-3xl flex items-center justify-center shadow-2xl logo-bounce mb-6">
            <i class="fas fa-cubes text-white text-5xl"></i>
        </div>
        <h1 class="text-2xl font-black text-white tracking-widest">SabanOS</h1>
        <p class="text-blue-400 text-sm mt-2 font-mono">Loading Profile...</p>
    </div>

    <iframe id="appFrame"></iframe>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // לוגיקת הנתב (Router Logic)
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const uid = params.get('uid');
            
            // בדיקת משתמש
            let targetUrl = "index.html"; // ברירת מחדל: מסך התחברות
            
            if (uid) {
                try {
                    const snap = await getDoc(doc(db, "users", uid));
                    if (snap.exists()) {
                        const user = snap.data();
                        
                        // שמירת נתונים לשימוש האפליקציות הפנימיות
                        localStorage.setItem('saban_user', JSON.stringify({ uid, ...user }));

                        // ניתוב לפי תפקיד
                        if (['admin', 'ops'].includes(user.role)) {
                            targetUrl = "whatsapp-center2.html"; // חמ"ל משודרג
                        } else if (user.role === 'client') {
                            targetUrl = "client-app.html"; // אפליקציית לקוח
                        } else if (user.role === 'driver') {
                            targetUrl = "driver.html"; // מסופון נהג
                        } else {
                            targetUrl = "whatsapp-center2.html"; // ברירת מחדל לצוות
                        }
                    }
                } catch(e) { console.error("Login Error", e); }
            }

            // טעינת האפליקציה והעלמת מסך הפתיחה
            const frame = document.getElementById('appFrame');
            frame.src = targetUrl;
            
            frame.onload = () => {
                setTimeout(() => {
                    document.getElementById('splash').style.opacity = '0';
                    setTimeout(() => document.getElementById('splash').remove(), 500);
                }, 800);
            };
        }

        init();
    </script>
</body>
</html>
