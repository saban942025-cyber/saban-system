<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Saban Brain |  住专 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #f3f4f6; font-family: -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* Driver Status Card */
        .driver-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-right: 4px solid transparent; }
        .driver-card.online { border-right-color: #10b981; } /* Green */
        .driver-card.busy { border-right-color: #f59e0b; }   /* Orange */
        .driver-card.offline { border-right-color: #9ca3af; opacity: 0.7; }

        /* Prediction Badge */
        .prediction-box { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        /* Order Row */
        .order-row { background: white; margin: 10px 20px; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .time-input { background: #f9fafb; border: 1px solid #d1d5db; padding: 5px; border-radius: 6px; font-weight: bold; width: 130px; text-align: center; }
    </style>
</head>
<body>

    <div class="bg-white p-4 border-b flex justify-between items-center shadow-sm">
        <div>
            <h1 class="text-xl font-black text-slate-800">住专 注 <span class="text-blue-600"></span></h1>
            <p class="text-xs text-gray-500">爪爪 注转  </p>
        </div>
        <div class="flex gap-4 text-sm font-bold">
            <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-green-500"></div> 专</div>
            <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-gray-400"></div> 转拽</div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-1/3 bg-gray-50 border-l p-4 overflow-y-auto">
            <h2 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">住住 爪 专 ( 转)</h2>
            <div id="drivers-container">
                </div>
        </div>

        <div class="flex-1 overflow-y-auto bg-gray-100 p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">拽砖转 转 (转转 砖专 专)</h2>
            <div id="orders-container">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // 1. 转  (住爪 专 -DB )
        const driversData = {
            'hichmat': { name: '转', type: '祝', status: 'busy', location: '专爪', destination: '转 6', lastLogin: new Date() },
            'ali': { name: '注', type: '驻', status: 'online', location: ' 砖专', destination: null, lastLogin: new Date() }
        };

        // 2. 驻拽爪转 "" - 砖 爪驻 专
        function calculateReturnTime(driver) {
            if(driver.status !== 'busy') return "驻 专注";
            
            // 住爪: 住注 专爪  砖专 + 驻专拽
            // 注专转 转转: OSRM API + 住专转 驻专拽 拽 住驻爪驻
            const travelTime = 25; // 拽转
            const unloadTime = 40; // 拽转 (爪注 住专)
            
            const now = new Date();
            now.setMinutes(now.getMinutes() + travelTime + unloadTime);
            
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            
            return `爪驻 专: ${hours}:${minutes}`;
        }

        // 3. 专专   转
        function renderDrivers() {
            const container = document.getElementById('drivers-container');
            container.innerHTML = "";

            Object.keys(driversData).forEach(id => {
                const d = driversData[id];
                const eta = calculateReturnTime(d);
                const statusClass = d.status; // online, busy, offline
                const lastSeen = d.lastLogin.toLocaleTimeString().slice(0,5);

                container.innerHTML += `
                <div class="driver-card ${statusClass}">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-lg">${d.name}</span>
                            <span class="text-xs bg-gray-200 px-2 rounded">${d.type}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-map-marker-alt"></i> ${d.location} 
                            ${d.destination ? `<i class="fas fa-arrow-left mx-1"></i> ${d.destination}` : ''}
                        </div>
                        <div class="text-[10px] text-gray-400 mt-1">专 专: ${lastSeen}</div>
                    </div>
                    ${d.status === 'busy' ? 
                        `<div class="prediction-box"><i class="fas fa-clock"></i> ${eta}</div>` : 
                        `<div class="text-green-600 text-xs font-bold">驻</div>`}
                </div>`;
            });
        }

        // 4. 专专 转  
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => {
            const container = document.getElementById('orders-container');
            container.innerHTML = "";

            snap.forEach(docSnap => {
                const o = docSnap.data();
                if(o.status === 'done') return; //  爪 专

                // 砖 爪 ( 砖 专)
                const requestedTime = o.supplyTime || "08:00";
                let warningHtml = "";
                
                // 拽 :  拽 拽砖 08:00  转 专 -11:30
                //    砖 拽驻拽
                if(requestedTime < "09:00" && o.itemsText.includes("祝")) {
                    warningHtml = `
                    <div class="mt-2 bg-red-50 text-red-700 p-2 rounded text-xs flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <b>拽驻拽:</b> 转 (祝) 转驻 专拽 -09:30. 抓 转.
                    </div>`;
                }

                container.innerHTML += `
                <div class="order-row">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-lg">${o.clientName}</span>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">#${o.orderNum}</span>
                        </div>
                        <div class="text-sm text-gray-600 w-3/4 truncate">${o.itemsText}</div>
                        ${warningHtml}
                    </div>

                    <div class="flex flex-col items-end gap-3 border-r pr-6 border-gray-200">
                        <label class="text-xs font-bold text-gray-400">注 住驻拽 拽砖</label>
                        <div class="flex items-center gap-2">
                            <input type="time" id="time-${docSnap.id}" class="time-input" value="${requestedTime}">
                            <span class="text-gray-400">-</span>
                            <input type="time" id="time-end-${docSnap.id}" class="time-input" value="${addHours(requestedTime, 2)}">
                        </div>
                        
                        <div class="flex gap-2 w-full mt-2">
                            <button onclick="updateSchedule('${docSnap.id}', '${o.clientName}', true)" class="flex-1 bg-green-600 text-white text-xs py-2 rounded hover:bg-green-700 transition">
                                <i class="fab fa-whatsapp"></i> 砖专 砖转祝
                            </button>
                            <button onclick="updateSchedule('${docSnap.id}', '${o.clientName}', false)" class="px-3 bg-gray-200 text-gray-700 text-xs py-2 rounded hover:bg-gray-300">
                                <i class="fas fa-save"></i> 专拽 砖专
                            </button>
                        </div>
                    </div>
                </div>`;
            });
        });

        // 5. 注   砖转 注
        window.updateSchedule = async (id, clientName, shareWhatsapp) => {
            const start = document.getElementById(`time-${id}`).value;
            const end = document.getElementById(`time-end-${id}`).value;

            // 注 -DB
            await updateDoc(doc(db, "orders", id), {
                supplyTime: start,
                supplyTimeEnd: end,
                status: 'scheduled', // 住住 砖: 砖抓 
                adminApproved: true
            });

            const msg = ` ${clientName},  砖 砖专! \n 住驻拽 注: ${start} - ${end}.\n爪转 住 住拽.`;

            if(shareWhatsapp) {
                // 驻转转 住驻 注 注 
                const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            } else {
                Swal.fire('注!', '  注 注专转', 'success');
            }
        };

        // 注专
        function addHours(time, h) {
            if(!time) return "10:00";
            let [hours, mins] = time.split(':');
            hours = (parseInt(hours) + h).toString().padStart(2, '0');
            return `${hours}:${mins}`;
        }

        // 驻注 专砖转
        renderDrivers();
        // 住爪 注  转  拽
        setInterval(renderDrivers, 60000);

    </script>
</body>
</html>
