<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×¡×™×“×•×¨ ×—.×¡×‘×Ÿ | WhatsApp Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* WhatsApp Theme Variables */
        :root {
            --wa-header: #f0f2f5;
            --wa-bg: #efeae2; /* ×¨×§×¢ ×”×¦'××˜ ×”×§×œ××¡×™ */
            --wa-sidebar: #ffffff;
            --wa-green: #008069;
            --wa-light-green: #d9fdd3;
            --wa-border: #e9edef;
        }

        body { background: #d1d7db; height: 100vh; margin: 0; font-family: -apple-system, Helvetica, Arial, sans-serif; display: flex; overflow: hidden; }

        /* --- Sidebar (×¨×©×™××ª ×”×–×× ×•×ª) --- */
        .sidebar { width: 30%; min-width: 380px; background: var(--wa-sidebar); border-left: 1px solid var(--wa-border); display: flex; flex-direction: column; height: 100%; }
        
        /* Header Sidebar */
        .sb-header { height: 60px; background: var(--wa-header); padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--wa-border); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #dfe5e7; }
        
        /* Stories Bar (×‘×ª×•×š ×”×¡×¨×’×œ) */
        .stories-wrapper { padding: 12px; background: white; border-bottom: 1px solid var(--wa-border); overflow-x: auto; white-space: nowrap; display: flex; gap: 12px; }
        .story-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: 60px; }
        .story-ring { width: 56px; height: 56px; border-radius: 50%; padding: 2px; background: white; position: relative; }
        .story-ring img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid white; }
        
        /* Story Colors (×›××• ×‘××™× ×¡×˜×’×¨×/×•×•××˜×¡××¤) */
        .ring-new { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        .ring-wait { background: linear-gradient(45deg, #3b82f6, #06b6d4); }
        
        /* Search */
        .search-box { padding: 8px 12px; border-bottom: 1px solid var(--wa-border); background: white; }
        .search-input { width: 100%; background: #f0f2f5; border: none; padding: 8px 32px 8px 12px; border-radius: 8px; font-size: 14px; outline: none; }

        /* Order List */
        .orders-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; height: 72px; padding: 0 15px; background: white; cursor: pointer; align-items: center; border-bottom: 1px solid #f0f2f5; transition: 0.2s; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; }
        
        .chat-info { flex: 1; margin-right: 15px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .chat-top { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .chat-name { font-size: 16px; color: #111b21; font-weight: 500; }
        .chat-time { font-size: 12px; color: #667781; }
        .chat-bottom { display: flex; justify-content: space-between; font-size: 13px; color: #667781; }
        
        /* Timers Chips */
        .timer-badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; min-width: 50px; text-align: center; }
        .bg-ok { background: #25d366; }
        .bg-warn { background: #f59e0b; }
        .bg-danger { background: #ef4444; animation: flash 1s infinite; }

        /* --- Main Area (×”×¦'××˜) --- */
        .main-area { flex: 1; background: var(--wa-bg); display: flex; flex-direction: column; position: relative; }
        .main-area::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.4; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); pointer-events: none; }
        
        .chat-header { height: 60px; background: var(--wa-header); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; border-left: 1px solid var(--wa-border); z-index: 10; }
        
        .msg-container { flex: 1; padding: 20px 40px; overflow-y: auto; z-index: 5; display: flex; flex-direction: column; gap: 10px; }
        
        .bubble { background: white; border-radius: 7.5px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); padding: 6px 7px 8px 9px; max-width: 65%; position: relative; font-size: 14.2px; line-height: 19px; color: #111b21; align-self: flex-start; }
        .bubble.admin { background: var(--wa-light-green); align-self: flex-end; }
        
        .bubble-meta { display: flex; justify-content: flex-end; font-size: 11px; color: #667781; margin-top: 4px; gap: 4px; }

        /* Action Buttons inside Bubble */
        .action-btn { display: inline-block; margin-top: 8px; padding: 8px 16px; background: var(--wa-header); border: 1px solid #d1d7db; border-radius: 20px; color: #008069; font-weight: bold; cursor: pointer; text-decoration: none; width: 100%; text-align: center; }
        .action-btn:hover { background: #e9edef; }

        /* Admin Tools Menu */
        .tools-menu { position: absolute; top: 60px; right: 10px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; display: none; z-index: 50; width: 200px; }
        .tools-menu.open { display: block; }
        .menu-item { padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #3b4a54; border-radius: 4px; }
        .menu-item:hover { background: #f0f2f5; }

        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sb-header">
            <div class="flex items-center gap-3">
                <div class="user-avatar flex items-center justify-center text-gray-500"><i class="fas fa-user"></i></div>
                <span class="font-bold text-gray-700">×¡×™×“×•×¨ ×—.×¡×‘×Ÿ</span>
            </div>
            <div class="flex gap-4 text-gray-500 text-lg">
                <button onclick="toggleTools()" title="×ª×¤×¨×™×˜ × ×™×”×•×œ"><i class="fas fa-ellipsis-v"></i></button>
            </div>
            
            <div id="tools-menu" class="tools-menu">
                <div class="menu-item" onclick="openUserGenerator()">
                    <i class="fas fa-user-plus text-[#008069]"></i>
                    <span>×¦×•×¨ ×œ×™× ×§ ×œ×œ×§×•×—</span>
                </div>
                <div class="menu-item" onclick="manualSync()">
                    <i class="fas fa-sync text-blue-500"></i>
                    <span>×¡× ×›×¨×•×Ÿ ×™×–×•×</span>
                </div>
            </div>
        </div>

        <div class="search-box">
            <input type="text" class="search-input" placeholder="×—×™×¤×•×© ××• ×”×ª×—×œ×ª ×¦'××˜ ×—×“×©">
        </div>

        <div class="stories-wrapper" id="stories-bar"></div>

        <div class="orders-list" id="orders-list"></div>
    </div>

    <div class="main-area">
        <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center bg-[#f0f2f5] z-20 border-b-[6px] border-[#25d366]">
            <i class="fas fa-laptop-house text-4xl text-gray-400 mb-4"></i>
            <h1 class="text-3xl font-light text-[#41525d] mb-2">×¡×™×“×•×¨ ×—.×¡×‘×Ÿ ×œ×•×‘</h1>
            <p class="text-[#667781]">×©×œ×— ×•×§×‘×œ ×”×–×× ×•×ª ××‘×œ×™ ×œ×—×‘×¨ ××ª ×”×˜×œ×¤×•×Ÿ.</p>
        </div>

        <div id="chat-view" class="flex flex-col h-full hidden">
            <header class="chat-header">
                <div class="flex items-center gap-3 cursor-pointer">
                    <img id="chat-avatar" class="w-10 h-10 rounded-full">
                    <div>
                        <div id="chat-title" class="font-bold text-[#111b21]">...</div>
                        <div id="chat-status" class="text-xs text-[#667781]">××—×•×‘×¨</div>
                    </div>
                </div>
                <div id="big-timer" class="font-mono text-xl font-bold text-gray-600 bg-white px-3 py-1 rounded shadow-sm">
                    00:00
                </div>
            </header>

            <div class="msg-container" id="messages-area">
                </div>
            
            <div class="h-[62px] bg-[#f0f2f5] flex items-center px-4 gap-4 border-t border-[#d1d7db] z-10">
                <i class="far fa-smile text-2xl text-[#54656f]"></i>
                <i class="fas fa-paperclip text-2xl text-[#54656f]"></i>
                <div class="flex-1 bg-white h-[42px] rounded-lg flex items-center px-4 text-[#54656f] text-sm">
                    ×”×§×œ×“ ×”×•×“×¢×”...
                </div>
                <i class="fas fa-microphone text-2xl text-[#54656f]"></i>
            </div>
        </div>
    </div>

    <audio id="sound-msg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a"></audio>
    <audio id="sound-alert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let ordersData = {};
        let currentChatId = null;

        // --- Data Listener ---
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => {
            const list = document.getElementById('orders-list');
            const stories = document.getElementById('stories-bar');
            
            list.innerHTML = "";
            stories.innerHTML = "";
            ordersData = {};

            snap.forEach(d => {
                const o = d.data();
                o.id = d.id;
                ordersData[o.id] = o;
                
                // Sound Alert for new/urgent
                if(o.status === 'waiting_approval' && !o.soundPlayed) {
                    document.getElementById('sound-alert').play();
                }

                renderStory(o, stories);
                renderListItem(o, list);
            });
            
            // Refresh open chat if exists
            if(currentChatId && ordersData[currentChatId]) {
                renderChat(ordersData[currentChatId]);
            }
        });

        // --- Render Functions ---

        function renderStory(o, container) {
            if(o.status === 'done') return;
            const ring = o.status === 'new' ? 'ring-new' : 'ring-wait';
            const avatar = `https://ui-avatars.com/api/?name=${o.clientName}&background=random`;
            
            container.innerHTML += `
            <div class="story-item" onclick="openChat('${o.id}')">
                <div class="story-ring ${ring}"><img src="${avatar}"></div>
                <div class="text-xs text-gray-500 mt-1 truncate w-16 text-center">${o.clientName.split(' ')[0]}</div>
            </div>`;
        }

        function renderListItem(o, container) {
            const time = new Date(o.createdAt?.seconds*1000).toLocaleTimeString().slice(0,5);
            const avatar = `https://ui-avatars.com/api/?name=${o.clientName}&background=random`;
            const active = currentChatId === o.id ? 'active' : '';
            const statusTxt = getStatusText(o.status);
            
            // Timer Calculation
            const {text: timerTxt, cls: timerCls} = getTimerData(o);

            container.innerHTML += `
            <div class="chat-item ${active}" onclick="openChat('${o.id}')">
                <div class="user-avatar mr-3"><img src="${avatar}" class="w-full h-full rounded-full"></div>
                <div class="chat-info">
                    <div class="chat-top">
                        <span class="chat-name truncate">${o.clientName}</span>
                        <span class="chat-time">${time}</span>
                    </div>
                    <div class="chat-bottom">
                        <span class="truncate w-32">${statusTxt} â€¢ #${o.orderNum}</span>
                        <span class="timer-badge ${timerCls}">${timerTxt}</span>
                    </div>
                </div>
            </div>`;
        }

        window.openChat = (id) => {
            currentChatId = id;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chat-view').classList.remove('hidden');
            
            // Highlight in list
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            // (Re-rendering list handles the active class usually, but for instant feedback:)
            // ...
            
            renderChat(ordersData[id]);
        };

        function renderChat(o) {
            document.getElementById('chat-title').innerText = o.clientName;
            document.getElementById('chat-avatar').src = `https://ui-avatars.com/api/?name=${o.clientName}&background=random`;
            
            const msgs = document.getElementById('messages-area');
            msgs.innerHTML = "";
            
            // 1. ×”×•×“×¢×ª ×¤×ª×™×—×” (×”×–×× ×” ××”××¤×œ×™×§×¦×™×”)
            const time = new Date(o.createdAt?.seconds*1000).toLocaleTimeString().slice(0,5);
            msgs.innerHTML += `
            <div class="bubble">
                <div class="font-bold text-[#e542a3] text-xs mb-1">×”×–×× ×” ×—×“×©×” ×××¤×œ×™×§×¦×™×”</div>
                <div>${o.itemsText || '×¤×™×¨×•×˜ ×¤×¨×™×˜×™×...'}</div>
                <div class="text-sm text-gray-500 mt-1">×ª××¨×™×š ××¡×¤×§×”: ${o.supplyDate} ${o.supplyTime}</div>
                <div class="bubble-meta"><span>${time}</span></div>
            </div>`;

            // 2. ×¡×˜×˜×•×¡×™× ×“×™× ××™×™×
            if(o.status === 'new') {
                msgs.innerHTML += `
                <div class="bubble admin">
                    <div class="text-sm">ğŸ‘‹ ×”×™×™, ×”×”×–×× ×” ×”×ª×§×‘×œ×”. ×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ×§×•××§×¡ ×›×“×™ ×œ×—×‘×¨ ×œ××™×™×œ.</div>
                    <div class="mt-2 flex gap-2">
                        <input id="cx-input" type="text" placeholder="××¡' ×§×•××§×¡ (×œ××©×œ 6210496)" class="flex-1 border p-1 rounded text-sm">
                        <button onclick="saveComax('${o.id}')" class="bg-[#008069] text-white px-3 rounded text-sm">×©××•×¨</button>
                    </div>
                    <div class="bubble-meta"><i class="fas fa-check"></i> <span>×¢×›×©×™×•</span></div>
                </div>`;
            }

            if(o.status === 'processing') {
                msgs.innerHTML += `
                <div class="bubble admin">
                    <div>âœ… ××¡×¤×¨ ×§×•××§×¡ <b>${o.comaxNum}</b> × ×§×œ×˜.</div>
                    <div>ğŸ“¡ ×”××¢×¨×›×ª ×××–×™× ×” ×œ××™×™×œ ×›×¢×ª...</div>
                    <div class="bubble-meta"><i class="fas fa-check-double text-blue-500"></i> <span>×¢×›×©×™×•</span></div>
                </div>`;
            }

            if(o.status === 'waiting_approval') {
                msgs.innerHTML += `
                <div class="bubble">
                    <div class="font-bold text-orange-500 text-xs mb-1">×¢×“×›×•×Ÿ ××¢×¨×›×ª</div>
                    <div>ğŸ“„ ×”×ª×§×‘×œ ××¡××š ××§×•××§×¡.</div>
                    <div>×”×•×“×¢×” × ×©×œ×—×” ×œ×œ×§×•×— ×œ××™×©×•×¨ ×”×¢××¡×”.</div>
                    <a href="${o.pdfUrl}" target="_blank" class="action-btn">×¦×¤×” ×‘××¡××š PDF</a>
                    <div class="bubble-meta"><span>×¢×›×©×™×•</span></div>
                </div>`;
            }

            if(o.status === 'done') {
                msgs.innerHTML += `
                <div class="bubble admin">
                    <div class="font-bold text-green-600">ğŸ‘ ×”×œ×§×•×— ××™×©×¨ ×”×¢××¡×”!</div>
                    <div>×”×”×–×× ×” × ×¡×’×¨×” ×‘×”×¦×œ×—×”. ×¡×¢ ×œ×©×œ×•×. ğŸšš</div>
                    <div class="bubble-meta"><i class="fas fa-check-double text-blue-500"></i> <span>${new Date(o.approvedAt?.seconds*1000).toLocaleTimeString().slice(0,5)}</span></div>
                </div>`;
            }
            
            // ×¢×“×›×•×Ÿ ×˜×™×™××¨ ×’×“×•×œ
            updateBigTimer(o);
        }

        // --- Helpers ---
        function getTimerData(o) {
            if(o.status === 'done') return {text: '×‘×•×¦×¢', cls: 'bg-gray-400'};
            
            let target = o.supplyDate ? new Date(`${o.supplyDate}T${o.supplyTime}`) : new Date(o.createdAt.toDate().getTime() + 3600000);
            const diff = target - new Date();
            
            if(diff <= 0) return {text: '00:00', cls: 'bg-danger'};
            
            const h = Math.floor(diff/3600000);
            const m = Math.floor((diff%3600000)/60000);
            return {
                text: `${h}:${m.toString().padStart(2,'0')}`,
                cls: h < 1 ? 'bg-warn' : 'bg-ok'
            };
        }

        function updateBigTimer(o) {
            const {text, cls} = getTimerData(o);
            const el = document.getElementById('big-timer');
            el.innerText = text;
            el.className = `font-mono text-xl font-bold px-3 py-1 rounded shadow-sm ${cls === 'bg-danger' ? 'text-red-600 animate-pulse' : 'text-gray-700 bg-white'}`;
        }

        window.saveComax = async (id) => {
            const val = document.getElementById('cx-input').value;
            if(val) await updateDoc(doc(db, "orders", id), { comaxNum: val, status: 'processing' });
        }

        window.toggleTools = () => document.getElementById('tools-menu').classList.toggle('open');
        
        window.openUserGenerator = async () => {
            document.getElementById('tools-menu').classList.remove('open');
            const { value: formValues } = await Swal.fire({
                title: '×¦×•×¨ ×œ×™× ×§ ×œ×œ×§×•×—',
                html: '<input id="swal-name" class="swal2-input" placeholder="×©× ×”×œ×§×•×—"><input id="swal-id" class="swal2-input" placeholder="××–×”×” (×ª.×–/×—.×¤)">',
                confirmButtonColor: '#008069',
                preConfirm: () => [document.getElementById('swal-name').value, document.getElementById('swal-id').value]
            });

            if (formValues && formValues[1]) {
                const link = `https://saban-system.onrender.com/client-final.html?uid=${formValues[1]}`;
                navigator.clipboard.writeText(link);
                Swal.fire({icon:'success', title:'×”×•×¢×ª×§!', text: link, confirmButtonColor: '#008069'});
            }
        };

        function getStatusText(s) {
            const map = {'new':'×—×“×©', 'processing':'×‘×˜×™×¤×•×œ', 'waiting_approval':'×××ª×™×Ÿ', 'done':'×”×•×©×œ×'};
            return map[s] || s;
        }
        
        // Timer Interval
        setInterval(() => {
            if(currentChatId && ordersData[currentChatId]) updateBigTimer(ordersData[currentChatId]);
            // Refresh list timers logic would go here in full implementation
        }, 1000);

    </script>
</body>
</html>
