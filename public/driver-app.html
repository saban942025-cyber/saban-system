<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Driver | Cockpit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body { background: #111827; color: white; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Views & Animations */
        .view-section { flex: 1; display: none; flex-direction: column; overflow-y: auto; padding-bottom: 80px; }
        .view-section.active { display: flex; }
        @keyframes slideIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse-border { 0% { border-color: rgba(255,255,255,0.1); } 50% { border-color: rgba(255,255,255,0.5); } 100% { border-color: rgba(255,255,255,0.1); } }

        /* Header */
        .driver-header { background: #1f2937; padding: 15px; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: center; }
        
        /* THE MISSION CARD (Chameleon) */
        .card-mission { margin: 15px; border-radius: 20px; overflow: hidden; position: relative; animation: slideIn 0.4s ease-out; box-shadow: 0 10px 40px rgba(0,0,0,0.5); background: white; color: #1f2937; }
        
        /* Theme Colors (Based on Task Type) */
        .theme-transfer .header-bg { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); } /* 转 - 注专 */
        .theme-client .header-bg { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); } /*  - 拽 */
        .theme-supplier .header-bg { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); } /* 住 - 住驻拽 */
        .theme-urgent .header-bg { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); animation: pulse-red 2s infinite; } /*  - 祝 */
        
        .mission-header { padding: 20px; color: white; display: flex; justify-content: space-between; align-items: flex-start; }
        .mission-icon { font-size: 40px; opacity: 0.8; }
        .mission-body { padding: 20px; }

        /* Progress Stepper */
        .stepper { display: flex; justify-content: space-between; margin-bottom: 20px; position: relative; padding: 0 10px; }
        .stepper::before { content: ''; position: absolute; top: 14px; left: 10px; right: 10px; height: 3px; background: #e5e7eb; z-index: 0; }
        .step { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; }
        .step-circle { width: 30px; height: 30px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #9ca3af; font-weight: bold; border: 2px solid white; transition: 0.3s; }
        .step.active .step-circle { background: #10b981; color: white; transform: scale(1.1); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
        .step-label { font-size: 10px; margin-top: 5px; color: #9ca3af; font-weight: bold; }
        .step.active .step-label { color: #10b981; }

        /* Motivation Box */
        .motivation-box { background: #f3f4f6; border-radius: 12px; padding: 10px; margin-bottom: 20px; border-right: 4px solid #3b82f6; display: flex; gap: 10px; align-items: center; }
        .motivation-text { font-size: 12px; color: #4b5563; }
        .motivation-highlight { font-weight: bold; color: #2563eb; }

        /* Action Buttons */
        .btn-main { width: 100%; padding: 18px; border-radius: 15px; font-size: 18px; font-weight: 900; color: white; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-main:active { transform: scale(0.98); }
        .btn-disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }

        /* Bottom Nav */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #1f2937; border-top: 1px solid #374151; display: flex; justify-content: space-around; padding: 15px 0; z-index: 50; }
        .nav-item { text-align: center; color: #9ca3af; font-size: 10px; width: 50%; }
        .nav-item.active { color: #f59e0b; }
        .nav-item i { font-size: 24px; margin-bottom: 3px; display: block; }

        /* Performance Modal */
        .perf-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div class="driver-header">
        <div>
            <div class="text-xs text-gray-400"> 专</div>
            <div class="font-bold text-lg" id="driver-name">注...</div>
        </div>
        <div class="bg-gray-800 px-3 py-1 rounded text-xs font-mono text-green-400 border border-green-900 flex items-center gap-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> GPS ON
        </div>
    </div>

    <div id="view-mission" class="view-section active">
        
        <div id="state-waiting" class="flex flex-col items-center justify-center h-full text-gray-500 mt-20">
            <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mb-4 animate-pulse">
                <i class="fas fa-radar text-3xl text-gray-600"></i>
            </div>
            <h2 class="text-xl font-bold">转 砖抓 住专...</h2>
            <p class="text-sm opacity-50 mt-2">砖专 , 注专转 .</p>
        </div>

        <div id="state-mission" class="card-mission hidden theme-client">
            <div class="header-bg mission-header">
                <div>
                    <div class="text-xs opacity-80 uppercase tracking-widest font-bold" id="task-type-label">转 拽</div>
                    <div class="text-2xl font-black mt-1" id="client-name">砖 拽</div>
                    <div class="text-sm opacity-90 mt-1"><i class="fas fa-map-marker-alt"></i> <span id="dest-address">转转</span></div>
                </div>
                <i class="fas fa-box-open mission-icon" id="type-icon"></i>
            </div>

            <div class="mission-body">
                <div class="stepper">
                    <div class="step active" id="step-1"><div class="step-circle"><i class="fas fa-file-alt"></i></div><div class="step-label">转拽</div></div>
                    <div class="step" id="step-2"><div class="step-circle"><i class="fas fa-route"></i></div><div class="step-label">专</div></div>
                    <div class="step" id="step-3"><div class="step-circle"><i class="fas fa-truck-loading"></i></div><div class="step-label">注</div></div>
                    <div class="step" id="step-4"><div class="step-circle"><i class="fas fa-flag-checkered"></i></div><div class="step-label">住</div></div>
                </div>

                <div class="motivation-box" id="motivation-area">
                    <i class="fas fa-stopwatch text-blue-500 text-xl"></i>
                    <div>
                        <div class="motivation-text"> 爪注 砖 : <span class="motivation-highlight">25 拽'</span></div>
                        <div class="text-[10px] text-gray-400">砖 砖 拽 : 21 拽' </div>
                    </div>
                </div>

                <div id="pending-alert" class="hidden bg-yellow-50 border-r-4 border-yellow-400 p-3 mb-4 rounded text-xs text-yellow-800">
                    <b> 转 砖专 住专:</b> 拽砖 拽  专 砖专 住驻转 注" /专.
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-6">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">驻专 砖</h4>
                    <div class="text-lg font-bold text-gray-800 leading-tight" id="mission-desc">...</div>
                </div>

                <button onclick="openWaze()" class="w-full bg-cyan-400 text-white font-bold py-3 rounded-xl mb-3 shadow-sm hover:bg-cyan-500 flex items-center justify-center gap-2">
                    <i class="fab fa-waze text-2xl"></i>  注
                </button>

                <button id="main-btn" class="btn-main bg-green-500" onclick="advanceStatus()">
                    <i class="fas fa-play"></i> 爪转 专
                </button>
            </div>
        </div>
    </div>

    <div id="perf-report" class="perf-modal">
        <i class="fas fa-trophy text-6xl text-yellow-400 mb-4 animate-bounce"></i>
        <h2 class="text-3xl font-black text-white mb-2">砖 砖!</h2>
        <div class="grid grid-cols-2 gap-4 w-full max-w-xs mt-6">
            <div class="bg-gray-800 p-4 rounded-xl">
                <div class="text-gray-400 text-xs"> </div>
                <div class="text-2xl font-bold text-white" id="report-time">22 拽'</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl">
                <div class="text-gray-400 text-xs">专拽</div>
                <div class="text-2xl font-bold text-white" id="report-dist">8 拽"</div>
            </div>
        </div>
        <button onclick="closeReport()" class="mt-8 bg-white text-black font-bold py-3 px-8 rounded-full">专 砖专</button>
    </div>

    <div id="view-chat" class="view-section" style="background: #efeae2;">
        <div id="chat-msgs" class="flex-1 flex flex-col p-4 overflow-y-auto gap-2"></div>
        <div class="p-3 bg-gray-200 flex gap-2">
            <input type="text" id="msg-input" class="flex-1 p-3 rounded-full text-black outline-none shadow-sm" placeholder="注 砖专...">
            <button onclick="sendMessage()" class="bg-[#00a884] w-12 h-12 rounded-full text-white shadow-lg flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchView('mission', this)"><i class="fas fa-truck"></i> 砖</div>
        <div class="nav-item" onclick="switchView('chat', this)"><div class="relative inline-block"><i class="fas fa-comments"></i><div id="chat-badge" class="absolute top-0 right-0 bg-red-500 w-3 h-3 rounded-full hidden"></div></div>注转</div>
    </div>

    <audio id="sound-alert" src="https://actions.google.com/sounds/v1/alarms/spaceship_alarm.ogg"></audio>
    <audio id="sound-success" src="https://actions.google.com/sounds/v1/cartoon/clank_car_crash.ogg"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, limit, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // IDENTITY
        const params = new URLSearchParams(window.location.search);
        let DRIVER = { uid: params.get('uid') || '999', name: params.get('name') || ' ' };
        document.getElementById('driver-name').innerText = DRIVER.name;

        let currentOrder = null;
        let startTime = null;

        // --- 1. MISSION ENGINE ---
        //  砖转 驻注转 (  砖转转 砖专 住专)
        const q = query(
            collection(db, "orders"), 
            where("driverId", "==", DRIVER.name), 
            where("status", "in", ["assigned", "pending_approval", "en_route", "arrived"]), 
            orderBy("createdAt", "desc"), 
            limit(1)
        );

        onSnapshot(q, (snap) => {
            if (snap.empty) {
                toggleState('waiting');
                return;
            }

            const data = snap.docs[0].data();
            const id = snap.docs[0].id;

            // New mission alert
            if (!currentOrder || currentOrder.id !== id) {
                document.getElementById('sound-alert').play().catch(()=>{});
                //  砖 专 砖专 住专 - 转  
                if(data.status === 'assigned') startTime = Date.now();
            }

            currentOrder = { id, ...data };
            toggleState('mission');
            renderMissionCard(currentOrder);
        });

        // --- 2. RENDER LOGIC (THE CHAMELEON) ---
        function renderMissionCard(order) {
            const card = document.getElementById('state-mission');
            const typeLabel = document.getElementById('task-type-label');
            const icon = document.getElementById('type-icon');
            const btn = document.getElementById('main-btn');
            const alertBox = document.getElementById('pending-alert');

            // Reset Classes
            card.classList.remove('theme-transfer', 'theme-client', 'theme-supplier', 'theme-urgent');

            // Apply Theme based on Task Type
            let theme = 'theme-client';
            let iconClass = 'fa-box';
            let label = ' 专';

            if (order.taskType === 'transfer') { theme = 'theme-transfer'; iconClass = 'fa-exchange-alt'; label = '注专  住驻'; }
            else if (order.taskType === 'supplier') { theme = 'theme-supplier'; iconClass = 'fa-dolly'; label = '住祝 住驻拽'; }
            else if (order.taskType === 'urgent') { theme = 'theme-urgent'; iconClass = 'fa-fire'; label = '砖 驻 '; }

            card.classList.add(theme);
            typeLabel.innerText = label;
            icon.className = `fas ${iconClass} mission-icon`;

            // Data
            document.getElementById('client-name').innerText = order.clientName;
            document.getElementById('dest-address').innerText = order.address || ' 爪 转转';
            document.getElementById('mission-desc').innerText = order.text || '...';

            // Stepper & Button Logic
            updateStepper(order.status);

            // Pending Approval Logic
            if (order.status === 'pending_approval') {
                btn.className = 'btn-main btn-disabled';
                btn.innerHTML = '<i class="fas fa-lock"></i> 转 砖专 住专';
                btn.disabled = true;
                alertBox.classList.remove('hidden');
            } else {
                alertBox.classList.add('hidden');
                btn.disabled = false;
                
                // Active Button States
                if (order.status === 'assigned') {
                    btn.className = 'btn-main bg-green-500';
                    btn.innerHTML = '<i class="fas fa-play"></i> 爪转 专';
                    btn.onclick = () => advanceStatus('en_route');
                } else if (order.status === 'en_route') {
                    btn.className = 'btn-main bg-blue-500';
                    btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> 注转 注';
                    btn.onclick = () => advanceStatus('arrived');
                } else if (order.status === 'arrived') {
                    btn.className = 'btn-main bg-purple-600';
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> 住 砖';
                    btn.onclick = () => finishMission();
                }
            }
        }

        function updateStepper(status) {
            const steps = ['assigned', 'en_route', 'arrived', 'done']; // map to 1-4
            // Logic to highlight circles...
            document.querySelectorAll('.step').forEach((el, idx) => {
                el.classList.remove('active');
                // Simple logic: if status index >= step index
                if (status === 'pending_approval' && idx === 0) el.classList.add('active'); // Special case
                if (status === 'assigned' && idx <= 0) el.classList.add('active');
                if (status === 'en_route' && idx <= 1) el.classList.add('active');
                if (status === 'arrived' && idx <= 2) el.classList.add('active');
            });
        }

        // --- 3. ACTIONS ---
        window.advanceStatus = async (newStatus) => {
            if(!currentOrder) return;
            await updateDoc(doc(db, "orders", currentOrder.id), { status: newStatus, lastUpdate: serverTimestamp() });
        };

        window.finishMission = async () => {
            if(!currentOrder) return;
            
            // Calculate Time
            const duration = startTime ? Math.floor((Date.now() - startTime) / 60000) : 15; // Mock minutes
            
            // Show Report
            document.getElementById('report-time').innerText = duration + " 拽'";
            document.getElementById('perf-report').style.display = 'flex';
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            document.getElementById('sound-success').play();

            // Update DB
            await updateDoc(doc(db, "orders", currentOrder.id), { 
                status: 'done', 
                completedAt: serverTimestamp(),
                performance: { timeMinutes: duration, distKm: 8 } // Mock distance
            });
        };

        window.closeReport = () => {
            document.getElementById('perf-report').style.display = 'none';
            toggleState('waiting');
        };

        window.openWaze = () => {
            if(!currentOrder) return;
            const addr = currentOrder.address || currentOrder.clientName;
            window.open(`https://waze.com/ul?q=${encodeURIComponent(addr)}&navigate=yes`, '_blank');
        };

        // --- UTILS ---
        function toggleState(state) {
            document.getElementById('state-waiting').classList.toggle('hidden', state !== 'waiting');
            document.getElementById('state-mission').classList.toggle('hidden', state !== 'mission');
        }

        window.switchView = (view, btn) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${view}`).classList.add('active');
            btn.classList.add('active');
        }

        // --- CHAT & GPS ---
        // (转 拽 爪' -GPS  拽 - 砖  拽爪专   注住, 转注转拽 专住 拽转  住专)
        // ... (Chat Logic) ...
        // ... (GPS Logic) ...

    </script>
</body>
</html>
