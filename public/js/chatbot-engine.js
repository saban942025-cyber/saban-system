// public/js/chatbot-engine.js
import { SabanPush } from './notifications.js';

export class SabanChatbot {
    constructor(db, userContext) {
        this.db = db;
        this.user = userContext; 
        
        // --- ×”××•×— ×”×¢×¦×××™ (×œ×œ× ×ª×œ×•×ª ×‘×§×‘×¦×™×) ---
        this.rules = [
            // 1. ×–×™×”×•×™ ×”×–×× ×•×ª ×—×•××¨×™× (×¨×©×™××ª ××›×•×œ×ª)
            {
                keywords: ["×”×–×× ×”", "×œ×”×–××™×Ÿ", "×ª×©×œ×—", "××œ×˜", "×—×•×œ", "×‘×œ×•×ª", "×˜×™×˜", "×“×‘×§", "×’×‘×¡", "×‘×œ×•×§×™×", "×‘×¨×–×œ", "×©×§"],
                answer: "×§×™×‘×œ×ª×™ ××ª ×”×¨×©×™××”! ğŸ“\n×× ×™ ××¢×‘×™×¨ ××•×ª×” ××™×“ ×œ×¦×•×•×ª (×¨××™/×™×•××‘) ×œ×”×§×œ×“×” ×‘×§×•××§×¡.\n××¡×¤×¨ ×”×–×× ×” ×•×§×•×‘×¥ PDF ×™×©×œ×—×• ××œ×™×š ×œ××™×©×•×¨ ×‘×¨×’×¢ ×©×–×” ×™×”×™×” ××•×›×Ÿ.",
                action: "order_received"
            },
            // 2. ×–×™×”×•×™ ×œ×•×’×™×¡×˜×™×§×” (×× ×•×£)
            {
                keywords: ["×× ×•×£", "×§×•××”", "×’×’", "×œ×”×¨×™×", "××©××™×ª"],
                answer: "××™×Ÿ ×‘×¢×™×”, × ×¡×¤×§ ×¢× ×× ×•×£ (×—×›××ª/×××™×¨). ğŸ—ï¸\n×¨×§ ×ª×•×•×“× ×©××™×Ÿ ×—×•×˜×™ ×—×©××œ ×‘×’×™×©×” ×•×©××©×˜×— ×”×¤×¨×™×§×” ×¤× ×•×™.",
                buttons: [{ label: "×××©×¨ ×’×™×©×” ×ª×§×™× ×” âœ…", payload: "crane_ok" }]
            },
            // 3. ××§×¨×™ ×—×™×¨×•×
            {
                keywords: ["×“×—×•×£", "×‘×”×•×œ", "×¢×›×©×™×•", "×ª×§×•×¢", "×ª×§×œ×”", "×œ× ×”×’×™×¢"],
                answer: "×”×‘× ×ª×™ ×©×–×” ×“×—×•×£! ğŸš¨\n×”×§×¤×¦×ª×™ ×”×ª×¨××” ××™×•×—×“×ª ×œ×× ×”×œ ×”×ª×¤×¢×•×œ (×¨×××™). ××™×ª×š ×ª×•×š ×“×§×•×ª.",
                action: "urgent_alert"
            },
            // 4. ×”×™×ª×¨×™× (×”×¨×¦×œ×™×”/×ª"×)
            {
                keywords: ["×”×¨×¦×œ×™×”", "×¤×™×ª×•×—", "×ª×œ ××‘×™×‘"],
                answer: "ğŸ›‘ ×©×™× ×œ×‘: ×‘××–×•×¨ ×”×–×” ×”×¢×™×¨×™×™×” ×“×•×¨×©×ª ×”×™×ª×¨ ×›× ×™×¡×”/×”×¢××“×”.\n×™×© ×œ×š ×”×™×ª×¨ ×‘×ª×•×§×£?",
                buttons: [{ label: "×›×Ÿ, ×™×© ×œ×™ ğŸ‘", payload: "permit_yes" }, { label: "×œ×, ×ª×‘×“×§×• ×œ×™ â“", payload: "permit_no" }]
            },
            // 5. × ×™××•×¡×™×Ÿ
            {
                keywords: ["×ª×•×“×”", "××—×œ×”", "××¢×•×œ×”", "×¡×‘×‘×”", "×ª×•×ª×—"],
                answer: "×‘×›×™×£ {name}! ×× ×™ ×›××Ÿ ×‘×©×‘×™×œ×š. ğŸ˜Š"
            },
            {
                keywords: ["×”×™×™", "×©×œ×•×", "×‘×•×§×¨ ×˜×•×‘", "×¢×¨×‘ ×˜×•×‘", "××”×œ×Ÿ"],
                answer: "××”×œ×Ÿ {name}! ×›××Ÿ ×”×‘×•×˜ ×©×œ ×¡×‘×Ÿ. ğŸ‘‹\n×©×œ×— ×œ×™ ×¨×©×™××ª ×”×–×× ×”, ××™×§×•×, ××• ×›×œ ×©××œ×”.",
                buttons: [{ label: "×”×“×‘×§ ×”×–×× ×”", payload: "paste_order" }, { label: "×§×˜×œ×•×’ ××•×¦×¨×™×", payload: "catalog" }]
            }
        ];
    }

    async ask(question) {
        console.log("ğŸ¤– SabanBot analyzing:", question); 
        
        if (!question) return null;
        const cleanQ = question.toLowerCase();

        // ×¡×¨×™×§×ª ×”×—×•×§×™×
        for (const rule of this.rules) {
            const match = rule.keywords.some(kw => cleanQ.includes(kw));
            
            if (match) {
                console.log("âœ… Match found:", rule.keywords[0]);
                
                // ×”×ª×¨××” ×œ×× ×”×œ ×× ×“×—×•×£
                if (rule.action === 'urgent_alert') {
                    await SabanPush.send('admin_rami', 'ğŸš¨ ×“×—×•×£ ××”×‘×•×˜', `${this.user.name}: ${question}`);
                }

                // ×”×—×œ×¤×ª ×©× ×”×œ×§×•×— ×‘×ª×©×•×‘×”
                const finalText = rule.answer.replace("{name}", this.user.name || "×—×‘×¨");
                
                return { 
                    text: finalText, 
                    buttons: rule.buttons || [],
                    action: rule.action || null
                };
            }
        }

        // ×ª×©×•×‘×ª ×‘×¨×™×¨×ª ××—×“×œ (×× ×œ× ×”×‘×™×Ÿ)
        return { 
            text: "×§×™×‘×œ×ª×™. ×”×”×•×“×¢×” ×”×•×¢×‘×¨×” ×œ× ×¦×™×’ ×× ×•×©×™ ×œ×”××©×š ×˜×™×¤×•×œ. ğŸ‘¨â€ğŸ’»",
            action: "fallback"
        };
    }
}
