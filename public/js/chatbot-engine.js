// public/js/chatbot-engine.js
import { SabanPush } from './notifications.js';

export class SabanChatbot {
    constructor(db, userContext) {
        this.db = db;
        this.user = userContext; 
        
        // --- ×”××•×— (Hardcoded Knowledge Base) ---
        // ×”×’×“×¨×ª ×—×•×§×™× ×•×ª×©×•×‘×•×ª ×™×©×™×¨×•×ª ×‘×ª×•×š ×”×§×•×“ ×œ×× ×™×¢×ª ×ª×§×œ×•×ª ×˜×¢×™× ×”
        this.rules = [
            // 1. ×–×™×”×•×™ ×”×–×× ×•×ª ×•×¨×©×™××•×ª
            {
                keywords: ["×”×–×× ×”", "×œ×”×–××™×Ÿ", "×ª×©×œ×—", "××œ×˜", "×—×•×œ", "×‘×œ×•×ª", "×˜×™×˜", "×“×‘×§", "×’×‘×¡", "×‘×œ×•×§×™×", "×‘×¨×–×œ"],
                answer: "×§×™×‘×œ×ª×™ ××ª ×¨×©×™××ª ×”×”×–×× ×”! ğŸ“\n×× ×™ ××¢×‘×™×¨ ××•×ª×” ××™×“ ×œ×¦×•×•×ª (×¨××™/×™×•××‘) ×œ×”×§×œ×“×” ×‘×§×•××§×¡.\n×ª×§×‘×œ ×¢×“×›×•×Ÿ ×•×§×•×‘×¥ PDF ×œ××™×©×•×¨ ×‘×¨×’×¢ ×©×–×” ×™×”×™×” ××•×›×Ÿ.",
                action: "order_received"
            },
            // 2. ×œ×•×’×™×§×” ×ª×¤×¢×•×œ×™×ª (×× ×•×£/××©××™×ª)
            {
                keywords: ["×× ×•×£", "×§×•××”", "×’×’", "×œ×”×¨×™×"],
                answer: "××™×Ÿ ×‘×¢×™×”, × ×¡×¤×§ ×¢× ×× ×•×£ (×—×›××ª/×××™×¨). ğŸ—ï¸\n×¨×§ ×ª×•×•×“× ×©××™×Ÿ ×—×•×˜×™ ×—×©××œ ×‘×’×™×©×” ×•×©××©×˜×— ×”×¤×¨×™×§×” ×¤× ×•×™.",
                buttons: [{ label: "×××©×¨ ×’×™×©×” ×ª×§×™× ×” âœ…", payload: "crane_ok" }]
            },
            {
                keywords: ["×™×“× ×™", "×¡×‘×œ×•×ª", "××“×¨×’×•×ª"],
                answer: "×¤×¨×™×§×” ×™×“× ×™×ª? ×–×” ×œ×˜×™×¤×•×œ ×©×œ ×¢×œ×™. ğŸ’ª\n×©×™× ×œ×‘ ×©×™×© ×ª×•×¡×¤×ª ×ª×©×œ×•× ×¢×œ ×¡×‘×œ×•×ª ×œ×¤×™ ×§×•××”.",
                buttons: [{ label: "×××©×¨ ×ª×•×¡×¤×ª", payload: "manual_ok" }]
            },
            // 3. ××§×¨×™ ×—×™×¨×•×
            {
                keywords: ["×“×—×•×£", "×‘×”×•×œ", "×¢×›×©×™×•", "×ª×§×•×¢", "×ª×§×œ×”", "×œ× ×”×’×™×¢"],
                answer: "×”×‘× ×ª×™ ×©×–×” ×“×—×•×£! ğŸš¨\n×”×§×¤×¦×ª×™ ×”×ª×¨××” ××™×•×—×“×ª ×œ×× ×”×œ ×”×ª×¤×¢×•×œ. ××™×ª×š ×ª×•×š ×“×§×•×ª.",
                action: "urgent_alert"
            },
            // 4. ×”×™×ª×¨×™× ×•××™×–×•×¨×™× ××™×•×—×“×™×
            {
                keywords: ["×”×¨×¦×œ×™×”", "×¤×™×ª×•×—", "×ª×œ ××‘×™×‘"],
                answer: "ğŸ›‘ ×©×™× ×œ×‘: ×‘××–×•×¨ ×”×–×” ×”×¢×™×¨×™×™×” ×“×•×¨×©×ª ×”×™×ª×¨ ×›× ×™×¡×”/×”×¢××“×”.\n×™×© ×œ×š ×”×™×ª×¨ ×‘×ª×•×§×£?",
                buttons: [{ label: "×›×Ÿ, ×™×© ×œ×™ ğŸ‘", payload: "permit_yes" }, { label: "×œ×, ×ª×‘×“×§×• ×œ×™ â“", payload: "permit_no" }]
            },
            // 5. × ×™××•×¡×™×Ÿ ×•×›×œ×œ×™
            {
                keywords: ["×ª×•×“×”", "××—×œ×”", "××¢×•×œ×”", "×¡×‘×‘×”", "×ª×•×ª×—"],
                answer: "×‘×›×™×£ {name}! ×× ×™ ×›××Ÿ ×× ×¦×¨×™×š ×¢×•×“ ××©×”×•. ğŸ˜Š"
            },
            {
                keywords: ["×”×™×™", "×©×œ×•×", "×‘×•×§×¨ ×˜×•×‘", "×¢×¨×‘ ×˜×•×‘", "××”×œ×Ÿ"],
                answer: "××”×œ×Ÿ {name}! ×‘×¨×•×š ×”×‘× ×œ×¡×‘×Ÿ. ğŸ‘‹\n××¤×©×¨ ×œ×”×§×œ×™×“ ×›××Ÿ ×”×–×× ×” ×—×•×¤×©×™×ª, ×œ×¦×œ× ××¡××š, ××• ×œ×‘×—×•×¨ ××”×ª×¤×¨×™×˜.",
                buttons: [{ label: "×”×“×‘×§ ×”×–×× ×”", payload: "paste_order" }, { label: "×§×˜×œ×•×’ ××•×¦×¨×™×", payload: "catalog" }]
            }
        ];
    }

    async ask(question) {
        console.log("ğŸ¤– SabanBot thinking about:", question); // ×œ×•×’ ×œ×‘×“×™×§×” ×‘×“×¤×“×¤×Ÿ
        
        if (!question) return null;
        const cleanQ = question.toLowerCase();

        // ××¢×‘×¨ ×¢×œ ×›×œ ×”×—×•×§×™× ×‘××•×—
        for (const rule of this.rules) {
            // ×”×× ××—×ª ×××™×œ×•×ª ×”××¤×ª×— × ××¦××ª ×‘××©×¤×˜?
            const match = rule.keywords.some(kw => cleanQ.includes(kw));
            
            if (match) {
                console.log("âœ… Match found via keyword:", rule.keywords[0]);
                
                // ×©×œ×™×—×ª ×”×ª×¨××” ×œ×× ×”×œ ×‘××§×¨×” ×“×—×•×£
                if (rule.action === 'urgent_alert') {
                    await SabanPush.send('admin_rami', 'ğŸš¨ ×“×—×•×£ ××‘×•×˜', `${this.user.name}: ${question}`);
                }

                // ×¢×™×‘×•×“ ×”×ª×©×•×‘×” (×”×›× ×¡×ª ×©× ×”×œ×§×•×—)
                const finalText = rule.answer.replace("{name}", this.user.name || "×—×‘×¨");
                
                return { 
                    text: finalText, 
                    buttons: rule.buttons || [],
                    action: rule.action || null
                };
            }
        }

        // ×ª×©×•×‘×ª ×‘×¨×™×¨×ª ××—×“×œ (×× ×œ× ×”×‘×™×Ÿ ×›×œ×•×)
        return { 
            text: "×§×™×‘×œ×ª×™ ××ª ×”×”×•×“×¢×”. ××¢×‘×™×¨ ×œ× ×¦×™×’ ×× ×•×©×™ ×œ×”××©×š ×˜×™×¤×•×œ. ğŸ‘¨â€ğŸ’»",
            action: "fallback"
        };
    }
}
