// public/js/chatbot-engine.js
import { SabanPush } from './notifications.js';
import { SabanSounds } from './sounds.js';

export class SabanChatbot {
    constructor(db, userContext) {
        this.db = db;
        this.user = userContext; 
        
        // ×”××•×— ×”××•×¨×—×‘ - ×¡×“×¨ ×”×—×•×§×™× ×—×©×•×‘ (×“×—×™×¤×•×ª ×§×•×“×)
        this.rules = [
            // --- 1. ×—×™×¨×•× ×•×¢×¦×™×¨×ª ×¢×‘×•×“×” (×”×›×™ ×—×©×•×‘) ---
            {
                category: "EMERGENCY",
                keywords: ["×“×—×•×£", "×‘×”×•×œ", "×¢×¦×•×¨", "×ª×¢×¦×•×¨", "×˜×¢×•×ª ×‘×”×–×× ×”", "×œ× ×œ×©×œ×•×—", "×ª×§×œ×”", "×©×™× ×•×™ ×“×—×•×£"],
                answer: "ğŸ›‘ ×¢×¦×¨×ª×™ ×”×›×œ! ×”×§×¤×¦×ª×™ ×”×ª×¨××” ××“×•××” ×œ×›×œ ×”×× ×”×œ×™× (×¨××™/××•×¨×Ÿ).\n×× ×™ ××—×™×™×’ ××œ×™×š ××• ×©×•×œ×— × ×¦×™×’ ×œ×¦'××˜ ××™×“.",
                action: "urgent_alert"
            },

            // --- 2. ××›×•×œ×•×ª ×•×¤×™× ×•×™ ×¤×¡×•×œ×ª (×œ×•×’×™×§×” ××•×¨×›×‘×ª) ---
            {
                category: "CONTAINERS",
                keywords: ["××›×•×œ×”", "8 ×§×•×‘", "×¤×™× ×•×™ ×¤×¡×•×œ×ª", "×œ×”×–××™×Ÿ ××›×•×œ×”", "×”×—×œ×¤×ª ××›×•×œ×”"],
                answer: "××™×Ÿ ×‘×¢×™×”, × ××¨×’×Ÿ ××›×•×œ×” 8 ×§×•×‘. ğŸš›\n×—×©×•×‘ ×××•×“: ×œ××™×–×• ×¢×™×¨ ×”××›×•×œ×” ××™×•×¢×“×ª? (×‘×ª\"×/×”×¨×¦×œ×™×” ×—×•×‘×” ×”×™×ª×¨ ×”×¦×‘×”).",
                buttons: [
                    { label: "ğŸ™ï¸ ×ª×œ ××‘×™×‘ / ×”×¨×¦×œ×™×”", payload: "CONTAINER_CITY_REQ_PERMIT" },
                    { label: "ğŸ  ×¢×™×¨ ××—×¨×ª", payload: "CONTAINER_CITY_NORMAL" }
                ]
            },
            {
                category: "PERMITS",
                keywords: ["×™×© ×”×™×ª×¨", "××™×Ÿ ×”×™×ª×¨", "××™×©×•×¨ ×”×¦×‘×”", "×¢×™×¨×™×™×”"],
                answer: "×§×™×‘×œ×ª×™. ×× ×™×© ×”×™×ª×¨, ×”× ×”×’ ×™×•×¦×. ×× ××™×Ÿ - ×§×— ×‘×—×©×‘×•×Ÿ ×©×”×§× ×¡ ×¢×œ ×”×œ×§×•×—. âš ï¸\n×”×× ×œ××©×¨ ×”×–×× ×”?",
                buttons: [{ label: "âœ… ××©×¨ ×•×©×œ×—", payload: "CONFIRM_CONTAINER" }]
            },

            // --- 3. ×œ×•×’×™×¡×˜×™×§×” ×•×©×˜×— ---
            {
                category: "LOCATION",
                keywords: ["××™×§×•×", "×œ×©×˜×—", "×œ××ª×¨", "×›×ª×•×‘×ª", "×ª×‘×™× ×œ", "××™×¤×” ×œ×¤×¨×•×§", "gps"],
                answer: "×›×“×™ ×©×”× ×”×’ ×™×’×™×¢ ×‘×•×œ ×œ× ×§×•×“×” ×•×œ× ×™×¡×ª×‘×š, ×©×œ×— ×œ×™ ××™×§×•× GPS × ×•×›×—×™. ğŸ“",
                buttons: [{ label: "ğŸ“ ×©×œ×— ××™×§×•× × ×•×›×—×™", payload: "ACTION_SEND_LOC" }]
            },
            {
                category: "CRANE",
                keywords: ["×× ×•×£", "×§×•××”", "×’×’", "×œ×”×¨×™×", "×–×¨×•×¢", "××¨×¤×¡×ª"],
                answer: "××™×Ÿ ×‘×¢×™×”, × ×¡×¤×§ ×¢× ×× ×•×£ (×—×›××ª/×××™×¨). ğŸ—ï¸\n×¨×§ ×ª×•×•×“× ×©××™×Ÿ ×—×•×˜×™ ×—×©××œ ×©××¤×¨×™×¢×™× ×œ×”×¨××”.",
                buttons: [{ label: "âœ… ×’×™×©×” ×ª×§×™× ×” ×œ×× ×•×£", payload: "CRANE_OK" }]
            },

            // --- 4. ×× ×”×œ×” ×•×›×¡×¤×™× (×”×¨××œ) ---
            {
                category: "FINANCE",
                keywords: ["×—×©×‘×•× ×™×ª", "×”×¨××œ", "×”× ×”×œ×ª ×—×©×‘×•× ×•×ª", "×›×¡×£", "×—×•×‘", "×ª×©×œ×•×", "××©×¨××™", "××—×™×¨"],
                answer: "×‘×›×™×£. ×× ×™ ×¤×•×ª×— ××©×™××” ×œ×”×¨××œ (×›×¡×¤×™×) ×©×™×˜×¤×œ ×‘×–×”. ğŸ§¾\n××” ×¨××ª ×”×“×—×™×¤×•×ª?",
                buttons: [
                    { label: "ğŸ”¥ ×“×—×•×£ ×œ××¢\"× (×”×™×•×)", payload: "URGENT_INVOICE" },
                    { label: "ğŸ•’ ×¨×’×™×œ (×‘×–×× ×• ×”×¤× ×•×™)", payload: "NORMAL_INVOICE" }
                ],
                action: "finance_task"
            },

            // --- 5. ×”×ª×™×™×¢×¦×•×ª ××•×¦×¨×™× (×˜×›× ×™) ---
            {
                category: "CONSULT",
                keywords: ["××ª×™×™×¢×¥", "×œ×’×‘×™ ××•×¦×¨", "××™×š ××©×ª××©×™×", "××¤×¨×˜", "××§\"×˜", "×›××” ×©×•×§×œ", "×¡×™×§×”", "××™×˜×•×"],
                answer: "×‘×©××—×”! ×× ×™ ×¨×•××” ×©××ª×” ××ª×¢× ×™×™×Ÿ ×‘××•×¦×¨ ×–×”. ğŸ§\n×× ×™ ×™×›×•×œ ×œ×©×œ×•×— ×œ×š ×“×£ ××•×¦×¨, ×¡×¨×˜×•×Ÿ ×™×™×©×•×, ××• ×œ×—×©×‘ ×›××•×™×•×ª.",
                buttons: [
                    { label: "ğŸ¬ ×¡×¨×˜×•×Ÿ ×™×™×©×•×", payload: "SHOW_VIDEO" },
                    { label: "ğŸ‘¨â€ğŸ’» × ×¦×™×’ ×˜×›× ×™", payload: "HUMAN_HELP" }
                ]
            },

            // --- 6. ×”×™×¡×˜×•×¨×™×” ×•××™×“×¢ ××™×©×™ ---
            {
                category: "HISTORY",
                keywords: ["×”×™×¡×˜×•×¨×™×”", "×”×–×× ×•×ª ×©×œ×™", "××” ×”×–×× ×ª×™", "××¨×›×™×•×Ÿ", "×¡×˜×˜×•×¡", "××ª×™ ××’×™×¢"],
                answer: "×‘×˜×—. ××ª×” ×™×›×•×œ ×œ×¨××•×ª ×”×›×œ ×‘×™×•××Ÿ ×”×”×–×× ×•×ª, ××• ×©××‘×“×•×§ ×œ×š ×¡×˜×˜×•×¡ ×¢×›×©×™×•. ğŸ“œ",
                buttons: [{ label: "×¤×ª×— ×™×•××Ÿ ×”×–×× ×•×ª", payload: "ACTION_OPEN_HISTORY" }]
            },

            // --- 7. ×”×–×× ×•×ª ×©×•×˜×¤×•×ª (Keywords) ---
            {
                category: "ORDER_GENERAL",
                keywords: ["×”×–×× ×”", "×œ×”×–××™×Ÿ", "×ª×©×œ×—", "××œ×˜", "×—×•×œ", "×‘×œ×•×ª", "×˜×™×˜", "×“×‘×§", "×’×‘×¡", "×‘×œ×•×§×™×", "×‘×¨×–×œ", "×©×•××©×•×"],
                answer: "×§×™×‘×œ×ª×™ ××ª ×”×¨×©×™××”! ğŸ“\n××¢×‘×™×¨ ×œ×”×§×œ×“×” ×•×œ×™×§×•×˜. ××¡×¤×¨ ×”×–×× ×” ×™×™×©×œ×— ×‘×¨×’×¢ ×©×™×•×¤×§.",
                action: "order_received"
            },

            // --- 8. × ×™××•×¡ ×•×¡××•×œ-×˜×•×§ ---
            {
                category: "SMALL_TALK",
                keywords: ["×ª×•×“×”", "××œ×•×£", "××œ×š", "×‘×•×§×¨ ×˜×•×‘", "×”×™×™", "×©×œ×•×", "××” ×§×•×¨×”"],
                answer: "×‘×›×™×£ {name}! ×× ×™ ×›××Ÿ ×œ×›×œ ××” ×©×¦×¨×™×š. ğŸ’ª\n×¦×¨×™×š ×¢×•×“ ××©×”×• ×œ××ª×¨?",
                buttons: [{ label: "×œ× ×ª×•×“×”", payload: "NO_THANKS" }, { label: "×›×Ÿ, ×”×–×× ×”", payload: "NEW_ORDER" }]
            }
        ];
    }

    async ask(question) {
        if (!question) return null;
        const cleanQ = question.toLowerCase();

        // ××¢×‘×¨ ×¢×œ ×›×œ ×”×—×•×§×™×
        for (const rule of this.rules) {
            // ×‘×“×™×§×” ×”×× ××—×ª ×××™×œ×•×ª ×”××¤×ª×— ×§×™×™××ª ×‘×©××œ×”
            const match = rule.keywords.some(kw => cleanQ.includes(kw));
            
            if (match) {
                // ×œ×•×’×™×§×” ×œ×¤×™ ×§×˜×’×•×¨×™×”
                
                // 1. ×—×™×¨×•× - ×¦×¤×¦×•×£ ×—×–×§ ×•×”×ª×¨××”
                if (rule.action === 'urgent_alert') {
                    if(SabanSounds) SabanSounds.playAlert();
                    await SabanPush.send('admin_rami', 'ğŸš¨ ×“×—×•×£ ×‘×—×"×œ!', `${this.user.name}: ${question}`);
                } 
                // 2. ×”×–×× ×”/×× ×”×œ×” - ×¦×œ×™×œ ×¨×’×™×œ ×•×¢×“×›×•×Ÿ
                else {
                    if(SabanSounds) SabanSounds.playMessage();
                }

                // ×”×—×œ×¤×ª ××©×ª× ×™× ×‘×ª×©×•×‘×” (×©× ×”×œ×§×•×—)
                const personalizedAnswer = rule.answer.replace("{name}", this.user.name || "×—×‘×¨");

                return { 
                    text: personalizedAnswer, 
                    buttons: rule.buttons || [],
                    action: rule.action || null,
                    category: rule.category
                };
            }
        }

        // Fallback: ×× ×”×‘×•×˜ ×œ× ×”×‘×™×Ÿ
        // ××©×—×§ ××•×ª×” "×—×•×©×‘" ×•×©×•×œ×— ×œ×¨××™ ×œ×‘×“×•×§
        await SabanPush.send('admin_rami', 'ğŸ¤” ×”×‘×•×˜ ×¦×¨×™×š ×¢×–×¨×”', `×©××œ×” ×-${this.user.name}: "${question}"`);
        
        return { 
            text: "×©××œ×” ×˜×•×‘×”... ×× ×™ ×‘×•×“×§ ××ª ×–×” ×¨×’×¢ ××•×œ ×¨××™/××•×¨×Ÿ ×•×—×•×–×¨ ××œ×™×š ×¢× ×ª×©×•×‘×” ××“×•×™×§×ª. â³\n(××™×“ ××™×ª×š...)", 
            action: "fallback" 
        };
    }
}
