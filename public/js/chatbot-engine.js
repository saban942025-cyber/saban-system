// public/js/chatbot-engine.js
import { SabanPush } from './notifications.js';
import { SabanSounds } from './sounds.js';

export class SabanChatbot {
    constructor(db, userContext) {
        this.db = db;
        this.user = userContext; 
        
        this.rules = [
            // --- ×˜×¨×™×’×¨ ×—×™×¨×•×: ×©×™× ×•×™ ×”×–×× ×” (×”×›×™ ×—×©×•×‘!) ---
            {
                keywords: ["×œ×”×•×¡×™×£", "×œ×©× ×•×ª", "×œ×”×’×“×™×œ", "×˜×¢×•×ª", "×¢×¦×•×¨", "×©×™× ×•×™ ×”×–×× ×”"],
                answer: "ğŸ›‘ ×¢×¦×¨×ª×™ ××ª ×”×˜×™×¤×•×œ ×‘×”×–×× ×”! \n×ª×™×™×’×ª×™ ××ª ×”××—×¡× ××™ (××•×¨×Ÿ) ×•××ª ×¨××™ ×œ××§×¨×” ×“×—×•×£.\n×× × ×¨×©×•× ×›××Ÿ ××” ×‘×“×™×•×§ ×œ×”×•×¡×™×£/×œ×©× ×•×ª?",
                action: "stop_order_alert"
            },
            // --- ×–×™×”×•×™ ×”×–×× ×•×ª ---
            {
                keywords: ["×”×–×× ×”", "×œ×”×–××™×Ÿ", "×ª×©×œ×—", "××œ×˜", "×—×•×œ", "×‘×œ×•×ª", "×˜×™×˜", "×“×‘×§", "×’×‘×¡", "×‘×œ×•×§×™×", "×‘×¨×–×œ"],
                answer: "×§×™×‘×œ×ª×™ ××ª ×”×¨×©×™××”! ğŸ“\n×× ×™ ××¢×‘×™×¨ ××•×ª×” ××™×“ ×œ×¦×•×•×ª (×¨××™/×™×•××‘) ×œ×”×§×œ×“×” ×‘×§×•××§×¡.\n××¡×¤×¨ ×”×–×× ×” ×•×§×•×‘×¥ PDF ×™×©×œ×—×• ××œ×™×š ×œ××™×©×•×¨ ×‘×¨×’×¢ ×©×–×” ×™×”×™×” ××•×›×Ÿ.",
                action: "order_received"
            },
            // --- ×œ×•×’×™×¡×˜×™×§×” ---
            {
                keywords: ["×× ×•×£", "×§×•××”", "×’×’", "×œ×”×¨×™×", "××©××™×ª"],
                answer: "××™×Ÿ ×‘×¢×™×”, × ×¡×¤×§ ×¢× ×× ×•×£ (×—×›××ª/×××™×¨). ğŸ—ï¸\n×¨×§ ×ª×•×•×“× ×©××™×Ÿ ×—×•×˜×™ ×—×©××œ ×‘×’×™×©×” ×•×©××©×˜×— ×”×¤×¨×™×§×” ×¤× ×•×™.",
                buttons: [{ label: "×××©×¨ ×’×™×©×” ×ª×§×™× ×” âœ…", payload: "crane_ok" }]
            },
            // --- ×—×™×¨×•× ---
            {
                keywords: ["×“×—×•×£", "×‘×”×•×œ", "×¢×›×©×™×•", "×ª×§×•×¢", "×ª×§×œ×”", "×œ× ×”×’×™×¢"],
                answer: "×”×‘× ×ª×™ ×©×–×” ×“×—×•×£! ğŸš¨\n×”×§×¤×¦×ª×™ ×”×ª×¨××” ××™×•×—×“×ª ×œ×× ×”×œ ×”×ª×¤×¢×•×œ. ××™×ª×š ×ª×•×š ×“×§×•×ª.",
                action: "urgent_alert"
            },
            // --- ×‘×™×¨×•×¨ ×–×× ×™× ---
            {
                keywords: ["××ª×™", "×¦×¤×™", "××’×™×¢", "×©×¢×”"],
                answer: "×”××©××™×ª ×‘×¡×™×“×•×¨ ×¢×‘×•×“×”. ğŸšš\n×× ×™ ×‘×•×“×§ ××™×§×•× ××•×œ ×”× ×”×’ (GPS) ×•×©×•×œ×— ×œ×š ×¢×“×›×•×Ÿ ××™×“.",
                action: "check_eta"
            },
            // --- ×”×™×ª×¨×™× ---
            {
                keywords: ["×”×¨×¦×œ×™×”", "×¤×™×ª×•×—", "×ª×œ ××‘×™×‘"],
                answer: "ğŸ›‘ ×©×™× ×œ×‘: ×‘××–×•×¨ ×”×–×” ×”×¢×™×¨×™×™×” ×“×•×¨×©×ª ×”×™×ª×¨ ×›× ×™×¡×”/×”×¢××“×”.\n×™×© ×œ×š ×”×™×ª×¨ ×‘×ª×•×§×£?",
                buttons: [{ label: "×›×Ÿ, ×™×© ×œ×™ ğŸ‘", payload: "permit_yes" }, { label: "×œ×, ×ª×‘×“×§×• ×œ×™ â“", payload: "permit_no" }]
            },
            // --- ×›×œ×œ×™ ---
            {
                keywords: ["×”×™×™", "×©×œ×•×", "×‘×•×§×¨ ×˜×•×‘", "×¢×¨×‘ ×˜×•×‘", "××”×œ×Ÿ"],
                answer: "××”×œ×Ÿ {name}! ×›××Ÿ ×”×‘×•×˜ ×©×œ ×¡×‘×Ÿ. ğŸ‘‹\n××¤×©×¨ ×œ×”×§×œ×™×“ ×›××Ÿ ×”×–×× ×”, ×œ×‘×§×© ×©×™× ×•×™, ××• ×œ×©××•×œ ××ª×™ ××’×™×¢.",
                buttons: [{ label: "×”×“×‘×§ ×”×–×× ×”", payload: "paste_order" }]
            }
        ];
    }

    async ask(question) {
        if (!question) return null;
        const cleanQ = question.toLowerCase();

        for (const rule of this.rules) {
            const match = rule.keywords.some(kw => cleanQ.includes(kw));
            
            if (match) {
                console.log("âœ… Bot Match:", rule.keywords[0]);
                
                // ×˜×™×¤×•×œ ×‘×¡××•× ×“ ×•×”×ª×¨××•×ª
                if (rule.action === 'stop_order_alert' || rule.action === 'urgent_alert') {
                    SabanSounds.playAlert(); // ğŸ”Š ×¦×¤×¦×•×£ ×—×–×§
                    // ×©×œ×™×—×ª ×”×ª×¨××•×ª ×œ×× ×”×œ×™×
                    await SabanPush.send('admin_rami', 'ğŸ›‘ ×¢×¦×•×¨ ×œ×™×§×•×˜!', `×”×œ×§×•×— ${this.user.name} ×‘×™×§×© ×©×™× ×•×™ ×“×—×•×£!`);
                } else {
                    SabanSounds.playMessage(); // ğŸµ ×¦×œ×™×œ ×¨×’×™×œ
                }

                const finalText = rule.answer.replace("{name}", this.user.name || "×—×‘×¨");
                
                return { 
                    text: finalText, 
                    buttons: rule.buttons || [],
                    action: rule.action || null
                };
            }
        }

        return { 
            text: "×§×™×‘×œ×ª×™. ×”×”×•×“×¢×” ×”×•×¢×‘×¨×” ×œ× ×¦×™×’ ×× ×•×©×™ ×œ×”××©×š ×˜×™×¤×•×œ. ğŸ‘¨â€ğŸ’»",
            action: "fallback"
        };
    }
}
