<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title> 注专转 住</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #f8fafc; font-family: -apple-system, sans-serif; padding: 20px; color: #334155; }

        /* 转专转 住拽砖 */
        .section-title { 
            font-size: 14px; font-weight: 800; color: #64748b; text-transform: uppercase; 
            margin-bottom: 12px; display: flex; align-items: center; gap: 8px; 
            border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;
        }

        /* --- 注爪 转拽转 住 (Inbox) --- */
        .doc-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 16px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
            transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .doc-card:hover { border-color: #3b82f6; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

        .doc-icon {
            width: 40px; height: 40px; background: #fee2e2; color: #dc2626;
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; flex-shrink: 0; margin-left: 15px;
        }

        /* --- 注爪 砖 (Active Transfer) --- */
        .transfer-row {
            background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px;
            border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between;
            position: relative; overflow: hidden;
        }
        .transfer-row.active { border-left: 4px solid #22c55e; }

        .wh-badge {
            font-size: 12px; font-weight: bold; background: #f1f5f9; color: #475569;
            padding: 6px 12px; border-radius: 6px; border: 1px solid #cbd5e1;
            display: flex; align-items: center; gap: 6px; z-index: 2;
        }
        
        /* 砖 专 */
        .snake-path { flex: 1; height: 4px; background: #e2e8f0; margin: 0 15px; position: relative; border-radius: 2px; }
        .snake-head {
            position: absolute; top: 0; bottom: 0; width: 30%;
            background: linear-gradient(90deg, transparent, #22c55e, transparent);
            animation: snakeRun 2s infinite linear;
        }
        @keyframes snakeRun { 0% {left: -30%} 100% {left: 100%} }

        /* 驻转专 */
        .btn-action {
            padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: bold;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .btn-blue { background: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }
        .btn-blue:hover { background: #dbeafe; }
        .btn-green { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        .btn-green:hover { background: #dcfce7; }

    </style>
</head>
<body>

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl font-black text-slate-800"> 注专转</h1>
            <p class="text-sm text-gray-500">转转 住 住 住住 爪注</p>
        </div>
        <div class="flex gap-2">
            <span class="bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full flex items-center gap-2">
                <i class="fas fa-sync fa-spin"></i>  
            </span>
        </div>
    </div>

    <div class="section-title">
        <i class="fas fa-inbox"></i> 住 砖转拽 (转 砖抓)
    </div>
    <div id="docs-inbox" class="mb-8">
        <div class="text-center py-8 text-gray-400 text-sm"> 住 砖 爪...</div>
        </div>

    <div class="section-title">
        <i class="fas fa-truck-loading"></i> 注专转 爪注 (注/转)
    </div>
    <div id="active-transfers">
        </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, where, onSnapshot, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // 1.  住 住 (Inbox Logic)
        // 住 砖注   注  砖 (住住 waiting_approval)
        const qDocs = query(collection(db, "transfers"), where("status", "==", "waiting_approval"));
        
        onSnapshot(qDocs, (snap) => {
            const container = document.getElementById('docs-inbox');
            if(snap.empty) {
                container.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm italic border-2 border-dashed border-gray-200 rounded-xl"> 转拽 专拽 -  住 砖</div>`;
                return;
            }
            
            container.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                const senderName = t.emailSender ? t.emailSender.split('@')[0] : ' 注';
                
                container.innerHTML += `
                <div class="doc-card">
                    <div class="flex items-center">
                        <div class="doc-icon"><i class="fas fa-file-pdf"></i></div>
                        <div class="ml-4">
                            <div class="font-bold text-slate-800">转注 #${t.comaxNum || ' 住驻专'}</div>
                            <div class="text-xs text-gray-500 flex items-center gap-2 mt-1">
                                <img src="https://ui-avatars.com/api/?name=${senderName}&background=random" class="w-4 h-4 rounded-full">
                                <span>转拽 : <b>${senderName}</b></span>
                                <span class="text-gray-300">|</span>
                                <span>${new Date(t.createdAt?.seconds*1000).toLocaleTimeString().slice(0,5)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="window.open('${t.pdfUrl}')" class="btn-blue">
                            <i class="fas fa-eye"></i> 爪驻
                        </button>
                        
                        <button onclick="discussInGroup('${t.comaxNum}', '${t.pdfUrl}', '${t.items}')" class="btn-blue">
                            <i class="fas fa-comments"></i>  拽爪
                        </button>
                        
                        <button onclick="assignTask('${d.id}', '${t.comaxNum}', '${t.items}')" class="btn-green">
                            <i class="fas fa-tasks"></i> 驻转 砖
                        </button>
                    </div>
                </div>`;
            });
        });

        // 2.  注专转 驻注转 (Snake Logic)
        const qActive = query(collection(db, "transfers"), where("status", "==", "processing"));
        
        onSnapshot(qActive, (snap) => {
            const container = document.getElementById('active-transfers');
            container.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                container.innerHTML += `
                <div class="transfer-row active">
                    <div class="wh-badge"><i class="fas fa-warehouse"></i> ${t.fromBranch || '拽专'}</div>
                    
                    <div class="snake-path">
                        <div class="snake-head"></div>
                        <div class="absolute -top-5 left-1/2 transform -translate-x-1/2 text-[10px] font-bold text-green-600 bg-green-50 px-2 rounded border border-green-100">
                            ${t.driverId === 'ali_01' ? '注 爪注' : '专 注'}
                        </div>
                    </div>
                    
                    <div class="wh-badge"><i class="fas fa-building"></i> ${t.toBranch || '注'}</div>
                    
                    <div class="mr-4 text-right min-w-[120px]">
                        <div class="font-bold text-sm text-slate-800">转注 ${t.comaxNum}</div>
                        <div class="text-xs text-gray-500">${t.items}</div>
                    </div>
                </div>`;
            });
        });

        // --- 驻注转 ---

        // A.  拽爪 (砖转 注 ")
        window.discussInGroup = async (docNum, url, items) => {
            const { value: text } = await Swal.fire({
                title: '转 拽爪转 住专',
                input: 'text',
                inputPlaceholder: '砖: @注 转住转 注 转注 ...',
                showCancelButton: true,
                confirmButtonText: '砖 拽爪'
            });

            if (text) {
                // 住驻转 注 拽拽砖 砖 爪' (驻注 orders 砖砖 爪' 专注  messages)
                // 砖转砖 -transfers  注 砖转 ,  砖 专注
                // 爪专 , 驻转 转 砖 砖
                Swal.fire('砖', '注 砖 拽爪 注 拽 住', 'success');
                //  砖 住祝 拽 砖转转 -messages collection  拽
            }
        };

        // B. 驻转转 砖 (砖 )
        window.assignTask = async (docId, docNum, defaultItems) => {
            const { value: form } = await Swal.fire({
                title: `驻转转 砖 转注 ${docNum}`,
                html: `
                    <div class="text-right text-sm mb-2 text-gray-500">专转 住 </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <select id="swal-from" class="swal2-select m-0 text-sm"><option value="专砖">专砖</option><option value="转">转</option></select>
                        <select id="swal-to" class="swal2-select m-0 text-sm"><option value="转">转</option><option value="专砖">专砖</option><option value="拽">拽</option></select>
                    </div>
                    <select id="swal-driver" class="swal2-select w-full mb-2 text-sm">
                        <option value="ali_01">注 (驻)</option>
                        <option value="hichmat_01">转 (祝)</option>
                    </select>
                `,
                focusConfirm: false,
                confirmButtonText: '砖专  ',
                preConfirm: () => {
                    return {
                        from: document.getElementById('swal-from').value,
                        to: document.getElementById('swal-to').value,
                        driver: document.getElementById('swal-driver').value
                    }
                }
            });

            if (form) {
                // 注 住 住住 "爪注" (processing)  砖注专 转 专砖转 砖
                await updateDoc(doc(db, "transfers", docId), {
                    status: 'processing',
                    fromBranch: form.from,
                    toBranch: form.to,
                    driverId: form.driver,
                    startTime: serverTimestamp()
                });
                
                Swal.fire('爪注', '砖 注专  砖 爪 专', 'success');
            }
        };

    </script>
</body>
</html>
