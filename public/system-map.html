<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Tactical Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .overlay { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 250px; }
        .driver-row { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="overlay">
        <h3 class="font-bold text-gray-700 mb-2 border-b pb-1">סטטוס צי רכב</h3>
        <div id="drivers-list">
            <div class="text-gray-400 text-xs">טוען נתונים...</div>
        </div>
    </div>

    <div id="map"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // Init Map (Center on Hod HaSharon)
        const map = L.map('map').setView([32.1624, 34.8447], 13);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'Saban Systems'
        }).addTo(map);

        // Icons
        const truckIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/741/741407.png',
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });

        // Store markers
        const markers = {};

        // Listen to Real-Time Locations
        onSnapshot(collection(db, "drivers_location"), (snap) => {
            const listEl = document.getElementById('drivers-list');
            listEl.innerHTML = '';

            snap.forEach(doc => {
                const d = doc.data();
                
                // Update List
                const lastUpdate = d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleTimeString() : '...';
                const isActive = (Date.now() - (d.timestamp?.seconds*1000 || 0)) < 300000; // 5 min timeout
                const color = isActive ? 'bg-green-500' : 'bg-gray-400';

                listEl.innerHTML += `
                <div class="driver-row">
                    <div><span class="status-dot ${color}"></span> <b>${d.name}</b></div>
                    <span class="text-xs text-gray-500">${lastUpdate}</span>
                </div>`;

                // Update Map Marker
                if (d.lat && d.lng) {
                    if (markers[doc.id]) {
                        // Move existing
                        markers[doc.id].setLatLng([d.lat, d.lng]);
                    } else {
                        // Create new
                        const m = L.marker([d.lat, d.lng], {icon: truckIcon}).addTo(map)
                            .bindPopup(`<b>${d.name}</b><br>עודכן: ${lastUpdate}`);
                        markers[doc.id] = m;
                    }
                }
            });
        });

    </script>
</body>
</html>
