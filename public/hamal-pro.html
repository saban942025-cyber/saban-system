<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Saban Hamal PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0f172a; color: white; height: 100vh; overflow: hidden; font-family: sans-serif; }
        .sidebar { width: 300px; background: #1e293b; border-left: 1px solid #334155; display: flex; flex-direction: column; }
        .main-area { flex: 1; display: flex; flex-direction: column; background: #0f172a; }
        .order-item { padding: 15px; border-bottom: 1px solid #334155; cursor: pointer; transition: 0.2s; }
        .order-item:hover, .order-item.active { background: #334155; border-right: 4px solid #3b82f6; }
        .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        
        /* Timeline */
        .timeline-item { position: relative; padding-right: 20px; border-right: 2px solid #334155; padding-bottom: 20px; }
        .timeline-item::after { content: ''; position: absolute; right: -5px; top: 0; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; }
        .timeline-item.active { border-color: #22c55e; }
        .timeline-item.active::after { background: #22c55e; box-shadow: 0 0 5px #22c55e; }
    </style>
</head>
<body class="flex">

    <div class="sidebar">
        <div class="p-4 border-b border-gray-700 font-bold text-xl flex justify-between items-center">
            <span>×—×"×œ ×¡×‘×Ÿ ğŸ›¡ï¸</span>
            <button onclick="manualSync()" class="text-xs bg-slate-700 hover:bg-slate-600 p-2 rounded text-blue-300" title="×¡× ×›×¨×Ÿ ××™×™×œ×™× ××§×•××§×¡">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div class="p-2">
            <input type="text" placeholder="×—×¤×© ×”×–×× ×” / ×œ×§×•×—..." class="w-full bg-slate-900 border border-slate-700 p-2 rounded text-sm text-white outline-none">
        </div>
        <div id="orders-list" class="flex-1 overflow-y-auto">
            </div>
    </div>

    <div class="main-area relative">
        <div id="empty-state" class="flex flex-col items-center justify-center h-full opacity-30">
            <i class="fas fa-truck-loading text-6xl mb-4"></i>
            <h2 class="text-2xl">×‘×—×¨ ×”×–×× ×” ×œ×˜×™×¤×•×œ</h2>
        </div>

        <div id="detail-view" class="hidden h-full flex flex-col">
            <div class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold" id="view-client">...</h2>
                    <div class="text-sm opacity-60">×”×–×× ×”: <span id="view-id">...</span> | <span id="view-status">...</span></div>
                </div>
                <div class="flex gap-3">
                    <button class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded font-bold shadow" onclick="approveOrder()">
                        <i class="fas fa-check-double"></i> ××©×¨ ×”×¢××¡×”
                    </button>
                </div>
            </div>

            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/3 p-6 border-l border-slate-700 overflow-y-auto bg-slate-900/50">
                    <h3 class="font-bold text-lg mb-6 text-blue-400">×¦×™×¨ ×”×–××Ÿ</h3>
                    
                    <div id="timeline-container" class="pr-2">
                        </div>

                    <div class="mt-8 p-4 bg-slate-800 rounded-xl border border-slate-700">
                        <h4 class="font-bold mb-2 text-sm text-gray-400">×¤×¨×˜×™ ×”×–×× ×”</h4>
                        <div id="order-details" class="text-sm space-y-2"></div>
                    </div>
                </div>

                <div class="flex-1 bg-slate-900 p-4 flex flex-col">
                    <div id="pdf-viewer" class="flex-1 bg-slate-800 rounded-xl border-2 border-dashed border-slate-600 flex items-center justify-center text-slate-500 relative overflow-hidden">
                        <div class="text-center">
                            <i class="fas fa-file-pdf text-4xl mb-2"></i>
                            <p>××™×Ÿ ××¡××š ××§×•××§×¡</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { SabanBrain } from './js/saban-brain.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        let currentOrder = null;

        // Sync Comax Button
        window.manualSync = async () => {
            alert("××ª×—×™×œ ×¡× ×›×¨×•×Ÿ ××•×œ ×’×©×¨ ×§×•××§×¡...");
            const res = await SabanBrain.syncComax();
            console.log(res); // ×”×œ×•×’ ×™×•×¤×™×¢ ×‘×§×•× ×¡×•×œ
        };

        // Load Orders
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => {
            const list = document.getElementById('orders-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                const isActive = currentOrder && currentOrder.id === d.id ? 'active' : '';
                const badgeColor = o.status === 'done' ? 'bg-green-500' : (o.pdfUrl ? 'bg-yellow-500' : 'bg-blue-600');
                
                list.innerHTML += `
                <div class="order-item ${isActive}" onclick="selectOrder('${d.id}')">
                    <div class="flex justify-between mb-1">
                        <span class="font-bold truncate">${o.clientName}</span>
                        <span class="status-badge ${badgeColor} text-black">${o.status}</span>
                    </div>
                    <div class="text-xs opacity-50 flex justify-between">
                        <span>#${o.orderNum || '---'}</span>
                        <span>${new Date(o.createdAt?.seconds * 1000).toLocaleTimeString().slice(0,5)}</span>
                    </div>
                </div>`;
                
                // Real-time update if selected
                if(currentOrder && currentOrder.id === d.id) renderDetail({id: d.id, ...o});
            });
        });

        window.selectOrder = (id) => {
            // Find data from cache (simplified)
            // In real app we use the snapshot data directly
            const item = document.querySelector(`.order-item[onclick="selectOrder('${id}')"]`);
            if(item) {
                document.querySelectorAll('.order-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
            }
        };

        // Helper to render details (called by snapshot)
        function renderDetail(o) {
            currentOrder = o;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');
            
            document.getElementById('view-client').innerText = o.clientName;
            document.getElementById('view-id').innerText = o.orderNum || '---';
            document.getElementById('view-status').innerText = o.status;
            
            // Render Timeline
            const tl = document.getElementById('timeline-container');
            const s1 = 'active', s2 = o.comaxNum ? 'active' : '', s3 = o.pdfUrl ? 'active' : '', s4 = o.status === 'done' ? 'active' : '';
            
            tl.innerHTML = `
                <div class="timeline-item ${s1}">
                    <div class="font-bold text-sm">×”×ª×§×‘×œ×” ×”×–×× ×”</div>
                    <div class="text-xs opacity-50">××”××¤×œ×™×§×¦×™×”</div>
                </div>
                <div class="timeline-item ${s2}">
                    <div class="font-bold text-sm">×”×§×œ×“×” ×‘×§×•××§×¡</div>
                    <div class="text-xs opacity-50">${o.comaxNum ? '××¡: ' + o.comaxNum : '×××ª×™×Ÿ...'}</div>
                </div>
                <div class="timeline-item ${s3}">
                    <div class="font-bold text-sm">××¡××š PDF</div>
                    <div class="text-xs opacity-50">${o.pdfUrl ? '×”×ª×§×‘×œ' : '×××ª×™×Ÿ ×œ××™×™×œ...'}</div>
                </div>
                <div class="timeline-item border-none ${s4}">
                    <div class="font-bold text-sm">×¡×™×•×</div>
                    <div class="text-xs opacity-50">×”×¢××¡×” ××•×©×¨×”</div>
                </div>
            `;

            // PDF Viewer
            const pdfView = document.getElementById('pdf-viewer');
            if(o.pdfUrl) {
                pdfView.innerHTML = `<iframe src="${o.pdfUrl}" class="w-full h-full border-none"></iframe>`;
            } else {
                pdfView.innerHTML = `<div class="text-center"><i class="fas fa-file-pdf text-4xl mb-2"></i><p>××™×Ÿ ××¡××š</p></div>`;
            }
        }

        window.approveOrder = async () => {
            if(!currentOrder) return;
            if(confirm("×œ××©×¨ ×”×¢××¡×” ×œ×”×–×× ×” ×–×•?")) {
                await updateDoc(doc(db, "orders", currentOrder.id), { status: 'done' });
            }
        };
    </script>
</body>
</html>
