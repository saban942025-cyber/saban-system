<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Logistics | ××•×¨×Ÿ (×—×¦×¨)</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background: #1e293b; color: white; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Start Overlay */
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-start { background: #f59e0b; color: #000; font-size: 24px; font-weight: 900; padding: 20px 40px; border-radius: 15px; border: 4px solid #d97706; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Header */
        .top-bar { background: #0f172a; padding: 15px; border-bottom: 2px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        
        /* Orders List */
        .orders-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Order Card */
        .order-card { background: #334155; border-radius: 12px; overflow: hidden; border-right: 6px solid #94a3b8; animation: slideIn 0.3s ease-out; }
        .card-new { border-color: #ef4444; background: #2a1b1b; } /* ××“×•× - ×—×“×© */
        .card-picking { border-color: #f59e0b; background: #292524; } /* ×›×ª×•× - ×‘×œ×™×§×•×˜ */
        
        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .card-body { padding: 15px; font-size: 15px; color: #cbd5e1; }
        .card-actions { padding: 10px; display: flex; gap: 10px; }

        /* Buttons */
        .btn-action { flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-pick { background: #f59e0b; color: black; }
        .btn-call { background: #10b981; color: white; }
        .btn-done { background: #3b82f6; color: white; }
        
        .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="start-overlay">
        <div class="mb-4 text-4xl">ğŸ—ï¸</div>
        <div class="mb-6 text-2xl font-bold">××¢×¨×›×ª ×—×¦×¨ - ××•×¨×Ÿ</div>
        <button class="btn-start" onclick="startShift()">×¤×ª×— ××©××¨×ª</button>
    </div>

    <div class="top-bar">
        <div>
            <div class="text-xs text-gray-400">×× ×”×œ ×—×¦×¨</div>
            <div class="font-bold text-xl">××•×¨×Ÿ</div>
        </div>
        <div class="bg-blue-900 px-3 py-1 rounded text-xs font-mono text-blue-200">
            ×¡× ×™×£ ×”×—×¨×©
        </div>
    </div>

    <div id="orders-list" class="orders-container">
        <div class="text-center text-gray-500 mt-10">
            <i class="fas fa-boxes text-4xl mb-4 opacity-50"></i>
            <div>×××ª×™×Ÿ ×œ×”×–×× ×•×ª...</div>
        </div>
    </div>

    <audio id="sound-new" src="https://actions.google.com/sounds/v1/alarms/mechanical_clock_ring.ogg"></audio>
    <audio id="sound-horn" src="https://actions.google.com/sounds/v1/transportation/car_horn.ogg"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, doc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // START
        window.startShift = () => {
            document.getElementById('sound-new').play().then(() => {
                document.getElementById('sound-new').pause();
            }).catch(()=>{});
            document.getElementById('start-overlay').style.display = 'none';
        };

        // --- LISTENER ---
        // ××•×¨×Ÿ ×¨×•××” ×”×–×× ×•×ª ×‘×¡×˜×˜×•×¡: assigned (×—×“×© ×œ× ×”×’) ××• picking (×‘×œ×™×§×•×˜)
        const q = query(collection(db, "orders"), 
            where("status", "in", ["assigned", "picking", "en_route"]), // ×¨×•××” ×’× ××” ×©×‘×“×¨×š ×›×“×™ ×œ×“×¢×ª ×©×–×” ×™×¦×
            orderBy("createdAt", "desc")
        );

        onSnapshot(q, (snap) => {
            const container = document.getElementById('orders-list');
            container.innerHTML = '';

            if(snap.empty) {
                container.innerHTML = '<div class="text-center text-gray-500 mt-10">××™×Ÿ ×¢×‘×•×“×” ×›×¨×’×¢ â˜•</div>';
                return;
            }

            snap.forEach(docSnap => {
                const order = { id: docSnap.id, ...docSnap.data() };
                renderOrder(order, container);
            });
        });

        function renderOrder(order, container) {
            let statusColor = 'bg-gray-500';
            let statusText = '×××ª×™×Ÿ';
            let cardClass = '';
            let buttonsHtml = '';

            // LOGIC
            if (order.status === 'assigned') {
                statusColor = 'bg-red-500';
                statusText = '×—×“×© - ×××ª×™×Ÿ ×œ×œ×™×§×•×˜';
                cardClass = 'card-new';
                buttonsHtml = `
                    <button onclick="updateStatus('${order.id}', 'picking')" class="btn-action btn-pick">
                        <i class="fas fa-box-open"></i> ×”×ª×—×œ ×œ×™×§×•×˜
                    </button>
                `;
            } else if (order.status === 'picking') {
                statusColor = 'bg-orange-500';
                statusText = '×‘×ª×”×œ×™×š ×œ×™×§×•×˜';
                cardClass = 'card-picking';
                
                // ×›×¤×ª×•×¨ ×”×§×¨×™××” ×œ× ×”×’
                const driverName = order.driverId || '× ×”×’';
                buttonsHtml = `
                    <button onclick="callDriver('${order.driverId}', '${order.clientName}')" class="btn-action btn-call">
                        <i class="fas fa-bullhorn"></i> ×§×¨× ×œ${driverName}
                    </button>
                    <button onclick="updateStatus('${order.id}', 'en_route')" class="btn-action btn-done">
                        <i class="fas fa-truck-loading"></i> ×”×•×¢××¡
                    </button>
                `;
            } else if (order.status === 'en_route') {
                statusColor = 'bg-blue-500';
                statusText = '×™×¦× ×œ×“×¨×š';
                buttonsHtml = `<div class="text-center w-full text-green-400 font-bold py-2"><i class="fas fa-check"></i> ×˜×•×¤×œ</div>`;
            }

            const html = `
            <div class="order-card ${cardClass}">
                <div class="card-header">
                    <div>
                        <div class="text-xs text-gray-400">#${order.id.slice(-4)} | ${order.driverId}</div>
                        <div class="font-bold text-lg">${order.clientName}</div>
                    </div>
                    <span class="status-badge ${statusColor}">${statusText}</span>
                </div>
                <div class="card-body">
                    ${order.text}
                    <div class="mt-2 text-xs text-gray-500"><i class="fas fa-map-marker-alt"></i> ${order.address || '××™×Ÿ ×›×ª×•×‘×ª'}</div>
                </div>
                <div class="card-actions">
                    ${buttonsHtml}
                </div>
            </div>`;
            
            container.innerHTML += html;
        }

        // --- ACTIONS ---
        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, "orders", id), { 
                status: status, 
                lastUpdate: serverTimestamp() 
            });
        };

        // --- THE "CALL DRIVER" FEATURE ---
        window.callDriver = async (driverName, client) => {
            // 1. ×× ×’×Ÿ ×¦×¤×¦×•×£ ×œ××•×¨×Ÿ (××™×©×•×¨)
            document.getElementById('sound-horn').play();

            // 2. ×©×•×œ×— ×”×•×“×¢×” ×œ×¦'××˜ ×©×œ ×”× ×”×’ ×”×¡×¤×¦×™×¤×™
            // ×× ×—× ×• ×¦×¨×™×›×™× ×œ××¦×•× ××ª ×”-UID ×©×œ ×”× ×”×’. × × ×™×— ×›×¨×’×¢ ××™×¤×•×™ ×¤×©×•×˜ ××• × ×©×œ×— ×œ×›×•×œ× ×× ××™×Ÿ ××™×¤×•×™
            // ×‘××¢×¨×›×ª ×—×›××” ×™×•×ª×¨ ×”×™×™× ×• ×©×•××¨×™× ××ª ×”-UID ×‘×”×–×× ×”.
            // ×›×¨×’×¢ × ×©×ª××© ×‘×˜×¨×™×§: × ×©×œ×— ×”×•×“×¢×” ×œ×›×œ ×¢×¨×•×¦×™ ×”× ×”×’×™× ×”×¤×¢×™×œ×™× ××• × ×©×ª××© ×‘×©×.
            
            // ×¤×ª×¨×•×Ÿ ××”×™×¨ ×•×—×›×: ×™×¦×™×¨×ª "×”×•×“×¢×ª ××¢×¨×›×ª" ×‘×ª×•×š ×”×¦'××˜ ×©×œ ×”× ×”×’
            // × × ×™×— ×©×©× ×”× ×”×’ ×”×•× "×—×›××ª" -> × ×—×¤×© ××ª ×”×¦'××˜ ×©×œ×•.
            // ×œ×¦×•×¨×š ×”×“×•×’××, × ×©×œ×— ×”×ª×¨××” ×›×œ×œ×™×ª ××• × ×¢×“×›×Ÿ ××ª ×”×”×–×× ×” ×‘×¡×˜×˜×•×¡ ××™×•×—×“ ×©×”× ×”×’ ×××–×™×Ÿ ×œ×•.
            
            // ×©×™×˜×” ×‘': ×©×œ×™×—×ª ×”×•×“×¢×” ×“×¨×š ×”×–×× ×”
            // × ×¢×“×›×Ÿ ×©×“×” "alertDriver" ×‘×”×–×× ×”, ×•×”××¤×œ×™×§×¦×™×” ×©×œ ×”× ×”×’ ×ª××–×™×Ÿ ×œ×–×”
            
            // ××‘×œ ×”×›×™ ×¤×©×•×˜: ×©×œ×™×—×ª ×”×•×“×¢×” ×œ×¦'××˜ ×©×œ ×—×›××ª/×¢×œ×™
            // × × ×™×— ×©×™×© ×œ× ×• ××ª ×”×˜×œ×¤×•× ×™× ×©×œ×”× hardcoded ×›××Ÿ ×œ×¦×•×¨×š ×”×¤×©×˜×•×ª, ××• ×©× ×©×œ×— ×œ×•×’×™×§×” ×œ×¦×“ ×©×¨×ª
            
            let driverPhone = '';
            if(driverName.includes('×—×›××ª')) driverPhone = '0500000607';
            if(driverName.includes('×¢×œ×™')) driverPhone = '054-2276631'; // ×”××¡×¤×¨ ×”××¢×•×“×›×Ÿ ×©×œ ×¢×œ×™

            if(driverPhone) {
                await addDoc(collection(db, `chats/chat_${driverPhone}/messages`), {
                    text: `ğŸ“¢ **×§×¨×™××” ××”×¨××¤×” (××•×¨×Ÿ):** ×”×¡×—×•×¨×” ×œ-${client} ××•×›× ×”! ×’×© ×œ×”×¢××¡×”.`,
                    sender: '××•×¨×Ÿ (×—×¦×¨)',
                    timestamp: serverTimestamp()
                });
                
                Swal.fire({
                    title: '×”× ×”×’ ×§×™×‘×œ ×§×¨×™××”!',
                    text: `×”×•×“×¢×” × ×©×œ×—×” ×œ${driverName}`,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire('×©×’×™××”', '×œ× × ××¦× ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×”×’ ×–×”', 'error');
            }
        };

    </script>
</body>
</html>
