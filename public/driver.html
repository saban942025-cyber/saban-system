<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Driver | ×¢×œ×™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #1e293b; color: white; font-family: 'Heebo', sans-serif; }
        .card { background: #334155; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #475569; }
        .btn-drive { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            width: 100%; padding: 20px; border-radius: 20px; 
            font-size: 24px; font-weight: 900; 
            box-shadow: 0 10px 30px -5px rgba(59, 130, 246, 0.5);
            transition: transform 0.2s;
        }
        .btn-drive:active { transform: scale(0.95); }
        .btn-drive.active { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 10px 30px -5px rgba(239, 68, 68, 0.5); }
        
        .pulse-dot { display: inline-block; width: 10px; height: 10px; background: #4ade80; border-radius: 50%; box-shadow: 0 0 10px #4ade80; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="p-4 flex flex-col h-screen">

    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-black">×©×œ×•×, ×¢×œ×™ ğŸš›</h1>
            <p class="text-slate-400 text-sm">× ×”×’ ×§×• - ×¡×‘×Ÿ ×œ×•×’×™×¡×˜×™×§×”</p>
        </div>
        <div class="bg-slate-700 p-2 rounded-full"><img src="https://cdn-icons-png.flaticon.com/512/713/713311.png" class="w-8 h-8"></div>
    </div>

    <div id="currentTask" class="card hidden">
        <div class="text-xs text-orange-400 font-bold uppercase mb-2">××©×™××” ×¤×¢×™×œ×”</div>
        <div class="text-xl font-bold mb-1" id="taskTitle">×”×¢×‘×¨×”: ××œ×˜ ×œ×‘×Ÿ</div>
        <div class="text-slate-300 text-sm flex gap-2 items-center">
            <i class="fas fa-map-marker-alt"></i> <span id="taskRoute">×”×—×¨×© -> ×ª×œ××™×“</span>
        </div>
    </div>

    <div class="mt-auto mb-10">
        <div id="statusText" class="text-center mb-4 text-slate-400 font-bold">×××ª×™×Ÿ ×œ×”×•×¨××”...</div>
        <button id="driveBtn" onclick="toggleDrive()" class="btn-drive">
            <i class="fas fa-play"></i> ×”×ª×—×œ × ×¡×™×¢×”
        </button>
        <p class="text-center text-xs text-slate-600 mt-4">* ×‘××¦×‘ ×“××• ×”××™×§×•× ××“×•××”</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, updateDoc, onSnapshot, query, collection, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ××–×”×” ×”× ×”×’ (×‘××¢×¨×›×ª ×××™×ª×™×ª ×–×” ××’×™×¢ ××”-Login)
        // ×œ×¦×•×¨×š ×”×“××•, ×× ×—× ×• × ×—×¤×© ××ª ×”××©×ª××© ×”×¨××©×•×Ÿ ×©×”×•× "× ×”×’" ××• ×©× ×™×¦×•×¨ ××—×“ ×–×× ×™
        let driverId = null;
        let isDriving = false;
        let driveInterval = null;

        // × ×ª×™×‘ ×“××• (×”×—×¨×© -> ×”×ª×œ××™×“)
        const path = [
            {lat: 32.2630, lng: 34.9750}, {lat: 32.2640, lng: 34.9740}, {lat: 32.2650, lng: 34.9730},
            {lat: 32.2660, lng: 34.9720}, {lat: 32.2670, lng: 34.9730}, {lat: 32.2680, lng: 34.9750},
            {lat: 32.2690, lng: 34.9780}, {lat: 32.2700, lng: 34.9800} 
        ];
        let pathIndex = 0;

        // 1. ××ª×—×•×œ - ××¦×™××ª ×”× ×”×’
        (async () => {
            // ×”××–× ×” ×œ××©×™××•×ª ×©× ×¤×ª×—×• ×¢×‘×•×¨ "×¢×œ×™" ××• "× ×”×’"
            onSnapshot(query(collection(db, "transfers"), where("status", "==", "open")), (snap) => {
                if(!snap.empty) {
                    const task = snap.docs[0].data();
                    document.getElementById('currentTask').classList.remove('hidden');
                    document.getElementById('taskTitle').innerText = `×”×¢×‘×¨×”: ${task.comaxNum}`;
                    document.getElementById('taskRoute').innerText = task.direction === 'harash_to_talmid' ? '×”×—×¨×© â¬… ×ª×œ××™×“' : '×ª×œ××™×“ â¬… ×”×—×¨×©';
                }
            });

            // ××¦×™××ª ×”-ID ×©×œ ×”× ×”×’ ××”-LocalStorage ××• ×—×™×¤×•×©
            const savedUser = localStorage.getItem('saban_user');
            if(savedUser) {
                const u = JSON.parse(savedUser);
                if(u.role === 'driver') driverId = u.uid;
            }
            
            // ×× ××™×Ÿ × ×”×’ ××—×•×‘×¨, × ×‘×§×© ××”××©×ª××© (×œ×¦×•×¨×š ×‘×“×™×§×”)
            if(!driverId) {
                // ×¨×§ ×œ×“××• - × × ×™×— ×©×™×© × ×”×’ ×§×™×™× ×‘××¢×¨×›×ª, ×ª×¦×˜×¨×š ×œ×•×•×“× ×©×™×¦×¨×ª ××©×ª××© × ×”×’ ×‘-setup.html
                console.log("×××ª×™×Ÿ ×œ×–×™×”×•×™ × ×”×’...");
            }
        })();

        window.toggleDrive = () => {
            if(!driverId) {
                alert("×©×’×™××”: ×¢×œ×™×š ×œ×”×ª×—×‘×¨ ×›× ×”×’ ×“×¨×š ××¡×š ×”×›× ×™×¡×” ×ª×—×™×œ×”!");
                return;
            }

            const btn = document.getElementById('driveBtn');
            const status = document.getElementById('statusText');

            if (!isDriving) {
                // ×”×ª×—×œ×ª × ×¡×™×¢×”
                isDriving = true;
                btn.innerHTML = '<i class="fas fa-stop"></i> ×¡×™×™× × ×¡×™×¢×”';
                btn.classList.add('active');
                status.innerHTML = '<span class="pulse-dot"></span> ××©×“×¨ ××™×§×•× ×‘×–××Ÿ ×××ª';
                
                // ×¡×™××•×œ×¦×™×™×ª GPS
                pathIndex = 0;
                driveInterval = setInterval(async () => {
                    if (pathIndex >= path.length) pathIndex = 0; // ×œ×•×œ××”
                    
                    const loc = path[pathIndex];
                    pathIndex++;

                    // ×¢×“×›×•×Ÿ ×”××™×§×•× ×‘-Firebase
                    await updateDoc(doc(db, "users", driverId), {
                        location: { lat: loc.lat, lng: loc.lng, speed: Math.floor(Math.random() * 20) + 60 },
                        lastSeen: serverTimestamp()
                    });

                }, 2000); // ×¢×“×›×•×Ÿ ×›×œ 2 ×©× ×™×•×ª

            } else {
                // ×¢×¦×™×¨×”
                isDriving = false;
                clearInterval(driveInterval);
                btn.innerHTML = '<i class="fas fa-play"></i> ×”×ª×—×œ × ×¡×™×¢×”';
                btn.classList.remove('active');
                status.innerText = '×××ª×™×Ÿ ×œ×”×•×¨××”...';
            }
        };
    </script>
</body>
</html>
