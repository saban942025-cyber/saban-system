<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabanOS | 专专</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-900 text-white flex flex-col h-screen items-center justify-center p-6">

    <div class="mb-8 relative">
        <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center text-4xl shadow-xl shadow-blue-500/50 z-10 relative">
            <i class="fas fa-truck-moving"></i>
        </div>
        <div id="pulse" class="absolute inset-0 bg-blue-500 rounded-full opacity-50 hidden"></div>
    </div>

    <h1 class="text-2xl font-bold mb-2">砖, 转</h1>
    <div id="status" class="text-gray-400 mb-8"> 砖专 拽 </div>

    <button id="toggleBtn" onclick="toggleShift()" class="w-full max-w-xs bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-xl shadow-lg transition transform active:scale-95">
        转 砖专转
    </button>

    <div class="mt-8 p-4 bg-slate-800 rounded-lg w-full max-w-xs text-xs font-mono text-gray-400">
        <div>Lat: <span id="lat">---</span></div>
        <div>Lng: <span id="lng">---</span></div>
        <div>Upd: <span id="lastUpd">---</span></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 专转 ID 拽注  (驻注 注 )
        const driverId = "driver_hikmat"; 
        let watchId = null;

        window.toggleShift = () => {
            const btn = document.getElementById('toggleBtn');
            const pulse = document.getElementById('pulse');
            
            if (!watchId) {
                // START
                if (!navigator.geolocation) return alert(" GPS 砖专 ");
                
                watchId = navigator.geolocation.watchPosition(updateLocation, handleError, {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                });

                btn.innerText = "住 砖专转";
                btn.className = "w-full max-w-xs bg-red-600 hover:bg-red-500 py-4 rounded-xl font-bold text-xl shadow-lg transition";
                document.getElementById('status').innerText = "砖专 拽  转 ";
                document.getElementById('status').className = "text-green-400 mb-8 font-bold animate-pulse";
                pulse.classList.remove('hidden');
                pulse.classList.add('animate-ping');
            } else {
                // STOP
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                btn.innerText = "转 砖专转";
                btn.className = "w-full max-w-xs bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-xl shadow-lg transition";
                document.getElementById('status').innerText = " 砖专 拽 ";
                document.getElementById('status').className = "text-gray-400 mb-8";
                pulse.classList.add('hidden');
                pulse.classList.remove('animate-ping');
            }
        };

        const updateLocation = async (position) => {
            const { latitude, longitude } = position.coords;
            
            document.getElementById('lat').innerText = latitude.toFixed(6);
            document.getElementById('lng').innerText = longitude.toFixed(6);
            document.getElementById('lastUpd').innerText = new Date().toLocaleTimeString();

            try {
                // 注 住住 转  转
                await updateDoc(doc(db, "users", driverId), {
                    location: { lat: latitude, lng: longitude },
                    lastActive: serverTimestamp(),
                    role: 'driver',
                    name: '转 ()'
                });
            } catch (e) { console.error("Error updating location", e); }
        };

        const handleError = (err) => {
            console.warn(`ERROR(${err.code}): ${err.message}`);
            alert("砖转 GPS:  砖转转 专砖转 拽");
        };
    </script>
</body>
</html>
