<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabanOS | × ×”×’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-900 text-white p-4 font-sans">
    
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-bold">××¡×•×¤×•×Ÿ × ×”×’ ğŸš›</h1>
        <div id="gpsStatus" class="bg-red-500 text-xs px-2 py-1 rounded animate-pulse">GPS ×× ×•×ª×§</div>
    </div>

    <div id="deliveries" class="space-y-4">
        <div class="text-center text-gray-500 mt-10">×˜×•×¢×Ÿ ××©×™××•×ª...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, updateDoc, doc, serverTimestamp, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        // ×”×’×“×¨×•×ª Firebase ×©×œ×š
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            
            // 1. ×©×™×“×•×¨ ××™×§×•× ×‘×–××Ÿ ×××ª
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((pos) => {
                    const status = document.getElementById('gpsStatus');
                    status.className = 'bg-green-600 text-white text-xs px-2 py-1 rounded';
                    status.innerText = 'GPS ××©×“×¨ âœ…';
                    
                    // ×¢×“×›×•×Ÿ ×‘-DB ×›×“×™ ×©×”×œ×§×•×— ×™×¨××” ×‘××¤×”
                    updateDoc(doc(db, "users", user.uid), { 
                        location: { lat: pos.coords.latitude, lng: pos.coords.longitude }, 
                        lastLocationUpdate: serverTimestamp() 
                    });
                }, (err) => {
                    console.error(err);
                    document.getElementById('gpsStatus').innerText = '×©×’×™××ª ××™×§×•×';
                }, { enableHighAccuracy: true });
            }

            // 2. ×”××–× ×” ×œ××©×œ×•×—×™× ×‘×¡×˜×˜×•×¡ "shipping"
            const q = query(collection(db, "orders"), where("status", "==", "shipping"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('deliveries');
                if(snap.empty) { 
                    container.innerHTML = "<div class='text-gray-500 text-center'>××™×Ÿ ××©×œ×•×—×™× ×›×¨×’×¢. ×ª× ×•×—. â˜•</div>"; 
                    return; 
                }
                
                container.innerHTML = snap.docs.map(d => {
                    const o = d.data();
                    const address = o.project || o.address || "×œ× ×¦×•×™×Ÿ";
                    return `
                    <div class="bg-gray-800 p-5 rounded-xl shadow-lg border-r-4 border-purple-500">
                        <div class="flex justify-between items-start mb-2">
                            <h2 class="font-bold text-lg">${o.clientName}</h2>
                            <span class="bg-purple-900 text-purple-200 text-xs px-2 py-1 rounded">#${d.id.slice(0,4)}</span>
                        </div>
                        <p class="text-gray-400 mb-4 text-sm"><i class="fas fa-map-marker-alt text-red-500"></i> ${address}</p>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <a href="https://waze.com/ul?q=${encodeURIComponent(address)}&navigate=yes" target="_blank" class="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg text-center font-bold flex items-center justify-center gap-2">
                                <i class="fab fa-waze text-xl"></i> × ×•×•×˜
                            </a>
                            <button onclick="confirmDelivery('${d.id}')" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold">
                                <i class="fas fa-check"></i> × ××¡×¨
                            </button>
                        </div>
                        
                        <div class="mt-4 bg-gray-900 p-3 rounded text-xs text-gray-400">
                            ${o.items ? o.items.map(i => `â€¢ ${i.name} (x${i.qty})`).join('<br>') : ''}
                        </div>
                    </div>`;
                }).join('');
            });
        });

        window.confirmDelivery = async (id) => {
            if(confirm("×××©×¨ ××¡×™×¨×” ×œ×œ×§×•×—?")) {
                await updateDoc(doc(db, "orders", id), { status: "delivered", deliveredAt: serverTimestamp() });
            }
        };
    </script>
</body>
</html>
