<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabanOS Admin - ××¨×›×– ×©×œ×™×˜×” v27.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; padding: 0.6rem; border-radius: 0.5rem; width: 100%; transition: 0.2s; }
        .input-dark:focus { border-color: #38bdf8; outline: none; }
        .glass-panel { background: #1e293b; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .phone-frame { border: 8px solid #334155; border-radius: 30px; overflow: hidden; background: #f3f4f6; position: relative; height: 600px; width: 320px; margin: 0 auto; display: flex; flex-direction: column; }
        .ai-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563", measurementId: "G-PQGYJ2YQRK" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firebaseData = { collection, addDoc, getDocs, deleteDoc, updateDoc, doc, onSnapshot, setDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const Icon = ({ name, size=16, className }) => { useEffect(() => lucide.createIcons(), [name]); return <i data-lucide={name} style={{fontSize: size}} className={className}></i>; };

        // --- KEYS (×”×¢×•×‘×“×™×) ---
        const API_KEYS = {
            googleSearch: "AIzaSyDLkShn6lBBew-PJJWtzvAe_14UF9Kv-QI",
            gemini: "AIzaSyAdfGVrmr90Mp9ZhNMItD81iaE8OipKwz0",
            cx: "1340c66f5e73a4076"
        };

        // --- 1. Product Search Component (AI Powered) ---
        const ProductSearch = ({ onSelect }) => {
            const [query, setQuery] = useState('');
            const [loading, setLoading] = useState(false);
            const [aiResult, setAiResult] = useState(null);

            const handleSearch = async () => {
                if (!query) return;
                setLoading(true);
                setAiResult(null);

                // 1. Ask Gemini for Data (Hebrew JSON)
                const prompt = `You are a logistics expert. Product: "${query}". Return JSON (Hebrew): {"name": "Professional Name", "description": "Short marketing desc", "price_estimate": 0, "features": ["feat1", "feat2"], "application": "Usage", "weight_kg": 0, "pallet_qty": 0, "requires_crane": true} ONLY JSON.`;

                try {
                    // A. Call Gemini
                    const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEYS.gemini}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    const aiData = await aiRes.json();
                    if (!aiData.candidates) throw new Error("AI Failed");
                    
                    const text = aiData.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());

                    // B. Call Google Images
                    const imgRes = await fetch(`https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(query)}&cx=${API_KEYS.cx}&key=${API_KEYS.googleSearch}&searchType=image&num=1`);
                    const imgData = await imgRes.json();
                    const imageUrl = imgData.items && imgData.items.length > 0 ? imgData.items[0].link : "";

                    // C. Combine
                    const fullProduct = {
                        title: parsedData.name || query,
                        description: parsedData.description,
                        image: imageUrl,
                        price: parsedData.price_estimate || 0,
                        features: parsedData.features || [],
                        logistics: {
                            weight: parsedData.weight_kg,
                            crane: parsedData.requires_crane
                        }
                    };

                    setAiResult(fullProduct);

                } catch (err) {
                    console.error(err);
                    alert("×©×’×™××” ×‘×©×œ×™×¤×”: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 mb-6 shadow-lg">
                    <h3 className="font-bold text-teal-400 mb-3 flex items-center gap-2">
                        <Icon name="sparkles" className="text-yellow-400"/> ×¡×•×›×Ÿ ×¨×›×© (AI)
                    </h3>
                    
                    <div className="flex gap-2 mb-4">
                        <input 
                            value={query} 
                            onChange={e=>setQuery(e.target.value)} 
                            onKeyDown={e=>e.key==='Enter'&&handleSearch()} 
                            className="input-dark flex-1" 
                            placeholder="×”×§×œ×“ ×©× ××•×¦×¨ (×œ××©×œ: ×“×‘×§ ×§×¨××™×§×” 114)..."
                        />
                        <button 
                            onClick={handleSearch} 
                            className="bg-gradient-to-r from-teal-600 to-blue-600 px-6 rounded font-bold hover:opacity-90 transition flex items-center gap-2"
                            disabled={loading}
                        >
                            {loading ? <Icon name="loader-2" className="animate-spin"/> : <Icon name="search"/>}
                            {loading ? '××¤×¢× ×—...' : '×©×œ×•×£'}
                        </button>
                    </div>

                    {aiResult && (
                        <div className="bg-gray-700/50 p-3 rounded-lg border border-gray-600 flex gap-3 animate-in fade-in slide-in-from-top-2">
                            <img src={aiResult.image || 'https://via.placeholder.com/100'} className="w-16 h-16 rounded object-cover bg-white"/>
                            <div className="flex-1">
                                <div className="font-bold text-lg">{aiResult.title}</div>
                                <div className="text-xs text-gray-300 line-clamp-2">{aiResult.description}</div>
                                <div className="flex gap-2 mt-2">
                                    {aiResult.logistics.crane && <span className="text-[10px] bg-red-900/50 text-red-200 px-2 rounded border border-red-800">ğŸ—ï¸ ×× ×•×£</span>}
                                    {aiResult.logistics.weight > 0 && <span className="text-[10px] bg-orange-900/50 text-orange-200 px-2 rounded border border-orange-800">âš–ï¸ {aiResult.logistics.weight} ×§"×’</span>}
                                </div>
                            </div>
                            <button 
                                onClick={() => onSelect(aiResult)} 
                                className="bg-green-600 hover:bg-green-500 text-white px-4 rounded font-bold h-10 self-center shadow-lg"
                            >
                                ×”×•×¡×£
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // --- 2. Categories Manager ---
        const CategoriesManager = ({ categories }) => {
            const [newCat, setNewCat] = useState({id:'', name:''});
            const add = async () => {
                if(!newCat.id || !newCat.name) return;
                await window.firebaseData.setDoc(window.firebaseData.doc(window.db, "categories", newCat.id), newCat);
                setNewCat({id:'', name:''});
            };
            const remove = async (id) => { if(confirm('×œ××—×•×§?')) await window.firebaseData.deleteDoc(window.firebaseData.doc(window.db, "categories", id)); };
            return (
                <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 mb-6">
                    <h3 className="font-bold text-purple-400 mb-2 flex gap-2"><Icon name="layers"/> × ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</h3>
                    <div className="flex gap-2 mb-2"><input value={newCat.name} onChange={e=>setNewCat({...newCat, name:e.target.value})} placeholder="×©× (×’×‘×¡)" className="input-dark flex-1"/><input value={newCat.id} onChange={e=>setNewCat({...newCat, id:e.target.value})} placeholder="××–×”×” (drywall)" className="input-dark w-1/3"/><button onClick={add} className="bg-purple-600 px-3 rounded">+</button></div>
                    <div className="flex flex-wrap gap-2">{categories.map(c=>(<span key={c.id} className="bg-gray-700 px-2 py-1 rounded text-xs border border-gray-600 flex items-center gap-1">{c.name} <button onClick={()=>remove(c.id)} className="text-red-400 hover:text-red-200">x</button></span>))}</div>
                </div>
            );
        };

        // --- 3. Variants Manager ---
        const VariantsManager = ({ variants, setVariants }) => {
            const [v, setV] = useState({label:'', price:''});
            const add = () => { if(v.label && v.price) { setVariants([...variants, {...v, price: Number(v.price)}]); setV({label:'', price:''}); }};
            return (
                <div className="bg-gray-900/50 p-3 rounded border border-gray-600 mt-2">
                    <div className="text-sm font-bold text-yellow-400 mb-2">ğŸ“ ××™×“×•×ª ×•×’×“×œ×™×</div>
                    <div className="flex gap-2 mb-2"><input value={v.label} onChange={e=>setV({...v, label:e.target.value})} placeholder="××™×“×” (×œ××©×œ 70/300)" className="input-dark text-xs flex-1"/><input value={v.price} onChange={e=>setV({...v, price:e.target.value})} type="number" placeholder="××—×™×¨" className="input-dark text-xs w-20"/><button type="button" onClick={add} className="bg-teal-600 px-2 rounded">+</button></div>
                    <div className="space-y-1">{variants.map((item,i)=>(<div key={i} className="flex justify-between bg-gray-800 p-1 px-2 rounded text-xs"><span>{item.label}</span><span>â‚ª{item.price} <button type="button" onClick={()=>setVariants(variants.filter((_,x)=>x!==i))} className="text-red-400 font-bold ml-1">x</button></span></div>))}</div>
                </div>
            );
        };

        // --- TAB 1: Inventory & Products ---
        const InventoryTab = () => {
            const [products, setProducts] = useState([]);
            const [categories, setCategories] = useState([]);
            const [form, setForm] = useState({ title: '', category: 'all', price: '', hasVariants: false, variants: [], description: '', image: '', logistics: {} });
            const [editingId, setEditingId] = useState(null);
            
            const { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } = window.firebaseData;
            const db = window.db;

            useEffect(() => {
                const u1 = onSnapshot(collection(db, "products"), s => setProducts(s.docs.map(d=>({id:d.id, ...d.data()}))));
                const u2 = onSnapshot(collection(db, "categories"), s => setCategories(s.docs.map(d=>({id:d.id, ...d.data()}))));
                return () => { u1(); u2(); };
            }, []);

            const save = async (e) => {
                e.preventDefault();
                // Map flat structure to nested structure if needed by other apps, or keep flat.
                // Keeping flat for React Admin simplicity, but adding "core" for compatibility if needed.
                const data = { 
                    ...form, 
                    price: form.hasVariants ? 0 : Number(form.price), 
                    updatedAt: new Date(),
                    // Hybrid structure for compatibility with Client App logic
                    core: { name: form.title, price: Number(form.price) },
                    rich: { image: form.image, description: form.description }
                };
                
                if(editingId) await updateDoc(doc(db,"products",editingId), data);
                else await addDoc(collection(db,"products"), {...data, createdAt: new Date()});
                
                setForm({ title: '', category: 'all', price: '', hasVariants: false, variants: [], description: '', image: '', logistics: {} });
                setEditingId(null); 
                alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="md:col-span-1">
                        
                        <ProductSearch onSelect={d => setForm(prev => ({...prev, ...d}))} />
                        
                        <CategoriesManager categories={categories} />
                        
                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700">
                            <h2 className="text-xl font-bold mb-4 flex justify-between">
                                {editingId ? '×¢×¨×™×›×”' : '××•×¦×¨ ×—×“×©'}
                                <button type="button" onClick={()=>{setForm({ title: '', category: 'all', price: '', hasVariants: false, variants: [], description: '', image: '' }); setEditingId(null);}} className="text-xs text-gray-400">× ×§×”</button>
                            </h2>
                            <form onSubmit={save} className="space-y-3">
                                <input value={form.title} onChange={e=>setForm({...form, title:e.target.value})} placeholder="×©× ××•×¦×¨" className="input-dark font-bold" required/>
                                <select value={form.category} onChange={e=>setForm({...form, category:e.target.value})} className="input-dark">{categories.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select>
                                <div className="flex items-center gap-2"><input type="checkbox" checked={form.hasVariants} onChange={e=>setForm({...form, hasVariants:e.target.checked})} /><span className="text-sm">×™×© ××™×“×•×ª?</span></div>
                                {form.hasVariants ? <VariantsManager variants={form.variants} setVariants={v=>setForm({...form, variants:v})}/> : <input type="number" value={form.price} onChange={e=>setForm({...form, price:e.target.value})} placeholder="××—×™×¨" className="input-dark text-green-400 font-bold" required/>}
                                <input value={form.image} onChange={e=>setForm({...form, image:e.target.value})} placeholder="×ª××•× ×” URL" className="input-dark text-xs"/>
                                <textarea value={form.description} onChange={e=>setForm({...form, description:e.target.value})} placeholder="×ª×™××•×¨" className="input-dark h-20 text-sm"></textarea>
                                
                                {/* Logistics Hidden Fields Display */}
                                {form.logistics && (form.logistics.crane || form.logistics.weight) && (
                                    <div className="text-xs text-gray-400 bg-gray-900 p-2 rounded">
                                        ×œ×•×’×™×¡×˜×™×§×” (AI): {form.logistics.weight}kg, {form.logistics.crane ? '×× ×•×£' : '×¨×’×™×œ'}
                                    </div>
                                )}

                                <button className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold shadow-lg transition transform active:scale-95">
                                    {editingId ? '×¢×“×›×•×Ÿ ××•×¦×¨' : '×©××•×¨ ×‘××œ××™'}
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div className="md:col-span-2 grid gap-2 content-start overflow-y-auto h-[85vh] custom-scroll pb-20">
                        {products.map(p => (
                            <div key={p.id} className="bg-gray-800 p-3 rounded-xl flex justify-between items-center border border-gray-700 hover:border-gray-500 transition">
                                <div className="flex gap-4 items-center">
                                    <img src={p.image || p.rich?.image || 'https://via.placeholder.com/50'} className="w-12 h-12 bg-white rounded-lg object-contain"/>
                                    <div>
                                        <div className="font-bold text-lg">{p.title || p.core?.name}</div>
                                        <div className="text-sm text-gray-400 flex gap-2">
                                            <span>{p.hasVariants ? `${p.variants.length} ××™×“×•×ª` : `â‚ª${p.price || p.core?.price}`}</span>
                                            {p.logistics?.crane && <span className="text-red-400 text-xs border border-red-900 px-1 rounded">×× ×•×£</span>}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={()=>{setEditingId(p.id); setForm(p); window.scrollTo({top:0, behavior:'smooth'})}} className="p-2 bg-gray-700 rounded hover:bg-gray-600"><Icon name="edit-2" size={18} className="text-yellow-400"/></button>
                                    <button onClick={()=>deleteDoc(doc(db,"products",p.id))} className="p-2 bg-gray-700 rounded hover:bg-red-900/50"><Icon name="trash-2" size={18} className="text-red-400"/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- TAB 2: Chat Studio ---
        const ChatStudioTab = () => {
            const [faqs, setFaqs] = useState([]);
            const [form, setForm] = useState({ scenarioId: '', keywords: '', answer: '', buttons: [] });
            const [editingId, setEditingId] = useState(null);
            const { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } = window.firebaseData;
            const db = window.db;

            useEffect(() => onSnapshot(collection(db, "faq"), s => setFaqs(s.docs.map(d=>({id:d.id, ...d.data()})))), []);

            const save = async () => {
                const kw = Array.isArray(form.keywords) ? form.keywords : form.keywords.split(',');
                if(editingId) await updateDoc(doc(db,"faq",editingId), {...form, keywords: kw});
                else await addDoc(collection(db,"faq"), {...form, keywords: kw});
                setForm({ scenarioId: '', keywords: '', answer: '', buttons: [] }); setEditingId(null); alert("× ×©××¨");
            };

            const addButton = () => setForm({...form, buttons: [...form.buttons, {label:'×›×¤×ª×•×¨', action:'order_popup'}]});
            const updateBtn = (i, f, v) => { const b = [...form.buttons]; b[i][f]=v; setForm({...form, buttons:b}); };

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-[80vh]">
                    <div className="overflow-y-auto custom-scroll pr-2">
                        <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 mb-6">
                            <h2 className="font-bold mb-4 text-teal-400">×¢×•×¨×š ×”×‘×•×˜</h2>
                            <div className="space-y-3">
                                <div className="flex gap-2"><input value={form.scenarioId} onChange={e=>setForm({...form, scenarioId:e.target.value})} placeholder="ID (glue_start)" className="input-dark w-1/3"/><input value={form.keywords} onChange={e=>setForm({...form, keywords:e.target.value})} placeholder="××™×œ×•×ª ××¤×ª×— (×“×‘×§, ×§×¨××™×§×”)" className="input-dark flex-1"/></div>
                                <textarea value={form.answer} onChange={e=>setForm({...form, answer:e.target.value})} placeholder="×ª×©×•×‘×” (×ª×•××š HTML)" className="input-dark h-32"></textarea>
                                <div className="bg-gray-900/50 p-3 rounded">
                                    <div className="flex justify-between mb-2"><span className="text-xs">×›×¤×ª×•×¨×™×</span><button onClick={addButton} className="text-xs bg-teal-600 px-2 rounded">+</button></div>
                                    {form.buttons.map((b, i) => (
                                        <div key={i} className="flex gap-2 mb-2"><input value={b.label} onChange={e=>updateBtn(i,'label',e.target.value)} className="input-dark text-xs flex-1"/><select value={b.action} onChange={e=>updateBtn(i,'action',e.target.value)} className="input-dark text-xs w-24"><option value="order_popup">×˜×•×¤×¡</option><option value="next_node">×”××©×š</option><option value="add_to_cart">×¢×’×œ×”</option></select></div>
                                    ))}
                                </div>
                                <button onClick={save} className="w-full bg-teal-600 py-2 rounded font-bold">×©××•×¨ ×ª×¨×—×™×©</button>
                            </div>
                        </div>
                        <div className="space-y-2">{faqs.map(f => (<div key={f.id} className="bg-gray-800 p-3 rounded border border-gray-700 flex justify-between group"><div><div className="text-xs text-yellow-400">{f.keywords}</div><div className="text-sm truncate">{f.answer}</div></div><button onClick={()=>{setEditingId(f.id); setForm({ ...f, keywords: f.keywords.join(',') })}}><Icon name="edit-2" size={14}/></button></div>))}</div>
                    </div>
                    <div className="hidden md:flex justify-center items-center bg-gray-900 rounded-3xl border border-gray-800">
                        <div className="phone-frame flex flex-col justify-center items-center text-gray-500">
                            <Icon name="smartphone" size={48}/>
                            <span>×”×¡×™××•×œ×˜×•×¨ ×¤×¢×™×œ ×‘-Client</span>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [tab, setTab] = useState('inventory');
            return (
                <div className="max-w-7xl mx-auto min-h-screen p-4">
                    <header className="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
                        <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">SabanOS Admin</h1>
                        <div className="flex gap-2 bg-gray-800 p-1 rounded-lg">
                            <button onClick={()=>setTab('inventory')} className={`px-4 py-2 rounded-md transition ${tab==='inventory' ? 'bg-teal-600 text-white' : 'text-gray-400 hover:text-white'}`}>ğŸ“¦ ××œ××™ ×•×§×˜×œ×•×’</button>
                            <button onClick={()=>setTab('chat')} className={`px-4 py-2 rounded-md transition ${tab==='chat' ? 'bg-teal-600 text-white' : 'text-gray-400 hover:text-white'}`}>ğŸ¤– ×¡×˜×•×“×™×• ×‘×•×˜</button>
                        </div>
                    </header>
                    {tab === 'inventory' ? <InventoryTab /> : <ChatStudioTab />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
