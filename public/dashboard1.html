<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban | ×¡×™×“×•×¨ ×¢×‘×•×“×”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background: #f8fafc; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Header */
        nav { background: white; border-bottom: 1px solid #e2e8f0; height: 60px; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; px: 20px; }
        
        /* Layout */
        .board-container { flex: 1; display: flex; overflow-x: auto; padding: 20px; gap: 20px; align-items: flex-start; }
        
        /* Columns */
        .col-bank { width: 350px; flex-shrink: 0; display: flex; flex-direction: column; max-height: 100%; }
        .col-driver { width: 320px; flex-shrink: 0; background: white; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; max-height: 100%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .col-header { padding: 15px; border-bottom: 1px solid #f1f5f9; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .driver-name { font-size: 18px; color: #1e293b; }
        .bank-title { font-size: 18px; color: #64748b; font-weight: 800; }

        /* Items Container */
        .items-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; min-height: 200px; background: #f8fafc; }
        
        /* Card Style */
        .task-card { background: white; border: 1px solid #cbd5e1; border-radius: 8px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; transition: 0.2s; border-right: 4px solid transparent; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .card-new { border-right-color: #22c55e; } /* ×™×¨×•×§ - ×”×–×× ×” */
        .card-task { border-right-color: #3b82f6; background: #f0f9ff; } /* ×›×—×•×œ - ×”×¢×‘×¨×” */
        .card-manual { border-right-color: #f59e0b; background: #fffbeb; } /* ×›×ª×•× - ×™×“× ×™ */

        .card-title { font-weight: bold; font-size: 14px; color: #334155; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .card-detail { font-size: 12px; color: #64748b; display: flex; items-center; gap: 5px; }
        
        /* Assign Buttons */
        .assign-controls { margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; border-top: 1px dashed #e2e8f0; pt: 5px; }
        .assign-btn { font-size: 10px; padding: 4px 8px; background: #e2e8f0; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .assign-btn:hover { background: #cbd5e1; }
        .assign-btn.active { background: #3b82f6; color: white; }

        /* WhatsApp Button */
        .wa-btn { background: #25d366; color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: 0.2s; text-decoration: none; }
        .wa-btn:hover { background: #16a34a; }

        /* Manual Input */
        .manual-box { background: white; padding: 15px; border-radius: 12px; border: 1px dashed #94a3b8; margin-bottom: 20px; }
        .input-line { display: flex; gap: 5px; margin-bottom: 5px; }
        .mini-input { flex: 1; border: 1px solid #e2e8f0; padding: 6px; border-radius: 4px; font-size: 13px; }
        .add-btn { background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 13px; cursor: pointer; width: 100%; font-weight: bold; }
        
        /* Remove Button */
        .remove-icon { position: absolute; top: 10px; left: 10px; color: #ef4444; cursor: pointer; display: none; }
        .task-card:hover .remove-icon { display: block; }
    </style>
</head>
<body>

    <nav>
        <div class="flex items-center gap-3 px-6">
            <div class="w-8 h-8 bg-slate-800 rounded flex items-center justify-center text-white"><i class="fas fa-network-wired"></i></div>
            <h1 class="font-bold text-xl text-slate-700">×¡×™×“×•×¨ ×¢×‘×•×“×” - ×‘×•×§×¨</h1>
        </div>
        <div class="px-6">
            <button onclick="window.location.href='whatsapp-center.html'" class="text-gray-500 font-bold text-sm hover:text-blue-600">×—×–×¨×” ×œ×—×"×œ <i class="fas fa-arrow-left"></i></button>
        </div>
    </nav>

    <div class="board-container">
        
        <div class="col-bank">
            <div class="manual-box">
                <div class="text-xs font-bold text-gray-400 uppercase mb-2">â• ×”×•×¡×¤×” ×™×“× ×™×ª ×œ×¡×™×“×•×¨</div>
                <div class="input-line">
                    <input type="text" id="manClient" class="mini-input" placeholder="×œ×§×•×— / ××©×™××”">
                    <input type="text" id="manCity" class="mini-input" placeholder="×¢×™×¨ / ×™×¢×“">
                </div>
                <input type="text" id="manDetails" class="mini-input mb-2 w-full" placeholder="×¤×¨×˜×™× (××œ×˜, ×‘×¨×–×œ...)">
                <button onclick="addManualTask()" class="add-btn">×¦×•×¨ ×›×¨×˜×™×¡</button>
            </div>

            <div class="flex justify-between items-center mb-2 px-2">
                <span class="bank-title">×××’×¨ ××©×™××•×ª</span>
                <span class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full font-bold" id="bank-count">0</span>
            </div>
            
            <div id="bank-list" class="items-list rounded-xl border border-gray-200 bg-white">
                <div class="text-center text-gray-400 mt-10"><i class="fas fa-spinner fa-spin"></i> ×˜×•×¢×Ÿ...</div>
            </div>
        </div>

        <div id="drivers-container" class="flex gap-5 h-full"></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // 1. ×”×’×“×¨×ª × ×”×’×™× - ××¤×©×¨ ×œ×”×•×¡×™×£/×œ×©× ×•×ª ×›××Ÿ
        const DRIVERS = [
            { id: 'ali', name: '×¢×œ×™', phone: '972500000000' }, // ×©×™× ×˜×œ×¤×•×Ÿ ×××™×ª×™
            { id: 'hicmat', name: '×—×›××ª', phone: '972500000000' },
            { id: 'truck3', name: '××©××™×ª ×’×“×•×œ×”', phone: '' },
            { id: 'truck4', name: '×˜× ×“×¨ ×©×™×¨×•×ª', phone: '' }
        ];

        // 2. Init Drivers Columns
        const driversContainer = document.getElementById('drivers-container');
        DRIVERS.forEach(d => {
            driversContainer.innerHTML += `
            <div class="col-driver">
                <div class="col-header bg-gray-50">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">${d.name[0]}</div>
                        <span class="driver-name">${d.name}</span>
                    </div>
                    <button onclick="sendWhatsapp('${d.id}', '${d.name}')" class="wa-btn">
                        <i class="fab fa-whatsapp"></i> ×©×œ×— ×¡×™×“×•×¨
                    </button>
                </div>
                <div id="list-${d.id}" class="items-list"></div>
            </div>`;
        });

        // 3. Listener: Load Tasks
        const q = query(collection(db, "orders"), where("status", "!=", "done"));
        
        onSnapshot(q, (snap) => {
            const bankList = document.getElementById('bank-list');
            
            // Clear all lists
            bankList.innerHTML = '';
            DRIVERS.forEach(d => document.getElementById(`list-${d.id}`).innerHTML = '');
            
            let bankCount = 0;

            snap.forEach(docSnap => {
                const o = { id: docSnap.id, ...docSnap.data() };
                const cardHtml = createCardHtml(o);

                // ××™×•×Ÿ: ×× ×™×© × ×”×’ ××©×•×™×š -> ×œ×˜×•×¨ ×”× ×”×’. ××—×¨×ª -> ×œ×‘× ×§.
                if (o.driverId && document.getElementById(`list-${o.driverId}`)) {
                    document.getElementById(`list-${o.driverId}`).innerHTML += cardHtml;
                } else {
                    bankList.innerHTML += cardHtml;
                    bankCount++;
                }
            });
            document.getElementById('bank-count').innerText = bankCount;
        });

        // 4. HTML Generator for Card
        function createCardHtml(o) {
            const isTask = o.isTask;
            const isManual = o.isManual;
            
            let borderClass = 'card-new'; // ×™×¨×•×§
            let icon = '<i class="fas fa-box text-green-600"></i>';
            
            if (isTask) { borderClass = 'card-task'; icon = '<i class="fas fa-truck-loading text-blue-600"></i>'; }
            if (isManual) { borderClass = 'card-manual'; icon = '<i class="fas fa-keyboard text-orange-500"></i>'; }

            // ×›×¤×ª×•×¨×™ ×©×™×‘×•×¥
            let buttonsHtml = '';
            DRIVERS.forEach(d => {
                const isActive = o.driverId === d.id ? 'active' : '';
                buttonsHtml += `<div class="assign-btn ${isActive}" onclick="window.assignDriver('${o.id}', '${d.id}')">${d.name}</div>`;
            });
            // ×›×¤×ª×•×¨ ×”×—×–×¨×” ×œ×‘× ×§
            if (o.driverId) {
                buttonsHtml += `<div class="assign-btn text-red-500" onclick="window.assignDriver('${o.id}', null)"><i class="fas fa-times"></i> ×”×¡×¨</div>`;
            }

            // ×ª×•×›×Ÿ ××§×•×¦×¨
            const details = o.itemsText || o.text || '×œ×œ× ×¤×™×¨×•×˜';
            const shortDetails = details.length > 40 ? details.substring(0, 40) + '...' : details;

            return `
            <div class="task-card ${borderClass}" id="card-${o.id}">
                ${o.isManual ? `<i class="fas fa-trash remove-icon" onclick="window.deleteTask('${o.id}')" title="××—×§"></i>` : ''}
                <div class="card-title">
                    <span>${icon} ${o.clientName}</span>
                    <span class="text-xs bg-gray-100 px-1 rounded">${o.address || o.supplyTime || ''}</span>
                </div>
                <div class="card-detail mb-2"><i class="fas fa-align-left text-gray-400"></i> ${shortDetails}</div>
                
                <div class="assign-controls">
                    ${buttonsHtml}
                </div>
            </div>`;
        }

        // 5. Actions (Global Scope)
        window.assignDriver = async (orderId, driverId) => {
            // ×¢×“×›×•×Ÿ ×”-DB ××–×™×– ××ª ×”×›×¨×˜×™×¡ ××•×˜×•××˜×™×ª ×‘×–×›×•×ª ×”×××–×™×Ÿ
            await updateDoc(doc(db, "orders", orderId), { 
                driverId: driverId,
                lastActive: serverTimestamp()
            });
        };

        window.addManualTask = async () => {
            const client = document.getElementById('manClient').value;
            const city = document.getElementById('manCity').value;
            const det = document.getElementById('manDetails').value;
            
            if(!client) return alert('×—×•×‘×” ×œ××œ× ×©× ×œ×§×•×—/××©×™××”');

            await addDoc(collection(db, "orders"), {
                clientName: client,
                address: city,
                itemsText: det,
                status: 'new',
                isManual: true, // ×“×’×œ ×œ×–×™×”×•×™ ×™×“× ×™
                createdAt: serverTimestamp(),
                lastActive: serverTimestamp()
            });

            // × ×™×§×•×™ ×˜×•×¤×¡
            document.getElementById('manClient').value = '';
            document.getElementById('manCity').value = '';
            document.getElementById('manDetails').value = '';
        };

        window.deleteTask = async (id) => {
            if(confirm('×œ××—×•×§ ××©×™××” ×™×“× ×™×ª ×–×•?')) {
                // ×‘××—×™×§×” ×××™×ª×™×ª ××©×ª××©×™× ×‘-deleteDoc
                // ×›××Ÿ × ×¡××Ÿ ×›-done ×›×“×™ ×œ×”×¢×œ×™× ××”×œ×•×—
                await updateDoc(doc(db, "orders", id), { status: 'done' });
            }
        };

        // 6. WhatsApp Generator
        window.sendWhatsapp = (driverId, driverName) => {
            const container = document.getElementById(`list-${driverId}`);
            const cards = container.querySelectorAll('.task-card');
            
            if(cards.length === 0) return alert('××™×Ÿ ××©×™××•×ª ×œ× ×”×’ ×–×”');

            let msg = `*×¡×™×“×•×¨ ×¢×‘×•×“×” ×œ××—×¨ - ${driverName}* ğŸšš\n×ª××¨×™×š: ${new Date().toLocaleDateString()}\n------------------\n`;
            
            cards.forEach((card, i) => {
                // ×©××™×‘×ª ××™×“×¢ ××”-HTML (×¤×©×•×˜ ×•×™×¢×™×œ)
                const title = card.querySelector('.card-title span').innerText;
                const addr = card.querySelector('.card-title .text-xs').innerText;
                const body = card.querySelector('.card-detail').innerText;
                
                msg += `*${i+1}. ${title}*\nğŸ“ ${addr}\nğŸ“ ${body}\n\n`;
            });

            msg += `\n×‘×”×¦×œ×—×”! ×¡×¢ ×‘×–×”×™×¨×•×ª.`;
            
            // ×¤×ª×™×—×ª ×•×•×¦××£
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        };
    </script>
</body>
</html>
