<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Saban Driver | Live</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* 驻住  住   */
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background: #fff; font-family: -apple-system, system-ui, sans-serif; }
        
        /* 驻 转驻住转 100%  专 */
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; }
        
        /* 住住  注 */
        .driver-status-badge {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95); padding: 8px 20px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-weight: bold; font-size: 14px;
            display: flex; items-center; gap: 8px; z-index: 500;
            backdrop-filter: blur(5px); border: 1px solid #e2e8f0;
        }
        .status-dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }

        /* 驻住 转拽转 (砖) - 驻注 注 */
        .progress-bar-container {
            position: absolute; top: 0; left: 0; right: 0; z-index: 400;
            background: rgba(255, 255, 255, 0.98); padding: 15px 20px 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .progress-bar-container.active { transform: translateY(0); }
        
        .steps { display: flex; justify-content: space-between; position: relative; padding: 0 10px; }
        .steps::before { content: ''; position: absolute; top: 10px; left: 20px; right: 20px; height: 2px; background: #e2e8f0; z-index: 0; }
        .step { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; }
        .step-dot { width: 22px; height: 22px; background: #fff; border: 3px solid #cbd5e1; border-radius: 50%; transition: 0.3s; }
        .step.active .step-dot { border-color: #3b82f6; background: #3b82f6; transform: scale(1.1); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .step.done .step-dot { background: #22c55e; border-color: #22c55e; }
        .step-label { font-size: 10px; font-weight: 700; color: #94a3b8; margin-top: 4px; }
        .step.active .step-label { color: #3b82f6; }

        /* 专住 驻注 转转 */
        .action-card {
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 24px; padding-bottom: max(24px, env(safe-area-inset-bottom));
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000;
        }
        .action-card.active { transform: translateY(0); }

        /* 驻转专 住 */
        .big-btn {
            height: 64px; border-radius: 16px; font-weight: 800; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; color: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transition: transform 0.1s;
        }
        .big-btn:active { transform: scale(0.96); }
        
        .btn-waze { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-call { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .btn-msg { background: linear-gradient(135deg, #f97316, #ea580c); }
        
        .btn-start { 
            background: linear-gradient(135deg, #2563eb, #1e40af); width: 100%; height: 75px; 
            font-size: 20px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
            animation: pulse-btn 2s infinite;
        }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* 注爪 住转 驻 */
        .truck-marker { font-size: 44px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); z-index: 2000 !important; }
        .custom-pin { display: flex; align-items: center; justify-content: center; }
        .pin-inner { 
            width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 20px; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .pin-order { background: #3b82f6; } /*  */
        .pin-transfer { background: #f97316; } /* 注专 */
    </style>
</head>
<body>

    <div class="driver-status-badge">
        <div class="status-dot"></div>
        <span id="driver-name-display">转专...</span>
    </div>

    <div id="progress-bar" class="progress-bar-container">
        <div class="steps">
            <div class="step active"><div class="step-dot"></div><div class="step-label">转拽</div></div>
            <div class="step" id="step-nav"><div class="step-dot"></div><div class="step-label">专</div></div>
            <div class="step" id="step-done"><div class="step-dot"></div><div class="step-label">住</div></div>
        </div>
    </div>

    <div id="map"></div>
    
    <div id="action-sheet" class="action-card"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let map, truckMarker;
        let currentDriver = null;
        let activeTaskId = null;

        // --- 砖 1: 转   ---
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('user_id');
            const driverParam = params.get('driver');
            
            // 转  
            const driversMap = {
                'QHzzWehstGOH1WBccCUS': '注',
                'TEST_DRIVER_2': '转'
            };

            // 拽注转  (注驻转 拽,  专)
            currentDriver = driverParam || driversMap[userId] || localStorage.getItem('saban_driver_name');

            if (currentDriver) {
                //  
                localStorage.setItem('saban_driver_name', currentDriver);
                document.getElementById('driver-name-display').innerText = `: ${currentDriver}`;
                initMap();
                
                // 专转 住 注
                Swal.fire({
                    toast: true, position: 'top', icon: 'success', 
                    title: `专 -${currentDriver}`, showConfirmButton: false, timer: 3000
                });
            } else {
                // 爪 专:   
                Swal.fire({
                    title: '砖转 转',
                    text: ' 住 专 拽 砖 砖砖  住专.',
                    icon: 'error',
                    confirmButtonText: '转'
                });
            }
        };

        // --- 砖 2: 转 驻 ---
        function initMap() {
            // 驻 专 拽 注专转
            map = L.map('map', { zoomControl: false }).setView([32.162, 34.844], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Saban Logistics',
                maxZoom: 19
            }).addTo(map);

            // 驻注转 GPS
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updateLocation, 
                    (err) => console.warn("GPS Access Denied"), 
                    { enableHighAccuracy: true }
                );
            }

            // 转转  砖转
            listenForTasks();
        }

        async function updateLocation(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const heading = pos.coords.heading || 0;

            // 拽 砖转 砖驻  住注
            const truckHtml = `<div style="transform: rotate(${heading}deg); transition: transform 0.5s;"></div>`;
            const truckIcon = L.divIcon({ className: 'truck-marker', html: truckHtml, iconSize: [44, 44], iconAnchor: [22, 22] });

            if (!truckMarker) {
                truckMarker = L.marker([lat, lng], {icon: truckIcon}).addTo(map);
                map.setView([lat, lng], 16);
            } else {
                truckMarker.setLatLng([lat, lng]);
                truckMarker.setIcon(truckIcon);
            }
            
            // 注 " 拽  (爪专 驻 爪注转)
            if(currentDriver) {
                await setDoc(doc(db, "drivers", currentDriver), {
                    name: currentDriver, 
                    location: { lat, lng }, 
                    heading, 
                    lastUpdate: serverTimestamp(),
                    status: activeTaskId ? 'busy' : 'online'
                });
            }
        }

        // --- 砖 3:  砖转 (注专转 转) ---
        function listenForTasks() {
            const q = query(collection(db, "orders"), where("driver", "==", currentDriver), where("status", "in", ["assigned", "on_route"]));
            
            onSnapshot(q, (snap) => {
                // 拽 住转 拽转 (抓 砖转)
                map.eachLayer(layer => { if(layer instanceof L.Marker && layer !== truckMarker) map.removeLayer(layer); });

                if (snap.empty) {
                    //  砖转 -> 住转专 转 砖拽
                    document.getElementById('action-sheet').classList.remove('active');
                    document.getElementById('progress-bar').classList.remove('active');
                    activeTaskId = null;
                    return;
                }

                snap.forEach(d => {
                    const task = d.data();
                    
                    //  住 砖 (注专 / )
                    const isTransfer = task.type === 'transfer' || (task.itemsText && task.itemsText.includes('注专'));
                    
                    // 注爪 住
                    const pinClass = isTransfer ? 'pin-transfer' : 'pin-order';
                    const iconClass = isTransfer ? 'fa-exchange-alt' : 'fa-box';
                    
                    // 拽 砖 (  拽专转, 爪专 拽 驻拽   砖)
                    // 注专转    -Geocoding 砖 转转
                    const destLat = 32.165 + (Math.random() * 0.01); 
                    const destLng = 34.845 + (Math.random() * 0.01);
                    
                    const icon = L.divIcon({
                        className: 'custom-pin',
                        html: `<div class="pin-inner ${pinClass}"><i class="fas ${iconClass}"></i></div>`,
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });

                    const marker = L.marker([destLat, destLng], {icon: icon}).addTo(map);
                    marker.on('click', () => openTaskCard(d.id, task, isTransfer));
                    
                    // 驻转 转 砖 砖
                    openTaskCard(d.id, task, isTransfer);
                });
            });
        }

        // --- 砖 4: 专住 砖 驻注转 ---
        function openTaskCard(id, task, isTransfer) {
            activeTaskId = id;
            const sheet = document.getElementById('action-sheet');
            const progress = document.getElementById('progress-bar');
            
            sheet.classList.add('active');
            progress.classList.add('active');

            const isStarted = task.status === 'on_route';
            if(isStarted) document.getElementById('step-nav').classList.add('active');
            
            const titleColor = isTransfer ? 'text-orange-600' : 'text-blue-600';
            const titleText = isTransfer ? '注专 驻' : '转 拽';
            const badge = isTransfer ? '住祝' : '拽';

            let html = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-[11px] font-bold ${titleColor} uppercase tracking-widest mb-1">
                            <i class="fas fa-circle text-[8px] align-middle"></i> ${titleText}
                        </div>
                        <h2 class="text-2xl font-black text-slate-800 leading-tight">${task.clientName}</h2>
                        <div class="text-gray-500 text-sm font-bold flex items-center gap-1 mt-1">
                            <i class="fas fa-map-marker-alt text-red-500"></i> ${task.address}
                        </div>
                    </div>
                    <div class="bg-slate-100 px-3 py-1 rounded text-xs font-bold text-slate-600 border border-slate-200">
                        #${task.orderNum}
                    </div>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl mb-5 border border-slate-200 text-sm text-slate-700 max-h-24 overflow-y-auto">
                    ${task.itemsText}
                </div>`;

            if (!isStarted) {
                // 住 1: 拽转 砖
                html += `
                <button onclick="acceptMission('${id}')" class="big-btn btn-start">
                     拽 砖 爪 专
                </button>`;
            } else {
                // 住 2: 驻注转 专
                html += `
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="navWaze('${task.address}')" class="big-btn btn-waze">
                        <i class="fab fa-waze text-2xl"></i> 住注 注
                    </button>
                    <button onclick="window.open('tel:${task.clientPhone}')" class="big-btn btn-call">
                        <i class="fas fa-phone-alt text-xl"></i>  ${badge}
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="msgToOps('${id}')" class="big-btn btn-msg">
                        <i class="fas fa-comment-dots text-xl"></i> 注 住专
                    </button>
                    <button onclick="finishMission('${id}', '${task.clientName}')" class="big-btn bg-slate-800 hover:bg-green-600 w-full transition-colors">
                        <i class="fas fa-flag-checkered text-xl"></i> 驻专拽 砖
                    </button>
                </div>`;
            }
            sheet.innerHTML = html;
        }

        // --- 拽 注住拽转 ---
        
        window.acceptMission = async (id) => {
            // 注 " + 砖转 注 爪'
            await updateDoc(doc(db, "orders", id), { 
                status: 'on_route', 
                chat: arrayUnion({ sender: 'system', text: ` ${currentDriver} 砖专 拽 爪 专`, time: new Date().toISOString() })
            });
            // 住 爪
            new Audio('https://assets.mixkit.co/active_storage/sfx/2598/2598-preview.m4a').play().catch(()=>{});
        };

        window.navWaze = (addr) => window.location.href = `waze://?q=${encodeURIComponent(addr)}&navigate=yes`;

        window.msgToOps = async (id) => {
            const { value: text } = await Swal.fire({ title: '注 住专', input: 'text', confirmButtonText: '砖', confirmButtonColor: '#f97316' });
            if(text) {
                await updateDoc(doc(db, "orders", id), { 
                    status: 'driver_msg', // 拽驻抓  "
                    chat: arrayUnion({ sender: 'driver', text: `: ${text}`, time: new Date().toISOString() }) 
                });
            }
        };

        window.finishMission = async (id, name) => {
            const { isConfirmed } = await Swal.fire({
                title: '住 砖',
                text: ` 驻专拽 住 爪 ${name}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: ', 住转!',
                confirmButtonColor: '#22c55e',
                cancelButtonText: ''
            });

            if(isConfirmed) {
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                await updateDoc(doc(db, "orders", id), { 
                    status: 'done', 
                    deliveredAt: serverTimestamp(),
                    chat: arrayUnion({ sender: 'driver', text: ` 驻专拽 砖 注" ${currentDriver}`, time: new Date().toISOString() })
                });
                // 住专转 专住
                document.getElementById('action-sheet').classList.remove('active');
                document.getElementById('progress-bar').classList.remove('active');
            }
        };
    </script>
</body>
</html>
