<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e293b">
    <title>Saban Driver Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #0f172a; color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; font-family: system-ui, -apple-system, sans-serif; }
        
        /* ××¡×š ×”××ª× ×” */
        .idle-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; opacity: 0.5; }
        .radar-pulse { width: 100px; height: 100px; background: rgba(34, 197, 94, 0.2); border-radius: 50%; animation: pulse 2s infinite; display: flex; align-items: center; justify-content: center; }
        @keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(34, 197, 94, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }

        /* ×›×¨×˜×™×¡ ××©×™××” */
        .mission-card { 
            background: #1e293b; border-radius: 20px; margin: 15px; padding: 20px; 
            border: 1px solid #334155; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            flex: 1; display: flex; flex-direction: column; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ×¢× ×§×™×™× */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: auto; margin-bottom: 20px; }
        .big-btn { 
            height: 100px; border-radius: 16px; font-weight: 800; font-size: 18px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; cursor: pointer;
        }
        .btn-waze { background: #3b82f6; color: white; box-shadow: 0 5px 0 #1d4ed8; }
        .btn-waze:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-call { background: #22c55e; color: white; box-shadow: 0 5px 0 #15803d; }
        .btn-call:active { transform: translateY(4px); box-shadow: none; }

        .status-bar { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: #1e293b; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div class="flex items-center gap-3">
            <div id="gps-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
            <div class="text-sm font-bold" id="driver-name">× ×”×’ ×œ× ××—×•×‘×¨</div>
        </div>
        <div class="text-xs text-gray-400 font-mono">GPS TRACKING</div>
    </div>

    <div id="login-screen" class="p-10 flex flex-col gap-4 justify-center h-full">
        <h1 class="text-2xl font-bold text-center mb-6">××™ × ×•×”×’ ×”×™×•×?</h1>
        <button onclick="loginDriver('×¢×œ×™')" class="p-4 bg-slate-700 rounded-xl font-bold text-lg">ğŸš› ×¢×œ×™</button>
        <button onclick="loginDriver('×—×›××ª')" class="p-4 bg-slate-700 rounded-xl font-bold text-lg">ğŸ—ï¸ ×—×›××ª</button>
        <button onclick="loginDriver('×¡×œ×××Ÿ')" class="p-4 bg-slate-700 rounded-xl font-bold text-lg">ğŸšš ×¡×œ×××Ÿ</button>
    </div>

    <div id="idle-screen" class="hidden h-full">
        <div class="idle-screen">
            <div class="radar-pulse">
                <i class="fas fa-satellite-dish text-3xl text-green-400"></i>
            </div>
            <div class="mt-4 font-bold text-gray-400">×××ª×™×Ÿ ×œ××©×™××” ××¨×××™...</div>
            <div class="text-xs text-gray-600 mt-2">××™×§×•× ××©×•×“×¨ ×œ×—×"×œ</div>
        </div>
    </div>

    <div id="mission-screen" class="hidden flex-1 flex flex-col">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        let currentDriver = null;
        let watchId = null;

        // ×¦×œ×™×œ ×”×–× ×§×”
        const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/933/933-preview.m4a');

        window.loginDriver = (name) => {
            currentDriver = name;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('idle-screen').classList.remove('hidden');
            document.getElementById('driver-name').innerText = `× ×”×’: ${name}`;
            
            // ×”×ª×—×œ×ª ×©×™×“×•×¨ GPS
            startGPS();
            // ×”×ª×—×œ×ª ×”××–× ×” ×œ××©×™××•×ª
            listenForMissions();
        };

        function startGPS() {
            if ("geolocation" in navigator) {
                watchId = navigator.geolocation.watchPosition(async (position) => {
                    const { latitude, longitude, speed, heading } = position.coords;
                    
                    document.getElementById('gps-indicator').className = "w-3 h-3 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#22c55e]";

                    // ×¢×“×›×•×Ÿ ××™×§×•× ×‘-Firestore ×‘×–××Ÿ ×××ª (×œ×˜×•×‘×ª ××¤×ª ×”××‘×¦×¢×™× ×©×œ ×¨×××™)
                    await setDoc(doc(db, "drivers", currentDriver), {
                        name: currentDriver,
                        location: { lat: latitude, lng: longitude },
                        speed: speed || 0,
                        heading: heading || 0,
                        lastUpdate: serverTimestamp(),
                        status: 'active'
                    });

                }, (err) => {
                    console.error(err);
                    document.getElementById('gps-indicator').className = "w-3 h-3 rounded-full bg-red-500";
                    Swal.fire('×©×’×™××ª GPS', '×—×•×‘×” ×œ××©×¨ ××™×§×•×!', 'error');
                }, { enableHighAccuracy: true });
            }
        }

        function listenForMissions() {
            // ×××–×™×Ÿ ×œ×”×–×× ×•×ª ×©××©×•×™×›×•×ª ×œ× ×”×’ ×”×–×” ×•×”×Ÿ ×‘×¡×˜×˜×•×¡ "×‘×“×¨×š" ××• "×©×•×™×š ×œ× ×”×’"
            const q = query(
                collection(db, "orders"), 
                where("driver", "==", currentDriver),
                where("status", "in", ["assigned", "on_route"]) 
            );

            onSnapshot(q, (snap) => {
                if (snap.empty) {
                    document.getElementById('mission-screen').classList.add('hidden');
                    document.getElementById('idle-screen').classList.remove('hidden');
                    return;
                }

                // ×™×© ××©×™××”!
                const order = snap.docs[0]; // ×œ×•×§×—×™× ××ª ×”×¨××©×•× ×”
                const data = order.data();
                
                showMission(order.id, data);
            });
        }

        function showMission(id, data) {
            document.getElementById('idle-screen').classList.add('hidden');
            const screen = document.getElementById('mission-screen');
            screen.classList.remove('hidden');

            // ×”×¤×¢×œ×ª ×¡××•× ×“ ×× ×–×• ××©×™××” ×—×“×©×”
            alertSound.play().catch(()=>{});
            if(navigator.vibrate) navigator.vibrate([500, 200, 500]);

            screen.innerHTML = `
                <div class="mission-card">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-sm text-gray-400 uppercase font-bold">×™×¢×“ ×”× ×¡×™×¢×”</div>
                            <div class="text-2xl font-black text-white">${data.clientName}</div>
                            <div class="text-lg text-gray-300"><i class="fas fa-map-marker-alt text-red-500"></i> ${data.address}</div>
                        </div>
                        <div class="bg-blue-600 px-3 py-1 rounded font-bold text-xs">#${data.orderNum}</div>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-xl mb-4 flex-1 overflow-y-auto">
                        <div class="text-xs text-gray-500 font-bold mb-2">×ª×›×•×œ×ª ××©×œ×•×—:</div>
                        <div class="text-sm whitespace-pre-line">${data.itemsText}</div>
                    </div>

                    <div class="action-grid">
                        <button onclick="openWaze('${data.address}')" class="big-btn btn-waze">
                            <i class="fas fa-location-arrow text-3xl"></i>
                            × ×•×•×˜ (WAZE)
                        </button>
                        <button onclick="window.open('tel:${data.clientPhone || ''}')" class="big-btn btn-call">
                            <i class="fas fa-phone text-3xl"></i>
                            ×—×™×™×’ ×œ×œ×§×•×—
                        </button>
                    </div>

                    <button onclick="markDelivered('${id}')" class="w-full bg-slate-700 p-4 rounded-xl font-bold text-gray-300 hover:bg-green-600 hover:text-white transition">
                        <i class="fas fa-check-circle"></i> ×¡×™×™× ××©×™××” ×•×“×•×•×— ××¡×™×¨×”
                    </button>
                </div>
            `;
        }

        window.openWaze = (address) => {
            // ×¤×ª×™×—×ª Waze ××•× ×™×‘×¨×¡×œ×™×ª
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const query = encodeURIComponent(address);
            if (isMobile) {
                window.location.href = `waze://?q=${query}&navigate=yes`;
            } else {
                window.open(`https://waze.com/ul?q=${query}&navigate=yes`);
            }
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×œ"×‘×“×¨×š"
            // (××•×¤×¦×™×•× ×œ×™: ××¤×©×¨ ×œ×¢×“×›×Ÿ ×¤×™×™×¨×‘×™×™×¡ ×©×”× ×”×’ ×™×¦×)
        };

        window.markDelivered = async (id) => {
            const { isConfirmed } = await Swal.fire({
                title: '×”×¡×—×•×¨×” × ××¡×¨×”?',
                text: "×”×× ×œ×¡×’×•×¨ ××ª ×”××©×™××”?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '×›×Ÿ, × ××¡×¨!',
                confirmButtonColor: '#22c55e',
                cancelButtonText: '×‘×™×˜×•×œ'
            });

            if (isConfirmed) {
                await updateDoc(doc(db, "orders", id), {
                    status: 'done', // ××¡×™×™× ××ª ×”××©×™××” ×•××¢×œ×™× ××•×ª×” ××”××¡×š
                    deliveredAt: serverTimestamp()
                });
                Swal.fire('×¢×‘×•×“×” ×˜×•×‘×”!', '×”×“×™×•×•×— ×”×ª×§×‘×œ ×‘×—×"×œ', 'success');
            }
        };
    </script>
</body>
</html>
