<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e293b">
    <title>Saban Driver Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; background: #0f172a; transition: background 0.3s; }
        body.light-mode { background: #f8fafc; color: #1e293b; }

        /* ××¤×” ×¢×œ ×›×œ ×”××¡×š */
        #map { flex: 1; width: 100%; height: 100%; z-index: 0; }
        
        /* ×›×¨×˜×™×¡ ×¤×¢×•×œ×” ×¦×£ (Action Bar) */
        .action-card {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(30, 41, 59, 0.98); 
            backdrop-filter: blur(10px);
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000; border-top: 1px solid rgba(255,255,255,0.1);
        }
        body.light-mode .action-card { background: rgba(255, 255, 255, 0.98); border-top: 1px solid #cbd5e1; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .action-card.active { transform: translateY(0); }

        /* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ×’×“×•×œ×™× (Thumb Experience) */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .big-btn {
            height: 60px; border-radius: 16px; font-weight: 800; font-size: 14px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
            cursor: pointer; transition: 0.2s; color: white; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .big-btn:active { transform: scale(0.95); }
        
        .btn-waze { background: #3b82f6; } /* ×›×—×•×œ */
        .btn-call { background: #22c55e; } /* ×™×¨×•×§ */
        .btn-msg { background: #ef4444; } /* ××“×•× */
        .btn-doc { background: #64748b; } /* ××¤×•×¨ */
        
        .btn-start { 
            background: linear-gradient(135deg, #f59e0b, #d97706); width: 100%; height: 75px; 
            font-size: 20px; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
            animation: pulse-glow 2s infinite; display: flex; flex-direction: row; gap: 10px;
        }
        
        .btn-finish {
            background: linear-gradient(135deg, #10b981, #059669); width: 100%; height: 60px;
            font-size: 18px; margin-top: 10px;
        }

        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        /* ×¡×™×›×•×ª ×§×¡× (Magic Pins) */
        .custom-pin { display: flex; align-items: center; justify-content: center; }
        .pin-inner {
            width: 44px; height: 44px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 18px; border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .pin-order { background: #3b82f6; } /* ×›×—×•×œ - ×”×–×× ×” */
        .pin-transfer { background: #f97316; } /* ×›×ª×•× - ×”×¢×‘×¨×” */
        .pin-return { background: #22c55e; } /* ×™×¨×•×§ - ××™×¡×•×£ */

        /* ××™×™×§×•×Ÿ ××©××™×ª ×ª×œ×ª ××™××“ */
        .truck-marker { font-size: 40px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); z-index: 2000 !important; transition: all 1s linear; }

        /* ×¡×¨×’×œ ×¢×œ×™×•×Ÿ */
        .top-bar { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; z-index: 500; pointer-events: none; }
        .top-btn { pointer-events: auto; background: rgba(15, 23, 42, 0.9); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 30px; display: flex; items-center; gap: 8px; font-weight: bold; font-size: 14px; cursor: pointer; backdrop-filter: blur(4px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .light-mode .top-btn { background: white; color: #1e293b; border-color: #cbd5e1; }

        /* ×ª×¤×¨×™×˜ My Stats */
        .stats-modal { display: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="top-btn" onclick="toggleMode()">
            <i class="fas fa-adjust"></i>
        </div>
        <div class="top-btn" onclick="showMyStats()">
            <i class="fas fa-trophy text-yellow-400"></i>
            <span id="driver-name-display">× ×”×’</span>
        </div>
    </div>

    <div id="map"></div>

    <div id="action-sheet" class="action-card">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, arrayUnion, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let map, truckMarker;
        let currentDriver = null;
        let isLightMode = false;
        let activeTaskId = null;
        
        // ×‘× ×§ ××•×˜×™×‘×¦×™×”
        const PRAISES = ["×¢×‘×•×“×” × ×§×™×™×”! âœ¨", "××ª×” ××›×•× ×”! ğŸ¤–", "×”×œ×§×•×— ××‘×¡×•×˜ ×¢×œ×™×š ğŸ¤©", "××œ×•×£ ×”×¢×•×œ× ğŸ†", "×™××œ×œ×” ×œ××©×™××” ×”×‘××” ğŸš€", "××™×Ÿ ×¢×œ×™×š ×¢×œ×™! ğŸ’ª"];

        // --- ××ª×—×•×œ ×”××¢×¨×›×ª ---
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            // ×–×™×”×•×™ ××•×˜×•××˜×™ ××”×œ×™× ×§ ××• LocalStorage
            currentDriver = params.get('driver') || localStorage.getItem('saban_driver');

            if (currentDriver) {
                initDriverApp();
            } else {
                loginFlow();
            }
        };

        async function loginFlow() {
            const { value: name } = await Swal.fire({
                title: '××™ × ×•×”×’?',
                input: 'select',
                inputOptions: {'×¢×œ×™':'×¢×œ×™', '×—×›××ª':'×—×›××ª', '×¡×œ×××Ÿ':'×¡×œ×××Ÿ'},
                allowOutsideClick: false,
                confirmButtonColor: '#3b82f6',
                background: '#1e293b', color: 'white'
            });
            if(name) {
                currentDriver = name;
                localStorage.setItem('saban_driver', name);
                initDriverApp();
            }
        }

        function initDriverApp() {
            document.getElementById('driver-name-display').innerText = currentDriver;
            
            // ×‘×¨×›×ª ×›× ×™×¡×”
            const hour = new Date().getHours();
            const greeting = hour < 12 ? "×‘×•×§×¨ ××•×¨" : "×”×™×™";
            Swal.fire({
                title: `${greeting} ${currentDriver}!`,
                text: '×”××©××™×ª ××ª×•×“×œ×§×ª? ×™××œ×œ×” ×‘×œ××’×Ÿ! ğŸ’ª',
                icon: 'success',
                timer: 2500, showConfirmButton: false,
                background: '#1e293b', color: '#fff',
                toast: true, position: 'top'
            });

            // ××¤×”
            initMap();
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([32.162, 34.844], 14);
            setMapTiles(); // ×˜×¢×™× ×ª ××¨×™×—×™× ×œ×¤×™ ××¦×‘ ×›×”×”/×‘×”×™×¨

            // GPS
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updateTruckLocation, null, { enableHighAccuracy: true });
            }

            // ×”××–× ×” ×œ××©×™××•×ª
            listenForTasks();
        }

        function setMapTiles() {
            const url = isLightMode 
                ? 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
                : 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
            
            L.tileLayer(url, { attribution: 'Saban', maxZoom: 19 }).addTo(map);
        }

        window.toggleMode = () => {
            isLightMode = !isLightMode;
            document.body.classList.toggle('light-mode');
            setMapTiles();
        };

        // --- ×¢×“×›×•×Ÿ ××™×§×•× ××©××™×ª ---
        async function updateTruckLocation(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const heading = pos.coords.heading || 0;

            // ××™×™×§×•×Ÿ ×ª×œ×ª ××™××“ ××¡×ª×•×‘×‘
            const truckHtml = `<div style="transform: rotate(${heading}deg); transition: transform 0.5s;">ğŸšš</div>`;
            const truckIcon = L.divIcon({ className: 'truck-marker', html: truckHtml, iconSize: [40, 40], iconAnchor: [20, 20] });

            if (!truckMarker) {
                truckMarker = L.marker([lat, lng], {icon: truckIcon}).addTo(map);
                map.setView([lat, lng], 16);
            } else {
                truckMarker.setLatLng([lat, lng]);
                truckMarker.setIcon(truckIcon);
            }

            // ×¢×“×›×•×Ÿ ×—×"×œ (×”××•×—)
            await setDoc(doc(db, "drivers", currentDriver), {
                name: currentDriver,
                location: { lat, lng },
                heading: heading,
                lastUpdate: serverTimestamp(),
                status: activeTaskId ? 'busy' : 'free'
            });
        }

        // --- × ×™×”×•×œ ××©×™××•×ª ×•×¡×™×›×•×ª ---
        function listenForTasks() {
            const q = query(collection(db, "orders"), where("driver", "==", currentDriver), where("status", "in", ["assigned", "on_route"]));
            
            onSnapshot(q, (snap) => {
                // × ×§×” ×¡×™×›×•×ª ×™×©× ×•×ª
                map.eachLayer(layer => { if(layer instanceof L.Marker && layer !== truckMarker) map.removeLayer(layer); });

                if (snap.empty) {
                    document.getElementById('action-sheet').classList.remove('active');
                    return;
                }

                snap.forEach(d => {
                    const task = d.data();
                    // ×¡×•×’ ×¡×™×›×”
                    let pinClass = 'pin-order'; // ×‘×¨×™×¨×ª ××—×“×œ: ×”×–×× ×” (×›×—×•×œ)
                    let icon = 'fa-box';
                    
                    if (task.type === 'transfer') { pinClass = 'pin-transfer'; icon = 'fa-exchange-alt'; } // ×”×¢×‘×¨×” (×›×ª×•×)
                    if (task.type === 'return') { pinClass = 'pin-return'; icon = 'fa-undo'; } // ××™×¡×•×£ (×™×¨×•×§)

                    // ××™×§×•× ×“××™ (×‘×¤×•×¢×œ Geocoding)
                    const pinLat = 32.165 + (Math.random() * 0.01);
                    const pinLng = 34.845 + (Math.random() * 0.01);

                    const customIcon = L.divIcon({
                        className: 'custom-pin',
                        html: `<div class="pin-inner ${pinClass}"><i class="fas ${icon}"></i></div>`,
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });

                    const marker = L.marker([pinLat, pinLng], {icon: customIcon}).addTo(map);
                    marker.on('click', () => openActionSheet(d.id, task));
                    
                    // ×× × ×”×’ ×‘× ×¡×™×¢×”, ×¤×ª×— ××•×˜×•××˜×™×ª
                    if (task.status === 'on_route') openActionSheet(d.id, task);
                });
            });
        }

        // --- ×›×¨×˜×™×¡ ×”××©×™××” ×•×”×¤×¢×•×œ×•×ª (The Action Bar) ---
        function openActionSheet(id, task) {
            activeTaskId = id;
            const sheet = document.getElementById('action-sheet');
            sheet.classList.add('active');
            
            const isStarted = task.status === 'on_route';
            const typeLabel = task.type === 'transfer' ? '×”×¢×‘×¨×” ×“×—×•×¤×”' : '×”×–×× ×ª ×œ×§×•×—';
            const textColor = isLightMode ? 'text-slate-800' : 'text-white';

            let html = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="text-[10px] font-bold text-blue-500 uppercase tracking-widest">${typeLabel}</div>
                        <h2 class="text-2xl font-black ${textColor}">${task.clientName}</h2>
                        <div class="text-gray-400 text-sm font-bold"><i class="fas fa-map-pin text-red-500"></i> ${task.address}</div>
                    </div>
                    <div class="bg-slate-700 text-white px-2 py-1 rounded text-xs font-mono">#${task.orderNum}</div>
                </div>`;
            
            // ×ª×¦×•×’×ª ×”×¤×¨×™×˜×™×
            html += `<div class="bg-gray-100/10 p-3 rounded-xl mb-4 text-sm text-gray-400 border border-gray-600 max-h-20 overflow-y-auto">${task.itemsText}</div>`;

            if (!isStarted) {
                // ××¦×‘ 1: ×œ×¤× ×™ ×”×ª×—×œ×”
                html += `
                <button onclick="startMission('${id}')" class="big-btn btn-start">
                    <i class="fas fa-flag-checkered"></i> ×§×‘×œ ××©×™××”
                </button>`;
            } else {
                // ××¦×‘ 2: ×‘× ×¡×™×¢×”
                html += `
                <div class="btn-grid">
                    <button onclick="wazeNav('${task.address}')" class="big-btn btn-waze">
                        <i class="fab fa-waze text-2xl"></i><span class="text-xs">× ×•×•×˜</span>
                    </button>
                    <button onclick="callClient('${task.clientPhone}')" class="big-btn btn-call">
                        <i class="fas fa-phone text-2xl"></i><span class="text-xs">×—×™×™×’</span>
                    </button>
                    <button onclick="viewDoc('${task.pdfUrl}')" class="big-btn btn-doc">
                        <i class="fas fa-eye text-2xl"></i><span class="text-xs">×ª×¢×•×“×”</span>
                    </button>
                </div>
                
                <button onclick="msgDispatch('${id}')" class="mt-3 w-full bg-slate-800 text-gray-300 py-2 rounded-lg text-xs font-bold border border-slate-600">
                    <i class="fas fa-comment-dots text-red-400"></i> ×”×•×“×¢×” ×“×—×•×¤×” ×œ×¡×™×“×•×¨ (SOS)
                </button>

                <button onclick="finishMission('${id}', '${task.clientName}')" class="big-btn btn-finish">
                    <i class="fas fa-check-circle"></i> ×”×’×¢×ª×™ / ×§×¨× ×œ×œ×§×•×—
                </button>`;
            }
            
            sheet.innerHTML = html;
        }

        // --- ×œ×•×’×™×§×” ×¢×¡×§×™×ª ---
        
        // 1. ×§×‘×œ ××©×™××”
        window.startMission = async (id) => {
            // ×¢×“×›×•×Ÿ ×¤×™×™×¨×‘×™×™×¡ -> ××¢×“×›×Ÿ ×—×"×œ (×™×¨×•×§) + ×œ×§×•×— (×¤×¡ ×”×ª×§×“××•×ª)
            await updateDoc(doc(db, "orders", id), { 
                status: 'on_route', 
                chat: arrayUnion({ sender: 'system', text: `ğŸšš ${currentDriver} ×§×™×‘×œ ××ª ×”××©×™××”`, time: new Date().toISOString() })
            });
            // ×¡××•× ×“ ×× ×•×¢
            new Audio('https://assets.mixkit.co/active_storage/sfx/2598/2598-preview.m4a').play().catch(()=>{});
        };

        // 2. Waze
        window.wazeNav = async (addr) => {
            // ×¢×“×›×•×Ÿ ×—×"×œ + ×œ×§×•×—
            if(activeTaskId) {
                 await updateDoc(doc(db, "orders", activeTaskId), { 
                    driverStatus: 'driving_waze',
                    chat: arrayUnion({ sender: 'system', text: `ğŸ“ ${currentDriver} ×”×ª×—×™×œ × ×™×•×•×˜ ×‘-Waze`, time: new Date().toISOString() })
                });
            }
            window.location.href = `waze://?q=${encodeURIComponent(addr)}&navigate=yes`;
        };

        // 3. ×”×•×“×¢×” ×“×—×•×¤×” ×œ×¡×™×“×•×¨ (SOS)
        window.msgDispatch = async (id) => {
            const { value: text } = await Swal.fire({ title: '×”×•×“×¢×” ×œ×¡×™×“×•×¨', input: 'text', background: '#1e293b', color:'white' });
            if(text) {
                // ×¡×˜×˜×•×¡ driver_msg ××§×¤×™×¥ ××“×•× ×‘×—×"×œ
                await updateDoc(doc(db, "orders", id), { 
                    status: 'driver_msg', 
                    chat: arrayUnion({ sender: 'driver', text: `ğŸš¨ × ×”×’: ${text}`, time: new Date().toISOString() })
                });
            }
        };

        // 4. ×”×’×¢×ª×™ / ×¡×™×•×
        window.finishMission = async (id, clientName) => {
            const { isConfirmed } = await Swal.fire({
                title: '×”×’×¢×ª ×œ×™×¢×“?',
                text: `×œ×©×œ×•×— ×œ${clientName} ×”×•×“×¢×ª "×‘×•× ×œ×§×—×ª"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '×›×Ÿ, ×“×•×•×— ×”×’×¢×”!',
                confirmButtonColor: '#22c55e',
                background: '#1e293b', color: '#fff'
            });

            if (isConfirmed) {
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } }); // ×§×•× ×¤×˜×™
                
                // ×©×œ×™×—×ª ×”×•×“×¢×” ×œ×œ×§×•×—
                await updateDoc(doc(db, "orders", id), { 
                    status: 'done', 
                    deliveredAt: serverTimestamp(),
                    chat: arrayUnion({ sender: 'driver', text: `ğŸ ×”× ×”×’ ${currentDriver} ×”×’×™×¢! ×ª×•×“×” ×©×‘×—×¨×ª ×¡×‘×Ÿ.`, time: new Date().toISOString() })
                });
                
                // ×©×‘×— ×¨× ×“×•××œ×™
                const praise = PRAISES[Math.floor(Math.random() * PRAISES.length)];
                Swal.fire({ title: praise, icon: 'success', timer: 2000, showConfirmButton: false });

                document.getElementById('action-sheet').classList.remove('active');
            }
        };

        // --- ×”×“×•×— ×”×™×•××™ (My Stats) ---
        window.showMyStats = async () => {
            // ×©×œ×™×¤×ª × ×ª×•× ×™× ××”×™×•× (×¡×™××•×œ×¦×™×” ×›×¨×’×¢, ××¤×©×¨ ×œ×©×œ×•×£ ××¤×™×™×¨×‘×™×™×¡ ×××™×ª×™)
            const todayDone = 5; // × × ×™×—
            
            Swal.fire({
                title: '×”×‘×™×¦×•×¢×™× ×©×œ×™ ×œ×”×™×•× ğŸ“Š',
                html: `
                    <div class="flex justify-center mb-4"><i class="fas fa-trophy text-yellow-400 text-6xl drop-shadow-lg"></i></div>
                    <div class="text-xl font-bold mb-2">×™×•× ×¤×¦×¦×” ×¢×œ×™!</div>
                    <div class="grid grid-cols-2 gap-4 text-center mb-4">
                        <div class="bg-slate-700 p-2 rounded text-white">
                            <div class="text-xs text-gray-400">××©×™××•×ª</div>
                            <div class="text-2xl font-bold text-blue-400">${todayDone}</div>
                        </div>
                        <div class="bg-slate-700 p-2 rounded text-white">
                            <div class="text-xs text-gray-400">×§"×</div>
                            <div class="text-2xl font-bold text-green-400">42</div>
                        </div>
                    </div>
                    <canvas id="statsChart" width="200" height="100"></canvas>
                `,
                background: '#1e293b', color: 'white',
                didOpen: () => {
                    const ctx = document.getElementById('statsChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['×”×–×× ×•×ª', '×”×¢×‘×¨×•×ª', '××™×¡×•×¤×™×'],
                            datasets: [{
                                data: [3, 1, 1],
                                backgroundColor: ['#3b82f6', '#f97316', '#22c55e'],
                                borderWidth: 0
                            }]
                        },
                        options: { plugins: { legend: { display: false } } }
                    });
                }
            });
        };

        window.viewDoc = (url) => url ? window.open(url) : Swal.fire('××™×Ÿ ××¡××š', '', 'info');
        window.callClient = (phone) => window.open(`tel:${phone}`);

    </script>
</body>
</html>
