<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1e293b">
    <title>Saban Driver | Cockpit</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { background: #0f172a; height: 100vh; overflow: hidden; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; }
        
        /* 驻 转驻住转 转  住 */
        #map { flex: 1; width: 100%; z-index: 0; }
        
        /* 专住 驻注 爪祝 */
        .action-card {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000; border-top: 1px solid rgba(255,255,255,0.1);
        }
        .action-card.active { transform: translateY(0); }

        /* 驻转专 */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .big-btn {
            height: 65px; border-radius: 16px; font-weight: 800; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; transition: 0.2s; color: white; border: none;
        }
        .big-btn:active { transform: scale(0.96); }
        
        .btn-waze { background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .btn-call { background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 4px 15px rgba(22, 163, 74, 0.4); }
        .btn-msg { background: linear-gradient(135deg, #f97316, #ea580c); box-shadow: 0 4px 15px rgba(234, 88, 12, 0.4); }
        .btn-doc { background: #334155; border: 1px solid #475569; }
        
        .btn-start { background: linear-gradient(135deg, #f59e0b, #d97706); width: 100%; height: 70px; font-size: 18px; box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); animation: pulse-glow 2s infinite; }
        
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        /* 拽 驻 */
        .truck-marker { font-size: 32px; filter: drop-shadow(0 0 10px #3b82f6); transition: all 1s linear; }
        .task-marker { 
            width: 40px; height: 40px; background: #1e293b; border: 3px solid; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        /* 转驻专 注 */
        .top-bar { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; z-index: 500; pointer-events: none; }
        .profile-btn { pointer-events: auto; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); padding: 8px 16px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); color: white; display: flex; items-center; gap: 10px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .status-badge { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="profile-btn" onclick="showStats()">
            <div class="status-badge" id="conn-status"></div>
            <span id="driver-name-display">专</span>
        </div>
        <div class="profile-btn" style="padding: 8px;" onclick="centerMap()">
            <i class="fas fa-crosshairs"></i>
        </div>
    </div>

    <div id="map"></div>

    <div id="action-sheet" class="action-card">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let map, truckMarker;
        let currentDriver = localStorage.getItem('saban_driver');
        let activeTaskId = null;
        let watchId = null;

        // --- 转 注专转 ---
        window.onload = async () => {
            if (!currentDriver) await loginFlow();
            else initMap();
        };

        async function loginFlow() {
            const { value: name } = await Swal.fire({
                title: ' 转 注爪, ',
                input: 'select',
                inputOptions: { '注': '注', '转': '转', '住': '住', '住': '住' },
                inputPlaceholder: '专 砖...',
                allowOutsideClick: false,
                confirmButtonText: '住 砖专转 ',
                confirmButtonColor: '#3b82f6',
                background: '#1e293b', color: 'white'
            });
            
            if (name) {
                currentDriver = name;
                localStorage.setItem('saban_driver', name);
                initMap();
                welcomeEffect();
            }
        }

        function initMap() {
            document.getElementById('driver-name-display').innerText = currentDriver;

            // 1. 爪专转 驻 (Dark Mode)
            map = L.map('map', { zoomControl: false }).setView([32.162, 34.844], 13);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Saban OS',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // 2. 驻注转 GPS
            if ("geolocation" in navigator) {
                watchId = navigator.geolocation.watchPosition(updateGPS, 
                    (err) => Swal.fire({icon: 'error', title: ' GPS', text: ' 砖专 拽!'}), 
                    { enableHighAccuracy: true }
                );
            }

            // 3.  砖转
            listenForTasks();
        }

        // --- GPS 砖专 拽 ---
        async function updateGPS(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            
            // 拽 砖转 转 砖转
            const truckIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="font-size: 30px; transform: rotate(${pos.coords.heading || 0}deg);"></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            if (!truckMarker) {
                truckMarker = L.marker([lat, lng], {icon: truckIcon}).addTo(map);
                map.setView([lat, lng], 16);
            } else {
                truckMarker.setLatLng([lat, lng]);
                truckMarker.setIcon(truckIcon);
            }

            // 砖专 " ()
            await setDoc(doc(db, "drivers", currentDriver), {
                name: currentDriver,
                location: { lat, lng },
                heading: pos.coords.heading || 0,
                speed: pos.coords.speed || 0,
                lastUpdate: serverTimestamp(),
                status: activeTaskId ? 'busy' : 'free'
            });
        }

        // ---  砖转 ---
        function listenForTasks() {
            //  转 砖砖  
            const q = query(collection(db, "orders"), where("driver", "==", currentDriver), where("status", "in", ["assigned", "on_route"]));
            
            onSnapshot(q, (snap) => {
                // 拽 住转 砖转 (注 砖转)
                map.eachLayer(layer => { if(layer instanceof L.Marker && layer !== truckMarker) map.removeLayer(layer); });

                if (snap.empty) {
                    closeSheet();
                    activeTaskId = null;
                    return;
                }

                snap.forEach(d => {
                    const task = d.data();
                    
                    // 拽 砖 (驻注 爪专 Geocoding 转,  砖转砖 拽 住  )
                    const pinLat = 32.165 + (Math.random() * 0.02 - 0.01);
                    const pinLng = 34.845 + (Math.random() * 0.02 - 0.01);
                    
                    // 爪注 住 驻 住
                    const isTransfer = task.type === 'transfer';
                    const color = isTransfer ? '#f97316' : '#3b82f6';
                    const iconHtml = `<div class="task-marker" style="border-color: ${color}"><i class="fas ${isTransfer ? 'fa-exchange-alt' : 'fa-box'}"></i></div>`;
                    
                    const marker = L.marker([pinLat, pinLng], {
                        icon: L.divIcon({ html: iconHtml, className: 'custom-pin', iconSize: [40, 40] })
                    }).addTo(map);

                    marker.on('click', () => openTaskSheet(d.id, task));
                    
                    //  砖 砖 驻注 转, 驻转 转 
                    if (snap.size === 1 || task.status === 'on_route') {
                        openTaskSheet(d.id, task);
                    }
                });
            });
        }

        function openTaskSheet(id, task) {
            activeTaskId = id;
            const sheet = document.getElementById('action-sheet');
            sheet.classList.add('active');
            
            const isStarted = task.status === 'on_route';

            let html = `
                <div class="flex justify-between items-start mb-4 text-white">
                    <div>
                        <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                            ${task.type === 'transfer' ? ' 注专  住驻' : ' 转 拽'}
                        </div>
                        <h2 class="text-2xl font-black">${task.clientName}</h2>
                        <div class="text-gray-400 text-sm flex items-center gap-1">
                            <i class="fas fa-map-pin text-red-500"></i> ${task.address}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="bg-slate-700 px-2 py-1 rounded text-xs font-mono">#${task.orderNum}</div>
                    </div>
                </div>
                
                <div class="bg-slate-800/50 p-3 rounded-xl mb-4 border border-slate-700 max-h-24 overflow-y-auto text-sm text-gray-300">
                    ${task.itemsText}
                </div>`;

            if (!isStarted) {
                html += `
                <button onclick="acceptMission('${id}')" class="big-btn btn-start">
                    <i class="fas fa-flag-checkered"></i> 拽 砖 爪 专
                </button>`;
            } else {
                html += `
                <div class="btn-grid">
                    <button onclick="navWaze('${task.address}')" class="big-btn btn-waze">
                        <i class="fab fa-waze text-2xl"></i> 
                    </button>
                    <button onclick="window.open('tel:${task.clientPhone}')" class="big-btn btn-call">
                        <i class="fas fa-phone text-2xl"></i> 
                    </button>
                    <button onclick="msgToCenter('${id}')" class="big-btn btn-msg">
                        <i class="fas fa-comment-alt"></i> 住专
                    </button>
                    <button onclick="viewDoc('${task.pdfUrl}')" class="big-btn btn-doc">
                        <i class="fas fa-file-invoice"></i> 转注
                    </button>
                </div>
                <button onclick="finishMission('${id}')" class="big-btn bg-slate-700 border border-slate-600 mt-3 w-full hover:bg-green-600 hover:border-green-500">
                    <i class="fas fa-check-circle"></i> 驻专拽 砖
                </button>`;
            }
            
            sheet.innerHTML = html;
        }

        window.closeSheet = () => document.getElementById('action-sheet').classList.remove('active');
        window.centerMap = () => { if(truckMarker) map.setView(truckMarker.getLatLng(), 16); };

        // --- 拽 注住拽转 ---
        window.acceptMission = async (id) => {
            // 注 住住 注 住专 拽
            await updateDoc(doc(db, "orders", id), { 
                status: 'on_route', 
                chat: arrayUnion({ sender: 'system', text: ` ${currentDriver} 爪 专!`, time: new Date().toISOString() })
            });
            new Audio('https://assets.mixkit.co/active_storage/sfx/2598/2598-preview.m4a').play().catch(()=>{});
        };

        window.navWaze = (addr) => window.location.href = `waze://?q=${encodeURIComponent(addr)}&navigate=yes`;
        
        window.msgToCenter = async (id) => {
            const { value: text } = await Swal.fire({ title: '注 住专', input: 'text', background: '#1e293b', color:'white', confirmButtonText: '砖' });
            if(text) {
                // 砖 注 砖拽驻爪 "" "
                await updateDoc(doc(db, "orders", id), { 
                    status: 'driver_msg', // 住住 
                    chat: arrayUnion({ sender: 'driver', text: ` : ${text}`, time: new Date().toISOString() })
                });
                Swal.fire({icon:'success', title:'砖', timer:1000, showConfirmButton:false, background:'#1e293b'});
            }
        };

        window.finishMission = async (id) => {
            const { isConfirmed } = await Swal.fire({
                title: '住转?',
                text: ' 砖 拽 注转 "注转"?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: ',  注!',
                confirmButtonColor: '#22c55e',
                background: '#1e293b', color:'white'
            });

            if(isConfirmed) {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.7 } });
                await updateDoc(doc(db, "orders", id), { 
                    status: 'done', 
                    deliveredAt: serverTimestamp(),
                    chat: arrayUnion({ sender: 'driver', text: `  注 注!`, time: new Date().toISOString() })
                });
                closeSheet();
            }
        };

        function welcomeEffect() {
            Swal.fire({ 
                title: ' ! ', 
                text: '砖转 专转 " 专 转.', 
                icon: 'success', 
                background: '#1e293b', color:'white', 
                timer: 2000, showConfirmButton: false 
            });
        }
        
        // 砖驻转 驻拽爪转 -HTML
        window.acceptMission = acceptMission;
        window.navWaze = navWaze;
        window.msgToCenter = msgToCenter;
        window.viewDoc = (url) => url ? window.open(url) : Swal.fire(' 转注', '', 'info');
        window.finishMission = finishMission;
    </script>
</body>
</html>
