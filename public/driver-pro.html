<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>Saban Driver App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* 驻住  转爪转  */
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; background: #fff; }
        
        /* 驻 注  住 */
        #map { flex: 1; width: 100%; height: 100%; z-index: 0; }
        
        /* 驻住 转拽转 (砖) */
        .progress-bar-container {
            position: absolute; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
            padding: 10px 15px; z-index: 500;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none; /* 住转专 砖 砖 */
        }
        .progress-bar-container.active { display: block; animation: slideDown 0.3s ease-out; }
        
        .steps { display: flex; justify-content: space-between; position: relative; }
        .steps::before { content: ''; position: absolute; top: 12px; left: 10px; right: 10px; height: 3px; background: #e2e8f0; z-index: 0; }
        .step { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; }
        .step-dot { width: 24px; height: 24px; border-radius: 50%; background: #fff; border: 3px solid #cbd5e1; transition: 0.3s; }
        .step.active .step-dot { background: #3b82f6; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .step.done .step-dot { background: #22c55e; border-color: #22c55e; }
        .step-label { font-size: 10px; font-weight: bold; color: #94a3b8; margin-top: 4px; }
        .step.active .step-label { color: #3b82f6; }

        /* 专住 驻注 爪祝 */
        .action-card {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; 
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            box-shadow: 0 -5px 40px rgba(0,0,0,0.15);
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000;
        }
        .action-card.active { transform: translateY(0); }

        /* 驻转专 */
        .big-btn {
            height: 60px; border-radius: 14px; font-weight: 800; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; transition: 0.2s; color: white; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .big-btn:active { transform: scale(0.96); }
        
        .btn-waze { background: #3b82f6; }
        .btn-call { background: #22c55e; }
        .btn-msg { background: #f97316; }
        
        .btn-start { 
            background: linear-gradient(135deg, #2563eb, #1d4ed8); width: 100%; height: 75px; 
            font-size: 20px; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
            animation: pulse-btn 2s infinite;
        }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* 拽 驻 */
        .truck-marker { font-size: 40px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); z-index: 1000 !important; }
        .custom-pin { display: flex; align-items: center; justify-content: center; }
        .pin-inner {
            width: 48px; height: 48px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }
        .pin-order { background: #3b82f6; }
        .pin-transfer { background: #f97316; }

        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="progress-bar" class="progress-bar-container">
        <div class="steps">
            <div class="step active" id="step-1"><div class="step-dot"></div><div class="step-label">转拽</div></div>
            <div class="step" id="step-2"><div class="step-dot"></div><div class="step-label">住注</div></div>
            <div class="step" id="step-3"><div class="step-dot"></div><div class="step-label">注</div></div>
            <div class="step" id="step-4"><div class="step-dot"></div><div class="step-label">住</div></div>
        </div>
    </div>

    <div id="map"></div>

    <div id="action-sheet" class="action-card">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let map, truckMarker;
        let currentDriver = null;
        let activeTaskId = null;
        let userLocation = null;

        // --- 转  ---
        window.onload = () => {
            //  拽 (user_id  driver)
            const params = new URLSearchParams(window.location.search);
            //  拽  ?user_id=... 砖转砖  ,  专 砖 
            //    砖-user_id  驻砖 砖  拽 砖转 驻转 砖
            // 转 驻砖转:  砖 user_id  driver,  .
            
            const userId = params.get('user_id');
            const driverName = params.get('driver');
            
            // 驻 专 砖  砖转 (住爪)
            const driverMap = {
                'QHzzWehstGOH1WBccCUS': '注',
                'driver2_code': '转'
            };

            currentDriver = driverName || driverMap[userId] || userId; //   驻, 砖转砖 -ID 砖

            if (currentDriver) {
                // 转专转 爪转 -  注 砖转
                console.log("Logged in as:", currentDriver);
                initMap();
                welcomeDriver(currentDriver);
            } else {
                // 拽专 专 (拽 砖专), 砖
                askDriverName();
            }
        };

        function welcomeDriver(name) {
            const msg = document.createElement('div');
            msg.className = 'fixed top-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg z-[2000] text-sm font-bold flex items-center gap-2 animate-bounce';
            msg.innerHTML = `<span> 砖 ${name}</span>`;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        function initMap() {
            // 驻 专 (OpenStreetMap)
            map = L.map('map', { zoomControl: false }).setView([32.162, 34.844], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Saban',
                maxZoom: 19
            }).addTo(map);

            // GPS
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updateLocation, 
                    (err) => console.log("GPS Error", err), 
                    { enableHighAccuracy: true }
                );
            }

            listenForTasks();
        }

        async function updateLocation(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            userLocation = { lat, lng };

            // 拽 砖转 住转 驻  住注
            const heading = pos.coords.heading || 0;
            const truckHtml = `<div style="transform: rotate(${heading}deg); transition: transform 0.5s;"></div>`;
            const truckIcon = L.divIcon({ className: 'truck-marker', html: truckHtml, iconSize: [40, 40], iconAnchor: [20, 20] });

            if (!truckMarker) {
                truckMarker = L.marker([lat, lng], {icon: truckIcon}).addTo(map);
                map.setView([lat, lng], 16);
            } else {
                truckMarker.setLatLng([lat, lng]);
                truckMarker.setIcon(truckIcon);
            }

            // 砖专 "
            await setDoc(doc(db, "drivers", currentDriver), {
                name: currentDriver,
                location: { lat, lng },
                heading: heading,
                speed: pos.coords.speed || 0,
                lastUpdate: serverTimestamp(),
                status: activeTaskId ? 'busy' : 'free'
            });
        }

        function listenForTasks() {
            //  砖转 砖 
            const q = query(collection(db, "orders"), where("driver", "==", currentDriver), where("status", "in", ["assigned", "on_route"]));
            
            onSnapshot(q, (snap) => {
                // 拽 住转 (抓 砖转)
                map.eachLayer(layer => { if(layer instanceof L.Marker && layer !== truckMarker) map.removeLayer(layer); });

                if (snap.empty) {
                    document.getElementById('action-sheet').classList.remove('active');
                    document.getElementById('progress-bar').classList.remove('active');
                    activeTaskId = null;
                    return;
                }

                snap.forEach(d => {
                    const task = d.data();
                    const isTransfer = task.type === 'transfer';
                    
                    // 爪专转 住 注 驻
                    const pinLat = 32.165 + (Math.random() * 0.01); //  (祝 拽 转)
                    const pinLng = 34.845 + (Math.random() * 0.01);

                    const pinClass = isTransfer ? 'pin-transfer' : 'pin-order';
                    const iconSign = isTransfer ? 'fa-exchange-alt' : 'fa-box';
                    
                    const customIcon = L.divIcon({
                        className: 'custom-pin',
                        html: `<div class="pin-inner ${pinClass}"><i class="fas ${iconSign}"></i></div>`,
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });

                    const marker = L.marker([pinLat, pinLng], {icon: customIcon}).addTo(map);
                    marker.on('click', () => openCard(d.id, task));
                    
                    if (snap.size === 1 || task.status === 'on_route') openCard(d.id, task);
                });
            });
        }

        function openCard(id, task) {
            activeTaskId = id;
            const sheet = document.getElementById('action-sheet');
            const progress = document.getElementById('progress-bar');
            
            sheet.classList.add('active');
            progress.classList.add('active');
            
            // 注 驻住 转拽转
            updateStepper(task.status);

            const isStarted = task.status === 'on_route';
            
            let html = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-[10px] font-bold text-blue-600 uppercase tracking-widest mb-1">
                            ${task.type === 'transfer' ? '注专' : '转 拽'}
                        </div>
                        <h2 class="text-2xl font-black text-slate-800">${task.clientName}</h2>
                        <div class="text-gray-500 text-sm font-bold flex items-center gap-1">
                            <i class="fas fa-map-marker-alt text-red-500"></i> ${task.address}
                        </div>
                    </div>
                    <div class="bg-gray-100 px-3 py-1 rounded text-xs font-bold text-gray-600">#${task.orderNum}</div>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-200 text-sm text-slate-700 max-h-24 overflow-y-auto">
                    ${task.itemsText}
                </div>`;

            if (!isStarted) {
                html += `
                <button onclick="startMission('${id}')" class="big-btn btn-start">
                     拽 砖 爪 专
                </button>`;
            } else {
                html += `
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="navWaze('${task.address}')" class="big-btn btn-waze">
                        <i class="fab fa-waze text-2xl"></i> 住注 注
                    </button>
                    <button onclick="window.open('tel:${task.clientPhone}')" class="big-btn btn-call">
                        <i class="fas fa-phone-alt text-xl"></i> 
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="msgCenter('${id}')" class="big-btn btn-msg">
                        <i class="fas fa-comment-dots"></i> 住专
                    </button>
                     <button onclick="finishMission('${id}')" class="big-btn bg-slate-800 hover:bg-green-600">
                        <i class="fas fa-check-circle"></i> 注转
                    </button>
                </div>`;
            }
            sheet.innerHTML = html;
        }

        function updateStepper(status) {
            const steps = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3'), document.getElementById('step-4')];
            steps.forEach(s => s.className = 'step'); // Reset
            
            if (status === 'assigned') { steps[0].classList.add('active'); }
            if (status === 'on_route') { steps[0].classList.add('done'); steps[1].classList.add('active'); }
            // status 'arrived' etc. can be added
        }

        // --- 驻注转 ---
        window.startMission = async (id) => {
            await updateDoc(doc(db, "orders", id), { 
                status: 'on_route', 
                chat: arrayUnion({ sender: 'system', text: ` ${currentDriver} 爪 专`, time: new Date().toISOString() })
            });
            new Audio('https://assets.mixkit.co/active_storage/sfx/2598/2598-preview.m4a').play().catch(()=>{});
        };

        window.navWaze = (addr) => window.location.href = `waze://?q=${encodeURIComponent(addr)}&navigate=yes`;

        window.msgCenter = async (id) => {
            const { value: text } = await Swal.fire({ title: '注 住专', input: 'text', confirmButtonText: '砖' });
            if(text) await updateDoc(doc(db, "orders", id), { status: 'driver_msg', chat: arrayUnion({ sender: 'driver', text: `: ${text}`, time: new Date().toISOString() }) });
        };

        window.finishMission = async (id) => {
            const { isConfirmed } = await Swal.fire({ title: '住转?', text: ' 注 拽?', icon: 'question', showCancelButton: true, confirmButtonText: '', confirmButtonColor: '#22c55e' });
            if(isConfirmed) {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.7 } });
                await updateDoc(doc(db, "orders", id), { status: 'done', deliveredAt: serverTimestamp() });
                document.getElementById('action-sheet').classList.remove('active');
                document.getElementById('progress-bar').classList.remove('active');
            }
        };

        // Fallback 拽专 砖 
        async function askDriverName() {
            const { value: name } = await Swal.fire({
                title: '砖转 ',
                text: '   拽',
                input: 'select',
                inputOptions: { '注': '注', '转': '转' },
                allowOutsideClick: false
            });
            if(name) {
                currentDriver = name;
                initMap();
            }
        }
    </script>
</body>
</html>
