<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>Saban Driver Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; background: #fff; font-family: -apple-system, sans-serif; }
        #map { flex: 1; width: 100%; height: 100%; z-index: 0; }
        
        /* 驻住 转拽转 (砖) */
        .progress-bar-container {
            position: absolute; top: 0; left: 0; right: 0; z-index: 500;
            background: rgba(255, 255, 255, 0.98); padding: 15px 20px 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .progress-bar-container.active { transform: translateY(0); }
        
        .steps { display: flex; justify-content: space-between; position: relative; padding: 0 10px; }
        .steps::before { content: ''; position: absolute; top: 10px; left: 10px; right: 10px; height: 2px; background: #e2e8f0; z-index: 0; }
        .step { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; }
        .step-dot { width: 22px; height: 22px; background: #fff; border: 3px solid #cbd5e1; border-radius: 50%; transition: 0.3s; z-index: 2; }
        .step.active .step-dot { border-color: #3b82f6; background: #3b82f6; transform: scale(1.2); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
        .step.done .step-dot { background: #22c55e; border-color: #22c55e; }
        .step-label { font-size: 10px; font-weight: 700; color: #94a3b8; margin-top: 6px; }
        .step.active .step-label { color: #3b82f6; }

        /* 专住 驻注 转转 */
        .action-card {
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 24px; padding-bottom: max(24px, env(safe-area-inset-bottom));
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000;
        }
        .action-card.active { transform: translateY(0); }

        /* 驻转专 */
        .big-btn {
            height: 60px; border-radius: 16px; font-weight: 800; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; color: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        .big-btn:active { transform: scale(0.96); }
        .btn-waze { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-call { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .btn-msg { background: linear-gradient(135deg, #f97316, #ea580c); }
        
        .btn-start { 
            background: linear-gradient(135deg, #2563eb, #1e40af); width: 100%; height: 75px; 
            font-size: 20px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
            animation: pulse-btn 2s infinite;
        }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* 转 住 */
        .driver-badge {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);
            padding: 6px 16px; border-radius: 30px; border: 1px solid #e2e8f0;
            font-weight: bold; font-size: 13px; display: flex; items-center; gap: 6px; z-index: 400;
        }
        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* 住转专转 专转  砖 Leaflet Routing Machine ( 专爪 专拽 转 拽) */
        .leaflet-routing-container { display: none !important; }
    </style>
</head>
<body>

    <div class="driver-badge">
        <div class="status-dot"></div>
        <span id="driver-name-display">转专...</span>
    </div>

    <div id="progress-bar" class="progress-bar-container">
        <div class="steps">
            <div class="step active" id="step-1"><div class="step-dot"></div><div class="step-label">转拽</div></div>
            <div class="step" id="step-2"><div class="step-dot"></div><div class="step-label">专</div></div>
            <div class="step" id="step-3"><div class="step-dot"></div><div class="step-label">驻专拽</div></div>
            <div class="step" id="step-4"><div class="step-dot"></div><div class="step-label">住</div></div>
        </div>
    </div>

    <div id="map"></div>
    <div id="action-sheet" class="action-card"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let map, truckMarker, routeControl;
        let currentDriver = null;
        let activeTaskId = null;
        let userPos = { lat: 32.162, lng: 34.844 }; // "砖 专专转 

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const driverMap = { 'QHzzWehstGOH1WBccCUS': '注' };
            currentDriver = params.get('driver') || driverMap[params.get('user_id')] || localStorage.getItem('saban_driver');

            if (currentDriver) {
                localStorage.setItem('saban_driver', currentDriver);
                document.getElementById('driver-name-display').innerText = `: ${currentDriver}`;
                initMap();
            } else {
                loginFlow();
            }
        };

        async function loginFlow() {
            const { value: name } = await Swal.fire({
                title: ' ?',
                input: 'select',
                inputOptions: { '注': '注', '转': '转', '住': '住' },
                confirmButtonColor: '#3b82f6', allowOutsideClick: false
            });
            if(name) {
                currentDriver = name;
                localStorage.setItem('saban_driver', name);
                window.location.reload();
            }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([userPos.lat, userPos.lng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updateLocation, null, { enableHighAccuracy: true });
            }
            listenForTasks();
        }

        async function updateLocation(pos) {
            userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            const heading = pos.coords.heading || 0;

            const iconHtml = `<div style="transform: rotate(${heading}deg); font-size:40px; transition: transform 0.5s;"></div>`;
            const icon = L.divIcon({ className: 'bg-transparent', html: iconHtml, iconSize: [40, 40], iconAnchor: [20, 20] });

            if (!truckMarker) {
                truckMarker = L.marker([userPos.lat, userPos.lng], {icon: icon}).addTo(map);
                map.setView([userPos.lat, userPos.lng], 16);
            } else {
                truckMarker.setLatLng([userPos.lat, userPos.lng]);
                truckMarker.setIcon(icon);
            }

            // 注 " (拽 )
            await setDoc(doc(db, "drivers", currentDriver), {
                name: currentDriver, location: userPos, heading, lastUpdate: serverTimestamp(), status: activeTaskId ? 'busy' : 'free'
            });
        }

        function listenForTasks() {
            const q = query(collection(db, "orders"), where("driver", "==", currentDriver), where("status", "in", ["assigned", "on_route", "arrived"]));
            
            onSnapshot(q, (snap) => {
                if (snap.empty) {
                    resetUI();
                    return;
                }

                const d = snap.docs[0];
                const task = d.data();
                activeTaskId = d.id;

                drawRouteToTask(task.address); // : 砖 住
                updateUI(task);
            });
        }

        // --- : 爪专 住 注 驻 ---
        function drawRouteToTask(address) {
            // 住 专 转转 拽专转 (注专转  注砖 Geocoding)
            //  砖转砖 拽转 爪 拽注 注专 "转 6"  转转  转 
            let destLat = 32.1476, destLng = 34.8870; // 转 6
            if (!address.includes("转")) {
                // 住转 拽 专转 砖
                destLat = userPos.lat + 0.02; 
                destLng = userPos.lng + 0.02;
            }

            if (routeControl) map.removeControl(routeControl);

            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(userPos.lat, userPos.lng),
                    L.latLng(destLat, destLng)
                ],
                lineOptions: { styles: [{color: '#3b82f6', opacity: 0.7, weight: 6}] },
                createMarker: function(i, wp, nWps) {
                    if (i === nWps - 1) {
                        return L.marker(wp.latLng, {
                            icon: L.divIcon({className: 'bg-transparent', html: '<div style="font-size:30px;"></div>', iconSize: [30,30], iconAnchor:[15,30]})
                        });
                    }
                    return null; //  住 转 (砖 砖转)
                },
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true
            }).addTo(map);
        }

        function updateUI(task) {
            const sheet = document.getElementById('action-sheet');
            const progress = document.getElementById('progress-bar');
            sheet.classList.add('active');
            progress.classList.add('active');

            // 注 砖
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active', 'done'));
            if (task.status === 'assigned') { document.getElementById('step-1').classList.add('active'); }
            if (task.status === 'on_route') { 
                document.getElementById('step-1').classList.add('done');
                document.getElementById('step-2').classList.add('active'); 
            }
            if (task.status === 'arrived') {
                document.getElementById('step-1').classList.add('done');
                document.getElementById('step-2').classList.add('done');
                document.getElementById('step-3').classList.add('active');
            }

            const isTransfer = task.type === 'transfer';
            const title = isTransfer ? '注专  住驻' : '转 拽';
            const titleColor = isTransfer ? 'text-orange-600' : 'text-blue-600';

            // 专专 专住
            let html = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="text-[10px] font-bold ${titleColor} uppercase tracking-widest mb-1">${title}</div>
                        <h2 class="text-xl font-black text-slate-800">${task.clientName}</h2>
                        <div class="text-gray-500 text-sm flex items-center gap-1"><i class="fas fa-map-pin text-red-500"></i> ${task.address}</div>
                    </div>
                    <div class="bg-gray-100 px-2 py-1 rounded text-xs font-bold text-gray-600">#${task.orderNum}</div>
                </div>
                <div class="bg-slate-50 p-3 rounded-xl mb-4 border border-slate-200 text-sm text-slate-700 max-h-24 overflow-y-auto whitespace-pre-line">${task.itemsText}</div>`;

            if (task.status === 'assigned') {
                html += `<button onclick="updateStatus('on_route')" class="big-btn btn-start"> 拽 砖 爪 专</button>`;
            } else if (task.status === 'on_route') {
                html += `
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="nav('${task.address}')" class="big-btn btn-waze"><i class="fab fa-waze text-2xl"></i> </button>
                    <button onclick="call('${task.clientPhone}')" class="big-btn btn-call"><i class="fas fa-phone text-xl"></i> </button>
                </div>
                <button onclick="updateStatus('arrived')" class="big-btn bg-slate-800 hover:bg-green-600 w-full text-white"><i class="fas fa-map-marker-alt"></i> 注转 注</button>`;
            } else if (task.status === 'arrived') {
                html += `<button onclick="finishTask()" class="big-btn bg-green-600 text-white w-full shadow-lg"><i class="fas fa-check-circle text-2xl"></i> 驻专拽 砖 - 住</button>`;
            }

            sheet.innerHTML = html;
        }

        function resetUI() {
            document.getElementById('action-sheet').classList.remove('active');
            document.getElementById('progress-bar').classList.remove('active');
            if (routeControl) map.removeControl(routeControl);
            activeTaskId = null;
        }

        // --- 驻注转 转 ---
        window.updateStatus = async (status) => {
            if(!activeTaskId) return;
            const msgMap = {
                'on_route': ` ${currentDriver} 爪 专`,
                'arrived': ` ${currentDriver} 注 注`
            };
            await updateDoc(doc(db, "orders", activeTaskId), { 
                status: status,
                chat: arrayUnion({ sender: 'system', text: msgMap[status], time: new Date().toISOString() })
            });
        };

        window.nav = (addr) => window.location.href = `waze://?q=${encodeURIComponent(addr)}&navigate=yes`;
        window.call = (phone) => window.location.href = `tel:${phone}`;

        window.finishTask = async () => {
            if(!activeTaskId) return;
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
            await updateDoc(doc(db, "orders", activeTaskId), { 
                status: 'done', 
                deliveredAt: serverTimestamp(),
                chat: arrayUnion({ sender: 'driver', text: ` 驻专拽 砖 注" ${currentDriver}`, time: new Date().toISOString() })
            });
            Swal.fire({ icon: 'success', title: '驻!', timer: 2000, showConfirmButton: false });
        };
    </script>
</body>
</html>
