<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>Saban Driver | Live Ops</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* CSS 拽  */
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; background: #fff; font-family: -apple-system, sans-serif; }
        #map { flex: 1; width: 100%; height: 100%; z-index: 0; }
        
        /* 转  转 () */
        .live-stats {
            position: absolute; top: 10px; left: 10px; z-index: 500;
            background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 12px; border-radius: 12px;
            font-size: 12px; font-weight: bold; display: none; backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .live-stats.active { display: flex; flex-direction: column; gap: 2px; animation: slideIn 0.3s; }

        /* 住住  注 */
        .driver-badge {
            position: absolute; top: 10px; right: 10px; z-index: 500;
            background: white; padding: 6px 12px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-weight: bold; font-size: 12px;
            display: flex; items-center; gap: 6px; border: 1px solid #e2e8f0;
        }
        .pulse-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }

        /* 专住 砖 */
        .action-card {
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px; box-shadow: 0 -5px 40px rgba(0,0,0,0.2);
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000; padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        .action-card.active { transform: translateY(0); }

        /* 驻转专 */
        .big-btn {
            height: 55px; border-radius: 12px; font-weight: 800; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; color: white; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .big-btn:active { transform: scale(0.96); }
        .btn-waze { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-start { 
            background: linear-gradient(135deg, #10b981, #059669); width: 100%; height: 70px; 
            font-size: 20px; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
            animation: bounce-slow 3s infinite;
        }
        
        /* 拽 */
        .truck-marker { font-size: 40px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); z-index: 2000 !important; transition: all 1s linear; }
        .custom-pin { display: flex; align-items: center; justify-content: center; }
        .pin-inner { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .pin-transfer { background: #f97316; } /* 转 */
        
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <div class="driver-badge">
        <div class="pulse-dot"></div>
        <span id="driver-name">转专...</span>
    </div>

    <div id="route-stats" class="live-stats">
        <div class="text-yellow-400"><i class="fas fa-clock"></i> <span id="time-val">--</span></div>
        <div class="text-blue-300"><i class="fas fa-road"></i> <span id="dist-val">--</span></div>
    </div>

    <div id="map"></div>
    
    <div id="action-sheet" class="action-card"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, arrayUnion, writeBatch, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let map, truckMarker, routeLayer;
        let currentDriver = '注'; // 专专转  转专砖
        let currentLocation = { lat: 32.1476, lng: 34.8870 }; // 专专转 : 转 6,  砖专
        let activeTaskId = null;

        // --- 转 ---
        window.onload = async () => {
            // 住  拽
            const params = new URLSearchParams(window.location.search);
            if(params.get('driver')) currentDriver = params.get('driver');
            
            document.getElementById('driver-name').innerText = currentDriver;
            
            initMap();
            
            // 拽转 "拽 " ( 拽  &reset=true)
            if(params.get('reset')) await cleanUpData();
            
            // 转专转 -GPS 砖专 拽 专砖
            updateLocation({ coords: { latitude: currentLocation.lat, longitude: currentLocation.lng, heading: 0 } });
        };

        function initMap() {
            // 驻 专 
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([currentLocation.lat, currentLocation.lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updateLocation, 
                    (err) => console.log("GPS Simulation Mode"), 
                    { enableHighAccuracy: true }
                );
            }
            
            listenForTasks();
        }

        async function updateLocation(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            currentLocation = { lat, lng }; // 砖专转 拽  砖

            // 砖转 注 驻
            const truckHtml = `<div style="transform: rotate(${pos.coords.heading || 0}deg); transition: transform 0.5s;"></div>`;
            const truckIcon = L.divIcon({ className: 'truck-marker', html: truckHtml, iconSize: [44, 44], iconAnchor: [22, 22] });

            if (!truckMarker) {
                truckMarker = L.marker([lat, lng], {icon: truckIcon}).addTo(map);
            } else {
                truckMarker.setLatLng([lat, lng]);
                truckMarker.setIcon(truckIcon);
            }
            
            // 注 "
            await setDoc(doc(db, "drivers", currentDriver), {
                name: currentDriver, location: { lat, lng }, lastUpdate: serverTimestamp()
            });
        }

        // --- : 砖 住  (Routing) ---
        function calculateRoute(destLat, destLng) {
            // 砖砖 -OSRM (Open Source Routing Machine) 
            const url = `https://router.project-osrm.org/route/v1/driving/${currentLocation.lng},${currentLocation.lat};${destLng},${destLat}?overview=false`;
            
            fetch(url).then(res => res.json()).then(data => {
                if(data.routes && data.routes.length > 0) {
                    const duration = Math.round(data.routes[0].duration / 60); // 拽转
                    const distance = (data.routes[0].distance / 1000).toFixed(1); // 拽"
                    
                    // 注 转爪 爪驻
                    const stats = document.getElementById('route-stats');
                    stats.classList.add('active');
                    document.getElementById('time-val').innerText = `${duration} 拽'`;
                    document.getElementById('dist-val').innerText = `${distance} 拽"`;
                }
            }).catch(e => console.log("Routing Error", e));
        }

        // ---  砖转 ---
        function listenForTasks() {
            const q = query(collection(db, "orders"), where("driver", "==", currentDriver), where("status", "in", ["assigned", "on_route"]));
            
            onSnapshot(q, (snap) => {
                // 拽 驻 (抓 砖转)
                map.eachLayer(layer => { if(layer instanceof L.Marker && layer !== truckMarker) map.removeLayer(layer); });

                if (snap.empty) {
                    document.getElementById('action-sheet').classList.remove('active');
                    document.getElementById('route-stats').classList.remove('active');
                    return;
                }

                snap.forEach(d => {
                    const task = d.data();
                    
                    // 拽 注 (住爪  砖转砖 拽专转 转转  砖,  爪 )
                    // 注  砖 (  -DB)
                    const destLat = 32.1650; // 专 转注砖 
                    const destLng = 34.8450;
                    
                    // 驻注转  (砖 住)
                    calculateRoute(destLat, destLng);

                    // 住 转 (注专)
                    const icon = L.divIcon({
                        className: 'custom-pin',
                        html: `<div class="pin-inner pin-transfer"><i class="fas fa-exchange-alt"></i></div>`,
                        iconSize: [50, 50]
                    });

                    L.marker([destLat, destLng], {icon: icon}).addTo(map);
                    openTaskCard(d.id, task);
                });
            });
        }

        function openTaskCard(id, task) {
            activeTaskId = id;
            const sheet = document.getElementById('action-sheet');
            sheet.classList.add('active');
            
            const isStarted = task.status === 'on_route';

            let html = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-[11px] font-bold text-orange-600 uppercase tracking-widest mb-1">
                            <i class="fas fa-dolly"></i> 注专 驻
                        </div>
                        <h2 class="text-xl font-black text-slate-800">${task.clientName}</h2>
                        <div class="text-gray-500 text-sm font-bold flex items-center gap-1 mt-1">
                            <i class="fas fa-map-pin text-red-500"></i> ${task.address}
                        </div>
                    </div>
                    <div class="bg-orange-100 text-orange-800 px-3 py-1 rounded text-xs font-bold border border-orange-200">
                        #${task.orderNum}
                    </div>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl mb-5 border border-slate-200 text-sm text-slate-700 max-h-24 overflow-y-auto">
                    ${task.itemsText}
                </div>`;

            if (!isStarted) {
                html += `
                <button onclick="acceptMission('${id}')" class="big-btn btn-start">
                    <i class="fas fa-truck-loading"></i> 拽 转 住注
                </button>`;
            } else {
                html += `
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="navWaze('${task.address}')" class="big-btn btn-waze">
                        <i class="fab fa-waze text-2xl"></i> 住注 注
                    </button>
                    <button onclick="finishMission('${id}')" class="big-btn bg-slate-800 text-white">
                        <i class="fas fa-check-circle text-xl"></i> 住 驻专拽
                    </button>
                </div>`;
            }
            sheet.innerHTML = html;
        }

        // --- 驻注转 ---
        window.acceptMission = async (id) => {
            await updateDoc(doc(db, "orders", id), { status: 'on_route' });
            new Audio('https://assets.mixkit.co/active_storage/sfx/2598/2598-preview.m4a').play().catch(()=>{});
        };

        window.navWaze = (addr) => window.location.href = `waze://?q=${encodeURIComponent(addr)}&navigate=yes`;

        window.finishMission = async (id) => {
            const { isConfirmed } = await Swal.fire({ title: '住转?', icon: 'question', showCancelButton: true, confirmButtonText: '', confirmButtonColor: '#22c55e' });
            if(isConfirmed) {
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                await updateDoc(doc(db, "orders", id), { status: 'done', deliveredAt: serverTimestamp() });
                document.getElementById('action-sheet').classList.remove('active');
                document.getElementById('route-stats').classList.remove('active');
            }
        };

        // ---  拽  (驻注 转 拽住  注" 驻专专 拽) ---
        window.cleanUpData = async () => {
            const batch = writeBatch(db);
            const q = query(collection(db, "orders"), where("driver", "==", currentDriver));
            const snap = await getDocs(q);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
            console.log("Ч Data cleaned for", currentDriver);
            Swal.fire('爪注 拽', '转  拽', 'info');
        };
        
        // --- 住爪转 注专 (驻注 拽住: createTransfer()) ---
        window.createTransfer = async () => {
            await addDoc(collection(db, "orders"), {
                driver: currentDriver,
                clientName: "住祝 转",
                address: "转 6,  砖专",
                itemsText: " 注专转 住专:\n- 10 砖拽 \n- 2 砖 拽",
                status: "assigned",
                orderNum: "TR-500",
                type: "transfer",
                createdAt: serverTimestamp(),
                lastUpdate: serverTimestamp()
            });
        };

    </script>
</body>
</html>
