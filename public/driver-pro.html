<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>Saban Driver Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { background: #0f172a; height: 100vh; overflow: hidden; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; }
        
        /* ×”××¤×” */
        #map { flex: 1; width: 100%; z-index: 0; }
        
        /* ×›×¨×˜×™×¡ ××©×™××” ×¦×£ (Floating Action Card) */
        .action-card {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #1e293b; border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            transform: translateY(110%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1000; border-top: 1px solid #334155;
        }
        .action-card.active { transform: translateY(0); }

        /* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ×¢× ×§×™×™× */
        .big-btn {
            height: 70px; border-radius: 16px; font-weight: 800; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; transition: 0.2s; color: white;
        }
        .big-btn:active { transform: scale(0.95); }
        .btn-waze { background: #3b82f6; box-shadow: 0 4px 0 #1d4ed8; }
        .btn-call { background: #22c55e; box-shadow: 0 4px 0 #15803d; }
        .btn-start { background: #f59e0b; box-shadow: 0 4px 0 #d97706; width: 100%; height: 80px; font-size: 20px; }
        
        /* ×ª×¤×¨×™×˜ ×”××‘×•×¨×’×¨ ×¦×£ */
        .fab-menu {
            position: fixed; top: 20px; right: 20px;
            width: 50px; height: 50px; background: rgba(30, 41, 59, 0.9);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; z-index: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* ××™×™×§×•×Ÿ ××©××™×ª */
        .truck-icon { font-size: 30px; color: #3b82f6; text-shadow: 0 0 10px rgba(59, 130, 246, 0.8); }
        .pin-marker { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div class="fab-menu" onclick="openMenu()">
        <i class="fas fa-bars"></i>
    </div>

    <div id="map"></div>

    <div id="action-sheet" class="action-card">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        // ×”×’×“×¨×•×ª ×¨××©×•× ×™×•×ª
        let map, truckMarker;
        let currentDriver = localStorage.getItem('saban_driver') || null;
        let activeTaskId = null;

        // ××ª×—×•×œ
        window.onload = () => {
            if(!currentDriver) selectDriver();
            else initSystem();
        };

        async function selectDriver() {
            const { value: name } = await Swal.fire({
                title: '××™ × ×•×”×’ ×”×™×•×? ğŸšš',
                input: 'select',
                inputOptions: { '×¢×œ×™': '×¢×œ×™', '×—×›××ª': '×—×›××ª', '×¡×œ×××Ÿ': '×¡×œ×××Ÿ' },
                inputPlaceholder: '×‘×—×¨ × ×”×’',
                allowOutsideClick: false,
                confirmButtonColor: '#3b82f6'
            });
            if(name) {
                currentDriver = name;
                localStorage.setItem('saban_driver', name);
                
                // ×‘×¨×›×ª ×›× ×™×¡×”
                Swal.fire({
                    title: `×‘×•×§×¨ ×˜×•×‘ ${name}!`,
                    text: '×”××©××™×ª ××ª×•×“×œ×§×ª? ×™××œ×œ×” ×œ×¢×‘×•×“×” ğŸ’ª',
                    icon: 'success',
                    timer: 2000, showConfirmButton: false
                });
                initSystem();
            }
        }

        function initSystem() {
            // 1. ××ª×—×•×œ ××¤×”
            map = L.map('map').setView([32.162, 34.844], 13); // ××¨×›×– ×‘×¨×™×¨×ª ××—×“×œ (×”×•×“"×©)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(map);

            // 2. ×”×ª×—×œ×ª GPS
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updatePosition, 
                (err) => Swal.fire('×©×’×™××ª GPS', '×”×¤×¢×œ ××™×§×•×!', 'error'), 
                { enableHighAccuracy: true });
            }

            // 3. ×”××–× ×” ×œ××©×™××•×ª
            listenForTasks();
        }

        // ×¢×“×›×•×Ÿ ××™×§×•× ××©××™×ª
        async function updatePosition(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            
            // ×¢×“×›×•×Ÿ ××™×™×§×•×Ÿ ×”××©××™×ª
            if (!truckMarker) {
                const icon = L.divIcon({ className: 'truck-icon', html: '<i class="fas fa-truck-moving"></i>', iconSize: [30, 30] });
                truckMarker = L.marker([lat, lng], {icon: icon}).addTo(map);
                map.setView([lat, lng], 15);
            } else {
                truckMarker.setLatLng([lat, lng]);
            }

            // ×©×™×“×•×¨ ×œ×—×"×œ
            await setDoc(doc(db, "drivers", currentDriver), {
                name: currentDriver,
                location: { lat, lng },
                lastUpdate: serverTimestamp(),
                status: activeTaskId ? 'busy' : 'idle'
            });
        }

        // ×”××–× ×” ×œ××©×™××•×ª
        function listenForTasks() {
            const q = query(collection(db, "orders"), where("driver", "==", currentDriver), where("status", "in", ["assigned", "on_route"]));
            
            onSnapshot(q, (snap) => {
                // × ×™×§×•×™ ×¡×™×›×•×ª ×™×©× ×•×ª (×‘×¤×©×˜×•×ª × ××—×§ ×”×›×œ ×•× ×•×¡×™×£)
                map.eachLayer(layer => { if(layer instanceof L.Marker && layer !== truckMarker) map.removeLayer(layer); });

                if(snap.empty) {
                    hideActionSheet();
                    activeTaskId = null;
                    return;
                }

                snap.forEach(d => {
                    const task = d.data();
                    const isTransfer = task.type === 'transfer'; // × × ×™×— ×©×™×© ×©×“×” ×›×–×”
                    
                    // ×”×•×¡×¤×ª ×¡×™×›×” ×œ××¤×” (××™×§×•× ××–×•×™×£ ×›×¨×’×¢ ×œ×¡×™××•×œ×¦×™×” ×× ××™×Ÿ, ××• ×©×™××•×© ×‘×›×ª×•×‘×ª)
                    // ×œ×¦×•×¨×š ×”×“×•×’××” × ×©×™× × ×§×•×“×” ×œ×™×“ ×”××©××™×ª
                    const destLat = 32.165 + (Math.random()*0.01); 
                    const destLng = 34.845 + (Math.random()*0.01);
                    
                    const pinColor = isTransfer ? 'bg-orange-500' : 'bg-blue-500';
                    const icon = L.divIcon({ 
                        className: 'custom-pin',
                        html: `<div class="pin-marker ${pinColor} text-white"><i class="fas ${isTransfer ? 'fa-dolly' : 'fa-box'}"></i></div>`,
                        iconSize: [40, 40]
                    });

                    const marker = L.marker([destLat, destLng], {icon: icon}).addTo(map);
                    marker.on('click', () => openTask(d.id, task));
                    
                    // ×× ×–×• ××©×™××” ×¤×¢×™×œ×”, × ×¤×ª×— ××•×ª×” ××•×˜×•××˜×™×ª
                    if (task.status === 'on_route' || snap.size === 1) {
                        openTask(d.id, task);
                    }
                });
            });
        }

        function openTask(id, task) {
            activeTaskId = id;
            const sheet = document.getElementById('action-sheet');
            sheet.classList.add('active');

            const isStarted = task.status === 'on_route';

            sheet.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">
                            ${task.type === 'transfer' ? 'ğŸŸ  ×”×¢×‘×¨×” ×“×—×•×¤×”' : 'ğŸ”µ ×”×–×× ×ª ×œ×§×•×—'}
                        </div>
                        <h2 class="text-2xl font-black text-white">${task.clientName}</h2>
                        <div class="text-gray-400 text-sm"><i class="fas fa-map-marker-alt text-red-500"></i> ${task.address}</div>
                    </div>
                    <div class="bg-slate-700 px-3 py-1 rounded font-mono text-xs text-white">#${task.orderNum}</div>
                </div>
                
                <div class="bg-slate-800/50 p-3 rounded-lg mb-4 text-sm text-gray-300 border border-slate-700 max-h-24 overflow-y-auto">
                    ${task.itemsText}
                </div>

                ${!isStarted ? `
                    <button onclick="startMission('${id}')" class="big-btn btn-start animate-pulse">
                        ğŸš€ ×§×‘×œ ××©×™××” ×•×¦× ×œ×“×¨×š
                    </button>
                ` : `
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button onclick="wazeNav('${task.address}')" class="big-btn btn-waze">
                            <i class="fab fa-waze text-2xl"></i> ×¡×¢
                        </button>
                        <button onclick="window.open('tel:${task.phone || ''}')" class="big-btn btn-call">
                            <i class="fas fa-phone text-2xl"></i> ×—×™×™×’
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                         <button onclick="openDoc('${task.pdfUrl}')" class="big-btn bg-slate-700 border border-slate-600">
                            <i class="fas fa-eye"></i> ×ª×¢×•×“×”
                        </button>
                        <button onclick="finishMission('${id}', '${task.clientName}')" class="big-btn bg-slate-700 border border-slate-600 hover:bg-green-600 hover:border-green-500 transition-colors">
                            <i class="fas fa-check-circle"></i> ×”×’×¢×ª×™
                        </button>
                    </div>
                `}
            `;
        }

        window.hideActionSheet = () => document.getElementById('action-sheet').classList.remove('active');

        // ×¤×¢×•×œ×•×ª
        window.startMission = async (id) => {
            // ×¢×“×›×•×Ÿ ×—×"×œ + ×œ×§×•×—
            await updateDoc(doc(db, "orders", id), { 
                status: 'on_route', 
                driverStatus: 'moving',
                chat: arrayUnion({ sender: 'system', type: 'driver_update', text: `ğŸšš ×”× ×”×’ ${currentDriver} ×§×™×‘×œ ××ª ×”××©×™××” ×•×™×¦× ×œ×“×¨×š!`, time: new Date().toISOString() })
            });
            
            // ×¡××•× ×“ ×× ×•×¢
            new Audio('https://assets.mixkit.co/active_storage/sfx/2598/2598-preview.m4a').play().catch(()=>{});
        };

        window.wazeNav = (address) => {
            // ×“×™×•×•×— ×œ×œ×§×•×— ×©×”× ×”×’ ×‘Waze
            // (××¤×©×¨ ×œ×”×•×¡×™×£ ×›××Ÿ ×¢×“×›×•×Ÿ ×œ×¤×™×™×¨×‘×™×™×¡)
            window.location.href = `waze://?q=${encodeURIComponent(address)}&navigate=yes`;
        };

        window.openDoc = (url) => {
            if(url) window.open(url, '_blank');
            else Swal.fire('××™×Ÿ ××¡××š', '×œ× ×¦×•×¨×¤×” ×ª×¢×•×“×” ×œ××©×™××” ×–×•', 'info');
        };

        window.finishMission = async (id, clientName) => {
            const { isConfirmed } = await Swal.fire({
                title: '×”×’×¢×ª ×œ×™×¢×“?',
                text: `×”×× ×œ×©×œ×•×— ×”×•×“×¢×ª "×”×’×¢×ª×™" ×œ${clientName}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '×›×Ÿ, ×“×•×•×— ×”×’×¢×”! ğŸ‰',
                confirmButtonColor: '#22c55e',
                background: '#1e293b', color: '#fff'
            });

            if (isConfirmed) {
                // ×§×•× ×¤×˜×™
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                
                // ×¢×“×›×•×Ÿ ×¡×™×•×
                await updateDoc(doc(db, "orders", id), { 
                    status: 'done', 
                    deliveredAt: serverTimestamp(),
                    chat: arrayUnion({ sender: 'driver', text: `ğŸ ×”× ×”×’ ${currentDriver} ×”×’×™×¢ ×œ×›×ª×•×‘×ª! ×‘×•× ×œ×§×‘×œ ××ª ×”×¡×—×•×¨×”.`, time: new Date().toISOString() })
                });

                Swal.fire({
                    title: '×¢×‘×•×“×” ×¤×¦×¦×”! ğŸ”¥',
                    text: '×”×“×™×•×•×— × ×©×œ×— ×œ×œ×§×•×— ×•×œ×—×"×œ. ×›×œ ×”×›×‘×•×“!',
                    icon: 'success',
                    timer: 3000, showConfirmButton: false,
                    background: '#1e293b', color: '#fff'
                });
                
                hideActionSheet();
            }
        };

        window.openMenu = () => {
             Swal.fire({
                title: '×ª×¤×¨×™×˜ × ×”×’',
                html: `
                    <div class="text-left bg-slate-800 p-4 rounded text-white">
                        <div class="mb-2">ğŸ‘¤ × ×”×’: <b>${currentDriver}</b></div>
                        <div class="mb-2">ğŸ“Š ××©×™××•×ª ×”×™×•×: <b>3</b></div>
                        <div>â­ ×“×™×¨×•×’ ×©×‘×™×¢×•×ª ×¨×¦×•×Ÿ: <b>5.0</b></div>
                    </div>
                `,
                background: '#0f172a', color: '#fff',
                showConfirmButton: false,
                showCloseButton: true
             });
        };

    </script>
</body>
</html>
