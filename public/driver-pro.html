<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>Saban Driver</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; background: #fff; font-family: -apple-system, sans-serif; }
        #map { flex: 1; width: 100%; height: 100%; z-index: 0; }
        
        /* ×¤×¡ ×”×ª×§×“××•×ª */
        .progress-bar-container {
            position: absolute; top: 0; left: 0; right: 0; z-index: 500;
            background: rgba(255, 255, 255, 0.95); padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 1px solid #e2e8f0;
            transform: translateY(-100%); transition: transform 0.3s;
        }
        .progress-bar-container.active { transform: translateY(0); }
        .steps { display: flex; justify-content: space-between; position: relative; }
        .steps::before { content: ''; position: absolute; top: 10px; left: 0; right: 0; height: 2px; background: #e2e8f0; z-index: -1; }
        .step-dot { width: 20px; height: 20px; background: #fff; border: 3px solid #cbd5e1; border-radius: 50%; transition: 0.3s; }
        .step.active .step-dot { border-color: #3b82f6; background: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .step-label { font-size: 10px; color: #94a3b8; margin-top: 4px; font-weight: bold; }
        .step.active .step-label { color: #3b82f6; }

        /* ×›×¨×˜×™×¡ ×¤×¢×•×œ×” */
        .action-card {
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px; box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000; padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        .action-card.active { transform: translateY(0); }

        /* ×›×¤×ª×•×¨×™× */
        .big-btn {
            height: 60px; border-radius: 14px; font-weight: 800; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; color: white; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .big-btn:active { transform: scale(0.96); }
        .btn-waze { background: #3b82f6; }
        .btn-call { background: #22c55e; }
        .btn-start { 
            background: linear-gradient(135deg, #2563eb, #1d4ed8); width: 100%; height: 70px; 
            font-size: 18px; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
            animation: pulse-btn 2s infinite;
        }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* ××™×™×§×•× ×™× */
        .truck-marker { font-size: 40px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); z-index: 1000 !important; }
        .custom-pin { display: flex; align-items: center; justify-content: center; }
        .pin-inner { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .pin-order { background: #3b82f6; }

        /* ×›×¤×ª×•×¨ ×“××• (×–×× ×™) */
        .demo-btn { position: absolute; top: 100px; right: 20px; z-index: 999; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="progress-bar" class="progress-bar-container">
        <div class="steps">
            <div class="step active"><div class="step-dot"></div><div class="step-label">×”×ª×§×‘×œ</div></div>
            <div class="step" id="step-nav"><div class="step-dot"></div><div class="step-label">×‘× ×¡×™×¢×”</div></div>
            <div class="step" id="step-done"><div class="step-dot"></div><div class="step-label">×¡×™×•×</div></div>
        </div>
    </div>

    <div id="map"></div>
    
    <div class="demo-btn" onclick="createDemoTask()">ğŸ› ï¸ ×¦×•×¨ ××©×™××” (×‘×“×™×§×”)</div>

    <div id="action-sheet" class="action-card"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, arrayUnion, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let map, truckMarker;
        let currentDriver = null;
        let activeTaskId = null;

        window.onload = () => {
            // ×–×™×”×•×™ ××”×™×¨ ××”-URL
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('user_id');
            const driverName = params.get('driver');
            
            // ××™×¤×•×™ ×¤×©×•×˜
            const driverMap = { 'QHzzWehstGOH1WBccCUS': '×¢×œ×™' };
            currentDriver = driverName || driverMap[userId] || '××•×¨×—';

            console.log("Driver:", currentDriver);
            initMap();
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([32.162, 34.844], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updatePos, null, { enableHighAccuracy: true });
            }
            
            listenForTasks();
        }

        async function updatePos(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const heading = pos.coords.heading || 0;

            const html = `<div style="transform: rotate(${heading}deg); transition: transform 0.5s;">ğŸšš</div>`;
            const icon = L.divIcon({ className: 'truck-marker', html: html, iconSize: [40, 40], iconAnchor: [20, 20] });

            if (!truckMarker) {
                truckMarker = L.marker([lat, lng], {icon: icon}).addTo(map);
                map.setView([lat, lng], 16);
            } else {
                truckMarker.setLatLng([lat, lng]);
                truckMarker.setIcon(icon);
            }
            
            // ×¢×“×›×•×Ÿ ×—×"×œ
            if(currentDriver !== '××•×¨×—') {
                await setDoc(doc(db, "drivers", currentDriver), {
                    name: currentDriver, location: { lat, lng }, heading, lastUpdate: serverTimestamp()
                });
            }
        }

        function listenForTasks() {
            if(currentDriver === '××•×¨×—') return;

            const q = query(collection(db, "orders"), where("driver", "==", currentDriver), where("status", "in", ["assigned", "on_route"]));
            
            onSnapshot(q, (snap) => {
                // × ×§×” ××¤×”
                map.eachLayer(layer => { if(layer instanceof L.Marker && layer !== truckMarker) map.removeLayer(layer); });

                if (snap.empty) {
                    document.getElementById('action-sheet').classList.remove('active');
                    document.getElementById('progress-bar').classList.remove('active');
                    return;
                }

                snap.forEach(d => {
                    const task = d.data();
                    
                    // ×¡×™×›×” ×¨× ×“×•××œ×™×ª (×œ×”××—×©×”)
                    const lat = 32.165 + (Math.random() * 0.01);
                    const lng = 34.845 + (Math.random() * 0.01);
                    
                    const icon = L.divIcon({
                        className: 'custom-pin',
                        html: `<div class="pin-inner pin-order"><i class="fas fa-box"></i></div>`,
                        iconSize: [50, 50]
                    });
                    
                    L.marker([lat, lng], {icon: icon}).addTo(map).on('click', () => openCard(d.id, task));
                    
                    // ×¤×ª×— ××•×˜×•××˜×™×ª
                    openCard(d.id, task);
                });
            });
        }

        function openCard(id, task) {
            activeTaskId = id;
            const sheet = document.getElementById('action-sheet');
            document.getElementById('progress-bar').classList.add('active');
            sheet.classList.add('active');
            
            const isStarted = task.status === 'on_route';
            if(isStarted) document.getElementById('step-nav').classList.add('active');
            
            let html = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-[10px] font-bold text-blue-600 uppercase">×”×–×× ×” #${task.orderNum}</div>
                        <h2 class="text-2xl font-black">${task.clientName}</h2>
                        <div class="text-gray-500 text-sm font-bold"><i class="fas fa-map-marker-alt text-red-500"></i> ${task.address}</div>
                    </div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-200 text-sm text-slate-700 max-h-24 overflow-y-auto">${task.itemsText}</div>`;

            if (!isStarted) {
                html += `<button onclick="startMission('${id}')" class="big-btn btn-start">ğŸš€ ×§×‘×œ ××©×™××” ×•×¦× ×œ×“×¨×š</button>`;
            } else {
                html += `
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="navWaze('${task.address}')" class="big-btn btn-waze"><i class="fab fa-waze text-2xl"></i> ×¡×¢ ×œ×™×¢×“</button>
                    <button onclick="window.open('tel:${task.clientPhone}')" class="big-btn btn-call"><i class="fas fa-phone-alt text-xl"></i> ×—×™×™×’</button>
                </div>
                <button onclick="finishMission('${id}')" class="big-btn bg-slate-800 hover:bg-green-600 w-full"><i class="fas fa-check-circle"></i> ×”×’×¢×ª×™</button>`;
            }
            sheet.innerHTML = html;
        }

        // --- ×¤×¢×•×œ×•×ª ---
        window.startMission = async (id) => {
            await updateDoc(doc(db, "orders", id), { status: 'on_route' });
        };
        window.navWaze = (addr) => window.location.href = `waze://?q=${encodeURIComponent(addr)}&navigate=yes`;
        window.finishMission = async (id) => {
            await updateDoc(doc(db, "orders", id), { status: 'done', deliveredAt: serverTimestamp() });
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.7 } });
            document.getElementById('action-sheet').classList.remove('active');
            document.getElementById('progress-bar').classList.remove('active');
        };

        // --- ×›×¤×ª×•×¨ ×‘×“×™×§×” (××™×™×¦×¨ ××©×™××” ××–×•×™×¤×ª ×›×“×™ ×©×ª×¨××” ××™×š ×–×” ×¢×•×‘×“) ---
        window.createDemoTask = async () => {
            if(currentDriver === '××•×¨×—') { alert('×”×ª×—×‘×¨ ×§×•×“× ×›× ×”×’ ×××™×ª×™'); return; }
            await addDoc(collection(db, "orders"), {
                driver: currentDriver,
                clientName: "×§×‘×œ×Ÿ ×‘×“×™×§×”",
                address: "×”×—×¨×© 10, ×”×•×“ ×”×©×¨×•×Ÿ",
                itemsText: "5 ××©×˜×—×™ ××œ×˜ ×œ×‘×“×™×§×”",
                status: "assigned",
                orderNum: "999",
                type: "order",
                createdAt: serverTimestamp()
            });
        };
        
        // ×—×©×™×¤×ª ×¤×•× ×§×¦×™×•×ª
        window.startMission = startMission;
        window.navWaze = navWaze;
        window.finishMission = finishMission;
        window.createDemoTask = createDemoTask;
    </script>
</body>
</html>
