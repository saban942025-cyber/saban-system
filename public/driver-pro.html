<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>Saban Driver</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { background: #f8fafc; height: 100vh; overflow: hidden; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; color: #1e293b; }
        
        /* 驻 专 注  住 */
        #map { flex: 1; width: 100%; z-index: 0; }
        
        /* 专住 驻注 爪祝 */
        .action-card {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98); 
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px; box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
            transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 1000; border-top: 1px solid #e2e8f0;
        }
        .action-card.active { transform: translateY(0); }

        /* 驻转专  专专 */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .big-btn {
            height: 60px; border-radius: 12px; font-weight: 800; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; transition: 0.2s; color: white; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .big-btn:active { transform: scale(0.96); box-shadow: none; }
        
        /* 爪注 驻转专 */
        .btn-waze { background: #3b82f6; }
        .btn-call { background: #22c55e; }
        .btn-msg { background: #f97316; }
        .btn-doc { background: #64748b; }
        
        .btn-start { 
            background: linear-gradient(135deg, #2563eb, #1d4ed8); 
            width: 100%; height: 75px; font-size: 18px; 
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }

        /* 拽 驻 (注爪 砖 专) */
        .truck-marker { 
            font-size: 36px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); 
            transition: all 1s linear; z-index: 1000 !important;
        }
        
        .custom-pin {
            display: flex; align-items: center; justify-content: center;
        }
        
        .pin-inner {
            width: 44px; height: 44px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .pin-order { background: #3b82f6; } /*  -  */
        .pin-transfer { background: #f97316; } /* 转 - 注专 */
        
        /* 住住 专 注 */
        .top-status {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: white; padding: 8px 20px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-weight: bold;
            display: flex; items-center; gap: 8px; z-index: 500; font-size: 14px;
        }
        .status-dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; animate: pulse 2s infinite; }
    </style>
</head>
<body>

    <div class="top-status">
        <div class="status-dot"></div>
        <span id="driver-title"> 专</span>
    </div>

    <div id="map"></div>

    <div id="action-sheet" class="action-card">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let map, truckMarker;
        let currentDriver = null;
        let activeTaskId = null;

        // 1. 住 转 ( 砖转)
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const driverParam = params.get('driver'); // 拽 转 砖 拽 ?driver=注

            if (driverParam) {
                currentDriver = driverParam;
                document.getElementById('driver-title').innerText = `: ${currentDriver}`;
                initSystem();
            } else {
                // 专拽   专专 (拽 砖专), 砖
                askDriverName();
            }
        };

        async function askDriverName() {
            const { value: name } = await Swal.fire({
                title: '砖转 ',
                text: '   拽.  转?',
                input: 'select',
                inputOptions: { '注': '注', '转': '转', '住': '住' },
                allowOutsideClick: false
            });
            if(name) {
                currentDriver = name;
                document.getElementById('driver-title').innerText = `: ${currentDriver}`;
                initSystem();
            }
        }

        function initSystem() {
            // 转 驻 专 (OpenStreetMap)
            map = L.map('map', { zoomControl: false }).setView([32.162, 34.844], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Saban Logistics',
                maxZoom: 19
            }).addTo(map);

            // 驻注转 GPS
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(updateLocation, null, { enableHighAccuracy: true });
            }

            //  砖转
            listenForTasks();
        }

        async function updateLocation(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            
            // 拽 砖转 转转 转
            const truckHtml = `<div style="transform: rotate(${pos.coords.heading || 0}deg);"></div>`;
            const truckIcon = L.divIcon({ className: 'truck-marker', html: truckHtml, iconSize: [40, 40], iconAnchor: [20, 20] });

            if (!truckMarker) {
                truckMarker = L.marker([lat, lng], {icon: truckIcon}).addTo(map);
                map.setView([lat, lng], 16); // 转拽转 注 
            } else {
                truckMarker.setLatLng([lat, lng]);
                truckMarker.setIcon(truckIcon);
            }

            // 砖专  (")
            await setDoc(doc(db, "drivers", currentDriver), {
                name: currentDriver,
                location: { lat, lng },
                heading: pos.coords.heading || 0,
                speed: pos.coords.speed || 0,
                lastUpdate: serverTimestamp(),
                status: activeTaskId ? 'busy' : 'free'
            });
        }

        function listenForTasks() {
            const q = query(collection(db, "orders"), where("driver", "==", currentDriver), where("status", "in", ["assigned", "on_route"]));
            
            onSnapshot(q, (snap) => {
                // 拽 住转 砖转 (抓 砖转)
                map.eachLayer(layer => { if(layer instanceof L.Marker && layer !== truckMarker) map.removeLayer(layer); });

                if (snap.empty) {
                    document.getElementById('action-sheet').classList.remove('active');
                    activeTaskId = null;
                    return;
                }

                snap.forEach(d => {
                    const task = d.data();
                    
                    // 住 砖 (砖 砖转砖 拽 专 拽专   转转 拽转)
                    const isTransfer = task.type === 'transfer';
                    const pinClass = isTransfer ? 'pin-transfer' : 'pin-order';
                    const iconSign = isTransfer ? 'fa-exchange-alt' : 'fa-box';
                    
                    // 爪专转 住 注爪转
                    const customIcon = L.divIcon({
                        className: 'custom-pin',
                        html: `<div class="pin-inner ${pinClass}"><i class="fas ${iconSign}"></i></div>`,
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });

                    // 拽  (驻注: 驻 Geocoding 砖 转转)
                    const destLat = 32.165 + (Math.random() * 0.01);
                    const destLng = 34.845 + (Math.random() * 0.01);

                    const marker = L.marker([destLat, destLng], {icon: customIcon}).addTo(map);
                    
                    // 爪 注 住 驻转转 转 专住
                    marker.on('click', () => openCard(d.id, task));
                    
                    // 驻转 转  砖 砖 转
                    if (snap.size === 1) openCard(d.id, task);
                });
            });
        }

        function openCard(id, task) {
            activeTaskId = id;
            const sheet = document.getElementById('action-sheet');
            sheet.classList.add('active');
            
            const isStarted = task.status === 'on_route';
            const typeLabel = task.type === 'transfer' ? '注专 驻' : '转 拽';
            const typeColor = task.type === 'transfer' ? 'text-orange-600' : 'text-blue-600';

            sheet.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-xs font-bold ${typeColor} uppercase tracking-widest mb-1">${typeLabel}</div>
                        <h2 class="text-2xl font-black text-slate-800">${task.clientName}</h2>
                        <div class="text-gray-500 text-sm font-bold flex items-center gap-1">
                            <i class="fas fa-map-marker-alt text-red-500"></i> ${task.address}
                        </div>
                    </div>
                    <div class="bg-gray-100 px-3 py-1 rounded text-xs font-bold text-gray-600">#${task.orderNum}</div>
                </div>
                
                <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100 text-sm text-slate-700 max-h-24 overflow-y-auto">
                    ${task.itemsText}
                </div>

                ${!isStarted ? `
                    <button onclick="startMission('${id}')" class="big-btn btn-start">
                         拽 砖 爪 专
                    </button>
                ` : `
                    <div class="btn-grid">
                        <button onclick="navWaze('${task.address}')" class="big-btn btn-waze">
                            <i class="fab fa-waze text-2xl"></i> 住注 注
                        </button>
                        <button onclick="window.open('tel:${task.clientPhone}')" class="big-btn btn-call">
                            <i class="fas fa-phone-alt text-xl"></i> 
                        </button>
                        <button onclick="msgCenter('${id}')" class="big-btn btn-msg">
                            <i class="fas fa-comment-dots text-xl"></i> 住专
                        </button>
                        <button onclick="viewDoc('${task.pdfUrl}')" class="big-btn btn-doc">
                            <i class="fas fa-file-invoice text-xl"></i> 转注
                        </button>
                    </div>
                    <button onclick="finishMission('${id}')" class="big-btn bg-slate-800 mt-3 w-full border border-slate-600 hover:bg-green-600">
                        <i class="fas fa-flag-checkered text-xl"></i>  驻专拽
                    </button>
                `}
            `;
        }

        // --- 驻注转  ---
        window.startMission = async (id) => {
            await updateDoc(doc(db, "orders", id), { 
                status: 'on_route', 
                chat: arrayUnion({ sender: 'system', text: ` ${currentDriver} 爪 专`, time: new Date().toISOString() })
            });
        };

        window.navWaze = (addr) => window.location.href = `waze://?q=${encodeURIComponent(addr)}&navigate=yes`;
        
        window.msgCenter = async (id) => {
            const { value: text } = await Swal.fire({ title: '注 住专', input: 'text', confirmButtonText: '砖' });
            if(text) await updateDoc(doc(db, "orders", id), { status: 'driver_msg', chat: arrayUnion({ sender: 'driver', text: `: ${text}`, time: new Date().toISOString() }) });
        };

        window.viewDoc = (url) => url ? window.open(url) : Swal.fire(' 转注', '', 'info');

        window.finishMission = async (id) => {
            const { isConfirmed } = await Swal.fire({ title: '住转?', text: '砖 注转 注 拽?', icon: 'question', showCancelButton: true, confirmButtonText: ', 住转!', confirmButtonColor: '#22c55e' });
            if(isConfirmed) {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.7 } });
                await updateDoc(doc(db, "orders", id), { status: 'done', deliveredAt: serverTimestamp() });
                document.getElementById('action-sheet').classList.remove('active');
            }
        };
    </script>
</body>
</html>
