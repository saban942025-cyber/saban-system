<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SabanOS Staff | ×—×"×œ × ×™×”×•×œ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-app: #d1d7db;
            --bg-panel: #ffffff;
            --bg-header: #f0f2f5;
            --text-main: #111b21;
            --text-sec: #667781;
            --chat-bg: #efeae2;
            --input-bg: #ffffff;
            --bubble-in: #ffffff;
            --bubble-out: #d9fdd3;
            --bubble-internal: #fff9c4;
            --border: #e9edef;
            --active-item: #f0f2f5;
        }

        /* DARK MODE OVERRIDES */
        [data-theme="dark"] {
            --bg-app: #0b141a;
            --bg-panel: #111b21;
            --bg-header: #202c33;
            --text-main: #e9edef;
            --text-sec: #8696a0;
            --chat-bg: #0b141a; /* Dark pattern */
            --input-bg: #2a3942;
            --bubble-in: #202c33;
            --bubble-out: #005c4b;
            --bubble-internal: #4a4a00;
            --border: #222e35;
            --active-item: #2a3942;
        }

        body { background-color: var(--bg-app); color: var(--text-main); font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        
        /* LAYOUT */
        #root { height: 100%; width: 100%; display: flex; justify-content: center; }
        .app-shell { display: flex; width: 100%; height: 100%; max-width: 1600px; background: var(--bg-panel); overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* Sidebar (Radar) */
        .sidebar { width: 30%; min-width: 320px; max-width: 450px; border-left: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg-panel); transition: width 0.3s; }
        .sidebar-header { height: 60px; background: var(--bg-header); padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .search-bar { padding: 8px; border-bottom: 1px solid var(--border); }
        .session-list { flex: 1; overflow-y: auto; }
        
        .session-item { display: flex; gap: 12px; padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: 0.2s; }
        .session-item:hover { background: var(--active-item); }
        .session-item.active { background: var(--active-item); }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #dfe5e7; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: #555; position: relative; }
        .status-dot { width: 10px; height: 10px; background: #00a884; border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid var(--bg-panel); }
        
        /* Chat Area (Arena) */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--chat-bg); position: relative; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-opacity: 0.05; }
        .chat-header { height: 60px; background: var(--bg-header); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Input Area */
        .chat-footer { min-height: 62px; background: var(--bg-header); padding: 10px 16px; display: flex; align-items: center; gap: 10px; border-top: 1px solid var(--border); }
        .input-box { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); outline: none; }
        
        /* Bubbles */
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); line-height: 1.4; }
        .msg.user { align-self: flex-start; background: var(--bubble-in); border-top-right-radius: 0; } /* ×œ×§×•×— ××™××™×Ÿ */
        .msg.bot { align-self: flex-end; background: var(--bg-header); border: 1px solid var(--border); color: var(--text-sec); border-top-left-radius: 0; font-size: 13px; }
        .msg.staff { align-self: flex-end; background: var(--bubble-out); border-top-left-radius: 0; }
        .msg.internal { align-self: center; background: var(--bubble-internal); color: #444; width: 80%; text-align: center; border: 1px dashed #d4b106; font-size: 12px; }
        
        .msg-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; font-size: 10px; font-weight: bold; opacity: 0.8; }
        .msg-time { font-size: 9px; opacity: 0.6; text-align: left; margin-top: 2px; }

        /* Responsive Mobile */
        @media (max-width: 768px) {
            .sidebar { width: 100%; max-width: 100%; display: flex; }
            .chat-area { display: none; width: 100%; position: fixed; top: 0; left: 0; height: 100%; z-index: 50; }
            .chat-area.open { display: flex; }
            .sidebar.hidden { display: none; }
        }

        /* Utilities */
        .btn-icon { padding: 8px; border-radius: 50%; cursor: pointer; color: var(--text-sec); }
        .btn-icon:hover { background: rgba(0,0,0,0.05); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, addDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563", measurementId: "G-PQGYJ2YQRK" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.fb = { collection, query, orderBy, onSnapshot, addDoc, updateDoc, doc, serverTimestamp, setDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const Icon = ({ name, size = 20 }) => { 
            const ref = useRef(null);
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]); 
            return <i data-lucide={name} style={{fontSize: size}}></i>; 
        };

        const StaffApp = () => {
            const [theme, setTheme] = useState('light');
            const [sessions, setSessions] = useState([]);
            const [activeSession, setActiveSession] = useState(null);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isWhisper, setIsWhisper] = useState(false);
            const scrollRef = useRef(null);

            // Toggle Theme
            useEffect(() => { document.documentElement.setAttribute('data-theme', theme); }, [theme]);
            
            // 1. Listen to Radar (Customers)
            useEffect(() => {
                // ×”××¤×ª×— ×œ×ª×™×§×•×Ÿ: ×××–×™× ×™× ×œ-chatSessions ×©×× ×•×”×œ ×¢"×™ index.html
                const q = window.fb.query(window.fb.collection(window.db, "chat_sessions"), window.fb.orderBy("lastActivity", "desc"));
                const unsub = window.fb.onSnapshot(q, (snap) => {
                    const list = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setSessions(list);
                });
                return () => unsub();
            }, []);

            // 2. Listen to Chat
            useEffect(() => {
                if(!activeSession) return;
                const q = window.fb.query(window.fb.collection(window.db, `chat_sessions/${activeSession.id}/messages`), window.fb.orderBy("createdAt", "asc"));
                const unsub = window.fb.onSnapshot(q, (snap) => {
                    setMessages(snap.docs.map(d => d.data()));
                    if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                });
                return () => unsub();
            }, [activeSession]);

            const sendMessage = async () => {
                if(!input.trim() || !activeSession) return;
                const role = isWhisper ? 'internal' : 'staff';
                
                await window.fb.addDoc(window.fb.collection(window.db, `chat_sessions/${activeSession.id}/messages`), {
                    text: input,
                    role: role,
                    sender: "× ×¦×™×’", // ××¤×©×¨ ×œ×©× ×•×ª ×œ×©× ×”× ×¦×™×’ ×”××—×•×‘×¨
                    createdAt: window.fb.serverTimestamp()
                });

                // ×¢×“×›×•×Ÿ ×”×¨×“××¨
                await window.fb.updateDoc(window.fb.doc(window.db, "chat_sessions", activeSession.id), {
                    lastMessage: role === 'internal' ? 'ğŸ”’ ×”×¢×¨×” ×¤× ×™××™×ª' : `× ×¦×™×’: ${input}`,
                    lastActivity: window.fb.serverTimestamp(),
                    isBotActive: false // ×”× ×¦×™×’ ×œ×•×§×— ×©×œ×™×˜×”
                });

                setInput('');
                setIsWhisper(false);
            };

            const toggleTheme = () => setTheme(theme === 'light' ? 'dark' : 'light');

            return (
                <div className="app-shell">
                    
                    {/* LEFT SIDEBAR (RADAR) */}
                    <div className={`sidebar ${activeSession ? 'hidden md:flex' : 'flex'}`}>
                        <div className="sidebar-header">
                            <div className="flex items-center gap-2">
                                <div className="avatar"><img src="https://i.ibb.co/FLq4YbGS/icon-192.png" className="w-full h-full rounded-full"/></div>
                                <h2 className="font-bold">×—×"×œ ×”×–×× ×•×ª</h2>
                            </div>
                            <div className="flex gap-2">
                                <button className="btn-icon" onClick={toggleTheme}><Icon name={theme==='light'?'moon':'sun'}/></button>
                                <button className="btn-icon"><Icon name="more-vertical"/></button>
                            </div>
                        </div>
                        <div className="search-bar">
                            <div className="bg-gray-100 dark:bg-gray-800 flex items-center px-3 py-1 rounded-lg">
                                <Icon name="search" size={16} className="text-gray-500"/>
                                <input placeholder="×—×™×¤×•×© ××• ×”×ª×—×œ×ª ×¦'××˜..." className="bg-transparent border-none outline-none w-full p-1 text-sm text-gray-700 dark:text-gray-200"/>
                            </div>
                        </div>
                        <div className="session-list custom-scroll">
                            {sessions.map(s => (
                                <div key={s.id} onClick={()=>setActiveSession(s)} className={`session-item ${activeSession?.id === s.id ? 'active' : ''}`}>
                                    <div className="avatar">
                                        {s.userName ? s.userName[0] : '?'}
                                        <div className="status-dot"></div>
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-baseline">
                                            <span className="font-bold text-sm truncate">{s.userName || '××•×¨×—'}</span>
                                            <span className="text-[10px] text-gray-500">{new Date(s.lastActivity?.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                        </div>
                                        <div className="text-xs text-gray-500 truncate flex items-center gap-1">
                                            {s.lastMessage}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {sessions.length === 0 && <div className="text-center p-4 text-gray-500 text-sm">××™×Ÿ ×©×™×—×•×ª ×¤×¢×™×œ×•×ª ×›×¨×’×¢</div>}
                        </div>
                    </div>

                    {/* RIGHT MAIN CHAT (ARENA) */}
                    <div className={`chat-area ${activeSession ? 'open' : 'hidden md:flex'}`}>
                        {activeSession ? (
                            <>
                                <div className="chat-header">
                                    <div className="flex items-center gap-3">
                                        <button className="md:hidden btn-icon" onClick={()=>setActiveSession(null)}><Icon name="arrow-right"/></button>
                                        <div className="avatar">{activeSession.userName ? activeSession.userName[0] : '?'}</div>
                                        <div>
                                            <div className="font-bold">{activeSession.userName}</div>
                                            <div className="text-xs text-gray-500">
                                                {activeSession.currentProject ? `×¤×¨×•×™×§×˜: ${activeSession.currentProject}` : '×œ×§×•×— ×›×œ×œ×™'}
                                                {!activeSession.isBotActive && <span className="text-green-600 font-bold ml-1">â— ×‘×˜×™×¤×•×œ × ×¦×™×’</span>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button className="btn-icon text-red-500" title="×¡×’×•×¨ ×˜×™×¤×•×œ"><Icon name="check-square"/></button>
                                        <button className="btn-icon" title="×¤×¨×˜×™ ×œ×§×•×—"><Icon name="info"/></button>
                                    </div>
                                </div>

                                <div className="chat-messages custom-scroll" ref={scrollRef}>
                                    {messages.map((m, i) => (
                                        <div key={i} className={`msg ${m.role}`}>
                                            <div className="msg-meta">
                                                <span>{m.sender}</span>
                                                {m.role === 'internal' && <Icon name="lock" size={10}/>}
                                            </div>
                                            <div>{m.text}</div>
                                            <div className="msg-time">{new Date(m.createdAt?.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                        </div>
                                    ))}
                                </div>

                                <div className="chat-footer">
                                    <button className={`btn-icon ${isWhisper?'text-yellow-500 bg-yellow-100':''}`} onClick={()=>setIsWhisper(!isWhisper)} title="×”×¢×¨×” ×¤× ×™××™×ª (×œ×•×—×©×ª)">
                                        <Icon name={isWhisper ? "mic-off" : "message-square"}/>
                                    </button>
                                    <button className="btn-icon"><Icon name="paperclip"/></button>
                                    <input 
                                        value={input} 
                                        onChange={e=>setInput(e.target.value)} 
                                        onKeyDown={e=>e.key==='Enter'&&sendMessage()}
                                        placeholder={isWhisper ? "×›×ª×•×‘ ×”×¢×¨×” ×¤× ×™××™×ª ×œ×¦×•×•×ª..." : "×”×§×œ×“ ×”×•×“×¢×” ×œ×œ×§×•×—..."} 
                                        className={`input-box ${isWhisper ? 'bg-yellow-50 border-yellow-300' : ''}`}
                                    />
                                    <button onClick={sendMessage} className="p-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                                        <Icon name="send"/>
                                    </button>
                                </div>
                            </>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full text-gray-400">
                                <img src="https://i.ibb.co/FLq4YbGS/icon-192.png" className="w-24 h-24 mb-4 opacity-50 grayscale"/>
                                <h2 className="text-xl">SabanOS Command Center</h2>
                                <p>×‘×—×¨ ×©×™×—×” ××”×¨×©×™××” ×›×“×™ ×œ×”×ª×—×™×œ ×œ× ×”×œ</p>
                            </div>
                        )}
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StaffApp />);
    </script>
</body>
</html>