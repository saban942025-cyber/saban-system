<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabanOS | 专 砖 拽专</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background: #0f172a; color: white; font-family: 'Heebo', sans-serif; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 280px 1fr 350px;
            grid-template-rows: 80px 1fr;
            height: 100vh;
            gap: 20px;
            padding: 20px;
        }

        .card { background: #1e293b; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #334155; }
        
        .sidebar { grid-row: 1 / -1; background: #1e293b; display: flex; flex-direction: column; }
        .nav-item { padding: 15px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; color: #94a3b8; border-right: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #334155; color: white; border-right-color: #3b82f6; }

        .header { grid-column: 2 / -1; display: flex; justify-content: space-between; align-items: center; }

        .stats-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #334155, #1e293b); padding: 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; }
        .stat-value { font-size: 2rem; font-weight: 900; }
        .stat-label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        .user-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #334155; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .offline { background: #64748b; }
        
        .log-feed { height: 400px; overflow-y: auto; font-size: 0.85rem; }
        .log-item { padding: 10px; border-left: 2px solid #3b82f6; background: #0f172a; margin-bottom: 8px; border-radius: 0 8px 8px 0; }
        .log-time { font-size: 0.7rem; color: #64748b; }
        .log-urgent { border-left-color: #ef4444; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="dashboard-grid">
        
        <div class="card sidebar">
            <div class="text-2xl font-black mb-8 flex items-center gap-2 px-4">
                <i class="fas fa-chart-pie text-blue-500"></i> Saban<span class="text-blue-500">BI</span>
            </div>
            <div class="nav-item active"><i class="fas fa-tachometer-alt"></i> 砖专 专砖</div>
            <div class="nav-item"><i class="fas fa-users"></i>  爪转</div>
            <div class="nav-item"><i class="fas fa-history"></i> 住专转 </div>
            <div class="nav-item"><i class="fas fa-file-invoice"></i> 转 住驻</div>
            <div class="mt-auto nav-item text-red-400" onclick="window.location.href='index.html'"><i class="fas fa-sign-out-alt"></i> 爪 注专转</div>
        </div>

        <div class="header">
            <div>
                <h1 class="text-2xl font-bold">拽专 , 专 </h1>
                <p class="text-slate-400 text-sm">住拽专转 注专转  转</p>
            </div>
            <div class="flex gap-3">
                <button class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-bold text-sm shadow">
                    <i class="fas fa-download"></i> 爪  
                </button>
            </div>
        </div>

        <div class="flex flex-col h-full overflow-hidden">
            
            <div class="stats-container">
                <div class="stat-card border-r-4 border-blue-500">
                    <div><div class="stat-value" id="countOrders">0</div><div class="stat-label">转 驻转转</div></div>
                    <i class="fas fa-box text-3xl text-blue-500 opacity-50"></i>
                </div>
                <div class="stat-card border-r-4 border-red-500">
                    <div><div class="stat-value text-red-400" id="countUrgent">0</div><div class="stat-label">砖转 驻转</div></div>
                    <i class="fas fa-exclamation-circle text-3xl text-red-500 opacity-50"></i>
                </div>
                <div class="stat-card border-r-4 border-green-500">
                    <div><div class="stat-value text-green-400" id="countStaff">0</div><div class="stat-label">爪转 专</div></div>
                    <i class="fas fa-user-clock text-3xl text-green-500 opacity-50"></i>
                </div>
            </div>

            <div class="card flex-1 min-h-0 flex flex-col">
                <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-chart-bar text-purple-500"></i> 驻 驻注转</h3>
                <div class="relative flex-1"><canvas id="activityChart"></canvas></div>
            </div>
        </div>

        <div class="flex flex-col gap-5 h-full overflow-hidden">
            
            <div class="card h-1/3 overflow-hidden flex flex-col">
                <h3 class="font-bold mb-3 text-sm uppercase text-slate-400"><i class="fas fa-wifi"></i> 住住 专</h3>
                <div id="presenceList" class="overflow-y-auto pr-2">
                    <div class="text-center text-slate-600 text-xs py-4">注 转...</div>
                </div>
            </div>

            <div class="card h-2/3 overflow-hidden flex flex-col">
                <h3 class="font-bold mb-3 text-sm uppercase text-slate-400"><i class="fas fa-list-ul"></i>  爪注 (Live)</h3>
                <div id="logFeed" class="log-feed pr-2"></div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. PRESENCE MONITOR ---
        function initPresence() {
            onSnapshot(collection(db, "users"), (snap) => {
                const list = document.getElementById('presenceList');
                let onlineCount = 0;
                
                const users = snap.docs.map(d => d.data());
                users.sort((a,b) => (b.lastSeen?.seconds || 0) - (a.lastSeen?.seconds || 0));

                list.innerHTML = users.map(u => {
                    const isOnline = checkOnline(u.lastSeen);
                    if(isOnline) onlineCount++;
                    
                    const timeStr = u.lastSeen ? new Date(u.lastSeen.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ' 转专';
                    const roleBadge = u.role === 'driver' ? '' : u.role === 'admin' ? '' : '';

                    return `
                    <div class="user-row">
                        <div class="status-dot ${isOnline ? 'online' : 'offline'}"></div>
                        <img src="${u.avatar || 'https://ui-avatars.com/api/?background=random'}" class="w-8 h-8 rounded-full">
                        <div class="flex-1">
                            <div class="text-sm font-bold leading-none">${u.name} ${roleBadge}</div>
                            <div class="text-[10px] text-slate-400">${isOnline ? '专 注转' : '专 专: ' + timeStr}</div>
                        </div>
                    </div>`;
                }).join('');

                document.getElementById('countStaff').innerText = onlineCount;
            });
        }

        function checkOnline(timestamp) {
            if (!timestamp) return false;
            const diff = (new Date() - new Date(timestamp.seconds * 1000)) / 1000;
            return diff < 180;
        }

        // --- 2. LIVE LOGS (FIXED) ---
        function initLogs() {
            const q = query(collection(db, "system_logs"), orderBy("timestamp", "desc"), limit(50));
            
            onSnapshot(q, (snap) => {
                const feed = document.getElementById('logFeed');
                
                feed.innerHTML = snap.docs.map(d => {
                    const l = d.data();
                    
                    // --- 转拽 拽专住 ---
                    //   砖砖转 拽 驻 砖砖 
                    const user = l.user || "注专转";
                    const action = l.action || "驻注 转";
                    const isUrgent = l.type === 'urgent' || action.includes('祝');
                    // ---------------------

                    const time = l.timestamp ? new Date(l.timestamp.seconds * 1000).toLocaleTimeString() : '';
                    
                    return `
                    <div class="log-item ${isUrgent ? 'log-urgent' : ''}">
                        <div class="flex justify-between items-start">
                            <span class="font-bold text-blue-400">${user}</span>
                            <span class="log-time">${time}</span>
                        </div>
                        <div class="text-slate-300 mt-1">${action}</div>
                        ${l.details ? `<div class="text-[10px] text-slate-500 mt-1">${l.details}</div>` : ''}
                    </div>`;
                }).join('');
            });
        }

        // --- 3. KPI & CHARTS ---
        function initStats() {
            onSnapshot(query(collection(db, "orders"), where("status", "!=", "done")), (snap) => {
                document.getElementById('countOrders').innerText = snap.size;
                updateChart(snap.size, null);
            });

            onSnapshot(query(collection(db, "transfers"), where("priority", "==", "high")), (snap) => {
                document.getElementById('countUrgent').innerText = snap.size;
                updateChart(null, snap.size);
            });
        }

        let myChart;
        function initChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['转 驻转转', '砖转 驻转', ' 驻注'],
                    datasets: [{
                        label: '住住 注专转',
                        data: [0, 0, 0],
                        backgroundColor: ['#3b82f6', '#ef4444', '#22c55e'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#334155' } }, x: { grid: { display: false } } }
                }
            });
        }

        function updateChart(orders, urgent) {
            if (myChart) {
                if (orders !== null) myChart.data.datasets[0].data[0] = orders;
                if (urgent !== null) myChart.data.datasets[0].data[1] = urgent;
                myChart.data.datasets[0].data[2] = document.getElementById('countStaff').innerText;
                myChart.update();
            }
        }

        // --- RUN ---
        initChart();
        initPresence();
        initLogs();
        initStats();

    </script>
</body>
</html>
