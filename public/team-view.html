<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 16px; }
        
        /* 注爪 专住 */
        .staff-card {
            background: white; border-radius: 16px; padding: 16px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
            position: relative; overflow: hidden; transition: 0.2s;
        }
        .staff-card:active { transform: scale(0.98); }

        .card-avatar { 
            width: 70px; height: 70px; border-radius: 50%; object-fit: cover; 
            border: 3px solid #f1f5f9; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .status-dot {
            position: absolute; top: 15px; right: 15px;
            width: 10px; height: 10px; background: #22c55e; border-radius: 50%;
            border: 2px solid white;
        }

        /* 驻转专 驻注 */
        .actions-row { display: flex; gap: 8px; width: 100%; margin-top: 12px; }
        .act-btn { 
            flex: 1; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 14px; cursor: pointer; transition: 0.2s; color: white;
        }
        .btn-wa { background: #25d366; }
        .btn-call { background: #3b82f6; }
        .btn-pop { background: #f97316; } /* 转 转专 */
    </style>
</head>
<body>

    <div class="flex justify-between items-center mb-4">
        <div class="text-sm font-bold text-slate-400 uppercase tracking-wider"> 爪转</div>
        <div class="text-xs bg-white px-2 py-1 rounded border text-slate-500" id="count">注...</div>
    </div>
    
    <div id="team-grid" class="grid grid-cols-2 gap-4">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // 注转 砖 爪转
        onSnapshot(query(collection(db, "users"), orderBy("name")), (snap) => {
            const grid = document.getElementById('team-grid');
            grid.innerHTML = '';
            let counter = 0;
            
            snap.forEach(d => {
                const u = d.data();
                const uid = d.id; //  砖 砖转砖 (砖 砖转 注)
                
                if(u.type === 'client') return;
                counter++;

                const avatar = u.avatar || `https://ui-avatars.com/api/?name=${u.name}&background=random`;
                const role = u.role || '爪转';
                const badge = u.role?.includes('') ? '<i class="fas fa-crown text-yellow-500"></i>' : '';

                // 爪专转 专住
                const card = document.createElement('div');
                card.className = 'staff-card';
                card.innerHTML = `
                    <div class="status-dot"></div>
                    <img src="${avatar}" class="card-avatar">
                    <div class="font-bold text-slate-800 text-sm mb-1">${u.name} ${badge}</div>
                    <div class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">${role}</div>
                    
                    <div class="actions-row">
                        <div class="act-btn btn-wa" onclick="window.open('https://wa.me/972${u.phone?.replace(/^0/,'')}', '_blank')">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="act-btn btn-call" onclick="window.open('tel:${u.phone}')">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="act-btn btn-pop" id="btn-pop-${uid}">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);

                // 住驻转  驻转专 驻驻-驻 ( 注 注转 注 专砖 砖)
                document.getElementById(`btn-pop-${uid}`).onclick = () => sendPopup(uid, u.name);
            });
            document.getElementById('count').innerText = counter + ' 专';
        });

        // 驻拽爪转 砖转 注 转驻专爪转 (POPUP)
        window.sendPopup = async (targetId, targetName) => {
            const { value: text } = await Swal.fire({
                title: `注 转驻专爪转 ${targetName}`,
                input: 'textarea',
                inputPlaceholder: '转 注 驻...',
                inputAttributes: { 'aria-label': '转 注 驻' },
                showCancelButton: true,
                confirmButtonText: '砖专 转专 ',
                confirmButtonColor: '#f97316',
                cancelButtonText: ''
            });

            if (text) {
                try {
                    // 转 住 转 - 驻拽爪 砖 注  
                    await addDoc(collection(db, "notifications"), {
                        targetUser: targetId, // : 'vered'  -ID 转
                        title: '注 ',
                        body: text,
                        type: 'urgent', // 住 祝
                        read: false,
                        createdAt: serverTimestamp()
                    });

                    Swal.fire({
                        icon: 'success',
                        title: '砖!',
                        text: `注 转拽驻抓 爪 ${targetName} .`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } catch (e) {
                    console.error(e);
                    Swal.fire('砖', ' 转 砖 转 注', 'error');
                }
            }
        }
    </script>
</body>
</html>
