<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Saban Hamal | Master Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #0f172a; color: white; height: 100vh; overflow: hidden; font-family: sans-serif; display: flex; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: #1e293b; border-left: 1px solid #334155; display: flex; flex-direction: column; }
        .nav-item { padding: 15px; cursor: pointer; color: #94a3b8; transition: 0.2s; display: flex; items-center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background: #334155; color: white; border-right: 3px solid #3b82f6; }

        /* Main Area */
        .main-content { flex: 1; display: flex; flex-direction: column; background: #0f172a; }
        
        /* Stories Header */
        .stories-bar { height: 110px; border-bottom: 1px solid #334155; display: flex; align-items: center; padding: 0 20px; gap: 15px; overflow-x: auto; }
        .story-circle { width: 64px; height: 64px; border-radius: 50%; padding: 3px; cursor: pointer; position: relative; }
        .story-circle img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 2px solid #0f172a; }
        .story-circle.new { background: linear-gradient(45deg, #ef4444, #f59e0b); } /* ××“×•×-×›×ª×•× ×œ×”×–×× ×” ×—×“×©×” */
        .story-circle.waiting { background: linear-gradient(45deg, #3b82f6, #06b6d4); } /* ×›×—×•×œ ×œ×××ª×™×Ÿ */
        
        /* Order List */
        .order-card { background: #1e293b; margin-bottom: 10px; padding: 15px; border-radius: 12px; border: 1px solid #334155; cursor: pointer; transition: 0.2s; position: relative; }
        .order-card:hover { transform: translateY(-2px); border-color: #64748b; }
        .order-card.selected { border-color: #3b82f6; background: #253347; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .st-new { background: #3b82f6; box-shadow: 0 0 10px #3b82f6; }
        .st-proc { background: #eab308; }
        .st-wait { background: #f97316; }
        .st-done { background: #22c55e; }

        /* Detail View */
        .detail-panel { width: 450px; background: #1e293b; border-right: 1px solid #334155; padding: 20px; display: flex; flex-direction: column; transition: 0.3s; transform: translateX(100%); position: absolute; right: 0; top: 0; bottom: 0; z-index: 50; }
        .detail-panel.open { transform: translateX(0); }

        /* Timeline */
        .timeline-item { position: relative; padding-right: 25px; margin-bottom: 25px; border-right: 2px solid #334155; }
        .timeline-item::after { content: ''; position: absolute; right: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: #475569; }
        .timeline-item.done { border-color: #22c55e; }
        .timeline-item.done::after { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-6 text-2xl font-black tracking-wider text-blue-500">SABAN<span class="text-white">OS</span></div>
        <div class="nav-item active"><i class="fas fa-home"></i> ×—×"×œ ×¨××©×™</div>
        <div class="nav-item"><i class="fas fa-truck"></i> ××©×™××•×ª</div>
        <div class="nav-item"><i class="fas fa-users"></i> ×œ×§×•×—×•×ª</div>
        <div class="mt-auto p-4 text-xs text-slate-500">System v4.0 PRO</div>
    </div>

    <div class="main-content relative">
        <div class="stories-bar" id="stories-container">
            </div>

        <div class="flex-1 p-6 flex gap-6 overflow-hidden">
            <div class="flex-1 flex flex-col">
                <h2 class="text-xl font-bold mb-4 flex justify-between">
                    <span>×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</span>
                    <button onclick="manualSync()" class="text-xs bg-blue-600 px-3 py-1 rounded hover:bg-blue-500"><i class="fas fa-sync"></i> ×¡× ×›×¨×•×Ÿ ×™×–×•×</button>
                </h2>
                <div class="flex-1 overflow-y-auto pr-2" id="orders-list">
                    </div>
            </div>

            <div id="detail-panel" class="detail-panel shadow-2xl">
                <button onclick="closePanel()" class="absolute left-4 top-4 text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                
                <div id="panel-content" class="mt-8">
                    <h2 id="det-client" class="text-2xl font-bold mb-1">...</h2>
                    <div class="text-sm text-gray-400 mb-6">×”×–×× ×”: <span id="det-app-id" class="font-mono text-blue-400">...</span></div>

                    <div id="action-area" class="mb-8 p-4 bg-slate-800 rounded-xl border border-slate-700">
                        </div>

                    <h3 class="font-bold text-gray-400 mb-4 text-sm">×¡×˜×˜×•×¡ ×˜×™×¤×•×œ</h3>
                    <div id="timeline-container">
                        </div>
                    
                    <div id="pdf-preview" class="mt-4 hidden">
                        <a id="pdf-link" target="_blank" class="block w-full py-3 bg-slate-700 hover:bg-slate-600 text-center rounded-xl border border-slate-600">
                            <i class="fas fa-file-pdf text-red-500"></i> ×¦×¤×” ×‘××¡××š
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        let currentOrder = null;

        // 1. ×”××–× ×” ×œ×”×–×× ×•×ª
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => {
            renderOrders(snap);
            renderStories(snap);
        });

        function renderOrders(snap) {
            const list = document.getElementById('orders-list');
            list.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                const st = getStatusInfo(o);
                
                list.innerHTML += `
                <div class="order-card" onclick="openOrder('${d.id}', '${o.clientName}')">
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-bold text-lg">${o.clientName}</div>
                        <div class="text-xs text-gray-400">${new Date(o.createdAt?.seconds*1000).toLocaleTimeString().slice(0,5)}</div>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-xs font-mono text-gray-500">#${o.orderNum}</div>
                        <div class="text-xs px-2 py-1 rounded bg-slate-800 border border-slate-700">
                            <span class="status-dot ${st.cls}"></span> ${st.txt}
                        </div>
                    </div>
                </div>`;
            });
        }

function renderStories(snap) {
    const container = document.getElementById('stories-container');
    container.innerHTML = "";
    snap.forEach(d => {
        const o = d.data();
        if (o.status === 'done') return; // ×œ× ××¦×™×’×™× ×’××•×¨×™× ×‘×¡×˜×•×¨×™
        
        // ×”×’× ×”: ×× ××™×Ÿ ×©× ×œ×§×•×—, ×”×©×ª××© ×‘×‘×¨×™×¨×ª ××—×“×œ
        const safeName = o.clientName || "×œ×§×•×— ×œ× ×™×“×•×¢";
        const ringClass = o.status === 'new' ? 'new' : 'waiting';
        const avatar = `https://ui-avatars.com/api/?name=${safeName}&background=random`;
        
        container.innerHTML += `
        <div class="flex flex-col items-center gap-1 min-w-[70px]" onclick="openOrder('${d.id}', '${safeName}')">
            <div class="story-circle ${ringClass}">
                <img src="${avatar}">
            </div>
            <div class="text-[10px] truncate w-full text-center">${safeName.split(' ')[0]}</div>
        </div>`;
    });
}

        // 2. ×¤×ª×™×—×ª ×”×–×× ×” ×•× ×™×”×•×œ
        window.openOrder = (id, name) => {
            // ×‘××¦×™××•×ª ×©×•×œ×¤×™× ×©×•×‘ ××ª ×”×“×•×§×•×× ×˜ ×”×¢×“×›× ×™
            // ×›××Ÿ × ×©×ª××© ×‘×˜×¨×™×§ ×©×œ ×—×™×¤×•×© ××”×™×¨×” ×‘-DOM ××• ×‘×©××™×¨×ª ×”×“××˜×” ×‘×¦×“
            // ×œ×¦×•×¨×š ×”×¤×©×˜×•×ª ×‘×§×•×“ ×”×–×”, × × ×™×— ×©×”××™×“×¢ ×–××™×Ÿ ××• × ×©××¨ ×‘×–×™×›×¨×•×Ÿ ×‘××¢×¨×š ×¦×“×“×™.
            // ×‘×’×¨×¡×” ××œ××” - ×¢×•×©×™× getDoc(id).
            
            // ×¡×™××•×œ×¦×™×” ×©×œ ×©×œ×™×¤×ª × ×ª×•× ×™× ××”×™×¨×” ××”××¢×¨×š ×”×’×œ×•×‘×œ×™ (×œ× ××™×•×©× ×¤×” ××œ×)
            // × ×©×ª××© ×‘-event listener ×¢×œ ×”×¨×©×™××” ×”×¨××©×™×ª ×›×“×™ ×œ×¢×“×›×Ÿ ××ª ×”×¤×× ×œ
        };

        // (×‘×’×œ×œ ××’×‘×œ×ª ××•×¨×š, ×”× ×” ×”×œ×•×’×™×§×” ×”××¨×›×–×™×ª ×œ×¤×× ×œ ×”× ×™×”×•×œ)
        // ×‘×¨×’×¢ ×©× ×¤×ª×— ×”×–×× ×”, × ×‘×“×•×§ ××ª ×”×¡×˜×˜×•×¡:
        
        window.updatePanelUI = (o) => {
            // ×× ×¡×˜×˜×•×¡ NEW -> ×”×¦×’ ×©×“×” ×”×–× ×ª ×§×•××§×¡
            const actionDiv = document.getElementById('action-area');
            if (o.status === 'new') {
                actionDiv.innerHTML = `
                    <label class="block text-xs text-blue-400 mb-2 font-bold">ğŸ¯ ×©×œ×‘ 1: ×”×§×œ×“×” ×•×”×–× ×ª ××¡×¤×¨</label>
                    <div class="flex gap-2">
                        <input id="input-comax" type="text" placeholder="×”×›× ×¡ ××¡' ×§×•××§×¡ (×œ××©×œ 6210496)" class="flex-1 bg-slate-900 border border-slate-600 p-2 rounded text-white text-sm outline-none focus:border-blue-500">
                        <button onclick="saveComaxNum('${o.id}')" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded font-bold text-sm">×©××•×¨</button>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2">×”×–× ×ª ×”××¡×¤×¨ ×ª××¤×©×¨ ×œ××¢×¨×›×ª ×œ×–×”×•×ª ××ª ×”××™×™×œ ×‘××•×¤×Ÿ ××•×˜×•××˜×™.</p>
                `;
            } 
            else if (o.status === 'processing') {
                actionDiv.innerHTML = `<div class="text-yellow-500 text-sm animate-pulse">â³ ×××ª×™×Ÿ ×œ××™×™×œ ××§×•××§×¡ ×¢× ×”×–×× ×” ${o.comaxNum}...</div>`;
            }
            else if (o.status === 'waiting_approval') {
                actionDiv.innerHTML = `<div class="text-orange-500 text-sm font-bold">âœ‹ ×××ª×™×Ÿ ×œ××™×©×•×¨ ×”×œ×§×•×—</div>`;
                document.getElementById('pdf-preview').classList.remove('hidden');
                document.getElementById('pdf-link').href = o.pdfUrl;
            }
            else {
                actionDiv.innerHTML = `<div class="text-green-500 text-sm font-bold">âœ… ×”×”×–×× ×” ××•×©×¨×” ×•×”×•×©×œ××”</div>`;
            }

            // ×¦×™×¨ ×–××Ÿ ×•×™×–×•××œ×™
            renderTimeline(o);
        };

        window.saveComaxNum = async (id) => {
            const num = document.getElementById('input-comax').value;
            if(!num) return alert("×—×•×‘×” ×œ×”×–×™×Ÿ ××¡×¤×¨!");
            
            await updateDoc(doc(db, "orders", id), {
                comaxNum: num,
                status: 'processing' // ××©× ×™× ×œ×¡×˜×˜×•×¡ ×‘×™× ×™×™×
            });
            alert("××¡×¤×¨ × ×©××¨! ×”××¢×¨×›×ª ×××–×™× ×” ×›×¢×ª ×œ××™×™×œ.");
        };

        // ×¢×–×¨×™×
        function getStatusInfo(o) {
            if(o.status==='new') return {cls:'st-new', txt:'×—×“×©'};
            if(o.status==='processing') return {cls:'st-proc', txt:'×”×•×§×œ×“'};
            if(o.status==='waiting_approval') return {cls:'st-wait', txt:'×××ª×™×Ÿ'};
            return {cls:'st-done', txt:'×‘×•×¦×¢'};
        }
    </script>
</body>
</html>
