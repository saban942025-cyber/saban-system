<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban TaskForce</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #f3f4f6; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        .header { background: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .header-title { font-weight: 800; font-size: 20px; color: #1f2937; display: flex; align-items: center; gap: 8px; }
        
        /* Filters */
        .filters { padding: 15px 20px; display: flex; gap: 10px; overflow-x: auto; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .filter-chip { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; white-space: nowrap; border: 1px solid #e5e7eb; background: white; color: #6b7280; }
        .filter-chip.active { background: #1f2937; color: white; border-color: #1f2937; }
        
        /* Task List */
        .task-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        /* Task Card */
        .task-card { background: white; border-radius: 12px; padding: 16px; border-left: 5px solid #d1d5db; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: 0.2s; position: relative; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .priority-high { border-left-color: #ef4444; } /* 祝 -  */
        .priority-medium { border-left-color: #f59e0b; } /*  - 转 */
        .priority-low { border-left-color: #10b981; } /* 专 - 专拽 */
        
        .task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .task-title { font-weight: 700; font-size: 15px; color: #111827; }
        .task-meta { font-size: 11px; color: #6b7280; display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .assignee-badge { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 10px; }
        
        /* 365 Button */
        .btn-365 { position: absolute; bottom: 12px; left: 12px; width: 28px; height: 28px; background: #f3f4f6; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #2563eb; transition: 0.2s; }
        .btn-365:hover { background: #dbeafe; }

        /* FAB (Floating Action Button) */
        .fab { position: fixed; bottom: 25px; left: 25px; width: 56px; height: 56px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4); cursor: pointer; transition: 0.2s; }
        .fab:hover { transform: scale(1.1); background: #1d4ed8; }
        .fab:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">
            <i class="fas fa-check-double text-blue-600"></i> 砖转 住
        </div>
        <div class="text-xs text-gray-500 font-bold" id="user-display">注...</div>
    </div>

    <div class="filters">
        <div class="filter-chip active" onclick="filterTasks('all', this)"> 砖转</div>
        <div class="filter-chip" onclick="filterTasks('my', this)">砖转 砖</div>
        <div class="filter-chip" onclick="filterTasks('sent', this)">砖转 砖爪专转</div>
        <div class="filter-chip" onclick="filterTasks('urgent', this)"> 祝</div>
    </div>

    <div id="tasks-list" class="task-container">
        <div class="text-center text-gray-400 mt-10">
            <i class="fas fa-spinner fa-spin text-2xl"></i><br>注 转...
        </div>
    </div>

    <div class="fab" onclick="openAddTaskModal()">
        <i class="fas fa-plus"></i>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanSounds } from './js/sounds.js';

        // 1. Firebase & Auth
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let currentUser = JSON.parse(localStorage.getItem('saban_client'));
        if(!currentUser) {
            //   砖转砖 - 专拽 专砖 ( 驻注)
            window.location.href = 'register.html'; 
        }
        document.getElementById('user-display').innerText = currentUser.name;

        let allTasks = [];
        let filterMode = 'all';

        // 2. Load Tasks (Real Time)
        // 注 转  砖转 砖拽砖专转  ( 砖 爪专转,  砖砖 )
        const q = query(collection(db, "tasks"), orderBy("createdAt", "desc"));
        
        onSnapshot(q, (snap) => {
            allTasks = [];
            snap.forEach(d => allTasks.push({ id: d.id, ...d.data() }));
            renderTasks();
        });

        function renderTasks() {
            const container = document.getElementById('tasks-list');
            container.innerHTML = '';
            
            const filtered = allTasks.filter(t => {
                if(filterMode === 'my') return t.assignedTo === currentUser.uid;
                if(filterMode === 'sent') return t.createdBy === currentUser.uid;
                if(filterMode === 'urgent') return t.priority === '';
                return true; // all
            });

            if(filtered.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 mt-10"> 砖转 爪 Ч</div>`;
                return;
            }

            filtered.forEach(t => {
                let borderClass = 'priority-low';
                if(t.priority === '祝') borderClass = 'priority-medium';
                if(t.priority === '') borderClass = 'priority-high';

                // Outlook Link Generator
                const outlookLink = generateOutlookLink(t.title, t.description, t.dueDate);

                const html = `
                <div class="task-card ${borderClass} ${t.status === 'done' ? 'opacity-50 grayscale' : ''}">
                    <div class="task-header">
                        <div class="task-title">${t.description}</div>
                        <input type="checkbox" class="w-5 h-5 accent-blue-600 cursor-pointer" 
                               ${t.status === 'done' ? 'checked' : ''} 
                               onchange="toggleTask('${t.id}', this.checked)">
                    </div>
                    
                    <div class="flex gap-2 mb-2">
                        <span class="assignee-badge"><i class="fas fa-user"></i> 注专: ${t.assignedToName}</span>
                        <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500 border">转: ${t.createdByName}</span>
                    </div>

                    <div class="task-meta">
                        <span><i class="far fa-calendar-alt"></i> ${t.dueDate || ' 转专'}</span>
                        ${t.priority === '' ? '<span class="text-red-500 font-bold"><i class="fas fa-fire"></i> !</span>' : ''}
                    </div>

                    <a href="${outlookLink}" target="_blank" class="btn-365" title="住祝  Outlook">
                        <i class="far fa-calendar-plus"></i>
                    </a>
                </div>`;
                container.innerHTML += html;
            });
        }

        // 3. Logic: Add Task + 365 Sync
        window.openAddTaskModal = async () => {
            // Get users list for dropdown
            const usersSnap = await getDocs(query(collection(db, "users"), orderBy("name")));
            let usersOptions = '';
            usersSnap.forEach(u => {
                const user = u.data();
                usersOptions += `<option value="${user.phone}" data-name="${user.name}">${user.name}</option>`;
            });

            Swal.fire({
                title: '砖 砖',
                html: `
                    <div class="text-right space-y-3">
                        <textarea id="task-desc" class="swal2-textarea w-full mx-0" placeholder=" 爪专 爪注?"></textarea>
                        
                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500">?</label>
                                <select id="task-assignee" class="swal2-input w-full mx-0 text-sm">${usersOptions}</select>
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500">驻转</label>
                                <select id="task-prio" class="swal2-input w-full mx-0 text-sm">
                                    <option value="专">专</option>
                                    <option value="祝">祝</option>
                                    <option value=""> </option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500">转专 注 (住专 )</label>
                            <input type="datetime-local" id="task-date" class="swal2-input w-full mx-0">
                        </div>
                    </div>
                `,
                confirmButtonText: '爪专 砖',
                confirmButtonColor: '#2563eb',
                showCancelButton: true,
                preConfirm: () => {
                    const select = document.getElementById('task-assignee');
                    return {
                        desc: document.getElementById('task-desc').value,
                        assigneeUid: select.value,
                        assigneeName: select.options[select.selectedIndex].getAttribute('data-name'),
                        prio: document.getElementById('task-prio').value,
                        date: document.getElementById('task-date').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const d = result.value;
                    if(!d.desc) return;

                    await addDoc(collection(db, "tasks"), {
                        description: d.desc,
                        assignedTo: d.assigneeUid, // phone number as uid
                        assignedToName: d.assigneeName,
                        priority: d.prio,
                        dueDate: d.date,
                        status: 'pending',
                        createdBy: currentUser.uid,
                        createdByName: currentUser.name,
                        createdAt: serverTimestamp()
                    });

                    // Play Sound
                    try { new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg').play(); } catch(e){}
                    
                    Swal.fire({
                        title: '爪专!', 
                        text: '砖 砖 驻注 爪 注',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        };

        // 4. Actions
        window.toggleTask = async (id, isDone) => {
            await updateDoc(doc(db, "tasks", id), { status: isDone ? 'done' : 'pending' });
            if(isDone) try { new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg').play(); } catch(e){}
        };

        window.filterTasks = (mode, el) => {
            filterMode = mode;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderTasks();
        };

        // 5. The 365 Deep Link Magic
        function generateOutlookLink(title, body, dateStr) {
            //   转专, 拽 转   + 砖注
            let start = new Date();
            if(dateStr) start = new Date(dateStr);
            let end = new Date(start.getTime() + 60*60*1000); // +1 hour

            const format = (d) => d.toISOString();
            
            const subject = encodeURIComponent(`砖转 住: ${body}`);
            const desc = encodeURIComponent(`爪专 注专转 TaskForce.\n\n转专: ${body}`);
            
            // 拽 专砖 砖 拽专住驻 驻转转 专注 砖 -Web
            return `https://outlook.office.com/calendar/0/deeplink/compose?subject=${subject}&body=${desc}&startdt=${format(start)}&enddt=${format(end)}&path=/calendar/view/Month`;
        }

        // Expose
        window.openAddTaskModal = openAddTaskModal;
        window.toggleTask = toggleTask;
        window.filterTasks = filterTasks;

    </script>
</body>
</html>
