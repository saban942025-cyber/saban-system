<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Logistics | ×ª××™×¨</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ×›×—×•×œ - ×¡× ×™×£ ×”×ª×œ××™×“ */
        body { background: #1e3a8a; color: white; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-start { background: #3b82f6; color: white; font-size: 24px; font-weight: 900; padding: 20px 40px; border-radius: 15px; border: 4px solid #93c5fd; animation: pulse 2s infinite; cursor: pointer; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .top-bar { background: #172554; padding: 15px; border-bottom: 2px solid #3b82f6; display: flex; justify-content: space-between; align-items: center; }
        .orders-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        .order-card { background: #fff; color: #1e293b; border-radius: 12px; overflow: hidden; border-right: 6px solid #94a3b8; animation: slideIn 0.3s ease-out; }
        .card-new { border-color: #ef4444; background: #fff1f2; } 
        .card-picking { border-color: #f59e0b; background: #fffbeb; } 
        
        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #e2e8f0; }
        .card-body { padding: 15px; font-size: 15px; font-weight: 500; }
        .card-actions { padding: 10px; display: flex; gap: 10px; }

        .btn-action { flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; color: white; }
        .btn-pick { background: #f59e0b; color: black; }
        .btn-call { background: #10b981; }
        .btn-done { background: #3b82f6; }
        
        .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; color: white; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="start-overlay">
        <div class="mb-4 text-4xl">ğŸ—ï¸</div>
        <div class="mb-6 text-2xl font-bold">××¢×¨×›×ª ×—×¦×¨ - ×ª××™×¨</div>
        <button class="btn-start" onclick="startShift()">×¤×ª×— ××©××¨×ª</button>
    </div>

    <div class="top-bar">
        <div>
            <div class="text-xs text-blue-200">×× ×”×œ ×—×¦×¨</div>
            <div class="font-bold text-xl">×ª××™×¨</div>
        </div>
        <div class="bg-blue-600 px-3 py-1 rounded text-xs font-mono">×¡× ×™×£ ×”×ª×œ××™×“ 6</div>
    </div>

    <div id="orders-list" class="orders-container">
        <div class="text-center text-blue-200 mt-10">×××ª×™×Ÿ ×œ×”×–×× ×•×ª...</div>
    </div>

    <audio id="sound-new" src="https://actions.google.com/sounds/v1/alarms/mechanical_clock_ring.ogg"></audio>
    <audio id="sound-horn" src="https://actions.google.com/sounds/v1/transportation/car_horn.ogg"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, doc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        window.startShift = () => {
            document.getElementById('sound-new').play().then(() => document.getElementById('sound-new').pause()).catch(()=>{});
            document.getElementById('start-overlay').style.display = 'none';
        };

        // --- LISTENER (×¤×™×œ×˜×¨ ×œ×¡× ×™×£ ×”×ª×œ××™×“ - 'main') ---
        const q = query(collection(db, "orders"), 
            where("status", "in", ["assigned", "picking", "en_route"]),
            where("pickupBranch", "==", "main"), // <--- ×–×” ×”×¤×™×œ×˜×¨ ×©×œ ×ª××™×¨!
            orderBy("createdAt", "desc")
        );

        onSnapshot(q, (snap) => {
            const container = document.getElementById('orders-list');
            container.innerHTML = '';
            if(snap.empty) { container.innerHTML = '<div class="text-center text-blue-300 mt-10">××™×Ÿ ×¢×‘×•×“×” ×›×¨×’×¢ â˜•</div>'; return; }

            snap.forEach(docSnap => {
                const order = { id: docSnap.id, ...docSnap.data() };
                renderOrder(order, container);
            });
        });

        function renderOrder(order, container) {
            let statusColor='bg-gray-500', statusText='×××ª×™×Ÿ', cardClass='', buttonsHtml='';

            if (order.status === 'assigned') {
                statusColor='bg-red-500'; statusText='×—×“×© - ×œ×”×›× ×”'; cardClass='card-new';
                // ×× ×–×• ×”×–×× ×” ×—×“×©×” (×‘-10 ×©× ×™×•×ª ×”××—×¨×•× ×•×ª) - × ×’×Ÿ ×¦×œ×™×œ
                if (Date.now() - (order.createdAt?.seconds*1000) < 10000) { document.getElementById('sound-new').play().catch(()=>{}); }
                buttonsHtml = `<button onclick="updateStatus('${order.id}', 'picking')" class="btn-action btn-pick"><i class="fas fa-box-open"></i> ×”×ª×—×œ ×œ×™×§×•×˜</button>`;
            } else if (order.status === 'picking') {
                statusColor='bg-orange-500'; statusText='×‘×œ×™×§×•×˜'; cardClass='card-picking';
                buttonsHtml = `
                    <button onclick="callDriver('${order.driverId}', '${order.clientName}')" class="btn-action btn-call"><i class="fas fa-bullhorn"></i> ×§×¨× ×œ× ×”×’</button>
                    <button onclick="updateStatus('${order.id}', 'en_route')" class="btn-action btn-done"><i class="fas fa-check"></i> ×”×•×¢××¡</button>`;
            } else if (order.status === 'en_route') {
                statusColor='bg-blue-500'; statusText='×™×¦×'; buttonsHtml = `<div class="text-center w-full text-green-600 font-bold py-2">×˜×•×¤×œ</div>`;
            }

            container.innerHTML += `
            <div class="order-card ${cardClass}">
                <div class="card-header"><div><div class="text-xs text-gray-400">#${order.id.slice(-4)} | ${order.driverId}</div><div class="font-bold text-lg">${order.clientName}</div></div><span class="status-badge ${statusColor}">${statusText}</span></div>
                <div class="card-body">${order.text}<div class="mt-2 text-xs text-gray-500"><i class="fas fa-map-marker-alt"></i> ${order.address||''}</div></div>
                <div class="card-actions">${buttonsHtml}</div>
            </div>`;
        }

        window.updateStatus = async (id, status) => { await updateDoc(doc(db, "orders", id), { status: status, lastUpdate: serverTimestamp() }); };

        window.callDriver = async (driverName, client) => {
            document.getElementById('sound-horn').play();
            let driverPhone = '';
            if(driverName.includes('×—×›××ª')) driverPhone = '0500000607';
            if(driverName.includes('×¢×œ×™')) driverPhone = '054-2276631';
            
            if(driverPhone) {
                // ×©×•×œ×— ×”×•×“×¢×” ×œ×¦'××˜ ×©×œ ×”× ×”×’
                await addDoc(collection(db, `chats/chat_${driverPhone}/messages`), {
                    text: `ğŸ“¢ **×§×¨×™××” ××”×ª×œ××™×“ (×ª××™×¨):** ×”×¡×—×•×¨×” ×œ-${client} ××•×›× ×”! ×’×© ×œ×”×¢××¡×”.`,
                    sender: '×ª××™×¨ (×—×¦×¨)', timestamp: serverTimestamp()
                });
                Swal.fire({title: '×”× ×”×’ × ×§×¨×!', text: '×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×”', icon: 'success', timer: 1500, showConfirmButton: false});
            } else {
                Swal.fire('×©×’×™××”', '×œ× × ××¦× ×˜×œ×¤×•×Ÿ × ×”×’ ×‘××¢×¨×›×ª', 'error');
            }
        };
    </script>
</body>
</html>
