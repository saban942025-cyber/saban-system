<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Client | 转</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* WhatsApp-like Design */
        body { background: #efeae2; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .app-header { background: #008069; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        .order-card { background: white; border-radius: 8px; padding: 12px; margin: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .order-card::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 4px; border-radius: 0 8px 8px 0; }
        .status-new { border-right: 4px solid #25D366; } /* Green */
        .status-wait { border-right: 4px solid #FFC107; } /* Yellow */
        .status-done { border-right: 4px solid #34B7F1; } /* Blue */

        .fab-btn { position: fixed; bottom: 20px; left: 20px; background: #25D366; color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 24px; transition: transform 0.2s; }
        .fab-btn:active { transform: scale(0.9); }

        /* Modal */
        #orderModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; align-items: flex-end; }
        .modal-content { background: #f0f2f5; width: 100%; height: 90vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from {transform: translateY(100%)} to {transform: translateY(0)} }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="flex items-center gap-3">
            <img id="userAvatar" class="w-10 h-10 rounded-full border-2 border-white/20">
            <div>
                <h1 class="font-bold text-lg leading-tight">住专 .住</h1>
                <p id="userName" class="text-xs opacity-80">拽 专</p>
            </div>
        </div>
    </header>

    <div id="orders-container" class="flex-1 overflow-y-auto pb-20">
        </div>

    <button onclick="openModal()" class="fab-btn"><i class="fas fa-plus"></i></button>

    <div id="orderModal">
        <div class="modal-content">
            <div class="p-4 bg-white flex justify-between items-center shadow-sm rounded-t-2xl">
                <h2 class="font-bold text-lg"> 砖 </h2>
                <button onclick="closeModal()" class="text-gray-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto space-y-4">
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <label class="block text-xs font-bold text-teal-700 mb-2">转 住驻拽? (砖 住专)</label>
                    <div class="flex gap-2">
                        <input type="date" id="supplyDate" class="flex-1 p-3 bg-gray-50 rounded-lg border border-gray-200 outline-none focus:border-teal-500">
                        <input type="time" id="supplyTime" class="w-1/3 p-3 bg-gray-50 rounded-lg border border-gray-200 outline-none focus:border-teal-500">
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <label class="block text-xs font-bold text-teal-700 mb-2">驻专  (拽住 驻砖)</label>
                    <textarea id="orderText" class="w-full h-32 p-3 bg-gray-50 rounded-lg border border-gray-200 outline-none resize-none" placeholder="砖: 10 砖 拽 20, 5  ..."></textarea>
                </div>
            </div>

            <div class="p-4 bg-white border-t">
                <button onclick="sendOrder()" class="w-full py-3 bg-[#008069] text-white font-bold rounded-xl shadow-lg flex justify-center items-center gap-2">
                    <i class="fas fa-paper-plane"></i> 砖 住专
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, addDoc, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        // 
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid') || 'guest';
        const clientName = uid === 'guest' ? '专' : `拽 ${uid}`;
        
        document.getElementById('userName').innerText = clientName;
        document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${uid}&background=008069&color=fff`;

        // 专专转  转专 (专 -07:00)
        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('supplyDate').valueAsDate = tomorrow;
        document.getElementById('supplyTime').value = "07:00";

        // 
        const q = query(collection(db, "orders"), where("clientId", "==", uid), orderBy("createdAt", "desc"));
        onSnapshot(q, (snap) => {
            const c = document.getElementById('orders-container');
            c.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                c.innerHTML += renderCard(d.id, o);
            });
        });

        function renderCard(id, o) {
            let borderClass = 'status-new';
            let statusBadge = `<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs">砖</span>`;
            let actionBtn = "";

            if(o.status === 'processing') {
                statusBadge = `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">拽 #${o.comaxNum}</span>`;
            }
            if(o.status === 'waiting_approval') {
                borderClass = 'status-wait';
                statusBadge = `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold animate-pulse">转 砖专</span>`;
                actionBtn = `
                <div class="mt-3 flex gap-2">
                    <a href="${o.pdfUrl}" target="_blank" class="flex-1 bg-white border border-gray-300 py-2 rounded text-center text-sm font-bold text-gray-700"> 爪驻</a>
                    <button onclick="approve('${id}')" class="flex-1 bg-[#008069] text-white py-2 rounded text-center text-sm font-bold shadow"> 砖专</button>
                </div>`;
            }
            if(o.status === 'done') {
                borderClass = 'status-done';
                statusBadge = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">砖专 爪注</span>`;
            }

            return `
            <div class="order-card ${borderClass}">
                <div class="flex justify-between items-start mb-1">
                    <span class="font-bold text-gray-800"> ${o.orderNum}</span>
                    <span class="text-xs text-gray-400">${new Date(o.createdAt?.seconds*1000).toLocaleTimeString().slice(0,5)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">${o.itemsText || '驻专 ...'}</p>
                <div class="flex justify-between items-center">
                    ${statusBadge}
                    <div class="text-xs text-teal-600 font-bold"><i class="far fa-clock"></i> 住驻拽: ${o.supplyDate} ${o.supplyTime}</div>
                </div>
                ${actionBtn}
            </div>`;
        }

        window.openModal = () => document.getElementById('orderModal').style.display = 'flex';
        window.closeModal = () => document.getElementById('orderModal').style.display = 'none';

        window.sendOrder = async () => {
            const text = document.getElementById('orderText').value;
            const date = document.getElementById('supplyDate').value;
            const time = document.getElementById('supplyTime').value;

            if(!text) return alert("  驻专 ");

            await addDoc(collection(db, "orders"), {
                clientId: uid,
                clientName: clientName,
                itemsText: text,
                supplyDate: date,
                supplyTime: time,
                status: 'new',
                orderNum: "APP-" + Math.floor(Math.random() * 1000),
                createdAt: serverTimestamp()
            });
            closeModal();
            // 驻住
            document.getElementById('orderText').value = "";
        };

        window.approve = async (id) => {
            if(confirm("砖专 转  住驻转?")) {
                await updateDoc(doc(db, "orders", id), { status: 'done', approvedAt: serverTimestamp() });
            }
        };
        window.approve = window.approve; // Expose to global
    </script>
</body>
</html>
