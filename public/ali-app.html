<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Comm Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background: #d1d7db; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 30%; min-width: 300px; background: white; border-left: 1px solid #e9edef; display: flex; flex-direction: column; }
        .main-chat { flex: 1; background: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); display: flex; flex-direction: column; }
        
        .chat-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f5f6f6; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }
        .avatar { width: 45px; height: 45px; rounded: 50%; margin-left: 12px; }
        
        .msg { max-width: 60%; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; position: relative; font-size: 14px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        
        .btn-dispatch { background: #54656f; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-4 bg-gray-100 border-b flex items-center justify-between">
            <div class="font-bold text-gray-700">爪' 驻注</div>
            <i class="fas fa-edit text-gray-500"></i>
        </div>
        <div id="contacts-list" class="flex-1 overflow-y-auto"></div>
    </div>

    <div class="main-chat">
        <div class="h-[60px] bg-[#f0f2f5] flex items-center justify-between px-4 border-b">
            <div class="flex items-center">
                <img id="active-avatar" src="" class="w-10 h-10 rounded-full ml-3 hidden">
                <div class="font-bold text-gray-800" id="active-name">专 爪'</div>
            </div>
            <button id="btn-dispatch" onclick="openDispatchModal()" class="btn-dispatch hidden">
                <i class="fas fa-tasks"></i> 砖专 砖
            </button>
        </div>

        <div id="messages-area" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>

        <div class="h-[62px] bg-[#f0f2f5] p-3 flex gap-3 items-center">
            <input id="msg-input" class="flex-1 bg-white p-3 rounded-lg border-none outline-none" placeholder="拽 注..." onkeydown="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="text-[#00a884] text-2xl"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // >>> 专砖转 爪' 注转 驻 砖 <<<
        const CHATS = [
            { id: 'orders_main', name: '转 拽转', type: 'group', avatar: 'https://ui-avatars.com/api/?name=Orders&background=00a884&color=fff' },
            { id: 'management', name: '注转 ', type: 'group', avatar: 'https://ui-avatars.com/api/?name=Saban&background=1e293b&color=fff' },
            
            // 转
            { id: 'chat_0500000607', name: '转 ()', phone: '0500000607', type: 'driver', avatar: 'https://cdn-icons-png.flaticon.com/512/1995/1995470.png' },
            
            // 注 - 住驻专 拽  砖!
            { id: 'chat_054-2276631', name: '注 (祝)', phone: '054-2276631', type: 'driver', avatar: 'https://cdn-icons-png.flaticon.com/512/741/741407.png' }
        ];

        let activeChat = null;

        function renderList() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            CHATS.forEach(c => {
                list.innerHTML += `
                <div class="chat-item" onclick="loadChat('${c.id}')">
                    <img src="${c.avatar}" class="avatar">
                    <div>
                        <div class="font-bold text-sm">${c.name}</div>
                        <div class="text-xs text-gray-500">抓 爪驻</div>
                    </div>
                </div>`;
            });
        }
        renderList();

        window.loadChat = (chatId) => {
            const chat = CHATS.find(c => c.id === chatId);
            activeChat = chat;
            
            document.getElementById('active-name').innerText = chat.name;
            document.getElementById('active-avatar').src = chat.avatar;
            document.getElementById('active-avatar').classList.remove('hidden');
            
            const btn = document.getElementById('btn-dispatch');
            if (chat.type === 'driver') {
                btn.classList.remove('hidden');
                btn.classList.add('flex');
            } else {
                btn.classList.add('hidden');
                btn.classList.remove('flex');
            }

            const q = query(collection(db, `chats/${chatId}/messages`));
            onSnapshot(q, (snap) => {
                const area = document.getElementById('messages-area');
                area.innerHTML = '';
                const msgs = snap.docs.map(d => d.data()).sort((a,b) => (a.timestamp?.seconds||0) - (b.timestamp?.seconds||0));
                
                msgs.forEach(m => {
                    const isMe = m.sender === '专 (Admin)';
                    area.innerHTML += `
                    <div class="msg ${isMe ? 'msg-out' : 'msg-in'}">
                        ${!isMe && chat.type === 'group' ? `<div class="text-xs font-bold text-orange-600">${m.sender}</div>` : ''}
                        ${m.text}
                        <div class="text-[9px] text-gray-500 text-left mt-1">${m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'}</div>
                    </div>`;
                });
                area.scrollTop = area.scrollHeight;
            });
        };

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !activeChat) return;
            input.value = '';
            await addDoc(collection(db, `chats/${activeChat.id}/messages`), {
                text: text, sender: '专 (Admin)', timestamp: serverTimestamp()
            });
        };

        // --- Dispatch Task (Fixed) ---
        window.openDispatchModal = () => {
            if(!activeChat || activeChat.type !== 'driver') return;
            Swal.fire({
                title: `砖 ${activeChat.name}`,
                html: `
                    <div class="text-right space-y-3">
                        <select id="task-cat" class="swal2-input w-full mx-0 text-sm"><option value="client">  ()</option><option value="transfer"> 注专 (转)</option><option value="urgent"> 祝 ()</option></select>
                        <textarea id="task-desc" class="swal2-textarea w-full mx-0" placeholder="驻专..."></textarea>
                        <input id="task-addr" class="swal2-input w-full mx-0" placeholder="转转 (Waze)">
                    </div>
                `,
                confirmButtonText: '砖专 ',
                showCancelButton: true,
                preConfirm: () => { return { type: document.getElementById('task-cat').value, desc: document.getElementById('task-desc').value, addr: document.getElementById('task-addr').value } }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    // 抓 砖  拽 ( 住专)
                    const driverName = activeChat.name.split(' ')[0]; 
                    
                    // 1. 爪专转 砖
                    await addDoc(collection(db, "orders"), {
                        driverId: driverName, // 砖  (注)
                        clientName: "砖 ",
                        text: data.desc,
                        address: data.addr,
                        taskType: data.type,
                        status: 'assigned',
                        lastUpdate: serverTimestamp(),
                        createdAt: serverTimestamp()
                    });

                    // 2. 注 爪'
                    await addDoc(collection(db, `chats/${activeChat.id}/messages`), {
                        text: ` *砖 砖:* ${data.desc}`, sender: '注专转', timestamp: serverTimestamp()
                    });
                    
                    Swal.fire('砖专!', '', 'success');
                }
            });
        };

        // Expose
        window.loadChat = loadChat;
        window.sendMessage = sendMessage;
        window.openDispatchModal = openDispatchModal;
    </script>
</body>
</html>
