<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Directory |  爪转 拽专</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; padding-bottom: 80px; }
        
        /* --- Header --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .page-title { font-size: 24px; font-weight: 800; color: #1e293b; display: flex; align-items: center; gap: 10px; }
        .actions-bar { display: flex; gap: 10px; align-items: center; }
        .search-bar { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 12px; width: 250px; display: flex; align-items: center; gap: 10px; }
        
        /* Buttons */
        .btn-new { background: #0f172a; color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-new:hover { background: #1e293b; transform: translateY(-2px); }
        .btn-broadcast { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); }

        /* --- CARDS (STAFF) --- */
        .staff-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; transition: 0.2s; position: relative; display: flex; flex-direction: column; }
        .staff-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: #cbd5e1; }
        
        .btn-edit-absolute { position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; z-index: 10; }
        .btn-edit-absolute:hover { background: #3b82f6; color: white; border-color: #3b82f6; }

        .branch-strip { height: 6px; width: 100%; }
        .strip-main { background: #3b82f6; } 
        .strip-harash { background: #f97316; } 
        .strip-logistics { background: #22c55e; } 

        .card-content { padding: 20px; text-align: center; flex: 1; }
        .avatar-container { position: relative; width: 80px; height: 80px; margin: 0 auto 10px; }
        .user-img { width: 100%; height: 100%; rounded-full; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .status-dot { position: absolute; bottom: 5px; right: 5px; width: 16px; height: 16px; background: #10b981; border: 3px solid white; border-radius: 50%; }

        .user-name { font-weight: 800; font-size: 18px; color: #334155; margin-bottom: 2px; }
        .user-role { font-size: 12px; font-weight: 700; color: #64748b; background: #f1f5f9; padding: 4px 10px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        
        /* Action Buttons */
        .btn-task { width: 100%; background: #f8fafc; border: 1px dashed #cbd5e1; color: #475569; padding: 8px; border-radius: 10px; font-weight: bold; font-size: 13px; margin-top: 5px; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-task:hover { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }

        /* Special App Buttons */
        .btn-app-manager { width: 100%; background: linear-gradient(135deg, #f97316 0%, #c2410c 100%); color: white; padding: 8px; border-radius: 10px; font-weight: bold; font-size: 13px; margin-top: 5px; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(249, 115, 22, 0.2); }
        .btn-app-manager:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(249, 115, 22, 0.3); }

        .btn-app-driver { width: 100%; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; padding: 8px; border-radius: 10px; font-weight: bold; font-size: 13px; margin-top: 5px; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
        .btn-app-driver:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3); }

        /* Comm Row */
        .comm-row { display: flex; justify-content: center; gap: 10px; margin-top: 15px; border-top: 1px solid #f1f5f9; padding-top: 10px; }
        .comm-btn { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.2s; }
        .comm-outlook { background: #e0f2fe; color: #0369a1; }
        .comm-wa { background: #dcfce7; color: #15803d; }
        .comm-teams { background: #f3e8ff; color: #7e22ce; }
        .comm-btn:hover { transform: scale(1.1); }

        /* --- TABLE (CLIENTS) --- */
        .section-title { font-size: 18px; font-weight: 800; color: #475569; margin: 40px 0 15px 0; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        
        .saban-table { width: 100%; background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; border-collapse: separate; border-spacing: 0; }
        .saban-table th { background: #f8fafc; color: #64748b; font-size: 12px; font-weight: 800; text-align: right; padding: 15px; border-bottom: 1px solid #e2e8f0; }
        .saban-table td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; vertical-align: middle; }
        .saban-table tr:last-child td { border-bottom: none; }
        .saban-table tr:hover { background: #f8fafc; }
        
        .table-avatar { width: 36px; height: 36px; rounded-full; object-fit: cover; border: 1px solid #e2e8f0; }
        .table-actions { display: flex; gap: 8px; }
        .btn-table-action { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #64748b; background: #f1f5f9; cursor: pointer; transition: 0.2s; }
        .btn-table-action:hover { background: #e2e8f0; color: #0f172a; }

    </style>
</head>
<body>

    <div class="page-header">
        <div class="page-title">
            <i class="fas fa-users-cog text-blue-600"></i>
            <div>
                <span> 专</span>
                <span class="text-xs font-normal text-gray-500 block" id="counter">注 转...</span>
            </div>
        </div>
        
        <div class="actions-bar">
            <button onclick="openBroadcastModal()" class="btn-broadcast">
                <i class="fas fa-bullhorn"></i> 专
            </button>
            <div class="search-bar">
                <i class="fas fa-search text-gray-400"></i>
                <input type="text" id="search" onkeyup="filterGrid()" placeholder="驻砖..." class="bg-transparent border-none outline-none text-sm w-full">
            </div>
            <button onclick="openEditModal()" class="btn-new">
                <i class="fas fa-plus"></i> 住祝
            </button>
        </div>
    </div>

    <div class="section-title"><i class="fas fa-id-badge text-blue-500"></i> 砖 爪转 </div>
    <div id="staff-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>

    <div id="clients-section" class="hidden">
        <div class="section-title"><i class="fas fa-briefcase text-orange-500"></i> 拽转 砖 拽砖专</div>
        <div class="overflow-x-auto">
            <table class="saban-table">
                <thead>
                    <tr>
                        <th width="60">转</th>
                        <th>砖</th>
                        <th>转驻拽/专</th>
                        <th>驻</th>
                        <th></th>
                        <th>住祝 砖</th>
                        <th width="120">驻注转</th>
                    </tr>
                </thead>
                <tbody id="clients-table-body"></tbody>
            </table>
        </div>
    </div>

    <audio id="sound-driver-start" src="https://actions.google.com/sounds/v1/transportation/car_horn.ogg"></audio>
    <audio id="sound-driver-arrive" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, deleteDoc, serverTimestamp, getDocs, where, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // --- 1. SEED DATA ---
        const FULL_STAFF_LIST = [
            { name: "专 住", role: "\"", phone: "0505227724", email: "harel@saban94.co.il", branch: "main", type: "admin" },
            { name: "专 住专", role: " 转驻注 (Admin)", phone: "0508860896", email: "ramims@saban94.co.il", branch: "main", type: "admin" },
            { name: "", role: " 住专", phone: "0507855865", email: "yoav@saban94.co.il", branch: "main", type: "admin" },
            { name: "转", role: " 专砖", phone: "0548132442", email: "netanel@saban94.co.il", branch: "main", type: "manager" },
            { name: "爪拽 ", role: " 住祝 专砖", phone: "0504482285", email: "itzik@saban94.co.il", branch: "harash", type: "manager" },
            { name: "注", role: " 祝", phone: "", email: "", branch: "logistics", type: "driver" },
            { name: "转", role: " 砖转", phone: "", email: "", branch: "logistics", type: "driver" },
            { name: "专", role: "转 砖专", phone: "0506662300", email: "vered@saban94.co.il", branch: "main", type: "office" },
            { name: "专", role: " 爪专 专砖", phone: "0509001392", email: "", branch: "harash", type: "field" },
            { name: "砖", role: "驻拽/拽", phone: "", email: "", branch: "harash", type: "field" },
            { name: "转专", role: " 爪专 转", phone: "0523002828", email: "", branch: "main", type: "field" }
        ];

        async function syncStaffDatabase() {
            const snap = await getDocs(collection(db, "users"));
            if (snap.size < 5) {
                const existingNames = new Set();
                snap.forEach(d => existingNames.add(d.data().name));
                for (const staff of FULL_STAFF_LIST) {
                    if (!existingNames.has(staff.name)) {
                        await addDoc(collection(db, "users"), { ...staff, permissions: 'view', active: true, createdAt: new Date() });
                    }
                }
            }
        }
        syncStaffDatabase();

        // --- 2. DRIVER MONITORING (THE POPUP FEATURE) ---
        //  砖 住住 转  转  拽驻抓 注转 
        function monitorDriverActivity() {
            const q = query(collection(db, "orders"), orderBy("lastUpdate", "desc"), limit(1));
            
            onSnapshot(q, (snap) => {
                snap.docChanges().forEach((change) => {
                    if (change.type === "modified") {
                        const data = change.doc.data();
                        
                        // 拽 砖砖 拽专 砖 注砖 (-10 砖转 专转)   拽驻抓 住转
                        if (data.lastUpdate && (Date.now() - data.lastUpdate.seconds * 1000) < 10000) {
                            
                            // 1.  爪 专
                            if (data.status === 'en_route') {
                                document.getElementById('sound-driver-start').play().catch(()=>{});
                                Swal.fire({
                                    title: `${data.driverId} 爪 专! `,
                                    text: `砖: ${data.clientName}`,
                                    position: 'top-end',
                                    icon: 'info',
                                    toast: true,
                                    timer: 5000,
                                    showConfirmButton: false,
                                    background: '#ecfdf5',
                                    color: '#065f46'
                                });
                            }
                            
                            // 2.  注
                            if (data.status === 'arrived') {
                                document.getElementById('sound-driver-arrive').play().catch(()=>{});
                                Swal.fire({
                                    title: `${data.driverId} 注 注 `,
                                    text: `爪 拽: ${data.clientName}`,
                                    position: 'top-end',
                                    icon: 'success',
                                    toast: true,
                                    timer: 5000,
                                    showConfirmButton: false
                                });
                            }
                        }
                    }
                });
            });
        }
        monitorDriverActivity(); // 驻注转 专

        // --- 3. RENDER LOGIC ---
        onSnapshot(query(collection(db, "users"), orderBy("name")), (snap) => {
            const grid = document.getElementById('staff-grid');
            const tableBody = document.getElementById('clients-table-body');
            const clientsSection = document.getElementById('clients-section');
            
            grid.innerHTML = '';
            tableBody.innerHTML = '';
            
            let staffCount = 0;
            let clientCount = 0;

            snap.forEach(docSnap => {
                const p = { id: docSnap.id, ...docSnap.data() };
                const avatar = p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=random&color=fff`;
                const userJson = JSON.stringify(p).replace(/"/g, '&quot;');

                // CLIENT ROW
                if (p.type === 'client') {
                    clientCount++;
                    tableBody.innerHTML += `
                    <tr class="item-row" data-name="${p.name}">
                        <td><img src="${avatar}" class="table-avatar"></td>
                        <td class="font-bold text-slate-800">${p.name}</td>
                        <td class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded inline-block">${p.role || '拽'}</td>
                        <td class="font-mono text-xs">${p.phone || '-'}</td>
                        <td class="text-xs text-blue-600 underline cursor-pointer">${p.email || '-'}</td>
                        <td class="text-xs">${getBranchName(p.branch)}</td>
                        <td>
                            <div class="table-actions">
                                <div class="btn-table-action" onclick="openEditModal('${userJson}')"><i class="fas fa-pencil-alt"></i></div>
                                <div class="btn-table-action" onclick="openTaskModal('${p.id}', '${p.name}', '${p.phone}')"><i class="fas fa-tasks text-blue-500"></i></div>
                                <div class="btn-table-action" onclick="window.open('https://wa.me/972${p.phone?.replace(/^0/,'')}', '_blank')"><i class="fab fa-whatsapp text-green-500"></i></div>
                            </div>
                        </td>
                    </tr>`;
                } 
                // STAFF CARD
                else {
                    staffCount++;
                    let stripClass = 'strip-main';
                    if(p.branch === 'harash') stripClass = 'strip-harash';
                    if(p.branch === 'logistics') stripClass = 'strip-logistics';

                    const outlookLink = p.email ? `mailto:${p.email}` : null;
                    const teamsLink = p.email ? `https://teams.microsoft.com/l/chat/0/0?users=${p.email}` : null;
                    const waLink = p.phone ? `https://wa.me/972${p.phone?.replace(/^0/,'')}` : null;

                    // SPECIAL BUTTONS
                    let specialBtn = '';
                    if (p.branch === 'harash' && p.type === 'manager') {
                        specialBtn = `<button onclick="window.open('itzik-app.html', '_blank')" class="btn-app-manager"><i class="fas fa-store"></i> 住 驻拽爪转 </button>`;
                    } else if (p.type === 'driver') {
                        const driverLink = `driver-app.html?uid=${p.phone}&name=${encodeURIComponent(p.name)}`;
                        specialBtn = `<button onclick="window.open('${driverLink}', '_blank')" class="btn-app-driver"><i class="fas fa-truck"></i> 住 驻拽爪转 </button>`;
                    } else {
                        specialBtn = `<button onclick="openTaskModal('${p.id}', '${p.name}', '${p.phone}')" class="btn-task"><i class="fas fa-tasks"></i> 砖专 砖</button>`;
                    }

                    grid.innerHTML += `
                    <div class="staff-card item-row" data-name="${p.name}">
                        <div class="branch-strip ${stripClass}"></div>
                        <button class="btn-edit-absolute" onclick="openEditModal('${userJson}')"><i class="fas fa-pencil-alt"></i></button>
                        
                        <div class="card-content">
                            <div class="avatar-container">
                                <img src="${avatar}" class="user-img"><div class="status-dot"></div>
                            </div>
                            <div class="user-name">${p.name}</div>
                            <div class="user-role">${p.role || '爪转'}</div>
                            
                            <div class="text-xs text-gray-500 mt-2 flex flex-col gap-1 items-center mb-2">
                                <span><i class="fas fa-building text-gray-300"></i> ${getBranchName(p.branch)}</span>
                                <span><i class="fas fa-phone text-gray-300"></i> ${p.phone || '-'}</span>
                            </div>
                            
                            ${specialBtn}
                            
                            <div class="comm-row">
                                ${outlookLink ? `<a href="${outlookLink}" class="comm-btn comm-outlook"><i class="fas fa-envelope"></i></a>` : ''}
                                ${teamsLink ? `<a href="${teamsLink}" class="comm-btn comm-teams"><i class="fas fa-video"></i></a>` : ''}
                                ${waLink ? `<a href="${waLink}" target="_blank" class="comm-btn comm-wa"><i class="fab fa-whatsapp"></i></a>` : ''}
                            </div>
                        </div>
                    </div>`;
                }
            });

            document.getElementById('counter').innerText = `${staffCount} 砖 爪转 | ${clientCount} 拽转`;
            clientsSection.classList.toggle('hidden', clientCount === 0);
        });

        function getBranchName(b) {
            if(b==='main') return '转 6';
            if(b==='harash') return '专砖 10';
            if(b==='logistics') return '住拽';
            return '';
        }

        // --- EDIT MODAL ---
        window.openEditModal = (userData = null) => {
            const user = userData ? JSON.parse(userData) : null;
            const isEdit = !!user;

            Swal.fire({
                title: isEdit ? `注专: ${user.name}` : '住驻转  砖',
                html: `
                    <div class="text-right space-y-3">
                        <div class="flex gap-2">
                            <div class="w-2/3"><label class="text-xs font-bold text-gray-500">砖 </label><input id="swal-name" class="swal2-input w-full mx-0" value="${user?.name || ''}"></div>
                            <div class="w-1/3"><label class="text-xs font-bold text-gray-500">住</label><select id="swal-type" class="swal2-input w-full mx-0 bg-yellow-50"><option value="staff" ${user?.type==='staff'?'selected':''}>注</option><option value="client" ${user?.type==='client'?'selected':''}>拽/住驻拽</option><option value="driver" ${user?.type==='driver'?'selected':''}></option><option value="manager" ${user?.type==='manager'?'selected':''}></option><option value="admin" ${user?.type==='admin'?'selected':''}> 注专转</option></select></div>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500">转</label><input id="swal-avatar" class="swal2-input w-full mx-0 text-xs" placeholder="https://..." value="${user?.avatar || ''}"></div>
                        <div class="flex gap-2"><div class="w-1/2"><label class="text-xs font-bold text-gray-500">驻</label><input id="swal-phone" class="swal2-input w-full mx-0" value="${user?.phone || ''}"></div><div class="w-1/2"><label class="text-xs font-bold text-gray-500"></label><input id="swal-email" class="swal2-input w-full mx-0" value="${user?.email || ''}"></div></div>
                        <div class="flex gap-2"><div class="w-1/2"><label class="text-xs font-bold text-gray-500">转驻拽</label><input id="swal-role-text" class="swal2-input w-full mx-0" value="${user?.role || ''}"></div><div class="w-1/2"><label class="text-xs font-bold text-gray-500">住祝</label><select id="swal-branch" class="swal2-input w-full mx-0"><option value="main" ${user?.branch==='main'?'selected':''}>转 6</option><option value="harash" ${user?.branch==='harash'?'selected':''}>专砖 10</option><option value="logistics" ${user?.branch==='logistics'?'selected':''}>住拽</option></select></div></div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '砖专',
                confirmButtonColor: '#0f172a',
                preConfirm: () => {
                    return {
                        name: document.getElementById('swal-name').value,
                        type: document.getElementById('swal-type').value,
                        avatar: document.getElementById('swal-avatar').value,
                        phone: document.getElementById('swal-phone').value,
                        email: document.getElementById('swal-email').value,
                        role: document.getElementById('swal-role-text').value,
                        branch: document.getElementById('swal-branch').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        if (isEdit) await updateDoc(doc(db, "users", user.id), result.value);
                        else await addDoc(collection(db, "users"), { ...result.value, createdAt: serverTimestamp() });
                        Swal.fire({icon: 'success', title: '砖专!', timer: 1500, showConfirmButton: false});
                    } catch (e) { Swal.fire('砖', e.message, 'error'); }
                }
            });
        };

        // --- TASK MODAL (With Types & Chameleon) ---
        window.openTaskModal = (uid, name, phone) => {
            Swal.fire({
                title: `砖 ${name}`,
                html: `
                    <div class="text-right space-y-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500">住 砖</label>
                            <select id="task-cat" class="swal2-input w-full mx-0 text-sm">
                                <option value="client">  拽 ()</option>
                                <option value="transfer"> 注专  住驻 (转)</option>
                                <option value="supplier"> 住祝 住驻拽 (住)</option>
                                <option value="urgent"> 砖 驻 ()</option>
                            </select>
                        </div>
                        <textarea id="task-desc" class="swal2-textarea w-full mx-0" placeholder="驻专 砖 / 住专..."></textarea>
                        <input id="task-addr" class="swal2-input w-full mx-0" placeholder="转转  (Waze)">
                        <div class="flex gap-2 items-center mt-2 bg-yellow-50 p-2 rounded">
                            <input type="checkbox" id="task-approval">
                            <label for="task-approval" class="text-xs text-yellow-800 font-bold">专砖 砖专 住专</label>
                        </div>
                    </div>
                `,
                confirmButtonText: '砖专  ',
                showCancelButton: true,
                preConfirm: () => {
                    return { 
                        type: document.getElementById('task-cat').value,
                        desc: document.getElementById('task-desc').value,
                        addr: document.getElementById('task-addr').value,
                        pending: document.getElementById('task-approval').checked
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    if(!data.desc) return;
                    
                    const initialStatus = data.pending ? 'pending_approval' : 'assigned';

                    await addDoc(collection(db, "orders"), {
                        driverId: name,
                        clientName: "砖 ",
                        text: data.desc,
                        address: data.addr,
                        taskType: data.type,
                        status: initialStatus,
                        lastUpdate: serverTimestamp(),
                        createdAt: serverTimestamp()
                    });

                    const waText = `*砖 砖*\n住: ${data.type}\n驻专: ${data.desc}\n转转: ${data.addr}`;
                    window.open(`https://wa.me/972${phone.replace(/^0/,'')}?text=${encodeURIComponent(waText)}`, '_blank');
                }
            });
        };

        // --- BROADCAST ---
        window.openBroadcastModal = () => {
            Swal.fire({
                title: ' 专 专',
                input: 'textarea',
                inputPlaceholder: '注 ...',
                confirmButtonText: '砖专',
                confirmButtonColor: '#ef4444'
            }).then((res) => {
                if(res.isConfirmed && res.value) {
                    Swal.fire('砖专!', '', 'success');
                }
            });
        };

        // Filter
        window.filterGrid = () => {
            const term = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('.item-row').forEach(row => {
                const name = row.getAttribute('data-name').toLowerCase();
                row.style.display = name.includes(term) ? (row.tagName === 'TR' ? 'table-row' : 'flex') : 'none';
            });
        };

    </script>
</body>
</html>
