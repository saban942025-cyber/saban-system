<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Directory & Task Force</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; }
        
        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .page-title { font-size: 24px; font-weight: 800; color: #1e293b; display: flex; align-items: center; gap: 10px; }
        
        /* Search & Actions */
        .actions-bar { display: flex; gap: 10px; align-items: center; }
        .search-bar { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 12px; width: 250px; display: flex; align-items: center; gap: 10px; }
        
        /* Buttons */
        .btn-new { background: #0f172a; color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-new:hover { background: #1e293b; transform: translateY(-2px); }
        
        .btn-broadcast { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Employee Card */
        .staff-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; transition: 0.2s; position: relative; display: flex; flex-direction: column; }
        .staff-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: #cbd5e1; }
        
        /* Edit Button (Top Left) */
        .btn-edit-absolute { position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; z-index: 10; }
        .btn-edit-absolute:hover { background: #3b82f6; color: white; border-color: #3b82f6; }

        /* Branch Strip */
        .branch-strip { height: 6px; width: 100%; }
        .strip-main { background: #3b82f6; } 
        .strip-harash { background: #f97316; } 
        .strip-logistics { background: #22c55e; } 

        .card-content { padding: 20px; text-align: center; flex: 1; }
        
        /* Avatar */
        .avatar-container { position: relative; width: 80px; height: 80px; margin: 0 auto 10px; }
        .user-img { width: 100%; height: 100%; rounded-full; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .status-dot { position: absolute; bottom: 5px; right: 5px; width: 16px; height: 16px; background: #10b981; border: 3px solid white; border-radius: 50%; }

        /* Text */
        .user-name { font-weight: 800; font-size: 18px; color: #334155; margin-bottom: 2px; }
        .user-role { font-size: 12px; font-weight: 700; color: #64748b; background: #f1f5f9; padding: 4px 10px; border-radius: 20px; display: inline-block; margin-bottom: 15px; }
        
        /* Task Button (The Magic) */
        .btn-task { width: 100%; background: #f8fafc; border: 1px dashed #cbd5e1; color: #475569; padding: 10px; border-radius: 10px; font-weight: bold; font-size: 13px; margin-top: 10px; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-task:hover { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }

        /* Communication Row */
        .comm-row { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .comm-btn { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; }
        .comm-outlook { background: #e0f2fe; color: #0369a1; }
        .comm-wa { background: #dcfce7; color: #15803d; }
        .comm-teams { background: #f3e8ff; color: #7e22ce; }
        .comm-btn:hover { transform: scale(1.1); }

    </style>
</head>
<body>

    <div class="page-header">
        <div class="page-title">
            <i class="fas fa-users-cog text-blue-600"></i>
            <div>
                <span> 爪转 砖转</span>
                <span class="text-xs font-normal text-gray-500 block" id="counter">注 转...</span>
            </div>
        </div>
        
        <div class="actions-bar">
            <button onclick="openBroadcastModal()" class="btn-broadcast" title="砖 注 ">
                <i class="fas fa-bullhorn"></i> 专 
            </button>
            
            <div class="search-bar">
                <i class="fas fa-search text-gray-400"></i>
                <input type="text" id="search" onkeyup="filterGrid()" placeholder="驻砖 注..." class="bg-transparent border-none outline-none text-sm w-full">
            </div>
            
            <button onclick="openEditModal()" class="btn-new">
                <i class="fas fa-user-plus"></i> 注 砖
            </button>
        </div>
    </div>

    <div id="staff-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, updateDoc, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // --- 1. RENDER (REAL TIME) ---
        onSnapshot(query(collection(db, "users"), orderBy("name")), (snap) => {
            const grid = document.getElementById('staff-grid');
            grid.innerHTML = '';
            document.getElementById('counter').innerText = `住" ${snap.size} 砖 爪转 驻注`;

            snap.forEach(docSnap => {
                const p = { id: docSnap.id, ...docSnap.data() };
                
                // Styling Logic
                let stripClass = 'strip-main';
                if(p.branch === 'harash') stripClass = 'strip-harash';
                if(p.branch === 'logistics') stripClass = 'strip-logistics';

                const avatar = p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=random&color=fff`;
                const outlookLink = p.email ? `mailto:${p.email}` : null;
                const teamsLink = p.email ? `https://teams.microsoft.com/l/chat/0/0?users=${p.email}` : null;
                const waLink = p.phone ? `https://wa.me/972${p.phone.replace(/^0/,'')}` : null;

                // JSON for Edit Modal
                const userDataJson = JSON.stringify(p).replace(/"/g, '&quot;');

                grid.innerHTML += `
                <div class="staff-card group" data-name="${p.name}">
                    <div class="branch-strip ${stripClass}"></div>
                    
                    <button class="btn-edit-absolute" onclick="openEditModal('${userDataJson}')" title="注专 驻专 ">
                        <i class="fas fa-pencil-alt"></i>
                    </button>

                    <div class="card-content">
                        <div class="avatar-container">
                            <img src="${avatar}" class="user-img">
                            <div class="status-dot"></div>
                        </div>
                        
                        <div class="user-name">${p.name}</div>
                        <div class="user-role">${p.role}</div>
                        
                        <div class="text-xs text-gray-500 mt-2 flex flex-col gap-1 items-center">
                            <span><i class="fas fa-building text-gray-300"></i> ${getBranchName(p.branch)}</span>
                            <span><i class="fas fa-phone text-gray-300"></i> ${p.phone || '-'}</span>
                        </div>

                        <button onclick="openTaskModal('${p.id}', '${p.name}', '${p.phone}')" class="btn-task">
                            <i class="fas fa-tasks"></i> 砖专 砖
                        </button>

                        <div class="comm-row">
                            ${outlookLink ? `<a href="${outlookLink}" class="comm-btn comm-outlook" title="Outlook"><i class="fas fa-envelope"></i></a>` : ''}
                            ${teamsLink ? `<a href="${teamsLink}" class="comm-btn comm-teams" title="Teams"><i class="fas fa-video"></i></a>` : ''}
                            ${waLink ? `<a href="${waLink}" target="_blank" class="comm-btn comm-wa" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>` : ''}
                        </div>
                    </div>
                </div>`;
            });
        });

        // Helper
        function getBranchName(b) {
            if(b==='main') return '转 6 (专砖)';
            if(b==='harash') return '专砖 10';
            if(b==='logistics') return '住拽/';
            return '';
        }

        // --- 2. EDIT / ADD MODAL ---
        window.openEditModal = (userData = null) => {
            const user = userData ? JSON.parse(userData) : null;
            const isEdit = !!user;

            Swal.fire({
                title: isEdit ? `注专转 注: ${user.name}` : '住驻转 注 砖',
                html: `
                    <div class="text-right space-y-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500">砖 </label>
                            <input id="swal-name" class="swal2-input w-full mx-0" value="${user?.name || ''}">
                        </div>
                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500">驻</label>
                                <input id="swal-phone" class="swal2-input w-full mx-0" value="${user?.phone || ''}">
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500"> (365)</label>
                                <input id="swal-email" class="swal2-input w-full mx-0" value="${user?.email || ''}">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">转驻拽 (拽住 驻砖)</label>
                            <input id="swal-role-text" class="swal2-input w-full mx-0" value="${user?.role || ''}">
                        </div>
                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500">住祝/拽</label>
                                <select id="swal-branch" class="swal2-input w-full mx-0">
                                    <option value="main" ${user?.branch==='main'?'selected':''}>转 6</option>
                                    <option value="harash" ${user?.branch==='harash'?'selected':''}>专砖 10</option>
                                    <option value="logistics" ${user?.branch==='logistics'?'selected':''}>住拽</option>
                                </select>
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500">专转 专砖</label>
                                <select id="swal-type" class="swal2-input w-full mx-0">
                                    <option value="staff" ${user?.type==='staff'?'selected':''}>注 专</option>
                                    <option value="admin" ${user?.type==='admin'?'selected':''}> 注专转</option>
                                    <option value="driver" ${user?.type==='driver'?'selected':''}></option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '砖专 砖',
                confirmButtonColor: '#0f172a',
                preConfirm: () => {
                    return {
                        name: document.getElementById('swal-name').value,
                        phone: document.getElementById('swal-phone').value,
                        email: document.getElementById('swal-email').value,
                        role: document.getElementById('swal-role-text').value,
                        branch: document.getElementById('swal-branch').value,
                        type: document.getElementById('swal-type').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        if (isEdit) {
                            await updateDoc(doc(db, "users", user.id), result.value);
                            Swal.fire('注!', '驻专 注 砖专 爪', 'success');
                        } else {
                            await addDoc(collection(db, "users"), { ...result.value, createdAt: serverTimestamp() });
                            Swal.fire('住祝!', '注 砖 住 注专转', 'success');
                        }
                    } catch (e) { Swal.fire('砖', e.message, 'error'); }
                }
            });
        };

        // --- 3. TASK ASSIGNMENT (THE MAGIC) ---
        window.openTaskModal = (uid, name, phone) => {
            Swal.fire({
                title: `砖 ${name}`,
                html: `
                    <div class="text-right">
                        <label class="text-xs font-bold text-gray-500"> 砖?</label>
                        <textarea id="task-desc" class="swal2-textarea w-full mx-0" placeholder=": 爪注 住驻专转  祝 专..."></textarea>
                        
                        <label class="text-xs font-bold text-gray-500 mt-2">驻转</label>
                        <select id="task-priority" class="swal2-input w-full mx-0">
                            <option value="专"> 专</option>
                            <option value="祝"> 祝</option>
                            <option value="">  (专)</option>
                        </select>
                    </div>
                `,
                confirmButtonText: '砖专 砖 + 爪祝 ',
                confirmButtonColor: '#3b82f6',
                showCancelButton: true,
                preConfirm: () => {
                    return {
                        desc: document.getElementById('task-desc').value,
                        priority: document.getElementById('task-priority').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const task = result.value;
                    if(!task.desc) return;

                    // 1. Save to DB
                    await addDoc(collection(db, "tasks"), {
                        assignedTo: uid,
                        assignedToName: name,
                        description: task.desc,
                        priority: task.priority,
                        status: 'pending',
                        createdAt: serverTimestamp(),
                        createdBy: 'Manager' //  -Auth 注转
                    });

                    // 2. Open WhatsApp
                    const waText = `* 砖 砖 转 转 住*\n------------------------\n注专: ${name}\n驻转: ${task.priority}\n\n *砖:* ${task.desc}\n\n 砖专 爪注 拽.`;
                    const link = `https://wa.me/972${phone.replace(/^0/,'')}?text=${encodeURIComponent(waText)}`;
                    window.open(link, '_blank');
                }
            });
        };

        // --- 4. BROADCAST (HAREL'S MEGAPHONE) ---
        window.openBroadcastModal = () => {
            Swal.fire({
                title: ' 专  专',
                html: `
                    <p class="text-sm text-gray-500 mb-4">注  转砖  注 转驻注 转专 转驻专爪转.</p>
                    <textarea id="broadcast-msg" class="swal2-textarea" placeholder="拽  转 注/ 砖..."></textarea>
                `,
                confirmButtonText: '砖专 ',
                confirmButtonColor: '#ef4444', // Red for alert
                showCancelButton: true,
                preConfirm: () => document.getElementById('broadcast-msg').value
            }).then(async (result) => {
                if (result.isConfirmed && result.value) {
                    // Save notification to DB
                    await addDoc(collection(db, "notifications"), {
                        type: 'broadcast',
                        message: result.value,
                        sender: '专 ()',
                        createdAt: serverTimestamp(),
                        target: 'all'
                    });
                    
                    Swal.fire('砖专!', '注 砖  15 砖 爪转.', 'success');
                    //  注转 专 API 砖 砖转 爪祝 转
                }
            });
        };

        // Search Filter
        window.filterGrid = () => {
            const term = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('.staff-card').forEach(card => {
                const name = card.getAttribute('data-name').toLowerCase();
                card.style.display = name.includes(term) ? 'flex' : 'none';
            });
        };

    </script>
</body>
</html>
