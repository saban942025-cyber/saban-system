<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; padding-bottom: 80px; }
        
        /* --- Header --- */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .page-title { font-size: 24px; font-weight: 800; color: #1e293b; display: flex; align-items: center; gap: 10px; }
        .actions-bar { display: flex; gap: 10px; align-items: center; }
        .search-bar { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 12px; width: 250px; display: flex; align-items: center; gap: 10px; }
        
        /* Buttons */
        .btn-new { background: #0f172a; color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-new:hover { background: #1e293b; transform: translateY(-2px); }
        .btn-broadcast { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); }

        /* --- CARDS (STAFF) --- */
        .staff-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; transition: 0.2s; position: relative; display: flex; flex-direction: column; }
        .staff-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: #cbd5e1; }
        
        .btn-edit-absolute { position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; z-index: 10; }
        .btn-edit-absolute:hover { background: #3b82f6; color: white; border-color: #3b82f6; }

        .branch-strip { height: 6px; width: 100%; }
        .strip-main { background: #3b82f6; } 
        .strip-harash { background: #f97316; } 
        .strip-logistics { background: #22c55e; } 

        .card-content { padding: 20px; text-align: center; flex: 1; }
        .avatar-container { position: relative; width: 80px; height: 80px; margin: 0 auto 10px; }
        .user-img { width: 100%; height: 100%; rounded-full; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .status-dot { position: absolute; bottom: 5px; right: 5px; width: 16px; height: 16px; background: #10b981; border: 3px solid white; border-radius: 50%; }

        .user-name { font-weight: 800; font-size: 18px; color: #334155; margin-bottom: 2px; }
        .user-role { font-size: 12px; font-weight: 700; color: #64748b; background: #f1f5f9; padding: 4px 10px; border-radius: 20px; display: inline-block; margin-bottom: 15px; }
        
        .btn-task { width: 100%; background: #f8fafc; border: 1px dashed #cbd5e1; color: #475569; padding: 8px; border-radius: 10px; font-weight: bold; font-size: 13px; margin-top: 10px; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-task:hover { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }

        /* Itzik App Button */
        .btn-app-connect { width: 100%; background: linear-gradient(135deg, #f97316 0%, #c2410c 100%); color: white; padding: 8px; border-radius: 10px; font-weight: bold; font-size: 13px; margin-top: 10px; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(249, 115, 22, 0.2); }
        .btn-app-connect:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(249, 115, 22, 0.3); }

        .comm-row { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .comm-btn { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; }
        .comm-outlook { background: #e0f2fe; color: #0369a1; }
        .comm-wa { background: #dcfce7; color: #15803d; }
        .comm-teams { background: #f3e8ff; color: #7e22ce; }
        .comm-btn:hover { transform: scale(1.1); }

        /* --- TABLE (CLIENTS) --- */
        .section-title { font-size: 18px; font-weight: 800; color: #475569; margin: 40px 0 15px 0; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        
        .saban-table { width: 100%; background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; border-collapse: separate; border-spacing: 0; }
        .saban-table th { background: #f8fafc; color: #64748b; font-size: 12px; font-weight: 800; text-align: right; padding: 15px; border-bottom: 1px solid #e2e8f0; }
        .saban-table td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; vertical-align: middle; }
        .saban-table tr:last-child td { border-bottom: none; }
        .saban-table tr:hover { background: #f8fafc; }
        
        .table-avatar { width: 36px; height: 36px; rounded-full; object-fit: cover; border: 1px solid #e2e8f0; }
        .table-actions { display: flex; gap: 8px; }
        .btn-table-action { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #64748b; background: #f1f5f9; cursor: pointer; transition: 0.2s; }
        .btn-table-action:hover { background: #e2e8f0; color: #0f172a; }

    </style>
</head>
<body>

    <div class="page-header">
        <div class="page-title">
            <i class="fas fa-users-cog text-blue-600"></i>
            <div>
                <span> 专</span>
                <span class="text-xs font-normal text-gray-500 block" id="counter">注 转...</span>
            </div>
        </div>
        
        <div class="actions-bar">
            <button onclick="openBroadcastModal()" class="btn-broadcast">
                <i class="fas fa-bullhorn"></i> 专
            </button>
            <div class="search-bar">
                <i class="fas fa-search text-gray-400"></i>
                <input type="text" id="search" onkeyup="filterGrid()" placeholder="驻砖..." class="bg-transparent border-none outline-none text-sm w-full">
            </div>
            <button onclick="openEditModal()" class="btn-new">
                <i class="fas fa-plus"></i> 住祝
            </button>
        </div>
    </div>

    <div class="section-title"><i class="fas fa-id-badge text-blue-500"></i> 砖 爪转 </div>
    <div id="staff-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>

    <div id="clients-section" class="hidden">
        <div class="section-title"><i class="fas fa-briefcase text-orange-500"></i> 拽转 砖 拽砖专</div>
        <div class="overflow-x-auto">
            <table class="saban-table">
                <thead>
                    <tr>
                        <th width="60">转</th>
                        <th>砖</th>
                        <th>转驻拽/专</th>
                        <th>驻</th>
                        <th></th>
                        <th>住祝 砖</th>
                        <th width="120">驻注转</th>
                    </tr>
                </thead>
                <tbody id="clients-table-body"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // --- 1. SEED DATA (专砖  转拽转) ---
        const FULL_STAFF_LIST = [
            { name: "专 住", role: "\"", phone: "0505227724", email: "harel@saban94.co.il", branch: "main", type: "admin", avatar: "https://media-mrs2-2.cdn.whatsapp.net/v/t61.24694-24/425943135_310910548378865_3167279294851460849_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3QHD690LByBt92z_IAsCKeUxC5rxY0qUddugkDzSkBSqUA&oe=695B03CF&_nc_sid=5e03e0&_nc_cat=104" },
            { name: "专 住专", role: " 转驻注 (Admin)", phone: "0508860896", email: "ramims@saban94.co.il", branch: "main", type: "admin", avatar: "https://media-mrs2-2.cdn.whatsapp.net/v/t61.24694-24/490584763_1521666505466352_3860845398977059833_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3QEGGv9ElRRb2Qx1Adjclex0ahijeyYdc8W8wmVuCZ6L2A&oe=695B04A6&_nc_sid=5e03e0&_nc_cat=104" },
            { name: "", role: " 住专", phone: "0507855865", email: "yoav@saban94.co.il", branch: "main", type: "admin" },
            { name: "专", role: "转 砖专/砖专", phone: "0506662300", email: "vered@saban94.co.il", branch: "main", type: "office" },
            { name: "", role: "\" 拽转", phone: "0507855869", email: "lina@saban94.co.il", branch: "main", type: "office" },
            { name: "砖专", role: "\" 住驻拽", phone: "", email: "sharon@saban94.co.il", branch: "main", type: "office" },
            { name: "转", role: " 专砖", phone: "0548132442", email: "netanel@saban94.co.il", branch: "main", type: "manager" },
            { name: "专 (驻拽)", role: "专转 驻拽", phone: "0543071181", email: "", branch: "main", type: "staff" },
            { name: "砖专 住", role: "专转", phone: "0546569115", email: "", branch: "main", type: "staff" },
            { name: "砖注 拽", role: "专转", phone: "0547644425", email: "", branch: "main", type: "staff" },
            { name: "", role: "专转", phone: "", email: "", branch: "main", type: "staff" },
            { name: "转专", role: " 爪专 转", phone: "0523002828", email: "", branch: "main", type: "field" },
            
            // 专住 砖 爪拽
            { name: "爪拽 ", role: " 住祝 专砖", phone: "0504482285", email: "itzik@saban94.co.il", branch: "harash", type: "manager", avatar: "https://media-mrs2-2.cdn.whatsapp.net/v/t61.24694-24/138846705_247951546693089_6505800604178808158_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3QE_Teyw4quA6Pany4Hj8a0LOLkFxWWSd7r__aOsnJSAug&oe=695B1F10&_nc_sid=5e03e0&_nc_cat=105" },
            { name: "", role: "驻拽转 专砖", phone: "", email: "galya@saban94.co.il", branch: "harash", type: "office" },
            { name: "专", role: " 爪专 专砖", phone: "0509001392", email: "", branch: "harash", type: "field" },
            { name: "砖", role: "驻拽/拽", phone: "", email: "", branch: "harash", type: "field" },
            { name: "注", role: " 祝", phone: "", email: "", branch: "logistics", type: "driver" },
            { name: "转", role: " 砖转", phone: "", email: "", branch: "logistics", type: "driver" }
        ];

        // Seed Logic
        async function syncStaffDatabase() {
            const snap = await getDocs(collection(db, "users"));
            if (snap.size < FULL_STAFF_LIST.length) {
                const existingNames = new Set();
                snap.forEach(d => existingNames.add(d.data().name));
                for (const staff of FULL_STAFF_LIST) {
                    if (!existingNames.has(staff.name)) {
                        await addDoc(collection(db, "users"), { ...staff, permissions: 'view', active: true, createdAt: new Date() });
                    }
                }
            }
        }
        syncStaffDatabase();

        // --- 2. RENDER LOGIC ---
        onSnapshot(query(collection(db, "users"), orderBy("name")), (snap) => {
            const grid = document.getElementById('staff-grid');
            const tableBody = document.getElementById('clients-table-body');
            const clientsSection = document.getElementById('clients-section');
            
            grid.innerHTML = '';
            tableBody.innerHTML = '';
            
            let staffCount = 0;
            let clientCount = 0;

            snap.forEach(docSnap => {
                const p = { id: docSnap.id, ...docSnap.data() };
                const avatar = p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=random&color=fff`;
                const userJson = JSON.stringify(p).replace(/"/g, '&quot;');

                // 1. CLIENTS -> TABLE ROW
                if (p.type === 'client') {
                    clientCount++;
                    tableBody.innerHTML += `
                    <tr class="item-row" data-name="${p.name}">
                        <td><img src="${avatar}" class="table-avatar"></td>
                        <td class="font-bold text-slate-800">${p.name}</td>
                        <td class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded inline-block">${p.role}</td>
                        <td class="font-mono text-xs">${p.phone || '-'}</td>
                        <td class="text-xs text-blue-600 underline cursor-pointer">${p.email || '-'}</td>
                        <td class="text-xs">${getBranchName(p.branch)}</td>
                        <td>
                            <div class="table-actions">
                                <div class="btn-table-action" onclick="openEditModal('${userJson}')"><i class="fas fa-pencil-alt"></i></div>
                                <div class="btn-table-action" onclick="openTaskModal('${p.id}', '${p.name}', '${p.phone}')"><i class="fas fa-tasks text-blue-500"></i></div>
                                <div class="btn-table-action" onclick="window.open('https://wa.me/972${p.phone?.replace(/^0/,'')}', '_blank')"><i class="fab fa-whatsapp text-green-500"></i></div>
                            </div>
                        </td>
                    </tr>`;
                } 
                // 2. STAFF -> CARD
                else {
                    staffCount++;
                    let stripClass = 'strip-main';
                    if(p.branch === 'harash') stripClass = 'strip-harash';
                    if(p.branch === 'logistics') stripClass = 'strip-logistics';

                    const outlookLink = p.email ? `mailto:${p.email}` : null;
                    const teamsLink = p.email ? `https://teams.microsoft.com/l/chat/0/0?users=${p.email}` : null;
                    const waLink = p.phone ? `https://wa.me/972${p.phone?.replace(/^0/,'')}` : null;

                    // --- THE SPECIAL BUTTON FOR ITZIK ---
                    let appButtonHtml = '';
                    if (p.branch === 'harash' && p.type === 'manager') {
                        appButtonHtml = `
                        <button onclick="window.open('itzik-app.html', '_blank')" 
                                class="btn-app-connect">
                            <i class="fas fa-mobile-alt"></i> 住 驻拽爪转 
                        </button>`;
                    }

                    grid.innerHTML += `
                    <div class="staff-card item-row" data-name="${p.name}">
                        <div class="branch-strip ${stripClass}"></div>
                        <button class="btn-edit-absolute" onclick="openEditModal('${userJson}')"><i class="fas fa-pencil-alt"></i></button>
                        <div class="card-content">
                            <div class="avatar-container">
                                <img src="${avatar}" class="user-img"><div class="status-dot"></div>
                            </div>
                            <div class="user-name">${p.name}</div>
                            <div class="user-role">${p.role}</div>
                            <div class="text-xs text-gray-500 mt-2 flex flex-col gap-1 items-center mb-2">
                                <span><i class="fas fa-building text-gray-300"></i> ${getBranchName(p.branch)}</span>
                                <span><i class="fas fa-phone text-gray-300"></i> ${p.phone || '-'}</span>
                            </div>
                            
                            ${appButtonHtml}

                            ${!appButtonHtml ? `<button onclick="openTaskModal('${p.id}', '${p.name}', '${p.phone}')" class="btn-task"><i class="fas fa-tasks"></i> 砖专 砖</button>` : ''}
                            
                            <div class="comm-row">
                                ${outlookLink ? `<a href="${outlookLink}" class="comm-btn comm-outlook"><i class="fas fa-envelope"></i></a>` : ''}
                                ${teamsLink ? `<a href="${teamsLink}" class="comm-btn comm-teams"><i class="fas fa-video"></i></a>` : ''}
                                ${waLink ? `<a href="${waLink}" target="_blank" class="comm-btn comm-wa"><i class="fab fa-whatsapp"></i></a>` : ''}
                            </div>
                        </div>
                    </div>`;
                }
            });

            document.getElementById('counter').innerText = `${staffCount} 砖 爪转 | ${clientCount} 拽转`;
            clientsSection.classList.toggle('hidden', clientCount === 0);
        });

        function getBranchName(b) {
            if(b==='main') return '转 6';
            if(b==='harash') return '专砖 10';
            if(b==='logistics') return '住拽';
            return '';
        }

        // --- EDIT / ADD MODAL ---
        window.openEditModal = (userData = null) => {
            const user = userData ? JSON.parse(userData) : null;
            const isEdit = !!user;

            Swal.fire({
                title: isEdit ? `注专: ${user.name}` : '住驻转  砖',
                html: `
                    <div class="text-right space-y-3">
                        <div class="flex gap-2">
                            <div class="w-2/3">
                                <label class="text-xs font-bold text-gray-500">砖 </label>
                                <input id="swal-name" class="swal2-input w-full mx-0" value="${user?.name || ''}">
                            </div>
                            <div class="w-1/3">
                                <label class="text-xs font-bold text-gray-500">住</label>
                                <select id="swal-type" class="swal2-input w-full mx-0 bg-yellow-50">
                                    <option value="staff" ${user?.type==='staff'?'selected':''}>注</option>
                                    <option value="client" ${user?.type==='client'?'selected':''}>拽/住驻拽</option>
                                    <option value="driver" ${user?.type==='driver'?'selected':''}></option>
                                    <option value="manager" ${user?.type==='manager'?'selected':''}></option>
                                    <option value="admin" ${user?.type==='admin'?'selected':''}> 注专转</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-gray-500">拽 转 (驻爪)</label>
                            <input id="swal-avatar" class="swal2-input w-full mx-0 text-xs" placeholder="https://..." value="${user?.avatar || ''}">
                        </div>

                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500">驻</label>
                                <input id="swal-phone" class="swal2-input w-full mx-0" value="${user?.phone || ''}">
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500"></label>
                                <input id="swal-email" class="swal2-input w-full mx-0" value="${user?.email || ''}">
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500">转驻拽</label>
                                <input id="swal-role-text" class="swal2-input w-full mx-0" value="${user?.role || ''}">
                            </div>
                            <div class="w-1/2">
                                <label class="text-xs font-bold text-gray-500">住祝</label>
                                <select id="swal-branch" class="swal2-input w-full mx-0">
                                    <option value="main" ${user?.branch==='main'?'selected':''}>转 6</option>
                                    <option value="harash" ${user?.branch==='harash'?'selected':''}>专砖 10</option>
                                    <option value="logistics" ${user?.branch==='logistics'?'selected':''}>住拽</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '砖专',
                confirmButtonColor: '#0f172a',
                preConfirm: () => {
                    return {
                        name: document.getElementById('swal-name').value,
                        type: document.getElementById('swal-type').value,
                        avatar: document.getElementById('swal-avatar').value,
                        phone: document.getElementById('swal-phone').value,
                        email: document.getElementById('swal-email').value,
                        role: document.getElementById('swal-role-text').value,
                        branch: document.getElementById('swal-branch').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        if (isEdit) {
                            await updateDoc(doc(db, "users", user.id), result.value);
                        } else {
                            await addDoc(collection(db, "users"), { ...result.value, createdAt: serverTimestamp() });
                        }
                        Swal.fire({icon: 'success', title: '砖专!', timer: 1500, showConfirmButton: false});
                    } catch (e) { Swal.fire('砖', e.message, 'error'); }
                }
            });
        };

        // --- TASK MODAL ---
        window.openTaskModal = (uid, name, phone) => {
            Swal.fire({
                title: `砖 ${name}`,
                html: `
                    <div class="text-right">
                        <textarea id="task-desc" class="swal2-textarea w-full mx-0" placeholder=" 砖 爪注?"></textarea>
                        <select id="task-priority" class="swal2-input w-full mx-0">
                            <option value="专"> 专</option>
                            <option value="祝"> 祝</option>
                            <option value="">  (专)</option>
                        </select>
                    </div>
                `,
                confirmButtonText: '砖专 砖 + 爪祝 ',
                showCancelButton: true,
                preConfirm: () => {
                    return { desc: document.getElementById('task-desc').value, prio: document.getElementById('task-priority').value }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const task = result.value;
                    if(!task.desc) return;
                    
                    await addDoc(collection(db, "tasks"), {
                        assignedTo: uid, assignedToName: name, description: task.desc, priority: task.prio, status: 'pending', createdAt: serverTimestamp()
                    });

                    const waText = `* 砖 砖 转 转 住*\n------------------------\n注专: ${name}\n驻转: ${task.prio}\n\n *砖:* ${task.desc}\n\n 砖专 爪注 拽.`;
                    window.open(`https://wa.me/972${phone.replace(/^0/,'')}?text=${encodeURIComponent(waText)}`, '_blank');
                }
            });
        };

        // --- BROADCAST ---
        window.openBroadcastModal = () => {
            Swal.fire({
                title: ' 专 专',
                input: 'textarea',
                inputPlaceholder: '注转  / 专 ...',
                confirmButtonText: '砖专 ',
                confirmButtonColor: '#ef4444'
            }).then((res) => {
                if(res.isConfirmed && res.value) {
                    Swal.fire('砖专!', '注 砖  砖专', 'success');
                }
            });
        };

        // Filter
        window.filterGrid = () => {
            const term = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('.item-row').forEach(row => {
                const name = row.getAttribute('data-name').toLowerCase();
                row.style.display = name.includes(term) ? (row.tagName === 'TR' ? 'table-row' : 'flex') : 'none';
            });
        };

    </script>
</body>
</html>
