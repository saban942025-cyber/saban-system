<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SabanOS | 驻专 专</title>
    <link rel="icon" href="https://saban-system.onrender.com/icons/icon-192.png">
    <link rel="manifest" href="manifest-chat.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- CORE STYLES --- */
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .top-bar { 
            height: 60px; background: white; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 16px; box-shadow: 0 1px 10px rgba(0,0,0,0.05); z-index: 40; position: relative;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 18px; color: #1e293b; }
        .logo-img { width: 32px; height: 32px; border-radius: 8px; }

        /* CONTENT AREA (THE STAGE) */
        .stage { flex: 1; position: relative; overflow: hidden; background: #f1f5f9; }

        /* VIEW 1: DASHBOARD (PORTAL) */
        .dashboard-view { 
            position: absolute; inset: 0; overflow-y: auto; padding: 16px; padding-bottom: 80px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* VIEW 2: IFRAME CONTAINER (APPS) */
        .app-view {
            position: absolute; inset: 0; background: white; transform: translateX(100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 20;
        }
        .app-view.active { transform: translateX(0); }
        iframe { width: 100%; height: 100%; border: none; }

        /* STAFF CARDS */
        .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
        .staff-card { 
            background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
            display: flex; flex-direction: column; align-items: center; padding: 16px; position: relative; border: 1px solid #e2e8f0;
        }
        .staff-avatar { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 3px solid #f8fafc; margin-bottom: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .staff-name { font-weight: 700; color: #334155; font-size: 14px; text-align: center; }
        .staff-role { font-size: 11px; color: #64748b; margin-bottom: 12px; background: #f1f5f9; padding: 2px 8px; border-radius: 10px; }
        
        .card-actions { display: flex; gap: 8px; width: 100%; }
        .btn-action { flex: 1; padding: 6px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-msg { background: #dcfce7; color: #166534; }
        .btn-task { background: #eff6ff; color: #1e40af; }

        /* HAMBURGER MENU (DRAWER) */
        .drawer-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s; 
        }
        .drawer-overlay.open { opacity: 1; pointer-events: all; }
        
        .drawer-menu {
            position: absolute; top: 0; right: 0; bottom: 0; width: 280px; background: white; 
            transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: -5px 0 20px rgba(0,0,0,0.1);
        }
        .drawer-overlay.open .drawer-menu { transform: translateX(0); }

        .menu-item { 
            padding: 16px 20px; display: flex; align-items: center; gap: 15px; color: #334155; font-weight: 600; 
            border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s;
        }
        .menu-item:active { background: #f8fafc; }
        .menu-icon { width: 24px; text-align: center; color: #64748b; }

        /* BOTTOM NAVIGATION */
        .bottom-nav { 
            height: 65px; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; 
            align-items: center; z-index: 50; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #94a3b8; font-size: 10px; font-weight: 600; width: 60px; height: 100%; cursor: pointer;
        }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active { color: #2563eb; }
        .nav-item.active i { transform: translateY(-2px); }

        /* QUICK BUTTONS GRID */
        .quick-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .quick-btn { 
            background: white; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #e2e8f0; font-weight: 700; color: #475569;
            cursor: pointer;
        }
        .quick-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }

        /* UTILS */
        .badge-manager { position: absolute; top: 10px; right: 10px; color: #eab308; font-size: 12px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="logo-area" onclick="goHome()">
            <img src="https://saban-system.onrender.com/icons/icon-192.png" class="logo-img">
            <span>Saban<span class="text-blue-600">OS</span></span>
        </div>
        <button onclick="toggleDrawer()" class="text-2xl text-slate-700 p-2"><i class="fas fa-bars"></i></button>
    </div>

    <div class="stage">
        
        <div id="view-dashboard" class="dashboard-view">
            
            <h3 class="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider">驻注转 专转</h3>
            <div class="quick-grid">
                <div class="quick-btn" onclick="sendMagicLink()">
                    <div class="quick-icon bg-gradient-to-br from-green-400 to-green-600"><i class="fas fa-link"></i></div>
                    <div>拽 拽住<div class="text-[10px] font-normal opacity-70">砖  拽</div></div>
                </div>
                <div class="quick-btn" onclick="openApp('tasks')">
                    <div class="quick-icon bg-gradient-to-br from-purple-400 to-purple-600"><i class="fas fa-check-double"></i></div>
                    <div>砖转<div class="text-[10px] font-normal opacity-70"> 砖祝</div></div>
                </div>
                <div class="quick-btn" onclick="openApp('chat', 'group')">
                    <div class="quick-icon bg-gradient-to-br from-blue-400 to-blue-600"><i class="fas fa-network-wired"></i></div>
                    <div>拽爪转 住专<div class="text-[10px] font-normal opacity-70">爪' 转驻注</div></div>
                </div>
                <div class="quick-btn" onclick="openApp('drive', 'transfer')">
                    <div class="quick-icon bg-gradient-to-br from-orange-400 to-orange-600"><i class="fas fa-exchange-alt"></i></div>
                    <div>注专转<div class="text-[10px] font-normal opacity-70">住 注专</div></div>
                </div>
            </div>

            <div class="flex justify-between items-end mb-3 mt-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">爪转 </h3>
                <span class="text-xs bg-white px-2 py-1 rounded border text-slate-500" id="staff-count">...</span>
            </div>
            
            <div id="staff-grid" class="staff-grid">
                </div>
        </div>

        <div id="view-app" class="app-view">
            <iframe id="app-frame" src=""></iframe>
        </div>
    </div>

    <div id="drawer" class="drawer-overlay" onclick="if(event.target===this) toggleDrawer()">
        <div class="drawer-menu">
            <div class="p-6 bg-slate-900 text-white mb-2">
                <div class="text-xl font-bold">转驻专 专砖</div>
                <div class="text-xs text-slate-400">.住 注专转</div>
            </div>
            
            <div class="menu-item" onclick="goHome()"><i class="fas fa-home menu-icon"></i> 祝 转</div>
            <div class="menu-item" onclick="openApp('drive')"><i class="fas fa-folder menu-icon"></i> 专 住</div>
            <div class="menu-item" onclick="openApp('chat')"><i class="fas fa-comments menu-icon"></i> 专 转拽砖专转</div>
            <div class="menu-item" onclick="sendMagicLink()"><i class="fas fa-magic menu-icon"></i> 拽 拽住 拽</div>
            
            <div class="mt-auto border-t p-4">
                <div class="menu-item text-red-500" onclick="window.close()"><i class="fas fa-sign-out-alt menu-icon"></i> 爪</div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="goHome()" id="nav-home">
            <i class="fas fa-th-large"></i>
            <span>驻专</span>
        </div>
        <div class="nav-item" onclick="openApp('chat')" id="nav-chat">
            <i class="fab fa-whatsapp"></i>
            <span>爪'</span>
        </div>
        <div class="nav-item" onclick="openApp('drive')" id="nav-drive">
            <i class="fas fa-cloud"></i>
            <span>专</span>
        </div>
        <div class="nav-item" onclick="openApp('tasks')" id="nav-tasks">
            <i class="fas fa-tasks"></i>
            <span>砖转</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // --- NAVIGATION ENGINE ---
        window.goHome = () => {
            document.getElementById('view-app').classList.remove('active');
            updateNav('nav-home');
            toggleDrawer(false);
            // 拽 转 -iframe  住 专
            setTimeout(() => { if(!document.getElementById('view-app').classList.contains('active')) document.getElementById('app-frame').src = ''; }, 500);
        };

        window.openApp = (appId, param = '') => {
            let url = '';
            switch(appId) {
                case 'chat': url = 'comm-center.html'; break;
                case 'drive': url = 'documents-drive.html'; break;
                case 'tasks': url = 'yoav-app.html'; break; //  驻拽爪转 砖转 专转
            }
            
            const frame = document.getElementById('app-frame');
            // 注 专拽    转 驻拽爪 砖专 驻转
            if (!frame.src.includes(url)) {
                frame.src = url;
            }
            
            document.getElementById('view-app').classList.add('active');
            updateNav(`nav-${appId}`);
            toggleDrawer(false);
        };

        function updateNav(activeId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const el = document.getElementById(activeId);
            if(el) el.classList.add('active');
        }

        window.toggleDrawer = (forceState) => {
            const drawer = document.getElementById('drawer');
            if (forceState === false) {
                drawer.classList.remove('open');
            } else {
                drawer.classList.toggle('open');
            }
        };

        // --- MAGIC LINK ---
        window.sendMagicLink = async () => {
            const { value: phone } = await Swal.fire({
                title: '拽 拽住 ',
                text: ' 转  拽 砖转 :',
                input: 'tel',
                inputPlaceholder: '050...',
                confirmButtonText: '砖 住驻',
                confirmButtonColor: '#25d366'
            });

            if (phone) {
                //   爪专 拽 转 (砖 驻住 )
                const orderLink = `https://saban-system.onrender.com/new-order`; // 祝 转转 转转  砖
                const text = `, 砖 专!  拽砖专 爪注  转 专:\n${orderLink}\n\n专, .住 专 `;
                window.open(`https://wa.me/972${phone.replace(/^0/,'')}?text=${encodeURIComponent(text)}`, '_blank');
            }
        };

        // --- STAFF GRID RENDERER ---
        onSnapshot(query(collection(db, "users"), orderBy("name")), (snap) => {
            const grid = document.getElementById('staff-grid');
            grid.innerHTML = '';
            let count = 0;

            snap.forEach(d => {
                const u = d.data();
                if(u.type === 'client') return; //  爪 拽转
                count++;

                const avatar = u.avatar || `https://ui-avatars.com/api/?name=${u.name}&background=random`;
                const role = u.role || '爪转';
                const badge = u.role?.includes('') ? '<i class="fas fa-crown badge-manager"></i>' : '';

                // 驻注转
                const waLink = `https://wa.me/972${u.phone?.replace(/^0/,'')}`;
                
                grid.innerHTML += `
                <div class="staff-card">
                    ${badge}
                    <img src="${avatar}" class="staff-avatar">
                    <div class="staff-name">${u.name}</div>
                    <div class="staff-role">${role}</div>
                    
                    <div class="card-actions">
                        <div onclick="window.open('${waLink}', '_blank')" class="btn-action btn-msg"><i class="fab fa-whatsapp"></i></div>
                        <div onclick="sendTask('${u.name}')" class="btn-action btn-task"><i class="fas fa-tasks"></i></div>
                    </div>
                </div>`;
            });
            document.getElementById('staff-count').innerText = count;
        });

        window.sendTask = (name) => {
            Swal.fire({
                title: `砖 ${name}`,
                input: 'text',
                inputPlaceholder: ' 爪注?',
                confirmButtonText: '砖专',
                confirmButtonColor: '#2563eb'
            }).then(r => {
                if(r.value) Swal.fire('砖', '砖 注专', 'success');
            });
        };

    </script>
</body>
</html>
