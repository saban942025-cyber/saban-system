<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Directory |  驻拽</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; padding-bottom: 80px; }
        
        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .page-title { font-size: 24px; font-weight: 800; color: #1e293b; display: flex; align-items: center; gap: 10px; }
        .actions-bar { display: flex; gap: 10px; align-items: center; }
        .search-bar { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 12px; width: 250px; display: flex; align-items: center; gap: 10px; }
        
        /* Buttons */
        .btn-new { background: #0f172a; color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-broadcast { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); }

        /* Card Styles */
        .staff-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; transition: 0.2s; position: relative; display: flex; flex-direction: column; }
        .staff-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: #cbd5e1; }
        
        .branch-strip { height: 6px; width: 100%; }
        .strip-main { background: #3b82f6; } 
        .strip-harash { background: #f97316; } 
        .strip-logistics { background: #22c55e; } 

        .card-content { padding: 20px; text-align: center; flex: 1; }
        .user-img { width: 80px; height: 80px; margin: 0 auto 10px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .user-name { font-weight: 800; font-size: 18px; color: #334155; margin-bottom: 2px; }
        .user-role { font-size: 12px; font-weight: 700; color: #64748b; background: #f1f5f9; padding: 4px 10px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        
        /* Edit Icon */
        .btn-edit-absolute { position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748b; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; z-index: 10; }
        .btn-edit-absolute:hover { background: #3b82f6; color: white; border-color: #3b82f6; }

        /* --- MAGIC BUTTONS --- */
        .driver-actions { display: flex; gap: 8px; margin-top: 10px; margin-bottom: 10px; }
        
        .btn-app-driver { flex: 1; background: #2563eb; color: white; padding: 8px; border-radius: 8px; font-weight: bold; font-size: 12px; display: flex; justify-content: center; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-app-driver:hover { background: #1d4ed8; }
        
        .btn-magic-link { flex: 1; background: #10b981; color: white; padding: 8px; border-radius: 8px; font-weight: bold; font-size: 12px; display: flex; justify-content: center; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-magic-link:hover { background: #059669; }

        .btn-task { width: 100%; background: #f8fafc; border: 1px dashed #cbd5e1; color: #475569; padding: 8px; border-radius: 10px; font-weight: bold; font-size: 13px; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-task:hover { background: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }

        .btn-app-manager { width: 100%; background: linear-gradient(135deg, #f97316 0%, #c2410c 100%); color: white; padding: 8px; border-radius: 10px; font-weight: bold; font-size: 13px; margin-top: 5px; box-shadow: 0 4px 6px rgba(249, 115, 22, 0.2); }

        /* Comm Row */
        .comm-row { display: flex; justify-content: center; gap: 10px; margin-top: 10px; border-top: 1px solid #f1f5f9; padding-top: 10px; }
        .comm-btn { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.2s; background: #f1f5f9; color: #64748b; }
        .comm-btn:hover { transform: scale(1.1); background: #e2e8f0; }
        .wa-active { color: #25D366; background: #dcfce7; }

        /* Table */
        .saban-table { width: 100%; background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; border-collapse: separate; border-spacing: 0; margin-top: 20px; }
        .saban-table th { background: #f8fafc; color: #64748b; font-size: 12px; font-weight: 800; text-align: right; padding: 15px; border-bottom: 1px solid #e2e8f0; }
        .saban-table td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; vertical-align: middle; }
    </style>
</head>
<body>

    <div class="page-header">
        <div class="page-title">
            <i class="fas fa-users-cog text-blue-600"></i>
            <div>
                <span> 专</span>
                <span class="text-xs font-normal text-gray-500 block" id="counter">注 转...</span>
            </div>
        </div>
        <div class="actions-bar">
            <button onclick="openBroadcastModal()" class="btn-broadcast"><i class="fas fa-bullhorn"></i> 专</button>
            <div class="search-bar"><i class="fas fa-search text-gray-400"></i><input type="text" id="search" onkeyup="filterGrid()" placeholder="驻砖..." class="bg-transparent border-none outline-none text-sm w-full"></div>
            <button onclick="openEditModal()" class="btn-new"><i class="fas fa-plus"></i> 住祝</button>
        </div>
    </div>

    <div class="text-lg font-bold text-slate-600 mb-4 border-b pb-2">砖 爪转 </div>
    <div id="staff-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>

    <div id="clients-section" class="hidden mt-10">
        <div class="text-lg font-bold text-orange-600 mb-2 border-b pb-2">拽转 砖 拽砖专</div>
        <div class="overflow-x-auto">
            <table class="saban-table">
                <thead><tr><th width="60">转</th><th>砖</th><th>转驻拽</th><th>驻</th><th></th><th>住祝</th><th width="120">驻注转</th></tr></thead>
                <tbody id="clients-table-body"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, getDocs, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // --- 1.  转拽  (Auto-Fixer) ---
        // 驻拽爪  专爪 驻注 转 转 砖注 转 专 
        async function fixDrivers() {
            const snap = await getDocs(collection(db, "users"));
            snap.forEach(async (docSnap) => {
                const p = docSnap.data();
                if ((p.name.includes('注') || p.name.includes('转')) && p.type !== 'driver') {
                    console.log(`Fixing permissions for ${p.name}...`);
                    await updateDoc(doc(db, "users", docSnap.id), { 
                        type: 'driver',
                        branch: 'logistics' 
                    });
                }
            });
        }
        fixDrivers();

        // --- 2. RENDER LOGIC ---
        onSnapshot(query(collection(db, "users"), orderBy("name")), (snap) => {
            const grid = document.getElementById('staff-grid');
            const tableBody = document.getElementById('clients-table-body');
            const clientsSection = document.getElementById('clients-section');
            
            grid.innerHTML = '';
            tableBody.innerHTML = '';
            
            let staffCount = 0;
            let clientCount = 0;

            snap.forEach(docSnap => {
                const p = { id: docSnap.id, ...docSnap.data() };
                const avatar = p.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=random&color=fff`;
                const userJson = JSON.stringify(p).replace(/"/g, '&quot;');

                // CLIENT
                if (p.type === 'client') {
                    clientCount++;
                    tableBody.innerHTML += `
                    <tr class="item-row" data-name="${p.name}">
                        <td><img src="${avatar}" class="w-8 h-8 rounded-full"></td>
                        <td class="font-bold text-slate-800">${p.name}</td>
                        <td class="text-xs bg-gray-100 px-2 py-1 rounded inline-block">${p.role || '拽'}</td>
                        <td class="font-mono text-xs">${p.phone || '-'}</td>
                        <td class="text-xs text-blue-600 underline">${p.email || '-'}</td>
                        <td class="text-xs">${getBranchName(p.branch)}</td>
                        <td>
                            <div class="flex gap-2">
                                <button onclick="openEditModal('${userJson}')"><i class="fas fa-pencil-alt text-gray-400"></i></button>
                                <button onclick="window.open('https://wa.me/972${p.phone?.replace(/^0/,'')}', '_blank')"><i class="fab fa-whatsapp text-green-500"></i></button>
                            </div>
                        </td>
                    </tr>`;
                } 
                // STAFF & DRIVERS
                else {
                    staffCount++;
                    let stripClass = 'strip-main';
                    if(p.branch === 'harash') stripClass = 'strip-harash';
                    if(p.branch === 'logistics') stripClass = 'strip-logistics';

                    // --- MAGIC BUTTONS ---
                    let specialBtn = '';
                    
                    // 1. DRIVERS (转 注)
                    if (p.type === 'driver') {
                        // 专 转 拽抓  
                        let appFile = 'driver-app.html'; // 专专转  转/
                        if (p.name.includes('注')) appFile = 'ali-app.html'; // 拽抓  砖 注

                        const appUrl = `${window.location.origin}/${appFile}?uid=${p.phone}&name=${encodeURIComponent(p.name)}`;
                        const waText = ` ${p.name},  拽 驻拽爪转  砖:\n${appUrl}`;

                        specialBtn = `
                        <div class="driver-actions">
                            <button onclick="window.open('${appUrl}', '_blank')" class="btn-app-driver" title="驻转 砖 ">
                                <i class="fas fa-desktop"></i> 住
                            </button>
                            <button onclick="window.open('https://wa.me/972${p.phone?.replace(/^0/,'')}?text=${encodeURIComponent(waText)}', '_blank')" class="btn-magic-link" title="砖  爪祝">
                                <i class="fab fa-whatsapp"></i> 砖 拽
                            </button>
                        </div>
                        <button onclick="openTaskModal('${p.name}', '${p.phone}')" class="btn-task"><i class="fas fa-tasks"></i> 砖专 砖</button>
                        `;
                    } 
                    // 2. MANAGER (爪拽)
                    else if (p.branch === 'harash' && p.type === 'manager') {
                        specialBtn = `
                        <button onclick="window.open('itzik-app.html', '_blank')" class="btn-app-manager">
                            <i class="fas fa-store"></i> 住 驻拽爪转 
                        </button>`;
                    } 
                    // 3. OTHERS
                    else {
                        specialBtn = `
                        <button onclick="openTaskModal('${p.name}', '${p.phone}')" class="btn-task">
                            <i class="fas fa-tasks"></i> 砖专 砖
                        </button>`;
                    }

                    grid.innerHTML += `
                    <div class="staff-card item-row" data-name="${p.name}">
                        <div class="branch-strip ${stripClass}"></div>
                        <button class="btn-edit-absolute" onclick="openEditModal('${userJson}')"><i class="fas fa-pencil-alt"></i></button>
                        
                        <div class="card-content">
                            <img src="${avatar}" class="user-img">
                            <div class="user-name">${p.name}</div>
                            <div class="user-role">${p.role || '爪转'}</div>
                            <div class="text-xs text-gray-500 mt-2 mb-2"><i class="fas fa-building text-gray-300"></i> ${getBranchName(p.branch)}</div>
                            
                            ${specialBtn}
                            
                            <div class="comm-row">
                                <button class="comm-btn comm-outlook"><i class="fas fa-envelope"></i></button>
                                <button onclick="window.open('https://wa.me/972${p.phone?.replace(/^0/,'')}', '_blank')" class="comm-btn comm-wa wa-active"><i class="fab fa-whatsapp"></i></button>
                            </div>
                        </div>
                    </div>`;
                }
            });

            document.getElementById('counter').innerText = `${staffCount} 砖 爪转 | ${clientCount} 拽转`;
            clientsSection.classList.toggle('hidden', clientCount === 0);
        });

        function getBranchName(b) {
            if(b==='main') return '转 6';
            if(b==='harash') return '专砖 10';
            if(b==='logistics') return '住拽';
            return '';
        }

        // --- TASK MODAL (Same as before) ---
        window.openTaskModal = (name, phone) => {
            Swal.fire({
                title: `砖 ${name}`,
                html: `
                    <div class="text-right space-y-3">
                        <select id="task-cat" class="swal2-input w-full mx-0 text-sm"><option value="client">  ()</option><option value="transfer"> 注专 (转)</option><option value="urgent"> 祝 ()</option></select>
                        <textarea id="task-desc" class="swal2-textarea w-full mx-0" placeholder="驻专..."></textarea>
                        <input id="task-addr" class="swal2-input w-full mx-0" placeholder="转转 (Waze)">
                        <div class="flex gap-2 items-center bg-yellow-50 p-2 rounded"><input type="checkbox" id="task-approval"><label class="text-xs font-bold text-yellow-800">专砖 砖专 住专</label></div>
                    </div>
                `,
                confirmButtonText: '砖专 ',
                showCancelButton: true,
                preConfirm: () => { return { type: document.getElementById('task-cat').value, desc: document.getElementById('task-desc').value, addr: document.getElementById('task-addr').value, pending: document.getElementById('task-approval').checked } }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    const status = data.pending ? 'pending_approval' : 'assigned';
                    await addDoc(collection(db, "orders"), {
                        driverId: name, clientName: "砖 ", text: data.desc, address: data.addr, taskType: data.type,
                        status: status, lastUpdate: serverTimestamp(), createdAt: serverTimestamp()
                    });
                    
                    // 砖  爪祝
                    const waText = `*砖 砖*\n住: ${data.type}\n驻专: ${data.desc}\n转转: ${data.addr}`;
                    window.open(`https://wa.me/972${phone.replace(/^0/,'')}?text=${encodeURIComponent(waText)}`, '_blank');
                }
            });
        };

        window.openEditModal = (json) => {
            const user = json ? JSON.parse(json) : null;
            Swal.fire({
                title: user ? '注专转 驻专' : '注 砖',
                html: `<input id="e-name" class="swal2-input" value="${user?.name||''}" placeholder="砖"><input id="e-phone" class="swal2-input" value="${user?.phone||''}" placeholder="驻"><select id="e-type" class="swal2-input"><option value="staff">注</option><option value="driver"></option><option value="manager"></option><option value="client">拽</option></select>`,
                confirmButtonText: '砖专',
                preConfirm: () => { return { name: document.getElementById('e-name').value, phone: document.getElementById('e-phone').value, type: document.getElementById('e-type').value, branch: 'main' } }
            }).then(async res => {
                if(res.isConfirmed) {
                    if(user) await updateDoc(doc(db, "users", user.id), res.value);
                    else await addDoc(collection(db, "users"), res.value);
                    Swal.fire('砖专', '', 'success');
                }
            });
        };
        
        window.openBroadcastModal = () => Swal.fire('专', '注 砖 ', 'success');
        
        window.filterGrid = () => {
            const term = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('.item-row').forEach(row => row.style.display = row.getAttribute('data-name').toLowerCase().includes(term) ? (row.tagName === 'TR' ? 'table-row' : 'flex') : 'none');
        };

    </script>
</body>
</html>
