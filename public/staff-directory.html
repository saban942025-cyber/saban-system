<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול צוות</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { background: #f8fafc; font-family: 'Segoe UI', sans-serif; }</style>
</head>
<body class="p-6">

    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">אנשי צוות</h1>
            <p class="text-sm text-gray-500" id="status-line">טוען נתונים...</p>
        </div>
        <button onclick="openAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700">
            <i class="fas fa-user-plus"></i> הוסף עובד
        </button>
    </div>

    <div id="staff-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // 1. הנתונים מה-CSV לשתילה ראשונית
        const INITIAL_STAFF = [
            { name: "הראל אידלסון", role: "מנכ\"ל", phone: "0505227724", email: "harel@saban94.co.il", branch: "main", type: "admin" },
            { name: "ראמי מסארוה", role: "מנהל תפעול", phone: "0508860896", email: "ramims@saban94.co.il", branch: "main", type: "admin" },
            { name: "יואב", role: "מנהל סידור", phone: "0507855865", email: "yoav@saban94.co.il", branch: "main", type: "admin" },
            { name: "נתנאל", role: "מנהל רכש", phone: "0548132442", email: "netanel@saban94.co.il", branch: "main", type: "manager" },
            { name: "איציק זהבי", role: "מנהל סניף החרש", phone: "0504482285", email: "itzik@saban94.co.il", branch: "harash", type: "manager" },
            { name: "ורד", role: "מנהלת משרד", phone: "0506662300", email: "vered@saban94.co.il", branch: "main", type: "staff" },
            { name: "לינה", role: "הנה\"ח לקוחות", phone: "0507855869", email: "lina@saban94.co.il", branch: "main", type: "staff" },
            { name: "שרון", role: "הנה\"ח ספקים", phone: "", email: "sharon@saban94.co.il", branch: "main", type: "staff" },
            { name: "אורן", role: "מנהל חצר", phone: "0509001392", email: "", branch: "harash", type: "field" },
            { name: "עלי", role: "נהג מנוף", phone: "", email: "", branch: "logistics", type: "driver" },
            { name: "חכמת", role: "נהג משאית", phone: "", email: "", branch: "logistics", type: "driver" }
        ];

        // 2. בדיקה וטעינה
        async function checkAndSeed() {
            const snap = await getDocs(collection(db, "users"));
            if (snap.empty) {
                console.log("DB ריק, מבצע שתילה ראשונית...");
                INITIAL_STAFF.forEach(async (staff) => {
                    await addDoc(collection(db, "users"), { ...staff, createdAt: new Date() });
                });
            }
        }
        checkAndSeed();

        // 3. האזנה בזמן אמת
        onSnapshot(query(collection(db, "users"), orderBy("name")), (snap) => {
            const grid = document.getElementById('staff-grid');
            grid.innerHTML = '';
            document.getElementById('status-line').innerText = `סה"כ ${snap.size} אנשי צוות פעילים`;

            snap.forEach(doc => {
                const p = doc.data();
                const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(p.name)}&background=random`;
                const bgClass = p.type === 'admin' ? 'bg-yellow-50 border-yellow-200' : 'bg-white border-gray-200';
                
                grid.innerHTML += `
                <div class="p-4 rounded-xl border ${bgClass} shadow-sm hover:shadow-md transition">
                    <div class="flex items-center gap-3 mb-3">
                        <img src="${avatar}" class="w-12 h-12 rounded-full border">
                        <div>
                            <h3 class="font-bold text-slate-800">${p.name}</h3>
                            <span class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">${p.role}</span>
                        </div>
                    </div>
                    <div class="space-y-1 text-sm text-gray-500">
                        <div><i class="fas fa-phone w-5"></i> ${p.phone || '-'}</div>
                        <div><i class="fas fa-envelope w-5"></i> ${p.email || '-'}</div>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <a href="mailto:${p.email}" class="flex-1 bg-blue-50 text-blue-600 py-1 rounded text-center text-xs font-bold hover:bg-blue-100">Outlook</a>
                        <a href="https://wa.me/972${p.phone?.replace(/^0/,'')}" target="_blank" class="flex-1 bg-green-50 text-green-600 py-1 rounded text-center text-xs font-bold hover:bg-green-100">Whatsapp</a>
                    </div>
                </div>`;
            });
        });

        // 4. הוספת עובד (פונקציה גלובלית)
        window.openAddModal = async () => {
            const { value: formValues } = await Swal.fire({
                title: 'הוספת עובד',
                html: `
                    <input id="swal-name" class="swal2-input" placeholder="שם מלא">
                    <input id="swal-phone" class="swal2-input" placeholder="טלפון">
                    <input id="swal-email" class="swal2-input" placeholder="מייל">
                    <select id="swal-role" class="swal2-input">
                        <option value="staff">עובד כללי</option>
                        <option value="driver">נהג</option>
                        <option value="manager">מנהל</option>
                    </select>
                `,
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-name').value,
                        document.getElementById('swal-phone').value,
                        document.getElementById('swal-email').value,
                        document.getElementById('swal-role').value
                    ]
                }
            });

            if (formValues) {
                await addDoc(collection(db, "users"), {
                    name: formValues[0],
                    phone: formValues[1],
                    email: formValues[2],
                    type: formValues[3],
                    createdAt: new Date()
                });
                Swal.fire('נוסף!', '', 'success');
            }
        };
    </script>
</body>
</html>
