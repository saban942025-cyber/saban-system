<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#008069">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>驻专 拽转 | 住</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f3f4f6; font-family: sans-serif; padding-bottom: 90px; }
        .magic-card { background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.06); margin: 16px; overflow: hidden; border: 1px solid #e5e7eb; }
        .step-dot { width: 32px; height: 32px; background: #e5e7eb; border-radius: 50%; display: flex; items-center; justify-content: center; margin: 0 auto 6px; }
        .step.active .step-dot { background: #10b981; color: white; transform: scale(1.1); box-shadow: 0 0 0 3px #d1fae5; }
        .step-label { font-size: 10px; color: #9ca3af; font-weight: 700; text-align: center; }
        .step.active .step-label { color: #10b981; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 13px; max-width: 85%; margin-bottom: 5px; }
        .msg.me { background: #dcfce7; align-self: flex-start; }
        .msg.rami { background: white; border: 1px solid #e2e8f0; align-self: flex-end; }
        .msg.system { background: #eff6ff; color: #1e40af; font-size: 11px; text-align: center; align-self: center; width: 100%; border: 1px dashed #bfdbfe; }
        .bottom-tabs { position: fixed; bottom: 0; width: 100%; background: white; height: 70px; display: flex; justify-content: space-around; padding-top: 10px; border-top: 1px solid #eee; z-index: 50; }
        .tab-btn { color: #94a3b8; display: flex; flex-direction: column; items-center; font-size: 10px; font-weight: bold; }
        .tab-btn.active { color: #008069; }
    </style>
</head>
<body>
    <div class="bg-white px-5 py-4 shadow-sm sticky top-0 z-40 flex justify-between items-center">
        <h1 class="text-lg font-black text-slate-800" id="client-greeting">砖...</h1>
        <i class="fas fa-bell text-green-600 bg-green-50 p-2 rounded-full"></i>
    </div>

    <div id="view-active" class="block">
        <div id="magic-container" class="pb-4"></div>
    </div>

    <div id="view-new" class="hidden p-4">
        <h2 class="font-bold text-xl mb-4"> 砖</h2>
        <div class="bg-white p-5 rounded-2xl shadow-sm">
            <textarea id="new-items" class="w-full bg-gray-50 rounded-xl p-4 h-32 mb-4 text-sm" placeholder="驻专 ..."></textarea>
            <input type="text" id="new-address" class="w-full bg-gray-50 p-3 rounded-xl mb-4 text-sm" placeholder="转转">
            <button onclick="submitOrder()" class="w-full bg-[#008069] text-white py-4 rounded-xl font-bold shadow-lg">砖专 爪祝 </button>
        </div>
    </div>

    <div class="bottom-tabs">
        <div class="tab-btn active" onclick="switchView('active', this)"><i class="fas fa-box text-2xl"></i> 注拽</div>
        <div class="tab-btn" onclick="switchView('new', this)"><i class="fas fa-plus-circle text-3xl text-[#008069]"></i> 砖</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const params = new URLSearchParams(window.location.search);
        const CLIENT_ID = params.get('uid') || 'guest';
        const CLIENT_NAME = params.get('name') || '专';
        document.getElementById('client-greeting').innerText = `, ${CLIENT_NAME}`;

        // Live Order Listener
        onSnapshot(query(collection(db, "orders"), where("clientId", "==", CLIENT_ID), orderBy("createdAt", "desc")), snap => {
            const container = document.getElementById('magic-container');
            if(snap.empty) { container.innerHTML = '<div class="text-center mt-20 text-gray-400"> 转</div>'; return; }
            
            const d = snap.docs[0].data(); // 爪 专拽 专
            renderCard(d, container);
        });

        function renderCard(data, container) {
            const steps = { 'new': 1, 'work': 2, 'approved': 3, 'done': 4 };
            const step = steps[data.status] || 1;
            
            // Chat Loop
            const chatHtml = (data.chat || []).map(m => `
                <div class="msg ${m.sender==='system'?'system':(m.sender==='client'?'me':'rami')}">${m.text}</div>
            `).join('');

            container.innerHTML = `
            <div class="magic-card border-t-4 border-blue-500">
                <div class="bg-slate-900 text-white p-5 flex justify-between">
                    <div><div class="font-bold"> #${data.orderNum}</div><div class="text-xs opacity-70">${new Date(data.createdAt.seconds*1000).toLocaleDateString()}</div></div>
                    ${step===4 ? '<i class="fas fa-check text-green-400 text-2xl"></i>' : '<i class="fas fa-clock text-yellow-400"></i>'}
                </div>
                <div class="flex justify-between px-6 py-4 relative">
                    <div style="position:absolute;top:28px;left:40px;right:40px;height:2px;background:#f3f4f6;z-index:0"></div>
                    <div class="step ${step>=1?'active':''}"><div class="step-dot relative z-10"><i class="fas fa-file"></i></div><div class="step-label">拽</div></div>
                    <div class="step ${step>=2?'active':''}"><div class="step-dot relative z-10"><i class="fas fa-tools"></i></div><div class="step-label">拽</div></div>
                    <div class="step ${step>=3?'active':''}"><div class="step-dot relative z-10"><i class="fas fa-check"></i></div><div class="step-label"></div></div>
                    <div class="step ${step>=4?'active':''}"><div class="step-dot relative z-10"><i class="fas fa-truck"></i></div><div class="step-label">专</div></div>
                </div>
                ${data.pdfUrl ? `<div class="p-4 bg-blue-50 text-center cursor-pointer border-t border-blue-100" onclick="window.open('${data.pdfUrl}')"><i class="fas fa-file-pdf text-red-500"></i> 爪驻 住</div>` : ''}
                <div class="p-3 bg-gray-50 flex flex-col gap-1 max-h-[200px] overflow-y-auto">${chatHtml}</div>
            </div>`;
        }

        window.submitOrder = async () => {
            const items = document.getElementById('new-items').value;
            const address = document.getElementById('new-address').value;
            if(!items) return;

            await addDoc(collection(db, "orders"), {
                clientId: CLIENT_ID, clientName: CLIENT_NAME, itemsText: items, address: address,
                status: 'new', orderNum: Math.floor(1000+Math.random()*9000), 
                createdAt: serverTimestamp(), lastActive: serverTimestamp(), chat: []
            });

            document.getElementById('new-items').value = '';
            switchView('active');

            const link = `https://saban-system.onrender.com/client-smart.html?uid=${CLIENT_ID}&name=${CLIENT_NAME}`;
            const text = `* 砖 - 住*\n ${items}\n ${address}\n\n注拽: ${link}`;
            window.open(`https://wa.me/972508860896?text=${encodeURIComponent(text)}`, '_blank');
        };

        window.switchView = (v, btn) => {
            document.getElementById('view-active').style.display = v==='active'?'block':'none';
            document.getElementById('view-new').style.display = v==='new'?'block':'none';
            document.getElementById('view-history').style.display = v==='history'?'block':'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        };
        window.switchView = window.switchView; window.submitOrder = window.submitOrder;
    </script>
</body>
</html>
