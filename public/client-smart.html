<div class="px-4 pb-2 text-xs font-bold text-gray-500 flex justify-between">
    <span>צ'אט מול חמ"ל סבן</span>
    <span class="text-green-600" id="typing-indicator">● מחובר</span>
</div>

<div class="chat-box" id="chat-${id}">
    ${chatHtml.length ? chatHtml : '<div class="text-center text-gray-400 text-xs py-4">כאן רושמים בקשות לשינויים...</div>'}
</div>

${!isLocked ? `
<div class="flex gap-2 p-4 pt-0">
    <input id="msg-${id}" type="text" placeholder="כתוב כאן הודעה לראמי..." 
           class="flex-1 bg-gray-100 p-3 rounded-lg text-sm outline-none border border-transparent focus:border-green-500 transition"
           onkeydown="if(event.key === 'Enter') sendChat('${id}')">
    
    <button onclick="sendChat('${id}')" class="bg-[#008069] text-white w-12 rounded-lg flex items-center justify-center shadow-md active:scale-95 transition">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>` : ''}

<script type="module">
    // ... (Imports נשארים אותו דבר) ...

    // הפונקציה הקריטית ששולחת את ההודעה ומפעילה את הצופר אצל ראמי
    window.sendChat = async (id) => {
        const input = document.getElementById(`msg-${id}`);
        const text = input.value;
        if(!text) return;

        // נקה שדה מיד לחוויה מהירה
        input.value = '';

        // עדכון פיירבייס
        await updateDoc(doc(db, "orders", id), {
            // הוספת ההודעה למערך
            chat: arrayUnion({ sender: 'client', text: text, time: new Date().toISOString() }),
            
            // **זה הטריגר החשוב!** שינוי הסטטוס מפעיל את ה"onSnapshot" אצל ראמי
            status: 'changes_requested',
            
            // עדכון זמן כדי שההזמנה תקפוץ למעלה ברשימה
            lastUpdate: serverTimestamp() 
        });
        
        // משוב ללקוח
        const chatBox = document.getElementById(`chat-${id}`);
        chatBox.innerHTML += `<div class="msg me">${text}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    };
    
    // ... (שאר הקוד נשאר אותו דבר) ...
</script>
