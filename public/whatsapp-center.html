<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×§×‘×•×¦×ª ×”×–×× ×•×ª ×—.×¡×‘×Ÿ | ×—×"×œ</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        body { background-color: #d1d7db; font-family: -apple-system, system-ui, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 35%; min-width: 380px; background: white; border-left: 1px solid #e9edef; display: flex; flex-direction: column; z-index: 20; }
        
        /* Header */
        .sidebar-header { height: 64px; background: #f0f2f5; border-bottom: 1px solid #d1d7db; display: flex; justify-content: space-between; align-items: center; padding: 0 16px; flex-shrink: 0; }

        /* Tabs (×”×˜××‘×™× ×©×‘×™×§×©×ª) */
        .tabs { display: flex; background: white; border-bottom: 1px solid #e9edef; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 14px; text-align: center; cursor: pointer; font-weight: 600; color: #54656f; border-bottom: 3px solid transparent; transition: 0.2s; position: relative; }
        .tab-btn.active { border-color: #008069; color: #008069; background: #f0fdfa; }
        .tab-btn:hover { background: #f5f6f6; }

        /* Stories Bar */
        .stories-container { padding: 12px; display: flex; gap: 10px; overflow-x: auto; background: #fff; border-bottom: 1px solid #f0f0f0; scrollbar-width: none; flex-shrink: 0; }
        .story-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: 60px; transition: transform 0.2s; }
        .story-item:hover { transform: scale(1.05); }
        .story-ring { width: 50px; height: 50px; border-radius: 50%; padding: 2px; border: 2px solid transparent; object-fit: cover; }
        .story-name { font-size: 10px; margin-top: 4px; font-weight: bold; color: #54656f; max-width: 55px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Rings Animation */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .ring-green { border-color: #10b981; } 
        .ring-orange { border-color: #f59e0b; border-style: dashed; } 
        .ring-red { border-color: #ef4444; animation: pulse-red 1.5s infinite; }

        /* Lists */
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f5f6f6; transition: 0.1s; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }

        /* Main Chat Area */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #efeae2 url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; }
        
        /* Sticky Order Card (×”×¤×ª×§×™×ª ×”×™×¨×•×§×”) */
        #activeOrderCard { background: #fff; padding: 12px 16px; border-bottom: 1px solid #e9edef; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 15; border-left: 5px solid #10b981; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        /* Messages */
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 8px; margin: 4px 20px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); width: fit-content; font-size: 14px; }
        .msg.staff { background: #d9fdd3; align-self: flex-end; }
        .msg.user { background: white; align-self: flex-start; }
        .msg.internal { background: #fff9c4; align-self: center; width: 85%; border: 1px dashed #eab308; text-align: center; font-size: 12px; margin: 10px auto; border-radius: 6px; }

        /* Audio Toggle Button */
        .audio-btn { transition: all 0.3s; }
        .audio-off { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .audio-on { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

        /* Sticky Note */
        #stickyNote { position: absolute; top: 80px; right: 20px; width: 220px; background: #fef08a; padding: 10px; box-shadow: 4px 4px 10px rgba(0,0,0,0.2); transform: rotate(-2deg); z-index: 10; display: none; border-radius: 2px; }
        #stickyNote.visible { display: block; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="flex items-center gap-2">
                <div class="relative">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=008069&color=fff" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                    <div class="absolute bottom-0 left-0 w-3 h-3 bg-green-500 rounded-full border border-white"></div>
                </div>
                <div>
                    <div class="font-bold text-gray-800 leading-tight">×§×‘×•×¦×ª ×”×–×× ×•×ª</div>
                    <div class="text-[10px] text-gray-500">×—×"×œ ×¤×¢×™×œ</div>
                </div>
            </div>
            
            <button id="soundToggle" onclick="toggleSound()" class="audio-btn audio-off px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm">
                <i class="fas fa-volume-mute" id="soundIcon"></i> <span id="soundText">×”×¤×¢×œ ×›×¨×™×–×”</span>
            </button>
        </div>

        <div class="tabs">
            <div onclick="switchTab('chats')" class="tab-btn active" id="tab-chats">ğŸ“¦ ×”×–×× ×•×ª</div>
            <div onclick="switchTab('saban')" class="tab-btn relative" id="tab-saban">
                ğŸ§  ×¦'××˜-×¡×‘×Ÿ
                <span id="sabanAlert" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-ping"></span>
            </div>
        </div>

        <div class="stories-container" id="storiesBar">
            <div class="text-xs text-gray-400 text-center w-full py-2">×˜×•×¢×Ÿ ×¡×˜×˜×•×¡×™×...</div>
        </div>

        <div id="chatsList" class="chat-list custom-scroll"></div>
        <div id="sabanList" class="chat-list hidden custom-scroll"></div> </div>

    <div id="chatArea" class="main-chat hidden">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4 shadow-sm z-20 flex-shrink-0">
            <div class="flex items-center gap-3">
                <img id="activeAvatar" src="" class="w-10 h-10 rounded-full border bg-white shadow-sm object-cover">
                <div>
                    <div id="activeName" class="font-bold text-gray-800"></div>
                    <div id="activeStatus" class="text-xs text-green-600 font-bold">××—×•×‘×¨</div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="promptLinkOrder()" class="bg-orange-50 text-orange-700 px-3 py-1.5 rounded-lg text-xs font-bold border border-orange-200 hover:bg-orange-100 transition shadow-sm flex items-center gap-2">
                    <i class="fas fa-link"></i> ×§×©×•×¨ ×”×–×× ×”
                </button>
                <button onclick="toggleSticky()" class="text-yellow-600 hover:text-yellow-700 bg-yellow-50 p-2 rounded-lg border border-yellow-200 shadow-sm transition">
                    <i class="fas fa-sticky-note"></i>
                </button>
            </div>
        </div>

        <div id="activeOrderCard" class="hidden">
            <div class="flex items-center gap-3">
                <div class="bg-green-100 text-green-700 p-2 rounded-full border border-green-200"><i class="fas fa-box-open"></i></div>
                <div>
                    <div class="text-sm font-bold text-gray-800" id="orderTitle">×”×–×× ×” ×¤×¢×™×œ×”</div>
                    <div class="text-xs text-gray-500" id="orderStatus">×‘×˜×™×¤×•×œ</div>
                </div>
            </div>
            <button id="btnArchive" onclick="archiveOrder(this.getAttribute('data-id'))" class="bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-green-700 transition flex items-center gap-2">
                <i class="fas fa-check-circle"></i> ×¡×•×¤×§ ×•××¨×›×‘
            </button>
        </div>

        <div id="stickyNote">
            <div class="flex justify-between mb-1 border-b border-yellow-300/50 pb-1">
                <span class="font-bold text-xs text-yellow-900">ğŸ“Œ ×¤×ª×§ ×¤× ×™××™</span>
                <i class="fas fa-times cursor-pointer hover:text-red-500" onclick="toggleSticky()"></i>
            </div>
            <textarea class="w-full bg-transparent outline-none text-sm resize-none text-gray-800 h-24" placeholder="×”×¢×¨×•×ª ×œ×¦×•×•×ª..."></textarea>
        </div>

        <div id="messagesBox" class="flex-1 overflow-y-auto flex flex-col p-4 pb-2"></div>

        <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t z-20 flex-shrink-0">
            <i onclick="toggleInternal()" id="internalBtn" class="fas fa-eye-slash text-gray-400 cursor-pointer text-xl p-2 hover:text-orange-500 transition" title="××¦×‘ ×”×¢×¨×” ×¤× ×™××™×ª"></i>
            <input type="text" id="msgInput" class="flex-1 p-3 rounded-lg border-none outline-none shadow-sm focus:ring-2 focus:ring-green-500 transition" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="text-[#008069] text-2xl hover:scale-110 transition p-2"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanSounds } from './js/sounds.js';

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        let app, db;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch(e) { console.error("Firebase Error", e); }

        let activeChatId = null;
        let internalMode = false;
        window.audioEnabled = false;

        // --- Audio Logic ---
        window.toggleSound = () => {
            const btn = document.getElementById('soundToggle');
            if (!window.audioEnabled) {
                const a = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAGZGF0YQQAAAAAAA==");
                a.play().then(() => {
                    window.audioEnabled = true;
                    btn.className = "audio-btn audio-on px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm";
                    btn.innerHTML = '<i class="fas fa-volume-up"></i> <span>×›×¨×™×–×” ×¤×¢×™×œ×”</span>';
                    SabanSounds.playMessage();
                });
            } else {
                window.audioEnabled = false;
                btn.className = "audio-btn audio-off px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm";
                btn.innerHTML = '<i class="fas fa-volume-mute"></i> <span>××•×©×ª×§</span>';
            }
        };
        window.unlockAudio = () => { if (!window.audioEnabled) window.toggleSound(); };

        // --- Tabs Logic ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'chats') {
                document.getElementById('chatsList').classList.remove('hidden');
                document.getElementById('sabanList').classList.add('hidden');
            } else if (tabName === 'saban') {
                document.getElementById('chatsList').classList.add('hidden');
                document.getElementById('sabanList').classList.remove('hidden');
                document.getElementById('sabanAlert').classList.add('hidden'); // ×›×™×‘×•×™ ×”×ª×¨××”
            }
        };

        // --- Listeners ---
        try {
            // 1. ×”×–×× ×•×ª ×¨×’×™×œ×•×ª
            onSnapshot(query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc")), (snap) => {
                const list = document.getElementById('chatsList'); 
                const stories = document.getElementById('storiesBar');
                list.innerHTML = ""; stories.innerHTML = "";
                
                snap.forEach(d => {
                    const c = d.data();
                    const lastMsg = c.lastMessage || "";
                    let ring = "ring-green";
                    
                    if (lastMsg.includes("×××ª×™×Ÿ")) ring = "ring-orange";
                    if (lastMsg.includes("ğŸ›‘") || lastMsg.includes("×“×—×•×£")) { 
                        ring = "ring-red"; 
                        if (window.audioEnabled) SabanSounds.playAlert(); 
                    } else if (c.role === 'user' && !c.lastMsgFromStaff && window.audioEnabled) {
                        SabanSounds.playMessage();
                    }

                    const avatar = c.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(c.userName)}`;
                    
                    const itemHtml = `
                    <div onclick="openChat('${d.id}', '${c.userName}', '${avatar}', 'orders')" class="chat-item ${activeChatId===d.id?'active':''}">
                        <div class="relative"><img src="${avatar}" class="w-10 h-10 rounded-full ${ring} story-ring object-cover p-0.5"></div>
                        <div class="flex-1 mr-3 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-sm text-gray-800 truncate">${c.userName}</span>
                                <span class="text-[10px] text-gray-400">${c.lastActivity ? new Date(c.lastActivity.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                            </div>
                            <div class="text-xs text-gray-500 truncate">${lastMsg}</div>
                        </div>
                    </div>`;
                    
                    list.innerHTML += itemHtml;
                    stories.innerHTML += `<div class="story-item" onclick="openChat('${d.id}', '${c.userName}', '${avatar}', 'orders')"><img src="${avatar}" class="story-ring ${ring}"><span class="story-name">${c.userName}</span></div>`;
                });
            });

            // 2. ×¦'××˜ ×¡×‘×Ÿ (×”×ª×™×™×¢×¦×•×ª)
            onSnapshot(query(collection(db, "saban_chats_meta"), orderBy("lastActivity", "desc")), (snap) => {
                const list = document.getElementById('sabanList');
                list.innerHTML = "";
                if(!snap.empty) document.getElementById('sabanAlert').classList.remove('hidden'); // ×”×ª×¨××” ×‘×˜××‘

                snap.forEach(d => {
                    const c = d.data();
                    list.innerHTML += `
                    <div onclick="openChat('${d.id}', '${c.userName}', '${c.avatar}', 'saban')" class="chat-item ${activeChatId===d.id?'active':''}">
                        <div class="relative"><img src="${c.avatar}" class="w-10 h-10 rounded-full ring-2 ring-indigo-500 p-0.5"></div>
                        <div class="flex-1 mr-3">
                            <div class="font-bold text-sm text-indigo-900">${c.userName}</div>
                            <div class="text-xs text-gray-500 truncate">ğŸ’¬ ${c.lastMessage}</div>
                        </div>
                    </div>`;
                });
            });

        } catch(e) { console.error("Snapshot Error:", e); }

        // --- Open Chat Logic ---
        window.openChat = async (id, name, img, type = 'orders') => {
            activeChatId = id;
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('activeName').innerText = name;
            document.getElementById('activeAvatar').src = img;
            
            // ××™×¤×•×¡ ×›×¨×˜×™×¡ ×”×–×× ×”
            const orderCard = document.getElementById('activeOrderCard');
            orderCard.classList.add('hidden');
            
            // ×‘×“×™×§×ª ×”×–×× ×” ×¤×¢×™×œ×” (×¨×§ ×‘×¦'××˜ ×”×–×× ×•×ª)
            if (type === 'orders') {
                const q = query(collection(db, "active_orders"), where("clientUid", "==", id), where("status", "!=", "archived"));
                const orderSnap = await getDocs(q);
                if (!orderSnap.empty) {
                    const o = orderSnap.docs[0].data();
                    const oid = orderSnap.docs[0].id;
                    document.getElementById('orderTitle').innerText = `×”×–×× ×” #${oid}`;
                    document.getElementById('orderStatus').innerText = o.status === 'waiting' ? 'â³ ×××ª×™×Ÿ ×œ××¡××š' : 'ğŸšš ×‘×˜×™×¤×•×œ';
                    
                    // *** ×”×ª×™×§×•×Ÿ ×”×§×¨×™×˜×™: ×”×¦××“×ª ×”-ID ×œ×›×¤×ª×•×¨ ***
                    const btn = document.getElementById('btnArchive');
                    btn.setAttribute('data-id', oid); 
                    
                    orderCard.classList.remove('hidden');
                }
            }

            // ×˜×¢×™× ×ª ×”×•×“×¢×•×ª (×œ×¤×™ ×¡×•×’ ×”××•×¡×£)
            const collName = type === 'saban' ? `saban_chats/${id}/messages` : `chat_sessions/${id}/messages`;
            
            onSnapshot(query(collection(db, collName), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('messagesBox');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    let cls = m.role==='staff' ? 'msg staff' : 'msg user';
                    if(m.role==='internal') cls = 'msg internal';
                    
                    return `<div class="${cls}">
                        ${m.role==='internal'?'<div class="text-[10px] text-orange-600 font-bold mb-1">ğŸ”’ ×¤×ª×§ ×¤× ×™××™</div>':''}
                        ${m.text}
                        <div class="text-[9px] text-gray-400 mt-1 opacity-60 text-left">${m.createdAt ? new Date(m.createdAt.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</div>
                    </div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMessage = async () => {
            const txt = document.getElementById('msgInput').value; if(!txt || !activeChatId) return;
            document.getElementById('msgInput').value = '';
            
            // ×‘×“×™×§×” ×‘××™×–×” ×˜××‘ ×× ×—× ×• (×›×“×™ ×œ×“×¢×ª ×œ××Ÿ ×œ×©×œ×•×—)
            const isSaban = document.getElementById('tab-saban').classList.contains('active');
            const collName = isSaban ? `saban_chats` : `chat_sessions`; // ×©×™× ×œ×‘: ×‘××•×¡×£ ×”×¨××©×™, ×œ× ×‘×ª×ª-××•×¡×£ ×”×•×“×¢×•×ª ×¢×“×™×™×Ÿ

            // ×©×œ×™×—×ª ×”×”×•×“×¢×”
            await addDoc(collection(db, `${collName}/${activeChatId}/messages`), { 
                text: txt, role: internalMode ? 'internal' : 'staff', sender: "×—×\"×œ", createdAt: serverTimestamp() 
            });
            
            if(!internalMode) {
                // ×¢×“×›×•×Ÿ ××˜×-×“××˜×” (×”×•×“×¢×” ××—×¨×•× ×”)
                const metaColl = isSaban ? 'saban_chats_meta' : 'chat_sessions';
                // ×›××Ÿ ×× ×—× ×• ×× ×™×—×™× ×©××¡××š ×”××˜× ×§×™×™×. ×× ×–×” ×¦'××˜ ×¡×‘×Ÿ ×—×“×© ××•×œ×™ ×¦×¨×™×š ×œ×™×¦×•×¨ ××•×ª×•, ××‘×œ ×œ×¨×•×‘ ×”×•× × ×•×¦×¨ ×¢"×™ ×”×œ×§×•×—.
                // × ×©×ª××© ×‘-setDoc ×¢× merge ×œ×™×ª×¨ ×‘×™×˜×—×•×Ÿ
                await setDoc(doc(db, metaColl, activeChatId), { 
                    lastMessage: `× ×¦×™×’: ${txt}`, 
                    lastActivity: serverTimestamp(), 
                    lastMsgFromStaff: true 
                }, { merge: true });
            }
            
            if(internalMode) window.toggleInternal();
        };

        // --- Archive Order (Fixed) ---
        window.archiveOrder = async (orderId) => {
            if(!orderId) { alert("×©×’×™××”: ××¡×¤×¨ ×”×–×× ×” ×œ× × ××¦×"); return; }
            if(!confirm(`×”×× ×œ××¨×›×‘ ××ª ×”×–×× ×” ${orderId}?`)) return;
            
            // 1. ×§×¨×™××ª ×”×”×–×× ×”
            const orderRef = doc(db, "active_orders", orderId);
            const orderSnap = await getDoc(orderRef);
            if (!orderSnap.exists()) return;
            
            // 2. ×”×¢×‘×¨×” ×œ××¨×›×™×•×Ÿ
            await addDoc(collection(db, "orders_archive"), { ...orderSnap.data(), id: orderId, archivedAt: serverTimestamp() });
            
            // 3. ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
            await updateDoc(orderRef, { status: "archived" });
            
            // 4. ×”×•×“×¢×” ×‘×¦'××˜
            await addDoc(collection(db, `chat_sessions/${activeChatId}/messages`), { 
                text: `âœ… ×”×–×× ×” ${orderId} ×¡×•×¤×§×” ×•××•×¨×›×‘×”.`, role: 'internal', createdAt: serverTimestamp() 
            });

            document.getElementById('activeOrderCard').classList.add('hidden');
            if(window.audioEnabled) SabanSounds.playMessage();
        };

        // --- UI Utils ---
        window.toggleInternal = () => { 
            internalMode=!internalMode; 
            const inp = document.getElementById('msgInput');
            const btn = document.getElementById('internalBtn');
            if(internalMode) {
                inp.placeholder = "×”×¢×¨×” ×¤× ×™××™×ª (××•×¡×ª×¨ ××”×œ×§×•×—)...";
                inp.classList.add('bg-yellow-50');
                btn.className = "fas fa-eye-slash text-orange-500 text-xl p-2";
            } else {
                inp.placeholder = "×”×§×œ×“ ×”×•×“×¢×”...";
                inp.classList.remove('bg-yellow-50');
                btn.className = "fas fa-eye text-gray-400 text-xl p-2";
            }
        };

        window.toggleSticky = () => {
            const sn = document.getElementById('stickyNote');
            sn.classList.toggle('visible');
        };

        window.promptLinkOrder = async () => {
            const id = prompt("×”×–×Ÿ ××¡×¤×¨ ×”×–×× ×” ××§×•××§×¡:");
            if(!id) return;
            await setDoc(doc(db, "active_orders", id), { clientUid: activeChatId, clientName: document.getElementById('activeName').innerText, status: "waiting", createdAt: serverTimestamp() });
            await addDoc(collection(db, `chat_sessions/${activeChatId}/messages`), { text: `â³ ×××ª×™×Ÿ ×œ××¡××š ×”×–×× ×” <b>${id}</b>...`, role: 'internal', createdAt: serverTimestamp() });
            updateDoc(doc(db, "chat_sessions", activeChatId), { lastMessage: `×××ª×™×Ÿ ×œ××¡××š ${id}`, lastActivity: serverTimestamp() });
            
            // ×¨×¢× ×•×Ÿ ×›×“×™ ×œ×”×¦×™×’ ××ª ×”×›×¨×˜×™×¡
            openChat(activeChatId, document.getElementById('activeName').innerText, document.getElementById('activeAvatar').src);
        };

    </script>
</body>
</html>
