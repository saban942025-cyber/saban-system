<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Command | ×—×"×œ ×œ×•×’×™×¡×˜×™</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/733/733585.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <style>
        :root { --wa-bg: #efeae2; --wa-green: #00a884; --task-blue: #0ea5e9; }
        body { margin: 0; padding: 0; background: #d1d7db; height: 100dvh; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        
        .app-container { display: flex; width: 100%; height: 100%; max-width: 1920px; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.15); position: relative; }
        .sidebar { width: 420px; min-width: 350px; display: flex; flex-direction: column; border-left: 1px solid #e9edef; background: white; z-index: 20; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--wa-bg); background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; min-width: 0; }

        /* --- 3 Tabs System --- */
        .tabs { display: flex; background: white; border-bottom: 1px solid #e9edef; padding: 0 5px; }
        .tab { flex: 1; text-align: center; padding: 14px 0; cursor: pointer; color: #54656f; font-weight: 600; border-bottom: 3px solid transparent; transition: 0.2s; position: relative; font-size: 13px; }
        .tab:hover { background: #f5f6f6; }
        .tab.active { color: var(--wa-green); border-bottom-color: var(--wa-green); }
        /* ×¦×‘×¢ ×©×•× ×” ×œ×˜××‘ ×”×¢×‘×¨×•×ª ×›×“×™ ×œ×‘×œ×•×˜ */
        .tab.transfer-tab.active { color: var(--task-blue); border-bottom-color: var(--task-blue); }
        
        .badge { position: absolute; top: 8px; left: 20%; background: #25d366; color: white; font-size: 10px; padding: 0 5px; border-radius: 10px; min-width: 16px; display: none; }
        .badge.show { display: flex; align-items: center; justify-content: center; }

        /* Chat List Items */
        .chat-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f5f6f6; transition: 0.2s; background: white; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid var(--wa-green); }
        
        /* ×¢×™×¦×•×‘ ××™×•×—×“ ×œ××©×™××•×ª ×”×¢×‘×¨×” */
        .chat-item.task-item { background: #f0f9ff; }
        .chat-item.task-item.active { border-right: 4px solid var(--task-blue); background: #e0f2fe; }
        .task-icon { width: 45px; height: 45px; background: #bae6fd; color: #0369a1; border-radius: 50%; display: flex; items-center; justify-content: center; margin-left: 12px; font-size: 18px; }
        .avatar { width: 45px; height: 45px; rounded: 50%; object-fit: cover; border: 1px solid #e9edef; margin-left: 12px; }

        /* --- Cards & Messages --- */
        .order-card { background: white; border-radius: 8px; overflow: hidden; width: 320px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 5px; border: 1px solid #e5e7eb; }
        .order-head { background: linear-gradient(to left, #f0fdf4, white); padding: 10px; border-bottom: 1px solid #dcfce7; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #166534; }
        .order-body { padding: 15px; font-family: monospace; white-space: pre-wrap; font-size: 13px; background: #fafafa; color: #333; }
        .order-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: #e5e7eb; border-top: 1px solid #e5e7eb; }
        .action-btn { background: white; padding: 10px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: 0.2s; color: #4b5563; }
        .action-btn:hover { background: #f9fafb; color: #111827; }

        /* Transfer Card (Blue) */
        .transfer-card { background: white; border-radius: 8px; overflow: hidden; width: 320px; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #bae6fd; }
        .transfer-head { background: linear-gradient(to left, #e0f2fe, white); padding: 10px; border-bottom: 1px solid #bae6fd; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #0369a1; }
        
        .msg-bubble { max-width: 70%; padding: 8px 10px; border-radius: 8px; font-size: 14px; margin-bottom: 6px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); position: relative; }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-internal { background: #fff7ed !important; border: 1px dashed #fdba74; }

        /* Modals */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 450px; border-radius: 12px; overflow: hidden; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; rounded: 8px; background: #f8fafc; margin-bottom: 10px; outline: none; }
        
        /* Pending Bar */
        .pending-bar { position: absolute; top: 60px; left: 0; width: 100%; background: #fff7ed; border-bottom: 2px solid #fdba74; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 15; }
        
        .info-panel { width: 0; background: #f7f8fa; border-right: 1px solid #e9edef; transition: width 0.3s ease; overflow: hidden; display: flex; flex-direction: column; }
        .info-panel.open { width: 380px; }
    </style>
</head>
<body>

    <div id="taskModal" class="modal-wrap">
        <div class="modal-box">
            <div class="p-4 border-b bg-blue-50 flex justify-between items-center">
                <h3 class="font-bold text-blue-800"><i class="fas fa-truck-loading"></i> ×™×¦×™×¨×ª ×”×¢×‘×¨×”/××©×™××”</h3>
                <button onclick="document.getElementById('taskModal').style.display='none'"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="p-4">
                <label class="text-xs font-bold text-gray-500 mb-1 block">×¡×•×’ ×¤×¢×•×œ×”</label>
                <select id="taskType" class="form-input">
                    <option value="transfer">ğŸ”„ ×”×¢×‘×¨×” ×‘×™×Ÿ ×¡× ×™×¤×™×</option>
                    <option value="pickup">ğŸ“¦ ××™×¡×•×£ ××¡×¤×§</option>
                    <option value="urgent">ğŸš¨ ×”×§×¤×¦×” ×“×—×•×¤×”</option>
                </select>
                <textarea id="taskDesc" class="form-input h-24" placeholder="×¤×™×¨×•×˜: ×××™×¤×”, ×œ××Ÿ, ××” ×œ×”×¢×‘×™×¨..."></textarea>
                <button onclick="window.submitTask()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold shadow hover:bg-blue-700">×©×’×¨ ×œ×‘×™×¦×•×¢ ğŸš€</button>
            </div>
        </div>
    </div>

    <div id="docSelectModal" class="modal-wrap">
        <div class="modal-box">
            <div class="p-4 border-b bg-gray-50 flex justify-between">
                <h3 class="font-bold">××¡××›×™× (Comax)</h3>
                <button onclick="document.getElementById('docSelectModal').style.display='none'"><i class="fas fa-times"></i></button>
            </div>
            <div id="docsList" class="flex-1 overflow-y-auto p-0 max-h-[400px]"></div>
        </div>
    </div>

    <div class="app-container">
        
        <div class="sidebar">
            <div class="h-[60px] bg-[#f0f2f5] p-3 flex justify-between items-center border-b flex-shrink-0">
                <div class="flex items-center gap-3">
                    <img id="myAvatar" src="" class="w-10 h-10 rounded-full border">
                    <span id="myName" class="font-bold text-gray-700">...</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('taskModal').style.display='flex'" class="w-10 h-10 rounded-full bg-blue-50 border border-blue-200 text-blue-600 hover:bg-blue-100" title="×”×¢×‘×¨×” ×—×“×©×”"><i class="fas fa-plus"></i></button>
                    <button onclick="window.openDocSelector()" class="w-10 h-10 rounded-full bg-white border hover:text-blue-600" title="××¡××›×™×"><i class="fas fa-file-import"></i></button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="window.switchTab('all')" id="tab-all">
                    ×”×›×œ
                </div>
                <div class="tab" onclick="window.switchTab('orders')" id="tab-orders">
                    ×”×–×× ×•×ª
                    <span id="badge-orders" class="badge">0</span>
                </div>
                <div class="tab transfer-tab" onclick="window.switchTab('transfers')" id="tab-transfers">
                    ×”×¢×‘×¨×•×ª
                    <span id="badge-transfers" class="badge bg-blue-500">0</span>
                </div>
            </div>

            <div class="p-2 border-b bg-white flex-shrink-0">
                <div class="bg-[#f0f2f5] rounded-lg flex items-center px-3 h-9">
                    <i class="fas fa-search text-gray-400 text-xs ml-2"></i>
                    <input type="text" placeholder="×—×™×¤×•×©..." class="bg-transparent border-none outline-none text-sm w-full">
                </div>
            </div>

            <div id="chat-list" class="flex-1 overflow-y-auto custom-scroll"></div>
        </div>

        <div class="chat-area">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400 select-none">
                <i class="fas fa-boxes text-6xl mb-4 opacity-20"></i>
                <h2 class="text-xl font-light">××¨×›×– ×œ×•×’×™×¡×˜×™ - ×¡×‘×Ÿ</h2>
            </div>

            <div id="active-chat" class="hidden flex flex-col h-full relative">
                <div class="h-[60px] bg-[#f0f2f5] p-3 flex items-center justify-between border-b shadow-sm z-20 cursor-pointer" onclick="window.toggleInfoPanel()">
                    <div class="flex items-center gap-3">
                        <img id="chatAvatar" src="" class="w-10 h-10 rounded-full border bg-white object-cover">
                        <div>
                            <span id="chatTitle" class="font-bold text-gray-800 block text-sm"></span>
                            <span id="chatSub" class="text-xs text-gray-500"></span>
                        </div>
                    </div>
                    <i class="fas fa-ellipsis-v text-gray-400 px-2"></i>
                </div>

                <div id="pendingDocBar" class="pending-bar hidden">
                    <div class="flex items-center gap-2 text-orange-900">
                        <i class="fas fa-file-import animate-bounce"></i> <span class="font-bold text-sm" id="pendingDocName">...</span>
                    </div>
                    <button onclick="window.attachDocToChat()" class="bg-orange-500 text-white px-3 py-1 rounded text-xs font-bold">×©×™×™×š</button>
                </div>

                <div id="messages-area" class="flex-1 overflow-y-auto p-5 flex flex-col gap-1 custom-scroll"></div>

                <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t z-20">
                    <button id="ghostBtn" onclick="window.toggleGhostMode()" class="w-10 h-10 text-gray-500 hover:bg-gray-200 rounded-full transition" title="×¢×™×Ÿ (×¤× ×™××™)"><i class="fas fa-eye-slash text-lg"></i></button>
                    <input id="msgInput" type="text" class="flex-1 bg-white rounded-xl h-10 px-4 text-sm border-none outline-none shadow-sm" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') window.sendMessage()">
                    <button onclick="window.sendMessage()" class="w-10 h-10 rounded-full bg-[#00a884] text-white shadow"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="info-panel" class="info-panel">
            <div class="h-[60px] flex items-center px-4 border-b bg-white justify-between">
                <span class="font-bold text-gray-700">×ª×™×§ ×œ×§×•×—</span>
                <button onclick="window.toggleInfoPanel()"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="p-6 text-center overflow-y-auto bg-[#f7f8fa] flex-1">
                <img id="crmAvatar" class="w-24 h-24 rounded-full mx-auto mb-3 shadow border-4 border-white object-cover">
                <h3 id="crmName" class="font-bold text-xl text-gray-800"></h3>
                <div class="mt-2"><span id="crmNum" class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full font-mono font-bold"></span></div>
                <div class="mt-8 border-t pt-4 text-right">
                    <div class="text-xs font-bold text-gray-400 uppercase mb-3">×”×™×¡×˜×•×¨×™×”</div>
                    <div id="crmHistoryList" class="flex flex-col gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanSounds } from './js/sounds.js';

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        // Init
        const urlUid = new URLSearchParams(window.location.search).get('uid');
        let currentUser = JSON.parse(localStorage.getItem('saban_user')) || { name: '××•×§×“×Ÿ' };
        if(urlUid) getDoc(doc(db, "users", urlUid)).then(s => { if(s.exists()){ currentUser=s.data(); localStorage.setItem('saban_user',JSON.stringify(currentUser)); document.getElementById('myName').innerText=currentUser.name; }});
        else document.getElementById('myName').innerText=currentUser.name;

        let currentChatId = null, currentFilter = 'all', pendingDoc = null, chatsCache = [];

        // --- 1. Task Creation (Transfers) ---
        window.submitTask = async () => {
            const type = document.getElementById('taskType').value;
            const desc = document.getElementById('taskDesc').value;
            if(!desc) return;

            const typeMap = { 'transfer': '×”×¢×‘×¨×”', 'pickup': '××™×¡×•×£', 'urgent': '×“×—×•×£' };
            const docRef = await addDoc(collection(db, "orders"), {
                clientName: `××©×™××”: ${typeMap[type]}`,
                isTask: true, // ×“×’×œ ××–×”×”
                taskType: type,
                status: 'new',
                lastActive: serverTimestamp(),
                chat: []
            });

            await addDoc(collection(db, `orders/${docRef.id}/internal_chat`), {
                text: desc, sender: currentUser.name, type: 'task_desc', createdAt: serverTimestamp(), isVisibleToClient: false
            });

            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('taskDesc').value = '';
        };

        // --- 2. List Logic & Filtering (Corrected) ---
        onSnapshot(query(collection(db, "orders"), orderBy("lastActive", "desc")), (snap) => {
            chatsCache = [];
            snap.forEach(d => chatsCache.push({ id: d.id, ...d.data() }));
            renderList();
        });

        function renderList() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            
            let ordersCount = 0;
            let transfersCount = 0;

            chatsCache.forEach(o => {
                // Counters
                if (!o.isTask && o.status === 'new') ordersCount++;
                if (o.isTask && o.status === 'new') transfersCount++;

                // Filter Logic
                if (currentFilter === 'orders' && o.isTask) return; // ×”×¡×ª×¨ ××©×™××•×ª ×‘×”×–×× ×•×ª
                if (currentFilter === 'transfers' && !o.isTask) return; // ×”×¡×ª×¨ ×”×–×× ×•×ª ×‘×”×¢×‘×¨×•×ª
                
                // Render Item
                const active = o.id === currentChatId ? 'active' : '';
                const taskClass = o.isTask ? 'task-item' : '';
                
                let iconHtml = o.isTask 
                    ? `<div class="task-icon"><i class="fas fa-truck-loading"></i></div>` 
                    : `<img src="${o.clientAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(o.clientName)}`}" class="avatar">`;

                list.innerHTML += `
                <div class="chat-item ${active} ${taskClass}" onclick="window.loadChat('${o.id}', '${o.clientName}', ${o.isTask})">
                    ${iconHtml}
                    <div class="flex-1 mr-3 min-w-0">
                        <div class="flex justify-between font-bold text-gray-800 text-sm">
                            ${o.clientName}
                            <span class="text-[10px] text-gray-400">${o.lastActive ? new Date(o.lastActive.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                        </div>
                        <div class="text-xs text-gray-500 truncate">${o.isTask ? '×××ª×™×Ÿ ×œ×©×™×‘×•×¥...' : (o.currentProject || '×”×–×× ×” ×›×œ×œ×™×ª')}</div>
                    </div>
                </div>`;
            });

            // Update Badges
            const bOrders = document.getElementById('badge-orders');
            const bTransfers = document.getElementById('badge-transfers');
            
            if(ordersCount > 0) { bOrders.innerText = ordersCount; bOrders.classList.add('show'); } else bOrders.classList.remove('show');
            if(transfersCount > 0) { bTransfers.innerText = transfersCount; bTransfers.classList.add('show'); } else bTransfers.classList.remove('show');
        }

        window.switchTab = (tab) => {
            currentFilter = tab;
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            renderList();
        };

        // --- 3. Chat Area ---
        window.loadChat = (id, title, isTask) => {
            currentChatId = id;
            document.getElementById('active-chat').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chatTitle').innerText = title;
            document.getElementById('chatSub').innerText = isTask ? '××©×™××” ×¤× ×™××™×ª' : '×œ×§×•×—';
            document.getElementById('chatAvatar').src = isTask ? 'https://cdn-icons-png.flaticon.com/512/733/733585.png' : `https://ui-avatars.com/api/?name=${title}`;

            if(pendingDoc) document.getElementById('pendingDocBar').classList.remove('hidden');

            const q = query(collection(db, `orders/${id}/internal_chat`), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                const area = document.getElementById('messages-area');
                area.innerHTML = '';
                snap.docs.forEach(d => renderMsg(d.data(), d.id, id));
                area.scrollTop = area.scrollHeight;
            });
        };

        function renderMsg(m, msgId, orderId) {
            const isMe = m.sender !== 'client';
            let content = m.text;

            // ×. ×›×¨×˜×™×¡ ××©×™××” (×›×—×•×œ)
            if (m.type === 'task_desc') {
                content = `
                <div class="transfer-card">
                    <div class="transfer-head"><i class="fas fa-info-circle"></i> ×¤×¨×˜×™ ×”×¢×‘×¨×”</div>
                    <div class="order-body">${m.text}</div>
                    <div class="order-actions">
                        <div class="action-btn text-blue-600" onclick="alert('× ×”×’ ×©×•×‘×¥')">ğŸ‘¤ ×©×™×™×š ×œ× ×”×’</div>
                        <div class="action-btn text-green-600" onclick="alert('×‘×•×¦×¢')">âœ… ×¡××Ÿ ×›×‘×•×¦×¢</div>
                    </div>
                </div>`;
            }
            // ×‘. ×›×¨×˜×™×¡ ×”×–×× ×” (×™×¨×•×§)
            else if (m.type === 'order') {
                content = `
                <div class="order-card">
                    <div class="order-head"><span>ğŸ“¦ ×”×–×× ×”</span><span class="text-xs bg-white border px-1 rounded">${m.project||'×›×œ×œ×™'}</span></div>
                    <div class="order-body">${m.text}</div>
                    <div class="order-actions">
                        <div class="action-btn text-blue-600" onclick="window.updateStatus('${orderId}','work')"><i class="fas fa-tools"></i> ×œ×™×§×•×˜</div>
                        <div class="action-btn text-green-600" onclick="window.updateStatus('${orderId}','approved')"><i class="fas fa-check"></i> ××•×›×Ÿ</div>
                        <div class="action-btn" onclick="window.printOrder(...)"><i class="fas fa-print"></i> ×”×“×¤×¡</div>
                    </div>
                </div>`;
            }
            else if (m.type === 'pdf') {
                content = `<a href="${m.url}" target="_blank" class="flex items-center gap-2 p-2 bg-red-50 border border-red-100 rounded text-red-700 font-bold text-sm"><i class="fas fa-file-pdf"></i> ××¡××š PDF</a>`;
            }

            document.getElementById('messages-area').innerHTML += `
            <div class="msg-bubble ${isMe ? 'msg-out' : 'msg-in'} ${m.isVisibleToClient===false?'msg-internal':''}">
                <div>${content}</div>
                <div class="msg-meta"><span>${new Date(m.createdAt?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>
            </div>`;
        }

        // --- 4. Helpers & Actions ---
        window.updateStatus = async (oid, status) => {
            if(!confirm('×œ×¢×“×›×Ÿ ×¡×˜×˜×•×¡ ×•×œ×©×œ×•×— ×”×•×“×¢×”?')) return;
            await updateDoc(doc(db, "orders", oid), { status: status, lastUpdate: serverTimestamp() });
            await addDoc(collection(db, `orders/${oid}/internal_chat`), { text: status==='work'?"ğŸš§ ×¢×‘×¨ ×œ×œ×™×§×•×˜":"âœ… ××•×›×Ÿ ×œ××©×œ×•×—", type: 'system', sender: '××¢×¨×›×ª', createdAt: serverTimestamp(), isVisibleToClient: true });
        };

        window.sendMessage = async () => {
            const inp = document.getElementById('msgInput'); const t = inp.value.trim(); if(!t || !currentChatId) return; inp.value='';
            await addDoc(collection(db, `orders/${currentChatId}/internal_chat`), { text: t, sender: currentUser.name, createdAt: serverTimestamp(), isVisibleToClient: !isGhostMode });
        };

        // --- Docs & Fallback ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwzf-dHQRZZ9msG-SffH5dQo0obCvwcOGc6nsV82s3Kw33m2rhNMn7Jt9AaWjGy4_4M/exec";
        window.openDocSelector = async () => {
            document.getElementById('docSelectModal').style.display='flex';
            document.getElementById('docsList').innerHTML = '<div class="p-4 text-center text-gray-400">×˜×•×¢×Ÿ...</div>';
            try {
                const res = await fetch(API_URL); if(!res.ok) throw new Error(); const data=await res.json(); renderDocs(data, document.getElementById('docsList'));
            } catch(e) { 
                renderDocs([{fileName:'×ª×¢×•×“×ª ××©×œ×•×— 881.pdf',date:'×¢×›×©×™×•'},{fileName:'×—×©×‘×•× ×™×ª 300.pdf',date:'08:00'}], document.getElementById('docsList')); 
            }
        };
        function renderDocs(d,c) { c.innerHTML = d.map(x=>`<div class="p-3 border-b hover:bg-gray-50 cursor-pointer flex justify-between" onclick="window.selectDoc('${x.fileName}')"><b>${x.fileName}</b><span class="text-xs">${x.date||''}</span></div>`).join(''); }
        
        window.selectDoc = (n) => { pendingDoc={name:n, url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'}; document.getElementById('docSelectModal').style.display='none'; document.getElementById('pendingDocName').innerText=n; if(currentChatId) document.getElementById('pendingDocBar').classList.remove('hidden'); };
        window.attachDocToChat = async () => { 
            if(!pendingDoc || !currentChatId) return;
            await addDoc(collection(db, `orders/${currentChatId}/internal_chat`), { text: `ğŸ“ ××¡××š: ${pendingDoc.name}`, type: 'pdf', url: pendingDoc.url, sender: currentUser.name, createdAt: serverTimestamp(), isVisibleToClient: !isGhostMode });
            pendingDoc=null; document.getElementById('pendingDocBar').classList.add('hidden');
        };
        
        window.toggleInfoPanel = () => document.getElementById('info-panel').classList.toggle('open');
        window.toggleGhostMode = () => { isGhostMode = !isGhostMode; const b=document.getElementById('ghostBtn'); const i=document.getElementById('msgInput'); if(isGhostMode){ b.className='w-10 h-10 text-orange-600 bg-orange-100 rounded-full transition'; i.style.background='#fff7ed'; i.placeholder='×”×¢×¨×” ×¤× ×™××™×ª...'; } else { b.className='w-10 h-10 text-gray-500 hover:bg-gray-200 rounded-full transition'; i.style.background='white'; i.placeholder='×”×§×œ×“...'; } i.focus(); };
        window.printOrder = (n,p,t,i,d) => { const w=window.open('','','width=800,height=900'); w.document.write(`<html><body style="padding:40px;text-align:right"><h1>×—.×¡×‘×Ÿ</h1><p>${n}</p><pre>${t}</pre><script>window.print()<\/script></body></html>`); w.document.close(); };
    </script>
</body>
</html>
