<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabanConnect | Master Hub v15.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
        body { background-color: #d1d7db; font-family: 'Heebo', sans-serif; height: 100vh; overflow: hidden; display: flex; }
        .wa-container { width: 100%; display: flex; background: #fff; max-width: 1600px; margin: 0 auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1); height: 100vh; }
        .sidebar { width: 30%; border-left: 1px solid #e9edef; background: #fff; display: flex; flex-direction: column; position: relative; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: #fff; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-internal { align-self: center; background: #fff9c4; border: 1px dashed #fbc02d; font-size: 12px; max-width: 80%; text-align: center; }
        .bot-badge { font-size: 9px; background: #e0f2f1; color: #00695c; padding: 1px 4px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .control-panel { position: absolute; top: 70px; left: 20px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 8px; z-index: 10; border: 1px solid #e5e5ea; }
        .stories-bar { display: flex; gap: 15px; padding: 15px; overflow-x: auto; border-bottom: 1px solid #e9edef; background: #f7f9fa; scrollbar-width: none; }
        .story-item { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; min-width: 60px; }
        .story-img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid #25d366; padding: 2px; }
        .story-name { font-size: 11px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 20px; border-radius: 12px; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="wa-container">
        <div class="sidebar">
            <div class="bg-[#f0f2f5] p-3 flex justify-between items-center border-b h-16">
                <div class="flex items-center gap-3">
                    <img src="https://i.pravatar.cc/150?img=60" class="w-10 h-10 rounded-full object-cover">
                    <div class="text-gray-600 text-sm font-bold">专 ()</div>
                </div>
                <div class="flex gap-3 text-gray-500">
                    <button onclick="openGroupModal()" class="hover:bg-gray-200 p-2 rounded-full transition"><i class="fas fa-plus text-lg text-green-600"></i></button>
                    <i class="fas fa-ellipsis-v p-2"></i>
                </div>
            </div>
            <div class="p-2 border-b bg-white"><input type="text" placeholder="驻砖..." class="w-full bg-[#f0f2f5] rounded-lg px-4 py-2 text-sm outline-none"></div>
            <div class="stories-bar" id="storiesBar"></div>
            <div class="flex-1 overflow-y-auto bg-white" id="chatList"></div>
        </div>

        <div class="chat-area relative">
            <div class="bg-[#f0f2f5] p-3 flex justify-between items-center border-b shadow-sm h-16">
                <div class="flex items-center gap-3">
                    <img id="activeAvatar" src="" class="w-10 h-10 rounded-full object-cover">
                    <div><div class="font-bold text-gray-800" id="activeName"></div><div class="text-xs text-green-600">专</div></div>
                </div>
            </div>
            <div class="control-panel">
                <div class="text-[10px] uppercase font-bold text-gray-400">拽专转 </div>
                <button id="botToggle" onclick="toggleBot()" class="flex items-center gap-2 px-3 py-1.5 rounded bg-green-100 text-green-700 text-xs font-bold border border-green-200"><i class="fas fa-robot"></i> 驻注 (Auto)</button>
                <button onclick="toggleInternal()" id="internalBtn" class="flex items-center gap-2 px-3 py-1.5 rounded bg-white text-gray-600 text-xs font-bold border border-gray-200 hover:bg-yellow-50"><i class="fas fa-eye-slash"></i> 注专 驻转</button>
            </div>
            <div class="flex-1 p-5 overflow-y-auto flex flex-col" id="messagesBox"></div>
            <div class="bg-[#f0f2f5] p-3 flex items-center gap-3" id="inputArea">
                <input type="text" id="msgInput" class="flex-1 bg-white rounded-lg px-4 py-3 text-sm outline-none" placeholder="拽 注..." onkeydown="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="text-gray-500 hover:text-[#00a884]"><i class="fas fa-paper-plane text-xl"></i></button>
            </div>
        </div>
    </div>

    <div id="groupModal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4 text-gray-700">爪专 砖</h3>
            <div class="space-y-3">
                <div><label class="text-xs text-gray-500">砖</label><input type="text" id="newGroupName" class="w-full border p-2 rounded text-sm outline-none"></div>
                <div><label class="text-xs text-gray-500">转 (URL)</label><input type="text" id="newGroupImg" class="w-full border p-2 rounded text-sm outline-none" placeholder="https://..."></div>
                <div><label class="text-xs text-gray-500">住</label><select id="newGroupType" class="w-full border p-2 rounded text-sm bg-white"><option value="user"> 拽</option><option value="truck"> 住拽</option><option value="cart"> 专砖</option><option value="hammer"> 转驻注</option></select></div>
                <div class="flex justify-end gap-2 mt-4"><button onclick="document.getElementById('groupModal').classList.add('hidden')" class="px-4 py-1 text-sm bg-gray-200 rounded"></button><button onclick="createNewGroup()" class="px-4 py-1 text-sm bg-green-600 text-white rounded font-bold">爪专</button></div>
            </div>
        </div>
    </div>

    <script>
        // --- LOGISTICS BRAIN (Enhanced for Bot) ---
        class LogisticsBrain {
            constructor() { this.branches = [{name: '专砖', lat: 32.1462, lng: 34.8951}, {name: '转', lat: 32.1554, lng: 34.8872}]; }
            async analyze(msg) {
                // Address Detection
                if (msg.length > 5 && (msg.includes("专") || msg.includes("砖") || msg.includes("专") || msg.includes("驻专") || msg.includes("转"))) {
                    try {
                        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(msg)}&countrycodes=il&limit=1`;
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        if (data.length > 0) {
                            const lat = data[0].lat, lng = data[0].lon;
                            const bbox = `${lng-0.01},${lat-0.01},${lng+0.01},${lat+0.01}`;
                            const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lng}`;
                            
                            return ` 转专转 转 转转: <b>${data[0].display_name.split(',')[0]}</b><br><iframe width="100%" height="150" src="${mapUrl}" style="border:0; border-radius:8px; margin-top:5px;"></iframe><br>憋 砖  注...`;
                        }
                    } catch(e) {}
                }
                if (msg.includes("转") || msg.includes("注")) return " 拽 拽... 转  转转 拽转 拽砖.";
                return null;
            }
        }
        const brain = new LogisticsBrain();

        // --- CHAT LOGIC ---
        let chats = [
            { id: 1, name: "砖专 砖", type: "user", imgUrl: "https://i.pravatar.cc/150?img=11", msgs: [{t:'in', txt:'转 拽 注?', time:'10:00'}], bot: true },
            { id: 2, name: "拽爪转 ", type: "truck", imgUrl: "", msgs: [{t:'internal', txt:'砖  驻拽拽', time:'08:00'}], bot: false },
            { id: 3, name: "住 拽", type: "user", imgUrl: "https://i.pravatar.cc/150?img=33", msgs: [{t:'in', txt:'转砖  专', time:'09:30'}], bot: true }
        ];
        let activeId = 1;
        let internalMode = false;

        function render() {
            renderStories();
            const list = document.getElementById('chatList');
            list.innerHTML = chats.map(c => `
                <div onclick="switchChat(${c.id})" class="p-3 cursor-pointer hover:bg-[#f5f6f6] flex items-center gap-3 ${activeId===c.id ? 'bg-[#f0f2f5]' : ''} border-b border-[#f0f2f5]">
                    <div class="relative">${getAvatarHtml(c)}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between"><div class="font-bold text-sm truncate text-[#111b21]">${c.name}</div><div class="text-[11px] text-[#667781]">${c.msgs.length > 0 ? c.msgs[c.msgs.length-1].time : ''}</div></div>
                        <div class="text-[13px] text-[#667781] truncate">${c.msgs.length > 0 ? c.msgs[c.msgs.length-1].txt : ' 注转'}</div>
                    </div>
                </div>
            `).join('');

            const chat = chats.find(c => c.id === activeId);
            if(chat) {
                document.getElementById('activeName').innerText = chat.name;
                document.getElementById('activeAvatar').src = chat.imgUrl || `https://ui-avatars.com/api/?name=${chat.name}&background=${getAvatarColorHex(chat.type)}&color=fff`;
                const box = document.getElementById('messagesBox');
                box.innerHTML = chat.msgs.map(m => `
                    <div class="msg ${m.t === 'in' ? 'msg-in' : (m.t === 'internal' ? 'msg-internal' : 'msg-out')}">
                        ${m.bot ? '<span class="bot-badge"><i class="fas fa-robot"></i> AI</span>' : ''}
                        ${m.t === 'internal' ? '<i class="fas fa-eye-slash"></i> ' : ''}${m.txt}
                        <div class="text-[9px] text-gray-400 text-left mt-1">${m.time}</div>
                    </div>
                `).join('');
                box.scrollTop = box.scrollHeight;
                updateBotBtn(chat.bot);
            }
        }

        function renderStories() {
            const bar = document.getElementById('storiesBar');
            bar.innerHTML = chats.filter(c => c.type === 'user').map(u => `
                <div class="story-item" onclick="switchChat(${u.id})"><img src="${u.imgUrl || 'https://i.pravatar.cc/150'}" class="story-img"><div class="story-name">${u.name.split(' ')[0]}</div></div>
            `).join('');
        }

        function getAvatarHtml(chat) { return chat.imgUrl ? `<img src="${chat.imgUrl}" class="w-12 h-12 rounded-full object-cover">` : `<div class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-white shadow-sm ${getAvatarColor(chat.type)}"><i class="fas ${getIcon(chat.type)} text-lg"></i></div>`; }
        function switchChat(id) { activeId = id; render(); }
        function openGroupModal() { document.getElementById('groupModal').classList.remove('hidden'); }
        function createNewGroup() {
            const name = document.getElementById('newGroupName').value;
            if(!name) return alert("  砖");
            const newChat = { id: Date.now(), name: name, type: document.getElementById('newGroupType').value, imgUrl: document.getElementById('newGroupImg').value, msgs: [], bot: true };
            chats.unshift(newChat); document.getElementById('groupModal').classList.add('hidden'); activeId = newChat.id; render();
        }
        function getIcon(type) { if(type === 'truck') return 'fa-truck-moving'; if(type === 'cart') return 'fa-shopping-cart'; if(type === 'hammer') return 'fa-hammer'; return 'fa-user'; }
        function getAvatarColor(type) { if(type === 'truck') return 'bg-purple-600'; if(type === 'cart') return 'bg-orange-500'; if(type === 'hammer') return 'bg-blue-600'; return 'bg-gray-400'; }
        function getAvatarColorHex(type) { if(type === 'truck') return '9333ea'; if(type === 'cart') return 'f97316'; if(type === 'hammer') return '2563eb'; return '9ca3af'; }

        async function sendMessage() {
            const txt = document.getElementById('msgInput').value; if(!txt) return;
            const chat = chats.find(c => c.id === activeId); const time = new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
            if(internalMode) { chat.msgs.push({t:'internal', txt: txt, time: time}); toggleInternal(); } else { chat.msgs.push({t:'out', txt: txt, time: time}); }
            document.getElementById('msgInput').value = ''; render();
            if (!internalMode && chat.bot) { 
                const reply = await brain.analyze(txt); 
                if (reply) { setTimeout(() => { chat.msgs.push({t:'in', txt: reply, time: time, bot: true}); render(); }, 1500); } 
            }
        }

        function toggleBot() { const chat = chats.find(c => c.id === activeId); chat.bot = !chat.bot; render(); }
        function updateBotBtn(active) { const btn = document.getElementById('botToggle'); if(active) { btn.className = "flex items-center gap-2 px-3 py-1.5 rounded bg-green-100 text-green-700 text-xs font-bold border border-green-200"; btn.innerHTML = '<i class="fas fa-robot"></i> 驻注 (Auto)'; } else { btn.className = "flex items-center gap-2 px-3 py-1.5 rounded bg-red-100 text-red-700 text-xs font-bold border border-red-200"; btn.innerHTML = '<i class="fas fa-user"></i>  (Human)'; } }
        function toggleInternal() { internalMode = !internalMode; const input = document.getElementById('msgInput'); const area = document.getElementById('inputArea'); const btn = document.getElementById('internalBtn'); if(internalMode) { area.style.backgroundColor = '#fff9c4'; input.placeholder = "注专 驻转 (住转专转)..."; btn.classList.add('bg-yellow-100', 'border-yellow-300'); } else { area.style.backgroundColor = '#f0f2f5'; input.placeholder = "拽 注..."; btn.classList.remove('bg-yellow-100', 'border-yellow-300'); } }

        render();
    </script>
</body>
</html>