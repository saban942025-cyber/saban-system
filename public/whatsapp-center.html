<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>SabanConnect | ×—×"×œ v31.0 (Forward & Edit)</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        body { background-color: #d1d7db; font-family: -apple-system, system-ui, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 30%; min-width: 360px; background: white; border-left: 1px solid #e9edef; display: flex; flex-direction: column; z-index: 20; }
        .sidebar-tabs { display: flex; border-bottom: 1px solid #e9edef; background: #f0f2f5; }
        .tab-btn { flex: 1; text-align: center; padding: 15px; cursor: pointer; color: #54656f; font-weight: 500; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: #008069; border-bottom-color: #008069; background: white; }
        
        /* Chat Items */
        .chat-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f2f5; transition: 0.2s; position: relative; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }
        .group-actions { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); display: none; }
        .chat-item:hover .group-actions { display: flex; gap: 5px; }

        /* Main Chat */
        .main-chat { flex: 1; display: flex; flex-direction: column; background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; }
        
        /* Messages */
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); margin-bottom: 8px; word-wrap: break-word; background: white; align-self: flex-start; }
        .msg.staff { background: #d9fdd3; align-self: flex-end; }
        .msg:hover .msg-tools { opacity: 1; }
        
        /* Forward Button */
        .msg-tools { position: absolute; top: 0; left: -30px; opacity: 0; transition: 0.2s; }
        .btn-forward { width: 24px; height: 24px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; color: #54656f; }
        .btn-forward:hover { color: #00a884; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; width: 400px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; }
        
        /* Forward List */
        .target-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f2f5; cursor: pointer; transition: 0.2s; }
        .target-item:hover { background: #f5f6f6; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4 shrink-0">
            <div class="flex items-center gap-2">
                <img src="https://ui-avatars.com/api/?name=Admin&background=00a884&color=fff" class="w-10 h-10 rounded-full border-2 border-white">
                <div><span class="font-bold text-gray-700 block text-sm">×—×"×œ ×¨××©×™</span><span class="text-[10px] text-green-600 font-bold">â— ××•× ×œ×™×™×Ÿ</span></div>
            </div>
            <button onclick="openGroupModal()" class="w-8 h-8 rounded-full bg-white hover:bg-gray-200 flex items-center justify-center text-gray-600 shadow-sm" title="×¦×•×¨ ×§×‘×•×¦×”"><i class="fas fa-plus"></i></button>
        </div>

        <div class="sidebar-tabs">
            <div onclick="switchTab('chats')" class="tab-btn active" id="tab-chats">ğŸ’¬ ×œ×§×•×—×•×ª</div>
            <div onclick="switchTab('groups')" class="tab-btn" id="tab-groups">ğŸ“¢ ×§×‘×•×¦×•×ª</div>
        </div>

        <div id="chatsList" class="flex-1 overflow-y-auto bg-white"></div>
        <div id="groupsList" class="flex-1 overflow-y-auto bg-white hidden"></div>
    </div>

    <div id="chatArea" class="main-chat hidden">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4 shadow-sm z-10 shrink-0">
            <div class="flex items-center gap-3">
                <img id="activeAvatar" src="" class="w-10 h-10 rounded-full border border-gray-300 object-cover">
                <div><div id="activeName" class="font-bold text-gray-800"></div><div id="activeDesc" class="text-xs text-gray-500"></div></div>
            </div>
        </div>

        <div id="messagesBox" class="flex-1 overflow-y-auto flex flex-col p-4 gap-2"></div>

        <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t relative shrink-0">
            <i onclick="toggleInternalMode()" id="internalBtn" class="fas fa-eye-slash text-xl text-gray-400 cursor-pointer p-2" title="×”×¢×¨×” ×¤× ×™××™×ª"></i>
            <div class="flex-1 relative"><input type="text" id="msgInput" class="w-full p-3 rounded-xl border-none outline-none shadow-sm text-sm" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key === 'Enter') sendMessage()"></div>
            <button onclick="sendMessage()" class="w-10 h-10 flex items-center justify-center bg-[#00a884] text-white rounded-full shadow hover:bg-[#008f6f]"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="groupModal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-lg font-bold mb-4" id="groupModalTitle">×§×‘×•×¦×” ×—×“×©×”</h2>
            <form onsubmit="handleGroupSubmit(event)" class="space-y-3">
                <input type="hidden" id="editGroupId"> <input type="text" id="gName" class="w-full p-2 border rounded text-sm" placeholder="×©× ×”×§×‘×•×¦×”" required>
                <input type="text" id="gImg" class="w-full p-2 border rounded text-sm" placeholder="×ª××•× ×” (URL)">
                <input type="text" id="gDesc" class="w-full p-2 border rounded text-sm" placeholder="×ª×™××•×¨ ×§×¦×¨">
                
                <div class="border p-2 rounded max-h-40 overflow-y-auto bg-gray-50">
                    <div class="text-xs font-bold mb-2">××©×ª×ª×¤×™×:</div>
                    <div id="usersForGroup" class="space-y-1"></div>
                </div>

                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal('groupModal')" class="text-gray-500 text-sm font-bold px-3">×‘×™×˜×•×œ</button>
                    <button type="submit" class="bg-[#00a884] text-white px-4 py-2 rounded text-sm font-bold">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <div id="forwardModal" class="modal-overlay">
        <div class="modal-box h-[500px] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-bold"><i class="fas fa-share text-blue-500"></i> ×”×¢×‘×¨×ª ×”×•×“×¢×”</h2>
                <button onclick="closeModal('forwardModal')"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="bg-gray-100 p-3 rounded-lg text-sm text-gray-600 mb-4 italic truncate" id="previewMsg"></div>
            
            <input type="text" placeholder="×—×¤×© ×™×¢×“ ×œ×”×¢×‘×¨×”..." oninput="filterForwardList(this.value)" class="w-full p-2 border rounded mb-2 text-sm">
            
            <div id="forwardList" class="flex-1 overflow-y-auto space-y-1">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanPush } from './js/notifications.js';

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let activeChatId = null;
        let activeType = 'private'; 
        let internalMode = false;
        let allUsers = [];
        let allChats = []; // For forwarding
        let msgToForward = null;

        SabanPush.init('admin', 'admin_rami');
        loadUsers();

        // --- LOADERS ---
        async function loadUsers() {
            const snap = await getDocs(collection(db, "users"));
            allUsers = snap.docs.map(d => ({id: d.id, ...d.data()}));
        }

        // --- LISTS & TABS ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.getElementById('chatsList').classList.toggle('hidden', tab !== 'chats');
            document.getElementById('groupsList').classList.toggle('hidden', tab !== 'groups');
        };

        // 1. Clients List
        onSnapshot(query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc")), (snap) => {
            const list = document.getElementById('chatsList');
            list.innerHTML = "";
            allChats = []; // Reset for forward
            
            snap.forEach(d => {
                const c = d.data();
                allChats.push({id: d.id, name: c.userName, type: 'private', img: `https://ui-avatars.com/api/?name=${c.userName}`});
                const active = activeChatId === d.id ? 'active' : '';
                list.innerHTML += `<div onclick="openChat('${d.id}', '${c.userName}', 'private')" class="chat-item ${active}">
                    <img src="https://ui-avatars.com/api/?name=${c.userName}&background=random&color=fff" class="w-10 h-10 rounded-full ml-3">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between"><span class="font-bold text-sm">${c.userName}</span><span class="text-[10px] text-gray-400">${formatTime(c.lastActivity)}</span></div>
                        <div class="text-xs text-gray-500 truncate">${c.lastMessage}</div>
                    </div>
                </div>`;
            });
        });

        // 2. Groups List (With Edit/Delete)
        onSnapshot(collection(db, "groups"), (snap) => {
            const list = document.getElementById('groupsList');
            list.innerHTML = "";
            
            snap.forEach(d => {
                const g = d.data();
                const gid = d.id;
                allChats.push({id: gid, name: g.name, type: 'group', img: g.image}); // For forward list
                const active = activeChatId === gid ? 'active' : '';
                
                // Encode group data for edit
                const gData = encodeURIComponent(JSON.stringify({id: gid, ...g}));

                list.innerHTML += `
                <div onclick="openChat('${gid}', '${g.name}', 'group', '${g.image}')" class="chat-item ${active} group">
                    <img src="${g.image || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full ml-3 object-cover">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-sm">${g.name}</div>
                        <div class="text-xs text-gray-500 truncate">${g.desc || ''}</div>
                    </div>
                    <div class="group-actions bg-white shadow rounded p-1" onclick="event.stopPropagation()">
                        <button onclick="editGroup('${gData}')" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteGroup('${gid}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
        });

        // --- CHAT ENGINE ---
        window.openChat = (id, name, type, img) => {
            activeChatId = id; activeType = type;
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('activeName').innerText = name;
            document.getElementById('activeDesc').innerText = type==='group' ? '×§×‘×•×¦×”' : '×œ×§×•×—';
            document.getElementById('activeAvatar').src = img || `https://ui-avatars.com/api/?name=${name}&background=random&color=fff`;

            const coll = type === 'group' ? `groups/${id}/messages` : `chat_sessions/${id}/messages`;
            
            onSnapshot(query(collection(db, coll), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('messagesBox');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const side = m.role === 'staff' ? 'self-end bg-[#d9fdd3]' : 'self-start bg-white';
                    
                    // Encode message for forwarding
                    const msgContentEncoded = encodeURIComponent(m.text);

                    return `
                    <div class="msg ${side} group">
                        <div class="text-xs font-bold text-gray-500 mb-1 flex justify-between">
                            <span>${m.sender || '××©×ª××©'}</span>
                            ${m.forwarded ? '<span class="text-[9px] italic"><i class="fas fa-share"></i> ×”×•×¢×‘×¨</span>' : ''}
                        </div>
                        <div>${m.text}</div>
                        <div class="text-[10px] text-gray-400 text-left mt-1">${formatTime(m.createdAt)}</div>
                        
                        <div class="msg-tools">
                            <div onclick="initForward('${msgContentEncoded}')" class="btn-forward" title="×”×¢×‘×¨ ×”×•×“×¢×”"><i class="fas fa-share"></i></div>
                        </div>
                    </div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMessage = async () => {
            const txt = document.getElementById('msgInput').value;
            if(!txt || !activeChatId) return;
            document.getElementById('msgInput').value = '';
            
            const coll = activeType === 'group' ? `groups/${activeChatId}/messages` : `chat_sessions/${activeChatId}/messages`;
            await addDoc(collection(db, coll), { text: txt, role: internalMode?'internal':'staff', sender: "×¨××™", createdAt: serverTimestamp() });
            
            if (activeType === 'private') updateDoc(doc(db, "chat_sessions", activeChatId), { lastMessage: txt, lastActivity: serverTimestamp() });
        };

        // --- GROUP MANAGEMENT (CREATE / EDIT / DELETE) ---
        
        // 1. Open Modal (Create or Edit)
        window.openGroupModal = () => {
            document.getElementById('groupModalTitle').innerText = "×§×‘×•×¦×” ×—×“×©×”";
            document.getElementById('editGroupId').value = ""; // Clear ID
            document.querySelector('form').reset();
            renderUserSelection([]); 
            document.getElementById('groupModal').classList.add('open');
        };

        window.editGroup = (gDataEncoded) => {
            const g = JSON.parse(decodeURIComponent(gDataEncoded));
            document.getElementById('groupModalTitle').innerText = "×¢×¨×™×›×ª ×§×‘×•×¦×”";
            document.getElementById('editGroupId').value = g.id;
            document.getElementById('gName').value = g.name;
            document.getElementById('gImg').value = g.image;
            document.getElementById('gDesc').value = g.desc;
            
            // Pre-select members
            const currentMembers = Object.keys(g.members || {});
            renderUserSelection(currentMembers);
            
            document.getElementById('groupModal').classList.add('open');
        };

        window.deleteGroup = async (gid) => {
            if(confirm("×œ××—×•×§ ××ª ×”×§×‘×•×¦×” ×œ×¦××™×ª×•×ª?")) {
                await deleteDoc(doc(db, "groups", gid));
                if(activeChatId === gid) document.getElementById('chatArea').classList.add('hidden');
            }
        };

        window.handleGroupSubmit = async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editGroupId').value;
            const data = {
                name: document.getElementById('gName').value,
                image: document.getElementById('gImg').value || 'https://via.placeholder.com/40',
                desc: document.getElementById('gDesc').value,
                members: getSelectedMembers(),
                lastUpdated: serverTimestamp()
            };

            if (editId) {
                await updateDoc(doc(db, "groups", editId), data);
            } else {
                await addDoc(collection(db, "groups"), { ...data, createdBy: "admin", createdAt: serverTimestamp() });
            }
            closeModal('groupModal');
        };

        function renderUserSelection(selectedIds = []) {
            const container = document.getElementById('usersForGroup');
            container.innerHTML = allUsers.map(u => `
                <label class="flex items-center justify-between p-2 hover:bg-gray-50 border-b cursor-pointer">
                    <div class="flex items-center gap-2">
                        <img src="${u.avatar}" class="w-6 h-6 rounded-full">
                        <span class="text-xs">${u.name}</span>
                    </div>
                    <input type="checkbox" class="user-check accent-green-600" value="${u.id}" ${selectedIds.includes(u.id)?'checked':''}>
                </label>
            `).join('');
        }

        function getSelectedMembers() {
            const mems = {};
            document.querySelectorAll('.user-check:checked').forEach(cb => mems[cb.value] = 'write'); // Default permission
            return mems;
        }

        // --- FORWARDING LOGIC ---
        window.initForward = (encodedText) => {
            msgToForward = decodeURIComponent(encodedText);
            document.getElementById('previewMsg').innerText = msgToForward;
            renderForwardList(allChats);
            document.getElementById('forwardModal').classList.add('open');
        };

        function renderForwardList(list) {
            const container = document.getElementById('forwardList');
            container.innerHTML = list.map(c => `
                <div onclick="executeForward('${c.id}', '${c.type}', '${c.name}')" class="target-item">
                    <img src="${c.img}" class="w-8 h-8 rounded-full ml-3">
                    <div>
                        <div class="font-bold text-sm">${c.name}</div>
                        <div class="text-[10px] text-gray-400">${c.type==='group'?'×§×‘×•×¦×”':'×œ×§×•×—'}</div>
                    </div>
                </div>
            `).join('');
        }

        window.filterForwardList = (term) => {
            renderForwardList(allChats.filter(c => c.name.toLowerCase().includes(term.toLowerCase())));
        };

        window.executeForward = async (targetId, type, targetName) => {
            if(!confirm(`×œ×”×¢×‘×™×¨ ××ª ×”×”×•×“×¢×” ×œ-${targetName}?`)) return;
            
            const coll = type === 'group' ? `groups/${targetId}/messages` : `chat_sessions/${targetId}/messages`;
            
            await addDoc(collection(db, coll), {
                text: msgToForward,
                role: 'staff',
                sender: "×¨××™ (×”×•×¢×‘×¨)",
                forwarded: true, // Flag
                createdAt: serverTimestamp()
            });

            closeModal('forwardModal');
            
            // If private chat, update last message
            if (type === 'private') {
                updateDoc(doc(db, "chat_sessions", targetId), { lastMessage: "â†ªï¸ ×”×•×“×¢×” ×”×•×¢×‘×¨×”", lastActivity: serverTimestamp() });
            }
            
            // Optional: Jump to that chat
            // openChat(targetId, targetName, type, ...);
        };

        // Utils
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');
        function formatTime(ts) { return ts ? new Date(ts.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''; }
        window.toggleInternalMode = () => { internalMode=!internalMode; document.getElementById('msgInput').placeholder = internalMode ? "×”×¢×¨×” ×¤× ×™××™×ª..." : "×”×§×œ×“..."; document.getElementById('internalBtn').className = internalMode ? "fas fa-eye-slash text-xl text-orange-500 p-2" : "fas fa-eye text-xl text-gray-400 p-2"; };

    </script>
</body>
</html>
