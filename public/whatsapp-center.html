<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabanConnect | Master Hub v16.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap');
        body { background-color: #d1d7db; font-family: 'Heebo', sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        /* Layout */
        .wa-container { width: 100%; display: flex; background: #fff; max-width: 1600px; margin: 0 auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1); height: 100vh; }
        .sidebar { width: 30%; border-left: 1px solid #e9edef; background: #fff; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; }
        
        /* Messages */
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.4; }
        .msg-in { align-self: flex-start; background: #fff; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-internal { align-self: center; background: #fff9c4; border: 1px dashed #fbc02d; font-size: 12px; max-width: 80%; text-align: center; }
        .bot-badge { font-size: 9px; background: #e0f2f1; color: #00695c; padding: 1px 4px; border-radius: 4px; font-weight: bold; margin-right: 5px; border: 1px solid #b2dfdb; }
        
        /* Elements */
        .product-card { border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; margin-top: 5px; background: #f8fafc; }
        .product-img { width: 100%; height: 120px; object-fit: contain; background: white; border-bottom: 1px solid #eee; }
        .team-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-top: 5px; }
        .team-card { background: #f1f5f9; padding: 5px; border-radius: 6px; display: flex; align-items: center; gap: 5px; cursor: pointer; border: 1px solid #e2e8f0; }
        .control-panel { position: absolute; top: 70px; left: 20px; background: rgba(255,255,255,0.95); padding: 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 8px; z-index: 10; border: 1px solid #e5e5ea; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 20px; border-radius: 12px; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .hidden { display: none !important; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="wa-container" id="appContainer">
        
        <div class="sidebar">
            <div class="bg-[#f0f2f5] p-3 flex justify-between items-center border-b h-16">
                <div class="flex items-center gap-3">
                    <img src="https://ui-avatars.com/api/?name=Rami+Admin&background=075E54&color=fff" class="w-10 h-10 rounded-full">
                    <div class="text-gray-600 text-sm font-bold">×¨××™ (×× ×”×œ)</div>
                </div>
                <div class="flex gap-3 text-gray-500">
                    <button onclick="openGroupModal()" class="hover:bg-gray-200 p-2 rounded-full transition" title="×¦×•×¨ ×§×‘×•×¦×” ×—×“×©×”"><i class="fas fa-plus text-lg text-green-600"></i></button>
                    <i class="fas fa-ellipsis-v p-2"></i>
                </div>
            </div>
            
            <div class="p-2 border-b bg-white"><input type="text" placeholder="×—×™×¤×•×©..." class="w-full bg-[#f0f2f5] rounded-lg px-4 py-2 text-sm outline-none"></div>
            
            <div class="flex-1 overflow-y-auto bg-white" id="chatList">
                </div>
        </div>

        <div class="chat-area">
            <div class="bg-[#f0f2f5] p-3 flex justify-between items-center border-b shadow-sm h-16">
                <div class="flex items-center gap-3">
                    <img id="activeAvatar" src="" class="w-10 h-10 rounded-full">
                    <div><div class="font-bold text-gray-800" id="activeName"></div><div class="text-xs text-green-600">××—×•×‘×¨</div></div>
                </div>
            </div>

            <div class="control-panel">
                <div class="text-[10px] uppercase font-bold text-gray-400">×‘×§×¨×ª ×‘×•×˜</div>
                <button id="botToggle" onclick="toggleBot()" class="flex items-center gap-2 px-3 py-1.5 rounded bg-green-100 text-green-700 text-xs font-bold border border-green-200"><i class="fas fa-robot"></i> ×¤×¢×™×œ (Auto)</button>
                <button onclick="toggleInternal()" id="internalBtn" class="flex items-center gap-2 px-3 py-1.5 rounded bg-white text-gray-600 text-xs font-bold border border-gray-200 hover:bg-yellow-50"><i class="fas fa-eye-slash"></i> ×”×¢×¨×” ×¤× ×™××™×ª</button>
            </div>

            <div class="flex-1 p-5 overflow-y-auto flex flex-col gap-2" id="messagesBox"></div>

            <div class="bg-[#f0f2f5] p-3 flex items-center gap-3" id="inputArea">
                <i class="fas fa-plus text-gray-500 text-xl cursor-pointer hover:text-green-600 transition" title="×›×œ×™× ×—×›××™×"></i>
                <input type="text" id="msgInput" class="flex-1 bg-white rounded-lg px-4 py-3 text-sm outline-none" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="text-gray-500 hover:text-[#00a884]"><i class="fas fa-paper-plane text-xl"></i></button>
            </div>
        </div>
    </div>

    <div id="groupModal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4 text-gray-700">×™×¦×™×¨×ª ×§×‘×•×¦×” / ××™×© ×§×©×¨</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500">×©× ×”×§×‘×•×¦×”</label>
                    <input type="text" id="newGroupName" class="w-full border p-2 rounded text-sm outline-none focus:border-green-500">
                </div>
                <div>
                    <label class="text-xs text-gray-500">×¡×•×’</label>
                    <select id="newGroupType" class="w-full border p-2 rounded text-sm outline-none bg-white">
                        <option value="user">ğŸ‘¤ ×œ×§×•×— ×¤×¨×˜×™</option>
                        <option value="truck">ğŸšš ×œ×•×’×™×¡×˜×™×§×”</option>
                        <option value="cart">ğŸ›’ ×¨×›×© ×•×¡×¤×§×™×</option>
                        <option value="hammer">ğŸ”¨ ×¦×•×•×ª ×ª×¤×¢×•×œ</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="document.getElementById('groupModal').classList.add('hidden')" class="px-4 py-1 text-sm text-gray-500 hover:bg-gray-100 rounded">×‘×™×˜×•×œ</button>
                    <button onclick="createNewGroup()" class="px-4 py-1 text-sm bg-green-600 text-white rounded font-bold hover:bg-green-700">×¦×•×¨</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let chats = [
            { 
                id: 1, 
                name: "×©×—×¨ ×©××•×œ", 
                type: "user", 
                avatar: "https://i.pravatar.cc/150?img=11", 
                msgs: [
                    {t:'in', txt:'××ª×™ ×”×‘×œ×•×§×™× ××’×™×¢×™×?', time:'10:00'},
                    {t:'out', txt:'××”×œ×Ÿ ×©×—×¨! ğŸ‘‹<br>×× ×™ <b>Chat-Saban</b>, ×”×‘×•×˜ ×”×—×“×©.<br>×¨××™ ×™×¦× ×œ×”×¤×¡×§×”, ×× ×™ ×›××Ÿ ×‘××§×•××•.', time:'10:01', bot:true}
                ], 
                bot: true 
            },
            { 
                id: 2, 
                name: "×§×‘×•×¦×ª × ×”×’×™×", 
                type: "truck", 
                avatar: "", 
                msgs: [{t:'internal', txt:'×œ×©×™× ×œ×‘ ×œ×¤×§×§×™× ×‘×›×‘×™×© 6', time:'08:00'}], 
                bot: false 
            }
        ];
        let activeId = 1;
        let internalMode = false;

        // --- RENDER FUNCTIONS ---
        function render() {
            renderChatList();
            renderActiveChat();
        }

        function renderChatList() {
            const list = document.getElementById('chatList');
            list.innerHTML = chats.map(c => `
                <div onclick="switchChat(${c.id})" class="p-3 cursor-pointer hover:bg-[#f5f6f6] flex items-center gap-3 ${activeId===c.id ? 'bg-[#f0f2f5]' : ''} border-b border-[#f0f2f5]">
                    <div class="relative">
                        ${getAvatarHtml(c)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between"><div class="font-bold text-sm truncate text-[#111b21]">${c.name}</div><div class="text-[11px] text-[#667781]">${c.msgs.length > 0 ? c.msgs[c.msgs.length-1].time : ''}</div></div>
                        <div class="text-[13px] text-[#667781] truncate">${c.msgs.length > 0 ? c.msgs[c.msgs.length-1].txt.replace(/<[^>]*>/g, '') : '××™×Ÿ ×”×•×“×¢×•×ª'}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderActiveChat() {
            const chat = chats.find(c => c.id === activeId);
            if(!chat) return;

            document.getElementById('activeName').innerText = chat.name;
            document.getElementById('activeAvatar').src = chat.avatar || `https://ui-avatars.com/api/?name=${chat.name}&background=${getAvatarColorHex(chat.type)}&color=fff`;
            
            const box = document.getElementById('messagesBox');
            box.innerHTML = chat.msgs.map(m => {
                if (m.t === 'internal') return `<div class="msg msg-internal fade-in"><i class="fas fa-lock"></i> <b>×”×¢×¨×” ×¤× ×™××™×ª:</b> ${m.text}<div class="text-[9px] text-gray-500 mt-1">${m.time}</div></div>`;
                const typeClass = m.t === 'in' ? 'msg-in' : 'msg-out';
                const badge = m.bot ? '<span class="bot-badge"><i class="fas fa-robot"></i> SabanAI</span>' : '';
                return `<div class="msg ${typeClass} fade-in">${badge}${m.txt}<div class="text-[9px] text-gray-500 text-left mt-1">${m.time}</div></div>`;
            }).join('');
            
            box.scrollTop = box.scrollHeight;
            updateBotBtn(chat.bot);
        }

        function switchChat(id) {
            activeId = id;
            render();
        }

        // --- GROUP MANAGEMENT (THE FIX) ---
        function openGroupModal() { 
            document.getElementById('groupModal').classList.remove('hidden'); 
        }
        
        function createNewGroup() {
            const name = document.getElementById('newGroupName').value;
            const type = document.getElementById('newGroupType').value;
            
            if(!name) return alert("×—×•×‘×” ×œ×”×–×™×Ÿ ×©× ×œ×§×‘×•×¦×”");
            
            const newChat = {
                id: Date.now(),
                name: name,
                type: type,
                avatar: "", // Default avatar based on type
                msgs: [{t:'internal', txt:'×”×§×‘×•×¦×” × ×•×¦×¨×” ×¢"×™ ×¨××™', time: new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'})}],
                bot: true
            };
            
            chats.unshift(newChat);
            document.getElementById('groupModal').classList.add('hidden');
            document.getElementById('newGroupName').value = '';
            
            activeId = newChat.id;
            render();
        }

        // --- CHAT LOGIC ---
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value;
            if(!text) return;
            
            const chat = chats.find(c => c.id === activeId);
            const time = new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
            
            if(internalMode) {
                chat.msgs.push({t:'internal', text: text, time: time}); // Fix: changed txt to text for internal to match structure? No wait, used 'txt' everywhere else. Let's fix that.
                // Correction: My structure uses 'txt'.
                chat.msgs[chat.msgs.length-1].txt = text; // Fix logic
                toggleInternal();
            } else {
                chat.msgs.push({t:'out', txt: text, time: time});
                analyzeUserText(text, chat); // Run bot analysis
            }
            
            input.value = '';
            render();
        }

        function analyzeUserText(text, chat) {
            if(!chat.bot || internalMode) return;
            const clean = text.toLowerCase();
            const time = new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});

            setTimeout(() => {
                if (clean.includes('603') || clean.includes('×“×‘×§')) {
                    chat.msgs.push({t:'in', txt: `×¨×’×¢ ××—×“, ×‘×•×“×§ ×‘××œ××™... <i class="fas fa-spinner fa-spin"></i>`, time: time, bot: true});
                    render();
                    setTimeout(() => {
                        chat.msgs.push({t:'in', txt: showProductCard("×ª×¨××•×§×™×¨ ×¤×œ×¡×˜×•××¨ 603", "38.00", "https://termokir.co.il/wp-content/uploads/2019/07/Plastomer-603.png"), time: time, bot: true});
                        render();
                    }, 1500);
                }
                else if (clean.includes('×× ×•×£') && clean.includes('7')) {
                    chat.msgs.push({t:'in', txt: `<b>×‘×“×™×§×ª ×”×™×ª×›× ×•×ª:</b><br>ğŸ“ ×™×¢×“: ××‘×Ÿ ×™×”×•×“×”<br>ğŸ‘· × ×”×’: ×—×›××ª (××ª×—×™×œ 06:30)<br>âœ… <b>××¤×©×¨×™.</b> ×—×›××ª ×™×’×™×¢ ×‘-07:15. ×œ×©×¨×™×™×Ÿ?`, time: time, bot: true});
                    render();
                }
                else if (clean.includes('@')) {
                    const tagged = clean.split('@')[1].split(' ')[0];
                    chat.msgs.push({t:'internal', txt: `ğŸ”” <b>×”×ª×¨××”:</b> ${tagged} ×ª×•×™×’ ×‘×©×™×—×” ×•× ×©×œ×—×” ×œ×• ×”×•×“×¢×”.`, time: time});
                    chat.msgs.push({t:'in', txt: `××™×Ÿ ×‘×¢×™×”, ×§×¨××ª×™ ×œ-${tagged}.`, time: time, bot: true});
                    render();
                }
            }, 1000);
        }

        // --- HELPERS ---
        function getAvatarHtml(chat) { 
            if (chat.avatar) return `<img src="${chat.avatar}" class="w-12 h-12 rounded-full object-cover">`;
            return `<div class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-white shadow-sm ${getAvatarColor(chat.type)}"><i class="fas ${getIcon(chat.type)} text-lg"></i></div>`; 
        }
        function getIcon(type) { if(type === 'truck') return 'fa-truck-moving'; if(type === 'cart') return 'fa-shopping-cart'; if(type === 'hammer') return 'fa-hammer'; return 'fa-user'; }
        function getAvatarColor(type) { if(type === 'truck') return 'bg-purple-600'; if(type === 'cart') return 'bg-orange-500'; if(type === 'hammer') return 'bg-blue-600'; return 'bg-gray-400'; }
        function getAvatarColorHex(type) { if(type === 'truck') return '9333ea'; if(type === 'cart') return 'f97316'; if(type === 'hammer') return '2563eb'; return '9ca3af'; }
        
        function showProductCard(name, price, img) {
            return `<div class="product-card"><div class="product-img flex items-center justify-center p-2"><img src="${img}" class="max-h-full"></div><div class="p-2"><div class="font-bold text-sm text-slate-800">${name}</div><div class="text-xs text-green-600 font-bold mb-1">â‚ª${price}</div><button class="w-full bg-green-600 text-white text-xs py-1.5 rounded font-bold shadow">×”×•×¡×£ ×œ×”×–×× ×”</button></div></div>`;
        }

        function toggleBot() { const chat = chats.find(c => c.id === activeId); chat.bot = !chat.bot; render(); }
        function updateBotBtn(active) { const btn = document.getElementById('botToggle'); if(active) { btn.className = "flex items-center gap-2 px-3 py-1.5 rounded bg-green-100 text-green-700 text-xs font-bold border border-green-200"; btn.innerHTML = '<i class="fas fa-robot"></i> ×¤×¢×™×œ (Auto)'; } else { btn.className = "flex items-center gap-2 px-3 py-1.5 rounded bg-red-100 text-red-700 text-xs font-bold border border-red-200"; btn.innerHTML = '<i class="fas fa-user"></i> ×™×“× ×™ (Human)'; } }
        function toggleInternal() { internalMode = !internalMode; const input = document.getElementById('msgInput'); const area = document.getElementById('inputArea'); const btn = document.getElementById('internalBtn'); if(internalMode) { area.style.backgroundColor = '#fff9c4'; input.placeholder = "×”×¢×¨×” ×¤× ×™××™×ª (××•×¡×ª×¨×ª)..."; btn.classList.add('bg-yellow-100', 'border-yellow-300'); } else { area.style.backgroundColor = '#f0f2f5'; input.placeholder = "×”×§×œ×“ ×”×•×“×¢×”..."; btn.classList.remove('bg-yellow-100', 'border-yellow-300'); } }

        // Init
        render();
    </script>
</body>
</html>
