<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×—×"×œ ×”×–×× ×•×ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #d1d7db; font-family: sans-serif; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 35%; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .main { flex: 1; background: #efeae2; display: flex; flex-direction: column; }
        
        .chat-item { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; }
        .chat-item:hover { background: #f5f5f5; }
        .chat-item.active { background: #e0f2f1; border-right: 4px solid #008069; }
        
        /* Ring Animation */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } }
        .ring-red { border: 3px solid #dc2626; animation: pulse-red 1.5s infinite; }
        .ring-green { border: 3px solid #10b981; }
        
        .msg { padding: 8px 12px; margin: 5px 20px; border-radius: 8px; width: fit-content; max-width: 70%; font-size: 14px; }
        .msg.staff { background: #d9fdd3; align-self: flex-end; }
        .msg.user { background: white; align-self: flex-start; }
        .msg.internal { background: #fff9c4; align-self: center; border: 1px dashed orange; text-align: center; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4">
            <div class="font-bold text-gray-700">×§×‘×•×¦×ª ×”×–×× ×•×ª</div>
            <button id="soundBtn" onclick="toggleSound()" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2">
                <i class="fas fa-volume-mute"></i> ×›×¨×™×–×” ×›×‘×•×™×”
            </button>
        </div>
        
        <div class="flex border-b">
            <div onclick="switchTab('chats')" class="flex-1 p-3 text-center cursor-pointer font-bold bg-white text-green-700 border-b-2 border-green-700" id="tab-chats">ğŸ“¦ ×”×–×× ×•×ª</div>
            <div onclick="switchTab('saban')" class="flex-1 p-3 text-center cursor-pointer font-bold text-gray-500" id="tab-saban">ğŸ§  ×¦'××˜-×¡×‘×Ÿ</div>
        </div>

        <div id="list-chats" class="flex-1 overflow-y-auto"></div>
        <div id="list-saban" class="flex-1 overflow-y-auto hidden"></div>
    </div>

    <div class="main hidden" id="mainArea">
        <div class="h-16 bg-[#f0f2f5] border-b flex items-center px-4 justify-between">
            <div class="flex items-center gap-3">
                <img id="chatAvatar" src="" class="w-10 h-10 rounded-full border">
                <div class="font-bold" id="chatName"></div>
            </div>
            <button onclick="promptLink()" class="bg-orange-100 text-orange-700 px-3 py-1 rounded border border-orange-200 text-sm font-bold">ğŸ”— ×§×©×•×¨ ×”×–×× ×”</button>
        </div>
        
        <div id="msgBox" class="flex-1 overflow-y-auto flex flex-col p-4"></div>
        
        <div class="p-3 bg-[#f0f2f5] border-t flex gap-2">
            <i onclick="toggleInternal()" id="eyeBtn" class="fas fa-eye-slash text-gray-400 p-2 text-xl cursor-pointer"></i>
            <input id="inputMsg" class="flex-1 p-2 rounded border-none outline-none" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') send()">
            <button onclick="send()" class="text-green-600 text-2xl"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanSounds } from './js/sounds.js';

        const config = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(config);
        const db = getFirestore(app);

        let activeId = null, internal = false, audioOn = false;

        window.toggleSound = () => {
            if(!audioOn) {
                audioOn = true; 
                document.getElementById('soundBtn').className = "bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2";
                document.getElementById('soundBtn').innerHTML = '<i class="fas fa-volume-up"></i> ×›×¨×™×–×” ×¤×¢×™×œ×”';
                SabanSounds.playMessage();
            }
        };

        window.switchTab = (t) => {
            document.getElementById('list-chats').classList.toggle('hidden', t!=='chats');
            document.getElementById('list-saban').classList.toggle('hidden', t!=='saban');
            // Visuals
            document.getElementById('tab-chats').className = t==='chats' ? "flex-1 p-3 text-center cursor-pointer font-bold bg-white text-green-700 border-b-2 border-green-700" : "flex-1 p-3 text-center cursor-pointer font-bold text-gray-500";
            document.getElementById('tab-saban').className = t==='saban' ? "flex-1 p-3 text-center cursor-pointer font-bold bg-white text-indigo-700 border-b-2 border-indigo-700" : "flex-1 p-3 text-center cursor-pointer font-bold text-gray-500";
        };

        // Listeners
        onSnapshot(query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc")), snap => {
            const list = document.getElementById('list-chats'); list.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                let ring = "ring-green";
                if(c.lastMessage?.includes("ğŸ›‘")) { ring = "ring-red"; if(audioOn) SabanSounds.playAlert(); }
                
                list.innerHTML += `<div onclick="loadChat('${d.id}', '${c.userName}', '${c.avatar}')" class="chat-item ${activeId===d.id?'active':''}">
                    <img src="${c.avatar}" class="w-12 h-12 rounded-full ${ring} p-0.5 object-cover">
                    <div class="mr-3 overflow-hidden">
                        <div class="font-bold text-sm">${c.userName}</div>
                        <div class="text-xs text-gray-500 truncate">${c.lastMessage}</div>
                    </div>
                </div>`;
            });
        });

        window.loadChat = (id, name, img) => {
            activeId = id;
            document.getElementById('mainArea').classList.remove('hidden');
            document.getElementById('chatName').innerText = name;
            document.getElementById('chatAvatar').src = img;
            
            onSnapshot(query(collection(db, `chat_sessions/${id}/messages`), orderBy("createdAt", "asc")), snap => {
                const box = document.getElementById('msgBox');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    let cls = m.role==='staff'?'msg staff':'msg user';
                    if(m.role==='internal') cls = 'msg internal';
                    return `<div class="${cls}">${m.role==='internal'?'ğŸ”’ ':''}${m.text}</div>`;
                }).join('');
                box.scrollTop = 9999;
            });
        };

        window.send = async () => {
            const txt = document.getElementById('inputMsg').value; if(!txt) return;
            document.getElementById('inputMsg').value = '';
            await addDoc(collection(db, `chat_sessions/${activeId}/messages`), { text: txt, role: internal?'internal':'staff', sender: "×—×\"×œ", createdAt: serverTimestamp() });
            if(!internal) updateDoc(doc(db, "chat_sessions", activeId), { lastMessage: `× ×¦×™×’: ${txt}`, lastActivity: serverTimestamp(), lastMsgFromStaff: true });
            if(internal) window.toggleInternal();
        };

        window.toggleInternal = () => {
            internal = !internal;
            const inp = document.getElementById('inputMsg');
            const eye = document.getElementById('eyeBtn');
            if(internal) { inp.placeholder="×”×¢×¨×” ×¤× ×™××™×ª..."; inp.classList.add('bg-yellow-100'); eye.className="fas fa-eye text-orange-500 p-2 text-xl cursor-pointer"; }
            else { inp.placeholder="×”×§×œ×“..."; inp.classList.remove('bg-yellow-100'); eye.className="fas fa-eye-slash text-gray-400 p-2 text-xl cursor-pointer"; }
        };

        window.promptLink = async () => {
            const id = prompt("××¡×¤×¨ ×”×–×× ×”:"); if(!id) return;
            await addDoc(collection(db, `chat_sessions/${activeId}/messages`), { text: `â³ ×××ª×™×Ÿ ×œ××¡××š ${id}...`, role: 'internal', createdAt: serverTimestamp() });
            updateDoc(doc(db, "chat_sessions", activeId), { lastMessage: `×××ª×™×Ÿ ×œ××¡××š ${id}`, lastActivity: serverTimestamp() });
        };
    </script>
</body>
</html>
