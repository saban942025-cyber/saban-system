<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Command | ×—×"×œ</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/733/733585.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --wa-header: #f0f2f5; --wa-bg: #efeae2; --wa-green: #00a884; --task-blue: #0ea5e9; }
        
        body { margin: 0; padding: 0; background: #d1d7db; height: 100dvh; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .app-container { display: flex; width: 100%; height: 100%; max-width: 1920px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: relative; }
        
        .sidebar { width: 400px; min-width: 350px; display: flex; flex-direction: column; border-left: 1px solid #e9edef; background: white; z-index: 20; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--wa-bg); background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; min-width: 0; }

        /* Tabs */
        .tabs { display: flex; background: white; border-bottom: 1px solid #e9edef; }
        .tab { flex: 1; text-align: center; padding: 14px; cursor: pointer; color: #54656f; font-weight: 600; border-bottom: 3px solid transparent; transition: 0.2s; position: relative; font-size: 14px; }
        .tab.active { color: var(--wa-green); border-bottom-color: var(--wa-green); }
        .badge { position: absolute; top: 10px; left: 20px; background: #25d366; color: white; font-size: 10px; padding: 0 6px; border-radius: 10px; min-width: 18px; }

        /* Chat List */
        .chat-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f5f6f6; transition: 0.2s; background: white; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid var(--wa-green); }
        .chat-item.task-item { border-right: 4px solid var(--task-blue); background: #f0f9ff; }
        .avatar { width: 45px; height: 45px; rounded: 50%; object-fit: cover; border: 1px solid #e9edef; margin-left: 12px; }
        .task-icon { width: 45px; height: 45px; background: #e0f2fe; color: #0284c7; border-radius: 50%; display: flex; items-center; justify-content: center; margin-left: 12px; font-size: 18px; }

        /* Messages */
        .msg-bubble { max-width: 70%; padding: 8px 10px; border-radius: 8px; font-size: 14px; margin-bottom: 6px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); position: relative; line-height: 1.4; }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-internal { background: #fff7ed !important; border: 1px dashed #fdba74; }
        .msg-system { align-self: center; background: #eef2ff; color: #3730a3; font-size: 11px; padding: 4px 10px; border-radius: 10px; border: 1px dashed #c7d2fe; margin: 8px 0; font-weight: 600; }

        /* Order Card */
        .order-card { background: white; border-radius: 8px; overflow: hidden; width: 320px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 5px; border: 1px solid #e5e7eb; }
        .order-header { background: #f0fdf4; padding: 10px 15px; border-bottom: 1px solid #dcfce7; display: flex; justify-content: space-between; align-items: center; }
        .order-body { padding: 15px; font-family: monospace; white-space: pre-wrap; font-size: 13px; background: #fafafa; color: #333; border-bottom: 1px solid #f3f4f6; }
        .order-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: #e5e7eb; }
        .action-btn { background: white; padding: 10px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: 0.2s; color: #4b5563; }
        .action-btn:hover { background: #f9fafb; color: #111827; }

        /* Internal Task Card (Blue) */
        .task-card { background: white; border-radius: 8px; overflow: hidden; width: 320px; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #bae6fd; }
        .task-header { background: #e0f2fe; padding: 10px 15px; border-bottom: 1px solid #bae6fd; display: flex; justify-content: space-between; align-items: center; color: #0369a1; font-weight: bold; }
        .task-actions { display: flex; border-top: 1px solid #f1f5f9; }
        .task-btn { flex: 1; padding: 10px; background: white; text-align: center; cursor: pointer; font-size: 12px; font-weight: bold; color: #0284c7; border-left: 1px solid #f1f5f9; }
        .task-btn:hover { background: #f0f9ff; }

        /* Modals */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 450px; max-height: 80vh; border-radius: 12px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.25); display: flex; flex-direction: column; animation: popIn 0.3s; }
        
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Task Form */
        .form-group { padding: 15px; }
        .form-label { display: block; font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; rounded: 8px; font-size: 14px; outline: none; transition: 0.2s; background: #f8fafc; }
        .form-input:focus { border-color: #0ea5e9; background: white; }
        .form-select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: #f8fafc; }
    </style>
</head>
<body>

    <div id="taskModal" class="modal-wrap">
        <div class="modal-box">
            <div class="p-4 border-b bg-blue-50 flex justify-between items-center">
                <h3 class="font-bold text-blue-800 flex items-center gap-2"><i class="fas fa-shipping-fast"></i> ××©×™××” ×œ×¡×™×“×•×¨ (×¤× ×™××™)</h3>
                <button onclick="document.getElementById('taskModal').style.display='none'" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="form-group">
                <label class="form-label">×¡×•×’ ××©×™××”</label>
                <select id="taskType" class="form-select">
                    <option value="transfer">ğŸ”„ ×”×¢×‘×¨×” ×‘×™×Ÿ ×¡× ×™×¤×™×</option>
                    <option value="pickup">ğŸ“¦ ××™×¡×•×£ ×¡×—×•×¨×”</option>
                    <option value="admin">ğŸ“„ ×©×œ×™×—×•×ª ××©×¨×“×™×ª</option>
                    <option value="urgent">ğŸš¨ ×”×§×¤×¦×” ×“×—×•×¤×”</option>
                </select>
            </div>
            <div class="form-group pt-0">
                <label class="form-label">×¤×¨×˜×™× (×××™×¤×”, ×œ××Ÿ, ××”)</label>
                <textarea id="taskDesc" class="form-input h-24" placeholder="×œ××©×œ: ×œ×§×—×ª 2 ××©×˜×—×™ ×‘×œ×•×§×™× ××¡× ×™×£ ××‘×Ÿ ×™×”×•×“×” ×œ×¤×¨×•×§ ××¦×œ ×”×œ×§×•×— ×©×—×¨..."></textarea>
            </div>
            <div class="p-4 border-t bg-gray-50 text-right">
                <button onclick="window.submitTask()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-blue-700 w-full">×©×’×¨ ×œ×¡×™×“×•×¨ ğŸš€</button>
            </div>
        </div>
    </div>

    <div id="docSelectModal" class="modal-wrap">
        <div class="modal-box">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-gray-700"><i class="fas fa-file-import text-blue-600"></i> ××¡××›×™× (Comax)</h3>
                <button onclick="document.getElementById('docSelectModal').style.display='none'" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div id="docsList" class="flex-1 overflow-y-auto p-0"></div>
        </div>
    </div>

    <div class="app-container">
        
        <div class="sidebar">
            <div class="h-[64px] bg-[#f0f2f5] p-3 flex justify-between items-center border-b flex-shrink-0">
                <div class="flex items-center gap-3">
                    <img id="myAvatar" src="" class="w-10 h-10 rounded-full border border-gray-300 object-cover">
                    <div>
                        <span id="myName" class="font-bold text-gray-700 text-sm block">...</span>
                        <span class="text-[10px] text-green-600 font-bold">â— ONLINE</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('taskModal').style.display='flex'" class="w-10 h-10 rounded-full bg-blue-50 border border-blue-200 text-blue-600 hover:bg-blue-100 transition shadow-sm" title="××©×™××” ×—×“×©×” ×œ×¡×™×“×•×¨"><i class="fas fa-plus"></i></button>
                    <button onclick="window.openDocSelector()" class="w-10 h-10 rounded-full bg-white border border-gray-200 text-gray-600 hover:text-blue-600 transition shadow-sm" title="×™×‘× ××¡××š"><i class="fas fa-cloud-download-alt"></i></button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="window.switchTab('all')" id="tab-all">×¦'××˜×™×</div>
                <div class="tab" onclick="window.switchTab('tasks')" id="tab-tasks">
                    ×œ×¡×™×“×•×¨ (×¤× ×™××™) <span id="tasksBadge" class="badge hidden">0</span>
                </div>
            </div>

            <div class="p-2 border-b bg-white flex-shrink-0">
                <div class="bg-[#f0f2f5] rounded-lg flex items-center px-3 h-9">
                    <i class="fas fa-search text-gray-400 text-xs ml-2"></i>
                    <input type="text" placeholder="×—×™×¤×•×© × ×”×’, ×œ×§×•×— ××• ××©×™××”..." class="bg-transparent border-none outline-none text-sm w-full font-sans">
                </div>
            </div>

            <div id="chat-list" class="flex-1 overflow-y-auto custom-scroll"></div>
        </div>

        <div class="chat-area">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400 select-none">
                <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-6 opacity-30"><i class="fas fa-truck-loading text-5xl"></i></div>
                <h2 class="text-xl font-light text-gray-500">××¨×›×– × ×™×”×•×œ - ×¡×‘×Ÿ</h2>
            </div>

            <div id="active-chat" class="hidden flex flex-col h-full relative">
                
                <div class="h-[64px] bg-[#f0f2f5] p-3 flex items-center justify-between border-b shadow-sm z-20 cursor-pointer">
                    <div class="flex items-center gap-3">
                        <img id="chatAvatar" src="" class="w-10 h-10 rounded-full bg-white border object-cover">
                        <div>
                            <span id="chatTitle" class="font-bold text-gray-800 block text-sm"></span>
                            <span class="text-xs text-gray-500 flex items-center gap-1" id="chatSubtitle"></span>
                        </div>
                    </div>
                    <div class="flex gap-3 text-gray-500">
                        <i class="fas fa-search hover:text-gray-700"></i>
                        <i class="fas fa-ellipsis-v hover:text-gray-700 px-2"></i>
                    </div>
                </div>

                <div id="messages-area" class="flex-1 overflow-y-auto p-5 flex flex-col gap-1 custom-scroll"></div>

                <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t z-20">
                    <button class="w-10 h-10 text-gray-500 hover:bg-gray-200 rounded-full transition flex-shrink-0"><i class="fas fa-paperclip text-lg"></i></button>
                    <input id="msgInput" type="text" class="flex-1 bg-white rounded-xl h-10 px-4 text-sm border-none outline-none shadow-sm" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') window.sendMessage()">
                    <button onclick="window.sendMessage()" class="w-10 h-10 text-white bg-[#00a884] rounded-full shadow hover:scale-105 transition flex-shrink-0 flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanSounds } from './js/sounds.js';

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        // --- Init ---
        const urlUid = new URLSearchParams(window.location.search).get('uid');
        let currentUser = JSON.parse(localStorage.getItem('saban_user')) || { name: '×¦×•×•×ª' };
        if(urlUid) getDoc(doc(db, "users", urlUid)).then(s => { if(s.exists()){ currentUser=s.data(); localStorage.setItem('saban_user',JSON.stringify(currentUser)); document.getElementById('myName').innerText=currentUser.name; }});
        else document.getElementById('myName').innerText=currentUser.name;

        let currentChatId = null, currentFilter = 'all';

        // --- 1. Task Logic (New Module) ---
        window.submitTask = async () => {
            const type = document.getElementById('taskType').value;
            const desc = document.getElementById('taskDesc').value;
            if(!desc) return alert('× × ×œ××œ× ×¤×¨×˜×™×');

            const typeMap = { 'transfer': '×”×¢×‘×¨×”', 'pickup': '××™×¡×•×£', 'admin': '××©×¨×“', 'urgent': '×“×—×•×£' };
            
            // ×™×¦×™×¨×ª "×œ×§×•×— ×•×™×¨×˜×•××œ×™" ×œ××©×™××”
            const taskName = `××©×™××”: ${typeMap[type]}`;
            const docRef = await addDoc(collection(db, "orders"), {
                clientName: taskName,
                isTask: true, // ×“×’×œ ××–×”×”
                taskType: type,
                status: 'new',
                lastActive: serverTimestamp(),
                chat: []
            });

            // ×”×•×¡×¤×ª ×”×”×•×“×¢×” ×”×¨××©×•× ×” (×”×ª×•×›×Ÿ)
            await addDoc(collection(db, `orders/${docRef.id}/internal_chat`), {
                text: desc, sender: currentUser.name, type: 'task_desc', createdAt: serverTimestamp(), isVisibleToClient: false
            });

            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('taskDesc').value = '';
            alert('×”××©×™××” ×©×•×’×¨×” ×œ×œ×•×— ×”×¡×™×“×•×¨ âœ…');
        };

        // --- 2. Chat & Task List Logic ---
        onSnapshot(query(collection(db, "orders"), orderBy("lastActive", "desc")), (snap) => {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            let tasksCount = 0;

            snap.forEach(d => {
                const o = d.data();
                
                // Filtering
                if (currentFilter === 'tasks' && !o.isTask) return;
                if (currentFilter === 'all' && o.isTask) { tasksCount++; return; } // Don't show tasks in main list, just count

                if (o.isTask) tasksCount++; // Count for badge

                // Render Item
                const activeClass = d.id === currentChatId ? 'active' : '';
                const isTaskItem = o.isTask ? 'task-item' : '';
                
                let iconHtml = '';
                if(o.isTask) {
                    iconHtml = `<div class="task-icon"><i class="fas fa-clipboard-list"></i></div>`;
                } else {
                    const av = o.clientAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(o.clientName)}`;
                    iconHtml = `<img src="${av}" class="avatar">`;
                }

                list.innerHTML += `
                <div class="chat-item ${activeClass} ${isTaskItem}" onclick="window.loadChat('${d.id}', '${o.clientName}', ${o.isTask})">
                    ${iconHtml}
                    <div class="flex-1 mr-3 min-w-0">
                        <div class="flex justify-between font-bold text-gray-800 text-sm">
                            ${o.clientName}
                            <span class="text-[10px] font-normal text-gray-400">${o.lastActive ? new Date(o.lastActive.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                        </div>
                        <div class="text-xs text-gray-500 truncate">${o.isTask ? '×××ª×™×Ÿ ×œ×©×™×‘×•×¥ × ×”×’' : (o.currentProject || '')}</div>
                    </div>
                </div>`;
            });

            const badge = document.getElementById('tasksBadge');
            if(tasksCount > 0) { badge.innerText = tasksCount; badge.classList.remove('hidden'); }
            else badge.classList.add('hidden');
        });

        // --- 3. Chat Area Logic ---
        window.loadChat = (id, title, isTask) => {
            currentChatId = id;
            document.getElementById('active-chat').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chatTitle').innerText = title;
            document.getElementById('chatSubtitle').innerText = isTask ? '× ×™×”×•×œ ××©×™××” ×¤× ×™××™×ª' : '×œ×—×¥ ×œ×¤×¨×˜×™ ×œ×§×•×—';
            document.getElementById('chatAvatar').src = isTask ? 'https://cdn-icons-png.flaticon.com/512/1584/1584892.png' : `https://ui-avatars.com/api/?name=${title}`;

            const q = query(collection(db, `orders/${id}/internal_chat`), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                const area = document.getElementById('messages-area');
                area.innerHTML = '';
                snap.docs.forEach(d => renderMsg(d.data(), d.id, id, isTask));
                area.scrollTop = area.scrollHeight;
            });
        };

        function renderMsg(m, msgId, orderId, isTaskContext) {
            let content = m.text;
            const container = document.getElementById('messages-area');

            // ×›×¨×˜×™×¡ ××©×™××” (×›×—×•×œ)
            if(m.type === 'task_desc') {
                content = `
                <div class="task-card">
                    <div class="task-header"><i class="fas fa-info-circle"></i> ×¤×¨×˜×™ ××©×™××”</div>
                    <div class="order-body">${m.text}</div>
                    <div class="task-actions">
                        <div class="task-btn" onclick="alert('×‘×¤×™×ª×•×—: ×©×™×‘×•×¥ × ×”×’')">ğŸ‘¤ ×©×™×™×š ×œ× ×”×’</div>
                        <div class="task-btn text-green-600" onclick="alert('×‘×•×¦×¢')">âœ… ×¡××Ÿ ×›×‘×•×¦×¢</div>
                    </div>
                </div>`;
            }
            // ×›×¨×˜×™×¡ ×”×–×× ×” (×™×¨×•×§)
            else if(m.type === 'order') {
                const safeName = (m.clientName||'').replace(/"/g,'&quot;');
                content = `
                <div class="order-card">
                    <div class="order-header">
                        <span class="text-green-800 font-bold"><i class="fas fa-box"></i> ×”×–×× ×”</span>
                        <span class="text-xs bg-white border px-1 rounded">${m.project||'×›×œ×œ×™'}</span>
                    </div>
                    <div class="order-body">${m.text}</div>
                    <div class="order-actions">
                        <div class="action-btn" onclick="window.updateStatus('${orderId}', 'work')"><i class="fas fa-tools text-blue-600"></i> ×œ×œ×™×§×•×˜</div>
                        <div class="action-btn" onclick="window.updateStatus('${orderId}', 'approved')"><i class="fas fa-check text-green-600"></i> ××•×›×Ÿ</div>
                        <div class="action-btn" onclick="window.printOrder('${safeName}','','${m.text.replace(/"/g,'&quot;').replace(/\n/g,'\\n')}','${msgId}','')"><i class="fas fa-print"></i> ×”×“×¤×¡</div>
                    </div>
                </div>`;
            }
            // ×”×•×“×¢×ª ××¢×¨×›×ª
            else if(m.type === 'system') {
                container.innerHTML += `<div class="msg-system">${m.text}</div>`; return;
            }

            container.innerHTML += `
            <div class="msg-bubble ${m.sender==='client'?'msg-in':'msg-out'} ${m.isVisibleToClient===false?'msg-internal':''}">
                <div>${content}</div>
                <div class="msg-meta">
                    <span>${new Date(m.createdAt?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                </div>
            </div>`;
        }

        // --- Helpers ---
        window.switchTab = (t) => {
            currentFilter = t;
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            // Trigger re-render handled by snapshot listener logic
        };

        window.updateStatus = async (oid, status) => {
            if(!confirm('×œ×¢×“×›×Ÿ ×¡×˜×˜×•×¡?')) return;
            await updateDoc(doc(db, "orders", oid), { status: status, lastUpdate: serverTimestamp() });
            const msg = status==='work' ? 'ğŸš§ ×¢×‘×¨ ×œ×œ×™×§×•×˜' : 'âœ… ×”×–×× ×” ××•×›× ×”';
            await addDoc(collection(db, `orders/${oid}/internal_chat`), { text: msg, type: 'system', sender: '××¢×¨×›×ª', createdAt: serverTimestamp(), isVisibleToClient: true });
        };

        window.sendMessage = async () => {
            const inp = document.getElementById('msgInput');
            const txt = inp.value.trim();
            if(!txt || !currentChatId) return;
            inp.value = '';
            await addDoc(collection(db, `orders/${currentChatId}/internal_chat`), {
                text: txt, sender: currentUser.name, createdAt: serverTimestamp(), isVisibleToClient: true
            });
        };

        // Document Fallback
        window.openDocSelector = () => {
            document.getElementById('docSelectModal').style.display='flex';
            document.getElementById('docsList').innerHTML = '<div class="p-4 text-center text-gray-400">×˜×•×¢×Ÿ... (×”×“××™×™×”)</div>';
            setTimeout(() => {
                const mocks = [{n:'××©×œ×•×— 881.pdf'},{n:'×—×©×‘×•× ×™×ª 400.pdf'}];
                document.getElementById('docsList').innerHTML = mocks.map(d=>`<div class="p-3 border-b hover:bg-gray-50 cursor-pointer font-bold text-sm text-gray-700" onclick="alert('×©×•×™×š')">${d.n}</div>`).join('');
            }, 1000);
        };
        
        window.printOrder = (n,p,t,i,d) => { const w=window.open('','','width=800,height=900'); w.document.write(`<html><body style="font-family:sans-serif;text-align:right;padding:40px;"><h1>×—.×¡×‘×Ÿ</h1><p>${n}</p><pre>${t}</pre><script>window.print()<\/script></body></html>`); w.document.close(); };
    </script>
</body>
</html>
