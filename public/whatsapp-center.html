<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>SabanOS | ×—×"×œ v35.1 (Fixed)</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body { background-color: #d1d7db; font-family: -apple-system, system-ui, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 30%; min-width: 360px; background: white; border-left: 1px solid #e9edef; display: flex; flex-direction: column; z-index: 20; }
        .main-chat { flex: 1; display: flex; flex-direction: column; background-color: #efeae2; position: relative; }
        
        .chat-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f2f5; cursor: pointer; transition: 0.2s; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }
        
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14px; margin-bottom: 8px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }
        .msg.staff { background: #d9fdd3; align-self: flex-end; }
        .msg.user { background: white; align-self: flex-start; }
        .msg.internal { background: #fff9c4; align-self: center; font-size: 12px; border: 1px dashed orange; }

        .tab-btn { flex: 1; text-align: center; padding: 15px; cursor: pointer; color: #54656f; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: #008069; border-bottom-color: #008069; background: #f0f2f5; }
        
        /* Modal & Popups */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 50; display: none; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; width: 600px; border-radius: 12px; padding: 20px; max-height: 85vh; overflow-y: auto; }
        
        /* Task Card */
        .task-card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-right: 4px solid #ccc; shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }
        .task-card:hover { transform: translateX(-2px); }
        .prio-high { border-right-color: #ef4444; } .prio-medium { border-right-color: #f59e0b; } .prio-low { border-right-color: #10b981; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4">
            <div class="flex items-center gap-2 cursor-pointer" onclick="handleLogout()">
                <img src="https://ui-avatars.com/api/?name=Admin&background=00a884&color=fff" class="w-10 h-10 rounded-full">
                <div><span class="font-bold text-gray-700 block text-sm">×—×"×œ ×¨××©×™</span><span class="text-[10px] text-green-600 font-bold">â— ××•× ×œ×™×™×Ÿ</span></div>
            </div>
            <button onclick="openTaskModal()" class="bg-blue-50 text-blue-600 p-2 rounded-full hover:bg-blue-100"><i class="fas fa-plus"></i></button>
        </div>

        <div class="flex border-b bg-gray-50 text-sm">
            <div onclick="switchTab('chats')" class="tab-btn active" id="tab-chats">ğŸ’¬ ×¦'××˜×™×</div>
            <div onclick="switchTab('tasks')" class="tab-btn" id="tab-tasks">ğŸ“‹ ××©×™××•×ª</div>
        </div>

        <div id="chatsList" class="flex-1 overflow-y-auto bg-white"></div>
        <div id="tasksList" class="flex-1 overflow-y-auto bg-gray-100 hidden p-2"></div>
    </div>

    <div id="chatArea" class="main-chat hidden">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4 shadow-sm z-10">
            <div class="flex items-center gap-3 cursor-pointer" onclick="openCRM()">
                <img id="activeAvatar" src="" class="w-10 h-10 rounded-full border">
                <div><div id="activeName" class="font-bold text-gray-800"></div><div class="text-xs text-gray-500">×œ×—×¥ ×œ×ª×™×§ ×œ×§×•×—</div></div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleBot()" id="botBtn" class="bg-white px-3 py-1 rounded text-xs font-bold shadow-sm">ğŸ¤– ×‘×•×˜ ×¤×¢×™×œ</button>
                <button onclick="openTaskModal(true)" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold shadow-sm">ğŸ“‹ ××©×™××”</button>
            </div>
        </div>

        <div id="messagesBox" class="flex-1 overflow-y-auto flex flex-col p-4 gap-2"></div>

        <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t">
            <i onclick="toggleInternalMode()" id="internalBtn" class="fas fa-eye-slash text-xl text-gray-400 cursor-pointer p-2" title="×”×¢×¨×” ×¤× ×™××™×ª"></i>
            <div class="flex-1"><input type="text" id="msgInput" class="w-full p-3 rounded-xl border-none outline-none shadow-sm text-sm" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key === 'Enter') sendMessage()"></div>
            <button onclick="sendMessage()" class="w-10 h-10 bg-[#00a884] text-white rounded-full shadow flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="crmModal" class="modal-overlay"><div class="modal-box"><h2 class="text-lg font-bold mb-4">×ª×™×§ ×œ×§×•×—</h2><div class="space-y-4"><div class="flex gap-4"><img id="crmAvatar" class="w-16 h-16 rounded-full"><div class="flex-1"><input id="crmName" class="w-full border p-1 rounded font-bold mb-1"><input id="crmPhone" class="w-full border p-1 rounded text-sm"></div></div><div class="bg-gray-50 p-3 rounded border"><h3 class="font-bold text-xs mb-2">×¤×¨×•×™×§×˜×™×</h3><div id="crmProjects"></div><button onclick="addProjectRow()" class="text-xs text-blue-600 mt-2">+ ×”×•×¡×£</button></div><button onclick="saveCRM()" class="w-full bg-green-600 text-white py-2 rounded font-bold">×©××•×¨</button><button onclick="closeModal('crmModal')" class="w-full text-gray-500 mt-2">×¡×’×•×¨</button></div></div></div>

    <div id="taskModal" class="modal-overlay"><div class="modal-box"><h2 class="text-lg font-bold mb-4">××©×™××” ×—×“×©×”</h2><div class="space-y-3"><input id="tTitle" class="w-full border p-2 rounded" placeholder="×›×•×ª×¨×ª"><select id="tAssign" class="w-full border p-2 rounded"><option value="rami">×¨××™</option><option value="nat">× ×ª× ××œ</option><option value="driver">× ×”×’</option></select><select id="tPrio" class="w-full border p-2 rounded"><option value="low">×¨×’×™×œ</option><option value="high">×“×—×•×£</option></select><input id="tDate" class="w-full border p-2 rounded" placeholder="×ª××¨×™×š"><textarea id="tDesc" class="w-full border p-2 rounded h-20" placeholder="×ª×™××•×¨..."></textarea></div><div class="flex justify-end gap-2 mt-4"><button onclick="closeModal('taskModal')" class="text-gray-500">×‘×™×˜×•×œ</button><button onclick="createTask()" class="bg-blue-600 text-white px-4 py-2 rounded">×¦×•×¨</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { SabanPush } from './js/notifications.js';
        import { SabanChatbot } from './js/chatbot-engine.js'; 
        import { TaskEngine } from './js/task-engine.js'; 

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let activeChatId = null;
        let activeUser = null;
        let internalMode = false;
        let botEnabled = true;
        let bot = null;

        SabanPush.init('admin', 'admin_rami');
        flatpickr("#tDate", { enableTime: true, dateFormat: "Y-m-d H:i", minDate: "today" });

        // --- CHATS ---
        onSnapshot(query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc")), (snap) => {
            const list = document.getElementById('chatsList'); list.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const active = activeChatId === d.id ? 'active' : '';
                list.innerHTML += `<div onclick="openChat('${d.id}', '${c.userName}')" class="chat-item ${active}"><img src="https://ui-avatars.com/api/?name=${c.userName}&background=random&color=fff" class="w-10 h-10 rounded-full ml-3"><div class="flex-1 min-w-0"><div class="font-bold text-sm">${c.userName}</div><div class="text-xs text-gray-500 truncate">${c.lastMessage}</div></div></div>`;
            });
        });

        // --- TASKS ---
        onSnapshot(query(collection(db, "tasks"), orderBy("createdAt", "desc")), (snap) => {
            const list = document.getElementById('tasksList'); list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                const prio = t.priority === 'high' ? 'prio-high' : 'prio-low';
                list.innerHTML += `<div class="task-card ${prio}"><div class="font-bold text-xs">${t.title}</div><div class="text-[10px] text-gray-500 flex justify-between mt-1"><span>×¢×‘×•×¨: ${t.toUid}</span><span>${t.status}</span></div></div>`;
            });
        });

        window.openChat = async (id, name) => {
            activeChatId = id;
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('activeName').innerText = name;
            
            try {
                const uSnap = await getDoc(doc(db, "users", id));
                if(uSnap.exists()) activeUser = { id: id, ...uSnap.data() };
                else activeUser = { id: id, name, role: '×œ×§×•×—', projects: [] };
                document.getElementById('activeAvatar').src = activeUser.avatar || `https://ui-avatars.com/api/?name=${name}`;
                
                // ××ª×—×•×œ ×‘×•×˜
                bot = new SabanChatbot(db, activeUser);
            } catch(e) {}

            onSnapshot(query(collection(db, `chat_sessions/${id}/messages`), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('messagesBox');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const style = m.role === 'internal' ? 'msg internal' : (m.role === 'staff' ? 'msg staff' : 'msg user');
                    return `<div class="${style}">${m.role==='internal'?'ğŸ”’ ':''}${m.text}</div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMessage = async () => {
            const txt = document.getElementById('msgInput').value; if(!txt) return;
            document.getElementById('msgInput').value = '';
            
            const role = internalMode ? 'internal' : 'staff';
            await addDoc(collection(db, `chat_sessions/${activeChatId}/messages`), { text: txt, role: role, sender: "×¨××™", createdAt: serverTimestamp() });
            
            if(!internalMode) {
                updateDoc(doc(db, "chat_sessions", activeChatId), { lastMessage: `× ×¦×™×’: ${txt}`, lastActivity: serverTimestamp(), isBotActive: botEnabled });
                // ×‘×•×˜ ××’×™×‘ ×× ×¦×¨×™×š (×œ××©×œ ×× ×”× ×¦×™×’ ×›×ª×‘ ×¤×§×•×“×”)
                // if(bot && botEnabled) ... 
            }
            if(internalMode) window.toggleInternalMode();
        };

        // --- CRM & TASKS ---
        window.openCRM = () => {
            if(!activeUser) return;
            document.getElementById('crmName').value = activeUser.name;
            document.getElementById('crmPhone').value = activeUser.phone||'';
            document.getElementById('crmAvatar').src = activeUser.avatar||'';
            const pBox = document.getElementById('crmProjects');
            pBox.innerHTML = (activeUser.projects||[]).map((p,i)=>`<div class="flex gap-2 mb-1"><input class="border text-xs w-full p-1" value="${p.name}" onchange="updProj(${i},'name',this.value)"></div>`).join('');
            document.getElementById('crmModal').classList.add('open');
        };
        window.updProj = (i,f,v) => activeUser.projects[i][f]=v;
        window.addProjectRow = () => { if(!activeUser.projects) activeUser.projects=[]; activeUser.projects.push({name:'×—×“×©',address:''}); window.openCRM(); };
        window.saveCRM = async () => { await updateDoc(doc(db,"users",activeUser.id), {name:document.getElementById('crmName').value, phone:document.getElementById('crmPhone').value, projects:activeUser.projects}); closeModal('crmModal'); };

        window.openTaskModal = (fromCRM=false) => { if(fromCRM) closeModal('crmModal'); if(!activeUser) return alert("×‘×—×¨ ×œ×§×•×—"); document.getElementById('tTitle').value=`×¢×‘×•×¨: ${activeUser.name}`; document.getElementById('taskModal').classList.add('open'); };
        window.createTask = async () => {
            await TaskEngine.createTask(db, {
                title: document.getElementById('tTitle').value, desc: document.getElementById('tDesc').value, toUid: document.getElementById('tAssign').value, priority: document.getElementById('tPrio').value, dueDate: document.getElementById('tDate').value, status:'open'
            });
            await addDoc(collection(db, `chat_sessions/${activeUser.id}/messages`), { text: `ğŸ“‹ × ×•×¦×¨×” ××©×™××”: ${document.getElementById('tTitle').value}`, role: 'internal', createdAt: serverTimestamp() });
            closeModal('taskModal');
        };

        window.switchTab = (t) => {
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active');
            document.getElementById('chatsList').classList.add('hidden'); document.getElementById('tasksList').classList.add('hidden');
            document.getElementById(`${t}List`).classList.remove('hidden');
        };
        window.toggleInternalMode = () => { internalMode=!internalMode; document.getElementById('msgInput').placeholder = internalMode?"×”×¢×¨×” ×¤× ×™××™×ª...":"×”×§×œ×“..."; document.getElementById('internalBtn').className = internalMode?"fas fa-eye-slash text-xl text-orange-500 p-2":"fas fa-eye text-xl text-gray-400 p-2"; };
        window.toggleBot = () => { botEnabled=!botEnabled; document.getElementById('botBtn').innerHTML = botEnabled ? 'ğŸ¤– ×‘×•×˜ ×¤×¢×™×œ' : 'ğŸ¤– ×‘×•×˜ ×›×‘×•×™'; };
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');
        window.handleLogout = async () => { if(confirm("×œ×¦××ª?")) { localStorage.clear(); await signOut(auth); location.href="index.html"; } };

    </script>
</body>
</html>
