<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>SabanConnect | ×—×ž"×œ v22.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #d1d7db; font-family: sans-serif; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 30%; max-width: 400px; background: white; border-left: 1px solid #e9edef; }
        .main-chat { flex: 1; background: #efeae2; display: flex; flex-direction: column; }
        .chat-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f2f5; }
        .chat-item:hover { background: #f5f6f6; }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; background: white; align-self: flex-start; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.staff { background: #d9fdd3; align-self: flex-end; }
        .msg.internal { background: #fff9c4; align-self: center; font-size: 12px; border: 1px dashed orange; }
        .tag { background: #ffedd5; color: #c2410c; padding: 0 4px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="sidebar flex flex-col">
        <div class="h-16 bg-[#f0f2f5] p-4 font-bold border-b">×—×ž"×œ ×”×–×ž× ×•×ª</div>
        <div id="chatList" class="flex-1 overflow-y-auto"></div>
    </div>
    <div id="chatArea" class="main-chat hidden">
        <div class="h-16 bg-[#f0f2f5] px-4 flex justify-between items-center shadow-sm">
            <div id="activeName" class="font-bold"></div>
            <button onclick="toggleBot()" id="botBtn" class="bg-white px-3 py-1 rounded shadow text-xs font-bold">ðŸ¤– ×‘×•×˜ ×¤×¢×™×œ</button>
        </div>
        <div id="messagesBox" class="flex-1 p-4 overflow-y-auto flex flex-col"></div>
        <div class="bg-[#f0f2f5] p-3 flex gap-2">
            <button onclick="toggleInternal()" id="intBtn" class="text-gray-400"><i class="fas fa-lock"></i></button>
            <input id="msgInput" class="flex-1 p-2 rounded" placeholder="×”×§×œ×“...">
            <button onclick="send()" class="text-[#00a884]"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const app = initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" });
        const db = getFirestore(app);
        let activeId = null, internal = false, botActive = true;

        onSnapshot(query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc")), (snap) => {
            document.getElementById('chatList').innerHTML = snap.docs.map(d => {
                const c = d.data();
                return `<div onclick="openChat('${d.id}','${c.userName}')" class="chat-item">
                    <div class="font-bold">${c.userName}</div><div class="text-sm text-gray-500 truncate">${c.lastMessage}</div>
                </div>`;
            }).join('');
        });

        window.openChat = (id, name) => {
            activeId = id; document.getElementById('chatArea').classList.remove('hidden'); document.getElementById('activeName').innerText = name;
            onSnapshot(query(collection(db, `chat_sessions/${id}/messages`), orderBy("createdAt", "asc")), (snap) => {
                document.getElementById('messagesBox').innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    let txt = m.text.replace(/@([\w\u0590-\u05FF]+)/g, '<span class="tag">@$1</span>');
                    return `<div class="msg ${m.role}">${m.role==='internal'?'ðŸ”’ ':''}${txt}</div>`;
                }).join('');
            });
            // Listen to bot status
            onSnapshot(doc(db, "chat_sessions", id), (s) => {
                botActive = s.data().isBotActive;
                const btn = document.getElementById('botBtn');
                btn.innerText = botActive ? "ðŸ¤– ×‘×•×˜ ×¤×¢×™×œ" : "ðŸ›‘ ×™×“× ×™";
                btn.className = botActive ? "bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold" : "bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold";
            });
        };

        window.send = async () => {
            const txt = document.getElementById('msgInput').value; if(!txt) return;
            await addDoc(collection(db, `chat_sessions/${activeId}/messages`), { text: txt, role: internal?'internal':'staff', createdAt: serverTimestamp() });
            if(!internal) await updateDoc(doc(db, "chat_sessions", activeId), { lastMessage: `× ×¦×™×’: ${txt}`, lastActivity: serverTimestamp(), isBotActive: false });
            document.getElementById('msgInput').value = '';
        };
        window.toggleBot = () => updateDoc(doc(db, "chat_sessions", activeId), { isBotActive: !botActive });
        window.toggleInternal = () => { internal = !internal; document.getElementById('intBtn').className = internal ? "text-orange-500" : "text-gray-400"; document.getElementById('msgInput').placeholder = internal ? "×”×¢×¨×” ×¤× ×™×ž×™×ª..." : "×”×§×œ×“..."; };
    </script>
</body>
</html>
