<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabanConnect | " 转 v22.1</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #d1d7db; font-family: -apple-system, system-ui, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 30%; max-width: 400px; background: white; border-left: 1px solid #e9edef; display: flex; flex-direction: column; }
        .main-chat { flex: 1; display: flex; flex-direction: column; background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); }
        
        .chat-item { display: flex; align-items: center; padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f2f5; transition: 0.2s; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }
        
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.4; margin-bottom: 8px; }
        .msg-user { align-self: flex-start; background: #fff; border-top-right-radius: 0; }
        .msg-staff { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-internal { align-self: center; background: #fff9c4; border: 1px dashed #d97706; font-size: 12px; }
        .msg-time { font-size: 10px; color: #999; text-align: left; margin-top: 3px; }

        /* 拽专  */
        .bot-status-on { background-color: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .bot-status-off { background-color: #f3f4f6; color: #6b7280; border: 1px solid #e5e7eb; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4">
            <div class="flex items-center gap-2">
                <img src="https://ui-avatars.com/api/?name=Admin&background=00a884&color=fff" class="w-10 h-10 rounded-full">
                <span class="font-bold text-gray-700">" 转</span>
            </div>
            <div class="text-xs text-gray-400">v22.1</div>
        </div>
        <div id="chatList" class="flex-1 overflow-y-auto bg-white custom-scroll"></div>
    </div>

    <div id="chatArea" class="main-chat hidden">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4 shadow-sm z-10">
            <div class="flex items-center gap-3">
                <img id="activeAvatar" src="" class="w-10 h-10 rounded-full border border-gray-300">
                <div class="cursor-pointer">
                    <div id="activeName" class="font-bold text-gray-800 leading-tight"></div>
                    <div class="text-xs text-gray-500">专</div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div id="botStatusBadge" class="hidden md:flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold transition-colors bot-status-off">
                    <span id="botStatusDot" class="w-2 h-2 rounded-full bg-gray-400"></span>
                    <span id="botStatusText"> </span>
                </div>
                <button onclick="toggleBot()" class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm transition active:scale-95 flex items-center gap-2">
                    <i class="fas fa-robot"></i> <span class="hidden sm:inline">驻注/</span>
                </button>
            </div>
        </div>

        <div id="messagesBox" class="flex-1 overflow-y-auto flex flex-col p-4"></div>

        <div class="bg-[#f0f2f5] p-3 flex items-center gap-3 border-t">
            <i onclick="toggleInternalMode()" id="internalBtn" class="fas fa-eye-slash text-xl text-gray-400 cursor-pointer hover:scale-110 transition" title="注专 驻转 ( 转砖 拽)"></i>
            <div class="flex-1 relative">
                <input type="text" id="msgInput" class="w-full p-3 rounded-xl border-none outline-none shadow-sm text-sm" placeholder="拽 注..." onkeydown="if(event.key === 'Enter') sendMessage()">
            </div>
            <button onclick="sendMessage()" class="w-10 h-10 flex items-center justify-center text-gray-500 hover:text-[#00a884] transition"><i class="fas fa-paper-plane text-xl"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let activeChatId = null;
        let internalMode = false;
        let currentBotState = false;
        let activeChatListener = null; // 砖专转  住住 

        // --- 1. 注转 专砖转 爪' ---
        const q = query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('chatList');
            list.innerHTML = "";
            snapshot.forEach(docSnap => {
                const chat = { id: docSnap.id, ...docSnap.data() };
                const time = chat.lastActivity ? new Date(chat.lastActivity.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                const active = activeChatId === chat.id ? 'active' : '';
                const botIcon = chat.isBotActive ? '<i class="fas fa-robot text-green-500 text-xs ml-1" title=" 驻注"></i>' : '';
                
                list.innerHTML += `
                <div onclick="openChat('${chat.id}', '${chat.userName}')" class="chat-item ${active}">
                    <div class="relative">
                        <img src="https://ui-avatars.com/api/?name=${chat.userName}&background=random&color=fff" class="w-12 h-12 rounded-full ml-3 shadow-sm">
                        ${chat.isBotActive ? '<div class="absolute bottom-0 right-3 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between mb-1"><span class="font-bold text-gray-800 text-sm flex items-center">${chat.userName} ${botIcon}</span><span class="text-xs text-gray-400">${time}</span></div>
                        <div class="text-sm text-gray-500 truncate dir-rtl">${chat.lastMessage || ''}</div>
                    </div>
                </div>`;
            });
        });

        // --- 2. 驻转转 爪'  ---
        window.openChat = (chatId, name) => {
            activeChatId = chatId;
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('activeName').innerText = name;
            document.getElementById('activeAvatar').src = `https://ui-avatars.com/api/?name=${name}&background=random&color=fff`;
            
            // 拽  拽转 住住   拽转
            if(activeChatListener) activeChatListener();

            //  住住  砖 爪' 住驻爪驻 
            activeChatListener = onSnapshot(doc(db, "chat_sessions", chatId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentBotState = data.isBotActive || false;
                    updateBotUI(currentBotState);
                }
            });

            //  注转
            const msgQ = query(collection(db, `chat_sessions/${chatId}/messages`), orderBy("createdAt", "asc"));
            onSnapshot(msgQ, (snapshot) => {
                const box = document.getElementById('messagesBox');
                box.innerHTML = "";
                snapshot.forEach(doc => {
                    const m = doc.data();
                    const time = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                    
                    if (m.role === 'internal') {
                        box.innerHTML += `<div class="msg msg-internal flex flex-col items-center"><div class="flex items-center gap-2 font-bold text-orange-700 mb-1"><i class="fas fa-lock"></i> 注专 驻转</div>${m.text}<div class="msg-time self-end">${time}</div></div>`;
                    } else {
                        const type = m.role === 'user' ? 'msg-user' : 'msg-staff';
                        //     砖注
                        const isBotMsg = m.sender === 'bot' || m.text.includes("SabanAI");
                        const badge = isBotMsg ? '<span class="text-[10px] text-green-600 font-bold block mb-1"><i class="fas fa-robot"></i> SabanAI</span>' : '';
                        
                        box.innerHTML += `<div class="msg ${type}">${badge}${m.text}<div class="msg-time">${time}</div></div>`;
                    }
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        // --- 3. 注 砖拽  ( ) ---
        function updateBotUI(isActive) {
            const badge = document.getElementById('botStatusBadge');
            const dot = document.getElementById('botStatusDot');
            const text = document.getElementById('botStatusText');
            
            if (isActive) {
                badge.className = "hidden md:flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold transition-colors bot-status-on";
                dot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                text.innerText = " 驻注";
            } else {
                badge.className = "hidden md:flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold transition-colors bot-status-off";
                dot.className = "w-2 h-2 rounded-full bg-gray-400";
                text.innerText = "  ()";
            }
        }

        // --- 4. 驻转专 驻转 爪  ---
        window.toggleBot = async () => {
            if (!activeChatId) return;
            const newState = !currentBotState;
            // 注 -Firebase - 砖拽 转注 转 专 -onSnapshot
            await updateDoc(doc(db, "chat_sessions", activeChatId), { 
                isBotActive: newState,
                lastActivity: serverTimestamp() // 拽驻抓 转 砖 注  砖转专 砖驻转 
            });
            // 注转 注专转 拽 爪' (驻爪, 注专 注拽)
            const statusMsg = newState ? "  驻注 砖" : "  砖 - 砖 转";
            await addDoc(collection(db, `chat_sessions/${activeChatId}/messages`), {
                text: statusMsg,
                role: 'internal',
                sender: 'system',
                createdAt: serverTimestamp()
            });
        };

        // --- 5. 砖转 注 ---
        window.sendMessage = async () => {
            const input = document.getElementById('msgInput');
            const txt = input.value;
            if (!txt || !activeChatId) return;
            
            const role = internalMode ? 'internal' : 'staff';
            input.value = '';

            // 砖转 注
            await addDoc(collection(db, `chat_sessions/${activeChatId}/messages`), { 
                text: txt, 
                role: role, 
                sender: role === 'internal' ? "System" : "爪", 
                createdAt: serverTimestamp() 
            });

            // 注 砖 -  注转 爪 ( 驻),  砖转转拽 转!
            const updateData = {
                lastMessage: role === 'internal' ? ' 注专 驻转' : `爪: ${txt}`,
                lastActivity: serverTimestamp()
            };
            
            //   转砖 拽 ( 驻转),   转   砖 转注专
            if (role !== 'internal') {
                updateData.isBotActive = false;
            }

            await updateDoc(doc(db, "chat_sessions", activeChatId), updateData);
            
            // 爪 爪 驻
            if(internalMode) toggleInternalMode();
            document.getElementById('msgInput').focus();
        };

        window.toggleInternalMode = () => {
            internalMode = !internalMode;
            const btn = document.getElementById('internalBtn');
            const input = document.getElementById('msgInput');
            if (internalMode) {
                btn.classList.replace('text-gray-400', 'text-orange-500');
                input.classList.add('bg-orange-50', 'text-orange-900', 'placeholder-orange-400');
                input.placeholder = " 转转 注专 驻转 爪转...";
            } else {
                btn.classList.replace('text-orange-500', 'text-gray-400');
                input.classList.remove('bg-orange-50', 'text-orange-900', 'placeholder-orange-400');
                input.placeholder = "拽 注 拽...";
            }
            input.focus();
        };
    </script>
</body>
</html>
