<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×§×‘×•×¦×ª ×”×–×× ×•×ª ×—.×¡×‘×Ÿ</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        body { background-color: #d1d7db; font-family: -apple-system, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 30%; min-width: 360px; background: white; border-left: 1px solid #e9edef; display: flex; flex-direction: column; }
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #efeae2 url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; }
        .chat-item { display: flex; align-items: center; padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f2f5; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }
        /* Rings */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
        .ring-green { border: 3px solid #10b981; }
        .ring-orange { border: 3px dashed #f59e0b; }
        .ring-red { border: 3px solid #ef4444; animation: pulse-red 1.5s infinite; }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; margin: 4px 20px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); width: fit-content; }
        .msg.staff { background: #d9fdd3; align-self: flex-end; }
        .msg.user { background: white; align-self: flex-start; }
        .msg.internal { background: #fff9c4; align-self: center; font-size: 12px; border: 1px dashed #eab308; text-align: center; width: 80%; }
        #stickyNote { position: absolute; top: 70px; right: 20px; width: 220px; background: #fef08a; padding: 10px; box-shadow: 4px 4px 10px rgba(0,0,0,0.2); transform: rotate(-2deg); z-index: 10; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="sidebar">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4">
            <div class="font-bold text-gray-700">×§×‘×•×¦×ª ×”×–×× ×•×ª ×—.×¡×‘×Ÿ</div>
            <div class="flex gap-2">
                <button onclick="localStorage.clear(); location.href='index.html'" class="text-gray-500"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        <div id="chatsList" class="flex-1 overflow-y-auto"></div>
    </div>

    <div id="chatArea" class="main-chat hidden">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4 shadow-sm z-20">
            <div class="flex items-center gap-3">
                <img id="activeAvatar" src="" class="w-10 h-10 rounded-full bg-white border">
                <div id="activeName" class="font-bold"></div>
            </div>
            <button onclick="promptLinkOrder()" class="bg-orange-100 text-orange-700 px-3 py-1 rounded font-bold border border-orange-300 shadow-sm hover:bg-orange-200 transition">ğŸ”— ×§×©×•×¨ ×”×–×× ×”</button>
        </div>

        <div id="stickyNote" class="hidden">
            <div class="flex justify-between mb-1 border-b border-yellow-300 pb-1">
                <span class="font-bold text-xs text-yellow-800">ğŸ“Œ ×¤×ª×§ ×¤× ×™××™</span>
                <i class="fas fa-times cursor-pointer hover:text-red-500" onclick="this.parentElement.parentElement.classList.add('hidden')"></i>
            </div>
            <textarea class="w-full bg-transparent outline-none text-sm resize-none text-gray-700" rows="4" placeholder="×”×¢×¨×•×ª ×œ×˜×™×¤×•×œ..."></textarea>
        </div>

        <div id="messagesBox" class="flex-1 overflow-y-auto flex flex-col p-4"></div>

        <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t z-20">
            <i onclick="document.getElementById('stickyNote').classList.remove('hidden')" class="fas fa-sticky-note text-yellow-500 cursor-pointer text-2xl p-1 hover:scale-110 transition" title="×¤×ª×§"></i>
            <i onclick="toggleInternal()" id="internalBtn" class="fas fa-eye-slash text-gray-400 cursor-pointer text-2xl p-1 hover:text-orange-500 transition" title="×”×¢×¨×” ×¤× ×™××™×ª"></i>
            <input type="text" id="msgInput" class="flex-1 p-3 rounded-lg border-none outline-none shadow-inner" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="text-[#008069] text-3xl hover:scale-110 transition"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanSounds } from './js/sounds.js';

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let activeChatId = null;
        let internalMode = false;

        // Audio Unlock
        window.unlockAudio = () => {
            const a = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAGZGF0YQQAAAAAAA==");
            a.play().catch(()=>{});
        };

        onSnapshot(query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc")), (snap) => {
            const list = document.getElementById('chatsList'); list.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const lastMsg = c.lastMessage || "";
                let ring = "ring-green";
                
                // Color & Sound Logic
                if(lastMsg.includes("×××ª×™×Ÿ")) ring = "ring-orange";
                if(lastMsg.includes("ğŸ›‘") || lastMsg.includes("×“×—×•×£") || lastMsg.includes("×¢×¦×•×¨")) { 
                    ring = "ring-red"; 
                    SabanSounds.playAlert(); // ğŸ”Š ××–×¢×§×”
                } else if (!c.lastMsgFromStaff) {
                    // ×¦×œ×™×œ ×¨×’×™×œ ×œ×”×•×“×¢×” ×—×“×©×” ××œ×§×•×—
                    SabanSounds.playMessage();
                }

                list.innerHTML += `<div onclick="openChat('${d.id}', '${c.userName}', '${c.avatar}')" class="chat-item ${activeChatId===d.id?'active':''}">
                    <img src="${c.avatar || 'https://ui-avatars.com/api/?name='+c.userName}" class="w-12 h-12 rounded-full ${ring} object-cover ml-3 p-0.5 shadow-sm">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-gray-800">${c.userName}</div>
                        <div class="text-xs text-gray-500 truncate">${lastMsg}</div>
                    </div>
                </div>`;
            });
        });

        window.openChat = (id, name, avatar) => {
            activeChatId = id;
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('activeName').innerText = name;
            document.getElementById('activeAvatar').src = avatar || `https://ui-avatars.com/api/?name=${name}`;
            
            onSnapshot(query(collection(db, `chat_sessions/${id}/messages`), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('messagesBox');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    let cls = m.role==='staff' ? 'msg staff' : 'msg user';
                    if(m.role==='internal') cls = 'msg internal';
                    return `<div class="${cls}">
                        ${m.role==='internal'?'<div class="text-[10px] text-orange-600 font-bold mb-1">ğŸ”’ ×¤× ×™××™</div>':''}
                        ${m.text}
                        <div class="text-[9px] text-gray-400 mt-1 text-left opacity-70">${new Date(m.createdAt?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                    </div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMessage = async () => {
            const txt = document.getElementById('msgInput').value; if(!txt || !activeChatId) return;
            document.getElementById('msgInput').value = '';
            await addDoc(collection(db, `chat_sessions/${activeChatId}/messages`), { 
                text: txt, role: internalMode ? 'internal' : 'staff', sender: "×—×\"×œ", createdAt: serverTimestamp() 
            });
            if(!internalMode) updateDoc(doc(db, "chat_sessions", activeChatId), { lastMessage: `× ×¦×™×’: ${txt}`, lastActivity: serverTimestamp(), lastMsgFromStaff: true });
            if(internalMode) window.toggleInternal();
        };

        window.toggleInternal = () => { 
            internalMode=!internalMode; 
            const inp = document.getElementById('msgInput');
            const btn = document.getElementById('internalBtn');
            if(internalMode) {
                inp.placeholder = "×”×¢×¨×” ×¤× ×™××™×ª (××•×¡×ª×¨ ××”×œ×§×•×—)...";
                inp.classList.add('bg-yellow-50');
                btn.className = "fas fa-eye-slash text-orange-500 text-2xl p-1";
            } else {
                inp.placeholder = "×”×§×œ×“ ×”×•×“×¢×”...";
                inp.classList.remove('bg-yellow-50');
                btn.className = "fas fa-eye text-gray-400 text-2xl p-1";
            }
        };
        
        window.promptLinkOrder = async () => {
            const id = prompt("×”×–×Ÿ ××¡×¤×¨ ×”×–×× ×” ××§×•××§×¡:");
            if(!id) return;
            await setDoc(doc(db, "active_orders", id), { clientUid: activeChatId, status: "waiting", createdAt: serverTimestamp() });
            await addDoc(collection(db, `chat_sessions/${activeChatId}/messages`), { text: `â³ ×××ª×™×Ÿ ×œ××¡××š ×”×–×× ×” <b>${id}</b>...`, role: 'internal', createdAt: serverTimestamp() });
            updateDoc(doc(db, "chat_sessions", activeChatId), { lastMessage: `×××ª×™×Ÿ ×œ××¡××š ${id}`, lastActivity: serverTimestamp(), lastMsgFromStaff: true });
        };
    </script>
</body>
</html>
