<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabanConnect | ×—×"×œ ×× ×˜×¨×¤×¨×™×™×– (Diamond Edition)</title>
    
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        /* --- ×¢×™×¦×•×‘ ×‘×¡×™×¡ --- */
        body { background-color: #d1d7db; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* ×¡×¨×’×œ ×¦×“ */
        .sidebar { width: 30%; min-width: 360px; background: white; border-left: 1px solid #e9edef; display: flex; flex-direction: column; z-index: 20; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .sidebar-header { height: 64px; background: #f0f2f5; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #d1d7db; flex-shrink: 0; }
        
        /* ×˜××‘×™× */
        .sidebar-tabs { display: flex; border-bottom: 1px solid #e9edef; background: #fff; flex-shrink: 0; }
        .tab-btn { flex: 1; text-align: center; padding: 14px; cursor: pointer; color: #54656f; font-weight: 500; border-bottom: 3px solid transparent; transition: 0.2s; font-size: 14px; }
        .tab-btn:hover { background: #f5f6f6; }
        .tab-btn.active { color: #008069; border-bottom-color: #008069; background: #f0f2f5; font-weight: bold; }

        /* ×¨×©×™××•×ª */
        .list-container { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f0f2f5; transition: 0.2s; position: relative; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }
        
        /* ××–×•×¨ ×¦'××˜ ×¨××©×™ */
        .main-chat { flex: 1; display: flex; flex-direction: column; background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; }
        .chat-header { height: 64px; background: #f0f2f5; padding: 0 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #d1d7db; z-index: 10; flex-shrink: 0; }
        
        /* ×‘×•×¢×•×ª ×”×•×“×¢×” */
        .messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; background: white; align-self: flex-start; }
        .msg.staff { background: #d9fdd3; align-self: flex-end; border-top-left-radius: 0; }
        .msg.user { background: white; align-self: flex-start; border-top-right-radius: 0; }
        .msg.internal { background: #fff9c4; align-self: center; font-size: 12px; border: 1px dashed #eab308; text-align: center; width: 80%; border-radius: 6px; }
        
        /* ×›×œ×™ ×¢×¨×™×›×” ×•×¡×˜×˜×•×¡ */
        .chat-footer { background: #f0f2f5; padding: 10px 16px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #d1d7db; flex-shrink: 0; }
        
        /* ×× ×™××¦×™×™×ª ×¡×˜×•×¨×™ (×”×˜×‘×¢×•×ª) */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .story-ring { padding: 2px; border-radius: 50%; border: 3px solid transparent; transition: all 0.3s; object-fit: cover; }
        .ring-green { border-color: #10b981; } 
        .ring-orange { border-color: #f59e0b; border-style: dashed; } 
        .ring-red { border-color: #ef4444; animation: pulse-red 1.5s infinite; }

        /* ×›×¨×˜×™×¡×™ ××©×™××•×ª */
        .task-card { background: white; padding: 14px; border-radius: 8px; border-left: 4px solid #ccc; margin: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .prio-high { border-left-color: #ef4444; } .prio-medium { border-left-color: #f59e0b; } .prio-low { border-left-color: #10b981; }

        /* ××•×“××œ×™× */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal-box { background: white; width: 500px; max-width: 90%; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="flex items-center gap-3 cursor-pointer" onclick="handleLogout()">
                <img src="https://ui-avatars.com/api/?name=Admin&background=00a884&color=fff" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                <div>
                    <div class="font-bold text-gray-800 text-sm">×”×¨××œ - ×× ×›"×œ</div>
                    <div class="text-[10px] text-green-600 font-bold flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> ××•× ×œ×™×™×Ÿ</div>
                </div>
            </div>
            <div class="flex gap-2 text-gray-500">
                <button onclick="openGroupModal()" title="×§×‘×•×¦×” ×—×“×©×”" class="p-2 hover:bg-gray-200 rounded-full transition"><i class="fas fa-users"></i></button>
                <button onclick="switchTab('tasks')" title="××©×™××•×ª" class="p-2 hover:bg-gray-200 rounded-full transition"><i class="fas fa-tasks"></i></button>
            </div>
        </div>

        <div class="sidebar-tabs">
            <div onclick="switchTab('chats')" class="tab-btn active" id="tab-chats">ğŸ’¬ ×¦'××˜×™×</div>
            <div onclick="switchTab('tasks')" class="tab-btn" id="tab-tasks">ğŸ“‹ ××©×™××•×ª</div>
            <div onclick="switchTab('groups')" class="tab-btn" id="tab-groups">ğŸ“¢ ×§×‘×•×¦×•×ª</div>
        </div>

        <div class="p-2 bg-white border-b border-gray-100">
            <div class="bg-[#f0f2f5] rounded-lg flex items-center px-3 py-1.5 transition focus-within:bg-white focus-within:shadow-sm focus-within:ring-1 ring-green-500">
                <i class="fas fa-search text-gray-500 text-xs"></i>
                <input type="text" placeholder="×—×™×¤×•×© ××• ×”×ª×—×œ×ª ×¦'××˜..." class="bg-transparent border-none outline-none text-sm w-full px-2" oninput="filterChats(this.value)">
            </div>
        </div>

        <div id="chatsList" class="list-container custom-scroll"></div>
        <div id="tasksList" class="list-container hidden custom-scroll bg-[#f0f2f5]"></div>
        <div id="groupsList" class="list-container hidden custom-scroll"></div>
    </div>

    <div id="chatArea" class="main-chat hidden">
        <div class="chat-header">
            <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-100 p-2 rounded transition" onclick="openCRM()">
                <img id="activeAvatar" src="" class="w-10 h-10 rounded-full object-cover border shadow-sm">
                <div>
                    <div id="activeName" class="font-bold text-gray-800 leading-tight"></div>
                    <div id="activeDesc" class="text-xs text-gray-500">×œ×—×¥ ×œ×¤×¨×˜×™ ×œ×§×•×—</div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="promptLinkOrder()" class="bg-orange-50 text-orange-700 hover:bg-orange-100 border border-orange-200 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition flex items-center gap-2">
                    <i class="fas fa-link"></i> ×§×©×•×¨ ×”×–×× ×”
                </button>
                
                <button onclick="toggleBot()" id="botBtn" class="bg-white hover:bg-gray-50 border px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600 shadow-sm transition">
                    <i class="fas fa-robot text-green-600"></i> ×‘×•×˜ ×¤×¢×™×œ
                </button>
                
                <button onclick="openTaskModal(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm flex items-center gap-2 transition">
                    <i class="fas fa-check-circle"></i> ××©×™××”
                </button>
            </div>
        </div>

        <div id="messagesBox" class="messages-container custom-scroll"></div>

        <div id="stickyNote" class="hidden absolute top-20 right-4 w-56 bg-yellow-100 p-3 rounded-lg shadow-md border border-yellow-300 text-sm transform rotate-1 z-10">
            <div class="flex justify-between text-yellow-800 mb-1 border-b border-yellow-200 pb-1">
                <span class="font-bold text-xs"><i class="fas fa-sticky-note"></i> ×¤×ª×§ ×¤× ×™××™</span>
                <i onclick="document.getElementById('stickyNote').classList.add('hidden')" class="fas fa-times cursor-pointer hover:text-red-500"></i>
            </div>
            <textarea class="w-full bg-transparent outline-none resize-none text-gray-700 text-xs" rows="4" placeholder="×¨×©×•× ×”×¢×¨×•×ª ×œ×©×™×—×” ×–×•..."></textarea>
        </div>

        <div class="chat-footer">
            <div class="flex gap-3 text-xl text-gray-500">
                <i onclick="document.getElementById('stickyNote').classList.remove('hidden')" class="fas fa-sticky-note text-yellow-500 cursor-pointer hover:scale-110 transition" title="×¤×ª×§"></i>
                <i onclick="toggleInternalMode()" id="internalBtn" class="fas fa-eye-slash cursor-pointer hover:text-orange-500 transition" title="×”×¢×¨×” ×¤× ×™××™×ª"></i>
            </div>
            <div class="flex-1 mx-2">
                <input type="text" id="msgInput" class="w-full py-3 px-4 rounded-lg border-none outline-none text-sm shadow-sm focus:ring-2 focus:ring-green-500 transition" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key === 'Enter') sendMessage()">
            </div>
            <button onclick="sendMessage()" class="text-[#008069] text-2xl hover:scale-110 transition active:scale-95"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="crmModal" class="modal-overlay">
        <div class="modal-box w-[600px]">
            <div class="flex justify-between items-center p-4 border-b bg-gray-50">
                <h2 class="text-lg font-bold">×ª×™×§ ×œ×§×•×—</h2>
                <button onclick="closeModal('crmModal')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4 bg-white">
                <div class="flex gap-4 items-center">
                    <img id="crmAvatar" class="w-20 h-20 rounded-full border shadow-sm">
                    <div class="flex-1 space-y-2">
                        <input id="crmName" class="w-full border p-2 rounded font-bold" placeholder="×©× ××œ×">
                        <input id="crmPhone" class="w-full border p-2 rounded text-sm" placeholder="×˜×œ×¤×•×Ÿ">
                    </div>
                </div>
                <div class="border rounded-lg p-3 bg-gray-50">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">×¤×¨×•×™×§×˜×™×</h3>
                    <div id="crmProjects" class="space-y-2"></div>
                    <button onclick="addProjectRow()" class="text-xs text-blue-600 font-bold mt-2 hover:underline">+ ×”×•×¡×£ ×¤×¨×•×™×§×˜</button>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button onclick="saveCRM()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-green-700">×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>
        </div>
    </div>

    <div id="taskModal" class="modal-overlay">
        <div class="modal-box">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="font-bold">××©×™××” ×—×“×©×”</h2>
                <button onclick="closeModal('taskModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 space-y-3">
                <input id="tTitle" class="w-full border p-2 rounded text-sm font-bold" placeholder="×›×•×ª×¨×ª ×”××©×™××”">
                <div class="flex gap-2">
                    <select id="tAssign" class="border p-2 rounded text-sm flex-1"><option value="rami">×¨××™</option><option value="nat">× ×ª× ××œ</option></select>
                    <select id="tPrio" class="border p-2 rounded text-sm w-32"><option value="low">×¨×’×™×œ</option><option value="high">×“×—×•×£</option></select>
                </div>
                <textarea id="tDesc" class="w-full border p-2 rounded text-sm h-24" placeholder="×ª×™××•×¨..."></textarea>
            </div>
            <div class="p-4 border-t flex justify-end">
                <button onclick="createTask()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold shadow">×¦×•×¨ ××©×™××”</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { SabanPush } from './js/notifications.js';
        import { SabanChatbot } from './js/chatbot-engine.js'; 
        import { TaskEngine } from './js/task-engine.js'; 
        import { SabanSounds } from './js/sounds.js'; 

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let activeChatId = null;
        let activeType = 'private';
        let internalMode = false;
        let botEnabled = true;
        let activeUser = null;
        let bot = null;

        SabanPush.init('admin', 'admin_rami');

        // --- TABS & LISTS ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.querySelectorAll('.list-container').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tab}List`).classList.remove('hidden');
        };

        // --- CHAT LISTENER (×¢× ×”×’× ×” ××ª××•× ×•×ª ×©×‘×•×¨×•×ª) ---
        onSnapshot(query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc")), (snap) => {
            const list = document.getElementById('chatsList'); list.innerHTML = "";
            
            snap.forEach(d => {
                const c = d.data();
                const lastMsg = c.lastMessage || "";
                
                // Color Logic
                let ring = "ring-green";
                let statusText = "×¤×¢×™×œ";
                if(lastMsg.includes("×××ª×™×Ÿ")) { ring = "ring-orange"; statusText = "×××ª×™×Ÿ ×œ××¡××š"; }
                if(lastMsg.includes("ğŸ›‘") || lastMsg.includes("×“×—×•×£")) { 
                    ring = "ring-red"; 
                    statusText = "×“×¨×•×©×” ×”×ª×¢×¨×‘×•×ª!";
                    SabanSounds.playAlert(); 
                }

                // Safe Avatar & Name
                const safeName = c.userName || "×œ×§×•×— ×œ× ××–×•×”×”";
                const safeAvatar = c.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(safeName)}&background=random&color=fff`;
                const activeClass = activeChatId === d.id ? 'active' : '';
                const time = c.lastActivity ? new Date(c.lastActivity.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';

                list.innerHTML += `
                <div onclick="openChat('${d.id}', '${safeName}', 'private', '${safeAvatar}')" class="chat-item ${activeClass}">
                    <div class="relative">
                        <img src="${safeAvatar}" class="w-12 h-12 rounded-full ${ring} story-ring object-cover ml-3 p-0.5" onerror="this.src='https://via.placeholder.com/40'">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between">
                            <span class="font-bold text-sm text-gray-800 truncate" title="${safeName}">${safeName}</span>
                            <span class="text-[10px] text-gray-400 flex-shrink-0">${time}</span>
                        </div>
                        <div class="text-xs text-gray-500 truncate" title="${lastMsg}">${lastMsg}</div>
                    </div>
                </div>`;
            });
        });

        // --- OPEN CHAT ---
        window.openChat = async (id, name, type, img) => {
            activeChatId = id; activeType = type;
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('activeName').innerText = name;
            document.getElementById('activeDesc').innerText = type==='group'?'×§×‘×•×¦×”':'×œ×§×•×—';
            document.getElementById('activeAvatar').src = img;

            // Fetch User Data safely
            try {
                if(type === 'private') {
                    const uSnap = await getDoc(doc(db, "users", id));
                    if(uSnap.exists()) activeUser = { id: id, ...uSnap.data() };
                    else activeUser = { id: id, name, role: '×œ×§×•×—', projects: [] };
                    bot = new SabanChatbot(db, activeUser);
                }
            } catch(e) { console.warn("User fetch error", e); }

            // Messages Listener
            const coll = type==='group' ? `groups/${id}/messages` : `chat_sessions/${id}/messages`;
            onSnapshot(query(collection(db, coll), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('messagesBox');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    let cls = m.role==='staff' ? 'msg staff' : 'msg user';
                    if(m.role==='internal') cls = 'msg internal';
                    
                    return `<div class="${cls}">
                        ${m.role==='internal'?'<i class="fas fa-lock text-[10px] ml-1"></i>':''}
                        ${m.text}
                        <div class="text-[9px] text-gray-400 text-left mt-1 opacity-70">${formatTime(m.createdAt)}</div>
                    </div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        };

        // --- SENDING ---
        window.sendMessage = async () => {
            const txt = document.getElementById('msgInput').value; if(!txt || !activeChatId) return;
            document.getElementById('msgInput').value = '';
            
            await addDoc(collection(db, `chat_sessions/${activeChatId}/messages`), { 
                text: txt, role: internalMode ? 'internal' : 'staff', sender: "×—×\"×œ", createdAt: serverTimestamp() 
            });
            
            if(!internalMode) updateDoc(doc(db, "chat_sessions", activeChatId), { lastMessage: `× ×¦×™×’: ${txt}`, lastActivity: serverTimestamp() });
            if(internalMode) window.toggleInternalMode();
        };

        // --- FEATURES ---
        window.toggleInternalMode = () => { 
            internalMode=!internalMode; 
            const inp = document.getElementById('msgInput');
            const btn = document.getElementById('internalBtn');
            if(internalMode) {
                inp.placeholder = "×”×¢×¨×” ×¤× ×™××™×ª (×œ× × ×©×œ×— ×œ×œ×§×•×—)...";
                inp.classList.add('bg-yellow-50');
                btn.className = "fas fa-eye-slash text-orange-500 text-xl p-2";
            } else {
                inp.placeholder = "×”×§×œ×“ ×”×•×“×¢×”...";
                inp.classList.remove('bg-yellow-50');
                btn.className = "fas fa-eye text-gray-400 text-xl p-2";
            }
        };

        window.promptLinkOrder = async () => {
            const id = prompt("×”×–×Ÿ ××¡×¤×¨ ×”×–×× ×” ××§×•××§×¡:");
            if(!id) return;
            await setDoc(doc(db, "active_orders", id), { clientUid: activeChatId, status: "waiting", createdAt: serverTimestamp() });
            await addDoc(collection(db, `chat_sessions/${activeChatId}/messages`), { text: `â³ ×××ª×™×Ÿ ×œ××¡××š ×”×–×× ×” <b>${id}</b>...`, role: 'internal', createdAt: serverTimestamp() });
            updateDoc(doc(db, "chat_sessions", activeChatId), { lastMessage: `×××ª×™×Ÿ ×œ××¡××š ${id}`, lastActivity: serverTimestamp() });
        };

        // --- CRM & TASKS (Minified for brevity but functional) ---
        window.openCRM = () => {
            if(!activeUser) return;
            document.getElementById('crmName').value = activeUser.name || '';
            document.getElementById('crmPhone').value = activeUser.phone || '';
            document.getElementById('crmEmail').value = activeUser.email || '';
            document.getElementById('crmAvatar').src = activeUser.avatar || '';
            document.getElementById('crmModal').classList.add('open');
        };
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');
        window.saveCRM = async () => {
            if(!activeUser) return;
            await updateDoc(doc(db, "users", activeUser.id), {
                name: document.getElementById('crmName').value,
                phone: document.getElementById('crmPhone').value
            });
            closeModal('crmModal');
        };

        // Tasks Listener
        onSnapshot(query(collection(db, "tasks"), orderBy("createdAt", "desc")), (snap) => {
            const list = document.getElementById('tasksList'); list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                const pClass = t.priority === 'high' ? 'prio-high' : 'prio-low';
                list.innerHTML += `<div class="task-card ${pClass}">
                    <div class="font-bold text-gray-800 text-sm">${t.title}</div>
                    <div class="text-xs text-gray-500 flex justify-between mt-1">
                        <span>×œ: ${t.toUid}</span>
                        <span>${t.status}</span>
                    </div>
                </div>`;
            });
        });

        window.openTaskModal = () => document.getElementById('taskModal').classList.add('open');
        window.createTask = async () => {
            await TaskEngine.createTask(db, {
                title: document.getElementById('tTitle').value,
                desc: document.getElementById('tDesc').value,
                toUid: document.getElementById('tAssign').value,
                priority: document.getElementById('tPrio').value,
                status: 'open'
            });
            closeModal('taskModal');
        };

        window.toggleBot = () => { 
            botEnabled = !botEnabled; 
            const btn = document.getElementById('botBtn');
            btn.innerHTML = botEnabled ? '<i class="fas fa-robot text-green-600"></i> ×‘×•×˜ ×¤×¢×™×œ' : '<i class="fas fa-robot text-red-500"></i> ×‘×•×˜ ×›×‘×•×™';
        };

        window.handleLogout = () => { localStorage.clear(); location.href="index.html"; };
        function formatTime(ts) { return ts ? new Date(ts.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''; }

    </script>
</body>
</html>
