<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#00a884">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>Saban Command | ×—×"×œ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <style>
        :root { --wa-green: #00a884; --wa-bg: #efeae2; --tab-active: #008069; --tab-inactive: #8696a0; }
        body { background: #d1d7db; height: 100dvh; display: flex; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        /* Layout */
        .app-layout { display: flex; width: 100%; max-width: 1920px; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .sidebar { width: 420px; border-left: 1px solid #e9edef; display: flex; flex-direction: column; background: white; z-index: 10; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--wa-bg); position: relative; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); }

        /* Tabs System */
        .sidebar-tabs { display: flex; background: #f0f2f5; padding: 4px; gap: 4px; border-bottom: 1px solid #e9edef; }
        .tab-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px; color: var(--tab-inactive); transition: 0.2s; position: relative; }
        .tab-btn.active { background: white; color: var(--tab-active); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .tab-badge { position: absolute; top: 6px; left: 10px; background: #ef4444; color: white; font-size: 10px; px: 4px; min-width: 16px; height: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }

        /* Order Dashboard Card */
        .dashboard-card { background: white; padding: 12px; margin: 8px; border-radius: 10px; border: 1px solid #e5e7eb; border-right: 4px solid #cbd5e1; cursor: pointer; transition: 0.2s; }
        .dashboard-card:hover { transform: translateX(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .dashboard-card.status-new { border-right-color: #22c55e; background: #f0fdf4; }
        .dashboard-card.status-processing { border-right-color: #3b82f6; background: #eff6ff; }

        /* Chat Order Card (In Message) */
        .order-msg-card { background: white; border-radius: 8px; overflow: hidden; width: 340px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; margin-top: 4px; }
        .order-msg-header { background: linear-gradient(to left, #f0fdf4, white); padding: 12px; border-bottom: 1px dashed #dcfce7; display: flex; justify-content: space-between; align-items: center; }
        .order-msg-body { padding: 16px; font-family: monospace; white-space: pre-wrap; font-size: 14px; line-height: 1.6; color: #333; background: #fafafa; }
        .order-actions { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: white; border-top: 1px solid #f3f4f6; }
        
        /* Buttons */
        .btn-pro { padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
        .btn-approve { background: #f0fdf4; color: #166534; border-color: #bbf7d0; }
        .btn-approve:hover { background: #166534; color: white; }
        .btn-print { background: #f8fafc; color: #475569; border-color: #e2e8f0; }
        .btn-print:hover { background: #e2e8f0; color: #1e293b; }

        /* Messages */
        .msg-bubble { max-width: 65%; padding: 6px 10px; border-radius: 8px; font-size: 14px; margin-bottom: 6px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-internal { background: #fff7ed !important; border: 1px dashed #fdba74; }
        .sender-name { font-size: 11px; font-weight: bold; margin-bottom: 2px; display: flex; justify-content: space-between; }

        /* Document Listener Pulse */
        @keyframes listen-pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 159, 28, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 159, 28, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 159, 28, 0); } }
        .listening-active { animation: listen-pulse 2s infinite; border-color: #ff9f1c !important; color: #ff9f1c !important; }
        
        /* Popup */
        #newOrderPopup { position: absolute; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; display: flex; align-items: center; gap: 12px; z-index: 100; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #newOrderPopup.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div class="app-layout">
        <div class="sidebar">
            <div class="h-[64px] bg-[#f0f2f5] p-3 flex justify-between items-center border-b">
                <div class="flex items-center gap-3">
                    <img id="myAvatar" src="" class="w-10 h-10 rounded-full border border-gray-300">
                    <div>
                        <span id="myName" class="font-bold text-gray-800 text-sm block"></span>
                        <span class="text-[10px] text-green-600 font-bold uppercase tracking-wider">â— Online</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="docListenerBtn" onclick="window.simulateComaxDoc()" class="w-10 h-10 rounded-full bg-white border border-gray-200 text-gray-500 hover:text-orange-500 transition" title="×§×œ×™×˜×ª ××¡××š ××§×•××§×¡"><i class="fas fa-file-import"></i></button>
                    <button onclick="window.toggleMute()" id="muteBtn" class="w-10 h-10 rounded-full bg-white border border-gray-200 text-gray-500 hover:bg-gray-100 transition"><i class="fas fa-volume-up"></i></button>
                </div>
            </div>

            <div class="sidebar-tabs">
                <div class="tab-btn active" onclick="window.switchTab('chats')" id="tab-chats">
                    <i class="far fa-comments"></i> ×¦'××˜×™×
                </div>
                <div class="tab-btn" onclick="window.switchTab('orders')" id="tab-orders">
                    <i class="fas fa-clipboard-list"></i> ×”×–×× ×•×ª ×¤×ª×•×—×•×ª
                    <span id="ordersBadge" class="tab-badge hidden">0</span>
                </div>
            </div>

            <div id="view-chats" class="flex-1 overflow-y-auto custom-scroll">
                <div class="p-2 border-b bg-white sticky top-0 z-10">
                    <div class="bg-[#f0f2f5] rounded-lg flex items-center px-4 h-9">
                        <i class="fas fa-search text-gray-400 text-sm ml-2"></i>
                        <input type="text" placeholder="×—×™×¤×•×©..." class="bg-transparent border-none outline-none text-sm w-full">
                    </div>
                </div>
                <div id="chat-list"></div>
            </div>

            <div id="view-orders" class="flex-1 overflow-y-auto custom-scroll hidden bg-gray-50 p-2">
                <div class="text-xs font-bold text-gray-400 uppercase p-2">×××ª×™× ×™× ×œ×˜×™×¤×•×œ</div>
                <div id="orders-dashboard-list"></div>
            </div>
        </div>

        <div class="chat-area">
            <div id="newOrderPopup">
                <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white"><i class="fas fa-check"></i></div>
                <div>
                    <div class="font-bold text-sm">×”×–×× ×” ×—×“×©×” ×”×ª×§×‘×œ×”!</div>
                    <div class="text-xs opacity-80" id="popupText"></div>
                </div>
            </div>

            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400">
                <i class="fas fa-shield-alt text-5xl mb-4 opacity-20"></i>
                <h2 class="text-xl font-light">Saban Command Center</h2>
                <p class="text-sm">×‘×—×¨ ×¦'××˜ ××• ×”×–×× ×” ×›×“×™ ×œ×”×ª×—×™×œ</p>
            </div>

            <div id="active-chat" class="hidden flex flex-col h-full">
                <div class="h-[64px] bg-[#f0f2f5] p-3 flex items-center justify-between border-b shadow-sm z-10">
                    <div class="flex items-center gap-3 cursor-pointer" onclick="window.toggleInfoPanel()">
                        <img id="chatAvatar" src="" class="w-10 h-10 rounded-full border bg-white">
                        <div>
                            <span id="chatTitle" class="font-bold text-gray-800 block text-sm"></span>
                            <span class="text-xs text-gray-500" id="chatSub">×œ×—×¥ ×œ×¤×¨×˜×™×</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="attachPendingDocBtn" onclick="window.attachPendingDoc()" class="hidden bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold border border-orange-200 animate-bounce">
                            <i class="fas fa-paperclip"></i> ×©×™×™×š ××¡××š
                        </button>
                    </div>
                </div>

                <div id="messages-area" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1 custom-scroll"></div>

                <div class="bg-[#f0f2f5] p-2 flex items-center gap-2 border-t z-20">
                    <input type="file" id="staffFile" hidden accept="image/*,application/pdf" onchange="window.staffFileUpload(this)">
                    <button onclick="document.getElementById('staffFile').click()" class="w-10 h-10 rounded-full text-gray-500 hover:bg-gray-200 transition" title="×¦×¨×£ ×§×•×‘×¥"><i class="fas fa-paperclip text-xl"></i></button>
                    
                    <button id="ghostBtn" onclick="window.toggleGhostMode()" class="w-10 h-10 rounded-full text-gray-500 hover:bg-gray-200 transition" title="××¦×‘ ×¢×™×Ÿ (×¤× ×™××™)"><i class="fas fa-eye-slash text-lg"></i></button>
                    
                    <input id="msgInput" type="text" class="flex-1 bg-white rounded-xl h-10 px-4 text-sm border-none outline-none shadow-sm" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') window.sendMessage()">
                    <button onclick="window.sendMessage()" class="w-10 h-10 rounded-full bg-[#00a884] text-white shadow hover:scale-105 transition flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="info-panel" class="info-panel">
            <div class="h-[64px] flex items-center px-4 border-b bg-white justify-between">
                <span class="font-bold">×ª×™×§ ×œ×§×•×—</span>
                <button onclick="window.toggleInfoPanel()"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="p-6 text-center">
                <img id="crmAvatar" class="w-24 h-24 rounded-full mx-auto mb-3 shadow">
                <h3 id="crmName" class="font-bold text-lg"></h3>
                <div id="crmNum" class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mt-2 font-mono"></div>
                <div id="crmHistory" class="mt-6 text-right"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanSounds } from './js/sounds.js';
        
        // --- 1. ×”×’×“×¨×•×ª ××¢×¨×›×ª ---
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        const urlUid = new URLSearchParams(window.location.search).get('uid');
        let currentUser = JSON.parse(localStorage.getItem('saban_user')) || { name: '××•×§×“×Ÿ', role: 'staff' };
        
        if(urlUid) getDoc(doc(db, "users", urlUid)).then(s => { if(s.exists()) { currentUser = s.data(); localStorage.setItem('saban_user', JSON.stringify(currentUser)); initUI(); } });
        else initUI();

        function initUI() {
            document.getElementById('myName').innerText = currentUser.name;
            document.getElementById('myAvatar').src = currentUser.avatar || `https://ui-avatars.com/api/?name=${currentUser.name}`;
            try { SabanSounds.init(); } catch(e){}
        }

        let currentChatId = null;
        let isMuted = true; // ×”×ª×—×œ×” ×©×§×˜×” (×—×•×§×™ ×“×¤×“×¤×Ÿ)
        let isGhostMode = false;
        let pendingDoc = null;

        // --- 2. × ×™×”×•×œ ×˜××‘×™× ×•×”×–×× ×•×ª ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            if (tab === 'chats') {
                document.getElementById('view-chats').classList.remove('hidden');
                document.getElementById('view-orders').classList.add('hidden');
            } else {
                document.getElementById('view-chats').classList.add('hidden');
                document.getElementById('view-orders').classList.remove('hidden');
            }
        };

        // --- 3. ××•×˜×•××¦×™×” ×•×¡×˜×˜×•×¡×™× ---
        window.approveOrder = async (msgId, clientName, project) => {
            if(!confirm('×œ××©×¨ ×”×¢××¡×” ×•×œ×©×œ×•×— ×”×•×“×¢×” ×œ×œ×§×•×—?')) return;
            
            // 1. ×”×•×“×¢×ª ××¢×¨×›×ª (××•×˜×•××¦×™×”)
            await addDoc(collection(db, `orders/${currentChatId}/internal_chat`), {
                text: `×©×œ×•× ${clientName}, ×”×”×–×× ×” ×¢×‘×•×¨ ×¤×¨×•×™×§×˜ *${project}* ×”×ª×§×‘×œ×” ×•×¢×•×‘×¨×ª ×œ×œ×™×§×•×˜ ×•×”×¢××¡×”. ğŸšœ`,
                sender: '××¢×¨×›×ª',
                isSystem: true,
                createdAt: serverTimestamp(),
                isVisibleToClient: true // ×”×œ×§×•×— ×¨×•××” ××ª ×–×”!
            });

            // 2. ×¢×“×›×•×Ÿ ×•×™×–×•××œ×™ (×‘×¢×ª×™×“: ×¢×“×›×•×Ÿ ×©×“×” ×‘-DB)
            alert("×”×”×•×“×¢×” × ×©×œ×—×” ×•×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ!");
        };

        // --- 4. ×¤×•× ×§×¦×™×•×ª ×œ×™×‘×” ---
        window.loadChat = async (id, title, avatar) => {
            currentChatId = id;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('active-chat').classList.remove('hidden');
            document.getElementById('chatTitle').innerText = title;
            document.getElementById('chatAvatar').src = avatar;
            
            // ×‘×“×™×§×ª ××¡××š ×××ª×™×Ÿ
            if(pendingDoc) document.getElementById('attachPendingDocBtn').classList.remove('hidden');

            const q = query(collection(db, `orders/${id}/internal_chat`), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                const area = document.getElementById('messages-area');
                area.innerHTML = '';
                snap.docs.forEach(d => renderMsg(d.data(), d.id, area));
                area.scrollTop = area.scrollHeight;
                
                // ×¡××•× ×“ ×¨×§ ×¢×œ ×—×“×©
                snap.docChanges().forEach(c => {
                    if (c.type === 'added' && !snap.metadata.fromCache && !snap.metadata.hasPendingWrites) {
                        const m = c.doc.data();
                        if (m.sender === 'client' && !isMuted) {
                            SabanSounds.playMessage();
                            showPopup(m.clientName, m.text);
                        }
                    }
                });
            });
            
            // ×¢×“×›×•×Ÿ ×¤×× ×œ CRM
            const u = await getDoc(doc(db, "users", id));
            if(u.exists()) {
                const d = u.data();
                document.getElementById('crmName').innerText = d.name;
                document.getElementById('crmNum').innerText = d.clientNum;
                document.getElementById('crmAvatar').src = d.avatar || avatar;
                loadHistory(id);
            }
        };

        function renderMsg(m, id, container) {
            const isMe = m.sender !== 'client';
            const isInternal = m.isVisibleToClient === false;
            let content = m.text;

            // ×¨×™× ×“×•×¨ ×›×¨×˜×™×¡ ×”×–×× ×”
            if(m.type === 'order') {
                const safeText = m.text.replace(/"/g, '&quot;');
                content = `
                <div class="order-msg-card">
                    <div class="order-msg-header">
                        <div class="text-sm font-bold text-green-800"><i class="fas fa-box"></i> ×”×–×× ×” ×—×“×©×”</div>
                        <div class="text-xs bg-white border px-2 py-1 rounded">${m.project || '×›×œ×œ×™'}</div>
                    </div>
                    <div class="order-msg-body">${m.text}</div>
                    <div class="order-actions">
                        <button class="btn-pro btn-approve" onclick="window.approveOrder('${id}', '${m.clientName}', '${m.project}')">
                            <i class="fas fa-check"></i> ××©×¨ ×”×¢××¡×”
                        </button>
                        <button class="btn-pro btn-print" onclick="window.printOrder(...)">
                            <i class="fas fa-print"></i> ×”×“×¤×¡
                        </button>
                    </div>
                </div>`;
            } else if (m.type === 'pdf') {
                content = `<a href="${m.url}" target="_blank" class="flex items-center gap-3 p-3 bg-red-50 border border-red-100 rounded-lg text-red-700 decoration-0"><i class="fas fa-file-pdf text-xl"></i> <div><div class="font-bold text-sm">××¡××š PDF</div><div class="text-xs opacity-75">×œ×—×¥ ×œ×¤×ª×™×—×”</div></div></a>`;
            }

            container.innerHTML += `
            <div class="msg-bubble ${isMe ? 'msg-out' : 'msg-in'} ${isInternal ? 'msg-internal' : ''}">
                ${isInternal ? '<div class="text-[9px] text-orange-600 font-bold mb-1"><i class="fas fa-eye-slash"></i> ×¤× ×™××™ ×œ×¦×•×•×ª</div>' : ''}
                
                <div class="sender-name">
                    <span class="${!isMe ? 'text-green-700' : 'text-gray-500'}">${!isMe ? '×œ×§×•×—' : (m.sender || '×¦×•×•×ª')}</span>
                </div>
                
                <div>${content}</div>
                <div class="text-[9px] text-gray-400 mt-1 text-left">${new Date(m.createdAt?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
            </div>`;
        }

        // --- 5. ×¡×™××•×œ×¦×™×™×ª ××¡××›×™× (Comax) ---
        window.simulateComaxDoc = () => {
            pendingDoc = { url: '#', name: '×ª×¢×•×“×”_1023.pdf' };
            document.getElementById('docListenerBtn').classList.add('listening-active');
            SabanSounds.playAlert();
            alert("×”×ª×§×‘×œ ××¡××š ×—×“×© ××”××¢×¨×›×ª! ×”×™×›× ×¡ ×œ×¦'××˜ ×•×©×™×™×š ××•×ª×•.");
            if(currentChatId) document.getElementById('attachPendingDocBtn').classList.remove('hidden');
        };

        window.attachPendingDoc = async () => {
            if(!pendingDoc || !currentChatId) return;
            // ×× ×× ×—× ×• ×‘××¦×‘ × ×¡×ª×¨ - ×”××¡××š ×™×™×©×œ×— ×›×¤× ×™××™
            const isInternal = isGhostMode; 
            
            await addDoc(collection(db, `orders/${currentChatId}/internal_chat`), {
                text: `ğŸ“ ××¡××š ××§×•××§×¡: ${pendingDoc.name}`,
                type: 'pdf',
                url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
                sender: currentUser.name,
                createdAt: serverTimestamp(),
                isVisibleToClient: !isInternal // ×× ×’×•×¡×˜ ××•×“ ×“×œ×•×§ - ×”×œ×§×•×— ×œ× ×™×¨××”
            });

            // ××™×¤×•×¡
            pendingDoc = null;
            document.getElementById('docListenerBtn').classList.remove('listening-active');
            document.getElementById('attachPendingDocBtn').classList.add('hidden');
        };

        // --- 6. ×××–×™×Ÿ ×¨××©×™ (Dashboard + Chat List) ---
        onSnapshot(query(collection(db, "orders"), orderBy("lastActive", "desc")), (snap) => {
            const chatList = document.getElementById('chat-list');
            const ordersList = document.getElementById('orders-dashboard-list');
            
            chatList.innerHTML = '';
            ordersList.innerHTML = '';
            let newOrdersCount = 0;

            snap.forEach(d => {
                const o = d.data();
                const av = o.clientAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(o.clientName)}`;
                const isActive = d.id === currentChatId ? 'active' : '';
                const isNew = o.status === 'new';

                // 1. ×¨×©×™××ª ×¦'××˜×™× ×¨×’×™×œ×”
                chatList.innerHTML += `
                <div class="chat-item ${isActive}" onclick="window.loadChat('${d.id}', '${o.clientName}', '${av}')">
                    <img src="${av}" class="w-12 h-12 rounded-full border ml-3">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between font-bold text-sm text-gray-800">
                            ${o.clientName}
                            <span class="text-[10px] font-normal text-gray-400">${o.lastActive ? new Date(o.lastActive.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs mt-1">
                            <span class="text-gray-500 truncate">${o.currentProject || ''}</span>
                            ${isNew ? '<span class="bg-green-500 text-white px-1.5 rounded-full text-[9px]">1</span>' : ''}
                        </div>
                    </div>
                </div>`;

                // 2. ×“×©×‘×•×¨×“ ×”×–×× ×•×ª (×¨×§ ×—×“×©×•×ª)
                if(isNew) {
                    newOrdersCount++;
                    ordersList.innerHTML += `
                    <div class="dashboard-card status-new" onclick="window.switchTab('chats'); window.loadChat('${d.id}', '${o.clientName}', '${av}')">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-gray-800">${o.clientName}</span>
                            <span class="text-[10px] bg-white border px-1 rounded text-gray-500">${new Date(o.lastActive?.seconds*1000).toLocaleTimeString()}</span>
                        </div>
                        <div class="text-xs text-gray-600 mb-2"><i class="fas fa-hard-hat"></i> ${o.currentProject || '×›×œ×œ×™'}</div>
                        <div class="text-xs font-bold text-green-700 flex items-center gap-1"><i class="fas fa-circle text-[8px]"></i> ×××ª×™×Ÿ ×œ×˜×™×¤×•×œ</div>
                    </div>`;
                }
            });

            // ×¢×“×›×•×Ÿ Badge ×‘×˜××‘
            const badge = document.getElementById('ordersBadge');
            if(newOrdersCount > 0) { badge.innerText = newOrdersCount; badge.classList.remove('hidden'); }
            else { badge.classList.add('hidden'); }
        });

        // --- Helpers ---
        window.toggleInfoPanel = () => document.getElementById('info-panel').classList.toggle('open');
        window.toggleMute = () => { isMuted = !isMuted; const b = document.getElementById('muteBtn'); if(!isMuted){ SabanSounds.init(); SabanSounds.playMessage(); b.innerHTML='<i class="fas fa-volume-up"></i>'; b.classList.add('text-green-600'); } else { b.innerHTML='<i class="fas fa-volume-mute"></i>'; b.classList.remove('text-green-600'); }};
        
        window.toggleGhostMode = () => {
            isGhostMode = !isGhostMode;
            const btn = document.getElementById('ghostBtn');
            const inp = document.getElementById('msgInput');
            if(isGhostMode) { btn.classList.add('text-orange-600', 'bg-orange-50'); inp.classList.add('bg-orange-50'); inp.placeholder = '×”×•×“×¢×” ×¤× ×™××™×ª (× ×¡×ª×¨×ª ××”×œ×§×•×—)...'; }
            else { btn.classList.remove('text-orange-600', 'bg-orange-50'); inp.classList.remove('bg-orange-50'); inp.placeholder = '×”×§×œ×“ ×”×•×“×¢×”...'; }
            inp.focus();
        };

        window.sendMessage = async () => {
            const inp = document.getElementById('msgInput');
            const txt = inp.value.trim();
            if(!txt || !currentChatId) return;
            inp.value = '';
            await addDoc(collection(db, `orders/${currentChatId}/internal_chat`), {
                text: txt, sender: currentUser.name, createdAt: serverTimestamp(), isVisibleToClient: !isGhostMode
            });
            if(isGhostMode) window.toggleGhostMode();
        };

        function showPopup(title, body) {
            const p = document.getElementById('newOrderPopup');
            document.getElementById('popupText').innerText = body;
            p.classList.add('show');
            setTimeout(() => p.classList.remove('show'), 5000);
        }

        // Print Stub
        window.printOrder = () => alert("×¤×•×ª×— ×—×œ×•× ×™×ª ×”×“×¤×¡×”...");
        
        // CRM History Stub
        function loadHistory(uid) {
            // (×›××Ÿ ×ª×‘×•× ×”×œ×•×’×™×§×” ×©×œ ××©×™×›×ª ×”×™×¡×˜×•×¨×™×” ×›××• ×‘×§×•×‘×¥ ×”×§×•×“×)
            document.getElementById('crmHistory').innerHTML = '<div class="text-xs text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>';
        }
        
        // File Upload
        window.staffFileUpload = (input) => {
            const file = input.files[0];
            if(!file || !currentChatId) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const type = file.type.includes('pdf') ? 'pdf' : 'image';
                await addDoc(collection(db, `orders/${currentChatId}/internal_chat`), {
                    text: type==='pdf'?'××¡××š × ×©×œ×—':'×ª××•× ×” × ×©×œ×—×”', type: type, url: e.target.result, sender: currentUser.name, createdAt: serverTimestamp(), isVisibleToClient: !isGhostMode
                });
            };
            reader.readAsDataURL(file);
        };
    </script>
</body>
</html>
