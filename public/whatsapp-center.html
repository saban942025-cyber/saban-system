<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Center CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <style>
        /* ... Base Styles ... */
        :root { --wa-green: #00a884; --wa-bg: #efeae2; }
        body { background: #d1d7db; height: 100dvh; display: flex; overflow: hidden; font-family: -apple-system, sans-serif; }
        .app-layout { display: flex; width: 100%; max-width: 1900px; margin: 0 auto; background: white; }
        
        /* Layout Grid */
        .sidebar { width: 350px; border-left: 1px solid #e9edef; display: flex; flex-direction: column; background: white; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--wa-bg); position: relative; }
        
        /* New: Client Info Panel (CRM) */
        .info-panel { 
            width: 0; transition: width 0.3s ease; 
            background: #f0f2f5; border-right: 1px solid #e9edef; 
            overflow: hidden; display: flex; flex-direction: column;
        }
        .info-panel.open { width: 320px; }

        /* Mention Tag Style */
        .mention-tag { background-color: #dbeafe; color: #1e40af; padding: 0 4px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .mention-tag:hover { text-decoration: underline; }
        
        /* Messages */
        .msg-bubble { max-width: 65%; padding: 6px 10px; border-radius: 8px; font-size: 14px; margin-bottom: 6px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); position: relative; }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-internal { background: #fff7ed !important; border: 1px dashed #fdba74; } /* צבע שונה להודעות פנימיות */
        
        .crm-stat-box { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div class="app-layout">
        <div class="sidebar">
            <div class="h-[60px] bg-[#f0f2f5] p-3 flex justify-between items-center border-b">
                <div class="flex items-center gap-2">
                    <img id="myAvatar" src="" class="w-9 h-9 rounded-full">
                    <span id="myName" class="font-bold text-gray-700">...</span>
                </div>
            </div>
            <div class="p-2 border-b"><input type="text" placeholder="חיפוש לקוח או הזמנה..." class="w-full bg-[#f0f2f5] rounded-lg h-9 px-4 text-sm outline-none"></div>
            <div id="chat-list" class="flex-1 overflow-y-auto"></div>
        </div>

        <div class="chat-area">
            <div id="active-chat" class="hidden flex flex-col h-full">
                <div class="h-[60px] bg-[#f0f2f5] p-3 flex items-center justify-between border-b shadow-sm z-10 cursor-pointer hover:bg-gray-100 transition" onclick="toggleInfoPanel()">
                    <div class="flex items-center gap-3">
                        <img id="chatAvatar" src="" class="w-10 h-10 rounded-full">
                        <div>
                            <span id="chatTitle" class="font-bold text-gray-800 block leading-tight"></span>
                            <span id="chatSub" class="text-xs text-gray-500">לחץ לפרטי לקוח</span>
                        </div>
                    </div>
                    <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                </div>

                <div id="messages-area" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1 custom-scroll"></div>

                <div class="bg-[#f0f2f5] p-2 flex items-center gap-2 border-t">
                    <button onclick="insertMention()" class="w-8 h-8 text-blue-600 hover:bg-blue-100 rounded font-bold">@</button>
                    <button id="ghostBtn" onclick="toggleGhostMode()" class="w-10 h-10 rounded-full text-gray-500 hover:bg-gray-200 transition"><i class="fas fa-eye-slash"></i></button>
                    <input id="msgInput" type="text" class="flex-1 bg-white rounded-lg h-10 px-4 text-sm border-none outline-none" placeholder="הקלד הודעה..." onkeydown="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()" class="p-2 text-[#00a884]"><i class="fas fa-paper-plane text-xl"></i></button>
                </div>
            </div>
        </div>

        <div id="info-panel" class="info-panel">
            <div class="h-[60px] flex items-center px-4 border-b bg-white">
                <i class="fas fa-times cursor-pointer text-gray-400 hover:text-red-500" onclick="toggleInfoPanel()"></i>
                <span class="mr-4 font-bold text-gray-700">תיק לקוח</span>
            </div>
            
            <div class="p-4 overflow-y-auto flex-1">
                <div class="flex flex-col items-center mb-6">
                    <img id="crmAvatar" src="" class="w-20 h-20 rounded-full mb-3 shadow-sm">
                    <h2 id="crmName" class="text-xl font-bold text-gray-800"></h2>
                    <div id="crmNum" class="text-sm font-mono bg-blue-100 text-blue-800 px-2 rounded"></div>
                </div>

                <div class="crm-stat-box">
                    <div class="text-xs text-gray-400 font-bold uppercase mb-2">סטטיסטיקה</div>
                    <div class="flex justify-between items-center mb-2">
                        <span>סך הזמנות</span>
                        <span id="crmTotalOrders" class="font-bold text-lg">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>פרויקט מוביל</span>
                        <span id="crmTopProject" class="text-sm text-green-600 font-bold">-</span>
                    </div>
                </div>

                <div class="crm-stat-box flex-1">
                    <div class="text-xs text-gray-400 font-bold uppercase mb-2">היסטוריה אחרונה</div>
                    <div id="crmHistory" class="text-sm space-y-2 max-h-60 overflow-y-auto">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        // ... (אותו Config) ...
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // Variables
        let currentChatId = null;
        let isGhostMode = false;
        let activeClientData = null;

        // --- Functions ---

        window.toggleInfoPanel = () => {
            const panel = document.getElementById('info-panel');
            panel.classList.toggle('open');
            if(panel.classList.contains('open') && currentChatId) {
                loadCRMData(currentChatId);
            }
        };

        window.insertMention = () => {
            const input = document.getElementById('msgInput');
            input.value += "@";
            input.focus();
        };

        // טעינת נתוני CRM
        async function loadCRMData(uid) {
            // 1. טעינת פרטי משתמש
            const userSnap = await getDoc(doc(db, "users", uid));
            const userData = userSnap.exists() ? userSnap.data() : { name: 'לא רשום', clientNum: '---' };
            activeClientData = userData;

            document.getElementById('crmName').innerText = userData.name;
            document.getElementById('crmNum').innerText = `ID: ${userData.clientNum}`;
            document.getElementById('crmAvatar').src = userData.avatar || `https://ui-avatars.com/api/?name=${userData.name}`;

            // 2. חישוב הזמנות (דמו)
            // כאן אפשר לעשות Query אמיתי להיסטוריה
            document.getElementById('crmTotalOrders').innerText = Math.floor(Math.random() * 50) + 1; // סימולציה
            document.getElementById('crmTopProject').innerText = (userData.projects && userData.projects[0]) || 'כללי';
        }

        // רינדור הודעה עם תיוגים
        function renderMsg(m, container) {
            const isMe = m.sender !== 'client';
            const isInternal = m.isVisibleToClient === false;
            
            // זיהוי תיוגים: @מילה הופך ל-Span כחול
            let formattedText = m.text.replace(/@(\w+)/g, '<span class="mention-tag">@$1</span>');

            container.innerHTML += `
            <div class="msg-bubble ${isMe ? 'msg-out' : 'msg-in'} ${isInternal ? 'msg-internal' : ''}">
                ${isInternal ? '<div class="text-[10px] text-orange-500 font-bold mb-1"><i class="fas fa-lock"></i> פנימי לצוות</div>' : ''}
                ${!isMe ? `<div class="text-[10px] font-bold text-orange-600 mb-1">לקוח</div>` : ''}
                <span>${formattedText}</span>
                <div class="text-[10px] text-gray-400 text-left mt-1">
                    ${new Date(m.createdAt?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
                </div>
            </div>`;
        }

        // --- שאר הפונקציות (loadChat, sendMessage) זהות לגרסאות הקודמות, רק להשתמש ב-renderMsg החדש ---
        // ולוודא שה-Header Click קורא ל-toggleInfoPanel
        
        // ... (העתק את שאר הלוגיקה של Firebase מהקובץ הקודם) ...
        
        // עדכון קטן ל-loadChat כדי לשמור את ה-ID
        window.loadChat = (id, title, avatar) => {
            currentChatId = id;
            document.getElementById('chatTitle').innerText = title;
            document.getElementById('chatAvatar').src = avatar;
            document.getElementById('active-chat').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            
            // טעינת הודעות
            const q = query(collection(db, `orders/${id}/internal_chat`), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                const area = document.getElementById('messages-area');
                area.innerHTML = '';
                snap.docs.forEach(d => renderMsg(d.data(), area));
                area.scrollTop = area.scrollHeight;
            });
        };
    </script>
</body>
</html>
