<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Command | ×—×"×œ</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/733/733585.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <style>
        :root { --wa-header: #f0f2f5; --wa-bg: #efeae2; --wa-green: #00a884; --task-blue: #0ea5e9; }
        body { background: #d1d7db; height: 100dvh; display: flex; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        .app-container { display: flex; width: 100%; height: 100%; max-width: 1920px; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.15); }
        .sidebar { width: 420px; min-width: 350px; display: flex; flex-direction: column; border-left: 1px solid #e9edef; background: white; z-index: 20; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--wa-bg); background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; min-width: 0; }

        /* Tabs */
        .tabs { display: flex; background: white; border-bottom: 1px solid #e9edef; }
        .tab { flex: 1; text-align: center; padding: 14px; cursor: pointer; color: #54656f; font-weight: 600; border-bottom: 3px solid transparent; transition: 0.2s; position: relative; font-size: 14px; }
        .tab:hover { background: #f5f6f6; }
        .tab.active { color: var(--wa-green); border-bottom-color: var(--wa-green); background: #f0fdf4; }
        .badge { position: absolute; top: 10px; left: 15px; background: #ef4444; color: white; font-size: 10px; padding: 0 5px; border-radius: 10px; min-width: 18px; display: flex; align-items: center; justify-content: center; }

        /* Chat List */
        .chat-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f5f6f6; transition: 0.2s; background: white; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid var(--wa-green); }
        .chat-item.task-item { border-right: 4px solid var(--task-blue); background: #f0f9ff; } /* ×¢×™×¦×•×‘ ××™×•×—×“ ×œ××©×™××•×ª */
        
        .avatar { width: 45px; height: 45px; rounded: 50%; object-fit: cover; border: 1px solid #e9edef; margin-left: 12px; }
        .task-icon { width: 45px; height: 45px; background: #e0f2fe; color: #0284c7; border-radius: 50%; display: flex; items-center; justify-content: center; margin-left: 12px; font-size: 18px; }

        /* Order Card */
        .order-card { background: white; border-radius: 8px; overflow: hidden; width: 320px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 5px; border: 1px solid #e5e7eb; }
        .order-head { background: linear-gradient(to left, #f0fdf4, #ffffff); padding: 10px; border-bottom: 1px solid #dcfce7; display: flex; justify-content: space-between; align-items: center; }
        .order-body { padding: 15px; font-family: monospace; white-space: pre-wrap; font-size: 13px; background: #fafafa; color: #333; }
        .order-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: #e5e7eb; border-top: 1px solid #e5e7eb; }
        .action-btn { background: white; padding: 10px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: 0.2s; color: #4b5563; }
        .action-btn:hover { background: #f9fafb; color: #111827; }

        /* Task Card (Blue) */
        .task-card { background: white; border-radius: 8px; overflow: hidden; width: 320px; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #bae6fd; }
        .task-header { background: #e0f2fe; padding: 10px; border-bottom: 1px solid #bae6fd; display: flex; justify-content: space-between; align-items: center; color: #0369a1; font-weight: bold; }
        .task-actions { display: flex; border-top: 1px solid #f1f5f9; }
        .task-btn { flex: 1; padding: 10px; background: white; text-align: center; cursor: pointer; font-size: 12px; font-weight: bold; color: #0284c7; border-left: 1px solid #f1f5f9; }
        .task-btn:hover { background: #f0f9ff; }

        /* Messages */
        .msg-bubble { max-width: 70%; padding: 8px 10px; border-radius: 8px; font-size: 14px; margin-bottom: 6px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); position: relative; }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-internal { background: #fff7ed !important; border: 1px dashed #fdba74; }
        .msg-system { align-self: center; background: #eef2ff; color: #3730a3; font-size: 11px; padding: 4px 10px; border-radius: 10px; margin: 8px 0; font-weight: 600; text-align: center; }

        /* Modals */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; width: 450px; max-height: 80vh; border-radius: 12px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.25); display: flex; flex-direction: column; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Forms */
        .form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; rounded: 8px; background: #f8fafc; margin-bottom: 10px; outline: none; }
        .form-input:focus { border-color: #0ea5e9; background: white; }
        
        /* Pending Bar */
        .pending-bar { position: absolute; top: 60px; left: 0; width: 100%; background: #fff7ed; border-bottom: 2px solid #fdba74; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 15; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div id="taskModal" class="modal-wrap">
        <div class="modal-box">
            <div class="p-4 border-b bg-blue-50 flex justify-between items-center">
                <h3 class="font-bold text-blue-800">ğŸš€ ××©×™××” ×—×“×©×” ×œ×¡×™×“×•×¨</h3>
                <button onclick="document.getElementById('taskModal').style.display='none'"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="p-4">
                <label class="text-xs font-bold text-gray-500 mb-1 block">×¡×•×’ ×”×¤×¢×•×œ×”</label>
                <select id="taskType" class="form-input">
                    <option value="transfer">ğŸ”„ ×”×¢×‘×¨×” ×‘×™×Ÿ ×¡× ×™×¤×™×</option>
                    <option value="pickup">ğŸ“¦ ××™×¡×•×£ ×¡×—×•×¨×” ××¡×¤×§</option>
                    <option value="admin">ğŸ“„ ×©×œ×™×—×•×ª ××©×¨×“×™×ª</option>
                    <option value="urgent">ğŸš¨ ×”×§×¤×¦×” ×“×—×•×¤×”</option>
                </select>
                <label class="text-xs font-bold text-gray-500 mb-1 block">×¤×™×¨×•×˜ (×××™×¤×”, ×œ××Ÿ, ××”)</label>
                <textarea id="taskDesc" class="form-input h-24" placeholder="×œ××©×œ: ×œ×”×¢×‘×™×¨ 2 ××©×˜×—×™ ×‘×œ×•×§×™× ××¡× ×™×£ ××‘×Ÿ ×™×”×•×“×” ×œ×œ×§×•×— ×©×—×¨..."></textarea>
                <button onclick="window.submitTask()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold shadow hover:bg-blue-700">×©×’×¨ ×œ×œ×•×—</button>
            </div>
        </div>
    </div>

    <div id="docSelectModal" class="modal-wrap">
        <div class="modal-box">
            <div class="p-4 border-b bg-gray-50 flex justify-between">
                <h3 class="font-bold">×™×™×‘×•× ××¡××š (Comax)</h3>
                <button onclick="document.getElementById('docSelectModal').style.display='none'"><i class="fas fa-times"></i></button>
            </div>
            <div id="docsList" class="flex-1 overflow-y-auto p-0"></div>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="h-[60px] bg-[#f0f2f5] p-3 flex justify-between items-center border-b flex-shrink-0">
                <div class="flex items-center gap-3">
                    <img id="myAvatar" src="" class="w-10 h-10 rounded-full border">
                    <span id="myName" class="font-bold text-gray-700">...</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('taskModal').style.display='flex'" class="w-10 h-10 rounded-full bg-blue-50 border border-blue-200 text-blue-600 hover:bg-blue-100" title="××©×™××” ×¤× ×™××™×ª"><i class="fas fa-plus"></i></button>
                    <button onclick="window.openDocSelector()" class="w-10 h-10 rounded-full bg-white border hover:text-blue-600" title="×™×‘× ××¡××š"><i class="fas fa-file-import"></i></button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="window.switchTab('all')" id="tab-all">×¦'××˜×™×</div>
                <div class="tab" onclick="window.switchTab('tasks')" id="tab-tasks">
                    ×œ×¡×™×“×•×¨ (×¤× ×™××™) <span id="tasksBadge" class="badge hidden">0</span>
                </div>
            </div>

            <div id="chat-list" class="flex-1 overflow-y-auto custom-scroll"></div>
        </div>

        <div class="chat-area">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400 select-none">
                <i class="fas fa-satellite-dish text-6xl mb-4 opacity-20"></i>
                <h2 class="text-xl font-light">Saban Command Center</h2>
            </div>

            <div id="active-chat" class="hidden flex flex-col h-full relative">
                <div class="h-[60px] bg-[#f0f2f5] p-3 flex items-center justify-between border-b shadow-sm z-20 cursor-pointer">
                    <div class="flex items-center gap-3">
                        <img id="chatAvatar" src="" class="w-10 h-10 rounded-full border bg-white object-cover">
                        <div>
                            <span id="chatTitle" class="font-bold text-gray-800 block text-sm"></span>
                            <span id="chatSub" class="text-xs text-gray-500"></span>
                        </div>
                    </div>
                    <i class="fas fa-ellipsis-v text-gray-400 px-2"></i>
                </div>

                <div id="pendingDocBar" class="pending-bar hidden">
                    <div class="flex items-center gap-2 text-orange-900">
                        <i class="fas fa-file-import animate-bounce"></i> <span class="font-bold text-sm" id="pendingDocName">...</span>
                    </div>
                    <button onclick="window.attachDocToChat()" class="bg-orange-500 text-white px-3 py-1 rounded text-xs font-bold">×©×™×™×š</button>
                </div>

                <div id="messages-area" class="flex-1 overflow-y-auto p-5 flex flex-col gap-1 custom-scroll"></div>

                <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t z-20">
                    <input id="msgInput" type="text" class="flex-1 bg-white rounded-xl h-10 px-4 text-sm border-none outline-none shadow-sm" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') window.sendMessage()">
                    <button onclick="window.sendMessage()" class="w-10 h-10 rounded-full bg-[#00a884] text-white shadow"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { SabanSounds } from './js/sounds.js';

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        // Init
        const urlUid = new URLSearchParams(window.location.search).get('uid');
        let currentUser = JSON.parse(localStorage.getItem('saban_user')) || { name: '××•×§×“×Ÿ' };
        if(urlUid) getDoc(doc(db, "users", urlUid)).then(s => { if(s.exists()){ currentUser=s.data(); localStorage.setItem('saban_user',JSON.stringify(currentUser)); document.getElementById('myName').innerText=currentUser.name; }});
        else document.getElementById('myName').innerText=currentUser.name;

        let currentChatId = null, currentFilter = 'all', pendingDoc = null, chatsCache = [];

        // --- 1. Task Logic (Create) ---
        window.submitTask = async () => {
            const type = document.getElementById('taskType').value;
            const desc = document.getElementById('taskDesc').value;
            if(!desc) return;

            const typeMap = { 'transfer': '×”×¢×‘×¨×”', 'pickup': '××™×¡×•×£', 'admin': '××©×¨×“', 'urgent': '×“×—×•×£' };
            const docRef = await addDoc(collection(db, "orders"), {
                clientName: `××©×™××”: ${typeMap[type]}`,
                isTask: true, // ×“×’×œ ×—×©×•×‘!
                taskType: type,
                status: 'new',
                lastActive: serverTimestamp(),
                chat: []
            });

            await addDoc(collection(db, `orders/${docRef.id}/internal_chat`), {
                text: desc, sender: currentUser.name, type: 'task_desc', createdAt: serverTimestamp(), isVisibleToClient: false
            });

            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('taskDesc').value = '';
        };

        // --- 2. List Logic & Filtering (The Fix) ---
        onSnapshot(query(collection(db, "orders"), orderBy("lastActive", "desc")), (snap) => {
            chatsCache = []; // Reset Cache
            snap.forEach(d => chatsCache.push({ id: d.id, ...d.data() }));
            renderList();
        });

        function renderList() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            let tasksCount = 0;

            chatsCache.forEach(o => {
                // ×¡×¤×™×¨×ª ××©×™××•×ª ×œ-Badge
                if (o.isTask) tasksCount++;

                // ×¡×™× ×•×Ÿ:
                // ×× ×× ×—× ×• ×‘×˜××‘ 'all' -> ××œ ×ª×¦×™×’ ××©×™××•×ª
                if (currentFilter === 'all' && o.isTask) return;
                // ×× ×× ×—× ×• ×‘×˜××‘ 'tasks' -> ×ª×¦×™×’ *×¨×§* ××©×™××•×ª
                if (currentFilter === 'tasks' && !o.isTask) return;

                const active = o.id === currentChatId ? 'active' : '';
                const taskClass = o.isTask ? 'task-item' : '';
                
                let iconHtml = '';
                if(o.isTask) iconHtml = `<div class="task-icon"><i class="fas fa-clipboard-list"></i></div>`;
                else {
                    const av = o.clientAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(o.clientName)}`;
                    iconHtml = `<img src="${av}" class="avatar">`;
                }

                list.innerHTML += `
                <div class="chat-item ${active} ${taskClass}" onclick="window.loadChat('${o.id}', '${o.clientName}', ${o.isTask})">
                    ${iconHtml}
                    <div class="flex-1 mr-3 min-w-0">
                        <div class="flex justify-between font-bold text-gray-800 text-sm">
                            ${o.clientName}
                            <span class="text-[10px] text-gray-400">${o.lastActive ? new Date(o.lastActive.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                        </div>
                        <div class="text-xs text-gray-500 truncate">${o.isTask ? '×××ª×™×Ÿ ×œ×©×™×‘×•×¥...' : (o.currentProject || '')}</div>
                    </div>
                </div>`;
            });

            // ×¢×“×›×•×Ÿ Badge
            const badge = document.getElementById('tasksBadge');
            if (tasksCount > 0) { badge.innerText = tasksCount; badge.classList.remove('hidden'); }
            else badge.classList.add('hidden');
        }

        window.switchTab = (tab) => {
            currentFilter = tab;
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            renderList(); // Re-render from cache immediately
        };

        // --- 3. Chat Logic ---
        window.loadChat = (id, title, isTask) => {
            currentChatId = id;
            document.getElementById('active-chat').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chatTitle').innerText = title;
            document.getElementById('chatSub').innerText = isTask ? '× ×™×”×•×œ ×¤× ×™××™' : '×œ×—×¥ ×œ×¤×¨×˜×™ ×œ×§×•×—';
            document.getElementById('chatAvatar').src = isTask ? 'https://cdn-icons-png.flaticon.com/512/1584/1584892.png' : `https://ui-avatars.com/api/?name=${title}`;

            if(pendingDoc) document.getElementById('pendingDocBar').classList.remove('hidden');

            const q = query(collection(db, `orders/${id}/internal_chat`), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                const area = document.getElementById('messages-area');
                area.innerHTML = '';
                snap.docs.forEach(d => renderMsg(d.data(), d.id, id));
                area.scrollTop = area.scrollHeight;
            });
        };

        function renderMsg(m, msgId, orderId) {
            const isMe = m.sender !== 'client';
            let content = m.text;

            // ×. ×›×¨×˜×™×¡ ××©×™××” (×›×—×•×œ)
            if (m.type === 'task_desc') {
                content = `
                <div class="task-card">
                    <div class="task-header"><i class="fas fa-info-circle"></i> ×¤×¨×˜×™ ××©×™××”</div>
                    <div class="order-body">${m.text}</div>
                    <div class="task-actions">
                        <div class="task-btn" onclick="alert('×‘×¤×™×ª×•×—: ×©×™×‘×•×¥ × ×”×’')">ğŸ‘¤ ×©×™×™×š ×œ× ×”×’</div>
                        <div class="task-btn text-green-600" onclick="alert('×‘×•×¦×¢')">âœ… ×‘×•×¦×¢</div>
                    </div>
                </div>`;
            }
            // ×‘. ×›×¨×˜×™×¡ ×”×–×× ×” (×™×¨×•×§)
            else if (m.type === 'order') {
                content = `
                <div class="order-card">
                    <div class="order-head">
                        <span class="text-green-800 font-bold"><i class="fas fa-box"></i> ×”×–×× ×”</span>
                        <span class="text-xs bg-white border px-1 rounded">${m.project||'×›×œ×œ×™'}</span>
                    </div>
                    <div class="order-body">${m.text}</div>
                    <div class="order-actions">
                        <div class="action-btn" onclick="window.updateStatus('${orderId}', 'work')"><i class="fas fa-tools text-blue-600"></i> ×œ×œ×™×§×•×˜</div>
                        <div class="action-btn" onclick="window.updateStatus('${orderId}', 'approved')"><i class="fas fa-check text-green-600"></i> ××•×›×Ÿ</div>
                        <div class="action-btn" onclick="window.printOrder(...)"><i class="fas fa-print"></i> ×”×“×¤×¡</div>
                    </div>
                </div>`;
            }
            // ×’. ××¢×¨×›×ª
            else if (m.type === 'system') {
                document.getElementById('messages-area').innerHTML += `<div class="msg-system">${m.text}</div>`; return;
            }
            // ×“. PDF
            else if (m.type === 'pdf') {
                content = `<a href="${m.url}" target="_blank" class="flex items-center gap-2 p-2 bg-red-50 border border-red-100 rounded text-red-700 font-bold text-sm"><i class="fas fa-file-pdf"></i> ××¡××š PDF</a>`;
            }

            document.getElementById('messages-area').innerHTML += `
            <div class="msg-bubble ${isMe ? 'msg-out' : 'msg-in'} ${m.isVisibleToClient===false?'msg-internal':''}">
                <div>${content}</div>
                <div class="msg-meta"><span>${new Date(m.createdAt?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>
            </div>`;
        }

        // --- 4. Actions ---
        window.updateStatus = async (oid, status) => {
            if(!confirm('×œ×¢×“×›×Ÿ ×¡×˜×˜×•×¡ ×•×œ×©×œ×•×— ×”×•×“×¢×”?')) return;
            await updateDoc(doc(db, "orders", oid), { status: status, lastUpdate: serverTimestamp() });
            const msg = status === 'work' ? "ğŸš§ ×¢×‘×¨ ×œ×œ×™×§×•×˜" : "âœ… ××•×›×Ÿ ×œ××©×œ×•×—";
            await addDoc(collection(db, `orders/${oid}/internal_chat`), { text: msg, type: 'system', sender: '××¢×¨×›×ª', createdAt: serverTimestamp(), isVisibleToClient: true });
        };

        window.sendMessage = async () => {
            const inp = document.getElementById('msgInput'); const t = inp.value.trim(); if(!t || !currentChatId) return; inp.value='';
            await addDoc(collection(db, `orders/${currentChatId}/internal_chat`), { text: t, sender: currentUser.name, createdAt: serverTimestamp(), isVisibleToClient: true });
        };

        // --- Docs & Fallback ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwzf-dHQRZZ9msG-SffH5dQo0obCvwcOGc6nsV82s3Kw33m2rhNMn7Jt9AaWjGy4_4M/exec";
        window.openDocSelector = async () => {
            document.getElementById('docSelectModal').style.display='flex';
            const list = document.getElementById('docsList');
            list.innerHTML = '<div class="p-4 text-center text-gray-400">×˜×•×¢×Ÿ...</div>';
            try {
                const res = await fetch(API_URL); if(!res.ok) throw new Error(); const data=await res.json(); renderDocs(data, list);
            } catch(e) { 
                renderDocs([{fileName:'×ª×¢×•×“×ª ××©×œ×•×— 881.pdf',date:'×¢×›×©×™×•'},{fileName:'×—×©×‘×•× ×™×ª 300.pdf',date:'08:00'}], list); 
            }
        };
        function renderDocs(d,c) { c.innerHTML = d.map(x=>`<div class="p-3 border-b hover:bg-gray-50 cursor-pointer flex justify-between" onclick="window.selectDoc('${x.fileName}')"><b>${x.fileName}</b><span class="text-xs">${x.date||''}</span></div>`).join(''); }
        
        window.selectDoc = (n) => { pendingDoc={name:n, url:'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf'}; document.getElementById('docSelectModal').style.display='none'; document.getElementById('pendingDocName').innerText=n; if(currentChatId) document.getElementById('pendingDocBar').classList.remove('hidden'); };
        window.attachDocToChat = async () => { 
            if(!pendingDoc || !currentChatId) return;
            await addDoc(collection(db, `orders/${currentChatId}/internal_chat`), { text: `ğŸ“ ××¡××š: ${pendingDoc.name}`, type: 'pdf', url: pendingDoc.url, sender: currentUser.name, createdAt: serverTimestamp(), isVisibleToClient: true });
            if(!chatsCache.find(x=>x.id===currentChatId)?.isTask) {
                await updateDoc(doc(db, "orders", currentChatId), { pdfUrl: pendingDoc.url, chat: arrayUnion({sender:'system', text:`ğŸ“ ×¦×•×¨×£: ${pendingDoc.name}`, time: new Date().toISOString()}) });
            }
            pendingDoc=null; document.getElementById('pendingDocBar').classList.add('hidden');
        };
        
        window.printOrder = (n,p,t,i,d) => { const w=window.open('','','width=800,height=900'); w.document.write(`<html><body style="padding:40px;text-align:right"><h1>×—.×¡×‘×Ÿ</h1><p>${n}</p><pre>${t}</pre><script>window.print()<\/script></body></html>`); w.document.close(); };
    </script>
</body>
</html>
