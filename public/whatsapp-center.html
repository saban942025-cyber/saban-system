<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        <title>SabanOS | " 爪注</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <style>
                @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');

                /* iOS Base Styles */
                body { 
                                background-color: #f2f2f7; /* iOS Gray */
                                font-family: 'Heebo', sans-serif; 
                                height: 100dvh; 
                                display: flex; 
                                flex-direction: column; 
                                overflow: hidden; 
                                -webkit-tap-highlight-color: transparent;
                }

                /* Layout */
                .app-shell { display: flex; flex: 1; height: 100%; overflow: hidden; position: relative; }
                .sidebar { width: 350px; background: white; border-left: 1px solid #e5e5ea; display: flex; flex-direction: column; z-index: 20; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
                .main-chat { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; position: relative; z-index: 10; }

                /* Mobile Logic */
                @media (max-width: 768px) {
                                .sidebar { width: 100%; position: absolute; inset: 0; }
                                .sidebar.hidden-mobile { transform: translateX(100%); }
                                .main-chat { position: absolute; inset: 0; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
                                .main-chat.active-mobile { transform: translateX(0); }
                }

                /* Header (Glassmorphism) */
                .app-header {
                                height: 60px;
                                background: rgba(255, 255, 255, 0.95);
                                backdrop-filter: blur(10px);
                                border-bottom: 1px solid #e5e5ea;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 0 16px;
                                z-index: 50;
                                flex-shrink: 0;
                }

                /* User & Logo */
                .user-pill {
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                background: #f2f2f7;
                                padding: 4px 12px 4px 4px;
                                border-radius: 99px;
                                transition: 0.2s;
                                cursor: pointer;
                }
                .user-pill:active { transform: scale(0.98); background: #e5e5ea; }
                .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                .live-indicator { width: 8px; height: 8px; background: #34c759; border-radius: 50%; box-shadow: 0 0 0 2px white; position: absolute; bottom: 0; right: 0; }

                /* Tools */
                .tool-btn { 
                                width: 36px; height: 36px; 
                                border-radius: 10px; 
                                display: flex; align-items: center; justify-content: center; 
                                color: #1c1c1e; 
                                transition: 0.2s;
                }
                .tool-btn:hover { background: #f2f2f7; }
                .tool-btn:active { transform: scale(0.95); }

                .mobile-menu {
                                position: absolute; top: 65px; left: 16px;
                                background: white; border-radius: 16px;
                                box-shadow: 0 10px 40px rgba(0,0,0,0.15);
                                width: 220px; padding: 8px;
                                transform: scale(0.9) opacity(0);
                                pointer-events: none;
                                transition: 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
                                transform-origin: top left;
                }
                .mobile-menu.open { transform: scale(1) opacity(1); pointer-events: auto; }
                .menu-item { padding: 12px; display: flex; items-center; gap: 12px; border-radius: 10px; color: #1c1c1e; font-size: 14px; font-weight: 500; transition: 0.2s; }
                .menu-item:active { background: #f2f2f7; }

                /* Chat List */
                .chat-list-item { 
                                padding: 12px 16px; 
                                display: flex; align-items: center; gap: 12px; 
                                border-bottom: 1px solid #f2f2f7; 
                                background: white;
                                transition: 0.2s;
                }
                .chat-list-item:active { background: #f2f2f7; }
                .chat-list-item.active { border-right: 4px solid #007aff; background: #f9f9fa; }

                /* Messages */
                .msg-container { padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
                .msg { max-width: 75%; padding: 8px 12px; border-radius: 16px; font-size: 15px; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
                .msg-in { align-self: flex-start; background: white; border-bottom-right-radius: 4px; color: #1c1c1e; }
                .msg-out { align-self: flex-end; background: #dcf8c6; border-bottom-left-radius: 4px; color: #1c1c1e; }
                .msg-internal { align-self: center; background: #fff9c4; border: 1px dashed #f59e0b; font-size: 13px; text-align: center; border-radius: 8px; width: 90%; }

                /* Input Area */
                .input-bar {
                                background: #f0f2f5;
                                padding: 8px 12px;
                       coik :dp x1p  oa u* b /ldr:d 0t;c:0 l;en  d: 2p 2 .0 itnc  e r" <dv ls=aphed>  le ibowcl d n  rsidca de     vi ia c"< l i< u-0o u sls </div>
                     v hAi a" a tnoeCa=mru-met"i   dep-nC
                    iA d2   d"=fae <iae> /      i a otaat ldi=l0"s> ds 
                      ctds vo"<y- -0e 2sh co-v> lsb ot0a<ie"ucikeEe k"0u s-dsan l-"<< ddvnso-ono-neg" o0ba dvio /v<>mdl   "odd n"
                     las=tx otb4t pumevn)p i =x n-o0m砖la>   x l 0> "s3x ehedo-  s laxueawe/  v
                       m
                       /i> citp"l>   imp itaep f "t:/wtcmrs/8
                      io{tiec, emtpoi/0sr.s; gsis  iotc r'Cc
                    sstaeedr "6p2e8  u  tc=laelsn;iedod.a ] inss" c dlM ( ( id0 't} ds s"tp/-& or-o> <1 f imetr 8
        s0e0fat)  =4"ltsa/ ;
          cdmIH>(  ur list.n olt$ghcr<p}c  ttmsld r'  at  tn dedr)dolmte-e eyI'cme r    tnmBdT=u''拽'maimght/pm={&
                                                                                                                ti     o, ,i)  e  pl  
                                                                                                                  aa.I(rtr e} vn}  / s yr}/`/i utoyr"   xnnsg M=    t d
          x[u) alb   (onesn t;    t = to -n  cl
          po `di ao:' i [xetga-c  bl ol   
        wnsg nml(tC gEm ' ar'{etnsos ta :'
                              ai et  t=r tDce lnM' i s)  ol   rrrn 
                              nl v@ .wemefnn; c dgEIm' a = eoM} <v 6 an vt(oi  le(PLd;  in{ u ep{` et} -os .s'r gmcavaI a eA'(sc)n-a'theI   o)dgI''tdnenowtgnrM e a转
                              -la)
                              c n"fl -t ne'-;
                               g b cD eHl "s/cs0; L(b'dlb.naf拽"So;w)=
                              c()lo( o=  une enudi e

                                    cS e')nUr
                              <t- 0r fcn-"=wpx>  eu a iat;   sm=dlmd'N)ao(a 
                               erdb c es `tm{ed,cetm) p os w.e.L('e 
                                              /gnwL,.ir;><
    </style></title>
</head></div>

        <div class="sidebar-tabs">
            <div onclick="switchTab('chats')" class="tab-btn active" id="tab-chats"> 爪'</div>
            <div onclick="switchTab('groups')" class="tab-btn" id="tab-groups"> 拽爪转</div>
        </div>

        <div id="chatsList" class="flex-1 overflow-y-auto bg-white custom-scroll"></div>
        <div id="groupsList" class="flex-1 overflow-y-auto bg-white hidden custom-scroll"></div>
        <div id="tasksList" class="flex-1 overflow-y-auto bg-gray-50 hidden custom-scroll p-2"></div>
    </div>

    <div id="chatArea" class="main-chat hidden">
        <div class="chat-header">
            <div class="flex items-center gap-3 cursor-pointer" onclick="openCRM()">
                <img id="activeAvatar" src="" class="w-10 h-10 rounded-full border border-gray-300 object-cover">
                <div>
                    <div id="activeName" class="font-bold text-gray-800"></div>
                    <div id="activeDesc" class="text-xs text-gray-500">抓 转拽 拽</div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleBot()" id="botBtn" class="bg-white px-3 py-1.5 rounded-lg border text-xs font-bold text-gray-600 hover:bg-gray-50"><i class="fas fa-robot text-green-600"></i> </button>
                <button onclick="openTaskModal(true)" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm flex items-center gap-2"><i class="fas fa-check-circle"></i> 砖</button>
            </div>
        </div>

        <div id="messagesBox" class="flex-1 overflow-y-auto flex flex-col p-4 gap-2"></div>

        <div id="mentionPopup" class="smart-popup"><div class="bg-gray-50 p-2 text-xs font-bold border-b">专 转 (@):</div><div id="mentionList"></div></div>
        <div id="productPopup" class="smart-popup"><div class="bg-gray-50 p-2 text-xs font-bold border-b">专 爪专 (#):</div><div id="productList"></div></div>

        <div id="stickyNote" class="hidden absolute top-20 right-4 w-48 bg-yellow-100 p-3 rounded-lg shadow-md border border-yellow-300 text-xs transform rotate-1 z-10">
            <textarea class="w-full bg-transparent outline-none resize-none" rows="3" placeholder="驻转拽 砖 ..."></textarea>
            <i onclick="this.parentElement.classList.add('hidden')" class="fas fa-times absolute top-1 left-1 cursor-pointer"></i>
        </div>

        <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t relative shrink-0">
            <i onclick="document.getElementById('stickyNote').classList.remove('hidden')" class="fas fa-sticky-note text-xl text-yellow-500 cursor-pointer p-2" title="驻转拽"></i>
            <i onclick="toggleInternalMode()" id="internalBtn" class="fas fa-eye-slash text-xl text-gray-400 cursor-pointer p-2" title="注专 驻转"></i>
            <div class="flex-1 relative"><input type="text" id="msgInput" class="w-full p-3 rounded-xl border-none outline-none shadow-sm text-sm" placeholder="拽 注... (@ 转, # 爪专)" oninput="handleInput(this)" onkeydown="if(event.key === 'Enter') sendMessage()"></div>
            <button onclick="sendMessage()" class="w-10 h-10 flex items-center justify-center bg-[#00a884] text-white rounded-full shadow hover:bg-[#008f6f]"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="groupModal" class="modal-overlay"><div class="modal-box"><h2 class="text-lg font-bold mb-4" id="groupModalTitle">拽爪 砖</h2><form onsubmit="handleGroupSubmit(event)" class="space-y-3"><input type="hidden" id="editGroupId"><input type="text" id="gName" class="w-full p-2 border rounded text-sm" placeholder="砖 拽爪" required><input type="text" id="gImg" class="w-full p-2 border rounded text-sm" placeholder="转 (URL)"><input type="text" id="gDesc" class="w-full p-2 border rounded text-sm" placeholder="转专"><div class="border p-2 rounded max-h-40 overflow-y-auto bg-gray-50"><div class="text-xs font-bold mb-2">砖转转驻:</div><div id="usersForGroup" class="space-y-1"></div></div><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="closeModal('groupModal')" class="text-gray-500 text-sm font-bold"></button><button type="submit" class="bg-[#00a884] text-white px-4 py-2 rounded text-sm font-bold">砖专</button></div></form></div></div>
    
    <div id="forwardModal" class="modal-overlay"><div class="modal-box h-[500px]"><div class="flex justify-between items-center mb-4 border-b pb-2"><h2 class="text-lg font-bold">注专转 注</h2><button onclick="closeModal('forwardModal')"><i class="fas fa-times"></i></button></div><div class="bg-gray-100 p-3 rounded-lg text-sm text-gray-600 mb-4 italic truncate" id="previewMsg"></div><input type="text" placeholder="驻砖 注..." oninput="filterForwardList(this.value)" class="w-full p-2 border rounded mb-2 text-sm"><div id="forwardList" class="flex-1 overflow-y-auto space-y-1"></div></div></div>

    <div id="crmModal" class="modal-overlay">
        <div class="modal-box w-[600px]">
            <div class="flex justify-between items-start mb-6">
                <div class="flex gap-4">
                    <img id="crmAvatar" src="" class="profile-img">
                    <div class="flex-1">
                        <input id="crmName" class="text-2xl font-bold text-slate-800 bg-transparent editable-field mb-1">
                        <div class="flex gap-2">
                            <input id="crmPhone" class="text-sm text-gray-500 bg-transparent editable-field w-32">
                            <input id="crmEmail" class="text-sm text-gray-500 bg-transparent editable-field flex-1">
                        </div>
                    </div>
                </div>
                <button onclick="closeModal('crmModal')"><i class="fas fa-times text-gray-400 hover:text-red-500 text-xl"></i></button>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-xl border mb-4">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">驻专拽</h3>
                <div id="crmProjects" class="space-y-2"></div>
                <button onclick="addProjectRow()" class="mt-2 text-xs text-blue-600 font-bold hover:underline">+ 住祝 驻专拽</button>
            </div>

            <div class="flex justify-end gap-2 mt-auto border-t pt-4">
                <button onclick="openTaskModal(true)" class="bg-blue-100 text-blue-700 px-4 py-2 rounded font-bold text-sm">砖 砖</button>
                <button onclick="saveCRM()" class="bg-[#008069] text-white px-4 py-2 rounded font-bold text-sm">砖专 砖</button>
            </div>
        </div>
    </div>

    <div id="taskModal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-lg font-bold mb-4">爪专转 砖</h2>
            <div class="space-y-3">
                <input type="text" id="taskTitle" class="w-full border p-2 rounded text-sm font-bold" placeholder="转专转 砖">
                <div class="grid grid-cols-2 gap-3">
                    <select id="taskTo" class="w-full border p-2 rounded text-sm"><option value="rami">专</option><option value="nat">转</option><option value="driver"></option></select>
                    <select id="taskPrio" class="w-full border p-2 rounded text-sm"><option value="low">专</option><option value="high">祝 </option></select>
                </div>
                <input type="text" id="taskDate" class="w-full border p-2 rounded text-sm" placeholder="转专 注...">
                <textarea id="taskDesc" class="w-full border p-2 rounded text-sm h-20" placeholder="驻专..."></textarea>
                
                <div class="border-2 border-dashed border-gray-300 rounded p-3 text-center cursor-pointer hover:bg-gray-50" onclick="alert('专 拽抓...')">
                    <i class="fas fa-paperclip text-gray-400"></i> <span class="text-xs text-gray-500">爪专祝 转注/住</span>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('taskModal')" class="text-gray-500 text-sm font-bold"></button>
                <button onclick="createTask()" class="bg-blue-600 text-white px-6 py-2 rounded text-sm font-bold">爪专</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { SabanPush } from './js/notifications.js';
        import { SmartContacts } from './js/smart-contacts.js';
        import { TaskEngine } from './js/task-engine.js'; 

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let activeChatId = null;
        let activeType = 'private';
        let internalMode = false;
        let botEnabled = true;
        let activeUser = null;
        
        let allUsers = [];
        let allProducts = [];
        let allChats = [];
        let msgToForward = null;

        SabanPush.init('admin', 'admin_rami');
        flatpickr("#taskDate", { enableTime: true, dateFormat: "Y-m-d H:i", minDate: "today" });
        loadData();

        async function loadData() {
            const uSnap = await getDocs(collection(db, "users"));
            allUsers = uSnap.docs.map(d => ({id: d.id, ...d.data()}));
            const pSnap = await getDocs(collection(db, "products"));
            allProducts = pSnap.docs.map(d => ({id: d.id, ...d.data()}));
            renderUserSelection([]);
        }

        // --- TABS & LISTS ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.getElementById('chatsList').classList.add('hidden');
            document.getElementById('groupsList').classList.add('hidden');
            document.getElementById('tasksList').classList.add('hidden');
            
            document.getElementById(`${tab}List`).classList.remove('hidden');
        };

        // Chats
        onSnapshot(query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc")), (snap) => {
            const list = document.getElementById('chatsList'); list.innerHTML = "";
            allChats = [];
            snap.forEach(d => {
                const c = d.data();
                allChats.push({id: d.id, name: c.userName, type: 'private', img: `https://ui-avatars.com/api/?name=${c.userName}`});
                const active = activeChatId === d.id ? 'active' : '';
                list.innerHTML += `<div onclick="openChat('${d.id}', '${c.userName}', 'private')" class="chat-item ${active}"><img src="https://ui-avatars.com/api/?name=${c.userName}&background=random&color=fff" class="w-10 h-10 rounded-full ml-3"><div class="flex-1 min-w-0"><div class="flex justify-between"><span class="font-bold text-sm">${c.userName}</span><span class="text-[10px] text-gray-400"></span></div><div class="text-xs text-gray-500 truncate">${c.lastMessage}</div></div></div>`;
            });
        });

        // Groups
        onSnapshot(collection(db, "groups"), (snap) => {
            const list = document.getElementById('groupsList'); list.innerHTML = "";
            snap.forEach(d => {
                const g = d.data();
                allChats.push({id: d.id, name: g.name, type: 'group', img: g.image});
                const active = activeChatId === d.id ? 'active' : '';
                const gData = encodeURIComponent(JSON.stringify({id: d.id, ...g}));
                list.innerHTML += `<div onclick="openChat('${d.id}', '${g.name}', 'group', '${g.image}')" class="chat-item ${active} group"><img src="${g.image||'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full ml-3 object-cover"><div class="flex-1 min-w-0"><div class="font-bold text-sm">${g.name}</div><div class="text-xs text-gray-500 truncate">${g.desc||''}</div></div><div class="group-actions bg-white shadow rounded p-1" onclick="event.stopPropagation()"><button onclick="editGroup('${gData}')" class="text-blue-500 p-1"><i class="fas fa-pen"></i></button><button onclick="deleteGroup('${d.id}')" class="text-red-500 p-1"><i class="fas fa-trash"></i></button></div></div>`;
            });
        });

        // Tasks
        onSnapshot(query(collection(db, "tasks"), orderBy("createdAt", "desc")), (snap) => {
            const list = document.getElementById('tasksList'); list.innerHTML = "";
            snap.forEach(d => {
                const t = d.data();
                const border = t.priority === 'high' ? 'border-red-500' : 'border-gray-300';
                list.innerHTML += `<div class="bg-white p-3 rounded border-r-4 ${border} shadow-sm mb-2 cursor-pointer hover:bg-blue-50"><div class="font-bold text-xs text-gray-800">${t.title}</div><div class="flex justify-between mt-1"><span class="text-[10px] text-gray-500">注专: ${t.toUid}</span><span class="text-[10px] bg-gray-100 px-1 rounded">${t.status}</span></div></div>`;
            });
        });

        // --- CHAT ENGINE ---
        window.openChat = async (id, name, type, img) => {
            activeChatId = id; activeType = type;
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('activeName').innerText = name;
            document.getElementById('activeDesc').innerText = type==='group'?'拽爪':'拽';
            document.getElementById('activeAvatar').src = img || `https://ui-avatars.com/api/?name=${name}&background=random&color=fff`;

            if(type === 'private') {
                try {
                    const uSnap = await getDoc(doc(db, "users", id));
                    if(uSnap.exists()) activeUser = { id: id, ...uSnap.data() };
                    else activeUser = { id: id, name, role: '拽', projects: [] };
                } catch(e) {}
            } else activeUser = null;

            const coll = type==='group' ? `groups/${id}/messages` : `chat_sessions/${id}/messages`;
            onSnapshot(query(collection(db, coll), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('messagesBox');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    let txt = m.text.replace(/@([\u0590-\u05FF\w\s]+)/g, '<span class="tag-mention">@$1</span>').replace(/\[(.*?)\]/g, '<span class="tag-product">$1</span>');
                    const side = m.role==='staff'?'bg-[#d9fdd3] self-end':'bg-white self-start';
                    const tools = `<div class="msg-tools"><div onclick="initForward('${encodeURIComponent(m.text)}')" class="btn-forward"><i class="fas fa-share"></i></div></div>`;
                    
                    if(m.role==='internal') return `<div class="msg internal"> ${txt}</div>`;
                    
                    return `<div class="msg ${side}">
                        <div class="text-xs font-bold text-gray-500 mb-1 flex justify-between"><span>${m.sender}</span>${m.forwarded?'<span class="text-[9px] italic">锔 注专</span>':''}</div>
                        <div>${txt}</div>
                        <div class="text-[9px] text-gray-400 text-left mt-1">${formatTime(m.createdAt)}</div>
                        ${tools}
                    </div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMessage = async () => {
            const txt = document.getElementById('msgInput').value; if(!txt || !activeChatId) return;
            document.getElementById('msgInput').value = '';
            
            const coll = activeType==='group' ? `groups/${activeChatId}/messages` : `chat_sessions/${activeChatId}/messages`;
            await addDoc(collection(db, coll), { text: txt, role: internalMode?'internal':'staff', sender: "专", createdAt: serverTimestamp() });
            
            if(activeType==='private') updateDoc(doc(db, "chat_sessions", activeChatId), { lastMessage: txt, lastActivity: serverTimestamp(), isBotActive: botEnabled });
        };

        // --- CRM & TASKS ---
        window.openCRM = () => {
            if(!activeUser) return;
            document.getElementById('crmName').value = activeUser.name;
            document.getElementById('crmPhone').value = activeUser.phone||'';
            document.getElementById('crmEmail').value = activeUser.email||'';
            document.getElementById('crmAvatar').src = activeUser.avatar||'';
            
            const pBox = document.getElementById('crmProjects');
            pBox.innerHTML = (activeUser.projects||[]).map((p,i)=>`<div class="flex gap-2 items-center bg-white p-2 border rounded mb-1"><input class="text-xs font-bold flex-1 border-none outline-none" value="${p.name}" onchange="updateProject(${i},'name',this.value)"><input class="text-xs text-gray-500 w-1/3 border-none outline-none" value="${p.address}" onchange="updateProject(${i},'address',this.value)"><i class="fas fa-trash text-gray-300 hover:text-red-500 cursor-pointer" onclick="removeProject(${i})"></i></div>`).join('');
            
            document.getElementById('crmModal').classList.add('open');
        };

        window.addProjectRow = () => { if(!activeUser.projects) activeUser.projects=[]; activeUser.projects.push({name:'砖',address:''}); window.openCRM(); };
        window.updateProject = (i,f,v) => activeUser.projects[i][f]=v;
        window.removeProject = (i) => { activeUser.projects.splice(i,1); window.openCRM(); };
        window.saveCRM = async () => { await updateDoc(doc(db,"users",activeUser.id), {name:document.getElementById('crmName').value, phone:document.getElementById('crmPhone').value, projects:activeUser.projects}); alert("砖专!"); closeModal('crmModal'); };

        window.openTaskModal = (fromCRM=false) => { if(fromCRM) closeModal('crmModal'); if(!activeUser) return alert("专 拽"); document.getElementById('taskTitle').value=`砖: ${activeUser.name}`; document.getElementById('taskModal').classList.add('open'); };
        window.createTask = async () => {
            await TaskEngine.createTask(db, {
                title: document.getElementById('taskTitle').value, desc: document.getElementById('taskDesc').value, toUid: document.getElementById('taskTo').value, priority: document.getElementById('taskPrio').value, dueDate: document.getElementById('taskDate').value, status:'open'
            });
            await addDoc(collection(db, `chat_sessions/${activeUser.id}/messages`), { text: ` 砖 爪专: ${document.getElementById('taskTitle').value}`, role: 'internal', createdAt: serverTimestamp() });
            closeModal('taskModal');
        };

        // --- SMART INPUT ---
        window.handleInput = (el) => {
            const val = el.value;
            if(val.includes('@')) {
                const term = val.split('@').pop().toLowerCase();
                const matches = allUsers.filter(u => u.name.toLowerCase().includes(term));
                showPopup('mention', matches, u => { el.value = val.replace(/@\w*$/, `@${u.name} `); closePopups(); });
            } else if(val.includes('#')) {
                const term = val.split('#').pop().toLowerCase();
                const matches = allProducts.filter(p => (p.core?.name||p.title||"").toLowerCase().includes(term));
                showPopup('product', matches, p => { el.value = val.replace(/#\w*$/, `[${p.core?.name||p.title}] `); closePopups(); });
            } else closePopups();
        };

        function showPopup(type, items, cb) {
            const pop = document.getElementById(type+'Popup');
            const list = document.getElementById(type+'List');
            if(!items.length) { pop.style.display='none'; return; }
            pop.style.display='block';
            list.innerHTML = items.map((i, idx) => `<div class="smart-item" data-idx="${idx}"><img src="${i.avatar||i.rich?.image||'https://via.placeholder.com/30'}" class="w-8 h-8 rounded"><div class="text-sm font-bold">${i.name||i.core?.name||i.title}</div></div>`).join('');
            list.querySelectorAll('.smart-item').forEach(el => el.onclick = () => cb(items[el.dataset.idx]));
        }
        function closePopups() { document.querySelectorAll('.smart-popup').forEach(p=>p.style.display='none'); document.getElementById('msgInput').focus(); }

        // --- ACTIONS ---
        window.openContactCard = (e) => { if(activeUser) SmartContacts.show(e, activeUser); };
        window.toggleBot = () => { botEnabled=!botEnabled; document.getElementById('botBtn').innerHTML = botEnabled ? '<i class="fas fa-robot text-green-600"></i>  驻注' : '<i class="fas fa-robot text-red-500"></i>  '; };
        window.toggleInternalMode = () => { internalMode=!internalMode; document.getElementById('msgInput').placeholder = internalMode?"注专 驻转...":"拽..."; document.getElementById('internalBtn').className = internalMode?"fas fa-eye-slash text-xl text-orange-500 p-2":"fas fa-eye text-xl text-gray-400 p-2"; };
        
        // Groups & Forward
        window.openGroupModal = () => { document.getElementById('groupModalTitle').innerText="拽爪 砖"; document.getElementById('editGroupId').value=""; document.querySelector('form').reset(); renderUserSelection([]); document.getElementById('groupModal').classList.add('open'); };
        window.editGroup = (s) => { const g=JSON.parse(decodeURIComponent(s)); document.getElementById('groupModalTitle').innerText="注专"; document.getElementById('editGroupId').value=g.id; document.getElementById('gName').value=g.name; document.getElementById('gImg').value=g.image; document.getElementById('gDesc').value=g.desc; document.getElementById('groupModal').classList.add('open'); };
        window.deleteGroup = async (id) => { if(confirm("拽?")) await deleteDoc(doc(db, "groups", id)); };
        window.handleGroupSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editGroupId').value;
            const data = { name: document.getElementById('gName').value, image: document.getElementById('gImg').value, desc: document.getElementById('gDesc').value, lastUpdated: serverTimestamp() };
            if(id) await updateDoc(doc(db,"groups",id), data); else await addDoc(collection(db,"groups"), {...data, createdAt: serverTimestamp()});
            closeModal('groupModal');
        };
        
        window.initForward = (txt) => { msgToForward = decodeURIComponent(txt); document.getElementById('previewMsg').innerText=msgToForward; renderForwardList(allChats); document.getElementById('forwardModal').classList.add('open'); };
        function renderForwardList(l) { document.getElementById('forwardList').innerHTML = l.map(c=>`<div onclick="execForward('${c.id}','${c.type}')" class="target-item"><img src="${c.img}" class="w-8 h-8 rounded ml-2"><div><div class="font-bold text-sm">${c.name}</div><div class="text-xs text-gray-400">${c.type}</div></div></div>`).join(''); }
        window.filterForwardList = (v) => renderForwardList(allChats.filter(c=>c.name.toLowerCase().includes(v.toLowerCase())));
        window.execForward = async (id, type) => {
            if(!confirm("注专?")) return;
            const coll = type==='group' ? `groups/${id}/messages` : `chat_sessions/${id}/messages`;
            await addDoc(collection(db, coll), { text: msgToForward, role: 'staff', sender: "专 (注专)", forwarded: true, createdAt: serverTimestamp() });
            closeModal('forwardModal');
        };

        // Utils
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');
        function formatTime(ts) { return ts ? new Date(ts.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''; }
        window.handleLogout = async () => { if(confirm("爪转?")) { localStorage.clear(); await signOut(auth); location.href="index.html"; } };
        function renderUserSelection(ids) { document.getElementById('usersForGroup').innerHTML = allUsers.map(u=>`<label class="flex justify-between p-2 hover:bg-gray-50 border-b"><div class="flex gap-2"><img src="${u.avatar}" class="w-6 h-6 rounded"><span>${u.name}</span></div><input type="checkbox" class="accent-green-600"></label>`).join(''); }

    </script>
</body>
</html>

