<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Admin | ניהול קטלוג</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background: #f1f5f9; font-family: 'Heebo', sans-serif; }
        
        /* Sidebar */
        .sidebar {
            width: 280px; background: #0f172a; color: white; height: 100vh;
            position: fixed; right: 0; display: flex; flex-direction: column;
            padding: 20px;
        }
        
        .nav-item {
            padding: 12px; border-radius: 10px; margin-bottom: 5px;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: #3b82f6; font-weight: bold; }

        /* Main Content */
        .main-content { margin-right: 280px; padding: 30px; }
        
        /* Product Card */
        .product-row {
            background: white; border-bottom: 1px solid #e2e8f0;
            display: grid; grid-template-columns: 60px 2fr 1fr 1fr 1fr 1fr;
            align-items: center; padding: 15px; transition: 0.2s;
        }
        .product-row:hover { background: #f8fafc; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .badge-stock { background: #dcfce7; color: #166534; }
        .badge-low { background: #fee2e2; color: #991b1b; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 16px; padding: 0; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 20px; }
        
        .input-group { margin-bottom: 15px; }
        .label { display: block; font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        .input { width: 100%; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; outline: none; }
        .input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="text-2xl font-black mb-10 flex items-center gap-3">
            <i class="fas fa-cubes text-blue-500"></i> Saban<span class="text-blue-500">Admin</span>
        </div>
        <div class="nav-item active"><i class="fas fa-box"></i> קטלוג מוצרים</div>
        <div class="nav-item"><i class="fas fa-tags"></i> מבצעים חמים</div>
        <div class="nav-item"><i class="fas fa-chart-line"></i> דוחות מלאי</div>
        <div class="mt-auto nav-item text-red-400"><i class="fas fa-sign-out-alt"></i> יציאה</div>
    </div>

    <div class="main-content">
        
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-3xl font-black text-slate-800">ניהול קטלוג</h1>
                <p class="text-slate-500">הוסף, ערוך ונהל את מוצרי החנות</p>
            </div>
            <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2">
                <i class="fas fa-plus"></i> מוצר חדש
            </button>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex gap-4 items-center">
            <div class="flex-1 bg-gray-50 rounded-lg flex items-center px-4 border">
                <i class="fas fa-search text-gray-400"></i>
                <input id="searchBox" type="text" placeholder="חיפוש לפי שם, מקט או תגיות..." class="bg-transparent border-none outline-none w-full p-3" oninput="filterProducts()">
            </div>
            <select id="filterCat" class="bg-gray-50 border rounded-lg p-3 outline-none" onchange="filterProducts()">
                <option value="all">כל הקטגוריות</option>
                <option value="cement">מלט וטיח</option>
                <option value="glue">דבקים ורובה</option>
                <option value="paint">צבע וגמר</option>
                <option value="tools">כלי עבודה</option>
            </select>
        </div>

        <div class="grid grid-cols-[60px_2fr_1fr_1fr_1fr_1fr] gap-4 px-4 py-2 text-xs font-bold text-gray-500 uppercase">
            <div>תמונה</div>
            <div>שם המוצר / מק"ט</div>
            <div>קטגוריה</div>
            <div>מחיר</div>
            <div>מלאי</div>
            <div>פעולות</div>
        </div>

        <div id="productsList" class="space-y-2">
            <div class="text-center py-10 text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> טוען נתונים...</div>
        </div>

    </div>

    <div id="productModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h2 class="text-xl font-bold" id="modalTitle">מוצר חדש</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <form id="productForm" onsubmit="event.preventDefault(); saveProduct();">
                <input type="hidden" id="editId">
                <div class="modal-body">
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-sm font-bold text-blue-600 uppercase mb-3 border-b pb-1">פרטים כלליים</h3>
                            <div class="input-group">
                                <label class="label">שם המוצר</label>
                                <input type="text" id="pName" class="input font-bold" required>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="input-group">
                                    <label class="label">מק"ט (SKU)</label>
                                    <input type="text" id="pSku" class="input uppercase">
                                </div>
                                <div class="input-group">
                                    <label class="label">קטגוריה</label>
                                    <select id="pCat" class="input">
                                        <option value="cement">מלט וטיח</option>
                                        <option value="glue">דבקים ורובה</option>
                                        <option value="paint">צבע וגמר</option>
                                        <option value="tools">כלי עבודה</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="input-group">
                                    <label class="label">מחיר ללקוח (₪)</label>
                                    <input type="number" id="pPrice" class="input font-mono">
                                </div>
                                <div class="input-group">
                                    <label class="label">מלאי נוכחי</label>
                                    <input type="number" id="pStock" class="input" value="100">
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-bold text-purple-600 uppercase mb-3 border-b pb-1">מפרט טכני (לקבלן)</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="input-group">
                                    <label class="label">משקל (ק"ג)</label>
                                    <input type="text" id="sWeight" class="input" placeholder="25">
                                </div>
                                <div class="input-group">
                                    <label class="label">כיסוי (מ"ר)</label>
                                    <input type="text" id="sCover" class="input" placeholder="12">
                                </div>
                                <div class="input-group">
                                    <label class="label">זמן ייבוש</label>
                                    <input type="text" id="sDry" class="input" placeholder="24 שעות">
                                </div>
                            </div>

                            <div class="input-group">
                                <label class="label">תגיות חכמות (לחיפוש)</label>
                                <input type="text" id="pTags" class="input" placeholder="איטום, גגות, חורף, דבק...">
                                <p class="text-[10px] text-gray-400 mt-1">מופרד בפסיקים. עוזר ל-AI למצוא את המוצר.</p>
                            </div>

                            <div class="input-group">
                                <label class="label">תמונה (URL)</label>
                                <input type="text" id="pImg" class="input text-xs" onchange="document.getElementById('imgPrev').src=this.value">
                            </div>
                            <img id="imgPrev" src="" class="h-20 w-20 object-cover rounded border bg-gray-50 mx-auto">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="label flex justify-between">
                            <span>תיאור שיווקי</span>
                            <button type="button" onclick="generateDesc()" class="text-xs text-blue-500 hover:underline"><i class="fas fa-magic"></i> כתוב לי תיאור עם Gemini</button>
                        </label>
                        <textarea id="pDesc" class="input h-20"></textarea>
                    </div>

                </div>
                <div class="p-5 bg-gray-50 flex justify-end gap-3 rounded-b-xl">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-200">ביטול</button>
                    <button type="submit" class="px-6 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 shadow">שמור מוצר</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let products = [];

        // --- LOAD PRODUCTS ---
        async function loadProducts() {
            const list = document.getElementById('productsList');
            const snap = await getDocs(collection(db, "products"));
            products = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderList(products);
        }

        function renderList(data) {
            const list = document.getElementById('productsList');
            if(data.length === 0) { list.innerHTML = '<div class="text-center p-5 text-gray-400">אין מוצרים</div>'; return; }

            list.innerHTML = data.map(p => `
                <div class="product-row">
                    <img src="${p.img || 'https://via.placeholder.com/50'}" class="w-10 h-10 rounded object-cover border">
                    <div>
                        <div class="font-bold text-slate-800">${p.name}</div>
                        <div class="text-xs text-slate-400 font-mono">${p.sku}</div>
                    </div>
                    <div class="text-sm text-gray-600">${catName(p.category)}</div>
                    <div class="font-bold font-mono">₪${p.price}</div>
                    <div>
                        <span class="badge ${p.stock < 10 ? 'badge-low' : 'badge-stock'}">
                            ${p.stock} יח' במלאי
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.editProduct('${p.id}')" class="text-blue-500 hover:bg-blue-100 p-2 rounded"><i class="fas fa-pen"></i></button>
                        <button onclick="window.deleteProduct('${p.id}')" class="text-red-500 hover:bg-red-100 p-2 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // --- FILTERING ---
        window.filterProducts = () => {
            const txt = document.getElementById('searchBox').value.toLowerCase();
            const cat = document.getElementById('filterCat').value;

            const filtered = products.filter(p => {
                const matchText = p.name.toLowerCase().includes(txt) || 
                                  p.sku.toLowerCase().includes(txt) ||
                                  (p.tags && p.tags.includes(txt)); // חיפוש תגיות חכם!
                const matchCat = cat === 'all' || p.category === cat;
                return matchText && matchCat;
            });
            renderList(filtered);
        };

        // --- CRUD ---
        window.openModal = () => {
            document.getElementById('productForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').innerText = "מוצר חדש";
            document.getElementById('imgPrev').src = '';
            document.getElementById('productModal').style.display = 'flex';
        };

        window.closeModal = () => document.getElementById('productModal').style.display = 'none';

        window.editProduct = (id) => {
            const p = products.find(x => x.id === id);
            document.getElementById('editId').value = id;
            document.getElementById('modalTitle').innerText = "עריכת מוצר: " + p.name;
            
            document.getElementById('pName').value = p.name;
            document.getElementById('pSku').value = p.sku;
            document.getElementById('pCat').value = p.category || 'tools';
            document.getElementById('pPrice').value = p.price;
            document.getElementById('pStock').value = p.stock || 0;
            document.getElementById('pImg').value = p.img || '';
            document.getElementById('imgPrev').src = p.img || '';
            document.getElementById('pDesc').value = p.desc || '';
            document.getElementById('pTags').value = p.tags || '';

            // Specs
            document.getElementById('sWeight').value = p.specs?.weight || '';
            document.getElementById('sCover').value = p.specs?.cover || '';
            document.getElementById('sDry').value = p.specs?.dry || '';

            document.getElementById('productModal').style.display = 'flex';
        };

        window.saveProduct = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('pName').value,
                sku: document.getElementById('pSku').value,
                category: document.getElementById('pCat').value,
                price: Number(document.getElementById('pPrice').value),
                stock: Number(document.getElementById('pStock').value),
                img: document.getElementById('pImg').value,
                desc: document.getElementById('pDesc').value,
                tags: document.getElementById('pTags').value, // מילות מפתח לחיפוש
                specs: {
                    weight: document.getElementById('sWeight').value,
                    cover: document.getElementById('sCover').value,
                    dry: document.getElementById('sDry').value
                },
                updatedAt: serverTimestamp()
            };

            if(id) {
                await updateDoc(doc(db, "products", id), data);
            } else {
                data.createdAt = serverTimestamp();
                await addDoc(collection(db, "products"), data);
            }
            closeModal();
            loadProducts();
        };

        window.deleteProduct = async (id) => {
            if(confirm("למחוק מוצר זה לצמיתות?")) {
                await deleteDoc(doc(db, "products", id));
                loadProducts();
            }
        };

        // --- UTILS ---
        window.generateDesc = () => {
            const name = document.getElementById('pName').value;
            if(!name) return alert("הכנס שם מוצר קודם");
            document.getElementById('pDesc').value = `Gemini AI: כותב תיאור ל-${name}...\n(סימולציה: מוצר זה הינו בעל עמידות גבוהה, מתאים לתנאי חוץ קשים ומומלץ על ידי הקבלנים המובילים בשוק.)`;
        };

        function catName(key) {
            const map = { cement: 'מלט וטיח', glue: 'דבקים', paint: 'צבע', tools: 'כלי עבודה' };
            return map[key] || key;
        }

        // Init
        loadProducts();

        // Export globals
        window.saveProduct = saveProduct; 
    </script>
</body>
</html>
