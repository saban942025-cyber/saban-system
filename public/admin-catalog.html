<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Catalog Ultimate ğŸ’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Windows 11 Glass Theme */
        :root {
            --glass: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.8);
            --primary: #2563eb;
            --bg-gradient: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        body { background: var(--bg-gradient); font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: #1e293b; }

        /* Layout Grid */
        .workspace { display: grid; grid-template-columns: 260px 380px 1fr 340px; gap: 15px; padding: 15px; height: 100%; overflow: hidden; }
        
        /* Panels */
        .panel {
            background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid white; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .panel-header { padding: 15px; border-bottom: 1px solid #f1f5f9; font-weight: bold; display: flex; justify-content: space-between; align-items: center; background: white; }
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* Tab Buttons */
        .nav-btn {
            display: flex; align-items: center; gap: 10px; padding: 12px;
            border-radius: 10px; cursor: pointer; transition: 0.2s; font-weight: 600; color: #64748b; margin-bottom: 5px;
        }
        .nav-btn:hover { background: #f1f5f9; color: var(--primary); }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* Google Results */
        .g-result { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; margin-bottom: 10px; }
        .g-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 8px; }
        .g-btn { font-size: 10px; padding: 4px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; text-align: center; }
        .g-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* Editor Inputs */
        .inp-group { margin-bottom: 12px; }
        .inp-label { font-size: 11px; font-weight: 700; color: #475569; display: block; margin-bottom: 4px; text-transform: uppercase; }
        .inp { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 13px; outline: none; background: white; }
        .inp:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }

        /* Preview Card (iPhone Style) */
        .preview-wrapper { background: #1e293b; border-radius: 30px; padding: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); height: 100%; }
        .preview-screen { background: #f1f5f9; border-radius: 20px; height: 100%; overflow-y: auto; position: relative; }
        
        .product-card { background: white; border-radius: 16px; overflow: hidden; margin-top: 10px; border: 1px solid #e2e8f0; position: relative; }
        .sale-badge { position: absolute; top: 10px; left: 10px; background: #ef4444; color: white; font-size: 10px; font-weight: bold; px-2; py-1; border-radius: 20px; z-index: 10; box-shadow: 0 2px 5px rgba(239,68,68,0.3); }
        .popup-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .popup-box { background: white; padding: 20px; border-radius: 20px; width: 80%; text-align: center; animation: popIn 0.3s; }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Inventory Item */
        .inv-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 10px; margin-bottom: 5px; border: 1px solid #f1f5f9; cursor: pointer; }
        .inv-item:hover { border-color: var(--primary); }
    </style>
</head>
<body>

    <header class="h-14 bg-white/80 backdrop-blur border-b flex items-center justify-between px-6 shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center text-white text-lg shadow">ğŸ›ï¸</div>
            <div>
                <h1 class="font-bold text-slate-800 leading-none">Saban Catalog Ultimate</h1>
                <div class="text-[10px] text-green-600 font-bold uppercase">××—×•×‘×¨ ×œ×¨×©×ª (Live)</div>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="clearForm()" class="text-slate-500 hover:text-red-500 font-bold text-xs">× ×§×” ×˜×•×¤×¡</button>
            <button onclick="saveProduct()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition text-sm flex items-center gap-2">
                <i class="fas fa-save"></i> ×©××•×¨ ××•×¦×¨
            </button>
        </div>
    </header>

    <div class="workspace">
        
        <div class="panel p-4">
            <div class="text-xs font-bold text-slate-400 mb-4 uppercase">×ª×¤×¨×™×˜ × ×™×”×•×œ</div>
            <div onclick="setTab('search')" class="nav-btn active" id="btn-search"><i class="fab fa-google"></i> ×—×™×¤×•×© ×•×™×™×‘×•×</div>
            <div onclick="setTab('inventory')" class="nav-btn" id="btn-inventory"><i class="fas fa-boxes"></i> × ×™×”×•×œ ××œ××™</div>
            <div onclick="setTab('promo')" class="nav-btn" id="btn-promo"><i class="fas fa-tags text-red-500"></i> ××‘×¦×¢×™× ×•-Popup</div>
            <div onclick="setTab('cats')" class="nav-btn" id="btn-cats"><i class="fas fa-th-large"></i> ×§×˜×’×•×¨×™×•×ª ×•××•×ª×’×™×</div>
        </div>

        <div class="panel">
            <div id="view-search" class="h-full flex flex-col">
                <div class="panel-header text-blue-600"><span><i class="fas fa-globe"></i> ×—×™×¤×•×© ×‘×¨×©×ª</span></div>
                <div class="p-3 bg-white border-b relative">
                    <input id="searchInput" class="inp font-bold" placeholder="×”×§×œ×“ ××•×¦×¨ (××§×™×˜×” 2470)..." onkeydown="if(event.key==='Enter') runSearch()">
                    <button onclick="runSearch()" class="absolute left-2 top-1.5 text-blue-600 hover:bg-blue-50 p-1 rounded"><i class="fas fa-search"></i></button>
                </div>
                <div id="resultsList" class="panel-content custom-scroll bg-slate-50">
                    <div class="text-center py-10 text-slate-400 text-xs">×”×ª×•×¦××•×ª ×™×•×¤×™×¢×• ×›××Ÿ</div>
                </div>
            </div>

            <div id="view-inventory" class="h-full flex flex-col hidden">
                <div class="panel-header text-orange-600"><span><i class="fas fa-edit"></i> ×¢×¨×™×›×ª ××œ××™</span></div>
                <div class="p-3 bg-white border-b">
                    <input id="invSearch" class="inp" placeholder="×¡× ×Ÿ ××•×¦×¨×™×..." oninput="filterInventory()">
                </div>
                <div id="inventoryList" class="panel-content custom-scroll bg-slate-50">
                    </div>
            </div>

            <div id="view-promo" class="h-full flex flex-col hidden">
                <div class="panel-header text-red-600"><span><i class="fas fa-bullhorn"></i> ×©×™×•×•×§</span></div>
                <div class="p-4 space-y-4">
                    <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                        <label class="inp-label text-red-500">×‘×× ×¨ ××‘×¦×¢ (POPUP)</label>
                        <textarea id="promoText" class="inp h-20" placeholder="×¨×§ ×”×™×•×! ×§× ×” ×‘×œ×” ×¡×•××¡×•× ×•×§×‘×œ..." oninput="updatePopupPreview()"></textarea>
                        <div class="flex items-center gap-2 mt-2">
                            <input type="checkbox" id="promoActive" onchange="updatePopupPreview()">
                            <span class="text-xs font-bold text-red-700">×”×¤×¢×œ ×—×œ×•×Ÿ ×§×•×¤×¥</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header text-slate-700">
                <span><i class="fas fa-pencil-alt"></i> ×›×¨×˜×™×¡ ××•×¦×¨</span>
                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded" id="editModeLabel">×—×“×©</span>
            </div>
            <div class="panel-content custom-scroll">
                
                <input type="hidden" id="editId">

                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="col-span-3 inp-label">××“×™×” ×•××•×ª×’</div>
                    <div class="h-20 border-2 dashed rounded flex items-center justify-center cursor-pointer bg-slate-50 relative group" id="slotMain">
                        <img id="imgMain" src="" class="h-full object-contain hidden">
                        <span class="text-[10px] text-gray-400 group-hover:hidden">×ª××•× ×” ×¨××©×™×ª</span>
                    </div>
                    <div class="h-20 border-2 dashed rounded flex items-center justify-center cursor-pointer bg-slate-50 relative group" id="slotSec">
                        <img id="imgSec" src="" class="h-full object-contain hidden">
                        <span class="text-[10px] text-gray-400 group-hover:hidden">××©× ×™×ª</span>
                    </div>
                    <div class="h-20 border-2 dashed rounded-full w-20 mx-auto flex items-center justify-center cursor-pointer bg-slate-50 relative group" id="slotBrand">
                        <img id="imgBrand" src="" class="h-full object-cover rounded-full hidden">
                        <span class="text-[10px] text-gray-400 group-hover:hidden">×œ×•×’×•</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div class="inp-group"><label class="inp-label">×©× ××•×¦×¨</label><input id="inpName" class="inp font-bold" oninput="updatePreview()"></div>
                    <div class="inp-group"><label class="inp-label">××§"×˜</label><input id="inpSku" class="inp font-mono" oninput="updatePreview()"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div class="inp-group"><label class="inp-label">××—×™×¨ (â‚ª)</label><input id="inpPrice" type="number" class="inp text-green-600 font-bold" oninput="updatePreview()"></div>
                    <div class="inp-group"><label class="inp-label">×©× ××•×ª×’</label><input id="inpBrandName" class="inp" placeholder="Makita" oninput="updatePreview()"></div>
                </div>

                <div class="inp-group">
                    <label class="inp-label">××—×¡×Ÿ (×œ×•×’×™×¡×˜×™×§×”)</label>
                    <select id="inpStock" class="inp" onchange="updatePreview()">
                        <option value="both">âœ… ×—×¨×© + ×ª×œ××™×“</option>
                        <option value="harash">ğŸ“ ×”×—×¨×© ×‘×œ×‘×“</option>
                        <option value="talmid">ğŸ“ ×”×ª×œ××™×“ ×‘×œ×‘×“</option>
                    </select>
                </div>

                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-3">
                    <div class="text-xs font-bold text-indigo-600 mb-2 uppercase flex items-center gap-1"><i class="fas fa-robot"></i> ××•×— ×œ×‘×•×˜</div>
                    <div class="grid grid-cols-2 gap-3">
                        <input id="inpDry" class="inp text-xs" placeholder="×–××Ÿ ×™×™×‘×•×© (24 ×©×¢×•×ª)">
                        <input id="inpMethod" class="inp text-xs" placeholder="×©×™×˜×ª ×™×™×©×•×">
                        <input id="inpWeight" class="inp text-xs" placeholder="××©×§×œ (25 ×§''×’)">
                    </div>
                </div>

                <div class="bg-red-50 p-3 rounded-lg border border-red-100 mb-3">
                    <div class="text-xs font-bold text-red-600 mb-2 uppercase flex items-center gap-1"><i class="fas fa-percentage"></i> ××‘×¦×¢ ×œ××•×¦×¨ ×–×”</div>
                    <div class="flex gap-2 items-center">
                        <input type="checkbox" id="inpIsSale" onchange="updatePreview()">
                        <span class="text-xs">×‘××‘×¦×¢?</span>
                        <input id="inpSalePercent" type="number" class="inp w-20 text-xs" placeholder="%" oninput="updatePreview()">
                    </div>
                </div>

                <div class="inp-group">
                    <label class="inp-label">×ª×™××•×¨ ×¢×©×™×¨</label>
                    <textarea id="inpDesc" class="inp h-20 resize-none" placeholder="××¤×¨×˜ ×˜×›× ×™..."></textarea>
                </div>
            </div>
        </div>

        <div class="panel bg-transparent border-none shadow-none">
            <div class="preview-wrapper">
                <div class="preview-screen custom-scroll p-3">
                    
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-bold text-slate-800">Saban Shop</span>
                        <i class="fas fa-shopping-cart text-slate-400"></i>
                    </div>

                    <div id="simPopup" class="popup-overlay hidden">
                        <div class="popup-box">
                            <div class="text-2xl mb-2">ğŸ</div>
                            <div class="font-bold text-slate-800 mb-1">×©×™× ×œ×‘!</div>
                            <div id="simPopupText" class="text-sm text-slate-500 mb-3">×˜×§×¡×˜ ×”××‘×¦×¢...</div>
                            <button class="bg-blue-600 text-white text-xs px-4 py-2 rounded-full w-full">×¡×’×•×¨</button>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-4 text-white mb-4 shadow-lg">
                        <div class="font-bold text-lg">×§×˜×œ×•×’ ××•×¦×¨×™×</div>
                        <div class="text-xs opacity-80">××™×›×•×ª ×•××§×¦×•×¢×™×•×ª</div>
                    </div>

                    <div class="product-card">
                        <div id="prevBadge" class="sale-badge hidden">20% OFF</div>
                        
                        <div class="relative h-40 bg-white flex items-center justify-center p-4 border-b border-slate-50">
                            <img id="prevImgMain" src="https://via.placeholder.com/200?text=Preview" class="h-full object-contain">
                            <div class="absolute top-2 right-2 w-8 h-8 rounded-full border bg-white p-0.5 shadow-sm">
                                <img id="prevBrandLogo" src="" class="w-full h-full rounded-full object-cover opacity-50">
                            </div>
                        </div>

                        <div class="p-3">
                            <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold mb-1" id="prevBrandName">BRAND</div>
                            <div class="font-bold text-slate-800 text-sm leading-tight mb-1" id="prevName">×©× ××•×¦×¨</div>
                            <div class="text-[10px] text-slate-400 mb-2 font-mono" id="prevSku">SKU-000</div>
                            
                            <div class="flex justify-between items-center mb-3">
                                <div>
                                    <span class="font-bold text-green-600 text-lg" id="prevPrice">â‚ª0</span>
                                    <span class="text-xs text-red-400 line-through hidden" id="prevOldPrice">â‚ª0</span>
                                </div>
                                <div id="prevStock" class="text-[9px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded">âœ” ×‘××œ××™</div>
                            </div>

                            <button class="w-full bg-slate-900 text-white text-xs font-bold py-2.5 rounded-lg flex items-center justify-center gap-2">
                                <i class="fas fa-cart-plus"></i> ×”×•×¡×£ ×œ×¢×’×œ×”
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config & Keys
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        let app, db; try{app=initializeApp(firebaseConfig);db=getFirestore(app);}catch(e){}

        const GOOGLE_API_KEY = "AIzaSyDLkShn6lBBew-PJJWtzvAe_14UF9Kv-QI";
        const GOOGLE_CX = "3331a7d5c75e14f26";

        // State
        let allProducts = [];

        // --- Tabs Logic ---
        window.setTab = (tab) => {
            ['search', 'inventory', 'promo'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                const btn = document.getElementById(`btn-${t}`);
                if(btn) btn.classList.remove('active');
            });
            const target = document.getElementById(`view-${tab}`);
            if(target) target.classList.remove('hidden');
            const activeBtn = document.getElementById(`btn-${tab}`);
            if(activeBtn) activeBtn.classList.add('active');

            if(tab === 'inventory') loadInventory();
        };

        // --- Search Logic ---
        window.runSearch = async () => {
            const query = document.getElementById('searchInput').value;
            const list = document.getElementById('resultsList');
            list.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-blue-600"></i></div>';

            try {
                const url = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${GOOGLE_CX}&q=${encodeURIComponent(query)}`;
                const res = await fetch(url);
                const data = await res.json();

                if(!data.items) { list.innerHTML = '<div class="text-center text-xs text-gray-400">××™×Ÿ ×ª×•×¦××•×ª</div>'; return; }

                list.innerHTML = data.items.map(item => {
                    const img = item.pagemap?.cse_image?.[0]?.src || item.pagemap?.og_image?.[0]?.src || '';
                    return `
                    <div class="g-result">
                        <div class="flex gap-2">
                            ${img ? `<img src="${img}" class="w-10 h-10 rounded border object-contain">` : ''}
                            <div class="min-w-0">
                                <div class="font-bold text-xs truncate" title="${item.title}">${item.title}</div>
                                <div class="text-[9px] text-gray-500 truncate">${item.snippet}</div>
                            </div>
                        </div>
                        <div class="g-actions">
                            <div class="g-btn" onclick="take('mainImg', '${img}')">×ª××•× ×”</div>
                            <div class="g-btn" onclick="take('logo', '${img}')">×œ×•×’×•</div>
                            <div class="g-btn" onclick="take('desc', '${escapeVal(item.snippet)}')">×ª×™××•×¨</div>
                            <div class="g-btn" onclick="take('name', '${escapeVal(item.title)}')">×©×</div>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) { list.innerHTML = `<div class="text-red-500 text-xs">${e.message}</div>`; }
        };

        window.take = (type, val) => {
            if(type === 'mainImg') { setImg('imgMain', val); setImg('prevImgMain', val); }
            if(type === 'logo') { setImg('imgBrand', val); setImg('prevBrandLogo', val); document.getElementById('prevBrandLogo').style.opacity=1; }
            if(type === 'name') { document.getElementById('inpName').value = val; updatePreview(); }
            if(type === 'desc') document.getElementById('inpDesc').value += val + '\n';
        };

        function setImg(id, src) {
            const el = document.getElementById(id);
            el.src = src; el.classList.remove('hidden');
        }

        // --- Preview Logic ---
        window.updatePreview = () => {
            document.getElementById('prevName').innerText = document.getElementById('inpName').value || '×©× ××•×¦×¨';
            document.getElementById('prevSku').innerText = document.getElementById('inpSku').value || 'SKU';
            document.getElementById('prevBrandName').innerText = document.getElementById('inpBrandName').value || 'BRAND';
            
            const price = Number(document.getElementById('inpPrice').value || 0);
            const isSale = document.getElementById('inpIsSale').checked;
            const percent = Number(document.getElementById('inpSalePercent').value || 0);

            if(isSale && percent > 0) {
                const discounted = (price * (1 - percent/100)).toFixed(0);
                document.getElementById('prevPrice').innerText = `â‚ª${discounted}`;
                document.getElementById('prevOldPrice').innerText = `â‚ª${price}`;
                document.getElementById('prevOldPrice').classList.remove('hidden');
                document.getElementById('prevBadge').innerText = `${percent}% ×”× ×—×”`;
                document.getElementById('prevBadge').classList.remove('hidden');
            } else {
                document.getElementById('prevPrice').innerText = `â‚ª${price}`;
                document.getElementById('prevOldPrice').classList.add('hidden');
                document.getElementById('prevBadge').classList.add('hidden');
            }

            const stock = document.getElementById('inpStock').value;
            const sDiv = document.getElementById('prevStock');
            if(stock==='both') sDiv.innerHTML = 'âœ” ×—×¨×© + ×ª×œ××™×“';
            else if(stock==='harash') sDiv.innerHTML = 'ğŸ“ ×—×¨×© ×‘×œ×‘×“';
            else sDiv.innerHTML = 'ğŸ“ ×ª×œ××™×“ ×‘×œ×‘×“';
        };

        window.updatePopupPreview = () => {
            const isActive = document.getElementById('promoActive').checked;
            const text = document.getElementById('promoText').value;
            const popup = document.getElementById('simPopup');
            
            if(isActive && text) {
                document.getElementById('simPopupText').innerText = text;
                popup.classList.remove('hidden');
            } else {
                popup.classList.add('hidden');
            }
        };

        // --- Inventory Logic ---
        window.loadInventory = async () => {
            if(!db) return;
            const snap = await getDocs(collection(db, "products"));
            allProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderInvList(allProducts);
        };

        function renderInvList(items) {
            const list = document.getElementById('inventoryList');
            list.innerHTML = items.map(p => `
                <div class="inv-item">
                    <div class="flex gap-2 items-center">
                        <img src="${p.rich?.image}" class="w-8 h-8 object-contain rounded bg-slate-50">
                        <div>
                            <div class="font-bold text-xs truncate w-32">${p.core.name}</div>
                            <div class="text-[9px] text-gray-500">${p.core.sku}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editProduct('${p.id}')" class="text-blue-600 hover:bg-blue-50 p-1 rounded"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="deleteProduct('${p.id}')" class="text-red-600 hover:bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        window.filterInventory = () => {
            const term = document.getElementById('invSearch').value.toLowerCase();
            const filtered = allProducts.filter(p => p.core.name.toLowerCase().includes(term));
            renderInvList(filtered);
        };

        window.editProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            
            document.getElementById('editId').value = id;
            document.getElementById('editModeLabel').innerText = "×¢×¨×™×›×”";
            document.getElementById('editModeLabel').className = "text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded";

            // Fill Core
            document.getElementById('inpName').value = p.core.name;
            document.getElementById('inpSku').value = p.core.sku;
            document.getElementById('inpPrice').value = p.core.price;
            document.getElementById('inpBrandName').value = p.core.brand;
            document.getElementById('inpStock').value = p.core.warehouse; // Correct field name from db

            // Fill Images
            if(p.rich.image) setImg('imgMain', p.rich.image);
            if(p.rich.secondaryImage) setImg('imgSec', p.rich.secondaryImage);
            if(p.core.brandLogo) setImg('imgBrand', p.core.brandLogo);

            // Fill Chatbot
            if(p.chatbot) {
                document.getElementById('inpDry').value = p.chatbot.drying_time || '';
                document.getElementById('inpMethod').value = p.chatbot.application_method || '';
                document.getElementById('inpWeight').value = p.chatbot.weight || '';
            }

            updatePreview();
        };

        window.deleteProduct = async (id) => {
            if(!confirm("×œ××—×•×§ ××•×¦×¨ ×–×”?")) return;
            await deleteDoc(doc(db, "products", id));
            loadInventory();
        };

        window.clearForm = () => {
            document.querySelectorAll('input, textarea').forEach(i => i.value='');
            document.querySelectorAll('img[id^="img"]').forEach(i => i.classList.add('hidden'));
            document.getElementById('editId').value = '';
            document.getElementById('editModeLabel').innerText = "×—×“×©";
            document.getElementById('editModeLabel').className = "text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded";
            updatePreview();
        };

        window.saveProduct = async () => {
            if(!db) return alert("××™×Ÿ ×—×™×‘×•×¨");
            
            const id = document.getElementById('editId').value;
            const product = {
                core: {
                    name: document.getElementById('inpName').value,
                    sku: document.getElementById('inpSku').value,
                    price: Number(document.getElementById('inpPrice').value),
                    brand: document.getElementById('inpBrandName').value,
                    brandLogo: document.getElementById('imgBrand').src,
                    warehouse: document.getElementById('inpStock').value
                },
                rich: {
                    description: document.getElementById('inpDesc').value,
                    image: document.getElementById('imgMain').src,
                    secondaryImage: document.getElementById('imgSec').src
                },
                chatbot: {
                    drying_time: document.getElementById('inpDry').value,
                    application_method: document.getElementById('inpMethod').value,
                    weight: document.getElementById('inpWeight').value
                },
                updatedAt: new Date()
            };

            if(!product.core.name) return alert("×—×•×‘×” ×œ××œ× ×©×");

            try {
                if(id) {
                    await updateDoc(doc(db, "products", id), product);
                } else {
                    await addDoc(collection(db, "products"), product);
                }
                alert("× ×©××¨!");
                window.clearForm();
                loadInventory();
            } catch(e) { console.error(e); alert("×©×’×™××”"); }
        };

        function escapeVal(str) { return str.replace(/'/g, "").replace(/"/g, ""); }

    </script>
</body>
</html>
