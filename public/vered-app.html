<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Ops | ×•×¨×“</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <meta name="theme-color" content="#be123c"> <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest-vered.json">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=Vered&background=be123c&color=fff&size=180">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- Chameleon Theme Engine --- */
        :root {
            --primary: #be123c;   /* Rose (Default) */
            --primary-light: #fb7185;
            --bg-body: #fff1f2;
            --bg-card: #ffffff;
            --text-main: #881337;
            --border: #ffe4e6;
        }

        /* Ocean Theme */
        body.theme-ocean {
            --primary: #0369a1;
            --primary-light: #38bdf8;
            --bg-body: #f0f9ff;
            --text-main: #0c4a6e;
            --border: #e0f2fe;
        }

        /* Forest Theme */
        body.theme-forest {
            --primary: #15803d;
            --primary-light: #4ade80;
            --bg-body: #f0fdf4;
            --text-main: #14532d;
            --border: #dcfce7;
        }

        /* Royal Night Theme */
        body.theme-royal {
            --primary: #1e1b4b; /* Deep Indigo */
            --primary-light: #6366f1;
            --bg-body: #f8fafc;
            --text-main: #0f172a;
            --border: #e2e8f0;
        }

        body { background: var(--bg-body); font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.5s ease; }
        
        /* Header */
        .app-header { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); 
            color: white; padding: 20px; padding-top: max(20px, env(safe-area-inset-top)); 
            border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: 0.5s;
        }
        
        /* Cards */
        .rose-card { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid var(--border); position: relative; overflow: hidden; }
        .rose-card::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 4px; background: var(--primary-light); }
        
        .harel-task { background: var(--bg-body); border-color: var(--primary-light); }
        .harel-task::before { background: var(--primary); }

        /* Buttons */
        .btn-sos { background: var(--primary); color: white; border-radius: 12px; padding: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: 0.2s; }
        
        .btn-quick { display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; color: var(--text-main); background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex: 1; border: 1px solid var(--border); }
        .btn-quick i { font-size: 20px; color: var(--primary); }

        /* Theme Picker Modal */
        .theme-option { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; }
        .theme-option:hover { transform: scale(1.1); }

        /* Tabs */
        .tab-bar { background: white; border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); display: flex; justify-content: space-around; position: fixed; bottom: 0; width: 100%; z-index: 50; }
        .tab-btn { padding: 12px; color: var(--text-main); opacity: 0.6; display: flex; flex-direction: column; align-items: center; font-size: 10px; flex: 1; transition: 0.3s; }
        .tab-btn.active { opacity: 1; font-weight: bold; color: var(--primary); transform: translateY(-2px); }
        .tab-btn i { font-size: 20px; margin-bottom: 4px; }

        .view-section { display: none; padding: 20px; padding-bottom: 90px; overflow-y: auto; height: 100%; }
        .view-section.active { display: block; }
    </style>
</head>
<body>

    <audio id="sound-ping" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="sound-alert" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3"></audio>

    <div class="app-header">
        <div class="flex justify-between items-start mb-4">
            <div>
                <div class="text-xs opacity-90">××“××™× ×™×¡×˜×¨×¦×™×” ×•×›×¡×¤×™×</div>
                <div class="text-2xl font-bold">×•×¨×“ ××™×“×œ×¡×•×Ÿ</div>
            </div>
            <div class="flex gap-2">
                <button onclick="openThemePicker()" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm hover:bg-white/30 transition">
                    <i class="fas fa-palette"></i>
                </button>
                <div id="dnd-btn" class="bg-white/20 px-3 py-1 rounded-full text-xs flex items-center gap-1 cursor-pointer backdrop-blur-sm" onclick="toggleDND()">
                    <i class="fas fa-bell"></i> <span>×–××™× ×”</span>
                </div>
            </div>
        </div>
        
        <div class="flex gap-3 justify-between">
            <div class="text-center bg-white/10 rounded-lg p-2 flex-1">
                <div class="text-xl font-bold" id="stat-tasks">0</div>
                <div class="text-[10px]">××©×™××•×ª ×”×¨××œ</div>
            </div>
            <div class="text-center bg-white/10 rounded-lg p-2 flex-1">
                <div class="text-xl font-bold text-green-200">OK</div>
                <div class="text-[10px]">×¡×˜×˜×•×¡ ×§×•××§×¡</div>
            </div>
            <div class="text-center bg-white/10 rounded-lg p-2 flex-1">
                <div class="text-xl font-bold" id="stat-alerts">0</div>
                <div class="text-[10px]">×”×•×“×¢×•×ª</div>
            </div>
        </div>
    </div>

    <div id="view-home" class="view-section active">
        <div class="flex gap-3 mb-6">
            <button class="btn-quick" onclick="window.open('tel:0505227724')"><i class="fas fa-phone"></i> ×”×¨××œ</button>
            <button class="btn-quick" onclick="window.open('https://wa.me/972505227724', '_blank')"><i class="fab fa-whatsapp"></i> ×”×¨××œ</button>
            <button class="btn-quick" onclick="window.open('documents-drive.html', '_blank')"><i class="fab fa-google-drive"></i> ××¡××›×™×</button>
            <button class="btn-quick" onclick="openComaxTicket()"><i class="fas fa-headset"></i> ×§×•××§×¡</button>
        </div>

        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i class="fas fa-crown text-yellow-500"></i> ××©×™××•×ª ×× ×›"×œ</h3>
        <div id="harel-tasks-list">
            <div class="text-center text-gray-400 text-sm py-4">××™×Ÿ ××©×™××•×ª ×¤×ª×•×—×•×ª ğŸ‰</div>
        </div>

        <h3 class="font-bold text-gray-800 mb-3 mt-6">×”×ª×¨××•×ª ××¢×¨×›×ª</h3>
        <div id="notifications-list" class="space-y-2"></div>
    </div>

    <div id="view-tech" class="view-section">
        <h2 class="text-xl font-bold mb-4" style="color: var(--primary)">×¢××“×•×ª ×§×•××§×¡</h2>
        <button onclick="openComaxTicket()" class="btn-sos mb-6"><i class="fas fa-exclamation-circle"></i> ×“×•×•×— ×ª×§×œ×” (SOS)</button>
        <div class="space-y-3">
            <div class="rose-card flex justify-between items-center"><span>ğŸ–¥ï¸ ×¢××“×” 1 (×“×œ×¤×§)</span><span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">×ª×§×™×Ÿ</span></div>
            <div class="rose-card flex justify-between items-center"><span>ğŸ–¥ï¸ ×¢××“×” 2 (×—×¨×©)</span><span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">×ª×§×™×Ÿ</span></div>
        </div>
    </div>

    <div id="view-hr" class="view-section">
        <h2 class="text-xl font-bold mb-4" style="color: var(--primary)">××©××‘×™ ×× ×•×©</h2>
        <div class="grid grid-cols-3 gap-3 mb-6">
            <button onclick="waContact('×’×œ×™×”')" class="btn-quick"><i class="fas fa-user-circle"></i> ×’×œ×™×”</button>
            <button onclick="waContact('×œ×™× ×”')" class="btn-quick"><i class="fas fa-user-circle"></i> ×œ×™× ×”</button>
            <button onclick="waContact('×©×¨×•×Ÿ')" class="btn-quick"><i class="fas fa-user-circle"></i> ×©×¨×•×Ÿ</button>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-btn active" onclick="switchTab('home', this)"><i class="fas fa-home"></i><span>×¨××©×™</span></div>
        <div class="tab-btn" onclick="switchTab('tech', this)"><i class="fas fa-server"></i><span>×§×•××§×¡</span></div>
        <div class="tab-btn" onclick="switchTab('hr', this)"><i class="fas fa-users"></i><span>×¦×•×•×ª</span></div>
        <div class="tab-btn" onclick="window.open('documents-drive.html', '_blank')"><i class="fas fa-folder"></i><span>×“×¨×™×™×‘</span></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // --- Theme Chameleon ---
        window.openThemePicker = () => {
            Swal.fire({
                title: '×‘×—×¨×™ ××ª ×”×¦×‘×¢ ×©×œ×š ğŸ¨',
                html: `
                    <div class="flex justify-center gap-4 mt-4">
                        <div class="theme-option" style="background: #be123c;" onclick="setTheme('')" title="×•×¨×“ ×§×œ××¡×™"></div>
                        <div class="theme-option" style="background: #0ea5e9;" onclick="setTheme('theme-ocean')" title="××•×§×™×™× ×•×¡"></div>
                        <div class="theme-option" style="background: #16a34a;" onclick="setTheme('theme-forest')" title="×˜×‘×¢"></div>
                        <div class="theme-option" style="background: #312e81;" onclick="setTheme('theme-royal')" title="×¨×•×™××œ"></div>
                    </div>
                `,
                showConfirmButton: false
            });
        };

        window.setTheme = (themeClass) => {
            document.body.className = themeClass;
            localStorage.setItem('vered_theme', themeClass);
            Swal.close();
        };

        // Load saved theme
        const savedTheme = localStorage.getItem('vered_theme');
        if (savedTheme) document.body.className = savedTheme;

        // --- Notifications Listener ---
        // ×××–×™×Ÿ ×œ×”×ª×¨××•×ª ×©××›×•×•× ×•×ª ×¡×¤×¦×™×¤×™×ª ×œ×•×¨×“ (×œ××©×œ ×ª×™×•×’ ××¡××š ××• ××©×™××” ××”×¨××œ)
        // ×œ×¦×•×¨×š ×”×“×•×’××” ×”-ID ×©×œ ×•×¨×“ ×‘××¢×¨×›×ª ×”×•× 'vered' (××• ×”×˜×œ×¤×•×Ÿ ×©×œ×”)
        const qNotify = query(collection(db, "notifications"), where("target", "==", "vered"), orderBy("createdAt", "desc")); // ×™×© ×œ×”×ª××™× ××ª ×”-ID ×”×××™×ª×™

        onSnapshot(qNotify, (snap) => {
            const list = document.getElementById('notifications-list');
            list.innerHTML = '';
            let unreadCount = 0;

            snap.forEach(d => {
                const n = d.data();
                if (!n.read) {
                    unreadCount++;
                    // ×”×©××¢×ª ×¦×œ×™×œ ×¨×§ ×× ×–×• ×”×ª×¨××” ×—×“×©×” (××”×“×§×” ×”××—×¨×•× ×”)
                    const isFresh = (Date.now() - n.createdAt?.seconds * 1000) < 60000;
                    if (isFresh && !window.isDND) {
                        document.getElementById(n.type === 'urgent' ? 'sound-alert' : 'sound-ping').play().catch(()=>{});
                        // ×”×•×“×¢×” ×§×•×¤×¦×ª
                        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                        Toast.fire({ icon: 'info', title: n.title });
                    }
                }

                list.innerHTML += `
                <div class="rose-card py-3 flex justify-between items-start ${n.read ? 'opacity-60' : ''}">
                    <div>
                        <div class="font-bold text-sm text-gray-800">${n.title}</div>
                        <div class="text-xs text-gray-500">${n.body}</div>
                        ${n.link ? `<a href="${n.link}" target="_blank" class="text-blue-600 text-xs underline mt-1 block">×¦×¤×” ×‘×§×™×©×•×¨</a>` : ''}
                    </div>
                    ${!n.read ? `<button onclick="markRead('${d.id}')" class="text-xs bg-rose-100 text-rose-700 px-2 py-1 rounded">×¡××Ÿ ×›× ×§×¨×</button>` : '<i class="fas fa-check text-green-500 text-xs"></i>'}
                </div>`;
            });
            document.getElementById('stat-alerts').innerText = unreadCount;
        });

        window.markRead = async (id) => {
            await updateDoc(doc(db, "notifications", id), { read: true });
        };

        // --- Tasks from Harel ---
        // ×¡×™××•×œ×¦×™×” ×©×œ ×”××–× ×” ×œ××©×™××•×ª ××”×¨××œ
        onSnapshot(query(collection(db, "orders"), where("taskType", "==", "harel_to_vered")), (snap) => {
            const container = document.getElementById('harel-tasks-list');
            container.innerHTML = '';
            if(snap.empty) { container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">××™×Ÿ ××©×™××•×ª ×¤×ª×•×—×•×ª ğŸ‰</div>'; }
            
            snap.forEach(d => {
                const t = d.data();
                container.innerHTML += `
                <div class="rose-card harel-task">
                    <div class="font-bold text-rose-900">${t.text}</div>
                    <div class="text-xs text-rose-600 mt-2 flex justify-between">
                        <span><i class="fas fa-user-tie"></i> ×”×¨××œ</span>
                        <span>${new Date(t.createdAt?.seconds*1000).toLocaleTimeString()}</span>
                    </div>
                </div>`;
            });
            document.getElementById('stat-tasks').innerText = snap.size;
        });

        // --- Standard Functions ---
        window.switchTab = (viewId, btn) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            btn.classList.add('active');
        };

        window.isDND = false;
        window.toggleDND = () => {
            window.isDND = !window.isDND;
            const btn = document.getElementById('dnd-btn');
            if (window.isDND) {
                btn.style.background = '#fff'; btn.style.color = 'var(--primary)';
                btn.innerHTML = `<i class="fas fa-moon"></i> <span>×©×§×˜</span>`;
            } else {
                btn.style.background = 'rgba(255,255,255,0.2)'; btn.style.color = 'white';
                btn.innerHTML = `<i class="fas fa-bell"></i> <span>×–××™× ×”</span>`;
            }
        };

        window.openComaxTicket = () => {
            Swal.fire({
                title: '×ª×§×œ×ª ×§×•××§×¡',
                input: 'textarea', placeholder: '×ª×™××•×¨ ×”×ª×§×œ×”...', confirmButtonText: '×©×œ×—', confirmButtonColor: 'var(--primary)'
            }).then(r => { if(r.value) Swal.fire('× ×©×œ×—','','success'); });
        };

        window.waContact = (name) => {
            const phones = { '×’×œ×™×”': '0500000000', '×œ×™× ×”': '0500000000', '×©×¨×•×Ÿ': '0500000000' };
            window.open(`https://wa.me/972${phones[name]?.replace(/^0/,'')}`, '_blank');
        };
    </script>
</body>
</html>
