// server.js - 砖专转 专 砖 SabanOS
const express = require('express');
const fetch = require('node-fetch');
const path = require('path');
const cors = require('cors');

const app = express();
const port = process.env.PORT || 3000;

// ---  专 驻转转 (注) ---
const KEYS = {
    // 驻转转 OneSignal (拽)
    ONE_SIGNAL_APP_ID: "acc8a2bc-d54e-4261-b3d2-cc5c5f7b39d3",
    ONE_SIGNAL_API_KEY: "syyhlq4pzu7reurjs7lqgtb3g",
    
    // 驻转转 砖 (注)
    SERPAPI_KEY: "0592368999282ef7ea7c5ef8bddc23fda18b9bf76856359df062eec32ceccf27",
    GEMINI_KEY: "AIzaSyAdfGVrmr90Mp9ZhNMItD81iaE8OipKwz0"
};

app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// 1. 砖转 转专转 (OneSignal)
app.post('/api/send-notification', async (req, res) => {
    try {
        const response = await fetch('https://onesignal.com/api/v1/notifications', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Basic ${KEYS.ONE_SIGNAL_API_KEY}`
            },
            body: JSON.stringify({
                app_id: KEYS.ONE_SIGNAL_APP_ID,
                include_aliases: { "external_id": [req.body.targetUid] },
                target_channel: "push",
                contents: { en: req.body.message, he: req.body.message },
                headings: { en: req.body.title, he: req.body.title }
            })
        });
        res.json(await response.json());
    } catch (e) { res.status(500).json({ error: e.message }); }
});

// 2. 驻砖 转转 (SerpApi Proxy) - 驻转专 注转 CORS
app.post('/api/search-images', async (req, res) => {
    const { query } = req.body;
    if (!query) return res.status(400).json({ error: "Missing query" });

    try {
        const url = `https://serpapi.com/search.json?q=${encodeURIComponent(query)}&tbm=isch&ijn=0&api_key=${KEYS.SERPAPI_KEY}`;
        const response = await fetch(url);
        const data = await response.json();
        
        // 专转 专砖转 转转 拽
        const images = data.images_results?.slice(0, 9).map(img => ({
            url: img.original,
            thumb: img.thumbnail
        })) || [];
        
        res.json({ items: images });
    } catch (e) { 
        console.error("SerpApi Error:", e);
        res.status(500).json({ error: e.message }); 
    }
});

// 3.  转转 (Gemini Proxy) - 砖专 注 驻转 住
app.post('/api/ask-gemini', async (req, res) => {
    const { prompt } = req.body;
    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${KEYS.GEMINI_KEY}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await response.json();
        res.json(data);
    } catch (e) { 
        console.error("Gemini Error:", e);
        res.status(500).json({ error: e.message }); 
    }
});

// 转 专专转 
app.get('*', (req, res) => res.sendFile(path.join(__dirname, 'public', 'index.html')));

app.listen(port, () => console.log(` SabanOS Server Active on port ${port}`));
