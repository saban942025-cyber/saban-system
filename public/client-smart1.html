<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Portal | ××–×•×¨ ××™×©×™</title>
    <meta name="theme-color" content="#ffffff">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8fafc; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* Animations */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .view-section { animation: fadeIn 0.3s ease-out; }
        
        /* Navigation */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 10px 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 11px; font-weight: 600; cursor: pointer; transition: 0.2s; width: 33%; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active { color: #00a884; }
        .nav-item.active i { transform: translateY(-3px); }

        /* Order Rows */
        .prod-input:focus { border-color: #00a884; background: white; box-shadow: 0 0 0 3px rgba(0, 168, 132, 0.1); }
        
        /* Status Steps */
        .step { width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; position: relative; }
        .step.active { background: #00a884; }
        .step-dot { position: absolute; right: 0; top: -3px; width: 10px; height: 10px; background: #e2e8f0; border-radius: 50%; }
        .step.active .step-dot { background: #00a884; box-shadow: 0 0 0 3px rgba(0, 168, 132, 0.2); }
    </style>
</head>
<body>

    <header class="bg-white p-5 shadow-sm sticky top-0 z-40 flex justify-between items-center">
        <div>
            <div class="text-xs text-gray-400 font-bold uppercase">×©×œ×•×,</div>
            <h1 class="text-xl font-bold text-slate-800" id="header-name">××•×¨×—</h1>
        </div>
        <img id="header-avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-10 h-10 rounded-full border border-gray-100 object-cover">
    </header>

    <div id="main-content" class="max-w-md mx-auto">

        <div id="view-active" class="view-section p-4">
            <h2 class="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2">
                <i class="fas fa-truck-fast text-green-600"></i> ×‘×˜×™×¤×•×œ
            </h2>
            <div id="active-list" class="space-y-4">
                <div class="text-center py-10 text-gray-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>×˜×•×¢×Ÿ × ×ª×•× ×™×...
                </div>
            </div>
        </div>

        <div id="view-new" class="view-section p-4 hidden">
            <h2 class="font-bold text-xl mb-4 text-slate-800">×”×–×× ×” ×—×“×©×” ğŸ—ï¸</h2>
            
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                
                <div class="text-[10px] font-bold text-gray-400 uppercase mb-2 flex justify-between px-1">
                    <span>×ª×™××•×¨ ×”×¤×¨×™×˜ (×˜×§×¡×˜ ×—×•×¤×©×™)</span>
                    <span class="pl-2">×›××•×ª</span>
                </div>
                
                <div id="order-rows" class="space-y-3 mb-4"></div>

                <button onclick="window.addProductRow()" class="w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 rounded-xl font-bold text-sm hover:bg-gray-50 hover:border-green-300 hover:text-green-600 transition mb-6 flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> ×”×•×¡×£ ×¤×¨×™×˜ × ×•×¡×£
                </button>
                
                <hr class="border-gray-100 mb-6">

                <label class="text-xs font-bold text-gray-400 uppercase block mb-2"><i class="fas fa-map-marker-alt"></i> ×œ××Ÿ ×•××ª×™?</label>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="date" id="new-date" class="w-full bg-gray-50 p-3 rounded-xl text-sm border-none outline-none focus:ring-2 focus:ring-green-100">
                    <input type="time" id="new-time" class="w-full bg-gray-50 p-3 rounded-xl text-sm border-none outline-none focus:ring-2 focus:ring-green-100">
                </div>
                <input type="text" id="new-address" class="w-full bg-gray-50 p-3 rounded-xl border-none mb-6 text-sm outline-none focus:ring-2 focus:ring-green-100" placeholder="×›×ª×•×‘×ª / ×©× ××ª×¨ (×œ×“×•×’××”: ×¤×¨×•×™×™×§×˜ ×”×™× 4)">
                
                <button onclick="window.submitSmartOrder()" class="w-full bg-[#25D366] text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-[#20bd5a] active:scale-95 transition flex justify-center items-center gap-2">
                    <span>×©×’×¨ ×œ×•×•×¦××£</span> <i class="fab fa-whatsapp text-2xl"></i>
                </button>
            </div>
        </div>

        <div id="view-history" class="view-section p-4 hidden">
            <h2 class="font-bold text-xl mb-4 text-slate-800">×”×™×¡×˜×•×¨×™×” ğŸ“œ</h2>
            <div id="history-list" class="space-y-3"></div>
        </div>

    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="window.switchView('active', this)">
            <i class="fas fa-box-open"></i>
            <span>×¡×˜×˜×•×¡</span>
        </div>
        <div class="nav-item" onclick="window.switchView('new', this)">
            <i class="fas fa-plus-circle text-2xl text-green-600"></i>
            <span class="text-green-700">×”×–×× ×”</span>
        </div>
        <div class="nav-item" onclick="window.switchView('history', this)">
            <i class="fas fa-history"></i>
            <span>×”×™×¡×˜×•×¨×™×”</span>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 1. Firebase Config
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 2. User Identity (From URL)
        const params = new URLSearchParams(window.location.search);
        // ×‘×¨×™×¨×ª ××—×“×œ: ××•×¨×—
        const CLIENT_NAME = params.get('name') || '××•×¨×—';
        const CLIENT_UID = params.get('uid') || 'guest';
        
        // UI Setup
        document.getElementById('header-name').innerText = CLIENT_NAME;
        document.getElementById('header-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(CLIENT_NAME)}&background=00a884&color=fff`;

        // 3. Navigation Logic
        window.switchView = (viewName, btn) => {
            // Hide all
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            if(btn) btn.classList.add('active');
            else document.querySelectorAll('.nav-item')[viewName==='active'?0: (viewName==='new'?1:2)].classList.add('active');
            
            // Scroll top
            window.scrollTo(0,0);
        };

        // 4. Dynamic Form Logic
        window.addProductRow = () => {
            const container = document.getElementById('order-rows');
            const rowId = 'row-' + Date.now();
            
            const html = `
            <div id="${rowId}" class="flex gap-2 items-center animate-[fadeIn_0.3s_ease-out]">
                <div class="flex-1 relative">
                    <input type="text" class="prod-name prod-input w-full bg-gray-50 p-3 rounded-xl text-sm border border-gray-200 outline-none transition" placeholder="×œ×“×•×’××”: ××œ×˜ ×©×—×•×¨">
                    <i class="fas fa-cube absolute left-3 top-3.5 text-gray-300 text-xs"></i>
                </div>
                <div class="w-20 relative">
                    <input type="number" class="prod-qty prod-input w-full bg-gray-50 p-3 rounded-xl text-center text-sm font-bold border border-gray-200 outline-none" placeholder="0">
                </div>
                <button onclick="document.getElementById('${rowId}').remove()" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>`;
            
            container.insertAdjacentHTML('beforeend', html);
            // Auto focus if not mobile (optional)
            // setTimeout(() => container.lastElementChild.querySelector('.prod-name').focus(), 50);
        };

        // ×”×•×¡×¤×ª ×©×•×¨×” ×¨××©×•× ×” ×‘×˜×¢×™× ×”
        document.addEventListener('DOMContentLoaded', () => window.addProductRow());

        // 5. Submit Order (Generate WhatsApp + Save DB)
        window.submitSmartOrder = async () => {
            // Collect Data
            const rows = document.querySelectorAll('#order-rows > div');
            let itemsListText = "";
            let itemsCount = 0;

            rows.forEach(row => {
                const name = row.querySelector('.prod-name').value.trim();
                const qty = row.querySelector('.prod-qty').value.trim();
                if(name && qty) {
                    itemsListText += `ğŸ”¹ *${qty}* x ${name}\n`;
                    itemsCount++;
                }
            });

            const address = document.getElementById('new-address').value;
            const date = document.getElementById('new-date').value;
            const time = document.getElementById('new-time').value;

            // Validation
            if(itemsCount === 0) return Swal.fire({title: '×”×¡×œ ×¨×™×§', text: '×™×© ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ××•×¦×¨ ××—×“', icon: 'warning', confirmButtonColor: '#00a884'});

            // Save to Firebase (×›×“×™ ×©×ª×¨××” ×‘×—×"×œ)
            try {
                await addDoc(collection(db, "orders"), {
                    clientName: CLIENT_NAME,
                    clientUid: CLIENT_UID,
                    itemsText: itemsListText, // ×”×˜×§×¡×˜ ×”××¢×•×¦×‘ ×œ×—×"×œ
                    text: itemsListText, // ×ª××™×›×” ×œ××—×•×¨
                    address: address,
                    supplyDate: date,
                    supplyTime: time,
                    status: 'new',
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                    clientAvatar: document.getElementById('header-avatar').src
                });
            } catch(e) { console.error(e); }

            // WhatsApp Generation
            // ×‘× ×” ×œ×™× ×§ ×—×›× ×©×”×œ×§×•×— ×©×œ×š ×™×•×›×œ ×œ×œ×—×•×¥ ×¢×œ×™×• ×›×“×™ ×œ×—×–×•×¨ ×œ××¤×œ×™×§×¦×™×”
            const trackingLink = `https://saban-system.onrender.com/client-smart.html?uid=${CLIENT_UID}&name=${encodeURIComponent(CLIENT_NAME)}`;
            
            let waText = `*×”×–×× ×” ×—×“×©×” - ${CLIENT_NAME}* ğŸšœ\n`;
            waText += `--------------------------\n`;
            waText += itemsListText;
            waText += `--------------------------\n`;
            waText += `ğŸ“ *×œ×›×ª×•×‘×ª:* ${address || '×¨×’×™×œ×”'}\n`;
            waText += `ğŸ“… *××¡×¤×§×”:* ${date || '××™×™×“×™'} ${time ? '('+time+')' : ''}\n\n`;
            waText += `×œ××¢×§×‘:\n${trackingLink}`;

            // Open WhatsApp
            window.open(`https://wa.me/972508860896?text=${encodeURIComponent(waText)}`, '_blank');
            
            // Cleanup
            Swal.fire({title: '×”×”×–×× ×” × ×©×œ×—×”!', text: '×¢×§×•×‘ ××—×¨×™ ×”×¡×˜×˜×•×¡ ×‘××–×•×¨ ×”××™×©×™', icon: 'success', timer: 2000, showConfirmButton: false});
            document.getElementById('order-rows').innerHTML = '';
            document.getElementById('new-address').value = '';
            window.addProductRow();
            window.switchView('active');
        };

        // 6. Real-Time Listeners (Active & History)
        const q = query(collection(db, "orders"), where("clientName", "==", CLIENT_NAME), orderBy("createdAt", "desc"));
        
        onSnapshot(q, (snap) => {
            const activeDiv = document.getElementById('active-list');
            const historyDiv = document.getElementById('history-list');
            activeDiv.innerHTML = '';
            historyDiv.innerHTML = '';

            if(snap.empty) {
                activeDiv.innerHTML = '<div class="text-center py-10 text-gray-400">××™×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</div>';
                return;
            }

            snap.forEach(doc => {
                const o = doc.data();
                const isDone = o.status === 'done' || o.status === 'deleted';
                
                // Status Config
                let statusText = '× ×§×œ×˜ ×‘××¢×¨×›×ª', statusColor = 'bg-gray-200 text-gray-600', width = '20%';
                if(o.status === 'work') { statusText = '×‘×œ×™×§×•×˜ / ×”×›× ×”'; statusColor = 'bg-blue-100 text-blue-700'; width = '60%'; }
                if(o.status === 'approved') { statusText = '××•×›×Ÿ ×œ××©×œ×•×—'; statusColor = 'bg-orange-100 text-orange-700'; width = '90%'; }
                if(o.status === 'done') { statusText = '× ××¡×¨ ×œ×œ×§×•×—'; statusColor = 'bg-green-100 text-green-700'; width = '100%'; }

                const dateStr = o.createdAt ? new Date(o.createdAt.seconds*1000).toLocaleDateString('he-IL') : '';

                const html = `
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm animate-[slideUp_0.3s_ease-out]">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-[10px] text-gray-400 font-bold">×”×–×× ×” #${doc.id.slice(-4)}</div>
                            <div class="font-bold text-slate-800 text-sm whitespace-pre-wrap">${o.itemsText || o.text || '×¤×™×¨×•×˜ ×œ× ×–××™×Ÿ'}</div>
                        </div>
                        <div class="text-[10px] text-gray-400 bg-gray-50 px-2 py-1 rounded">${dateStr}</div>
                    </div>
                    
                    ${!isDone ? `
                    <div class="mt-4">
                        <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-1">
                            <span>${statusText}</span>
                            <span>${width}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                            <div class="bg-green-500 h-2 rounded-full transition-all duration-1000" style="width: ${width}"></div>
                        </div>
                    </div>` : 
                    `<div class="mt-2 text-center text-xs font-bold text-green-600 bg-green-50 py-1 rounded">âœ… ${statusText}</div>`}
                </div>`;

                if(isDone) historyDiv.innerHTML += html;
                else activeDiv.innerHTML += html;
            });
            
            if(activeDiv.innerHTML === '') activeDiv.innerHTML = '<div class="text-center py-10 text-gray-400">××™×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª ×›×¨×’×¢ ğŸ§¹</div>';
        });

        // Expose to window
        window.addProductRow = window.addProductRow;
        window.submitSmartOrder = window.submitSmartOrder;
        window.switchView = window.switchView;
    </script>
</body>
</html>
