<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harel Command Pro</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        /* 拽转 转拽转 驻驻 注转 拽专住转 */
        const isHealthy = await new Promise(r => { try { let q=indexedDB.open("t");q.onsuccess=()=>{q.result.close();r(true)};q.onerror=()=>r(false);}catch{r(false)}});
        if(isHealthy) await OneSignal.init({ appId: "07b81f2e-e812-424f-beca-36584b12ccf2" });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f2f2f7; font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        .ios-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02); }
        .ios-input { width: 100%; background: #f2f2f7; border: none; padding: 14px; border-radius: 12px; font-size: 16px; outline: none; margin-bottom: 12px; transition: 0.2s; }
        .ios-btn { background: #007aff; color: white; border-radius: 14px; padding: 16px; font-weight: 700; width: 100%; text-align: center; font-size: 18px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .nav-segment { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .nav-item { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 600; color: #8e8e93; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { background: white; color: #1c1c1e; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 20px; font-weight: bold; }
        .st-read { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .st-sent { background: #fee2e2; color: #991b1b; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    
    <div class="pt-6 pb-2 px-5 sticky top-0 bg-[#f2f2f7] z-10">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black text-slate-900 tracking-tight">专 住</h1>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Master Control</p>
            </div>
            <img src="https://ui-avatars.com/api/?name=Harel&background=000&color=fff" class="w-10 h-10 rounded-full shadow-md border-2 border-white">
        </div>

        <div class="nav-segment mt-4">
            <div class="nav-item active" onclick="switchView('create', this)"> 砖专</div>
            <div class="nav-item" onclick="switchView('feed', this)"> 驻 </div>
            <div class="nav-item" onclick="switchView('stats', this)"> 爪注</div>
        </div>
    </div>

    <div id="view-create" class="px-4 view-section">
        <div class="ios-card">
            <h3 class="font-bold mb-4 text-slate-800 flex items-center gap-2">
                <i class="fas fa-plus-circle text-blue-500"></i> 专 砖
            </h3>
            
            <input id="task-title" class="ios-input" placeholder="砖 (: 爪 拽 拽)">
            <textarea id="task-desc" class="ios-input" rows="2" placeholder="驻专..."></textarea>
            
            <label class="text-xs font-bold text-gray-400 mr-1 mb-1 block">注 砖:</label>
            <select id="task-assign" class="ios-input bg-white border border-gray-200">
                <option value="all">  (注 转驻专爪转)</option>
            </select>

            <div class="bg-red-50 p-3 rounded-xl border border-red-100 flex justify-between items-center mb-4">
                <div>
                    <div class="font-bold text-red-900 text-sm">住转 住 (祝)</div>
                    <div class="text-[10px] text-red-600">注  砖专  砖</div>
                </div>
                <input type="checkbox" id="task-confirm" class="w-6 h-6 accent-red-600" checked>
            </div>

            <button onclick="sendTask()" class="ios-btn shadow-blue-500/30">
                砖专 注砖 <i class="fas fa-paper-plane ml-2"></i>
            </button>
        </div>
    </div>

    <div id="view-feed" class="px-4 view-section hidden">
        <div id="live-feed-list" class="space-y-3 pb-20"></div>
    </div>

    <div id="view-stats" class="px-4 view-section hidden">
        <div class="ios-card">
            <h3 class="font-bold mb-4 text-slate-800 text-sm">爪注 爪转</h3>
            <canvas id="performanceChart"></canvas>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // 转转 砖 "" (GAS) -  砖 转转  驻专住 专 砖!
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw6tU2yOXn4BkP3xwlmgB8nKU-8u6BOSKXTXJjXsY9E86E_zYXpa9_aDxsPmd63X1Wd/exec";

        let usersMap = {};
        let myChart = null;

        // 注转 砖转砖
        onSnapshot(query(collection(db, "users")), (snap) => {
            const sel = document.getElementById('task-assign');
            let html = '<option value="all">  (注 转驻专爪转)</option>';
            snap.forEach(d => {
                const u = d.data();
                usersMap[d.id] = u.name; 
                if(u.type !== 'client') html += `<option value="${d.id}">${u.name}</option>`;
            });
            sel.innerHTML = html;
        });

        //  砖转 + 注 驻 + 专驻
        onSnapshot(query(collection(db, "tasks"), orderBy("createdAt", "desc"), limit(50)), (snap) => {
            const feed = document.getElementById('live-feed-list');
            feed.innerHTML = '';
            let stats = {};

            snap.forEach(d => {
                const t = d.data();
                const assigneeName = usersMap[t.assignedTo] || '';
                const timeStr = t.createdAt ? new Date(t.createdAt.seconds*1000).toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}) : '...';
                
                const isRead = t.readBy && t.readBy.length > 0;
                let statusHtml = isRead 
                    ? `<span class="status-badge st-read"><i class="fas fa-check-double"></i> 砖专 (${t.readBy.length})</span>`
                    : `<span class="status-badge st-sent"><i class="fas fa-clock"></i> 转...</span>`;

                feed.innerHTML += `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-bold text-slate-800">${t.title}</div>
                        <div class="text-[10px] text-gray-400 font-mono">${timeStr}</div>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-xs text-gray-500 flex items-center gap-1"><i class="fas fa-user"></i> ${assigneeName}</div>
                        ${statusHtml}
                    </div>
                </div>`;

                if (t.assignedTo !== 'all') {
                    if (!stats[t.assignedTo]) stats[t.assignedTo] = { name: assigneeName, total: 0, read: 0 };
                    stats[t.assignedTo].total++;
                    if (isRead) stats[t.assignedTo].read++;
                }
            });
            updateChart(stats);
        });

        function updateChart(statsData) {
            const labels = [], dataTotal = [], dataRead = [];
            for (const [uid, data] of Object.entries(statsData)) {
                labels.push(data.name);
                dataTotal.push(data.total);
                dataRead.push(data.read);
            }
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '爪注', data: dataRead, backgroundColor: '#22c55e' },
                        { label: '住"', data: dataTotal, backgroundColor: '#e2e8f0' }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        window.sendTask = async () => {
            const title = document.getElementById('task-title').value;
            const assignTo = document.getElementById('task-assign').value;
            const mustConfirm = document.getElementById('task-confirm').checked;

            if(!title) return Swal.fire('砖', '砖 转 砖', 'error');

            // 1. 砖专 -DB ( 拽 砖驻注 转 住 住 砖 注)
            await addDoc(collection(db, "tasks"), {
                title: title,
                desc: document.getElementById('task-desc').value,
                assignedTo: assignTo,
                mustConfirm: mustConfirm,
                createdBy: '专',
                createdAt: serverTimestamp(),
                status: 'pending',
                readBy: []
            });

            // 2. 砖转 Push 专 "" (Google Apps Script)  注拽祝 转 砖转 -CORS
            fetch(SCRIPT_URL, {
                method: "POST",
                mode: 'no-cors', // 砖  注 砖转 驻驻
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: "send_push",
                    title: "砖 驻 专",
                    message: title
                })
            });

            Swal.fire({icon: 'success', title: '砖专!', timer: 1000, showConfirmButton: false});
            document.getElementById('task-title').value = '';
            switchView('feed', document.querySelectorAll('.nav-item')[1]);
        };

        window.switchView = (viewId, btn) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        };
    </script>
</body>
</html>
