<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harel Command</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        /* 拽转 转拽转 驻驻 */
        const isHealthy = await new Promise(r => { try { let q=indexedDB.open("t");q.onsuccess=()=>{q.result.close();r(true)};q.onerror=()=>r(false);}catch{r(false)}});
        if(isHealthy) await OneSignal.init({ appId: "07b81f2e-e812-424f-beca-36584b12ccf2" });
      });
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f2f2f7; font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        .ios-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .ios-input { width: 100%; background: #f2f2f7; border: none; padding: 14px; border-radius: 12px; font-size: 16px; outline: none; margin-bottom: 12px; }
        .ios-btn { background: #007aff; color: white; border-radius: 14px; padding: 16px; font-weight: 700; width: 100%; text-align: center; font-size: 18px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .ios-btn:active { transform: scale(0.97); }

        /* Day Selector */
        .day-selector { display: flex; justify-content: space-between; gap: 4px; margin-top: 8px; }
        .day-circle { width: 36px; height: 36px; border-radius: 50%; background: #f2f2f7; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #8e8e93; cursor: pointer; transition: 0.2s; }
        .day-circle.selected { background: #007aff; color: white; box-shadow: 0 2px 5px rgba(0,122,255,0.3); }
    </style>
</head>
<body>

    <div class="pt-6 pb-4 px-5">
        <h1 class="text-3xl font-black text-slate-900 tracking-tight">砖转 专</h1>
        <p class="text-slate-500 text-sm font-medium">砖, 拽专 爪注</p>
    </div>

    <div class="px-4">
        <div class="ios-card">
            <h3 class="font-bold mb-4 text-slate-800 text-lg">爪专转 砖 砖</h3>
            
            <input id="task-title" class="ios-input" placeholder="砖 砖 (: 拽转 )">
            <textarea id="task-desc" class="ios-input" rows="3" placeholder="驻专 转..."></textarea>
            
            <label class="text-xs font-bold text-gray-400 mr-1 mb-1 block"> 砖?</label>
            <select id="task-assign" class="ios-input bg-white border border-gray-200">
                <option value="all">  (注 转驻专爪转  专)</option>
                </select>

            <div class="space-y-4 mt-2">
                
                <div class="flex items-center justify-between bg-red-50 p-3 rounded-xl border border-red-100">
                    <div>
                        <div class="font-bold text-red-900 text-sm">砖转拽 转专 ()</div>
                        <div class="text-[10px] text-red-600">住 转 住 注 注 砖专</div>
                    </div>
                    <input type="checkbox" id="task-confirm" class="w-6 h-6 accent-red-600" checked>
                </div>

                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-bold text-gray-700 text-sm">转专转 专转</div>
                        <input type="checkbox" id="task-recurring" class="w-6 h-6 accent-blue-600" onchange="toggleRecurring()">
                    </div>
                    
                    <div id="recurring-panel" class="hidden border-t border-gray-200 pt-2 mt-2">
                        <div class="text-[10px] font-bold text-gray-400 mb-2">专  专:</div>
                        <div class="day-selector">
                            <div class="day-circle" onclick="toggleDay(this, 'sun')"></div>
                            <div class="day-circle" onclick="toggleDay(this, 'mon')"></div>
                            <div class="day-circle" onclick="toggleDay(this, 'tue')"></div>
                            <div class="day-circle" onclick="toggleDay(this, 'wed')"></div>
                            <div class="day-circle" onclick="toggleDay(this, 'thu')"></div>
                            <div class="day-circle" onclick="toggleDay(this, 'fri')"></div>
                        </div>
                        <div class="mt-3">
                            <div class="text-[10px] font-bold text-gray-400 mb-1">砖注 拽注:</div>
                            <input type="time" id="recurring-time" class="ios-input bg-white !mb-0 !py-2">
                        </div>
                    </div>
                </div>

            </div>

            <button onclick="sendTask()" class="ios-btn mt-6 shadow-blue-500/30">
                <i class="fas fa-paper-plane ml-2"></i> 砖专 专
            </button>
        </div>
    </div>

    <div class="px-4">
        <div class="text-xs font-bold text-gray-400 mb-2 mr-2">驻注转 专</div>
        <div id="logs-preview" class="space-y-2"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        //  砖专
        window.selectedDays = [];

        // 注转 注
        onSnapshot(query(collection(db, "users"), orderBy("name")), (snap) => {
            const sel = document.getElementById('task-assign');
            let html = '<option value="all">  (注 转驻专爪转)</option>';
            snap.forEach(d => {
                const u = d.data();
                if(u.type !== 'client') {
                    html += `<option value="${d.id}">${u.name}</option>`;
                }
            });
            sel.innerHTML = html;
        });

        // 注转  专 (专转  砖专)
        onSnapshot(query(collection(db, "task_logs"), orderBy("timestamp", "desc"), limit(5)), (snap) => {
            const list = document.getElementById('logs-preview');
            list.innerHTML = '';
            snap.forEach(d => {
                const l = d.data();
                const time = l.timestamp ? new Date(l.timestamp.seconds*1000).toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}) : '';
                list.innerHTML += `
                <div class="bg-white p-3 rounded-xl border border-gray-100 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span class="text-sm font-bold text-gray-700">${l.userName} 砖专/</span>
                    </div>
                    <span class="text-xs text-gray-400">${time}</span>
                </div>`;
            });
        });

        // 拽 砖拽
        window.toggleRecurring = () => {
            const el = document.getElementById('recurring-panel');
            el.classList.toggle('hidden');
        };

        window.toggleDay = (el, day) => {
            el.classList.toggle('selected');
            if(window.selectedDays.includes(day)) {
                window.selectedDays = window.selectedDays.filter(d => d !== day);
            } else {
                window.selectedDays.push(day);
            }
        };

        // --- 注 砖 ---
        window.sendTask = async () => {
            const title = document.getElementById('task-title').value;
            const assignTo = document.getElementById('task-assign').value;
            const mustConfirm = document.getElementById('task-confirm').checked;
            
            if(!title) return Swal.fire('砖', '砖 转 砖 砖', 'error');

            // 1. 砖转 转专 转转 (Push) 驻
            try {
                // 驻转 住 砖住驻拽转 - 爪  拽   砖
                const ONE_SIGNAL_API_KEY = "jaav6e6m2em34c3wxihk3tgxk"; 
                const APP_ID = "07b81f2e-e812-424f-beca-36584b12ccf2";

                await fetch("https://onesignal.com/api/v1/notifications", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Basic " + ONE_SIGNAL_API_KEY
                    },
                    body: JSON.stringify({
                        app_id: APP_ID,
                        included_segments: ["All"], // 砖  ( 住 驻 砖转砖  专爪 注转)
                        headings: { en: "砖 砖 专" },
                        contents: { en: title },
                        data: { type: 'urgent_task' } // 住  砖驻拽爪 转注 驻转 转 拽
                    })
                });
                console.log("Push sent successfully");
            } catch (e) {
                console.error("Push failed", e);
            }

            // 2. 砖专 住 转 (  砖驻注 转 住 住)
            await addDoc(collection(db, "tasks"), {
                title: title,
                desc: document.getElementById('task-desc').value,
                assignedTo: assignTo,
                mustConfirm: mustConfirm, //   True - 住 砖 注 住
                isRecurring: document.getElementById('task-recurring').checked,
                recurringDays: window.selectedDays,
                recurringTime: document.getElementById('recurring-time').value,
                createdBy: '专',
                createdAt: serverTimestamp(),
                status: 'pending',
                readBy: []
            });

            Swal.fire({
                icon: 'success', 
                title: '砖 爪', 
                text: '注 拽 转专 住 砖 住 注 砖专',
                confirmButtonColor: '#007aff'
            });

            // 驻住
            document.getElementById('task-title').value = '';
            document.getElementById('task-desc').value = '';
        };
    </script>
</body>
</html>
