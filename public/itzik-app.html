<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Manager | 爪拽 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        body { background: #f1f5f9; font-family: 'Segoe UI', system-ui, sans-serif; padding-bottom: 90px; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Layout */
        .app-container { display: flex; height: 100%; max-width: 1600px; margin: 0 auto; width: 100%; }
        .sidebar-menu { width: 80px; background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; padding-top: 20px; display: none; } 
        .main-view { flex: 1; overflow-y: auto; position: relative; background: #f8fafc; }
        @media (min-width: 768px) { .sidebar-menu { display: flex; } }

        /* Header */
        .hero-header { background: linear-gradient(135deg, #f97316 0%, #c2410c 100%); padding: 25px; border-radius: 0 0 30px 30px; color: white; position: relative; box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3); transition: 0.3s; }
        .admin-watching .hero-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); } /* Dark mode when admin watches */

        .user-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); position: absolute; bottom: -35px; left: 20px; background: white; object-fit: cover; }
        
        /* Actions */
        .grid-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 50px 20px 20px 20px; }
        @media (min-width: 768px) { .grid-actions { grid-template-columns: repeat(4, 1fr); padding-top: 20px; } }

        .action-btn { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border: 1px solid #e2e8f0; transition: 0.2s; position: relative; overflow: hidden; }
        .action-btn:active { transform: scale(0.95); }
        
        /* Admin Ghost Bar (The new feature) */
        .admin-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 50px; display: none; align-items: center; gap: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 100; animation: slideUp 0.5s; }
        .admin-bar button { background: rgba(255,255,255,0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .admin-bar button:hover { background: #3b82f6; transform: scale(1.1); }
        @keyframes slideUp { from { bottom: -100px; } to { bottom: 20px; } }

        /* Visitor View (For non-admins) */
        .visitor-overlay { position: fixed; inset: 0; background: #f8fafc; z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }

        /* Live Indicator */
        .live-indicator { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); padding: 5px 12px; border-radius: 20px; font-size: 11px; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.2); }
        .blink-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body>

    <div id="visitor-mode" class="visitor-overlay">
        <img src="https://media-mrs2-2.cdn.whatsapp.net/v/t61.24694-24/138846705_247951546693089_6505800604178808158_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3QE_Teyw4quA6Pany4Hj8a0LOLkFxWWSd7r__aOsnJSAug&oe=695B1F10&_nc_sid=5e03e0&_nc_cat=105" class="w-24 h-24 rounded-full border-4 border-white shadow-xl mb-4">
        <h2 class="text-xl font-bold text-slate-800">砖转  住祝 专砖</h2>
        <p class="text-gray-500 mb-6 text-sm">砖专 注 爪拽 </p>
        
        <textarea id="visitor-msg" class="w-full max-w-sm p-4 rounded-xl border border-gray-300 mb-4 shadow-sm outline-none focus:border-orange-500" rows="4" placeholder="拽 注..."></textarea>
        <button onclick="sendVisitorMessage()" class="w-full max-w-sm bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">
            <i class="fas fa-paper-plane"></i> 砖 注
        </button>
    </div>

    <div class="app-container" id="app-content">
        
        <div class="sidebar-menu">
            <div class="mb-6 text-orange-600 text-2xl font-bold"><i class="fas fa-layer-group"></i></div>
            <div class="p-3 bg-orange-100 text-orange-600 rounded-xl mb-4"><i class="fas fa-home"></i></div>
        </div>

        <div class="main-view">
            <div class="hero-header flex items-center justify-between" id="header-bg">
                <div class="flex items-center relative z-10">
                    <img src="https://media-mrs2-2.cdn.whatsapp.net/v/t61.24694-24/138846705_247951546693089_6505800604178808158_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3QE_Teyw4quA6Pany4Hj8a0LOLkFxWWSd7r__aOsnJSAug&oe=695B1F10&_nc_sid=5e03e0&_nc_cat=105" class="user-avatar shadow-lg">
                    <div class="mr-4 md:mr-0">
                        <div class="text-orange-100 text-sm font-bold"> 住祝 专砖</div>
                        <h1 class="text-3xl font-black">爪拽 </h1>
                    </div>
                </div>
                
                <div id="admin-presence" class="live-indicator hidden">
                    <div class="blink-dot"></div>
                    <span id="admin-name"> 专</span>
                </div>
            </div>

            <div class="px-5 pt-12 md:pt-5">
                <h2 class="text-lg font-bold text-slate-700 mb-4 border-r-4 border-orange-500 pr-3">驻注转 专转</h2>
                <div class="grid-actions">
                    <button class="action-btn" onclick="createAction('transport')">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-truck-moving"></i></div>
                        <div class="font-bold text-slate-800">转 </div>
                    </button>
                    <button class="action-btn" onclick="createAction('transfer')">
                        <div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-exchange-alt"></i></div>
                        <div class="font-bold text-slate-800">砖 转</div>
                    </button>
                    <button class="action-btn" onclick="openAddUserModal()">
                        <div class="w-12 h-12 bg-green-50 text-green-600 rounded-full flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-user-plus"></i></div>
                        <div class="font-bold text-slate-800">住祝 爪/拽</div>
                    </button>
                    <button class="action-btn" onclick="alert('驻转转 爪')">
                        <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-2 text-xl"><i class="fas fa-comments"></i></div>
                        <div class="font-bold text-slate-800">专 </div>
                    </button>
                </div>
            </div>

            <div class="px-5 mt-4">
                <h2 class="text-lg font-bold text-slate-700 mb-4 border-r-4 border-green-500 pr-3">注 </h2>
                <div id="live-feed" class="space-y-3 pb-20"></div>
            </div>
        </div>
    </div>

    <div id="admin-toolbar" class="admin-bar">
        <div class="text-xs font-bold text-gray-400 pl-2 border-l border-gray-600 ml-2">Admin Control</div>
        <button onclick="adminSendTask()" title="砖 砖 爪拽"><i class="fas fa-tasks"></i></button>
        <button onclick="adminSendMessage()" title="砖 注 转驻专爪转"><i class="fas fa-comment-alt"></i></button>
        <button onclick="window.close()" title="爪 (转拽 注)" class="text-red-400"><i class="fas fa-power-off"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        // --- 1. IDENTITY CHECK ---
        const ITZIK_UID = "0504482285"; // 住驻专 砖 爪拽 (Hardcoded Owner)
        const currentUser = JSON.parse(localStorage.getItem('saban_client')) || { name: '专', uid: 'guest', type: 'visitor' };
        
        // Sounds
        const alertSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        
        function initApp() {
            // 转专砖 ': 爪拽 转
            if (currentUser.uid === ITZIK_UID) {
                setupOwnerMode();
            } 
            // 转专砖 ':  (专/专)
            else if (currentUser.type === 'admin') {
                setupAdminMode();
            } 
            // 转专砖 ': 专/注 专
            else {
                document.getElementById('app-content').style.display = 'none';
                document.getElementById('visitor-mode').style.display = 'flex';
                // 专砖  住 砖 注
                logAction('visitor_view', `${currentUser.name} viewed Itzik's page`);
            }
        }

        // --- OWNER MODE (爪拽) ---
        function setupOwnerMode() {
            //  住转 砖 
            onSnapshot(query(collection(db, "system_events"), where("target", "==", "itzik"), orderBy("timestamp", "desc")), (snap) => {
                snap.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const event = change.doc.data();
                        //  专注 拽专 -10 砖转 专转
                        if (Date.now() - event.timestamp.toMillis() < 10000) {
                            handleAdminEvent(event);
                        }
                    }
                });
            });
        }

        function handleAdminEvent(event) {
            if (event.type === 'admin_entry') {
                alertSound.play();
                document.getElementById('admin-presence').classList.remove('hidden');
                document.getElementById('admin-name').innerText = `${event.adminName} 爪驻 `;
                
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'info', title: `${event.adminName} 转专 驻拽爪` });
                
                // 砖 爪注 专拽注  砖爪拽  砖"砖 注 注"
                document.body.classList.add('admin-watching');
            }
        }

        // --- ADMIN MODE (专/专) ---
        function setupAdminMode() {
            // 1.  爪拽 砖住转
            addDoc(collection(db, "system_events"), {
                target: "itzik",
                type: "admin_entry",
                adminName: currentUser.name,
                timestamp: serverTimestamp()
            });

            // 2. 爪  砖 
            document.getElementById('admin-toolbar').style.display = 'flex';
            document.getElementById('header-bg').classList.add('bg-slate-800'); // Dark theme for admin
            
            // 3. 专砖 
            logAction('admin_monitoring', `${currentUser.name} entered Itzik App`);
        }

        // --- ACTIONS ---
        
        // 砖转 砖 (注" )
        window.adminSendTask = async () => {
            const { value: text } = await Swal.fire({
                title: '砖专 砖 爪拽',
                input: 'text',
                inputPlaceholder: ': 转拽  砖转 转注转...',
                confirmButtonText: '砖专 '
            });
            if(text) {
                // 砖 爪祝 砖 爪拽
                window.open(`https://wa.me/972${ITZIK_UID.substring(1)}?text=${encodeURIComponent(' 砖 : ' + text)}`, '_blank');
                logAction('admin_task', `Task sent to Itzik: ${text}`);
            }
        };

        // 驻注转 砖 爪拽 (转 ')
        window.createAction = async (type) => {
            if(currentUser.type === 'admin') return Swal.fire('爪 爪驻', '转 爪 ,  转 爪注 驻注转 砖 爪拽', 'info');
            
            const { value: text } = await Swal.fire({
                title: '驻专 拽砖',
                input: 'text',
                confirmButtonText: '砖',
                confirmButtonColor: '#f97316'
            });
            
            if(text) {
                await addDoc(collection(db, "orders"), {
                    clientName: `拽砖转 住祝 (${type})`,
                    text: text,
                    requester: '爪拽 ',
                    status: 'new',
                    createdAt: serverTimestamp()
                });
                Swal.fire('砖!', '', 'success');
                logAction('itzik_action', `Created ${type}: ${text}`);
            }
        };

        //  (砖)
        async function logAction(action, details) {
            await addDoc(collection(db, "system_logs"), {
                user: currentUser.name,
                uid: currentUser.uid,
                action: action,
                details: details,
                timestamp: serverTimestamp(),
                device: 'App'
            });
        }

        // 转注
        initApp();
        
        // Expose
        window.adminSendTask = adminSendTask;
        window.createAction = createAction;
        window.openAddUserModal = () => Swal.fire('驻转', '住驻转 砖转砖 转 ', 'info');

    </script>
</body>
</html>
