<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Manager | 爪拽 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background: #e5ddd5; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* --- TABS NAVIGATION (Bottom) --- */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 10px 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); height: 70px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 11px; font-weight: bold; width: 50%; cursor: pointer; transition: 0.2s; position: relative; }
        .nav-item.active { color: #f97316; } /* Orange for Home */
        .nav-item.active.chat-tab { color: #00a884; } /* Green for Chat */
        .nav-item i { font-size: 24px; margin-bottom: 4px; }
        
        .notification-badge { position: absolute; top: 5px; right: 30%; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; animation: bounce 1s infinite; display: none; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        /* --- VIEW CONTAINER --- */
        .view-container { flex: 1; overflow: hidden; display: none; height: 100%; }
        .view-container.active { display: flex; flex-direction: column; }

        /* --- HOME VIEW STYLES --- */
        #view-home { background: #f1f5f9; overflow-y: auto; }
        .hero-header { background: linear-gradient(135deg, #f97316 0%, #c2410c 100%); padding: 25px; border-radius: 0 0 30px 30px; color: white; box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3); }
        .user-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); object-fit: cover; background: white; }
        .action-btn { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border: 1px solid #e2e8f0; transition: 0.2s; }
        .action-btn:active { transform: scale(0.95); }

        /* --- CHAT VIEW STYLES (WhatsApp Clone) --- */
        #view-chat { background: white; }
        
        /* Contact List */
        .chat-list { flex: 1; overflow-y: auto; background: white; }
        .contact-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .contact-item:hover { background: #f5f6f6; }
        .contact-avatar { width: 45px; height: 45px; rounded: 50%; object-fit: cover; margin-left: 12px; }
        .contact-info { flex: 1; }
        .contact-name { font-weight: bold; color: #111b21; font-size: 16px; }
        .last-msg { color: #667781; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .msg-time { font-size: 11px; color: #667781; margin-right: auto; }

        /* Actual Conversation Screen */
        .chat-room { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); z-index: 60; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .chat-room.open { transform: translateX(0); }

        .chat-header { background: #00a884; color: white; padding: 10px 15px; display: flex; align-items: center; height: 60px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 5px; }
        
        .msg-bubble { max-width: 75%; padding: 6px 10px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-meta { font-size: 10px; color: #999; text-align: left; margin-top: 2px; display: flex; justify-content: flex-end; gap: 3px; }
        
        .chat-input-area { background: #f0f2f5; padding: 10px; display: flex; align-items: center; gap: 8px; }
        .chat-input { flex: 1; background: white; border: none; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 15px; }

        /* Admin Inspector Bar (For Rami) */
        .admin-bar { position: fixed; top: 0; left: 0; width: 100%; background: #1e293b; color: white; padding: 5px; text-align: center; font-size: 10px; z-index: 100; display: none; }
    </style>
</head>
<body>

    <div id="admin-inspector" class="admin-bar"> 爪 爪驻 - 专  注专转</div>

    <div id="view-home" class="view-container active">
        <div class="hero-header flex items-center justify-between">
            <div class="flex items-center">
                <img src="https://media-mrs2-2.cdn.whatsapp.net/v/t61.24694-24/138846705_247951546693089_6505800604178808158_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3QE_Teyw4quA6Pany4Hj8a0LOLkFxWWSd7r__aOsnJSAug&oe=695B1F10&_nc_sid=5e03e0&_nc_cat=105" class="user-avatar shadow-lg">
                <div class="mr-4">
                    <div class="text-orange-100 text-sm font-bold"> 住祝 专砖</div>
                    <h1 class="text-2xl font-black">爪拽 </h1>
                </div>
            </div>
        </div>

        <div class="p-5">
            <h2 class="text-lg font-bold text-slate-700 mb-4 border-r-4 border-orange-500 pr-3">驻注转 专转</h2>
            <div class="grid grid-cols-2 gap-4">
                <button class="action-btn" onclick="createOrder('transport')">
                    <div class="text-3xl text-blue-600 mb-2"><i class="fas fa-truck-moving"></i></div>
                    <div class="font-bold text-slate-800">转 </div>
                </button>
                <button class="action-btn" onclick="createOrder('transfer')">
                    <div class="text-3xl text-orange-600 mb-2"><i class="fas fa-exchange-alt"></i></div>
                    <div class="font-bold text-slate-800">砖 转</div>
                </button>
                <button class="action-btn" onclick="openAddUserModal()">
                    <div class="text-3xl text-green-600 mb-2"><i class="fas fa-user-plus"></i></div>
                    <div class="font-bold text-slate-800">住祝 拽</div>
                </button>
                <button class="action-btn" onclick="switchTab('chat')">
                    <div class="text-3xl text-purple-600 mb-2"><i class="fas fa-comments"></i></div>
                    <div class="font-bold text-slate-800">注转 爪转</div>
                </button>
            </div>
        </div>

        <div class="px-5 pb-20">
            <h2 class="text-lg font-bold text-slate-700 mb-4 border-r-4 border-green-500 pr-3">注 专</h2>
            <div id="live-feed" class="space-y-3"></div>
        </div>
    </div>

    <div id="view-chat" class="view-container">
        <div class="bg-[#00a884] p-4 text-white font-bold text-lg flex justify-between items-center h-[70px]">
            <span>Saban Chat</span>
            <i class="fas fa-search"></i>
        </div>
        <div id="contacts-list" class="chat-list">
            </div>
    </div>

    <div id="conversation-room" class="chat-room">
        <div class="chat-header">
            <button onclick="closeChat()" class="ml-2"><i class="fas fa-arrow-right"></i></button>
            <img id="room-avatar" src="" class="w-9 h-9 rounded-full ml-2 bg-gray-300">
            <div class="flex-1">
                <div id="room-name" class="font-bold text-sm">...</div>
                <div class="text-xs text-green-100">专</div>
            </div>
            <i class="fas fa-phone ml-4"></i>
            <i class="fas fa-video"></i>
        </div>

        <div id="chat-messages" class="chat-messages"></div>

        <div class="chat-input-area">
            <i class="fas fa-plus text-gray-500 text-xl"></i>
            <input type="text" id="msg-input" class="chat-input" placeholder="拽 注..." onkeydown="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="w-10 h-10 bg-[#00a884] rounded-full text-white flex items-center justify-center shadow">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="tab-home" onclick="switchTab('home')">
            <i class="fas fa-home"></i>
            <span>专砖</span>
        </div>
        <div class="nav-item chat-tab" id="tab-chat" onclick="switchTab('chat')">
            <div class="relative">
                <i class="fas fa-comment-dots"></i>
                <div id="chat-badge" class="notification-badge">!</div>
            </div>
            <span>注转</span>
        </div>
    </div>

    <audio id="msg-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, where, orderBy, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Config
        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // IDENTITY (Itzik)
        const MY_UID = "0504482285"; 
        const MY_NAME = "爪拽 ";
        
        // Check if Admin is watching
        const localUser = JSON.parse(localStorage.getItem('saban_client'));
        if(localUser && localUser.type === 'admin') {
            document.getElementById('admin-inspector').style.display = 'block';
        }

        // STATIC CONTACTS FOR ITZIK
        const CONTACTS = [
            { uid: '972505227724', name: '专 住', role: '"', avatar: 'https://ui-avatars.com/api/?name=Harel&background=1e293b&color=fff' },
            { uid: '972508860896', name: '专 (转驻注)', role: '', avatar: 'https://media-mrs2-2.cdn.whatsapp.net/v/t61.24694-24/490584763_1521666505466352_3860845398977059833_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3QEGGv9ElRRb2Qx1Adjclex0ahijeyYdc8W8wmVuCZ6L2A&oe=695B04A6&_nc_sid=5e03e0&_nc_cat=104' },
            { uid: '972507855865', name: ' (住专)', role: '', avatar: 'https://ui-avatars.com/api/?name=Yoav&background=00a884&color=fff' },
            { uid: '972509001392', name: '专 (爪专)', role: '注', avatar: 'https://ui-avatars.com/api/?name=Oren&background=orange&color=fff' }
        ];

        let activeChatId = null;
        let activeTab = 'home';

        // --- 1. INITIALIZATION ---
        function init() {
            renderContacts();
            listenToOrders(); // For Home Feed
        }

        // --- 2. NAVIGATION ---
        window.switchTab = (tab) => {
            activeTab = tab;
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`view-${tab}`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');

            if(tab === 'chat') {
                document.getElementById('chat-badge').style.display = 'none'; // Clear badge
            }
        };

        // --- 3. CHAT LOGIC ---
        function renderContacts() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '';
            
            CONTACTS.forEach(c => {
                const chatId = getChatId(MY_UID, c.uid);
                
                // Create list item (Attach listener later for last msg)
                const html = `
                <div class="contact-item" onclick="openChat('${c.uid}', '${c.name}', '${c.avatar}')">
                    <img src="${c.avatar}" class="contact-avatar">
                    <div class="contact-info">
                        <div class="flex justify-between">
                            <div class="contact-name">${c.name}</div>
                            <div class="msg-time" id="time-${chatId}"></div>
                        </div>
                        <div class="last-msg" id="last-${chatId}">抓 转转 砖...</div>
                    </div>
                </div>`;
                list.innerHTML += html;

                // Listen to last message for preview
                listenToLastMessage(chatId);
            });
        }

        function getChatId(uid1, uid2) {
            // Sort UIDs to ensure same ID regardless of who started
            return [uid1, uid2].sort().join('_');
        }

        function listenToLastMessage(chatId) {
            const q = query(collection(db, `chats/${chatId}/messages`), orderBy('timestamp', 'desc'), limit(1));
            onSnapshot(q, (snap) => {
                if(!snap.empty) {
                    const m = snap.docs[0].data();
                    const elMsg = document.getElementById(`last-${chatId}`);
                    const elTime = document.getElementById(`time-${chatId}`);
                    if(elMsg) elMsg.innerText = m.text;
                    if(elTime && m.timestamp) elTime.innerText = new Date(m.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    
                    // Notification Logic
                    if(activeTab !== 'chat' && m.sender !== MY_NAME) {
                        playNotification();
                    }
                }
            });
        }

        window.openChat = (targetUid, name, avatar) => {
            activeChatId = getChatId(MY_UID, targetUid);
            
            // Setup UI
            document.getElementById('room-name').innerText = name;
            document.getElementById('room-avatar').src = avatar;
            document.getElementById('chat-messages').innerHTML = '<div class="text-center text-xs text-gray-400 mt-4">注 注转...</div>';
            document.getElementById('conversation-room').classList.add('open');

            // Listen to messages
            const q = query(collection(db, `chats/${activeChatId}/messages`), orderBy('timestamp', 'asc'));
            
            onSnapshot(q, (snap) => {
                const container = document.getElementById('chat-messages');
                container.innerHTML = '';
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.sender === MY_NAME;
                    const time = m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                    
                    container.innerHTML += `
                    <div class="msg-bubble ${isMe ? 'msg-out' : 'msg-in'}">
                        ${m.text}
                        <div class="msg-meta">
                            <span>${time}</span>
                            ${isMe ? '<i class="fas fa-check-double text-blue-500 text-[10px]"></i>' : ''}
                        </div>
                    </div>`;
                });
                container.scrollTop = container.scrollHeight;
            });
        };

        window.closeChat = () => {
            document.getElementById('conversation-room').classList.remove('open');
            activeChatId = null;
        };

        window.sendMessage = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !activeChatId) return;
            
            input.value = ''; // Clear fast
            
            await addDoc(collection(db, `chats/${activeChatId}/messages`), {
                text: text,
                sender: MY_NAME,
                senderUid: MY_UID,
                timestamp: serverTimestamp()
            });
        };

        // --- 4. HOME TAB LOGIC ---
        function listenToOrders() {
            const q = query(collection(db, "orders"), where("requester", "==", MY_NAME), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                const feed = document.getElementById('live-feed');
                feed.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    feed.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 ${d.status==='new'?'border-orange-500':'border-green-500'} flex justify-between items-center">
                        <div>
                            <div class="font-bold text-gray-800">${d.clientName}</div>
                            <div class="text-xs text-gray-500">${d.text}</div>
                        </div>
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded font-bold">${d.status}</span>
                    </div>`;
                });
            });
        }

        window.createOrder = async (type) => {
            const { value: text } = await Swal.fire({
                title: '驻专 拽砖',
                input: 'text',
                confirmButtonText: '砖',
                confirmButtonColor: '#f97316'
            });
            if(text) {
                await addDoc(collection(db, "orders"), {
                    clientName: `住祝 专砖 (${type})`,
                    text: text,
                    requester: MY_NAME,
                    status: 'new',
                    createdAt: serverTimestamp()
                });
                Swal.fire({icon: 'success', title: '砖!', timer: 1000, showConfirmButton: false});
            }
        };

        window.openAddUserModal = () => {
             Swal.fire({
                title: '住祝 拽',
                html: '<input id="c-name" class="swal2-input" placeholder="砖"><input id="c-phone" class="swal2-input" placeholder="驻">',
                confirmButtonText: '爪专 拽',
                preConfirm: () => {
                    const name = document.getElementById('c-name').value;
                    const phone = document.getElementById('c-phone').value;
                    return `https://saban-system.onrender.com/client-smart.html?uid=${phone}&name=${encodeURIComponent(name)}`;
                }
            }).then(res => {
                if(res.isConfirmed) Swal.fire('拽 ', res.value, 'success');
            });
        };

        function playNotification() {
            document.getElementById('chat-badge').style.display = 'flex';
            const audio = document.getElementById('msg-sound');
            audio.play().catch(e => console.log("Audio requires interaction first"));
        }

        // Init
        init();
        
        // Expose
        window.switchTab = switchTab;
        window.openChat = openChat;
        window.closeChat = closeChat;
        window.sendMessage = sendMessage;
        window.createOrder = createOrder;
        window.openAddUserModal = openAddUserModal;

    </script>
</body>
</html>
