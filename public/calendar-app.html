<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 16px; padding-bottom: 80px; }
        
        /* Calendar Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .day-cell { 
            background: white; border-radius: 8px; min-height: 80px; padding: 4px; border: 1px solid #e2e8f0; 
            display: flex; flex-direction: column; gap: 2px; cursor: pointer; transition: 0.2s;
        }
        .day-cell:active { background: #f1f5f9; }
        .day-header { text-align: center; font-size: 10px; color: #94a3b8; font-weight: bold; padding-bottom: 5px; }
        .day-number { font-size: 12px; font-weight: bold; color: #334155; margin-bottom: 4px; }
        .today .day-number { background: #2563eb; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px auto; }

        /* Events Pills */
        .event-pill { font-size: 9px; padding: 2px 4px; border-radius: 4px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 1px; }
        .evt-meeting { background: #3b82f6; } /*  - 驻砖 */
        .evt-task { background: #ef4444; }    /*  - 砖 */
        .evt-delivery { background: #f59e0b; } /* 转 -  */

        /* Task List Item */
        .task-item { background: white; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .task-check { width: 20px; height: 20px; border: 2px solid #cbd5e1; border-radius: 6px; cursor: pointer; }
        .task-check.done { background: #22c55e; border-color: #22c55e; }
    </style>
</head>
<body>

    <div class="flex justify-between items-center mb-4">
        <div>
            <h1 class="font-bold text-xl text-slate-800"> </h1>
            <div class="text-xs text-slate-500" id="current-month">注...</div>
        </div>
        <button onclick="openAddModal()" class="bg-blue-600 text-white w-10 h-10 rounded-xl shadow-lg flex items-center justify-center text-xl">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <div class="bg-white p-3 rounded-2xl shadow-sm border border-slate-100">
        <div class="grid grid-cols-7 text-center mb-2">
            <div class="day-header"></div><div class="day-header"></div><div class="day-header"></div><div class="day-header"></div>
            <div class="day-header"></div><div class="day-header"></div><div class="day-header">砖</div>
        </div>
        <div id="calendar-body" class="calendar-grid"></div>
    </div>

    <h3 class="text-xs font-bold text-slate-400 uppercase mt-6 mb-3 tracking-wider">转专转 砖 (拽)</h3>
    <div id="tasks-list">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        let currentDate = new Date();
        let events = [];

        // --- 1. RENDER CALENDAR ---
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 注 转专转
            const monthNames = ["专", "驻专专", "专抓", "驻专", "", "", "", "住", "住驻专", "拽专", "专", "爪专"];
            document.getElementById('current-month').innerText = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = '';

            // 砖爪转 专拽转 转
            for(let i=0; i<firstDay; i++) {
                grid.innerHTML += `<div class="bg-transparent"></div>`;
            }

            // 
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const isToday = new Date().toDateString() === new Date(year, month, d).toDateString();
                
                // 住 专注  
                const daysEvents = events.filter(e => e.date === dateStr);
                let eventsHtml = '';
                daysEvents.forEach(e => {
                    let colorClass = 'evt-task';
                    if(e.type === 'meeting') colorClass = 'evt-meeting';
                    if(e.type === 'delivery') colorClass = 'evt-delivery';
                    eventsHtml += `<div class="event-pill ${colorClass}">${e.title}</div>`;
                });

                grid.innerHTML += `
                <div class="day-cell ${isToday ? 'today' : ''}" onclick="selectDate('${dateStr}')">
                    <div class="day-number">${d}</div>
                    ${eventsHtml}
                </div>`;
            }
        }

        // --- 2. FETCH DATA ---
        onSnapshot(query(collection(db, "calendar"), orderBy("date")), (snap) => {
            events = [];
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';

            snap.forEach(d => {
                const e = {id: d.id, ...d.data()};
                events.push(e);

                //   砖 砖注  爪注 - 住祝 专砖 
                if(!e.done) {
                    let icon = 'fa-circle';
                    if(e.type === 'meeting') icon = 'fa-handshake text-blue-500';
                    if(e.type === 'delivery') icon = 'fa-truck text-orange-500';
                    if(e.type === 'task') icon = 'fa-exclamation-circle text-red-500';

                    list.innerHTML += `
                    <div class="task-item">
                        <div class="task-check" onclick="toggleTask('${e.id}', true)"></div>
                        <div class="flex-1">
                            <div class="font-bold text-sm text-slate-800">${e.title}</div>
                            <div class="text-xs text-slate-400 flex gap-2">
                                <span><i class="fas ${icon}"></i> ${e.assignTo || ''}</span>
                                <span><i class="far fa-clock"></i> ${e.date}</span>
                            </div>
                        </div>
                    </div>`;
                }
            });
            renderCalendar();
        });

        // --- 3. ACTIONS ---
        window.openAddModal = async () => {
            const { value: formValues } = await Swal.fire({
                title: '专注 砖',
                html: `
                    <input id="swal-title" class="swal2-input" placeholder="砖 砖/驻砖">
                    <select id="swal-type" class="swal2-input">
                        <option value="task"> 砖</option>
                        <option value="meeting"> 驻砖</option>
                        <option value="delivery"> </option>
                    </select>
                    <input id="swal-date" type="date" class="swal2-input" value="${new Date().toISOString().split('T')[0]}">
                    <input id="swal-assign" class="swal2-input" placeholder="? (: 专)">
                    <input id="swal-doc" class="swal2-input" placeholder="拽 住 (驻爪)">
                `,
                focusConfirm: false,
                confirmButtonText: '砖专 ',
                preConfirm: () => {
                    return {
                        title: document.getElementById('swal-title').value,
                        type: document.getElementById('swal-type').value,
                        date: document.getElementById('swal-date').value,
                        assignTo: document.getElementById('swal-assign').value,
                        docLink: document.getElementById('swal-doc').value
                    }
                }
            });

            if (formValues && formValues.title) {
                await addDoc(collection(db, "calendar"), {
                    ...formValues,
                    done: false,
                    createdAt: new Date()
                });
                
                // 砖转 转专 ( 专 砖)
                if(formValues.assignTo && window.parent.sendOneSignal) {
                    //  驻砖专 驻注 转 驻拽爪转 转专 注驻转  转专爪
                }
                
                Swal.fire('砖专!', '', 'success');
            }
        };

        window.toggleTask = async (id, status) => {
            await updateDoc(doc(db, "calendar", id), { done: status });
        };
        
        window.selectDate = (date) => {
            // 驻砖专转 驻转 住驻 注 转专 砖专
            document.getElementById('swal-date').value = date; // 专砖 砖 拽 拽 -swal
            openAddModal(); 
        };
    </script>
</body>
</html>
