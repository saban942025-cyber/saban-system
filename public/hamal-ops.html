<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Saban Ops | </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f8fafc; font-family: system-ui; }
        
        /* 住专 注 爪祝 */
        .top-bar {
            position: absolute; top: 20px; right: 20px; left: 20px; z-index: 1000;
            display: flex; gap: 10px; pointer-events: none;
        }
        .search-box {
            pointer-events: auto; flex: 1; max-width: 400px; background: white; 
            padding: 12px 20px; border-radius: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 10px; border: 1px solid #e2e8f0;
        }
        .search-input { width: 100%; outline: none; font-size: 16px; color: #334155; }
        
        /* 专住 注 爪祝 */
        .brain-card {
            background: white; padding: 15px; border-radius: 12px; min-width: 250px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2); font-size: 14px;
        }
        .brain-stat { background: #f0fdf4; color: #166534; padding: 5px 10px; border-radius: 6px; font-weight: bold; margin-top: 5px; font-size: 12px; border: 1px solid #bbf7d0; }

        /* 驻 */
        #map { flex: 1; width: 100%; z-index: 0; }
        
        /* 拽 */
        .driver-marker { font-size: 24px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .pin-red { color: #ef4444; font-size: 36px; filter: drop-shadow(0 5px 15px rgba(239, 68, 68, 0.4)); animation: bounce 1s infinite; }
        
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="search-box">
            <i class="fas fa-search text-gray-400"></i>
            <input type="text" id="address-input" class="search-input" placeholder="驻砖 转转 砖专..." onkeydown="if(event.key==='Enter') searchAddress()">
            <button onclick="searchAddress()" class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-700"><i class="fas fa-arrow-left"></i></button>
        </div>
        
        <div class="bg-white px-4 py-2 rounded-full shadow-lg flex items-center gap-3 pointer-events-auto text-sm font-bold text-slate-700">
            <span><i class="fas fa-brain text-purple-500"></i>  :</span>
            <span class="text-blue-600" id="total-trips">0</span> 住注转 转注转
        </div>
    </div>

    <div id="map"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        
        let map, searchMarker;
        let tripHistory = [];

        // 1. 转
        window.onload = async () => {
            initMap();
            loadBrainData(); // 注转 
        };

        function initMap() {
            // 驻 专 (CartoDB Voyager)
            map = L.map('map', { zoomControl: false }).setView([32.162, 34.844], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: 'Saban Ops', maxZoom: 19
            }).addTo(map);

            //  
            onSnapshot(collection(db, "drivers"), (snap) => {
                // 拽  拽 (驻砖转)
                map.eachLayer(l => { if(l.options.icon && l.options.icon.options.className === 'driver-marker') map.removeLayer(l); });
                
                snap.forEach(d => {
                    const drv = d.data();
                    if(drv.location) {
                        const icon = L.divIcon({ className: 'driver-marker', html: '', iconSize: [30,30] });
                        L.marker([drv.location.lat, drv.location.lng], {icon}).addTo(map)
                            .bindTooltip(drv.name, {permanent: true, direction: 'bottom', className: 'bg-white text-xs font-bold px-1 rounded shadow'});
                    }
                });
            });
        }

        // 2. : 注转 住专
        async function loadBrainData() {
            const snap = await getDocs(collection(db, "trip_logs"));
            tripHistory = snap.docs.map(d => d.data());
            document.getElementById('total-trips').innerText = tripHistory.length;
        }

        // 3. 驻砖 转转 (Nominatim API - )
        window.searchAddress = async () => {
            const query = document.getElementById('address-input').value;
            if(!query) return;

            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            const data = await res.json();

            if(data && data.length > 0) {
                const { lat, lon, display_name } = data[0];
                
                if(searchMarker) map.removeLayer(searchMarker);
                
                // 砖 :   砖?
                const brainStats = analyzeLocation(lat, lon);

                const icon = L.divIcon({ className: 'bg-transparent', html: '<i class="fas fa-map-marker-alt pin-red"></i>', iconSize: [40,40], iconAnchor:[20,40] });
                
                searchMarker = L.marker([lat, lon], {icon}).addTo(map)
                    .bindPopup(`
                        <div class="brain-card">
                            <div class="font-bold text-lg mb-1"> 注 砖</div>
                            <div class="text-gray-500 mb-2">${display_name.split(',')[0]}</div>
                            
                            ${brainStats ? `
                                <div class="brain-stat">
                                    <i class="fas fa-brain"></i> 注专转 专转:<br>
                                     爪注: <b>${brainStats.avgTime} 拽'</b> (${brainStats.count} 住注转)
                                </div>
                            ` : '<div class="text-xs text-gray-400 mt-1"> 转 住专 注 </div>'}

                            <button onclick="dispatchOrder('${lat}', '${lon}', '${display_name}')" class="w-full bg-blue-600 text-white mt-3 py-2 rounded-lg font-bold hover:bg-blue-700">
                                砖专  注 
                            </button>
                        </div>
                    `).openPopup();
                
                map.setView([lat, lon], 16);
            } else {
                Swal.fire(' 爪', '住 转转 专转', 'warning');
            }
        };

        // 4. 转 
        function analyzeLocation(lat, lon) {
            // 爪 住注转 砖 专住 砖 500 专 注
            const matches = tripHistory.filter(t => {
                if(!t.destLat) return false;
                const dist = Math.sqrt(Math.pow(t.destLat - lat, 2) + Math.pow(t.destLng - lon, 2));
                return dist < 0.005; 
            });

            if(matches.length > 0) {
                const totalTime = matches.reduce((sum, t) => sum + (t.duration || 0), 0);
                return { count: matches.length, avgTime: Math.round(totalTime / matches.length) };
            }
            return null;
        }

        // 5. 砖专
        window.dispatchOrder = async (lat, lon, address) => {
            const { value: form } = await Swal.fire({
                title: '砖专 砖',
                html: `<input id="swal-items" class="swal2-input" placeholder="驻专 爪 (砖: 2 砖)">
                       <select id="swal-driver" class="swal2-input">
                           <option value="注">注</option>
                           <option value="转">转</option>
                           <option value="住">住</option>
                       </select>`,
                focusConfirm: false,
                preConfirm: () => [document.getElementById('swal-driver').value, document.getElementById('swal-items').value]
            });

            if(form) {
                const [driver, items] = form;
                await addDoc(collection(db, "orders"), {
                    driver: driver,
                    clientName: "砖专 驻",
                    address: address.split(',')[0],
                    destLat: parseFloat(lat), destLng: parseFloat(lon),
                    itemsText: items,
                    status: 'assigned', // 拽驻抓 爪 
                    orderNum: "MAP-" + Math.floor(Math.random()*1000),
                    type: 'order',
                    createdAt: serverTimestamp(),
                    lastUpdate: serverTimestamp()
                });
                Swal.fire('砖专!', `砖 砖 ${driver}`, 'success');
            }
        };
    </script>
</body>
</html>
