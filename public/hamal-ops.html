<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Saban Ops Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #0f172a; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #ops-map { flex: 1; width: 100%; z-index: 1; }
        
        .overlay-panel {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(5px);
            padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            color: white; width: 250px;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .stat-val { font-weight: bold; color: #4ade80; }
        
        /* 拽 转 */
        .driver-pin { font-size: 24px; text-shadow: 0 0 10px cyan; transition: all 0.5s ease; }
        .driver-label { 
            position: absolute; top: -20px; left: -20px; width: 60px; text-align: center;
            background: rgba(0,0,0,0.7); color: white; font-size: 10px; border-radius: 4px; padding: 2px;
        }
        .order-pin { 
            width: 14px; height: 14px; background: #3b82f6; border: 2px solid white; 
            border-radius: 50%; box-shadow: 0 0 10px #3b82f6; 
        }
        .order-pin.urgent { background: #ef4444; box-shadow: 0 0 10px #ef4444; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="overlay-panel">
        <h2 class="text-lg font-bold mb-4 border-b border-gray-700 pb-2 flex items-center gap-2">
            <i class="fas fa-radar text-green-500 animate-pulse"></i> 转转 爪 
        </h2>
        <div class="stat-row">
            <span>  驻注:</span> <span class="stat-val" id="active-drivers">0</span>
        </div>
        <div class="stat-row">
            <span> 转 驻转转:</span> <span class="stat-val text-blue-400" id="open-orders">0</span>
        </div>
        <div class="stat-row">
            <span> 专注 专:</span> <span class="stat-val text-red-500" id="alerts">0</span>
        </div>
    </div>

    <div id="ops-map"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        let map;
        const markers = { drivers: {}, orders: {} };

        // 1. 转 驻 拽转 (Dark)
        map = L.map('ops-map', { zoomControl: false }).setView([32.160, 34.860], 12);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Saban Ops', subdomains: 'abcd', maxZoom: 19
        }).addTo(map);

        // 2.   ( 转)
        onSnapshot(collection(db, "drivers"), (snap) => {
            let activeCount = 0;
            snap.forEach(doc => {
                const driver = doc.data();
                const id = doc.id;
                
                // 拽   注 专 (转 10 拽转) - 专转  "Offline"
                const lastUpdate = driver.lastUpdate?.seconds * 1000 || 0;
                const isOnline = (Date.now() - lastUpdate) < 600000;

                if (isOnline && driver.location) {
                    activeCount++;
                    const iconHtml = `
                        <div class="driver-pin relative">
                            
                            <div class="driver-label">${driver.name}</div>
                        </div>`;
                    
                    const icon = L.divIcon({ className: 'custom-driver', html: iconHtml, iconSize: [30, 30] });

                    if (markers.drivers[id]) {
                        markers.drivers[id].setLatLng([driver.location.lat, driver.location.lng]);
                    } else {
                        markers.drivers[id] = L.marker([driver.location.lat, driver.location.lng], {icon: icon})
                            .bindPopup(`<b>${driver.name}</b><br>专转: ${Math.round(driver.speed || 0)} 拽"砖`)
                            .addTo(map);
                    }
                }
            });
            document.getElementById('active-drivers').innerText = activeCount;
        });

        // 3.  转 (住转 注 驻)
        const qOrders = query(collection(db, "orders"), where("status", "in", ["new", "approved", "assigned", "on_route"]));
        
        onSnapshot(qOrders, (snap) => {
            // 拽 转 砖住专
            // (专住  注砖 diff  转专,  拽 爪专 砖 爪专 驻砖转  专砖 拽)
            Object.values(markers.orders).forEach(m => map.removeLayer(m));
            markers.orders = {};

            let openCount = 0;
            let alertCount = 0;

            snap.forEach(doc => {
                const order = doc.data();
                openCount++;
                if(order.status === 'driver_msg' || order.status === 'urgent') alertCount++;

                // 拽 驻拽 砖 (  GPS 转转)
                // 注专转 转转: 砖转砖 - Geocoding 砖 转转
                //  驻专 转 专转 住 住
                const lat = 32.160 + (Math.random() * 0.05 - 0.025);
                const lng = 34.860 + (Math.random() * 0.05 - 0.025);

                const isUrgent = order.status === 'driver_msg' || order.status === 'urgent';
                const colorClass = isUrgent ? 'urgent' : '';
                
                const icon = L.divIcon({ className: `order-pin ${colorClass}` });
                
                const marker = L.marker([lat, lng], {icon: icon})
                    .bindPopup(`
                        <div style="text-align:right;">
                            <strong>${order.clientName}</strong><br>
                            住住: ${order.status}<br>
                            ${order.driver ? `: ${order.driver}` : '转 砖抓'}
                        </div>
                    `)
                    .addTo(map);
                
                markers.orders[doc.id] = marker;
            });

            document.getElementById('open-orders').innerText = openCount;
            document.getElementById('alerts').innerText = alertCount;
        });

    </script>
</body>
</html>
