<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Saban Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* --- ×¢×™×¦×•×‘ ×“××•×™ WhatsApp --- */
        body { background-color: #efeae2; font-family: -apple-system, Helvetica, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        
        /* Header */
        .app-header { background: #008069; color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 20; }
        
        /* Story Ring (×¡×˜×•×¨×™ ×¡×˜×˜×•×¡) */
        .story-ring { padding: 2px; border-radius: 50%; border: 2px solid transparent; transition: 0.3s; cursor: pointer; position: relative; }
        .story-ring.status-new { border-color: #3b82f6; } /* ×›×—×•×œ - ×—×“×© */
        .story-ring.status-working { border-color: #f97316; animation: spin-slow 4s infinite linear; } /* ×›×ª×•× - ×¢×•×‘×“×™× */
        .story-ring.status-shipping { border-color: #22c55e; } /* ×™×¨×•×§ - ×‘×“×¨×š */
        
        @keyframes spin-slow { 100% { transform: rotate(360deg); } }

        /* ××–×•×¨ ×”×¦'××˜ */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
        
        /* ×‘×•×¢×•×ª ×”×•×“×¢×” */
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); line-height: 1.4; }
        .msg.out { align-self: flex-start; background: #dcf8c6; border-top-right-radius: 0; } /* ×× ×™ (×œ×§×•×—) */
        .msg.in { align-self: flex-end; background: white; border-top-left-radius: 0; } /* ×—×"×œ */
        
        .msg-time { font-size: 10px; color: #999; text-align: left; margin-top: 4px; display: flex; justify-content: flex-end; gap: 4px; }
        
        /* ×‘×•×¢×ª ×”×–×× ×” ××™×•×—×“×ª */
        .order-bubble { background: #e0f2fe !important; border-left: 4px solid #3b82f6; width: 260px; }
        .order-header { font-weight: bold; color: #0369a1; font-size: 13px; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .waze-info { background: rgba(255,255,255,0.5); padding: 4px; border-radius: 4px; font-size: 10px; margin-top: 6px; display: flex; justify-content: space-between; color: #0c4a6e; font-weight: bold; }

        /* ×‘×•×¢×ª × ×”×’ */
        .driver-bubble { background: #f0fdf4 !important; border-left: 4px solid #22c55e; width: 280px; }
        .map-preview { height: 120px; background: #e5e7eb; margin-top: 8px; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        
        /* Input Bar */
        .input-area { background: #f0f2f5; padding: 8px 10px; display: flex; align-items: center; gap: 8px; z-index: 20; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
        .btn-plus { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #54656f; cursor: pointer; }
        .input-box { flex: 1; background: white; border-radius: 20px; padding: 10px 15px; border: none; outline: none; font-size: 15px; }
        .btn-send { width: 40px; height: 40px; background: #008069; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Modal (×”×–×× ×”) */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 50; display: none; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px; animation: slideUp 0.3s ease-out; max-height: 80vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Story View */
        .story-modal { position: fixed; inset: 0; background: black; z-index: 60; display: none; flex-direction: column; }
        .story-bar { display: flex; gap: 4px; padding: 10px; }
        .story-progress { height: 3px; background: rgba(255,255,255,0.3); flex: 1; border-radius: 2px; overflow: hidden; }
        .story-fill { height: 100%; background: white; width: 0%; transition: width 0.1s linear; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="flex items-center gap-3">
            <i class="fas fa-arrow-right text-white"></i>
            <div class="story-ring status-new" id="main-avatar-ring" onclick="openStory()">
                <img src="https://ui-avatars.com/api/?name=Saban+Group&background=25D366&color=fff" class="w-9 h-9 rounded-full border border-white/20">
            </div>
            <div class="flex flex-col cursor-pointer" onclick="openStory()">
                <span class="font-bold text-base leading-none">×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×Ÿ</span>
                <span class="text-[11px] opacity-80" id="header-status">×œ×—×¥ ×œ×¡×˜×˜×•×¡ ×”×–×× ×”...</span>
            </div>
        </div>
        <div class="flex gap-4 text-xl">
            <i class="fas fa-video"></i>
            <i class="fas fa-phone"></i>
            <i class="fas fa-ellipsis-v"></i>
        </div>
    </header>

    <div id="chat-container">
        <div class="bg-[#e1f3fb] text-[12px] text-center p-2 rounded-lg text-gray-600 shadow-sm mx-auto mb-4 border border-[#ccebf8]">
            ğŸ”’ ×”×•×“×¢×•×ª ×•×ª××•× ×•×ª ×‘×©×™×—×” ×–×• ××•×’× ×•×ª ×•××•×¦×¤× ×•×ª ××§×¦×” ×œ×§×¦×”.
        </div>
        
        <div class="msg in">
            ××”×œ×Ÿ <span id="client-name-span"></span> ğŸ‘‹<br>×›××Ÿ ×”×¦×•×•×ª ×©×œ ×¡×‘×Ÿ. ××™×š ××¤×©×¨ ×œ×¢×–×•×¨ ×”×™×•×?
            <div class="msg-time">10:00</div>
        </div>
    </div>

    <div class="input-area">
        <div class="btn-plus hover:bg-gray-200 transition" onclick="openOrderModal()">
            <i class="fas fa-plus text-xl"></i>
        </div>
        <input type="text" id="msg-input" class="input-box" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeydown="if(event.key==='Enter') sendText()">
        <div class="btn-send" onclick="sendText()">
            <i class="fas fa-paper-plane text-sm"></i>
        </div>
    </div>

    <div id="order-modal" class="modal-overlay" onclick="if(event.target===this) closeOrderModal()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">×”×–×× ×” ×—×“×©×” ğŸ—ï¸</h2>
                <button onclick="closeOrderModal()" class="bg-gray-100 w-8 h-8 rounded-full"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">××” ×œ×”×‘×™×?</label>
                    <textarea id="order-items" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-200 h-24 text-base focus:border-green-500 outline-none" placeholder="×œ××©×œ: 5 ××©×˜×—×™ ××œ×˜, 20 ×©×§×™× ×˜×™×˜..."></textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">×œ××Ÿ?</label>
                    <select id="warehouse-select" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-200 mb-2 text-sm" onchange="calcDistance()">
                        <option value="site">×œ××ª×¨ ×©×œ×™ (×œ×¤×™ GPS)</option>
                        <option value="pickup">××™×¡×•×£ ×¢×¦××™</option>
                    </select>
                    <div id="dist-calc" class="text-xs text-blue-600 font-bold hidden bg-blue-50 p-2 rounded">
                        <i class="fas fa-calculator fa-spin"></i> ××—×©×‘ ××¨×—×§ ×××—×¡×Ÿ ×”×—×¨×©...
                    </div>
                </div>

                <button onclick="submitOrder()" class="w-full bg-[#008069] text-white py-3 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">
                    ×©×œ×— ×”×–×× ×” ğŸš€
                </button>
            </div>
        </div>
    </div>

    <div id="story-view" class="story-modal" onclick="closeStory()">
        <div class="story-bar">
            <div class="story-progress"><div class="story-fill" style="width: 100%"></div></div>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center text-white p-10 text-center">
            <div class="w-24 h-24 rounded-full border-4 border-green-500 p-1 mb-6">
                <img src="https://ui-avatars.com/api/?name=Saban&background=fff&color=000" class="w-full h-full rounded-full">
            </div>
            <h1 class="text-2xl font-bold mb-2">×¡×˜×˜×•×¡ ×”×–×× ×” #<span id="story-order-id">888</span></h1>
            <div class="text-4xl mb-4" id="story-icon">ğŸšš</div>
            <p class="text-xl" id="story-text">×”× ×”×’ ×‘×“×¨×š ××œ×™×š!</p>
            <p class="text-sm text-gray-400 mt-8">×œ×—×¥ ×›×“×™ ×œ×¡×’×•×¨</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, updateDoc, doc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // ×–×™×”×•×™ ×œ×§×•×— (×¡×™××•×œ×¦×™×” ××• ×××™×ª×™)
        const params = new URLSearchParams(window.location.search);
        const CLIENT_ID = params.get('uid') || 'guest_123';
        const CLIENT_NAME = params.get('name') || '×–×‘×•×œ×•×Ÿ ×§×‘×œ× ×™×';

        document.getElementById('client-name-span').innerText = CLIENT_NAME.split(' ')[0];

        let currentOrderId = null;
        let warehouseCoords = { lat: 32.147, lng: 34.887 }; // ×”×—×¨×© 10, ×”×•×“ ×”×©×¨×•×Ÿ

        // --- 1. ×”××–× ×” ×œ×¦'××˜ ×‘×–××Ÿ ×××ª ---
        // ×× ×—× ×• ×××–×™× ×™× ×œ×”×–×× ×” ×”××—×¨×•× ×” ×”×¤×¢×™×œ×” ×©×œ ×”×œ×§×•×—
        const q = query(collection(db, "orders"), where("clientId", "==", CLIENT_ID), orderBy("createdAt", "desc"));

        onSnapshot(q, (snap) => {
            const container = document.getElementById('chat-container');
            
            if (!snap.empty) {
                const data = snap.docs[0].data();
                const id = snap.docs[0].id;
                currentOrderId = id;

                // ×¢×“×›×•×Ÿ ×”×¡×˜×•×¨×™ ×œ××¢×œ×”
                updateHeaderStory(data.status);

                // ×× ×–×” ×˜×¢×™× ×” ×¨××©×•× ×” ××• ×©×™× ×•×™, × ×¨× ×“×¨ ××ª ×”×¦'××˜
                // (×‘×’×¨×¡×” ××œ××” × ×‘×“×•×§ ×“×œ×ª×, ×›××Ÿ × × ×§×” ×•× ×¨× ×“×¨ ×œ××¢×Ÿ ×”×¤×©×˜×•×ª ×•×”×¡×“×¨)
                // ×× ×—× ×• ×©×•××¨×™× ×¢×œ ×”×”×•×“×¢×” ×”×¨××©×•× ×” (×‘×¨×•×š ×”×‘×)
                const welcomeMsg = container.firstElementChild.outerHTML + container.children[1].outerHTML;
                container.innerHTML = welcomeMsg;

                // ×¨×™× ×“×•×¨ ×”×•×“×¢×•×ª
                if(data.chat) {
                    data.chat.forEach(msg => {
                        appendMessageBubble(msg);
                    });
                }
                
                // ×’×œ×™×œ×” ×œ××˜×”
                container.scrollTop = container.scrollHeight;

                // ×”×ª×¨××•×ª ×¡××•× ×“ (×× ×”×”×•×“×¢×” ×”××—×¨×•× ×” ×”×™× ×œ× ×©×œ×™)
                const lastMsg = data.chat ? data.chat[data.chat.length - 1] : null;
                if (lastMsg && lastMsg.sender !== 'client') {
                    playNotification();
                }
            }
        });

        function appendMessageBubble(msg) {
            const container = document.getElementById('chat-container');
            const isMe = msg.sender === 'client';
            const time = msg.time ? new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
            
            let html = '';

            // 1. ×‘×•×¢×ª ×”×–×× ×” (××™×•×—×“×ª)
            if (msg.type === 'order_created') {
                html = `
                <div class="msg out order-bubble">
                    <div class="order-header"><i class="fas fa-clipboard-list"></i> ×”×–×× ×” ×—×“×©×”</div>
                    <div class="text-sm">${msg.text}</div>
                    <div class="waze-info">
                        <span><i class="fas fa-route"></i> ${msg.dist || '12 ×§"×'}</span>
                        <span><i class="fas fa-clock"></i> ${msg.duration || '20 ×“×§\''}</span>
                    </div>
                    <div class="msg-time">${time} <i class="fas fa-check-double text-blue-500"></i></div>
                </div>`;
            } 
            // 2. ×‘×•×¢×ª "× ×”×’ ×‘×“×¨×š" (××™×•×—×“×ª)
            else if (msg.type === 'driver_assigned' || (msg.text && msg.text.includes('×”× ×”×’'))) {
                html = `
                <div class="msg in driver-bubble">
                    <div class="font-bold text-green-800 text-xs mb-1">ğŸšš ×¢×“×›×•×Ÿ ×—×"×œ</div>
                    <div class="text-sm">${msg.text}</div>
                    
                    <div class="map-preview" onclick="openLiveMap()">
                        <div class="absolute inset-0 bg-[url('https://miro.medium.com/max/1400/1*qYUvh-EtES8dtgKiBRiLsA.png')] bg-cover opacity-60"></div>
                        <button class="bg-white/90 text-green-700 px-4 py-2 rounded-full font-bold shadow-lg z-10 text-xs hover:scale-105 transition">
                            <i class="fas fa-map-marker-alt"></i> ×¦×¤×” ×‘××™×§×•× × ×”×’
                        </button>
                    </div>

                    <div class="flex gap-2 mt-2">
                        <button class="flex-1 bg-white border border-gray-200 py-1 rounded text-xs font-bold text-gray-700">ğŸ“ ×”× ×”×’</button>
                        <button class="flex-1 bg-blue-500 text-white py-1 rounded text-xs font-bold"><i class="fab fa-waze"></i> ×¡×¢</button>
                    </div>
                    <div class="msg-time">${time}</div>
                </div>`;
            }
            // 3. ×”×•×“×¢×ª ×˜×§×¡×˜ ×¨×’×™×œ×”
            else {
                html = `
                <div class="msg ${isMe ? 'out' : 'in'}">
                    ${msg.imageUrl ? `<img src="${msg.imageUrl}" class="rounded-lg mb-1 w-full cursor-pointer" onclick="window.open(this.src)">` : ''}
                    ${msg.text}
                    <div class="msg-time">${time} ${isMe ? '<i class="fas fa-check text-gray-400"></i>' : ''}</div>
                </div>`;
            }
            
            container.insertAdjacentHTML('beforeend', html);
        }

        // --- 2. ×œ×•×’×™×§×ª ×”×–×× ×” ×•×—×™×©×•×‘ ×–×× ×™× ---
        window.openOrderModal = () => {
            document.getElementById('order-modal').style.display = 'flex';
            calcDistance(); // ×”×ª×—×œ×ª ×—×™×©×•×‘
        };
        window.closeOrderModal = () => document.getElementById('order-modal').style.display = 'none';

        window.calcDistance = () => {
            const distDiv = document.getElementById('dist-calc');
            distDiv.classList.remove('hidden');
            distDiv.innerHTML = '<i class="fas fa-calculator fa-spin"></i> ××—×©×‘ ××¡×œ×•×œ ×××—×¡×Ÿ ×”×—×¨×©...';
            
            // ×¡×™××•×œ×¦×™×™×ª ×—×™×©×•×‘ (×‘××¦×™××•×ª: Google Distance Matrix API)
            setTimeout(() => {
                const rndDist = (Math.random() * 15 + 5).toFixed(1); // 5-20 ×§"×
                const rndTime = Math.floor(rndDist * 1.5 + 10); // ×–××Ÿ ××©×•×¢×¨
                distDiv.innerHTML = `ğŸ“ ××¨×—×§ ××©×•×¢×¨: <b>${rndDist} ×§"×</b> | â±ï¸ ×–××Ÿ: <b>${rndTime} ×“×§×•×ª</b>`;
                distDiv.dataset.dist = rndDist + ' ×§"×';
                distDiv.dataset.time = rndTime + ' ×“×§\'';
            }, 1500);
        };

        window.submitOrder = async () => {
            const items = document.getElementById('order-items').value;
            if(!items) return;
            
            const distInfo = document.getElementById('dist-calc');
            const dist = distInfo.dataset.dist || '10 ×§"×';
            const duration = distInfo.dataset.time || '25 ×“×§\'';

            // ×× ××™×Ÿ ×”×–×× ×” ×§×™×™××ª ×¤×¢×™×œ×”, × ×™×¦×•×¨ ×—×“×©×”. ×× ×™×©, × ×•×¡×™×£ ×œ×”×•×“×¢×”.
            // ×œ×¦×•×¨×š ×”×¤×©×˜×•×ª, × ×™×¦×•×¨ ×—×“×©×” ×× ×”×¡×˜×˜×•×¡ ×”×•× 'done', ××—×¨×ª × ×¢×“×›×Ÿ.
            
            const msgData = {
                sender: 'client',
                type: 'order_created',
                text: items,
                dist: dist,
                duration: duration,
                time: new Date().toISOString()
            };

            // ×™×¦×™×¨×ª ×”×–×× ×” ×—×“×©×” ×‘×¤×™×™×¨×‘×™×™×¡
            await addDoc(collection(db, "orders"), {
                clientId: CLIENT_ID,
                clientName: CLIENT_NAME,
                itemsText: items,
                status: 'new', // ×—×“×©
                orderNum: Math.floor(Math.random()*10000).toString(),
                createdAt: serverTimestamp(),
                lastUpdate: serverTimestamp(),
                chat: [msgData]
            });

            closeOrderModal();
            document.getElementById('order-items').value = '';
            
            // ×¡××•× ×“ ×©×œ×™×—×”
            new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a').play().catch(()=>{});
        };

        // --- 3. ×©×œ×™×—×ª ×”×•×“×¢×” ×¨×’×™×œ×” ---
        window.sendText = async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            input.value = '';
            
            // ×× ×™×© ×”×–×× ×” ×¤×¢×™×œ×”, × ×¢×“×›×Ÿ ××•×ª×”. ×× ×œ×, ×¦×¨×™×š ×œ×™×¦×•×¨ ×—×“×©×” (××• ×œ×•×’×™×§×ª "×©×™×—×” ×›×œ×œ×™×ª").
            // ×‘×¡×™××•×œ×¦×™×” ×”×–×• × × ×™×— ×©×× ×—× ×• ××¢×“×›× ×™× ××ª currentOrderId
            if (currentOrderId) {
                await updateDoc(doc(db, "orders", currentOrderId), {
                    chat: arrayUnion({ sender: 'client', text: text, time: new Date().toISOString() }),
                    status: 'changes_requested', // ××§×¤×™×¥ ×œ×—×"×œ
                    lastUpdate: serverTimestamp()
                });
            } else {
                // ×™×¦×™×¨×ª "×©×™×—×”" ×—×“×©×”
                await addDoc(collection(db, "orders"), {
                    clientId: CLIENT_ID,
                    clientName: CLIENT_NAME,
                    status: 'new',
                    itemsText: '×”×•×“×¢×ª ×¦\'××˜',
                    createdAt: serverTimestamp(),
                    lastUpdate: serverTimestamp(),
                    chat: [{ sender: 'client', text: text, time: new Date().toISOString() }]
                });
            }
        };

        // --- 4. ×¢×–×¨×™× (×¡××•× ×“, ×¡×˜×•×¨×™) ---
        function updateHeaderStory(status) {
            const ring = document.getElementById('main-avatar-ring');
            const statusText = document.getElementById('header-status');
            
            ring.className = 'story-ring'; // Reset
            
            if (status === 'new') {
                ring.classList.add('status-new');
                statusText.innerText = '×”×ª×§×‘×œ ××¦×œ× ×•';
            } else if (status === 'assigned' || status === 'approved') {
                ring.classList.add('status-working');
                statusText.innerText = '××›×™× ×™× ××ª ×”×”×–×× ×”...';
            } else if (status === 'on_route' || status.includes('driver')) {
                ring.classList.add('status-shipping');
                statusText.innerText = '×”× ×”×’ ×‘×“×¨×š ××œ×™×š!';
            } else {
                statusText.innerText = '××—×•×‘×¨';
            }
        }

        window.openStory = () => {
            document.getElementById('story-view').style.display = 'flex';
            // ×× ×™××¦×™×™×ª ××™×œ×•×™ ×¤×¡
            setTimeout(() => document.querySelector('.story-fill').style.width = '100%', 100);
            setTimeout(() => closeStory(), 4000); // ×¡×’×™×¨×” ××•×˜×•××˜×™×ª
        };
        window.closeStory = () => {
            document.getElementById('story-view').style.display = 'none';
            document.querySelector('.story-fill').style.width = '0%';
        };

        window.openLiveMap = () => {
            Swal.fire({
                title: 'ğŸ“ ××¢×§×‘ ×—×™',
                html: '<div style="height:300px; background:#e5e7eb; display:flex; align-items:center; justify-content:center;">××¤×ª ×’×•×’×œ ×—×™×” × ×˜×¢× ×ª...</div>',
                showConfirmButton: false,
                showCloseButton: true
            });
        };

        function playNotification() {
            // ×¦×œ×™×œ ×”×•×“×¢×” × ×›× ×¡×ª (×¢×“×™×Ÿ)
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.m4a');
            audio.volume = 0.5;
            audio.play().catch(e => console.log('Audio autoplay blocked'));
            if(navigator.vibrate) navigator.vibrate(200);
        }

    </script>
</body>
</html>
