<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sidor Group AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: transparent; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 12px; border: 1px solid #e2e8f0; position: relative; }
        .card-client-msg { border-right: 4px solid #f97316; background: #fff7ed; }
        .card-new { border-right: 4px solid #3b82f6; }
        
        .btn-dispatch { background: #1e293b; color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-dispatch:hover { background: #000; }
    </style>
</head>
<body>
    
    <div class="bg-white p-3 border-b flex justify-between items-center shadow-sm sticky top-0 z-10">
        <div class="text-xs font-bold text-gray-500">×¤×™×“ ××‘×¦×¢×™</div>
        <button onclick="manualLink()" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded text-xs font-bold hover:bg-indigo-100"><i class="fas fa-link"></i> ×©×™×“×•×š ××¡××š</button>
    </div>

    <div id="chat-feed"><div class="text-center text-xs text-gray-400 mt-4">-- ×‘×˜×¢×™× ×” --</div></div>

    <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t">
        <button onclick="window.parent.triggerAlert('buzzer', '×‘×“×™×§×”')" class="text-white bg-red-500 w-10 h-10 rounded-full shadow-md flex items-center justify-center"><i class="fas fa-bullhorn"></i></button>
        <input type="text" id="team-input" placeholder="×”×•×“×¢×” ×œ×¦×•×•×ª..." class="flex-1 p-3 rounded-xl border-none text-sm shadow-sm">
        <button onclick="sendTeamMsg()" class="text-green-600 p-2"><i class="fas fa-paper-plane text-xl"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, updateDoc, doc, arrayUnion, getDocs, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        onSnapshot(query(collection(db, "orders"), orderBy("lastUpdate", "desc"), limit(20)), (snap) => {
            if(snap.empty) { feed.innerHTML = '<div class="text-center text-xs mt-10">××™×Ÿ ××™×¨×•×¢×™×</div>'; return; }
            
            feed.innerHTML = ''; // ×× ×§×™× ×•××¨× ×“×¨×™× ××—×“×© ×›×“×™ ×œ×©××•×¨ ×¢×œ ×¡×“×¨ × ×›×•×Ÿ
            
            // × ×”×¤×•×š ××ª ×”×¡×“×¨ ×›×“×™ ×©×”×—×“×© ×™×”×™×” ×œ××˜×” (×›××• ×¦'××˜) ××• ×œ××¢×œ×”?
            // ×‘×¤×™×“ ××‘×¦×¢×™ ×¢×“×™×£ ×—×“×© ×œ××¢×œ×”, ××‘×œ ×‘×¦'××˜ ×¨×’×™×œ ×—×“×© ×œ××˜×”. × ×©××™×¨ ×›××• ×¤×™×“ (×—×“×© ×œ××¢×œ×”).
            snap.docs.forEach(d => {
                const data = d.data();
                const id = d.id;
                const isFresh = (Date.now() - (data.lastUpdate?.seconds*1000 || 0)) < 15000;
                
                // ×œ×•×’×™×§×ª ×ª×¦×•×’×”
                let cardClass = 'card';
                if(data.status === 'changes_requested') cardClass += ' card-client-msg';
                if(data.status === 'new') cardClass += ' card-new';
                
                // ×›×¤×ª×•×¨ ×©×™×’×•×¨ × ×”×’? (×¨×§ ×× ×××•×©×¨ ×•×¢×“×™×™×Ÿ ×œ× ×©×•×™×š ××• ×©×•×™×š)
                const showDispatch = data.status === 'approved' || data.status === 'assigned';
                const driverLabel = data.driver ? `(× ×”×’: ${data.driver})` : '';

                const html = `
                <div class="${cardClass} mb-3">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>${data.status === 'changes_requested' ? 'ğŸŸ  ×”×•×“×¢×” ××œ×§×•×—' : (data.status === 'new' ? 'ğŸ”µ ×”×–×× ×” ×—×“×©×”' : 'ğŸŸ¢ ×‘×˜×™×¤×•×œ')}</span>
                        <span>${new Date(data.lastUpdate?.seconds*1000).toLocaleTimeString().slice(0,5)}</span>
                    </div>
                    <div class="font-bold text-sm text-slate-800">#${data.orderNum} | ${data.clientName}</div>
                    <div class="text-xs text-gray-600 mt-1 truncate">${data.itemsText}</div>
                    
                    ${data.status === 'changes_requested' ? `
                        <div class="mt-2 bg-orange-100 p-2 rounded text-sm font-bold text-orange-800">"${data.chat[data.chat.length-1]?.text}"</div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="reply('${id}')" class="text-xs bg-white border border-orange-300 px-2 py-1 rounded">×”×©×‘</button>
                            <button onclick="markOK('${id}')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">×˜×•×¤×œ</button>
                        </div>
                    ` : ''}

                    ${showDispatch ? `
                        <div class="mt-3 pt-2 border-t flex justify-between items-center">
                            <span class="text-xs font-bold text-green-600">âœ… ×××•×©×¨ ×œ×”×¢××¡×”</span>
                            <button onclick="dispatchDriver('${id}', '${data.clientName}')" class="btn-dispatch">
                                <i class="fas fa-truck-moving"></i> ${data.driver ? '×©× ×” × ×”×’' : '×”×–× ×§ × ×”×’'} ${driverLabel}
                            </button>
                        </div>
                    ` : ''}
                </div>`;
                
                feed.innerHTML += html;
                
                if(isFresh && change.type === 'modified') { /* ×¡××•× ×“ ×•×›×•' */ }
            });
        });

        window.dispatchDriver = async (id, client) => {
            const { value: driver } = await Swal.fire({
                title: '×”×–× ×§×ª × ×”×’',
                text: `×¢×‘×•×¨: ${client}`,
                input: 'select',
                inputOptions: {'×¢×œ×™':'×¢×œ×™','×—×›××ª':'×—×›××ª','×¡×œ×××Ÿ':'×¡×œ×××Ÿ'},
                inputPlaceholder: '×‘×—×¨ × ×”×’...',
                confirmButtonText: '×©×“×¨ ×œ××¡×š ×”× ×”×’ ğŸš€'
            });

            if(driver) {
                await updateDoc(doc(db, "orders", id), {
                    driver: driver,
                    status: 'assigned',
                    dispatchedAt: new Date(),
                    lastUpdate: new Date() // ××§×¤×™×¥ ×œ××¢×œ×”
                });
                Swal.fire('×©×•×“×¨!', `×”××©×™××” ××¦×œ ${driver}`, 'success');
            }
        };

        window.manualLink = async () => { /* ×§×•×“ ×”×©×™×“×•×š ×©×›×ª×‘× ×• ×§×•×“× */ };
        window.reply = async (id) => { /* ×§×•×“ ×ª×©×•×‘×” */ };
        window.markOK = async (id) => { await updateDoc(doc(db,"orders",id),{status:'waiting_approval'}); };
        window.sendTeamMsg = async () => { /* ... */ };
    </script>
</body>
</html>
