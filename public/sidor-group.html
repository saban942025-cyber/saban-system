<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sidor Group AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: transparent; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #chat-feed { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; gap: 10px; }
        
        .bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; position: relative; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble.in { background: white; align-self: flex-start; border-top-right-radius: 0; }
        .bubble.alert { background: #fee2e2; border-left: 4px solid #ef4444; } /* ×”×•×“×¢×” ×“×—×•×¤×” ××œ×§×•×— */
        .bubble.approved { background: #dcfce7; border-left: 4px solid #22c55e; } /* ××™×©×•×¨ ×”×¢××¡×” */
        
        .timestamp { font-size: 10px; color: #999; text-align: left; margin-top: 4px; }
        
        /* ×× ×™××¦×™×™×ª ×”×‘×”×•×‘ ×œ×”×•×“×¢×•×ª ×“×—×•×¤×•×ª */
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .flashing { animation: flash 1s infinite; }
    </style>
</head>
<body>
    <div id="chat-feed">
        <div class="text-center text-xs text-gray-500 bg-gray-100 p-2 rounded mb-4">
            ğŸ¤– ×”××¢×¨×›×ª ×××–×™× ×” ×œ×©×™× ×•×™×™× ×‘×–××Ÿ ×××ª...
        </div>
    </div>

    <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t border-gray-300">
        <button class="text-gray-500 p-2 hover:bg-gray-200 rounded-full"><i class="fas fa-plus"></i></button>
        <input type="text" id="team-input" placeholder="×”×§×œ×“ ×”×•×“×¢×” ×œ×¦×•×•×ª..." class="flex-1 p-3 rounded-xl border-none outline-none text-sm">
        <button onclick="sendTeamMsg()" class="text-[#008069] p-2 hover:bg-gray-200 rounded-full"><i class="fas fa-paper-plane text-xl"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        // ×¤×•× ×§×¦×™×™×ª ×”×•×¡×¤×ª ×‘×•×¢×”
        function addMsg(html, type) {
            const div = document.createElement('div');
            div.className = `bubble in ${type}`;
            div.innerHTML = html;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }
// --- ×”×—×œ×£ ××ª ×”-onSnapshot ×”×§×™×™× ×‘×§×•×“ ×”×–×” ×‘-sidor-group.html ---

        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(20)), (snap) => {
            snap.docChanges().forEach(change => {
                const data = change.doc.data();
                
                // 1. ×”×–×× ×” ×—×“×©×” × ×›× ×¡×”! (ADDED)
                if (change.type === "added") {
                    // ×‘×“×™×§×”: ×”×× ×”×”×–×× ×” × ×•×¦×¨×” ×××© ×¢×›×©×™×•? (×›×“×™ ×œ× ×œ×¦×¤×¦×£ ×¢×œ ×”×™×¡×˜×•×¨×™×” ×‘×˜×¢×™× ×ª ×“×£)
                    const now = Date.now();
                    const orderTime = data.createdAt ? data.createdAt.seconds * 1000 : now;
                    const isFresh = (now - orderTime) < 10000; // × ×•×¦×¨ ×‘-10 ×©× ×™×•×ª ×”××—×¨×•× ×•×ª

                    addMsg(`
                        <div class="flex justify-between items-start">
                            <span class="font-bold text-blue-600 text-xs">ğŸ“¦ ×”×–×× ×” ×—×“×©×” #${data.orderNum || '...'}</span>
                            <span class="text-[10px] bg-gray-100 px-1 rounded">${data.supplyTime || '×˜×¨× × ×§×‘×¢'}</span>
                        </div>
                        <div class="font-bold text-gray-800">${data.clientName}</div>
                        <div class="text-sm text-gray-600 mt-1">${data.itemsText}</div>
                        <div class="flex gap-2 mt-2">
                             <button onclick="window.parent.loadTool('client-final.html?uid=${data.clientId}&name=${data.clientName}', '××‘×˜ ×œ×§×•×—', null)" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100">ğŸ‘ï¸ ×¦×¤×” ×›×œ×§×•×—</button>
                        </div>
                    `, '');

                    // === ×”×ª×™×§×•×Ÿ: ×”×©××¢×ª ×¡××•× ×“ ×× ×”×”×–×× ×” ×˜×¨×™×™×” ===
                    if (isFresh) {
                        // × ×™×¡×™×•×Ÿ ×œ× ×’×Ÿ ×“×¨×š ×—×œ×•×Ÿ ×”××‘ (×™×•×ª×¨ ×™×¦×™×‘)
                        if(window.parent && window.parent.triggerAlert) {
                            window.parent.triggerAlert('info', `×”×–×× ×” ×—×“×©×” ×${data.clientName}`);
                        } else {
                            // ×’×™×‘×•×™: × ×™×’×•×Ÿ ×™×©×™×¨
                            new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a').play().catch(e => console.log("Sound blocked by browser"));
                        }
                    }
                }

                // 2. ×©×™× ×•×™×™× (MODIFIED) - ×”×•×“×¢×•×ª, ××™×©×•×¨×™× ×•×›×•'
                if (change.type === "modified") {
                    
                    // ×ª×¨×—×™×© ×': ×”×•×“×¢×” ××œ×§×•×—
                    if (data.status === 'changes_requested') {
                        const lastMsg = data.chat && data.chat.length > 0 ? data.chat[data.chat.length - 1].text : '×‘×™×§×© ×©×™× ×•×™';
                        addMsg(`
                            <div class="flex items-center gap-2 text-red-600 font-bold text-xs mb-1">
                                <i class="fas fa-comment-dots animate-bounce"></i> ×”×•×“×¢×” ××œ×§×•×— ×‘×”×–×× ×” #${data.orderNum}
                            </div>
                            <div class="text-sm font-bold">"${lastMsg}"</div>
                        `, 'alert flashing');

                        // ×”×¤×¢×œ×ª ×¦×•×¤×¨
                        if(window.parent.triggerUrgentAlert) {
                            window.parent.triggerUrgentAlert(`×”×•×“×¢×” ×${data.clientName}: ${lastMsg}`);
                        }
                    }

                    // ×ª×¨×—×™×© ×‘': ××™×©×•×¨ ×”×¢××¡×”
                    if (data.status === 'approved') {
                        addMsg(`
                            <div class="flex items-center gap-2 text-green-700 font-bold text-xs mb-1">
                                <i class="fas fa-lock"></i> ××™×©×•×¨ ×”×¢××¡×”
                            </div>
                            <div class="text-sm">×”×œ×§×•×— <b>${data.clientName}</b> ××™×©×¨ ××ª ×”×”×–×× ×”!</div>
                        `, 'approved');
                        
                        new Audio('https://assets.mixkit.co/active_storage/sfx/1111/1111-preview.m4a').play().catch(()=>{});
                    }
                }
            });
        });

        // ×©×œ×™×—×ª ×”×•×“×¢×” ×›×œ×œ×™×ª ×œ×¦×•×•×ª (×œ× ×§×©×•×¨×” ×œ×”×–×× ×” ×¡×¤×¦×™×¤×™×ª)
        window.sendTeamMsg = () => {
            const input = document.getElementById('team-input');
            if(input.value) {
                // ×œ×•×’×™×§×” ×œ×©××™×¨×” ×‘-DB ×›×œ×œ×™ ×©×œ ×”×•×“×¢×•×ª ×¦×•×•×ª
                input.value = '';
            }
        }
    </script>
</body>
</html>
