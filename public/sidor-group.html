<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sidor Group AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: transparent; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        /* 注爪 专住 住 住 */
        .doc-card {
            background: white; border-radius: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            border: 1px solid #e2e8f0; border-right: 4px solid #3b82f6; /* 驻住  住 */
            padding: 12px; position: relative;
        }

        .sender-info { font-size: 10px; color: #64748b; display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid #f1f5f9; padding-bottom: 4px; }
        .doc-title { font-weight: 800; font-size: 14px; color: #1e293b; line-height: 1.4; margin-bottom: 8px; }
        .action-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }

        .btn-pdf { background: #eff6ff; color: #2563eb; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; display: flex; items-center; gap: 5px; }
        .btn-inquiry { background: #fef2f2; color: #dc2626; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="chat-feed">
        <div class="text-center text-xs text-gray-400 my-4">-- 转转 住 住 --</div>
    </div>

    <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t border-gray-300">
        <button onclick="window.parent.triggerAlert('buzzer', '拽')" class="text-white bg-red-500 w-10 h-10 rounded-full shadow-md flex items-center justify-center"><i class="fas fa-bullhorn"></i></button>
        <input type="text" id="team-input" placeholder="注 爪转..." class="flex-1 p-3 rounded-xl border-none outline-none text-sm shadow-sm">
        <button onclick="sendTeamMsg()" class="text-[#008069] p-2"><i class="fas fa-paper-plane text-xl"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, updateDoc, doc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        function addCard(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        // ---  住 住 ---
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(20)), (snap) => {
            snap.docChanges().forEach(change => {
                const data = change.doc.data();
                const id = change.doc.id;
                
                // 注  拽
                const time = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'}) : '注砖';

                //   住 砖转拽  (砖  docTitle  pdfUrl)
                if (change.type === "added" || change.type === "modified") {
                    
                    // 转专转:  砖 docTitle () 砖转砖 , 专转  
                    const displayTitle = data.docTitle || `住 #${data.orderNum} 拽: ${data.clientName}`;
                    
                    // 砖: 拽 转 - <email> 转专  砖
                    let sender = data.emailSender || '注专转 转';
                    sender = sender.replace(/<.*>/, '').trim(); 

                    const html = `
                    <div class="doc-card">
                        <div class="sender-info">
                            <span><i class="fas fa-envelope"></i> ${sender}</span>
                            <span>${time}</span>
                        </div>

                        <div class="doc-title">
                            ${displayTitle}
                        </div>

                        <div class="action-row">
                            ${data.pdfUrl ? 
                                `<button onclick="window.open('${data.pdfUrl}')" class="btn-pdf">
                                    <i class="fas fa-file-pdf"></i> 爪驻 住
                                 </button>` : 
                                `<span class="text-xs text-gray-400"> 拽抓</span>`
                            }

                            <button onclick="openInquiry('${id}', '${data.orderNum}')" class="btn-inquiry">
                                 驻转 专专
                            </button>
                        </div>
                        
                        ${data.status === 'urgent_attention' ? 
                            `<div class="mt-2 bg-red-50 text-red-700 text-xs p-2 rounded border border-red-100 font-bold">
                                <i class="fas fa-exclamation-circle"></i> 驻: ${data.assignedTo}
                            </div>` : ''}
                    </div>`;
                    
                    if (change.type === "added") {
                        addCard(html);
                        // 住   专
                        if((Date.now() - (data.createdAt?.seconds*1000)) < 10000) window.parent.triggerAlert('knock', '住 砖 转拽');
                    }
                }
            });
        });

        // 驻拽爪转 专专 ( 拽)
        window.openInquiry = async (orderId, orderNum) => {
            const { value: form } = await Swal.fire({
                title: `专专 住 ${orderNum}`,
                html: `<input id="swal-text" class="w-full p-2 border rounded" placeholder=" 拽?">
                       <select id="swal-target" class="w-full p-2 mt-2 bg-gray-50 border rounded"><option>爪拽</option><option>转专</option></select>`,
                showCancelButton: true,
                confirmButtonText: '砖',
                confirmButtonColor: '#ef4444',
                preConfirm: () => ({ text: document.getElementById('swal-text').value, target: document.getElementById('swal-target').value })
            });

            if(form) {
                await updateDoc(doc(db, "orders", orderId), {
                    status: 'urgent_attention',
                    assignedTo: form.target,
                    chat: arrayUnion({ sender: '专', text: form.text, time: new Date().toISOString() })
                });
            }
        };
        
        window.sendTeamMsg = async () => {}; // Placeholder
    </script>
</body>
</html>
