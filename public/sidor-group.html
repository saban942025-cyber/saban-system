<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>拽爪转 住专</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: transparent; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #chat-feed { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; gap: 8px; }
        
        .bubble { max-width: 75%; padding: 8px 12px; border-radius: 8px; position: relative; font-size: 14px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .bubble.in { background: white; align-self: flex-start; border-top-right-radius: 0; }
        .bubble.out { background: #d9fdd3; align-self: flex-end; border-top-left-radius: 0; }
        .bubble.sys { background: #fff5c4; align-self: center; font-size: 12px; text-align: center; max-width: 90%; }
        
        .timestamp { font-size: 10px; color: #999; text-align: left; margin-top: 4px; }
    </style>
</head>
<body>
    <div id="chat-feed">
        <div class="bubble sys">
             注转 拽爪  爪驻转.<br>专  " 住专 住.
        </div>
    </div>

    <div class="bg-[#f0f2f5] p-3 flex items-center gap-2">
        <button class="text-gray-500 p-2"><i class="fas fa-plus"></i></button>
        <input type="text" placeholder="拽 注..." class="flex-1 p-2 rounded-lg border-none outline-none">
        <button class="text-green-600 p-2"><i class="fas fa-paper-plane"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        function addMsg(html, type) {
            const div = document.createElement('div');
            div.className = `bubble ${type}`;
            div.innerHTML = html;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        //  转 注专转 -   专
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(10)), (snap) => {
            snap.docChanges().forEach(change => {
                const data = change.doc.data();
                
                // 1. 住驻 专砖 (注 砖)
                if (change.type === "added") {
                    const isUrgent = data.itemsText?.includes('祝') || data.urgent;
                    const icon = isUrgent ? '' : '';
                    
                    addMsg(`
                        <div class="font-bold text-blue-600 text-xs">${icon}  #${data.orderNum}</div>
                        <div class="font-bold">${data.clientName}</div>
                        <div class="text-sm">${data.itemsText}</div>
                        <div class="timestamp">${new Date(data.createdAt?.seconds*1000 || Date.now()).toLocaleTimeString().slice(0,5)}</div>
                    `, 'in');
                }

                // 2.  砖 拽专 (MODIFIED) -  驻注 转 注拽
                if (change.type === "modified") {
                    
                    // 转专砖:  住  "驻 ""
                    if (data.status === 'urgent_attention') {
                        // 拽:   专 ? (驻砖专 住祝 拽转 ID)
                        // 砖转 驻拽  (index.html) 驻注 爪驻爪祝
                        if(window.parent && window.parent.triggerUrgentAlert) {
                            window.parent.triggerUrgentAlert(`转砖转 ! 砖 驻 #${data.orderNum}  砖专!`);
                        }
                    }

                    // 转专砖: 住 转拽  (砖专 专拽)
                    if (data.pdfUrl && !document.getElementById(`pdf-${change.doc.id}`)) {
                        addMsg(`
                            <div class="font-bold text-green-700"> 住 拽 !</div>
                            <div class="text-xs">转: ${data.emailSender || '注专转'}</div>
                            <a href="${data.pdfUrl}" target="_blank" id="pdf-${change.doc.id}" class="text-blue-600 underline text-xs mt-1 block">驻转 住 PDF</a>
                        `, 'sys');
                        
                        // 爪 "爪" 注
                        new Audio('https://assets.mixkit.co/active_storage/sfx/1111/1111-preview.m4a').play().catch(()=>{});
                    }
                }
            });
        });
    </script>
</body>
</html>
