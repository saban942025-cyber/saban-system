<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sidor Group AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: transparent; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 12px; border: 1px solid #e2e8f0; position: relative; }
        .card-transfer { border-right: 4px solid #f97316; background: #fff7ed; } /* 注爪 注专 */
        .status-pill { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
    
    <div class="bg-white p-3 border-b flex justify-between items-center shadow-sm sticky top-0 z-10">
        <div class="text-xs font-bold text-gray-500">驻 爪注</div>
        
        <button onclick="createRealTransfer()" class="bg-orange-100 text-orange-700 px-3 py-1 rounded text-xs font-bold hover:bg-orange-200 border border-orange-200 shadow-sm flex items-center gap-1">
            <i class="fas fa-dolly"></i> 爪专 注专: 专砖->转
        </button>
    </div>

    <div id="chat-feed"><div class="text-center text-xs text-gray-400 mt-4">-- 注 --</div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        //  转
        onSnapshot(query(collection(db, "orders"), orderBy("lastUpdate", "desc"), limit(20)), (snap) => {
            if(snap.empty) { feed.innerHTML = '<div class="text-center text-xs mt-10"> 专注</div>'; return; }
            feed.innerHTML = ''; 
            
            snap.forEach(d => {
                const data = d.data();
                const isTransfer = data.type === 'transfer';
                
                let statusHtml = '';
                if(data.status === 'assigned') statusHtml = '<span class="status-pill bg-blue-100 text-blue-700">转 </span>';
                if(data.status === 'on_route') statusHtml = '<span class="status-pill bg-yellow-100 text-yellow-700 animate-pulse">住注</span>';
                if(data.status === 'arrived') statusHtml = '<span class="status-pill bg-purple-100 text-purple-700">驻专拽</span>';
                if(data.status === 'done') statusHtml = '<span class="status-pill bg-green-100 text-green-700">砖</span>';

                const html = `
                <div class="card ${isTransfer ? 'card-transfer' : ''} mb-2">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span class="font-bold uppercase">${isTransfer ? ' 注专' : ' '}</span>
                        <span>${new Date(data.lastUpdate?.seconds*1000).toLocaleTimeString().slice(0,5)}</span>
                    </div>
                    <div class="font-bold text-sm text-slate-800">${data.clientName}</div>
                    <div class="text-xs text-gray-600 mt-1 truncate">${data.itemsText}</div>
                    <div class="mt-2 flex justify-between items-center">
                        <div class="text-xs font-bold text-slate-500"><i class="fas fa-truck"></i> ${data.driver || '?'}</div>
                        ${statusHtml}
                    </div>
                </div>`;
                feed.innerHTML += html;
            });
        });

        // 爪专转 砖转 转
        window.createRealTransfer = async () => {
            const { isConfirmed } = await Swal.fire({
                title: '砖专 砖 注?',
                text: '注专 住祝 专砖 10 住祝 转',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '砖专 注砖 ',
                confirmButtonColor: '#f97316'
            });

            if (isConfirmed) {
                await addDoc(collection(db, "orders"), {
                    driver: '注', // 砖 砖专转 注
                    clientName: "住祝 转",
                    clientPhone: "0500000000",
                    address: "转 6,  砖专",
                    itemsText: " 注专 驻:\n- 4 砖 拽 10\n- 2 转 ",
                    status: "assigned", //  拽驻抓 转 砖 爪 
                    type: "transfer",
                    orderNum: "TR-" + Math.floor(Math.random()*1000),
                    createdAt: serverTimestamp(),
                    lastUpdate: serverTimestamp(),
                    chat: []
                });
                Swal.fire('砖专!', '砖 砖 注', 'success');
            }
        };
    </script>
</body>
</html>
