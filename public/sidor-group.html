<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sidor Group AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: transparent; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        /* ×›×¨×˜×™×¡×™× */
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 12px; border: 1px solid #e2e8f0; position: relative; transition: 0.3s; }
        
        /* ××¦×‘×™ ×›×¨×˜×™×¡ */
        .card-new { border-right: 4px solid #3b82f6; }
        .card-approved { border-right: 4px solid #22c55e; background: #f0fdf4; opacity: 0.9; }
        
        /* ×”×ª×™×§×•×Ÿ: ×× ×™××¦×™×” ×—×–×§×” ×œ×”×•×“×¢×•×ª ×œ×§×•×— */
        .card-client-msg { 
            border-right: 4px solid #f97316; 
            background: #fff7ed; 
            animation: flash-border 1.5s infinite alternate;
        }
        
        @keyframes flash-border { 
            0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.2); border-color: #fdba74; } 
            100% { box-shadow: 0 0 15px rgba(249, 115, 22, 0.6); border-color: #f97316; transform: scale(1.01); } 
        }

        .btn-action { font-size: 11px; padding: 5px 10px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    </style>
</head>
<body>
    
    <div class="bg-white p-3 border-b flex justify-between items-center shadow-sm sticky top-0 z-20">
        <div class="text-xs font-bold text-gray-500 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ×¤×™×“ ××‘×¦×¢×™ ×—×™
        </div>
        <button onclick="manualLink()" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded text-xs font-bold hover:bg-indigo-100">
            <i class="fas fa-link"></i> ×©×™×“×•×š ×™×“× ×™
        </button>
    </div>

    <div id="chat-feed">
        <div class="text-center text-xs text-gray-400 mt-10">
            <i class="fas fa-circle-notch fa-spin"></i> ×˜×•×¢×Ÿ × ×ª×•× ×™×...
        </div>
    </div>

    <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t border-gray-300 z-20">
        <button onclick="window.parent.triggerAlert('buzzer', '×‘×“×™×§×”')" class="text-white bg-red-500 w-10 h-10 rounded-full shadow-md flex items-center justify-center active:scale-95"><i class="fas fa-bullhorn"></i></button>
        <input type="text" id="team-input" placeholder="×”×•×“×¢×” ×œ×¦×•×•×ª..." class="flex-1 p-3 rounded-xl border-none outline-none text-sm shadow-sm">
        <button onclick="sendTeamMsg()" class="text-[#008069] p-2 hover:bg-gray-200 rounded-full"><i class="fas fa-paper-plane text-xl"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, updateDoc, doc, arrayUnion, getDocs, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        // ××©×ª× ×” ×œ×× ×™×¢×ª ×¦×œ×¦×•×œ×™× ×‘×˜×¢×™× ×” ×¨××©×•× ×™×ª
        let isInitialLoad = true;

        // --- ×”×œ×‘ ×©×œ ×”××¢×¨×›×ª: ×”××–× ×” ×‘×–××Ÿ ×××ª ---
        // ××™×•×Ÿ ×œ×¤×™ lastUpdate ××‘×˜×™×— ×©×”×”×•×“×¢×” ×”××—×¨×•× ×” ×ª×§×¤×™×¥ ××ª ×”×”×–×× ×” ×œ××¢×œ×”
        const q = query(collection(db, "orders"), orderBy("lastUpdate", "desc"), limit(50));

        onSnapshot(q, (snap) => {
            if(snap.empty) { 
                feed.innerHTML = '<div class="text-center text-xs mt-10 text-gray-400">××™×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</div>'; 
                return; 
            }
            
            // ×‘×“×™×§×ª ×©×™× ×•×™×™× ×œ×¦×•×¨×š ×¡××•× ×“
            if (!isInitialLoad) {
                snap.docChanges().forEach(change => {
                    const data = change.doc.data();
                    // ×× ×™×© ×¢×“×›×•×Ÿ ×•×”×¡×˜×˜×•×¡ ×”×•× "×‘×§×©×ª ×©×™× ×•×™" (×”×•×“×¢×ª ×œ×§×•×—)
                    if (change.type === 'modified' && data.status === 'changes_requested') {
                        // ×¦×œ×¦×•×œ + ×¨×˜×˜ ×—×–×§
                        window.parent.triggerAlert('buzzer', `×”×•×“×¢×” ×${data.clientName}`);
                        console.log("ğŸ”” ×”×ª×¨××” ×”×•×¤×¢×œ×” ×¢×‘×•×¨:", data.clientName);
                    }
                    // ×× ×–×• ×”×–×× ×” ×—×“×©×” ×œ×’××¨×™
                    if (change.type === 'added' && data.status === 'new') {
                        window.parent.triggerAlert('knock', '×”×–×× ×” ×—×“×©×”!');
                    }
                });
            }

            // ×¨×™× ×“×•×¨ ××—×“×© ×©×œ ×›×œ ×”×¨×©×™××” (×›×“×™ ×œ×©××•×¨ ×¢×œ ×”×¡×“×¨ ×”× ×›×•×Ÿ)
            feed.innerHTML = ''; 
            
            snap.forEach(d => {
                const data = d.data();
                const id = d.id;
                
                // ×§×‘×™×¢×ª ×¢×™×¦×•×‘ ×”×›×¨×˜×™×¡
                let cardClass = 'card';
                let statusIcon = 'ğŸŸ¢';
                
                if (data.status === 'changes_requested') {
                    cardClass += ' card-client-msg'; // ×”×‘×”×•×‘ ×›×ª×•×
                    statusIcon = 'ğŸŸ  ×”×•×“×¢×”!';
                } else if (data.status === 'new') {
                    cardClass += ' card-new';
                    statusIcon = 'ğŸ”µ ×—×“×©';
                } else if (data.status === 'approved') {
                    cardClass += ' card-approved';
                    statusIcon = 'âœ… ×××•×©×¨';
                }

                // ×©×œ×™×¤×ª ×”×”×•×“×¢×” ×”××—×¨×•× ×”
                const lastMsg = data.chat && data.chat.length > 0 ? data.chat[data.chat.length - 1] : { text: '' };
                const timeStr = data.lastUpdate ? new Date(data.lastUpdate.seconds * 1000).toLocaleTimeString().slice(0,5) : '';

                const html = `
                <div class="${cardClass}" id="card-${id}">
                    <div class="flex justify-between text-[10px] text-gray-500 mb-1 font-bold uppercase tracking-wide">
                        <span>${statusIcon}</span>
                        <span>${timeStr}</span>
                    </div>
                    
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-black text-sm text-slate-800">#${data.orderNum} | ${data.clientName}</div>
                            <div class="text-xs text-gray-600 mt-1 line-clamp-1">${data.itemsText}</div>
                        </div>
                    </div>

                    ${data.status === 'changes_requested' ? `
                        <div class="mt-2 bg-orange-100 p-2 rounded border border-orange-200">
                            <div class="text-[10px] text-orange-800 font-bold mb-1 flex items-center gap-1">
                                <i class="fas fa-comment-dots"></i> ×”×œ×§×•×— ×›×ª×‘:
                            </div>
                            <div class="text-sm font-bold text-gray-900">"${lastMsg.text}"</div>
                        </div>
                        
                        <div class="flex gap-2 mt-3">
                            <button onclick="reply('${id}')" class="btn-action bg-white border border-orange-300 text-orange-700 hover:bg-orange-50 flex-1">
                                <i class="fas fa-reply"></i> ×”×©×‘
                            </button>
                            <button onclick="markOK('${id}')" class="btn-action bg-green-600 text-white hover:bg-green-700 flex-1 shadow">
                                <i class="fas fa-check"></i> ×˜×•×¤×œ / × ×§×”
                            </button>
                        </div>
                    ` : ''}

                    ${(data.status === 'approved' || data.status === 'assigned') ? `
                        <div class="mt-3 pt-2 border-t flex justify-between items-center">
                            <span class="text-xs text-green-700 font-bold">
                                ${data.driver ? `<i class="fas fa-truck"></i> ××¦×œ ${data.driver}` : '××•×›×Ÿ ×œ×©×™×’×•×¨'}
                            </span>
                            <button onclick="dispatchDriver('${id}', '${data.clientName}')" class="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold shadow hover:bg-black">
                                ${data.driver ? '×©× ×” × ×”×’' : 'ğŸšš ×”×–× ×§ × ×”×’'}
                            </button>
                        </div>
                    ` : ''}
                </div>`;
                
                feed.innerHTML += html;
            });

            isInitialLoad = false;
        });

        // --- ×¤×¢×•×œ×•×ª ---
        window.dispatchDriver = async (id, client) => {
            const { value: driver } = await Swal.fire({
                title: '×”×–× ×§×ª × ×”×’',
                text: `×¢×‘×•×¨: ${client}`,
                input: 'select',
                inputOptions: {'×¢×œ×™':'×¢×œ×™','×—×›××ª':'×—×›××ª','×¡×œ×××Ÿ':'×¡×œ×××Ÿ'},
                inputPlaceholder: '×‘×—×¨ × ×”×’...',
                confirmButtonText: '×©×“×¨ ×œ××¡×š ×”× ×”×’ ğŸš€'
            });
            if(driver) {
                await updateDoc(doc(db, "orders", id), { driver: driver, status: 'assigned', dispatchedAt: new Date(), lastUpdate: new Date() });
                Swal.fire('×©×•×“×¨!', `×”××©×™××” ××¦×œ ${driver}`, 'success');
            }
        };

        window.reply = async (id) => {
            const { value: text } = await Swal.fire({ input: 'text', title: '×ª×©×•×‘×” ×œ×œ×§×•×—', confirmButtonText: '×©×œ×—' });
            if(text) {
                await updateDoc(doc(db, "orders", id), {
                    chat: arrayUnion({ sender: '×¨×××™', text: text, time: new Date().toISOString() }),
                    status: 'waiting_approval', // ×× ×§×” ××ª ×”×”×ª×¨××”
                    lastUpdate: new Date()
                });
            }
        };

        window.markOK = async (id) => { 
            await updateDoc(doc(db, "orders", id), { status: 'waiting_approval', lastUpdate: new Date() }); 
        };

        // --- ×©×™×“×•×š ×™×“× ×™ ---
        window.manualLink = async () => {
            const { value: form } = await Swal.fire({
                title: '×©×™×“×•×š ××¡××š',
                html: `<input id="swal-order" class="swal2-input" placeholder="××¡' ×”×–×× ×” (×œ××©×œ 888)">
                       <input id="swal-url" class="swal2-input" placeholder="×œ×™× ×§ ×œ××¡××š">`,
                preConfirm: () => [document.getElementById('swal-order').value, document.getElementById('swal-url').value]
            });
            if (form) {
                // ×—×™×¤×•×© ×”×–×× ×” (×œ×¤×™ ××¡×¤×¨ ××• ID - ×›××Ÿ ×”× ×—× ×• ×©×”××¡×¤×¨ ×”×•× ×©×“×” orderNum)
                const q = query(collection(db, "orders"), where("orderNum", "==", form[0]));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const docId = snap.docs[0].id;
                    await updateDoc(doc(db, "orders", docId), { pdfUrl: form[1], status: 'waiting_approval', lastUpdate: new Date() });
                    Swal.fire('×‘×•×¦×¢', '×”××¡××š ×©×•×“×š ×‘×”×¦×œ×—×”', 'success');
                } else {
                    Swal.fire('×©×’×™××”', '×œ× × ××¦××” ×”×–×× ×” ×¢× ×”××¡×¤×¨ ×”×–×”', 'error');
                }
            }
        };
        
        window.sendTeamMsg = async () => {}; 
    </script>
</body>
</html>
