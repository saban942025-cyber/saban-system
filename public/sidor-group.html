<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>拽爪转 住专</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #efeae2; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .chat-bg { background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); opacity: 0.1; position: absolute; inset: 0; pointer-events: none; }
        
        .msg-bubble { 
            background: white; padding: 8px 12px; border-radius: 8px; margin-bottom: 10px; 
            max-width: 80%; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .msg-sys { background: #fff5c4; align-self: center; font-size: 12px; text-align: center; }
        .msg-transfer { background: #d9fdd3; align-self: flex-start; } /* 专拽 砖 住驻 */
        .msg-order { background: #ffffff; align-self: flex-start; }
        
        .timestamp { font-size: 10px; color: #999; text-align: left; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="chat-bg"></div>
    
    <div class="bg-[#008069] text-white p-3 flex items-center gap-3 shadow z-10">
        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i class="fas fa-users"></i></div>
        <div>
            <div class="font-bold">住专 住 - 专  </div>
            <div class="text-xs opacity-80">专, 爪拽, , 转, 注...</div>
        </div>
    </div>

    <div id="chat-feed" class="flex-1 overflow-y-auto p-4 flex flex-col z-10">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        // 驻拽爪 住驻转 注
        function addMsg(html, type) {
            const div = document.createElement('div');
            div.className = `msg-bubble ${type}`;
            div.innerHTML = html;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        //  转 砖转
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(5)), (snap) => {
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const o = change.doc.data();
                    addMsg(`
                        <div class="font-bold text-blue-600 text-xs"> 砖 #${o.orderNum}</div>
                        <div>${o.clientName}</div>
                        <div class="text-sm text-gray-600">${o.itemsText?.slice(0,50)}...</div>
                        ${o.pdfUrl ? '<div class="mt-1 text-green-600 text-xs"><i class="fas fa-file-pdf"></i> 住 拽</div>' : ''}
                        <div class="timestamp">${new Date(o.createdAt?.seconds*1000).toLocaleTimeString().slice(0,5)}</div>
                    `, 'msg-order');
                }
            });
        });

        //  注专转
        onSnapshot(query(collection(db, "transfers"), orderBy("createdAt", "desc"), limit(5)), (snap) => {
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const t = change.doc.data();
                    addMsg(`
                        <div class="font-bold text-green-700 text-xs"> 注专  住驻</div>
                        <div>${t.fromBranch} -> ${t.toBranch}</div>
                        <div class="text-xs bg-white/50 p-1 rounded mt-1">${t.items}</div>
                        <div class="text-[10px] text-gray-500 mt-1">: 注</div>
                        <div class="timestamp">${new Date(t.createdAt?.seconds*1000).toLocaleTimeString().slice(0,5)}</div>
                    `, 'msg-transfer');
                }
                if (change.type === "modified") {
                    const t = change.doc.data();
                    if(t.status === 'waiting_approval') {
                        addMsg(`
                            <div class="font-bold text-xs"> 转拽 住 注专</div>
                            <div class="text-xs">转: ${t.emailSender || '注专转'}</div>
                            <a href="${t.pdfUrl}" target="_blank" class="text-blue-600 underline text-xs">驻转 转注</a>
                        `, 'msg-sys');
                    }
                }
            });
        });
    </script>
</body>
</html>
