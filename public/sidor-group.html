<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sidor Group AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: transparent; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #chat-feed { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; gap: 12px; }
        
        .bubble { max-width: 90%; padding: 12px; border-radius: 12px; position: relative; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; background: white; align-self: flex-start; }
        
        /* ×¢×™×¦×•×‘×™× ××™×•×—×“×™× */
        .bubble.urgent { border-right: 4px solid #ef4444; background: #fef2f2; }
        .bubble.approved { border-right: 4px solid #22c55e; background: #f0fdf4; }
        
        .action-btn { font-size: 11px; padding: 4px 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .btn-check { background: #fee2e2; color: #b91c1c; }
        .btn-check:hover { background: #fecaca; }
        
        .timestamp { font-size: 10px; color: #9ca3af; margin-top: 4px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div id="chat-feed">
        <div class="text-center text-xs text-gray-400 my-4">-- ×¨×¢× ×•×Ÿ × ×ª×•× ×™× ×—×™ --</div>
    </div>

    <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t border-gray-300">
        <button onclick="openBuzzerMenu()" class="text-white bg-red-500 w-10 h-10 rounded-full shadow-md active:scale-95 transition flex items-center justify-center">
            <i class="fas fa-bullhorn"></i>
        </button>
        <input type="text" id="team-input" placeholder="×”×•×“×¢×” ×œ×¦×•×•×ª..." class="flex-1 p-3 rounded-xl border-none outline-none text-sm shadow-sm" onkeydown="if(event.key==='Enter') sendTeamMsg()">
        <button onclick="sendTeamMsg()" class="text-[#008069] p-2 hover:bg-gray-200 rounded-full"><i class="fas fa-paper-plane text-xl"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, updateDoc, doc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        function addMsg(html, type) {
            const div = document.createElement('div');
            div.className = `bubble ${type}`;
            div.innerHTML = html;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        // --- ×¤×•× ×§×¦×™×” ×œ×¤×ª×™×—×ª ×‘×™×¨×•×¨ (×¨×××™ -> ××™×¦×™×§) ---
        window.openInquiry = async (orderId, orderNum) => {
            const { value: form } = await Swal.fire({
                title: `ğŸš¨ ×‘×™×¨×•×¨ ×œ×”×–×× ×” ${orderNum}`,
                html: `
                    <label class="block text-right text-xs font-bold mb-1">×œ××™ ×œ×”×¤× ×•×ª?</label>
                    <select id="swal-target" class="w-full p-2 border rounded mb-3 bg-gray-50">
                        <option value="××™×¦×™×§">××™×¦×™×§</option>
                        <option value="×ª××™×¨">×ª××™×¨</option>
                        <option value="×¢×œ×™">×¢×œ×™</option>
                    </select>
                    <label class="block text-right text-xs font-bold mb-1">××” ×”×‘×¢×™×”/×©××œ×”?</label>
                    <input id="swal-text" class="w-full p-2 border rounded" placeholder="×œ××©×œ: ×œ×‘×“×•×§ ×›××•×ª ××œ×˜...">
                `,
                confirmButtonText: '×¤×ª×— ××©×™××” ×•××“×•×“ ×–××Ÿ',
                confirmButtonColor: '#ef4444',
                showCancelButton: true,
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        target: document.getElementById('swal-target').value,
                        text: document.getElementById('swal-text').value
                    }
                }
            });

            if (form) {
                // ×¢×“×›×•×Ÿ ×”××¡××š ×‘×¤×™×™×¨×‘×™×™×¡
                await updateDoc(doc(db, "orders", orderId), {
                    status: 'urgent_attention', // ×”×•×¤×š ××ª ×”×›×¨×˜×™×¡ ×œ××“×•×
                    assignedTo: form.target,
                    inquiryStart: new Date().getTime(), // ×”×ª×—×œ×ª ××“×™×“×”
                    chat: arrayUnion({
                        sender: '×¨×××™',
                        text: `@${form.target} ${form.text}`,
                        type: 'alert',
                        time: new Date().toISOString()
                    })
                });
                
                // ×”×•×“×¢×” ××§×•××™×ª (×”×¦×•×¤×¨ ×™×•×¤×¢×œ ×“×¨×š ×”-Snapshot)
            }
        };

        // --- ×”××–× ×” ×œ×”×–×× ×•×ª (Live Feed) ---
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(20)), (snap) => {
            snap.docChanges().forEach(change => {
                const data = change.doc.data();
                const id = change.doc.id;
                const isUrgent = data.status === 'urgent_attention';
                const isApproved = data.status === 'approved';
                
                // ×—×™×©×•×‘ ×–××Ÿ ××“×™×“×” (×× ×™×©)
                let timerHtml = '';
                if(isUrgent && data.inquiryStart) {
                    const elapsed = Math.floor((new Date().getTime() - data.inquiryStart) / 60000); // ×“×§×•×ª
                    timerHtml = `<span class="text-red-600 font-bold animate-pulse">â±ï¸ ×¤×ª×•×— ×›×‘×¨ ${elapsed} ×“×§'</span>`;
                }
                
                // ×›×¤×ª×•×¨ ××¡××š
                const docBtn = data.pdfUrl ? `<button onclick="window.open('${data.pdfUrl}')" class="text-blue-600 hover:underline"><i class="fas fa-file-pdf"></i> ×”×¦×’ ×ª×¢×•×“×”</button>` : '';

                if (change.type === "added" || change.type === "modified") {
                    // ×‘× ×™×™×ª ×”-HTML ×©×œ ×”×›×¨×˜×™×¡
                    const html = `
                        <div class="flex justify-between items-start mb-1">
                            <div>
                                <span class="font-bold text-gray-800">#${data.orderNum}</span>
                                <span class="text-xs text-gray-500"> | ${data.clientName}</span>
                            </div>
                            <div class="text-xs">${timerHtml || data.supplyTime || ''}</div>
                        </div>
                        
                        <div class="text-sm text-gray-700 mb-2">${data.itemsText}</div>
                        
                        ${data.chat && data.chat.length ? `
                            <div class="bg-gray-50 p-2 rounded text-xs text-gray-600 mb-2 border border-gray-100">
                                ${data.chat.map(m => `<div><b>${m.sender}:</b> ${m.text}</div>`).join('')}
                            </div>
                        ` : ''}

                        <div class="flex justify-between items-center border-t pt-2 mt-1">
                            <div class="flex gap-3 text-xs">
                                ${docBtn}
                                <button onclick="window.parent.loadPage('client-final.html?uid=${data.clientId}&name=${data.clientName}', '××‘×˜ ×œ×§×•×—', null)" class="text-gray-500 hover:text-black"><i class="fas fa-eye"></i> ×”×œ×§×•×—</button>
                            </div>
                            
                            ${!isUrgent && !isApproved ? `
                                <button onclick="openInquiry('${id}', '${data.orderNum}')" class="action-btn btn-check">
                                    ğŸš¨ ×¤×ª×— ×‘×™×¨×•×¨
                                </button>
                            ` : ''}
                            
                            ${isUrgent ? `<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded font-bold">×‘×˜×™×¤×•×œ ${data.assignedTo || ''}</span>` : ''}
                            ${isApproved ? `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded font-bold">âœ… ×××•×©×¨</span>` : ''}
                        </div>
                    `;

                    // ×”×•×¡×¤×” ×œ××¡×š
                    // ×”×¢×¨×”: ×‘×’×¨×¡×” ×¤×©×•×˜×” ×–×• ×× ×—× ×• ××•×¡×™×¤×™× ×”×•×“×¢×•×ª ×—×“×©×•×ª ×œ××˜×”. 
                    // ×‘××¢×¨×›×ª ××œ××” ×”×™×™× ×• ××¢×“×›× ×™× ××ª ×”-DOM ×”×§×™×™× ×× ×–×” Modified.
                    if(change.type === "added") {
                        addMsg(html, isUrgent ? 'urgent' : (isApproved ? 'approved' : ''));
                        // ×¡××•× ×“ ×¨×§ ×œ×—×“×©×•×ª ×××©
                        if((Date.now() - (data.createdAt?.seconds*1000)) < 10000) window.parent.triggerAlert('knock', '×”×–×× ×” ×—×“×©×”');
                    } else if (change.type === "modified") {
                        // ×× ×–×” ×”×¤×š ×œ×“×—×•×£ ×¢×›×©×™×• - ×¦×•×¤×¨!
                        if(isUrgent) window.parent.triggerAlert('buzzer', `××©×™××” ×“×—×•×¤×” ×œ${data.assignedTo}`);
                        // ××•×¡×™×£ ××ª ×”×¢×“×›×•×Ÿ ×œ××˜×” ×›×”×•×“×¢×” ×—×“×©×” ×›×“×™ ×©×¨×××™ ×™×¨××”
                        addMsg(html, isUrgent ? 'urgent' : '');
                    }
                }
            });
        });

        // --- ×¦×•×¤×¨ ×›×œ×œ×™ (×›××• ×§×•×“×) ---
        window.openBuzzerMenu = async () => { /* ... ×”×§×•×“ ×”×§×™×™× ... */ };
        window.sendTeamMsg = async () => { /* ... ×”×§×•×“ ×”×§×™×™× ... */ };
    </script>
</body>
</html>
