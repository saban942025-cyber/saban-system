<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sidor Group AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: transparent; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #chat-feed { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; gap: 10px; }
        
        .bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; position: relative; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble.in { background: white; align-self: flex-start; border-top-right-radius: 0; }
        
        /* ×¢×™×¦×•×‘ ××™×•×—×“ ×œ×¦×•×¤×¨ */
        .bubble.buzzer { 
            background: #fef2f2; border: 1px solid #fca5a5; border-right: 4px solid #ef4444; 
            align-self: flex-start; width: 100%;
            animation: shake 0.5s;
        }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

        .timestamp { font-size: 10px; color: #999; text-align: left; margin-top: 4px; }
    </style>
</head>
<body>
    <div id="chat-feed">
        <div class="text-center text-xs text-gray-400 my-4">-- ×”×™×•× --</div>
    </div>

    <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t border-gray-300">
        <button onclick="openBuzzerMenu()" class="text-white bg-red-500 w-10 h-10 rounded-full shadow-md active:scale-95 transition flex items-center justify-center">
            <i class="fas fa-bullhorn"></i>
        </button>
        
        <input type="text" id="team-input" placeholder="×”×•×“×¢×” ×¨×’×™×œ×”..." class="flex-1 p-3 rounded-xl border-none outline-none text-sm shadow-sm" onkeydown="if(event.key==='Enter') sendTeamMsg()">
        
        <button onclick="sendTeamMsg()" class="text-[#008069] p-2 hover:bg-gray-200 rounded-full">
            <i class="fas fa-paper-plane text-xl"></i>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        // ×”×•×¡×¤×ª ×”×•×“×¢×” ×œ××¡×š
        function addMsg(html, type) {
            const div = document.createElement('div');
            div.className = `bubble in ${type}`;
            div.innerHTML = html;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        // --- ×¤×•× ×§×¦×™×™×ª ×”×¦×•×¤×¨ (Buzzer) ---
        window.openBuzzerMenu = async () => {
            const { value: formValues } = await Swal.fire({
                title: 'ğŸ“¢ ×©×œ×™×—×ª ×¦×•×¤×¨ ×œ×¦×•×•×ª',
                html: `
                    <label class="block text-right text-xs font-bold mb-1 text-gray-500">×œ××™ ×œ×©×œ×•×—?</label>
                    <select id="buzzer-target" class="w-full p-2 border rounded mb-3 bg-gray-50">
                        <option value="all">ğŸ“£ ×œ×›×•×œ× (×›×œ×œ×™)</option>
                        <option value="×¢×œ×™">ğŸš› ×¢×œ×™ (× ×”×’)</option>
                        <option value="×—×›××ª">ğŸ—ï¸ ×—×›××ª (×× ×•×£)</option>
                        <option value="×ª××™×¨">ğŸ­ ×ª××™×¨ (××—×¡×Ÿ)</option>
                        <option value="×¨×××™">ğŸ‘® ×¨×××™ (×× ×”×œ)</option>
                    </select>
                    <label class="block text-right text-xs font-bold mb-1 text-gray-500">××¡×¨ ×“×—×•×£</label>
                    <input id="buzzer-text" class="w-full p-2 border rounded" placeholder="×œ××©×œ: ×œ×—×–×•×¨ ×œ××—×¡×Ÿ ×“×—×•×£!">
                `,
                confirmButtonText: '×”×¤×¢×œ ×¦×•×¤×¨',
                confirmButtonColor: '#ef4444',
                showCancelButton: true,
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('buzzer-target').value,
                        document.getElementById('buzzer-text').value
                    ]
                }
            });

            if (formValues) {
                const [target, text] = formValues;
                if(!text) return;

                // ×©×œ×™×—×” ×œ×¤×™×™×¨×‘×™×™×¡ ×›×”×•×“×¢×” ××™×•×—×“×ª
                await addDoc(collection(db, "team_chat"), {
                    sender: '×¨×××™', // ××¤×©×¨ ×œ×©×œ×•×£ ×“×™× ××™×ª
                    text: text,
                    type: 'buzzer', // ×¡×•×’ ××™×•×—×“
                    target: target,
                    createdAt: serverTimestamp()
                });
            }
        };

        // ×©×œ×™×—×ª ×”×•×“×¢×” ×¨×’×™×œ×”
        window.sendTeamMsg = async () => {
            const input = document.getElementById('team-input');
            if(input.value) {
                await addDoc(collection(db, "team_chat"), {
                    sender: '×¨×××™',
                    text: input.value,
                    type: 'text',
                    target: 'all',
                    createdAt: serverTimestamp()
                });
                input.value = '';
            }
        };

        // --- ×”××–× ×” ×œ×”×•×“×¢×•×ª ×¦×•×•×ª (×›×•×œ×œ ×¦×•×¤×¨×™×) ---
        onSnapshot(query(collection(db, "team_chat"), orderBy("createdAt", "desc"), limit(10)), (snap) => {
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    
                    // ×‘×“×™×§×” ×× ×”×”×•×“×¢×” ×˜×¨×™×™×” (×-10 ×©× ×™×•×ª ×”××—×¨×•× ×•×ª) ×›×“×™ ×œ× ×œ×¦×¤×¦×£ ×¢×œ ×”×™×¡×˜×•×¨×™×”
                    const isFresh = (Date.now() - (data.createdAt?.seconds * 1000 || 0)) < 10000;

                    if (data.type === 'buzzer') {
                        // ×”×¦×’×ª ×”×¦×•×¤×¨ ×‘×¦'××˜
                        addMsg(`
                            <div class="flex items-center gap-2 text-red-600 font-bold mb-1">
                                <i class="fas fa-bullhorn animate-pulse"></i> ×¦×•×¤×¨ ×œ: ${data.target}
                            </div>
                            <div class="text-lg font-black text-gray-800">${data.text}</div>
                            <div class="text-xs text-red-400 mt-1">× ×©×œ×— ×¢"×™ ${data.sender}</div>
                        `, 'buzzer');

                        // ×”×¤×¢×œ×ª ×”××–×¢×§×” ××¦×œ ×”××©×ª××© (×× ×–×” ×˜×¨×™)
                        if (isFresh && window.parent.triggerAlert) {
                            window.parent.triggerAlert('buzzer', `×¦×•×¤×¨ ×${data.sender}: ${data.text}`);
                        }
                    } else {
                        // ×”×•×“×¢×” ×¨×’×™×œ×”
                        addMsg(`
                            <div class="text-xs font-bold text-blue-600 mb-1">${data.sender}</div>
                            <div>${data.text}</div>
                        `, '');
                        
                        // ×”×©××¢×ª "× ×§×™×©×” ×¢×“×™× ×”" (×× ×–×” ×˜×¨×™)
                        if (isFresh && window.parent.triggerAlert) {
                            window.parent.triggerAlert('knock', '×”×•×“×¢×” ×—×“×©×” ×‘×¦×•×•×ª');
                        }
                    }
                }
            });
        });
        
        // (×”×©××¨×ª×™ ×›××Ÿ ××ª ×”×”××–× ×” ×œ×”×–×× ×•×ª ××”×§×•×“ ×”×§×•×“×, ×”×™× ×××©×™×›×” ×œ×¢×‘×•×“ ×‘××§×‘×™×œ)
        
    </script>
</body>
</html>
