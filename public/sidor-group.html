<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sidor Group AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: transparent; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #chat-feed { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        /* ×›×¨×˜×™×¡ ×‘×¡×™×¡×™ */
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 12px; border: 1px solid #e2e8f0; position: relative; transition: 0.3s; }
        
        /* ×¡×•×’×™ ×›×¨×˜×™×¡×™× */
        .card-new-order { border-right: 4px solid #3b82f6; } /* ×”×–×× ×” ×—×“×©×” - ×›×—×•×œ */
        .card-client-msg { border-right: 4px solid #f97316; background: #fff7ed; animation: pulse-orange 2s infinite; } /* ×”×•×“×¢×ª ×œ×§×•×— - ×›×ª×•× ××”×‘×”×‘ */
        .card-approved { border-right: 4px solid #22c55e; background: #f0fdf4; opacity: 0.8; } /* ×××•×©×¨ - ×™×¨×•×§ */

        .sender-row { display: flex; justify-content: space-between; font-size: 11px; color: #64748b; margin-bottom: 6px; }
        .content-text { font-weight: bold; color: #1e293b; font-size: 14px; }
        
        /* ×›×¤×ª×•×¨ ×©×™×“×•×š */
        .link-btn { background: #e0e7ff; color: #4338ca; font-weight: bold; font-size: 11px; padding: 5px 10px; border-radius: 6px; cursor: pointer; display: flex; items-center; gap: 5px; }

        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
    </style>
</head>
<body>
    
    <div class="bg-white p-3 border-b border-gray-200 flex justify-between items-center shadow-sm z-10">
        <div class="text-xs font-bold text-gray-500">×¤×™×“ ××‘×¦×¢×™</div>
        
        <button onclick="manualLink()" class="link-btn hover:bg-indigo-100">
            <i class="fas fa-link"></i> ×©×™×“×•×š ××¡××š ×œ×”×–×× ×”
        </button>
    </div>

    <div id="chat-feed">
        <div class="text-center text-xs text-gray-400 mt-4">-- ×”××¢×¨×›×ª ×××–×™× ×” --</div>
    </div>

    <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t border-gray-300">
        <button onclick="window.parent.triggerAlert('buzzer', '×‘×“×™×§×”')" class="text-white bg-red-500 w-10 h-10 rounded-full shadow-md flex items-center justify-center active:scale-95"><i class="fas fa-bullhorn"></i></button>
        <input type="text" id="team-input" placeholder="×”×•×“×¢×” ×œ×¦×•×•×ª..." class="flex-1 p-3 rounded-xl border-none outline-none text-sm shadow-sm">
        <button onclick="sendTeamMsg()" class="text-[#008069] p-2 hover:bg-gray-200 rounded-full"><i class="fas fa-paper-plane text-xl"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, onSnapshot, updateDoc, doc, arrayUnion, getDocs, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));
        const feed = document.getElementById('chat-feed');

        function addHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        // --- ×”××–× ×” ×—×›××” (×”×œ×™×‘×”) ---
        // ×× ×—× ×• ×××™×™× ×™× ×œ×¤×™ lastUpdate ×›×“×™ ×©×©×™× ×•×™×™× ×—×“×©×™× ×™×§×¤×¦×•, ×œ× ×¨×§ ×™×¦×™×¨×•×ª ×—×“×©×•×ª
        onSnapshot(query(collection(db, "orders"), orderBy("lastUpdate", "desc"), limit(20)), (snap) => {
            snap.docChanges().forEach(change => {
                const data = change.doc.data();
                const id = change.doc.id;
                
                // === ×ª×™×§×•×Ÿ ×”×¡××•× ×“: ××‘×—×Ÿ ×”×˜×¨×™×•×ª ===
                // ×‘×•×“×§×™×: ×”×× ×”××™×¨×•×¢ ×§×¨×” ×‘-15 ×©× ×™×•×ª ×”××—×¨×•× ×•×ª?
                // ×× ×›×Ÿ -> ××©××™×¢×™× ×¦×œ×™×œ. ×× ×œ× -> ×¨×§ ××¦×™×’×™× ×‘×©×§×˜ (×›×“×™ ×œ×× ×•×¢ ×¨×¢×© ×‘×˜×¢×™× ×”).
                const now = Date.now();
                const eventTime = data.lastUpdate ? data.lastUpdate.seconds * 1000 : now;
                const isFresh = (now - eventTime) < 15000; 

                if (isFresh) {
                    console.log("ğŸ”¥ ××™×¨×•×¢ ×˜×¨×™ ×–×•×”×”:", data.status);
                }

                // 1. ×ª×¨×—×™×©: ×”×•×“×¢×” ×—×“×©×” ××œ×§×•×— (×¢×“×™×¤×•×ª ×¢×œ×™×•× ×”)
                if (data.status === 'changes_requested') {
                    const lastMsg = data.chat && data.chat.length > 0 ? data.chat[data.chat.length - 1] : null;
                    
                    if (lastMsg && lastMsg.sender === 'client' && change.type === 'modified') {
                        const html = `
                        <div class="card card-client-msg">
                            <div class="sender-row">
                                <span><i class="fas fa-comment-dots text-orange-600"></i> ×”×•×“×¢×” ××œ×§×•×—: ${data.clientName}</span>
                                <span>${new Date().toLocaleTimeString().slice(0,5)}</span>
                            </div>
                            <div class="content-text text-lg">
                                "${lastMsg.text}"
                            </div>
                             <div class="text-xs text-gray-500 mt-1">×”×œ×§×•×— ×××ª×™×Ÿ ×œ×ª×©×•×‘×”...</div>
                            <div class="mt-2 text-xs flex gap-2">
                                <button onclick="replyToClient('${id}')" class="bg-white border border-orange-200 text-orange-600 px-3 py-1 rounded shadow-sm hover:bg-orange-50 font-bold">â†©ï¸ ×”×©×‘</button>
                                <button onclick="markHandled('${id}')" class="bg-green-100 text-green-700 px-3 py-1 rounded font-bold hover:bg-green-200">âœ… ×˜×•×¤×œ</button>
                            </div>
                        </div>`;
                        
                        addHtml(html);
                        if (isFresh) window.parent.triggerAlert('knock', `×”×•×“×¢×” ×${data.clientName}`);
                    }
                }
                
                // 2. ×ª×¨×—×™×©: ×”×–×× ×” ×—×“×©×” (× ×•×¦×¨×” ×¢×›×©×™×•)
                if (change.type === "added") {
                    // ×‘×“×™×§×” ×›×¤×•×œ×” ×œ×˜×¨×™×•×ª ×™×¦×™×¨×”
                    const createdTime = data.createdAt ? data.createdAt.seconds * 1000 : 0;
                    const isNewCreation = (now - createdTime) < 15000;

                    if(isNewCreation) {
                        const html = `
                        <div class="card card-new-order">
                            <div class="sender-row">
                                <span class="text-blue-600 font-bold">ğŸ“¦ ×”×–×× ×” ×—×“×©×” × ×›× ×¡×”!</span>
                                <span>${new Date().toLocaleTimeString().slice(0,5)}</span>
                            </div>
                            <div class="content-text">${data.clientName}</div>
                            <div class="text-sm text-gray-600 mt-1">${data.itemsText}</div>
                            <div class="mt-2 text-xs">
                                <button onclick="window.parent.loadPage('client-final.html?uid=${data.clientId}&name=${data.clientName}', '××‘×˜ ×œ×§×•×—', null)" class="text-blue-500 hover:underline">ğŸ‘ï¸ ×¦×¤×” ×›×œ×§×•×—</button>
                            </div>
                        </div>`;
                        
                        addHtml(html);
                        window.parent.triggerAlert('knock', '×”×–×× ×” ×—×“×©×”!');
                    }
                }
            });
        });

        // --- ×”×›×œ×™ ×©×‘×™×§×©×ª: ×©×™×“×•×š ××¡××š ×™×“× ×™ ---
        window.manualLink = async () => {
            // ×©×œ×‘ 1: ×”×–× ×ª × ×ª×•× ×™×
            const { value: formValues } = await Swal.fire({
                title: 'ğŸ”— ×©×™×“×•×š ××¡××š ×œ×”×–×× ×”',
                html: `
                    <label class="block text-right text-xs font-bold mb-1">××¡×¤×¨ ×”×–×× ×” (×œ×§×•×—)</label>
                    <input id="link-order-num" class="swal2-input" placeholder="×œ××©×œ: 888">
                    
                    <label class="block text-right text-xs font-bold mb-1 mt-3">××¡×¤×¨ ××¡××š/×§×™×©×•×¨</label>
                    <input id="link-doc-url" class="swal2-input" placeholder="×”×“×‘×§ ×œ×™× ×§ ××• ××¡×¤×¨ ××¡××š">
                `,
                focusConfirm: false,
                confirmButtonText: '×‘×¦×¢ ×©×™×“×•×š',
                preConfirm: () => {
                    return [
                        document.getElementById('link-order-num').value,
                        document.getElementById('link-doc-url').value
                    ]
                }
            });

            if (formValues) {
                const [orderNum, docUrl] = formValues;
                if(!orderNum || !docUrl) return;

                // ×©×œ×‘ 2: ×—×™×¤×•×© ×”×”×–×× ×”
                const q = query(collection(db, "orders"), where("orderNum", "==", orderNum)); // ××—×¤×© ×œ×¤×™ ××¡×¤×¨ ×”×–×× ×” ×©×”××¢×¨×›×ª × ×ª× ×” ××• ×©×”×•×’×“×¨
                // ×”×¢×¨×”: ×× ××ª×” ××©×ª××© ×‘-Auto ID ×©×œ ×¤×™×™×¨×‘×™×™×¡, × ×¦×˜×¨×š ×œ×—×¤×© ××—×¨×ª. 
                // ×›××Ÿ ×× ×™ ×× ×™×— ×©-orderNum ×”×•× ×©×“×” ×§×™×™×. ×× ×œ×, × ×—×¤×© ×œ×¤×™ ×©× ×œ×§×•×— ××• ××©×”×• ××—×¨.
                // ×œ×‘×™×˜×—×•×Ÿ - × ×—×¤×© ××ª ×›×œ ×”×”×–×× ×•×ª ×•× ×¦×™×’ ×œ×‘×—×™×¨×” ×× ×œ× ××•×¦××™× ××“×•×™×§.
                
                // ×’×¨×¡×” ×¤×©×•×˜×”: ×—×™×¤×•×© ×”×”×–×× ×” ×”×›×™ ×—×“×©×” ×©×œ ×”×œ×§×•×—/××¡×¤×¨ ×”×–×”
                // ×œ×¦×•×¨×š ×”×¤×©×˜×•×ª, × × ×™×— ×©××ª×” ××§×œ×™×“ ID ×©×œ ××¡××š ×¤×™×™×¨×‘×™×™×¡ ××• ×©× ×‘×¦×¢ ×œ×•×’×™×§×” ×—×›××” ×™×•×ª×¨:
                // × ×—×‘×¨ ××ª ×”-URL ×”×–×” ×œ××¡××š ×”××—×¨×•×Ÿ ×©× ×•×¡×£.
                
                // ×”×ª×™×§×•×Ÿ: ×¤×©×•×˜ × ×¢×“×›×Ÿ ×”×–×× ×” ×œ×¤×™ ID ×× ×”×•× ×™×“×•×¢, ××• × ×—×¤×©.
                // ×›×“×™ ×œ×¢×©×•×ª ××ª ×–×” ×§×œ, ×‘×•× × × ×™×— ×©××ª×” ××“×‘×™×§ ××ª ×”-URL ×œ×ª×•×š ×”×”×–×× ×” ×”××—×¨×•× ×” ×‘×¨×©×™××”, ××• ×‘×•×—×¨ ××¨×©×™××”.
                
                // ×©×™×˜×” ×—×›××” ×™×•×ª×¨: × ×¤×ª×— ×—×œ×•×Ÿ ×‘×—×™×¨×ª ×”×–×× ×” ×¤×¢×™×œ×”
                const snap = await getDocs(query(collection(db, "orders"), where("status", "!=", "done")));
                const options = {};
                snap.forEach(d => {
                     const o = d.data();
                     options[d.id] = `#${o.orderNum || '???'} - ${o.clientName}`;
                });
                
                const { value: selectedOrderId } = await Swal.fire({
                    title: '×œ××™×–×• ×”×–×× ×” ×œ×©×“×š?',
                    input: 'select',
                    inputOptions: options,
                    inputPlaceholder: '×‘×—×¨ ×”×–×× ×” ××”×¨×©×™××”...'
                });

                if (selectedOrderId) {
                    // ×‘×™×¦×•×¢ ×”×©×™×“×•×š
                    await updateDoc(doc(db, "orders", selectedOrderId), {
                        pdfUrl: docUrl, // ××¢×“×›×Ÿ ××ª ×”-PDF
                        status: 'waiting_approval', // ××¢×™×¨ ××ª ×”×œ×§×•×— ×œ××©×¨
                        chat: arrayUnion({
                            sender: '×¨×××™',
                            text: '×¦×™×¨×¤×ª×™ ×œ×š ××¡××š ×œ×¢×™×•×Ÿ. ×× × ××©×¨×™.',
                            time: new Date().toISOString()
                        })
                    });
                    
                    Swal.fire('×‘×•×¦×¢!', '×”××¡××š ×©×•×“×š ×•×”×œ×§×•×— ×§×™×‘×œ ×¢×“×›×•×Ÿ.', 'success');
                }
            }
        };

        window.replyToClient = async (id) => {
            const { value: text } = await Swal.fire({ input: 'text', title: '×ª×©×•×‘×” ×œ×œ×§×•×—', confirmButtonText: '×©×œ×—' });
            if(text) {
                await updateDoc(doc(db, "orders", id), {
                    chat: arrayUnion({ sender: '×¨×××™', text: text, time: new Date().toISOString() }),
                    status: 'waiting_approval'
                });
            }
        };

        window.markHandled = async (id) => {
             await updateDoc(doc(db, "orders", id), { status: 'waiting_approval' });
        };
        
        window.sendTeamMsg = async () => {}; 
    </script>
</body>
</html>
