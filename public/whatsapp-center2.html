<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>" 转 住 PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #d1d7db; font-family: system-ui; height: 100vh; display: flex; }
        .sidebar { width: 350px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .main { flex: 1; background: #efeae2; display: flex; align-items: center; justify-content: center; }
        .order-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .order-item:hover { background: #f5f5f5; }
        .order-item.new { border-right: 4px solid #25d366; background: #e8f5e9; }
        
        /* Print Area */
        @media print { body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; top:0; left:0; width:100%; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="h-16 bg-gray-100 flex items-center px-4 font-bold border-b"> 转 住转</div>
        <div id="ordersList" class="flex-1 overflow-y-auto"></div>
    </div>

    <div class="main" id="mainArea">
        <div class="text-center text-gray-400">
            <i class="fas fa-inbox text-6xl mb-4"></i>
            <h2 class="text-xl">专  专砖</h2>
        </div>
    </div>

    <div id="printArea" class="hidden bg-white p-10 text-black">
        <h1 class="text-2xl font-bold text-center border-b pb-4 mb-4">转 注 - .住</h1>
        <div id="printContent"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Listen to Orders
        const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('ordersList');
            list.innerHTML = "";
            
            snap.forEach(doc => {
                const o = doc.data();
                const div = document.createElement('div');
                div.className = `order-item ${o.status === 'new' ? 'new' : ''}`;
                div.innerHTML = `
                    <div class="font-bold text-sm">${o.clientName}</div>
                    <div class="text-xs text-gray-500">${new Date(o.createdAt?.seconds*1000).toLocaleTimeString()} | ${o.items?.length} 驻专</div>
                `;
                div.onclick = () => showOrder(o);
                list.appendChild(div);
            });
        });

        window.showOrder = (o) => {
            const main = document.getElementById('mainArea');
            const wazeBtn = o.wazeLink ? `<a href="${o.wazeLink}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2"><i class="fab fa-waze"></i> </a>` : '';
            
            main.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-xl w-[600px]">
                    <div class="flex justify-between items-start mb-6 border-b pb-4">
                        <div>
                            <h2 class="text-2xl font-bold">${o.clientName}</h2>
                            <p class="text-gray-500">${o.phone} | ${o.address}</p>
                        </div>
                        <div class="flex gap-2">
                            ${wazeBtn}
                            <button onclick="printCurrentOrder()" class="bg-gray-800 text-white px-4 py-2 rounded-lg font-bold"><i class="fas fa-print"></i> 驻住</button>
                        </div>
                    </div>
                    
                    <table class="w-full text-right border-collapse">
                        <tr class="bg-gray-100"><th class="p-2">爪专</th><th class="p-2 text-center">转</th></tr>
                        ${o.items.map(i => `<tr class="border-b"><td class="p-2">${i.name}</td><td class="p-2 text-center font-bold">${i.qty}</td></tr>`).join('')}
                    </table>
                </div>
            `;

            // Prepare Print
            document.getElementById('printContent').innerHTML = `
                <div style="text-align:right; margin-bottom:20px;">
                    <strong>拽:</strong> ${o.clientName}<br>
                    <strong>转转:</strong> ${o.address}<br>
                    <strong>驻:</strong> ${o.phone}
                </div>
                <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                    <thead><tr style="background:#eee;"><th style="border:1px solid #000; padding:5px;">爪专</th><th style="border:1px solid #000; padding:5px;">转</th></tr></thead>
                    <tbody>${o.items.map(i => `<tr><td style="border:1px solid #000; padding:5px;">${i.name}</td><td style="border:1px solid #000; padding:5px; text-align:center;">${i.qty}</td></tr>`).join('')}</tbody>
                </table>
            `;
        };

        window.printCurrentOrder = () => window.print();
    </script>
</body>
</html>
