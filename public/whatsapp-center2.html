<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>" 转 住 PRO</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { background-color: #d1d7db; font-family: -apple-system, system-ui, sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* 住专 爪 */
        .sidebar { width: 35%; min-width: 380px; background: white; border-left: 1px solid #e9edef; display: flex; flex-direction: column; z-index: 20; }
        
        /*  */
        .tab-btn { flex: 1; padding: 14px; text-align: center; cursor: pointer; font-weight: 600; color: #54656f; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { border-color: #008069; color: #008069; background: #f0fdfa; }
        .tab-btn:hover { background: #f5f6f6; }

        /* 住专 */
        .story-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: 60px; transition: transform 0.2s; }
        .story-item:hover { transform: scale(1.05); }
        .story-ring { width: 50px; height: 50px; border-radius: 50%; padding: 2px; border: 2px solid transparent; object-fit: cover; }
        .ring-green { border-color: #10b981; }
        .ring-red { border-color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }

        /* 专砖转 */
        .chat-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f5f6f6; transition: 0.1s; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #f0f2f5; border-right: 4px solid #00a884; }

        /* 爪' 专砖 */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #efeae2 url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); position: relative; }
        
        /* --- 驻转拽 专专 --- */
        .sticky-note { 
            position: absolute; width: 220px; min-height: 180px; padding: 15px; 
            box-shadow: 5px 5px 15px rgba(0,0,0,0.2); z-index: 50; 
            border-radius: 8px; display: none; flex-direction: column;
            cursor: grab; transition: transform 0.1s; top: 100px; left: 50px;
        }
        .sticky-note.visible { display: flex; }
        .sticky-note:active { cursor: grabbing; transform: scale(1.02); z-index: 60; }
        .note-header { display: flex; justify-content: space-between; margin-bottom: 8px; cursor: grab; }
        .note-colors { display: flex; gap: 5px; }
        .color-dot { width: 12px; height: 12px; rounded-full; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        .sticky-textarea { background: transparent; border: none; outline: none; resize: none; width: 100%; flex: 1; font-family: 'Comic Sans MS', sans-serif; font-size: 14px; }

        /* 驻转专 */
        .action-btn { transition: all 0.2s; cursor: pointer; }
        .action-btn:active { transform: scale(0.95); }

        /* 注转 */
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 8px; margin: 4px 20px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); width: fit-content; font-size: 14px; }
        .msg.staff { background: #d9fdd3; align-self: flex-end; }
        .msg.user { background: white; align-self: flex-start; }
        .msg.internal { background: #fff9c4; align-self: center; border: 1px dashed orange; text-align: center; width: 80%; }

        /* ---  驻注 (Smart Parser Modal) --- */
        .parser-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .parser-content {
            background: #f0f2f5; width: 90%; max-width: 900px; height: 85vh;
            border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .parser-header { background: #008069; color: white; padding: 15px; display: flex; justify-content: space-between; items-center; }
        .parser-body { flex: 1; display: flex; overflow: hidden; }
        .parser-input { width: 35%; padding: 15px; border-left: 1px solid #ddd; background: white; display: flex; flex-direction: column; }
        .parser-results { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .result-row { 
            background: white; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px;
            border: 1px solid #ddd; transition: 0.2s; position: relative;
        }
        .result-row.matched { border-right: 5px solid #10b981; }
        .result-row.unknown { border-right: 5px solid #ef4444; background: #fef2f2; }
        
        /* 转转 驻砖 爪驻 */
        .search-dropdown {
            position: absolute; top: 100%; right: 0; left: 0;
            background: white; border: 1px solid #ddd; 
            max-height: 200px; overflow-y: auto; z-index: 50; 
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .search-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; text-align: right; }
        .search-item:hover { background: #f0fdfa; }

        /*   */
        .audio-btn.on { background: #dcfce7; color: #166534; }
        .audio-btn.off { background: #fee2e2; color: #dc2626; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4 flex-shrink-0">
            <div class="flex items-center gap-2">
                <div class="relative">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=008069&color=fff" class="w-10 h-10 rounded-full border shadow-sm">
                    <div class="absolute bottom-0 left-0 w-3 h-3 bg-green-500 rounded-full border border-white"></div>
                </div>
                <div class="font-bold text-gray-700">拽爪转 转</div>
            </div>
            
            <button id="soundToggle" onclick="window.toggleSound()" class="action-btn audio-btn off px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm">
                <i class="fas fa-volume-mute" id="soundIcon"></i> <span id="soundText">砖转拽</span>
            </button>
        </div>

        <div class="flex border-b bg-white flex-shrink-0">
            <div onclick="window.switchTab('chats')" class="tab-btn active" id="tab-chats"> 转</div>
            <div onclick="window.switchTab('saban')" class="tab-btn" id="tab-saban">
                 爪'-住
                <span id="sabanAlert" class="hidden w-2 h-2 bg-red-500 rounded-full inline-block ml-1 animate-ping"></span>
            </div>
        </div>

        <div class="stories-container" id="storiesBar" style="padding: 12px; display: flex; gap: 10px; overflow-x: auto;"></div>

        <div id="chatsList" class="chat-list custom-scroll flex-1 overflow-y-auto"></div>
        <div id="sabanList" class="chat-list hidden custom-scroll flex-1 overflow-y-auto"></div>
    </div>

    <div id="chatArea" class="main-chat hidden">
        <div class="h-16 bg-[#f0f2f5] border-b flex justify-between items-center px-4 shadow-sm z-20 flex-shrink-0">
            <div class="flex items-center gap-3">
                <img id="activeAvatar" src="" class="w-10 h-10 rounded-full border bg-white object-cover">
                <div><div id="activeName" class="font-bold text-gray-800"></div><div class="text-xs text-green-600">专</div></div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.toggleParser()" class="action-btn bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold border border-indigo-700 shadow flex gap-2 items-center hover:opacity-90">
                    <i class="fas fa-magic"></i> 驻注 
                </button>
                
                <button onclick="window.toggleSticky()" class="action-btn bg-yellow-100 text-yellow-700 px-3 py-1.5 rounded border border-yellow-200 text-xs font-bold flex gap-2 items-center hover:bg-yellow-200">
                    <i class="fas fa-sticky-note"></i> 驻转拽
                </button>
            </div>
        </div>

        <div id="stickyNote" class="sticky-note bg-yellow-100 border border-yellow-300">
            <div class="note-header" onmousedown="window.dragStart(event, this.parentElement)">
                <i class="fas fa-thumbtack text-yellow-600/50"></i>
                <div class="note-colors">
                    <div class="color-dot bg-red-200" onclick="window.setNoteColor('#fecaca', '#fca5a5')"></div>
                    <div class="color-dot bg-green-200" onclick="window.setNoteColor('#bbf7d0', '#86efac')"></div>
                    <div class="color-dot bg-yellow-200" onclick="window.setNoteColor('#fef08a', '#fde047')"></div>
                </div>
            </div>
            <textarea class="sticky-textarea" placeholder="专砖 砖转 ..."></textarea>
        </div>

        <div id="messagesBox" class="flex-1 overflow-y-auto flex flex-col p-4 pb-2"></div>

        <div class="bg-[#f0f2f5] p-3 flex items-center gap-2 border-t z-20 flex-shrink-0">
            <i onclick="window.toggleInternal()" id="internalBtn" class="fas fa-eye-slash text-gray-400 cursor-pointer text-xl p-2" title="驻"></i>
            <input type="text" id="msgInput" class="flex-1 p-3 rounded-lg border-none outline-none shadow-sm bg-white" placeholder="拽..." onkeydown="if(event.key==='Enter') window.sendMessage()">
            <button onclick="window.sendMessage()" class="text-[#008069] text-2xl hover:scale-110 transition"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="parserModal" class="parser-modal">
        <div class="parser-content">
            <div class="parser-header">
                <div class="flex items-center gap-2">
                    <i class="fas fa-robot text-2xl"></i>
                    <div><div class="font-bold text-lg">驻注 转 </div><div class="text-xs opacity-80">.住 专 </div></div>
                </div>
                <button onclick="window.toggleParser()" class="text-white hover:text-red-200"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="parser-body">
                <div class="parser-input">
                    <label class="text-xs font-bold text-gray-500 mb-2">拽 拽住:</label>
                    <textarea id="rawOrderInput" class="w-full flex-1 p-3 border rounded-xl bg-gray-50 resize-none outline-none focus:ring-2 ring-green-500 mb-4 font-mono text-sm" placeholder=": 10  拽 住拽..."></textarea>
                    <button onclick="window.analyzeText()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2 hover:bg-slate-700 transition"><i class="fas fa-bolt"></i> 驻注 注砖</button>
                </div>

                <div class="parser-results bg-gray-100 relative" id="resultsPane">
                    <div id="emptyParserState" class="text-center text-gray-400 mt-20">
                        <i class="fas fa-list-ol text-4xl mb-4"></i>
                        <p>转爪转 驻注 ...</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 border-t flex justify-between items-center">
                <div class="text-xs text-gray-500 font-bold" id="itemsCount">0 驻专</div>
                <div class="flex gap-3">
                    <button onclick="window.printParserOrder()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-300"><i class="fas fa-print"></i> 驻住</button>
                    <button onclick="window.exportPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-700"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const { jsPDF } = window.jspdf;

        // --- Firebase Config ---
        const config = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(config);
        const db = getFirestore(app);

        // --- Global Variables ---
        let activeChatId = null;
        let activeColl = 'chat_sessions';
        let internalMode = false;
        let audioEnabled = false;
        let catalog = [];
        let parsedItems = [];

        // --- 1. Sound Logic ---
        window.toggleSound = () => {
            const btn = document.getElementById('soundToggle');
            const icon = document.getElementById('soundIcon');
            const text = document.getElementById('soundText');

            if (!audioEnabled) {
                // 住  爪   砖专专 住转 驻驻
                const a = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAGZGF0YQQAAAAAAA==");
                a.play().then(() => {
                    audioEnabled = true;
                    btn.classList.remove('off'); btn.classList.add('on');
                    icon.className = "fas fa-volume-up";
                    text.innerText = "驻注";
                }).catch(e => alert(" 抓 砖 注 驻转专 砖专 住"));
            } else {
                audioEnabled = false;
                btn.classList.remove('on'); btn.classList.add('off');
                icon.className = "fas fa-volume-mute";
                text.innerText = "砖转拽";
            }
        };

        // --- 2. Chat Logic ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            if (tab === 'chats') {
                document.getElementById('chatsList').classList.remove('hidden');
                document.getElementById('sabanList').classList.add('hidden');
            } else {
                document.getElementById('chatsList').classList.add('hidden');
                document.getElementById('sabanList').classList.remove('hidden');
                document.getElementById('sabanAlert').classList.add('hidden');
            }
        };

        window.openChat = (id, name, img, coll) => {
            activeChatId = id; activeColl = coll;
            document.getElementById('chatArea').classList.remove('hidden');
            document.getElementById('activeName').innerText = name;
            document.getElementById('activeAvatar').src = img;

            onSnapshot(query(collection(db, `${coll}/${id}/messages`), orderBy("createdAt", "asc")), (snap) => {
                const box = document.getElementById('messagesBox');
                box.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const cls = m.role==='staff' ? 'msg staff' : (m.role==='internal'?'msg internal':'msg user');
                    return `<div class="${cls}">${m.role==='internal'?' ':''}${m.text}</div>`;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMessage = async () => {
            const txt = document.getElementById('msgInput').value; if(!txt || !activeChatId) return;
            document.getElementById('msgInput').value = '';
            await addDoc(collection(db, `${activeColl}/${activeChatId}/messages`), { text: txt, role: internalMode?'internal':'staff', createdAt: serverTimestamp() });
            
            if(!internalMode) {
                const metaColl = activeColl === 'saban_chats' ? 'saban_chats_meta' : 'chat_sessions';
                await setDoc(doc(db, metaColl, activeChatId), { lastMessage: `爪: ${txt}`, lastActivity: serverTimestamp() }, { merge: true });
            }
            if(internalMode) window.toggleInternal();
        };

        window.toggleInternal = () => {
            internalMode = !internalMode;
            const inp = document.getElementById('msgInput');
            const btn = document.getElementById('internalBtn');
            if(internalMode) {
                inp.placeholder = "注专 驻转..."; inp.classList.add('bg-yellow-100');
                btn.className = "fas fa-eye-slash text-orange-500 text-xl p-2";
            } else {
                inp.placeholder = "拽..."; inp.classList.remove('bg-yellow-100');
                btn.className = "fas fa-eye text-gray-400 text-xl p-2";
            }
        };

        // --- 3. Sticky Notes Logic ---
        window.toggleSticky = () => document.getElementById('stickyNote').classList.toggle('visible');
        
        window.setNoteColor = (bg, border) => {
            const note = document.getElementById('stickyNote');
            note.style.backgroundColor = bg; note.style.borderColor = border;
        };

        let dragItem = null;
        let offsetX = 0, offsetY = 0;
        window.dragStart = (e, item) => {
            dragItem = item;
            offsetX = e.clientX - item.offsetLeft;
            offsetY = e.clientY - item.offsetTop;
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', dragEnd);
        };
        function dragMove(e) {
            if(!dragItem) return;
            dragItem.style.left = (e.clientX - offsetX) + 'px';
            dragItem.style.top = (e.clientY - offsetY) + 'px';
        }
        function dragEnd() {
            dragItem = null;
            document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('mouseup', dragEnd);
        }

        // --- 4. Smart Parser Logic ---
        async function loadCatalogData() {
            try {
                const snap = await getDocs(collection(db, "products"));
                catalog = snap.docs.map(d => ({id: d.id, ...d.data()}));
            } catch(e) { console.error("Catalog Error", e); }
        }
        loadCatalogData();

        window.toggleParser = () => {
            const modal = document.getElementById('parserModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        };

        window.analyzeText = () => {
            const text = document.getElementById('rawOrderInput').value;
            if(!text) return;
            const lines = text.split('\n');
            parsedItems = [];
            document.getElementById('resultsPane').innerHTML = '';
            document.getElementById('emptyParserState').style.display = 'none';

            lines.forEach((line, idx) => {
                const clean = line.trim();
                if(clean.length < 2 || /拽专|转|祝/.test(clean)) return;

                const qty = (clean.match(/\d+/) || [1])[0];
                const cleanText = clean.replace(/[0-9]/g, '').trim();
                const match = catalog.find(p => p.core.name.includes(cleanText));

                const item = {
                    original: clean, qty: qty,
                    status: match ? 'matched' : 'unknown',
                    name: match ? match.core.name : clean,
                    image: match?.rich?.image
                };
                parsedItems.push(item);
                renderParserRow(item, idx);
            });
            document.getElementById('itemsCount').innerText = `${parsedItems.length} 驻专`;
        };

        function renderParserRow(item, idx) {
            const pane = document.getElementById('resultsPane');
            const row = document.createElement('div');
            row.className = `result-row ${item.status}`;
            const imgHtml = item.image ? `<img src="${item.image}" class="w-8 h-8 rounded">` : `<div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center"><i class="fas fa-box text-gray-400"></i></div>`;
            const icon = item.status === 'matched' ? 'check-circle text-green-500' : 'question-circle text-red-500';

            row.innerHTML = `
                <i class="fas fa-${icon}"></i> ${imgHtml}
                <div class="flex-1 cursor-pointer" onclick="window.enableRowEdit(${idx}, this)">
                    <div class="font-bold text-sm">${item.name}</div>
                    <div class="text-xs text-gray-400">拽专: ${item.original}</div>
                </div>
                <div class="border-r px-2 text-center"><div class="text-[10px] text-gray-500">转</div><b>${item.qty}</b></div>
            `;
            pane.appendChild(row);
        }

        window.enableRowEdit = (idx, el) => {
            const val = parsedItems[idx].name;
            el.innerHTML = `
                <input type="text" class="w-full border rounded p-1 text-sm" value="${val}" oninput="window.parserSearch(this, ${idx})" autofocus>
                <div id="drop-${idx}" class="search-dropdown hidden"></div>
            `;
        };

        window.parserSearch = (inp, idx) => {
            const val = inp.value.toLowerCase();
            const drop = document.getElementById(`drop-${idx}`);
            drop.classList.remove('hidden');
            const found = catalog.filter(p => p.core.name.toLowerCase().includes(val)).slice(0,5);
            
            drop.innerHTML = found.length ? found.map(p => `
                <div class="search-item" onclick="window.selectParserItem(${idx}, '${p.core.name.replace(/'/g,"\\'")}', '${p.rich?.image||''}')">
                    <div class="font-bold">${p.core.name}</div>
                </div>`).join('') : '<div class="p-2 text-gray-400 text-xs"> 爪</div>';
        };

        window.selectParserItem = (idx, name, img) => {
            parsedItems[idx].name = name;
            parsedItems[idx].image = img;
            parsedItems[idx].status = 'matched';
            // Re-render
            document.getElementById('resultsPane').innerHTML = '';
            parsedItems.forEach((it, i) => renderParserRow(it, i));
        };

        window.printParserOrder = () => {
            const w = window.open('','','width=600,height=800');
            let h = `<html dir="rtl"><body style="font-family:sans-serif"><h2> - .住</h2><ul>`;
            parsedItems.forEach(i => h+=`<li><b>${i.name}</b> (转: ${i.qty})</li>`);
            h+=`</ul><script>window.print()<\/script></body></html>`;
            w.document.write(h);
        };

        window.exportPDF = () => {
            const doc = new jsPDF({align:"right", isRtl:true});
            doc.text("Saban Order", 190, 20, {align:"right"});
            let y=30;
            parsedItems.forEach(i => {
                doc.text(`${i.name} (x${i.qty})`, 190, y, {align:"right"});
                y+=10;
            });
            doc.save("order.pdf");
        };

        // --- Load Chats ---
        onSnapshot(query(collection(db, "chat_sessions"), orderBy("lastActivity", "desc")), (snap) => {
            const list = document.getElementById('chatsList');
            const stories = document.getElementById('storiesBar');
            list.innerHTML = ""; stories.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                let img = c.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(c.userName)}&background=random&color=fff`;
                list.innerHTML += `<div onclick="window.openChat('${d.id}', '${c.userName}', '${img}', 'chat_sessions')" class="chat-item"><img src="${img}" class="w-10 h-10 rounded-full ml-3"><div class="flex-1"><div class="font-bold text-sm">${c.userName}</div><div class="text-xs text-gray-500 truncate">${c.lastMessage}</div></div></div>`;
                stories.innerHTML += `<div class="story-item" onclick="window.openChat('${d.id}', '${c.userName}', '${img}', 'chat_sessions')"><img src="${img}" class="story-ring ring-green"><span class="text-[10px]">${c.userName.split(' ')[0]}</span></div>`;
            });
        });

    </script>
</body>
</html>
