<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban WhatsApp | חמ"ל מוח</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --wa-green: #008069; --wa-bg: #efeae2; --wa-white: #ffffff; --internal-bg: #fff9c4; }
        body { background-color: #d1d7db; font-family: 'Heebo', sans-serif; height: 100vh; margin: 0; overflow: hidden; }
        .app-container { display: flex; width: 100%; height: 100%; max-width: 1700px; margin: 0 auto; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .sidebar { width: 420px; display: flex; flex-direction: column; border-left: 1px solid #e9edef; background: white; }
        .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--wa-bg); position: relative; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); }
        @media (max-width: 768px) { .sidebar { width: 100%; position: absolute; inset: 0; } .main-chat { position: absolute; inset: 0; z-index: 30; transform: translateX(100%); transition: transform 0.3s; } .main-chat.open { transform: translateX(0); } }
        
        .wa-header { height: 60px; background: #f0f2f5; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e9edef; }
        .chat-list { overflow-y: auto; flex: 1; }
        .chat-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f5f6f6; }
        .chat-item:hover { background: #f5f6f6; } .chat-item.active { background: #f0f2f5; border-right: 4px solid var(--wa-green); }
        .msg-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg-bubble { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 14.2px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .msg-in { align-self: flex-start; background: white; border-top-right-radius: 0; }
        .msg-out { align-self: flex-end; background: #d9fdd3; border-top-left-radius: 0; }
        .msg-internal { align-self: flex-end; background: var(--internal-bg); border: 1px dashed #f59e0b; opacity: 0.95; }
        .sys-msg { align-self: center; background: #fff5c4; color: #5c4b08; font-size: 12px; padding: 5px 12px; border-radius: 8px; margin: 10px 0; }
        .chat-footer { min-height: 62px; background: #f0f2f5; padding: 10px; display: flex; items-center; gap: 10px; }
        
        /* AI Modal */
        .ai-modal { position: fixed; bottom: 80px; left: 20px; width: 350px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 100; display: none; flex-direction: column; border: 2px solid #3b82f6; overflow: hidden; }
        .ai-header { background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 15px; color: white; font-weight: bold; display: flex; justify-content: space-between; }
        .ai-body { padding: 15px; max-height: 300px; overflow-y: auto; background: #f8fafc; font-size: 13px; }
        .ai-msg { background: white; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        .ai-msg.bot { background: #eff6ff; border-color: #bfdbfe; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="wa-header">
                <div class="flex items-center gap-2">
                    <img id="userAvatar" src="" class="w-8 h-8 rounded-full">
                    <span id="userName" class="font-bold text-sm">...</span>
                </div>
                <button onclick="toggleBrain()" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow animate-pulse">
                    <i class="fas fa-brain"></i> SabanAI
                </button>
            </div>
            <div class="flex bg-white border-b">
                <div onclick="switchTab('orders')" class="flex-1 text-center p-3 cursor-pointer hover:bg-gray-50 border-b-2 border-green-600 font-bold">הזמנות</div>
                <div onclick="switchTab('transfers')" class="flex-1 text-center p-3 cursor-pointer hover:bg-gray-50">העברות</div>
            </div>
            <div id="list-container" class="chat-list"></div>
        </div>

        <div class="main-chat" id="mainChat">
            <div id="emptyState" class="flex flex-col items-center justify-center h-full text-center p-10 text-gray-500">
                <h2 class="text-2xl font-light">חמ"ל סבן</h2>
                <p>בחר שיחה או השתמש במוח AI</p>
            </div>
            <div id="activeChat" class="hidden flex flex-col h-full">
                <div class="wa-header">
                    <div class="flex items-center gap-3">
                        <i onclick="document.getElementById('mainChat').classList.remove('open')" class="fas fa-arrow-right md:hidden cursor-pointer"></i>
                        <img id="chatImg" src="" class="w-10 h-10 rounded-full">
                        <span id="chatTitle" class="font-bold"></span>
                    </div>
                </div>
                <div id="messagesArea" class="msg-container custom-scroll"></div>
                <div class="chat-footer">
                    <input id="msgInput" type="text" class="flex-1 bg-white rounded-lg h-10 px-4 text-sm border-none outline-none" placeholder="הקלד הודעה..." onkeydown="if(event.key==='Enter') sendMessage()">
                    <i onclick="sendMessage()" class="fas fa-paper-plane text-2xl text-gray-500 cursor-pointer hover:text-[#008069]"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="sabanBrain" class="ai-modal">
        <div class="ai-header">
            <span><i class="fas fa-robot"></i> יועץ חכם</span>
            <i class="fas fa-times cursor-pointer" onclick="toggleBrain()"></i>
        </div>
        <div id="brainLog" class="ai-body"><div class="ai-msg bot">אהלן! אני מחובר למפתחות גוגל וג'ימני שלך. תשאל חופשי.</div></div>
        <div class="p-2 border-t flex gap-2">
            <input id="brainInput" class="flex-1 border rounded px-2 text-sm outline-none h-8" placeholder="שאל שאלה...">
            <button onclick="askBrain()" class="bg-blue-600 text-white px-3 rounded h-8"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { SabanBrain } from './services/saban-brain.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let activeTab = 'orders';
        let currentChatId = null;
        const currentUser = JSON.parse(localStorage.getItem('saban_user')) || {name: 'אורח'};

        document.getElementById('userName').innerText = currentUser.name;
        document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${currentUser.name}&background=random`;

        // --- BRAIN ---
        window.toggleBrain = () => {
            const el = document.getElementById('sabanBrain');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        };

        window.askBrain = async () => {
            const input = document.getElementById('brainInput');
            const txt = input.value; if(!txt) return;
            
            document.getElementById('brainLog').innerHTML += `<div class="ai-msg"><b>אני:</b> ${txt}</div>`;
            input.value = 'חושב...'; input.disabled = true;
            
            const ans = await SabanBrain.ask(txt, "אתה עוזר למנהל חמ'ל. תן תשובות קצרות.");
            document.getElementById('brainLog').innerHTML += `<div class="ai-msg bot"><b>AI:</b> ${ans}</div>`;
            input.value = ''; input.disabled = false; input.focus();
        };

        // --- CHAT LOGIC ---
        window.switchTab = (tab) => {
            activeTab = tab;
            const coll = tab === 'orders' ? 'orders' : 'transfers';
            onSnapshot(query(collection(db, coll), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('list-container');
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const title = tab==='orders' ? data.clientName : data.comaxNum;
                    list.innerHTML += `
                    <div class="chat-item" onclick="openChat('${d.id}', '${title}')">
                        <img src="https://ui-avatars.com/api/?name=${title}&background=random" class="w-10 h-10 rounded-full ml-3">
                        <div>
                            <div class="font-bold text-sm">${title}</div>
                            <div class="text-xs text-gray-500">${tab==='orders'?'הזמנה':'העברה'}</div>
                        </div>
                    </div>`;
                });
            });
        };

        window.openChat = (id, title) => {
            currentChatId = id;
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('activeChat').classList.remove('hidden');
            document.getElementById('mainChat').classList.add('open');
            document.getElementById('chatTitle').innerText = title;
            document.getElementById('chatImg').src = `https://ui-avatars.com/api/?name=${title}&background=random`;
            
            const coll = activeTab === 'orders' ? `orders/${id}/internal_chat` : `transfers/${id}/chat`;
            onSnapshot(query(collection(db, coll), orderBy("createdAt", "asc")), (snap) => {
                const area = document.getElementById('messagesArea');
                area.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.sender === currentUser.name;
                    area.innerHTML += `<div class="msg-bubble ${isMe ? 'msg-out' : 'msg-in'}"><div class="text-[10px] font-bold text-purple-600">${m.sender}</div>${m.text}</div>`;
                });
                area.scrollTop = area.scrollHeight;
            });
        };

        window.sendMessage = async () => {
            const txt = document.getElementById('msgInput').value;
            if(!txt || !currentChatId) return;
            document.getElementById('msgInput').value = '';
            const coll = activeTab === 'orders' ? `orders/${currentChatId}/internal_chat` : `transfers/${currentChatId}/chat`;
            await addDoc(collection(db, coll), { text: txt, sender: currentUser.name, createdAt: serverTimestamp() });
        };

        window.switchTab('orders'); // Init
    </script>
</body>
</html>
