<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Dispatch | </title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <meta name="theme-color" content="#374151">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest-yoav.json">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=Yoav&background=374151&color=fff&size=180">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background: #f8fafc; font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .sidebar { width: 250px; background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 20; }
        .main-area { flex: 1; padding: 20px; overflow-y: auto; background: #f1f5f9; display: flex; flex-direction: column; }
        
        /* Cards */
        .dispatch-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; border-right: 5px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: 0.2s; position: relative; }
        .dispatch-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .status-assigned { border-right-color: #3b82f6; } 
        .status-picking { border-right-color: #f97316; } 
        .status-en_route { border-right-color: #10b981; } 
        .status-urgent { border-right-color: #ef4444 !important; background: #fef2f2; }

        .app-header { background: #374151; color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-add-task { background: #3b82f6; color: white; border-radius: 8px; padding: 10px 20px; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); }
        .btn-add-task:hover { background: #2563eb; transform: translateY(-1px); }

        .driver-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .driver-row:hover { background: #f8fafc; }
        .driver-row.active-driver { background: #eff6ff; border: 1px solid #3b82f6; } /* Driver Selection Style */
        
        .driver-status { width: 8px; height: 8px; border-radius: 50%; }
        
        .filters { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 6px 12px; border-radius: 20px; background: white; border: 1px solid #e2e8f0; font-size: 13px; color: #64748b; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background: #374151; color: white; border-color: #374151; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="flex items-center gap-3">
            <div class="bg-gray-700 p-2 rounded-lg"><i class="fas fa-network-wired text-xl"></i></div>
            <div>
                <h1 class="text-xl font-bold">注专转 住专</h1>
                <div class="text-xs text-gray-400"> 爪 专 住拽</div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right hidden md:block">
                <div class="text-sm font-bold"></div>
                <div class="text-xs text-gray-400"> 住专</div>
            </div>
            <img src="https://ui-avatars.com/api/?name=Yoav&background=4b5563&color=fff" class="w-10 h-10 rounded-full border-2 border-gray-600">
        </div>
    </div>

    <div class="flex h-full">
        <div class="sidebar hidden md:flex">
            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2"> 驻注</h3>
            <div id="drivers-list">
                <div class="text-center text-gray-400 text-sm mt-4">注 ...</div>
            </div>
        </div>

        <div class="main-area">
            <div class="flex justify-between items-center mb-4">
                <div class="filters">
                    <button class="filter-btn active" onclick="filterView('all', this)"></button>
                    <button class="filter-btn" onclick="filterView('assigned', this)">转</button>
                    <button class="filter-btn" onclick="filterView('picking', this)">拽</button>
                    <button class="filter-btn" onclick="filterView('en_route', this)">专</button>
                    <button class="filter-btn" onclick="filterView('urgent', this)"> 驻</button>
                </div>
                <button onclick="openNewOrderModal()" class="btn-add-task">
                    <i class="fas fa-plus"></i> 砖 砖
                </button>
            </div>

            <div id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const db = getFirestore(initializeApp({ apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0" }));

        // STATE
        let currentFilter = 'all';
        let currentDriverFilter = null; // For filtering by driver
        let ordersData = [];

        // 1. DRIVERS LISTENER
        onSnapshot(query(collection(db, "users"), where("type", "==", "driver")), (snap) => {
            const list = document.getElementById('drivers-list');
            list.innerHTML = '';
            
            snap.forEach(d => {
                const u = d.data();
                // 拽    专 专注 住
                const activeClass = currentDriverFilter === u.name ? 'active-driver' : '';
                
                list.innerHTML += `
                <div class="driver-row ${activeClass}" onclick="filterByDriver('${u.name}')" id="d-${u.name.replace(/\s/g, '')}">
                    <div class="flex items-center gap-3">
                        <img src="${u.avatar || `https://ui-avatars.com/api/?name=${u.name}`}" class="w-8 h-8 rounded-full">
                        <div class="text-sm font-bold text-gray-700">${u.name}</div>
                    </div>
                    <div class="driver-status bg-green-500"></div>
                </div>`;
            });
        });

        // 2. ORDERS LISTENER
        onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => {
            ordersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderOrders();
        });

        function renderOrders() {
            const grid = document.getElementById('orders-grid');
            grid.innerHTML = '';
            
            const filtered = ordersData.filter(o => {
                // 1. Driver Filter ( 专  爪)
                if (currentDriverFilter && o.driverId !== currentDriverFilter) return false;

                // 2. Status Filter ( 注)
                if (o.status === 'done' && currentFilter !== 'all') return false; 
                if (currentFilter === 'all') return o.status !== 'done';
                if (currentFilter === 'urgent') return o.taskType === 'urgent';
                return o.status === currentFilter;
            });

            if(filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-400 mt-10"> 砖转 爪</div>`;
                return;
            }

            filtered.forEach(o => {
                const statusClass = `status-${o.status}`;
                const isUrgent = o.taskType === 'urgent' ? 'status-urgent' : '';
                
                grid.innerHTML += `
                <div class="dispatch-card ${statusClass} ${isUrgent}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-gray-400">#${o.id.slice(-4)}</span>
                        <div class="flex gap-2">
                            <button onclick="editOrder('${o.id}')" class="text-gray-400 hover:text-blue-500"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="deleteOrder('${o.id}')" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <div class="font-bold text-lg text-gray-800 mb-1">${o.clientName}</div>
                    <div class="text-sm text-gray-600 mb-3 line-clamp-2">${o.text || ' 驻专'}</div>
                    
                    <div class="flex items-center gap-2 text-xs bg-gray-50 p-2 rounded mb-3">
                        <i class="fas fa-truck text-gray-400"></i>
                        <span class="font-bold">${o.driverId}</span>
                        <i class="fas fa-arrow-left text-gray-300 mx-1"></i>
                        <i class="fas fa-warehouse text-gray-400"></i>
                        <span>${o.pickupBranch === 'harash' ? '专砖' : (o.pickupBranch==='main'?'转':'住驻拽')}</span>
                    </div>

                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs px-2 py-1 rounded bg-gray-200 font-bold">${getStatusText(o.status)}</span>
                        <span class="text-[10px] text-gray-400">${new Date(o.createdAt?.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                    </div>
                </div>`;
            });
        }

        // --- GLOBAL ACTIONS (Attached to Window) ---
        
        // 住 驻  (爪 注 砖专 爪)
        window.filterByDriver = (name) => {
            if (currentDriverFilter === name) {
                currentDriverFilter = null; //  住
                document.querySelectorAll('.driver-row').forEach(e => e.classList.remove('active-driver'));
            } else {
                currentDriverFilter = name;
                document.querySelectorAll('.driver-row').forEach(e => e.classList.remove('active-driver'));
                const el = document.getElementById(`d-${name.replace(/\s/g, '')}`);
                if(el) el.classList.add('active-driver');
            }
            renderOrders();
        };

        // 注专转  (驻拽爪 砖转 住专!)
        window.editOrder = (id) => {
            const order = ordersData.find(o => o.id === id);
            if (!order) return;

            Swal.fire({
                title: '注专转 砖',
                html: `
                    <div class="text-right space-y-3">
                        <label class="text-xs text-gray-500 font-bold">驻专</label>
                        <textarea id="e-text" class="swal2-textarea w-full mx-0">${order.text}</textarea>
                        <label class="text-xs text-gray-500 font-bold">住住</label>
                        <select id="e-status" class="swal2-input w-full mx-0">
                            <option value="assigned" ${order.status==='assigned'?'selected':''}>转</option>
                            <option value="picking" ${order.status==='picking'?'selected':''}>拽</option>
                            <option value="en_route" ${order.status==='en_route'?'selected':''}>专</option>
                            <option value="done" ${order.status==='done'?'selected':''}>砖</option>
                        </select>
                    </div>
                `,
                confirmButtonText: '砖专 砖',
                showCancelButton: true,
                preConfirm: () => {
                    return {
                        text: document.getElementById('e-text').value,
                        status: document.getElementById('e-status').value
                    }
                }
            }).then(async (result) => {
                if(result.isConfirmed) {
                    await updateDoc(doc(db, "orders", id), {
                        text: result.value.text,
                        status: result.value.status,
                        lastUpdate: serverTimestamp()
                    });
                    Swal.fire('注', '', 'success');
                }
            });
        };

        window.openNewOrderModal = () => {
            Swal.fire({
                title: '砖 砖',
                html: `
                    <div class="text-right space-y-3">
                        <input id="n-client" class="swal2-input w-full mx-0" placeholder="砖 拽">
                        <div class="flex gap-2">
                            <select id="n-driver" class="swal2-input w-full mx-0 text-sm">
                                <option value="" disabled selected>专 ...</option>
                                <option value="转">转</option>
                                <option value="注">注 (祝)</option>
                            </select>
                            <select id="n-branch" class="swal2-input w-full mx-0 text-sm bg-blue-50">
                                <option value="harash">专砖</option>
                                <option value="main">转</option>
                                <option value="supplier">住驻拽</option>
                            </select>
                        </div>
                        <select id="n-type" class="swal2-input w-full mx-0 text-sm"><option value="client">专</option><option value="urgent"> 祝</option></select>
                        <textarea id="n-text" class="swal2-textarea w-full mx-0" placeholder="驻专 住专..."></textarea>
                        <input id="n-addr" class="swal2-input w-full mx-0" placeholder="转转 (Waze)">
                    </div>
                `,
                confirmButtonText: '爪专 砖',
                showCancelButton: true,
                preConfirm: () => {
                    return {
                        client: document.getElementById('n-client').value,
                        driver: document.getElementById('n-driver').value,
                        branch: document.getElementById('n-branch').value,
                        type: document.getElementById('n-type').value,
                        text: document.getElementById('n-text').value,
                        addr: document.getElementById('n-addr').value
                    }
                }
            }).then(async res => {
                if(res.isConfirmed) {
                    const d = res.value;
                    if(!d.client || !d.driver) return Swal.fire('住专 驻专', '', 'error');
                    
                    await addDoc(collection(db, "orders"), {
                        clientName: d.client, driverId: d.driver, pickupBranch: d.branch, taskType: d.type, text: d.text, address: d.addr,
                        status: 'assigned', createdAt: serverTimestamp(), lastUpdate: serverTimestamp()
                    });
                    
                    Swal.fire('爪专 爪', '', 'success');
                }
            });
        };

        window.deleteOrder = (id) => {
            Swal.fire({ title: '拽?', icon: 'warning', showCancelButton: true, confirmButtonText: ', 拽' }).then(async r => {
                if(r.isConfirmed) { await deleteDoc(doc(db, "orders", id)); Swal.fire('拽', '', 'success'); }
            });
        };

        window.filterView = (filter, btn) => {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderOrders();
        };

        function getStatusText(s) {
            const map = { 'assigned': '转 爪注', 'picking': '拽 爪专', 'en_route': '爪 拽', 'arrived': '驻专拽', 'done': '砖' };
            return map[s] || s;
        }
    </script>
</body>
</html>
