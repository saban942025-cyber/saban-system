<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>SabanOS | מגדל פיקוח</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .kanban-col { min-height: 80vh; background: #f1f5f9; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 12px; }
        .card { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; border-left: 4px solid transparent; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card-new { border-left-color: #3b82f6; } .card-picking { border-left-color: #f59e0b; } .card-ready { border-left-color: #10b981; } .card-shipping { border-left-color: #8b5cf6; }
    </style>
</head>
<body class="bg-slate-200 h-screen flex flex-col font-sans overflow-hidden">
    <header class="bg-slate-900 text-white p-4 shadow-lg flex justify-between items-center z-20">
        <div class="flex items-center gap-4"><div class="bg-blue-600 w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl">S</div><div><h1 class="text-xl font-bold">מגדל פיקוח (סידור)</h1><p class="text-xs text-gray-400">ניהול שרשרת אספקה</p></div></div>
        <div class="flex gap-3"><button onclick="window.location.href='index.html'" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-sm transition">חזרה</button></div>
    </header>
    <main class="flex-1 overflow-x-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 min-w-[1200px] h-full">
            <div class="flex flex-col"><div class="flex justify-between items-center mb-3 px-1"><h2 class="font-bold text-slate-700 flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span> התקבל</h2><span id="count-new" class="bg-white text-blue-600 text-xs font-bold px-2 py-1 rounded-full shadow">0</span></div><div id="col-new" class="kanban-col border-t-4 border-blue-500"></div></div>
            <div class="flex flex-col"><div class="flex justify-between items-center mb-3 px-1"><h2 class="font-bold text-slate-700 flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-orange-500"></span> בליקוט</h2><span id="count-picking" class="bg-white text-orange-600 text-xs font-bold px-2 py-1 rounded-full shadow">0</span></div><div id="col-picking" class="kanban-col border-t-4 border-orange-500"></div></div>
            <div class="flex flex-col"><div class="flex justify-between items-center mb-3 px-1"><h2 class="font-bold text-slate-700 flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> מוכן</h2><span id="count-ready" class="bg-white text-green-600 text-xs font-bold px-2 py-1 rounded-full shadow">0</span></div><div id="col-ready" class="kanban-col border-t-4 border-green-500"></div></div>
            <div class="flex flex-col"><div class="flex justify-between items-center mb-3 px-1"><h2 class="font-bold text-slate-700 flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-purple-500"></span> בשינוע</h2><span id="count-shipping" class="bg-white text-purple-600 text-xs font-bold px-2 py-1 rounded-full shadow">0</span></div><div id="col-shipping" class="kanban-col border-t-4 border-purple-500"></div></div>
        </div>
    </main>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, updateDoc, doc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc", authDomain: "saban94-eb5f0.firebaseapp.com", projectId: "saban94-eb5f0", storageBucket: "saban94-eb5f0.firebasestorage.app", messagingSenderId: "656829273946", appId: "1:656829273946:web:8ebcb440ed280aff014563" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        const q = query(collection(db, "orders"), where("status", "!=", "delivered"), orderBy("status"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snap) => {
            ['new', 'picking', 'ready', 'shipping'].forEach(c => { document.getElementById(`col-${c}`).innerHTML = ''; document.getElementById(`count-${c}`).innerText = '0'; });
            let counts = { new: 0, picking: 0, ready: 0, shipping: 0 };
            snap.forEach(docSnap => {
                const o = docSnap.data(); const id = docSnap.id; const status = o.status === 'loaded' || o.status === 'approved' ? 'ready' : (o.status || 'new');
                if (counts[status] !== undefined) {
                    counts[status]++;
                    const card = document.createElement('div'); card.className = `card card-${status}`;
                    card.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg">${o.clientName}</h3><span class="text-xs bg-gray-100 px-2 py-1 rounded font-mono">#${id.slice(0,4)}</span></div><div class="text-sm text-gray-600 mb-2"><i class="fas fa-map-marker-alt text-red-400"></i> ${o.project || 'כללי'}</div><div class="text-xs bg-slate-50 p-2 rounded border mb-3 text-gray-500 truncate">${o.items ? o.items.map(i => i.qty + ' ' + (i.core?.name || i.name)).join(', ') : '...'}</div>`;
                    if(status === 'new') card.innerHTML += `<button onclick="window.updateStatus('${id}', 'picking')" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold">לליקוט</button>`;
                    else if(status === 'picking') card.innerHTML += `<button onclick="window.updateStatus('${id}', 'ready')" class="w-full bg-orange-500 text-white py-2 rounded text-sm font-bold">סיים ליקוט</button>`;
                    else if(status === 'ready') card.innerHTML += `<button onclick="window.updateStatus('${id}', 'shipping')" class="w-full bg-green-600 text-white py-2 rounded text-sm font-bold">שגר לנהג</button>`;
                    document.getElementById(`col-${status}`).appendChild(card);
                }
            });
            Object.keys(counts).forEach(k => document.getElementById(`count-${k}`).innerText = counts[k]);
        });
        window.updateStatus = async (id, status) => { await updateDoc(doc(db, "orders", id), { status: status }); };
    </script>
</body>
</html>